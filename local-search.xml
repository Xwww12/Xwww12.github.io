<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Blender</title>
    <link href="/2025/07/08/%E5%85%B6%E4%BB%96/Blender/"/>
    <url>/2025/07/08/%E5%85%B6%E4%BB%96/Blender/</url>
    
    <content type="html"><![CDATA[<h1 id="Blender"><a href="#Blender" class="headerlink" title="Blender"></a>Blender</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>官网：<a href="https://www.blender.org/">https://www.blender.org/</a></p><p>Download &gt; LTS(长期支持版本) &gt; Windows-Installer</p><h2 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h2><p>– <strong>保存设置</strong></p><p>点击左下角 &gt; 保存用户设置</p><p>– <strong>显示大小</strong></p><p>编辑 &gt; 偏好设置 &gt; 界面 &gt; 分辨率缩放</p><p>– <strong>设置临时文件位置</strong></p><p>编辑 &gt; 偏好设置 &gt; 文件路径 &gt; 数据 &gt; 临时文件</p><p>– <strong>下载扩展插件</strong></p><p>编辑 &gt; 偏好设置 &gt; 获取扩展</p><p>– <strong>下载非官方认证插件</strong></p><p>编辑 &gt; 偏好设置 &gt; 插件 &gt; 右上角从磁盘安装</p><blockquote><p>安装好的插件按N键会显示在右边</p></blockquote><p>– <strong>设置拾色器为方形</strong></p><p>编辑 &gt; 偏好设置 &gt; 界面 &gt; 拾色器类型 &gt; 方形(SV+H)</p><p>– <strong>设置Tab键调用饼菜单（常用）</strong></p><p>编辑 &gt; 偏好设置 &gt; 键位映射 &gt; Tab键调用饼菜单</p><p>– <strong>设置撤销次数</strong></p><p>编辑 &gt; 偏好设置 &gt; 系统 &gt; 撤销次数</p><p>– <strong>设置打开blender文件为Blender</strong></p><p>编辑 &gt; 偏好设置 &gt; 系统 &gt; 操作系统设置 &gt; 注册</p><p>– <strong>保存版本</strong></p><p>编辑 &gt; 偏好设置 &gt; 保存&amp;加载 &gt; 保存版本 &gt; 用不到，设为0</p><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><table><thead><tr><th>功能</th><th>快捷键</th></tr></thead><tbody><tr><td>缩放视图</td><td>鼠标滚轮</td></tr><tr><td>旋转视图</td><td>鼠标中键</td></tr><tr><td>平移视图</td><td>shift+中键</td></tr><tr><td>移动</td><td>G</td></tr><tr><td>旋转</td><td>R</td></tr><tr><td>缩放</td><td>S</td></tr><tr><td>全选</td><td>A</td></tr><tr><td>删除</td><td>X</td></tr><tr><td>查看前后左右视图</td><td>~</td></tr><tr><td>切换物体或骨骼模式</td><td>Tab</td></tr></tbody></table><h2 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h2><p>– <strong>设置输出帧率</strong></p><p>右边工作栏 &gt; 输出 &gt; 格式 &gt; 帧率</p><p>– <strong>输出透明背景</strong></p><p>渲染 &gt; 胶片 &gt; 勾选透明</p><h1 id="MMD"><a href="#MMD" class="headerlink" title="MMD"></a>MMD</h1><h2 id="下载模型和动作"><a href="#下载模型和动作" class="headerlink" title="下载模型和动作"></a>下载模型和动作</h2><p>模之屋：<a href="https://www.aplaybox.com/">https://www.aplaybox.com/</a></p><h2 id="导入模型"><a href="#导入模型" class="headerlink" title="导入模型"></a>导入模型</h2><blockquote><p>先下载插件MMD Tools</p></blockquote><p>按N &gt; MMD &gt; 导入pmx文件</p><p>常见问题：</p><ol><li><p><strong>模型颜色发红发紫</strong></p><p> 可能识别不到贴图，可以点击MMD &gt; 材质 &gt; 转换给Blender，之后再手动修改有问题的材质</p></li></ol><h2 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h2><p>先点击文件 &gt; 外部数据 &gt; 打包资源，之后再另存为</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>python数学</title>
    <link href="/2025/06/11/python/python%E6%95%B0%E5%AD%A6/"/>
    <url>/2025/06/11/python/python%E6%95%B0%E5%AD%A6/</url>
    
    <content type="html"><![CDATA[<h1 id="回归"><a href="#回归" class="headerlink" title="回归"></a>回归</h1><blockquote><p>预测</p></blockquote><h2 id="目标函数"><a href="#目标函数" class="headerlink" title="目标函数"></a>目标函数</h2><p><img src="/img/python_math_img/%E7%9B%AE%E6%A0%87%E5%87%BD%E6%95%B0.png" alt="目标函数"></p><ul><li>E是Error的首字母</li><li>i表示第i个训练数据</li><li>y为实际值，f为预测值</li><li>最优化问题：找到让E最小的θ</li><li>使用平方而不是绝对值、乘以1&#x2F;2，是为了后面微分计算方便</li></ul><h2 id="最小二乘法"><a href="#最小二乘法" class="headerlink" title="最小二乘法"></a>最小二乘法</h2><p>调整θ让E变小</p><h2 id="最速下降法-x2F-梯度下降法"><a href="#最速下降法-x2F-梯度下降法" class="headerlink" title="最速下降法&#x2F;梯度下降法"></a>最速下降法&#x2F;梯度下降法</h2><blockquote><p>最速下降法有容易陷入局部最优解的问题</p></blockquote><p>求导，然后往导数符号相反的方向增减</p><p><img src="/img/python_math_img/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95.png" alt="梯度下降法"></p><ul><li><code>:=</code>和编程里的<code>=</code>一个意思</li><li><code>り</code>为学习率，控制值的变化幅度</li></ul><h2 id="多项式回归"><a href="#多项式回归" class="headerlink" title="多项式回归"></a>多项式回归</h2><p>当曲线方程为：</p><p><img src="/img/python_math_img/%E5%A4%9A%E9%A1%B9%E5%BC%8F%E5%9B%9E%E5%BD%921.png"></p><p>时，每个参数的更新表达式为：</p><p><img src="/img/python_math_img/%E5%A4%9A%E9%A1%B9%E5%BC%8F%E5%9B%9E%E5%BD%922.png"></p><h2 id="多重回归"><a href="#多重回归" class="headerlink" title="多重回归"></a>多重回归</h2><p>包含了多个变量</p><h2 id="随机梯度下降法"><a href="#随机梯度下降法" class="headerlink" title="随机梯度下降法"></a>随机梯度下降法</h2><p>最速下降法使用了所有训练数据的误差，</p><p>而在随机梯度下降法中会随机选择一个或多个训练数据，并使用它来更新参数</p><p><img src="/img/python_math_img/%E9%9A%8F%E6%9C%BA%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%951.png" alt="选择一个的时候"></p><p><img src="/img/python_math_img/%E9%9A%8F%E6%9C%BA%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%952.png" alt="选择多个的时候"></p><ul><li>K为含有m个训练数据的集合</li></ul><h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><blockquote><p>有标签，有监督学习</p></blockquote><h2 id="二分类"><a href="#二分类" class="headerlink" title="二分类"></a>二分类</h2><p>将训练数据分类成两类，<strong>线性可分</strong>。</p><p>（假设训练数据是二维的）将训练放在坐标轴上，可通过一条直线将训练数据分成两类</p><p><img src="/img/python_math_img/%E4%BA%8C%E5%88%86%E7%B1%BB.png"></p><ul><li><code>w</code>意思是权重向量，是要找的直线的法向量</li><li>通过训练找到权重向量</li><li>和<code>w</code>夹角在<code>0°~90°</code>和<code>270°~360°</code>为正，<code>90°~270°</code>为负</li></ul><p><strong>权重向量的更新表达式</strong></p><p><img src="/img/python_math_img/%E6%9D%83%E9%87%8D%E5%90%91%E9%87%8F%E6%9B%B4%E6%96%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F.png"></p><ul><li>预测结果和标签相同时，权重不变</li><li>预测结果和标签不同时<ul><li>标签为正则做加法</li><li>标签为负则做减法</li></ul></li></ul><h2 id="逻辑回归"><a href="#逻辑回归" class="headerlink" title="逻辑回归"></a>逻辑回归</h2><p><strong>sigmoid函数</strong></p><blockquote><p>sigmoid函数用来把数据转化成0~1上的数</p></blockquote><p><img src="/img/python_math_img/sigmoid%E5%87%BD%E6%95%B0.png"></p><ul><li><p>exp为指数函数，底数为e</p></li><li><p><img src="/img/python_math_img/sigmoid%E5%87%BD%E6%95%B0%E5%9B%BE%E5%83%8F.png"></p><p>  <strong>把f(θ)看做概率</strong>，<code>&gt;=0.5</code>时分类为1，<code>&lt;0.5</code>时分类为0</p><p>  即<code>θx &gt;= 0</code>时为1，<code>θx &lt; 0</code>时分类为0</p><p>  <code>θx = 0</code>称为<strong>决策边界</strong></p></li></ul><p><strong>似然函数</strong></p><blockquote><p>是逻辑回归的目标函数</p></blockquote><p><img src="/img/python_math_img/%E4%BC%BC%E7%84%B6%E5%87%BD%E6%95%B0.png"></p><ul><li><p>目标是找到参数<code>θ</code>，使得<code>L(θ)</code><strong>最大化</strong></p></li><li><p>求导时乘法比较复杂，一般取对数后再计算</p><p>  <img src="/img/python_math_img/%E4%BC%BC%E7%84%B6%E5%87%BD%E6%95%B0%E5%8F%96%E5%AF%B9%E6%95%B0.png"></p><p>  这个就是逻辑回归的目标函数</p></li></ul><p>对这个目标函数对θ求导得：</p><p><img src="/img/python_math_img/%E4%BC%BC%E7%84%B6%E5%87%BD%E6%95%B0%E5%8F%96%E5%AF%B9%E6%95%B0%E6%B1%82%E5%AF%BC.png"></p><p>因为要L(θ)越大越好，故参数更新表达式为：</p><p><img src="/img/python_math_img/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E5%8F%82%E6%95%B0%E6%9B%B4%E6%96%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F1.png"></p><p>为了和回归时的符号一样，改成：</p><p><img src="/img/python_math_img/%E9%80%BB%E8%BE%91%E5%9B%9E%E5%BD%92%E5%8F%82%E6%95%B0%E6%9B%B4%E6%96%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F2.png"></p><h2 id="线性不可分"><a href="#线性不可分" class="headerlink" title="线性不可分"></a>线性不可分</h2><p>即用直线不能分类的问题</p><p>通过加入更高阶的参数让直线变曲线</p><h1 id="聚集"><a href="#聚集" class="headerlink" title="聚集"></a>聚集</h1><blockquote><p>无标签，无监督学习</p></blockquote><h1 id="评估模型的方法"><a href="#评估模型的方法" class="headerlink" title="评估模型的方法"></a>评估模型的方法</h1><h2 id="交叉验证"><a href="#交叉验证" class="headerlink" title="交叉验证"></a>交叉验证</h2><p>交叉验证为，将数据分为<strong>测试数据</strong>和<strong>训练数据</strong></p><ul><li>回归：计算测试数据的方差</li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python基础</title>
    <link href="/2025/06/01/python/python%E5%9F%BA%E7%A1%80/"/>
    <url>/2025/06/01/python/python%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h1><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>单行：#</p><p>多行：<code>&#39;&#39;&#39;</code>或<code>&quot;&quot;&quot;</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 如果一段代码太长，可用\分段</span><br>a = b + c + \<br>d + e + \<br>    f<br></code></pre></td></tr></table></figure><h2 id="变量类型"><a href="#变量类型" class="headerlink" title="变量类型"></a>变量类型</h2><h3 id="查看类型"><a href="#查看类型" class="headerlink" title="查看类型"></a>查看类型</h3><p><code>type()</code>查看变量类型</p><p><code>isinstance(a, (类型1, ...))</code>判断是否是其中一种类型或子类</p><h3 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h3><ul><li>int</li><li>bool（True&#x2F;False）</li><li>float</li><li>complex（复数）</li></ul><blockquote><p><code>/</code>返回浮点数，<code>//</code>返回整数<strong>的部分</strong></p></blockquote><h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>单行字符串可用<code>&#39;&#39;</code>或<code>&quot;&quot;</code>，多行字符串可用<code>&#39;&#39;&#39; &#39;&#39;&#39;</code>或<code>&quot;&quot;&quot; &quot;&quot;&quot;</code></p><p>转义符号<code>\</code></p><p>不让<code>\</code>生效，在引号前加r</p><p>可用<code>+</code>连接字符串，<code>*</code>重复字符串</p><p>字符串是不可改变量</p><p><strong>切片</strong></p><p>左闭右开</p><p>-1为末尾位置</p><p>还可加上步长，步长-1表示逆向</p><p><strong>格式化</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span> (<span class="hljs-string">&quot;我叫 %s 今年 %d 岁!&quot;</span> % (<span class="hljs-string">&#x27;小明&#x27;</span>, <span class="hljs-number">10</span>))<br><br><span class="hljs-comment"># 还有前面加f的格式化语法</span><br>name = <span class="hljs-string">&#x27;aaa&#x27;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;Hello <span class="hljs-subst">&#123;name&#125;</span>&#x27;</span>)      <span class="hljs-comment"># Hello aaa</span><br><br>w = &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;baidu&#x27;</span>, <span class="hljs-string">&#x27;url&#x27;</span>: <span class="hljs-string">&#x27;www.baidu.com&#x27;</span>&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;w[<span class="hljs-string">&quot;name&quot;</span>]&#125;</span>: <span class="hljs-subst">&#123;w[<span class="hljs-string">&quot;url&quot;</span>]&#125;</span>&#x27;</span>)   <span class="hljs-comment"># baidu: www.baidu.com</span><br></code></pre></td></tr></table></figure><h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><p>列表的元素是可改变的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]<br><span class="hljs-built_in">print</span>(a[<span class="hljs-number">1</span> : <span class="hljs-number">2</span>]) <span class="hljs-comment"># [2]</span><br><span class="hljs-built_in">print</span>(a[<span class="hljs-number">1</span> :])   <span class="hljs-comment"># [2, 3, 4, 5, 6]</span><br><br>a[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span><br><span class="hljs-built_in">print</span>(a) <span class="hljs-comment">#[1, 0, 3, 4, 5, 6]</span><br></code></pre></td></tr></table></figure><p><strong>列表操作</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 增加元素</span><br>list1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br>list1.append(<span class="hljs-number">4</span>)<br><span class="hljs-built_in">print</span>(list1)    <span class="hljs-comment"># [1, 2, 3, 4]</span><br><br><span class="hljs-comment"># 删除元素</span><br><span class="hljs-keyword">del</span> list1[<span class="hljs-number">0</span>]<br><span class="hljs-built_in">print</span>(list1)    <span class="hljs-comment"># [2, 3, 4]</span><br><br><span class="hljs-comment"># 比较列表</span><br><span class="hljs-keyword">import</span> operator<br><br>list1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>]<br>list2 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]<br><span class="hljs-built_in">print</span>(operator.eq(list1, list2))<span class="hljs-comment"># False</span><br></code></pre></td></tr></table></figure><h3 id="元组"><a href="#元组" class="headerlink" title="元组"></a>元组</h3><p>元组的元素不可以改变</p><p>可以把字符串看成特殊的元组</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">tup = (<span class="hljs-number">1</span>, ) <span class="hljs-comment"># 只包含一个元素的元组</span><br>a = (<span class="hljs-number">1</span>)     <span class="hljs-comment"># int类型</span><br>b = () <span class="hljs-comment"># 空元组</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(tup))    <span class="hljs-comment"># &lt;class &#x27;tuple&#x27;&gt;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(a))  <span class="hljs-comment"># &lt;class &#x27;int&#x27;&gt;</span><br></code></pre></td></tr></table></figure><h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>集合的元素可变，唯一</p><p>创建可用<code>&#123;&#125;</code>或<code>set()</code>，空集合要用set</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python">a = <span class="hljs-built_in">set</span>(<span class="hljs-string">&#x27;abracadabra&#x27;</span>)<br>b = <span class="hljs-built_in">set</span>(<span class="hljs-string">&#x27;alacazam&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(a)<br><br><span class="hljs-built_in">print</span>(a - b)     <span class="hljs-comment"># a 和 b 的差集</span><br><br><span class="hljs-built_in">print</span>(a | b)     <span class="hljs-comment"># a 和 b 的并集</span><br><br><span class="hljs-built_in">print</span>(a &amp; b)     <span class="hljs-comment"># a 和 b 的交集</span><br><br><span class="hljs-built_in">print</span>(a ^ b)     <span class="hljs-comment"># a 和 b 中不同时存在的元素</span><br></code></pre></td></tr></table></figure><h3 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h3><p>创建可用<code>&#123;&#125;</code>或<code>dict</code>，空字典可用<code>&#123;&#125;</code>创建</p><p>key必须为不可变类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">a = &#123;<span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-number">4</span> : <span class="hljs-string">&#x27;d&#x27;</span>&#125;<br><span class="hljs-built_in">print</span>(a)        <span class="hljs-comment"># &#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: 2, &#x27;c&#x27;: 3, 4: &#x27;d&#x27;&#125;</span><br><span class="hljs-built_in">print</span>(a[<span class="hljs-string">&#x27;a&#x27;</span>])   <span class="hljs-comment"># 1</span><br><span class="hljs-built_in">print</span>(a[<span class="hljs-number">4</span>])     <span class="hljs-comment"># d</span><br></code></pre></td></tr></table></figure><p><strong>字典操作</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 删除指定key</span><br>d = &#123;<span class="hljs-number">1</span> : <span class="hljs-number">1</span>, <span class="hljs-number">2</span> : <span class="hljs-number">2</span>, <span class="hljs-number">3</span> : <span class="hljs-number">3</span>&#125;<br><span class="hljs-keyword">del</span> d[<span class="hljs-number">1</span>]<br><span class="hljs-built_in">print</span>(d)    <span class="hljs-comment"># &#123;2: 2, 3: 3&#125;</span><br><br><span class="hljs-comment"># 清空字典</span><br>d.clear()<br><span class="hljs-built_in">print</span>(d)    <span class="hljs-comment"># &#123;&#125;</span><br></code></pre></td></tr></table></figure><h2 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 输入</span><br>price = <span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;Enter price: &quot;</span>)<br><br><span class="hljs-comment"># print默认带换行</span><br><span class="hljs-built_in">print</span>(price)<br><span class="hljs-built_in">print</span>(price, end = <span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>format格式化</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 按位置填充</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, &#123;&#125;!&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;Alice&quot;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello, &#123;0&#125;, you are &#123;1&#125; years old.&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">25</span>))<br><br><span class="hljs-comment"># 按关键字填充</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Site name: &#123;name&#125;, Rank: &#123;rank&#125;&quot;</span>.<span class="hljs-built_in">format</span>(name=<span class="hljs-string">&quot;Google&quot;</span>, rank=<span class="hljs-number">1</span>))<br><br><span class="hljs-comment"># 混合字典访问</span><br>user = &#123;<span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">18</span>&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Name: &#123;0[name]&#125;, Age: &#123;0[age]&#125;&quot;</span>.<span class="hljs-built_in">format</span>(user))<br><br><span class="hljs-comment"># 解包</span><br>data = &#123;<span class="hljs-string">&quot;site&quot;</span>: <span class="hljs-string">&quot;Google&quot;</span>, <span class="hljs-string">&quot;rank&quot;</span>: <span class="hljs-number">1</span>&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Site: &#123;site&#125;, Rank: &#123;rank&#125;&quot;</span>.<span class="hljs-built_in">format</span>(**data))<br></code></pre></td></tr></table></figure><p>格式化控制符</p><table><thead><tr><th>格式符</th><th>含义</th><th>示例值</th><th>示例结果</th></tr></thead><tbody><tr><td><code>d</code></td><td>十进制整数</td><td><code>&#123;0:d&#125;</code></td><td><code>42</code></td></tr><tr><td><code>f</code></td><td>浮点数（默认 6 位）</td><td><code>&#123;0:f&#125;</code></td><td><code>3.141593</code></td></tr><tr><td><code>.2f</code></td><td>保留 2 位小数</td><td><code>&#123;0:.2f&#125;</code></td><td><code>3.14</code></td></tr><tr><td><code>&gt;10</code></td><td>右对齐，占 10 宽度</td><td><code>&#123;0:&gt;10&#125;</code></td><td><code>       text</code></td></tr><tr><td><code>&lt;10</code></td><td>左对齐，占 10 宽度</td><td><code>&#123;0:&lt;10&#125;</code></td><td><code>text      </code></td></tr><tr><td><code>^10</code></td><td>居中，占 10 宽度</td><td><code>&#123;0:^10&#125;</code></td><td><code> text </code></td></tr><tr><td><code>,</code></td><td>千位分隔符</td><td><code>&#123;0:,&#125;</code></td><td><code>1,000,000</code></td></tr><tr><td><code>%</code></td><td>百分比（乘以 100）</td><td><code>&#123;0:.2%&#125;</code></td><td><code>25.00%</code></td></tr></tbody></table><h2 id="条件-x2F-循环"><a href="#条件-x2F-循环" class="headerlink" title="条件&#x2F;循环"></a>条件&#x2F;循环</h2><ul><li><p>if &#x2F; elif &#x2F; else</p></li><li><p>match…case(相当于switch…case，在3.10版本可用)</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">status = <span class="hljs-number">400</span><br><span class="hljs-keyword">match</span> status:<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">400</span> | <span class="hljs-number">401</span> | <span class="hljs-number">402</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Bad request&quot;</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Not found&quot;</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-number">418</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I&#x27;m a teapot&quot;</span><br>    <span class="hljs-keyword">case</span> _:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Something&#x27;s wrong with the internet&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>while…else</p></li><li><p>for…in…else</p><blockquote><p>range(5): 遍历从0到4</p></blockquote></li><li><p>pass: 空语句，不做任何事</p></li></ul><h2 id="导入模块"><a href="#导入模块" class="headerlink" title="导入模块"></a>导入模块</h2><p>导入模块的搜索路径：</p><ol><li>当前目录</li><li>环境变量 <code>PYTHONPATH</code> 指定的目录</li><li>Python 标准库目录</li><li><code>.pth</code> 文件中指定的目录</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 整个模块</span><br><span class="hljs-keyword">import</span> sys<br><br><span class="hljs-comment"># 模块中的某个函数</span><br><span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> argv, path<br><br><span class="hljs-comment"># 模块中的所有函数(不推荐，容易覆盖已经定义的函数)</span><br><span class="hljs-keyword">from</span> sys <span class="hljs-keyword">import</span> *<br></code></pre></td></tr></table></figure><p>每个模块都有一个<code>__name__</code>属性</p><ul><li>如果模块是被直接运行，<code>__name__</code> 的值为 <code>__main__</code>。</li><li>如果模块是被导入的，<code>__name__</code> 的值为模块名。</li></ul><h2 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h2><ul><li>abs(): 绝对值</li><li>ceil()&#x2F;floor(): 向上&#x2F;向下取整</li><li>round(): 四舍五入</li><li>cmp(): 比较两个数</li><li>max()&#x2F;min(): 取最大&#x2F;最小值</li><li>pow(): 开方</li><li>sqrt(): 平方根</li></ul><h2 id="错误异常"><a href="#错误异常" class="headerlink" title="错误异常"></a>错误异常</h2><p><strong>处理异常</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 完整语法</span><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-comment"># 可能抛出异常的代码</span><br><span class="hljs-keyword">except</span> ExceptionType1:<br>    <span class="hljs-comment"># 处理方式 1</span><br><span class="hljs-keyword">except</span> ExceptionType2 <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-comment"># 处理方式 2，可获取异常对象 e</span><br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment"># 没有发生任何异常时执行</span><br><span class="hljs-keyword">finally</span>:<br>    <span class="hljs-comment"># 不管是否异常都会执行（清理资源用）</span><br></code></pre></td></tr></table></figure><p><strong>抛出异常</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sqrt</span>(<span class="hljs-params">x</span>):<br>    <span class="hljs-keyword">if</span> x &lt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">&quot;不能对负数开平方&quot;</span>)<br>    <span class="hljs-keyword">return</span> x ** <span class="hljs-number">0.5</span><br></code></pre></td></tr></table></figure><p><strong>常见异常类型</strong></p><table><thead><tr><th>异常名</th><th>说明</th></tr></thead><tbody><tr><td><code>ValueError</code></td><td>参数类型&#x2F;值不合法</td></tr><tr><td><code>ZeroDivisionError</code></td><td>除以 0</td></tr><tr><td><code>IndexError</code></td><td>索引超出范围</td></tr><tr><td><code>KeyError</code></td><td>字典中键不存在</td></tr><tr><td><code>FileNotFoundError</code></td><td>打开的文件不存在</td></tr><tr><td><code>TypeError</code></td><td>操作&#x2F;函数类型不对</td></tr><tr><td><code>NameError</code></td><td>使用了未定义的变量</td></tr></tbody></table><p><strong>自定义异常</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyError</span>(<span class="hljs-title class_ inherited__">Exception</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, message</span>):<br>        self.message = message<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__str__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> self.message<br><br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">raise</span> MyError(<span class="hljs-string">&quot;MyError&quot;</span>)<br><span class="hljs-keyword">except</span> MyError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><p><strong>打开文件</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">f = <span class="hljs-built_in">open</span>(file, mode=<span class="hljs-string">&#x27;r&#x27;</span>, encoding=<span class="hljs-literal">None</span>)<br></code></pre></td></tr></table></figure><p><strong>打开模式</strong></p><table><thead><tr><th>模式</th><th>含义</th><th>文件不存在时行为</th><th>可读</th><th>可写</th><th>是否清空原文件</th></tr></thead><tbody><tr><td><code>r</code></td><td>只读</td><td>❌ 报错</td><td>✅</td><td>❌</td><td>否</td></tr><tr><td><code>w</code></td><td>只写</td><td>✅ 创建新文件</td><td>❌</td><td>✅</td><td>✅ 清空</td></tr><tr><td><code>a</code></td><td>追加写入</td><td>✅ 创建新文件</td><td>❌</td><td>✅</td><td>❌（在末尾写）</td></tr><tr><td><code>r+</code></td><td>读写</td><td>❌ 报错</td><td>✅</td><td>✅</td><td>❌</td></tr><tr><td><code>w+</code></td><td>写读（先清空）</td><td>✅ 创建新文件</td><td>✅</td><td>✅</td><td>✅ 清空</td></tr><tr><td><code>a+</code></td><td>读写（追加写入）</td><td>✅ 创建新文件</td><td>✅</td><td>✅</td><td>❌（只追加）</td></tr><tr><td><code>rb</code>&#x2F;<code>wb</code> 等</td><td>二进制读写</td><td>适合图片、音频等</td><td>看上面</td><td>看上面</td><td>看上面</td></tr></tbody></table><p><strong>写入文件</strong></p><blockquote><p>使用with open() as f会自动关闭文件，不然要手动f.close()</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 覆盖写入</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;w&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(<span class="hljs-string">&quot;Hello, world!\n&quot;</span>)<br>    f.write(<span class="hljs-string">&quot;Second line.\n&quot;</span>)<br><br><span class="hljs-comment"># 追加写入</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(<span class="hljs-string">&quot;Appended line.\n&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>读取文件</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 一次读完全部内容（字符串）</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    content = f.read()<br>    <span class="hljs-built_in">print</span>(content)<br><br><span class="hljs-comment"># 按行读取</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    lines = f.readlines()<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> lines:<br>        <span class="hljs-built_in">print</span>(line.strip())<br>               <br><span class="hljs-comment"># 读一行</span><br>f.readline()<br></code></pre></td></tr></table></figure><h1 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h1><p>访问集合元素的一种方式</p><p>可以记住遍历的位置的对象，只能往前不会后退</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 用next()访问</span><br>a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]<br>b = <span class="hljs-built_in">iter</span>(a)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(b))  <span class="hljs-comment"># 1</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(b))  <span class="hljs-comment"># 2</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(b))  <span class="hljs-comment"># 3</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(b))  <span class="hljs-comment"># 报错</span><br><br><span class="hljs-comment"># 用for循环访问</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">iter</span>(a):<br>    <span class="hljs-built_in">print</span>(i)<br></code></pre></td></tr></table></figure><h2 id="创建迭代器"><a href="#创建迭代器" class="headerlink" title="创建迭代器"></a>创建迭代器</h2><p>实现<code>__iter__()</code>和<code>__next__()</code>方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyNum</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):<br>        self.num = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">return</span> self<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__next__</span>(<span class="hljs-params">self</span>):<br>        tmp = self.num<br>        <span class="hljs-keyword">if</span> tmp &lt; <span class="hljs-number">20</span>:<br>            self.num += <span class="hljs-number">1</span><br>            <span class="hljs-keyword">return</span> tmp<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> StopIteration     <span class="hljs-comment"># 停止迭代</span><br>myclass = MyNum()<br>it = <span class="hljs-built_in">iter</span>(myclass)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> it:<br>    <span class="hljs-built_in">print</span>(i)<br><br></code></pre></td></tr></table></figure><h1 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h1><p>使用了<code>yield</code>的<strong>函数</strong>被称为生成器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 每次到yield时，函数会返回n，并且在这里暂停，在下次调用时从这里继续执行</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">countdown</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">while</span> n &gt; <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">yield</span> n<br>        n -= <span class="hljs-number">1</span><br> <br><span class="hljs-comment"># 创建生成器对象</span><br>generator = countdown(<span class="hljs-number">5</span>)<br> <br><span class="hljs-comment"># 通过迭代生成器获取值</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(generator))  <span class="hljs-comment"># 输出: 5</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(generator))  <span class="hljs-comment"># 输出: 4</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(generator))  <span class="hljs-comment"># 输出: 3</span><br> <br><span class="hljs-comment"># 使用 for 循环迭代生成器</span><br><span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> generator:<br>    <span class="hljs-built_in">print</span>(value)  <span class="hljs-comment"># 输出: 2 1</span><br></code></pre></td></tr></table></figure><h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p><strong>不定长参数</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 一个*为元组</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">method</span>(<span class="hljs-params">var1, *var2</span>):<br>    <span class="hljs-built_in">print</span>(var1, <span class="hljs-string">&quot;  &quot;</span>,var2)<br><br>method(<span class="hljs-number">1</span>)   <span class="hljs-comment"># 1    ()</span><br>method(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)    <span class="hljs-comment"># 1    (2,)</span><br>method(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>) <span class="hljs-comment"># 1    (2, 3)</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 一个**为字典</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">method</span>(<span class="hljs-params">var1, *var2, **var3</span>):<br>    <span class="hljs-built_in">print</span>(var1)<br>    <span class="hljs-built_in">print</span>(var2)<br>    <span class="hljs-built_in">print</span>(var3)<br><br>method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>, a = <span class="hljs-number">1</span>, b = <span class="hljs-number">2</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">1</span><br><span class="hljs-string">(2, 3, 4, 5)</span><br><span class="hljs-string">&#123;&#x27;a&#x27;: 1, &#x27;b&#x27;: 2&#125;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>匿名函数</strong></p><p>作用是为了简洁，性能上和普通函数没差</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">sum</span> = <span class="hljs-keyword">lambda</span> arg1, arg2: arg1 + arg2<br><br><span class="hljs-comment"># 调用sum函数</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;相加后的值为 : &quot;</span>, <span class="hljs-built_in">sum</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>)) <span class="hljs-comment"># 相加后的值为 :  30</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;相加后的值为 : &quot;</span>, <span class="hljs-built_in">sum</span>(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>)) <span class="hljs-comment"># 相加后的值为 :  40</span><br></code></pre></td></tr></table></figure><h1 id="函数装饰器"><a href="#函数装饰器" class="headerlink" title="函数装饰器"></a>函数装饰器</h1><p>函数装饰器是一种函数，它接受一个函数作为参数，并返回一个新的函数或修改原来的函数</p><p>用于不修改原函数的基础上动态地增加或修改函数的功能</p><p>类似java的注解+AOP</p><p><strong>基本语法</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator_function</span>(<span class="hljs-params">original_function</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        <span class="hljs-comment"># 这里是在调用原始函数前添加的新功能</span><br>        before_call_code()<br>       <br>        result = original_function(*args, **kwargs)<br>       <br>        <span class="hljs-comment"># 这里是在调用原始函数后添加的新功能</span><br>        after_call_code()<br>       <br>        <span class="hljs-keyword">return</span> result<br>    <span class="hljs-keyword">return</span> wrapper<br><br><span class="hljs-comment"># 使用装饰器</span><br><span class="hljs-meta">@decorator_function</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">target_function</span>(<span class="hljs-params">arg1, arg2</span>):<br>    <span class="hljs-keyword">pass</span>  <span class="hljs-comment"># 原始函数的实现</span><br></code></pre></td></tr></table></figure><p><strong>实例</strong>：函数执行时间</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">time_logger</span>(<span class="hljs-params">func</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):<br>        start_time = time.time()<br>        res = func(*args, **kwargs)<br>        end_time = time.time()<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;参数: &quot;</span>, args)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行时间: &quot;</span>, end_time - start_time)<br>        <span class="hljs-keyword">return</span> res<br>    <span class="hljs-keyword">return</span> wrapper<br><br><br><span class="hljs-meta">@time_logger</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>(<span class="hljs-params">name</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello! &quot;</span>, name)<br>    time.sleep(<span class="hljs-number">0.5</span>)<br><br>say_hello(<span class="hljs-string">&quot;Alice&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>实例</strong>：带参数的装饰器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">repeat</span>(<span class="hljs-params">n</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):<br>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):<br>            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):<br>                func(*args, **kwargs)<br>        <span class="hljs-keyword">return</span> wrapper<br>    <span class="hljs-keyword">return</span> decorator<br><br><span class="hljs-meta">@repeat(<span class="hljs-params"><span class="hljs-number">3</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World!&quot;</span>)<br><br>say_hello()<br></code></pre></td></tr></table></figure><h1 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h1><p>类装饰器用于动态修改类行为</p><p><strong>实例</strong>：实现类的单例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonDecorator</span>:<br>    <span class="hljs-string">&quot;&quot;&quot;类装饰器，使目标类变成单例模式&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, cls</span>):<br>        self.cls = cls<br>        self.instance = <span class="hljs-literal">None</span><br>    <br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, *args, **kwargs</span>):<br>        <span class="hljs-string">&quot;&quot;&quot;拦截实例化过程，确保只创建一个实例&quot;&quot;&quot;</span><br>        <span class="hljs-keyword">if</span> self.instance <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            self.instance = self.cls(*args, **kwargs)<br>        <span class="hljs-keyword">return</span> self.instance<br><br><span class="hljs-meta">@SingletonDecorator</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Database 初始化&quot;</span>)<br><br>db1 = Database()<br>db2 = Database()<br><span class="hljs-built_in">print</span>(db1 <span class="hljs-keyword">is</span> db2)  <span class="hljs-comment"># True，说明是同一个实例</span><br></code></pre></td></tr></table></figure><h1 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h1><h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><p><code>__init()__</code>，创建对象时自动调用</p><p>不写默认是个空的构造方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):<br>        self.name = name<br>        self.age = age<br><br>p = Person(<span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-number">22</span>)<br><span class="hljs-built_in">print</span>(p.age)<br><span class="hljs-built_in">print</span>(p.name)<br></code></pre></td></tr></table></figure><h2 id="类方法"><a href="#类方法" class="headerlink" title="类方法"></a>类方法</h2><p>类方法用<code>def</code>定义，且第一个参数要为<code>self</code></p><h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>子类继承父类的属性和方法</p><p>子类里可用<code>super().</code>来调用父类的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;动物在叫&quot;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-title class_ inherited__">Animal</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bark</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;汪汪汪&quot;</span>)<br><br>d = Dog()<br>d.speak()  <br>d.bark()<br></code></pre></td></tr></table></figure><p><strong>多继承</strong>时决定调用哪个类的方法，按从左到右的优先级</p><p>即先找自己，在从左到右找父类（如果父类也有父类，则会顺着它的父类找上去）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;A&quot;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span>(<span class="hljs-title class_ inherited__">A</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;B&quot;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span>(<span class="hljs-title class_ inherited__">A</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;C&quot;</span>)<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span>(B, C):<br>    <span class="hljs-keyword">pass</span><br><br>D().hello()  <span class="hljs-comment"># 输出 B</span><br></code></pre></td></tr></table></figure><h2 id="私有属性和方法"><a href="#私有属性和方法" class="headerlink" title="私有属性和方法"></a>私有属性和方法</h2><p>定义：在属性或方法前加<code>__</code></p><p>私有属性和方法只能在本类中访问</p><p>python的私有并不是真的私有，只是改了其名字，变为<code>_类型__属性名</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):<br>        self.__name = name      <span class="hljs-comment"># 私有属性</span><br>        self.__age = age        <span class="hljs-comment"># 私有属性</span><br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__say_secret</span>(<span class="hljs-params">self</span>):     <span class="hljs-comment"># 私有方法</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;这是一个秘密&quot;</span>)<br><br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;<span class="hljs-subst">&#123;self.__name&#125;</span>, <span class="hljs-subst">&#123;self.__age&#125;</span>&quot;</span>)<br>        self.__say_secret()<br><br><span class="hljs-built_in">print</span>(Person(<span class="hljs-string">&quot;Tom&quot;</span>, <span class="hljs-number">20</span>).show())<br></code></pre></td></tr></table></figure><h2 id="魔法方法"><a href="#魔法方法" class="headerlink" title="魔法方法"></a>魔法方法</h2><p>魔法方法是 Python 自动调用的一些特殊方法</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td><code>__init__(self, ...)</code></td><td>构造函数，创建对象时调用</td></tr><tr><td><code>__new__(cls, ...)</code></td><td>真正创建对象的方法，<code>__init__</code> 前执行（用于元类）</td></tr><tr><td><code>__del__(self)</code></td><td>析构函数，删除对象时调用</td></tr><tr><td><code>__str__()</code></td><td><code>print(obj)</code> 时调用</td></tr><tr><td><code>__repr__()</code></td><td>解释器或 <code>repr(obj)</code> 时调用</td></tr></tbody></table><p>运算符重载</p><table><thead><tr><th>方法</th><th>对应操作</th></tr></thead><tbody><tr><td><code>__add__</code></td><td><code>+</code> 加法</td></tr><tr><td><code>__sub__</code></td><td><code>-</code> 减法</td></tr><tr><td><code>__mul__</code></td><td><code>*</code> 乘法</td></tr><tr><td><code>__eq__</code></td><td><code>==</code> 比较</td></tr><tr><td><code>__lt__</code></td><td><code>&lt;</code> 小于</td></tr></tbody></table><h1 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h1><p>Python的多线程是<strong>并发</strong>的，而非真正的并行</p><blockquote><p>CPython使用全局解释器锁（GIL）来保证线程安全，即同一时刻只有一个线程可以执行Python字节码。即使有多核CPU，GIL也会阻止多线程的<strong>并行</strong>执行</p></blockquote><p>通过<code>threading</code>模块来使用多线程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>():<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;线程 <span class="hljs-subst">&#123;threading.current_thread().name&#125;</span> 打招呼&quot;</span>)<br>        time.sleep(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># 创建两个线程</span><br>t1 = threading.Thread(target=say_hello, name=<span class="hljs-string">&#x27;T1&#x27;</span>)<br>t2 = threading.Thread(target=say_hello, name=<span class="hljs-string">&#x27;T2&#x27;</span>)<br><br>t1.start()<br>t2.start()<br><br>t1.join()<br>t2.join()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;主线程结束&quot;</span>)<br></code></pre></td></tr></table></figure><table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><code>Thread(target=...)</code></td><td>创建线程并指定要执行的函数</td></tr><tr><td><code>start()</code></td><td>启动线程</td></tr><tr><td><code>join()</code></td><td>阻塞，直到被调用线程终止</td></tr><tr><td><code>current_thread()</code></td><td>获取当前线程信息</td></tr><tr><td><code>Lock()</code></td><td>创建互斥锁，防止多线程同时修改共享数据</td></tr><tr><td><code>enumerate()</code></td><td>返回一个包含正在运行的线程的列表</td></tr><tr><td><code>active_count()</code></td><td>返回正在运行的线程数量</td></tr><tr><td></td><td></td></tr></tbody></table><p><strong>守护线程</strong></p><p>主线程会等待普通线程结束后才结束，而不会等待守护线程</p><p>要在<code>start()</code>前设置<code>t.daemon = True</code>才为守护线程</p><p>适合做后台服务或辅助任务</p><h2 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h2><p><strong>互斥锁</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><br>count = <span class="hljs-number">0</span><br>lock = threading.Lock()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    <span class="hljs-keyword">global</span> count<br>    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100000</span>):<br>        <span class="hljs-keyword">with</span> lock:<br>            count += <span class="hljs-number">1</span>  <span class="hljs-comment"># 保证这段代码只有一个线程能执行</span><br><br>t1 = threading.Thread(target=add)<br>t2 = threading.Thread(target=add)<br>t1.start()<br>t2.start()<br>t1.join()<br>t2.join()<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;count:&quot;</span>, count)<br></code></pre></td></tr></table></figure><p><strong>可重入锁</strong></p><p><code>threading.RLock()</code></p><p>支持一个线程加多次锁，适合递归或多个函数都加锁时</p><p><strong>信号量</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br>sem = threading.Semaphore(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 最多3个线程同时进入</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">task</span>():<br>    <span class="hljs-keyword">with</span> sem:<br>        <span class="hljs-built_in">print</span>(threading.current_thread().name, <span class="hljs-string">&quot;进入&quot;</span>)<br>        time.sleep(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p><strong>线程通知</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> threading<br><span class="hljs-keyword">import</span> time<br><br>event = threading.Event()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;等待事件触发...&quot;</span>)<br>    event.wait()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;事件已触发，开始工作&quot;</span>)<br><br>t = threading.Thread(target=worker)<br>t.start()<br><br>time.sleep(<span class="hljs-number">3</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;触发事件！&quot;</span>)<br>event.<span class="hljs-built_in">set</span>()<br></code></pre></td></tr></table></figure><h1 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h1><p>通过<code>dump()</code>转换为json格式，<code>load()</code>读取json</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br><span class="hljs-comment"># 写入文件</span><br>data = &#123;<span class="hljs-string">&#x27;name&#x27;</span>: <span class="hljs-string">&#x27;Bob&#x27;</span>, <span class="hljs-string">&#x27;age&#x27;</span>: <span class="hljs-number">30</span>, <span class="hljs-string">&#x27;is_student&#x27;</span>: <span class="hljs-literal">True</span>&#125;<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.json&#x27;</span>, <span class="hljs-string">&#x27;w&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    json.dump(data, f, indent=<span class="hljs-number">4</span>, ensure_ascii=<span class="hljs-literal">False</span>)<br><br><span class="hljs-comment"># 读出json数据</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;data.json&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    data = json.load(f)<br>    <span class="hljs-built_in">print</span>(data)<br></code></pre></td></tr></table></figure><h1 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h1><p>python的包管理工具</p><ul><li><p>查看pip版本</p><p>  <code>pip --version</code></p></li><li><p>下载包</p><p>  <code>pip install 包名</code></p></li><li><p>删除包</p><p>  <code>pip uninstall 包名</code></p></li><li><p>查看已安装的包</p><p>  <code>pip list</code></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AE</title>
    <link href="/2025/05/06/%E5%85%B6%E4%BB%96/AE/"/>
    <url>/2025/05/06/%E5%85%B6%E4%BB%96/AE/</url>
    
    <content type="html"><![CDATA[<h1 id="AE"><a href="#AE" class="headerlink" title="AE"></a>AE</h1><h2 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h2><table><thead><tr><th>说明</th><th>快捷键</th></tr></thead><tbody><tr><td>选取工具</td><td>v</td></tr><tr><td>手型工具</td><td>h</td></tr><tr><td>裁剪素材</td><td>alt + [ 或 alt+ ]</td></tr><tr><td>预合成（类似多个素材打包成一个）</td><td>cltr + shift + c</td></tr><tr><td>素材头(尾)时间移到指示器</td><td>[ 或 ]</td></tr><tr><td>居中锚点</td><td>ctrl + alt + home</td></tr><tr><td>居中素材</td><td>ctrl + home</td></tr><tr><td>合成设置</td><td>ctrl + k</td></tr><tr><td>显示关键帧</td><td>u</td></tr><tr><td>显示&#x2F;隐藏图层空间</td><td>ctrl + shift + h</td></tr></tbody></table><p><strong>对素材</strong></p><table><thead><tr><th>说明</th><th>快捷键</th></tr></thead><tbody><tr><td>缩放</td><td>s</td></tr><tr><td>旋转</td><td>r</td></tr><tr><td>位置</td><td>p</td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table><h2 id="找资源"><a href="#找资源" class="headerlink" title="找资源"></a>找资源</h2><p><a href="https://www.lookae.com/">https://www.lookae.com/</a></p><h2 id="混合模式"><a href="#混合模式" class="headerlink" title="混合模式"></a>混合模式</h2><blockquote><p>和当前图层的下面那个图层混合</p></blockquote><p>都是对灰度值（亮度）进行计算，白色为1，黑色为0</p><ul><li>变暗：取二者小的</li><li>变亮：取二者大的</li><li>相加：二者相加</li><li>相减：二者相减</li><li><strong>相乘</strong>（正片叠底）：和纯白相乘为原来的颜色，和纯黑相乘为纯黑，和其他相乘都会变暗（因为灰度在0~1间，怎么乘都会变小）。扣白留黑</li><li><strong>屏幕</strong>（滤色，screen）：扣黑留白</li><li>叠加：亮的地方更亮，暗的地方更暗</li><li>差值：取二者之差的绝对值</li></ul><h2 id="摄像机跟踪"><a href="#摄像机跟踪" class="headerlink" title="摄像机跟踪"></a>摄像机跟踪</h2><h3 id="打开方式"><a href="#打开方式" class="headerlink" title="打开方式"></a>打开方式</h3><p>方法一：动画 -&gt; 跟踪摄像机</p><p>方法二：窗口 -&gt; 跟踪器 -&gt; 跟踪摄像机</p><h3 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h3><p>贴图、抠像</p><h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><blockquote><p>先shitf选取多个点，右键<strong>设置地平面和原点</strong></p></blockquote><p>选择多个点，右键<strong>构建实底和摄像机</strong>，就可以创建一个纯色图层定在这几个点上</p><p>再按住shift选择素材（打开三维开关）的父级关联器，选择纯色图层，就能将素材固定到这个位置（这时纯色图层可以隐藏掉）</p><h2 id="运动跟踪"><a href="#运动跟踪" class="headerlink" title="运动跟踪"></a>运动跟踪</h2><h3 id="打开方式-1"><a href="#打开方式-1" class="headerlink" title="打开方式"></a>打开方式</h3><p>方法一：窗口 -&gt; 跟踪器 -&gt; 跟踪运动</p><h3 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h3><p>和摄像机跟踪的区别在于，运动跟踪只作用于XY轴，适合在平面的跟踪</p><h3 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h3><p>将跟踪点框住要跟踪的目标，点击分析</p><p>之后选择编辑目标，选择素材，之后点应用</p><h2 id="抠像"><a href="#抠像" class="headerlink" title="抠像"></a>抠像</h2><h3 id="颜色抠像"><a href="#颜色抠像" class="headerlink" title="颜色抠像"></a><strong>颜色抠像</strong></h3><h5 id="打开方式-2"><a href="#打开方式-2" class="headerlink" title="打开方式"></a>打开方式</h5><p>效果 -&gt; 抠像 -&gt; 线性颜色键</p><h3 id="keylight抠像"><a href="#keylight抠像" class="headerlink" title="keylight抠像"></a>keylight抠像</h3><h4 id="打开方式-3"><a href="#打开方式-3" class="headerlink" title="打开方式"></a>打开方式</h4><p>AE2022版本：效果 -&gt; keying -&gt; keylight</p><p>AE2025版本：效果 -&gt; 抠像 -&gt; keylight</p><h3 id="roto工具抠像"><a href="#roto工具抠像" class="headerlink" title="roto工具抠像"></a>roto工具抠像</h3><p>用于比较复杂的场景</p><h4 id="打开方式-4"><a href="#打开方式-4" class="headerlink" title="打开方式"></a>打开方式</h4><p>工具栏 -&gt; roto工具</p><p>roto工具下的边缘调整工具可以用来选择roto工具框选的边缘，来框下边缘的细节</p><h4 id="使用方法-2"><a href="#使用方法-2" class="headerlink" title="使用方法"></a>使用方法</h4><p>双击素材，在素材上拖动为选择，按住alt拖动为减选</p><p>选择完后播放，会自动解算 </p><h2 id="时间码"><a href="#时间码" class="headerlink" title="时间码"></a>时间码</h2><h3 id="打开方式-5"><a href="#打开方式-5" class="headerlink" title="打开方式"></a>打开方式</h3><p>创建一个纯色图层 -&gt; 效果 -&gt; 文本</p><p>其中，编号用来计时，时间码显示的是时间线上的时间</p><h2 id="常用表达式"><a href="#常用表达式" class="headerlink" title="常用表达式"></a>常用表达式</h2><blockquote><p>表达式的优先级高于关键帧</p></blockquote><h3 id="打开"><a href="#打开" class="headerlink" title="打开"></a>打开</h3><p>按alt在有码表的地方点击即可</p><p>按两下e打开有表达式的属性</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul><li><p>value：这个属性的初始值</p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 一维属性，如旋转,给其赋值</span><br>value = <span class="hljs-number">50</span><br><span class="hljs-comment">// 二维属性，如位置</span><br>value = [<span class="hljs-number">100</span>, <span class="hljs-number">100</span>]<br></code></pre></td></tr></table></figure></li><li><p>time：当前时间轴的时间（秒）</p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 可用于属性的值随时间变化</span><br>time * <span class="hljs-number">100</span><br></code></pre></td></tr></table></figure></li><li><p>index：素材的序号</p></li><li><p>wiggle(频率, 振幅)：晃动，返回值的个数会根据属性变化</p></li><li><p>random(最小值, 最大值)：随机数</p></li><li><p>Math.round()：四舍五入取整</p></li><li><p>Math.floor()：向下取整</p></li><li><p>Math.ceil()：向上取整</p></li><li><p>Math.exp(): 指数函数</p></li><li><p>linear(t, tMin, tMax, value1, value2)：将t在[tMin, tMax]的值映射成[value1, value2]</p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// t = 0时返回0，随着t的增大返回值也增大，t = 1920时返回100</span><br>t = thisComp.<span class="hljs-title function_">layer</span>(<span class="hljs-string">&quot;形状图层 1&quot;</span>).<span class="hljs-property">transform</span>.<span class="hljs-property">position</span>[<span class="hljs-number">0</span>]<br><span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title function_">linear</span>(t, <span class="hljs-number">0</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>))<br></code></pre></td></tr></table></figure></li><li><p>if&#x2F;else</p></li><li><p>inPoint&#x2F;outPoint：合成的开始时间和结束时间（秒）</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>日本旅游</title>
    <link href="/2025/04/11/%E6%97%85%E6%B8%B8/%E6%97%A5%E6%9C%AC%E6%97%85%E6%B8%B8/"/>
    <url>/2025/04/11/%E6%97%85%E6%B8%B8/%E6%97%A5%E6%9C%AC%E6%97%85%E6%B8%B8/</url>
    
    <content type="html"><![CDATA[<h1 id="日本旅游"><a href="#日本旅游" class="headerlink" title="日本旅游"></a>日本旅游</h1><h2 id="签证办理"><a href="#签证办理" class="headerlink" title="签证办理"></a>签证办理</h2><ul><li><input checked="" disabled="" type="checkbox"> 护照原件</li><li><input checked="" disabled="" type="checkbox"> 白底彩照2张+电子版</li><li><input checked="" disabled="" type="checkbox"> 申请表+紧急联系人表+个人同意书+签收单</li><li><input checked="" disabled="" type="checkbox"> 户口本首页+户主页+本人页1:1彩色复印件</li><li><input checked="" disabled="" type="checkbox"> 身份证正反面彩印</li><li><input checked="" disabled="" type="checkbox"> 大陆全日制本科学历学信网报告（电子信息备案表+毕业证复印件）</li></ul><h2 id="出行前准备"><a href="#出行前准备" class="headerlink" title="出行前准备"></a>出行前准备</h2><ul><li><input checked="" disabled="" type="checkbox"> 办理签证</li><li><input checked="" disabled="" type="checkbox"> 现金</li><li><input checked="" disabled="" type="checkbox"> 流量卡</li><li><input checked="" disabled="" type="checkbox"> 垃圾袋</li><li><input checked="" disabled="" type="checkbox"> 机票</li><li><input checked="" disabled="" type="checkbox"> 酒店</li><li><input disabled="" type="checkbox"> 交通卡</li><li><input checked="" disabled="" type="checkbox"> VJW</li><li><input checked="" disabled="" type="checkbox"> 零钱包</li></ul><h2 id="App"><a href="#App" class="headerlink" title="App"></a>App</h2><ul><li>VoiceTra：翻译软件</li><li>KuliKuli：点菜翻译软件</li><li>Booking：订酒店软件</li><li>Agoda：订酒店软件</li><li>Google Map</li></ul><h2 id="日程规划"><a href="#日程规划" class="headerlink" title="日程规划"></a>日程规划</h2><p><a href="https://hk.anitabi.cn/map?c=139.7545,35.6294&z=11.4">巡礼地图</a></p><p><strong>day1（5.22）</strong></p><ul><li><p>浅草寺（雷门，上午7点40来，记得带硬币）</p></li><li><p>隅田川、晴空塔</p></li><li><p>东京站</p><ul><li><p>gbc</p><p>  <img src="/img/travel_img/gbc1.png"></p></li><li><p>天丼てんや（驻地市场或者东京站）</p></li></ul></li><li><p>皇居</p><ul><li>二重桥</li></ul></li><li><p>银座</p><ul><li><p>银座四丁目交叉点</p></li><li><p>朝日稲荷神社（天气之子，10点开始）</p></li><li><p>末日后酒店巡礼</p><p>  <img src="/img/travel_img/%E6%9C%AB%E6%97%A5%E5%90%8E%E9%85%92%E5%BA%971.png"></p></li></ul></li><li><p>驻地市场</p></li><li><p>东京塔（9~23点）</p></li><li><p>惠比寿花园广场38F观景台（20点）</p><blockquote><p>惠比寿站下车，东口出来右拐一直走</p></blockquote></li></ul><p><strong>day2</strong></p><ul><li><p>上野</p><ul><li>上野公园</li><li>国立西洋美术馆</li><li>东京国立博物馆</li><li>阿美横町</li></ul></li><li><p>秋叶原</p><ul><li>atre商场二楼往上</li><li>ラジオ会館</li><li>寿屋</li><li>骏河屋</li></ul><blockquote><p>地铁 电器街口出</p></blockquote><p>  <img src="/img/travel_img/%E7%A7%8B%E5%8F%B6%E5%8E%9F.png"></p><p>  <img src="/img/travel_img/%E5%91%BD%E8%BF%90%E7%9F%B3%E4%B9%8B%E9%97%A8.png" alt="命运石之门"></p></li><li><p>池袋</p><ul><li>mygo<ul><li>飞鸟山公园（不在池袋）</li><li>千登世橋</li><li>鬼子母神前駅</li><li>sunshine city</li><li>sunshine 水族馆</li><li>太阳城60展望台（9:00～22:00）</li><li><img src="/img/travel_img/mygo1.png"></li><li>西武池袋本店（8楼）</li><li><img src="/img/travel_img/mygo2.png" alt="六本木站下车 soyo家"></li></ul></li><li>国立新美术馆</li><li>六本木大厦<ul><li>观景台</li></ul></li></ul></li></ul><p><strong>day3</strong></p><ul><li>秋叶神社</li><li>新宿、涩谷<ul><li><p><img src="/img/travel_img/%E6%96%B0%E5%AE%BF%E6%B6%A9%E8%B0%B7.png"></p></li><li><p>須賀神社（你的名字）</p></li><li><p>代代木公园（东京爱情故事）</p></li><li><p>shibuya sky（傍晚）</p></li><li><p>歌舞伎町（回头路晚上再去）</p></li></ul></li></ul><p><strong>day4</strong></p><ul><li>富士山（选天气好的时候去）<ul><li>河口湖</li><li>山中湖</li><li>忍野八海</li><li>日川时计店</li><li>富士山五合目</li><li>新仓山浅间公园</li></ul></li><li>再去银座看看</li></ul><p><strong>day5</strong></p><ul><li>东京大学</li><li>下北泽<ul><li>见<a href="https://hk.anitabi.cn/map?bangumiId=328609&amp;c=139.6674,35.6617&amp;z=16.6">https://hk.anitabi.cn/map?bangumiId=328609&amp;c=139.6674,35.6617&amp;z=16.6</a></li></ul></li><li>买点纪念品、伴手礼</li></ul><h2 id="地下铁"><a href="#地下铁" class="headerlink" title="地下铁"></a>地下铁</h2><h3 id="JR"><a href="#JR" class="headerlink" title="JR"></a>JR</h3><h4 id="山手线"><a href="#山手线" class="headerlink" title="山手线"></a>山手线</h4><ul><li>上野<ul><li>上野恩赐公园</li><li>上野动物园</li><li>阿美横町</li></ul></li><li>东京<ul><li>东京车站一番街</li></ul></li><li>新桥</li><li>品川<ul><li>羽田机场</li></ul></li><li>涩谷<ul><li>shibuya sky</li><li>十字街口</li></ul></li><li>新宿<ul><li>歌舞伎町</li></ul></li><li>池袋</li></ul><p><img src="/img/travel_img/%E5%B1%B1%E6%89%8B%E7%BA%BF.png" alt="山手线"></p><h3 id="都营地下铁"><a href="#都营地下铁" class="headerlink" title="都营地下铁"></a>都营地下铁</h3><p>log：叶子</p><h4 id="都营浅草线"><a href="#都营浅草线" class="headerlink" title="都营浅草线"></a>都营浅草线</h4><ul><li>押上<ul><li>晴空塔</li></ul></li><li>浅草<ul><li>浅草寺</li><li>隅田公園</li></ul></li><li>新桥</li></ul><p><img src="/img/travel_img/%E9%83%BD%E8%90%A5%E6%B5%85%E8%8D%89%E7%BA%BF.png" alt="都营浅草线"></p><h4 id="新宿线"><a href="#新宿线" class="headerlink" title="新宿线"></a>新宿线</h4><p><img src="/img/travel_img/%E6%96%B0%E5%AE%BF%E7%BA%BF.png" alt="新宿线"></p><h4 id="大江户线"><a href="#大江户线" class="headerlink" title="大江户线"></a>大江户线</h4><ul><li>赤羽桥<ul><li>东京塔</li></ul></li><li>筑地市场</li></ul><p><img src="/img/travel_img/%E5%A4%A7%E6%B1%9F%E6%88%B7%E7%BA%BF.png" alt="大江户线"></p><h3 id="东京地下铁"><a href="#东京地下铁" class="headerlink" title="东京地下铁"></a>东京地下铁</h3><p>log：M</p><h4 id="日比谷线"><a href="#日比谷线" class="headerlink" title="日比谷线"></a>日比谷线</h4><ul><li>秋叶原</li><li>筑地市场</li><li>银座</li><li>六本木</li></ul><p><img src="/img/travel_img/%E6%97%A5%E6%AF%94%E8%B0%B7%E7%BA%BF.png" alt="日比谷线"></p><h4 id="丸之内线"><a href="#丸之内线" class="headerlink" title="丸之内线"></a>丸之内线</h4><p><img src="/img/travel_img/%E4%B8%B8%E4%B9%8B%E5%86%85%E7%BA%BF.png" alt="丸之内线"></p>]]></content>
    
    
    <categories>
      
      <category>旅游</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>数据库</title>
    <link href="/2025/02/25/%E8%80%83%E7%A0%94/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <url>/2025/02/25/%E8%80%83%E7%A0%94/%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>数据：数据库中存储的基本对象</p><p>数据库（DataBase，<strong>DB</strong>）：长期存储在计算机内，有组织的、可共享的大量数据的集合</p><p>数据库管理系统（DataBase Management System，<strong>DBMS</strong>）：数据定义、数据组织、存储和管理</p><p>数据定义语言（Data Definition Language，<strong>DDL</strong>）</p><p>数据操纵（Data Manipulation Language，<strong>DML</strong>）：增删改查</p><p>数据库系统（DataBase System，<strong>DBS</strong>）：数据库+数据库管理系统+应用系统+数据库管理员</p><h2 id="数据库管理发展阶段"><a href="#数据库管理发展阶段" class="headerlink" title="数据库管理发展阶段"></a>数据库管理发展阶段</h2><ol><li><strong>人工管理</strong><ul><li>数据不保存</li><li>应用程序管理数据</li><li>数据不共享</li><li>数据不具有独立性</li></ul></li><li><strong>文件系统</strong><ul><li>数据可以长期保存</li><li>由文件系统管理数据</li><li>共享性差、独立性差</li></ul></li><li><strong>数据库系统</strong><ul><li>数据结构化</li><li>数据共享性高、冗余度低、易扩充</li><li>数据独立性高</li><li>数据由DBMS统一管理和控制</li></ul></li></ol><h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>数据模型（Data Model）：对现实世界数据特征的抽象</p><ol><li>概念模型：也称信息模型，主要用于数据库设计</li><li>逻辑模型：主要用于DBMS的实现</li><li>物理模型：数据在计算机硬件上的存储方式</li></ol><p>组成要素：</p><ol><li>数据结构</li><li>数据操作</li><li>完整性约束<ol><li>实体完整性：主属性非空且唯一（主键）</li><li>参照完整性：关系间的引用（外键）</li><li>用户定义完整性：用户定义的取值范围</li></ol></li></ol><h2 id="三级模式"><a href="#三级模式" class="headerlink" title="三级模式"></a>三级模式</h2><ul><li>外模式（应用模式）：展示给用户的数据</li><li>模式（概念模式）：数据库里存的数据</li><li>内模式（物理模式）：物理硬盘中存的数据</li></ul><p>各个模式之间数据的转换叫映像</p><h1 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h1><h2 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h2><p>关系：二维表</p><p>域（Domain）：取值范围</p><p>笛卡尔积：不同域之间所有排列组合的集合</p><p>元组（Tuple）：表里的一条数据</p><p>基数：笛卡尔积里包含的组合的数量</p><p>码（键）：</p><ul><li><strong>候选码</strong>：能够唯一标识关系中每一行（元组）的最小属性集合</li><li>全码：需要所有的属性才能唯一确定一条记录</li><li>主码：从候选码中选出来的一个</li><li><strong>主属性</strong>：包含在任何一个候选码中的属性</li><li>非主属性：不属于任何候选码</li><li><strong>关键字</strong>：唯一标识行的属性集合，包括超键、候选码、主键、外键等</li></ul><h2 id="✨基本操作"><a href="#✨基本操作" class="headerlink" title="✨基本操作"></a>✨基本操作</h2><p><img src="/img/db_img/%E8%BF%90%E7%AE%97%E7%AC%A6.png"></p><p><strong>对行运算</strong></p><ul><li><p>并：两张要有同样的属性，并后会去重</p><p>  <img src="/img/db_img/%E5%B9%B6%E8%BF%90%E7%AE%97.png"></p></li><li><p>差：两张要有同样的属性，在第一张表不在第二张表的数据</p></li><li><p>交：两张要有同样的属性，在第一张表且在第二张表的数据</p></li><li><p>笛卡尔积：</p><p>  <img src="/img/db_img/%E7%AC%9B%E5%8D%A1%E5%B0%94%E7%A7%AF%E8%BF%90%E7%AE%97.png"></p></li></ul><p><strong>对列运算</strong></p><ul><li><p>选择：选择符合条件的元组（行）</p><p>  <img src="/img/db_img/%E9%80%89%E6%8B%A9%E8%BF%90%E7%AE%97.png"></p></li><li><p>投影：选出若干属性组成新的关系，会去重</p><p>  <img src="/img/db_img/%E6%8A%95%E5%BD%B1%E8%BF%90%E7%AE%97.png"></p></li><li><p>连接：</p><ul><li><p>一般连接</p><p>  <img src="/img/db_img/%E4%B8%80%E8%88%AC%E8%BF%9E%E6%8E%A5%E8%BF%90%E7%AE%97.png"></p></li><li><p>等值连接</p><p>  <img src="/img/db_img/%E7%AD%89%E5%80%BC%E8%BF%9E%E6%8E%A5%E8%BF%90%E7%AE%97.png"></p></li><li><p>自然连接</p><p>  <img src="/img/db_img/%E8%87%AA%E7%84%B6%E8%BF%9E%E6%8E%A5%E8%BF%90%E7%AE%97.png"></p></li><li><p>外连接：不符合条件的元组也保留，没有的值为NULL</p></li><li><p>左（右）外连接：只保留左（右）不符合条件的元组</p></li></ul></li><li><p>除：</p><p>  <img src="/img/db_img/%E9%99%A4%E8%BF%90%E7%AE%97.png"></p><p>  a1的像集把S中的B、C都包括了</p></li></ul><h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><h2 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h2><p>一个模式下可以包含多张表，视图和索引等数据库对象</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 定义模式给某个用户<br><span class="hljs-keyword">create</span> schema <span class="hljs-operator">&lt;</span>模式名<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">authorization</span> <span class="hljs-operator">&lt;</span>用户名<span class="hljs-operator">&gt;</span>;<br><br># 删除模式<br><span class="hljs-keyword">drop</span> schema <span class="hljs-operator">&lt;</span>模式名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>cascade <span class="hljs-operator">|</span> restrict<span class="hljs-operator">&gt;</span>;<br>cascade: 把数据库对象也一起删了<br>restrict: 如果模式下有表、视图等，则不执行删除<br></code></pre></td></tr></table></figure><h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 创建表<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">&lt;</span>表名<span class="hljs-operator">&gt;</span> (<br>    <span class="hljs-operator">&lt;</span>列名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>数据类型<span class="hljs-operator">&gt;</span> [完整性约束],<br>    ...<br>);<br><br># 修改表<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">&lt;</span>表名<span class="hljs-operator">&gt;</span><br>[<span class="hljs-keyword">add</span> <span class="hljs-keyword">column</span> <span class="hljs-operator">&lt;</span>列名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>数据类型<span class="hljs-operator">&gt;</span> [完整性约束]]<br>[<span class="hljs-keyword">drop</span> <span class="hljs-keyword">column</span> <span class="hljs-operator">&lt;</span>列名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>cascade <span class="hljs-operator">|</span> restrict<span class="hljs-operator">&gt;</span>]<br>[<span class="hljs-keyword">alter</span> <span class="hljs-keyword">column</span> <span class="hljs-operator">&lt;</span>列名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>数据类型<span class="hljs-operator">&gt;</span>];<br><br># 删除表<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">&lt;</span>表名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>cascade <span class="hljs-operator">|</span> restrict<span class="hljs-operator">&gt;</span>;<br>cascade: 直接删<br>restrict: 有被其他表约束所引用、有视图、有触发器等就不能删<br></code></pre></td></tr></table></figure><p><strong>数据类型</strong></p><p><img src="/img/db_img/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B.png"></p><p><strong>数据查询</strong></p><p><img src="/img/db_img/%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2.png"></p><ul><li>distance: 消除查询出来的重复行</li></ul><p><strong>聚合函数</strong></p><p><img src="/img/db_img/%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0.png"></p><ul><li>除了count(*)，其他聚合函数都会跳过空值</li><li>聚合函数只能用于select子句和group by中的having子句</li><li>having用于分组后按要求对这些组进行筛选</li><li>order by不能在子查询的select中使用</li></ul><p><strong>集合查询</strong></p><ul><li>union：并</li><li>intersect：交</li><li>except：差</li></ul><h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 创建索引<br><span class="hljs-keyword">create</span> [<span class="hljs-keyword">unique</span>] [cluster] index <span class="hljs-operator">&lt;</span>索引名<span class="hljs-operator">&gt;</span><br><span class="hljs-keyword">on</span> <span class="hljs-operator">&lt;</span>表名<span class="hljs-operator">&gt;</span>(<span class="hljs-operator">&lt;</span>列名<span class="hljs-operator">&gt;</span> [<span class="hljs-keyword">asc</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">desc</span>], ...);<br><span class="hljs-keyword">unique</span>: 表明此索引的每一个索引值只对应唯一的数据记录<br>cluster: 聚簇索引<br># 修改索引名<br><span class="hljs-keyword">alter</span> index <span class="hljs-operator">&lt;</span>旧索引名<span class="hljs-operator">&gt;</span> rename <span class="hljs-keyword">to</span> <span class="hljs-operator">&lt;</span>新索引名<span class="hljs-operator">&gt;</span>;<br># 删除索引<br><span class="hljs-keyword">drop</span> index <span class="hljs-operator">&lt;</span>索引名<span class="hljs-operator">&gt;</span>;<br></code></pre></td></tr></table></figure><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p>从一个或几个基本表中导出的表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 建立视图<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> <span class="hljs-operator">&lt;</span>视图名<span class="hljs-operator">&gt;</span>(列名, ...)<br><span class="hljs-keyword">as</span> <span class="hljs-operator">&lt;</span>子查询<span class="hljs-operator">&gt;</span><br>[<span class="hljs-keyword">with</span> <span class="hljs-keyword">check</span> option];<br><span class="hljs-keyword">with</span> <span class="hljs-keyword">check</span> option: 对视图的增删改也要满足子查询的条件<br># 删除视图<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">view</span> <span class="hljs-operator">&lt;</span>视图名<span class="hljs-operator">&gt;</span>[cascade]<br>cascade: 即使有视图上的视图也能删除<br># 删改查视图<br># 同表操作一样<br></code></pre></td></tr></table></figure><h1 id="数据库安全性"><a href="#数据库安全性" class="headerlink" title="数据库安全性"></a>数据库安全性</h1><p><strong>用户身份鉴别</strong>：</p><ol><li>静态口令（密码）</li><li>动态口令（短信验证）</li><li>生物特征（指纹）</li><li>智能卡</li></ol><p><strong>存取控制</strong>：</p><ol><li><p>自主存取控制（DAC）</p><p> 用户对于不同的数据库有不同的权限</p><p> 不同的用户对同一对象也有不同的权限</p></li><li><p>强制存取控制（MAC）</p><p> 每一个数据库对象都被标以一定的密级</p><p> 只有有相应级别的用户才能访问</p></li></ol><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"># 自主存取控制方式<br># 赋予权限<br><span class="hljs-keyword">grant</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">update</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">insert</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">delete</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">all</span> privileges<span class="hljs-operator">&gt;</span>, ...<br><span class="hljs-keyword">on</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">table</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">view</span> <span class="hljs-operator">|</span> ...<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>表名<span class="hljs-operator">&gt;</span><br><span class="hljs-keyword">to</span> <span class="hljs-operator">&lt;</span>用户名<span class="hljs-operator">&gt;</span><br># 收回权限<br><span class="hljs-keyword">revoke</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">update</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">insert</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">delete</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">all</span> privileges<span class="hljs-operator">&gt;</span>, ...<br><span class="hljs-keyword">on</span> <span class="hljs-operator">&lt;</span><span class="hljs-keyword">table</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">view</span> <span class="hljs-operator">|</span> ...<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>表名<span class="hljs-operator">&gt;</span><br><span class="hljs-keyword">from</span> <span class="hljs-operator">&lt;</span>用户名<span class="hljs-operator">&gt;</span> <span class="hljs-operator">&lt;</span>cascade <span class="hljs-operator">|</span> restrict<span class="hljs-operator">&gt;</span><br>cascade: 把这个用户赋给其他用户的权限也回收<br>restrict: 只回收这个用户的权限<br></code></pre></td></tr></table></figure><h1 id="数据库完整性"><a href="#数据库完整性" class="headerlink" title="数据库完整性"></a>数据库完整性</h1><p>是指数据的正确性和相容性</p><ul><li>正确性：反映现实的实际状况</li><li>相容性：同一对象在不同关系表中的数据是符合逻辑的</li></ul><h2 id="实体完整性"><a href="#实体完整性" class="headerlink" title="实体完整性"></a>实体完整性</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">primary</span> key: 定义主键<br></code></pre></td></tr></table></figure><h2 id="参照完整性"><a href="#参照完整性" class="headerlink" title="参照完整性"></a>参照完整性</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">foreing key(外键名) <span class="hljs-keyword">references</span> 表名(列名): 定义外键<br></code></pre></td></tr></table></figure><h2 id="用户定义完整性"><a href="#用户定义完整性" class="headerlink" title="用户定义完整性"></a>用户定义完整性</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>: 非空<br><span class="hljs-keyword">unique</span>: 唯一<br><span class="hljs-keyword">check</span>(条件): 检查值是否符合条件<br></code></pre></td></tr></table></figure><h1 id="关系数据理论"><a href="#关系数据理论" class="headerlink" title="关系数据理论"></a>关系数据理论</h1><h2 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h2><table><thead><tr><th>范式</th><th>说明</th><th>解决的异常</th></tr></thead><tbody><tr><td>第一范式（1NF）</td><td>每一个分量必须是不可再分的数据项</td><td></td></tr><tr><td>第二范式（2NF）</td><td>非主属性没有部分依赖</td><td>消除了更新异常</td></tr><tr><td>第三范式（3NF）</td><td>非主属性没有传递依赖</td><td>消除了<strong>部分的</strong>插入和删除异常</td></tr><tr><td>BCNF</td><td>所有主属性对每一个不包含它的码也是完全函数依赖</td><td></td></tr></tbody></table><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><ul><li>函数依赖：x值确认后，能够唯一的确认出y。记作x -&gt; y</li><li>非平凡依赖：x -&gt; y, 但y ∉ x</li><li>平凡依赖：x -&gt; y, 但y ∈ x</li><li>完全函数依赖：x -&gt; y，且x的真子集都推不出y</li><li>传递依赖：x -&gt; y, y -&gt; z, y 推不出 x, 则x -&gt; z</li></ul><h2 id="规范化"><a href="#规范化" class="headerlink" title="规范化"></a>规范化</h2><p>模式可能存在的问题：</p><ol><li>数据冗余</li><li>更新异常：没更新全部数据导致数据不一致</li><li>插入异常</li><li>删除异常</li></ol><h1 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h1><h2 id="数据库设计6个阶段"><a href="#数据库设计6个阶段" class="headerlink" title="数据库设计6个阶段"></a>数据库设计6个阶段</h2><ol><li><p><strong>需求分析</strong></p><p> 最困难，最耗时，数据字典</p></li><li><p><strong>概念结构设计</strong></p><p> E-R图</p></li><li><p><strong>逻辑结构设计</strong></p><p> 关系模式设计、表、规范化处理</p></li><li><p><strong>物理结构设计</strong></p><p> 设置索引</p></li><li><p><strong>数据库实施</strong></p></li><li><p><strong>数据库运行和维护</strong></p></li></ol><h2 id="各子系统的E-R图间的冲突"><a href="#各子系统的E-R图间的冲突" class="headerlink" title="各子系统的E-R图间的冲突"></a>各子系统的E-R图间的冲突</h2><ol><li><p>属性冲突</p><p> 取值范围、单位不一致</p></li><li><p>命名冲突</p><p> 同一意思在不同的表里名字不一样，或者意思不一样但名字一样</p></li><li><p>结构冲突</p><p> 一个对象在有的表里是属性，有的表里是对象；同一个对象在不同表里属性不同；实体间联系在不同的E-R图为不同类型</p></li></ol><h1 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h1><h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><ol><li>原子性</li><li>一致性</li><li>隔离性</li><li>持久性</li></ol><h2 id="数据不一致问题"><a href="#数据不一致问题" class="headerlink" title="数据不一致问题"></a>数据不一致问题</h2><ol><li><p>丢失数据</p><p> 事务一起提交，其中一个被覆盖</p></li><li><p>读“脏”数据</p><p> 事务1修改数据后，事务2读取，事务1回滚，导致事务2读取的是脏数据</p></li><li><p>不可重复读</p><p> 事务1读取某一行后，事务2进行了修改，事务1再次读取与前一次的结果不一致</p></li><li><p>幻读</p><p> 事务1读取一些数据，事务2添加&#x2F;删除了一部分数据，事务1再次读取与前一次的结果不一致</p></li></ol><h2 id="封锁"><a href="#封锁" class="headerlink" title="封锁"></a>封锁</h2><p>排它锁（写锁、X锁）；共享锁（读锁、S锁）</p><ol><li>一级封锁协议（解决丢失数据）：修改数据前加<strong>X锁</strong>，<strong>事务结束后</strong>释放</li><li>二级封锁协议（解决读脏数据）：读取数据前加<strong>S锁</strong>，<strong>读完后</strong>释放</li><li>三级封锁协议（解决不可重复读）：读取数据前加<strong>S锁</strong>，<strong>事务结束后</strong>释放</li></ol><h2 id="活锁死锁"><a href="#活锁死锁" class="headerlink" title="活锁死锁"></a>活锁死锁</h2><p>活锁：加锁无限等待，可用先来先服务解决</p><p>死锁的预防：</p><ul><li>一次封锁法：将要使用的数据一次全部加锁</li><li>顺序封锁发：对数据对象规定一个封锁顺序</li></ul><p>死锁的诊断和解除：</p><ul><li>超时法：一个事务等待时间过长就认为发生死锁</li><li>等待图法：事务间等待的有向图，若出现环路则为死锁</li></ul><p>死锁的解除：</p><p>​撤销一个处理死锁代价最小的事务</p><h2 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h2><p>如果对一个节点加意向锁，说明该节点的下层节点正在被加锁</p><ul><li>意向共享锁（IS锁）：拟向下层节点添加S锁</li><li>意向排它锁（IX锁）：拟向下层节点添加X锁</li><li>共享意向排他锁（SIX锁）：先加S锁，再加IX锁，表示要读整个表，并更新个别元组</li></ul><p>意向锁作用：多粒度封锁提高了并发性，减少了加锁和解锁的开销</p><h1 id="关系模式题型"><a href="#关系模式题型" class="headerlink" title="关系模式题型"></a>关系模式题型</h1><h2 id="求候选键"><a href="#求候选键" class="headerlink" title="求候选键"></a>求候选键</h2><p>步骤：</p><ol><li>分为L（仅出现在左）、R（仅出现在右）、N（都没出现）、LR（两边都出现）</li><li>令X &#x3D; L ∪ N，如果X能推出全集，就是候选键（结束）</li><li>上一步推不出：从LR中选一个和X组合，若能推出全集，就是候选键</li><li>把第三步选择的去掉后：从LR选两个和X组合</li><li>一般最多只选到两个</li></ol><h2 id="求最小函数依赖集"><a href="#求最小函数依赖集" class="headerlink" title="求最小函数依赖集"></a>求最小函数依赖集</h2><p>步骤：</p><ol><li>分解右侧为单属性</li><li>消除冗余函数依赖</li><li>消除左侧冗余属性</li></ol><h2 id="规范化程度"><a href="#规范化程度" class="headerlink" title="规范化程度"></a>规范化程度</h2><table><thead><tr><th>范式</th><th>条件</th></tr></thead><tbody><tr><td>1NF</td><td>所有属性值都是<strong>原子</strong></td></tr><tr><td>2NF</td><td>所有非主属性必须<strong>完全依赖候选键</strong>（部分依赖）</td></tr><tr><td>3NF</td><td>非主属性不能<strong>传递依赖</strong>候选键（传递依赖）</td></tr><tr><td>BCNF</td><td>函数依赖的左侧必须是<strong>超键</strong></td></tr></tbody></table><p>步骤：</p><ol><li>求出候选键</li><li>判断部分依赖</li><li>判断传递依赖</li><li>左边都是候选键 –&gt;BCNF</li></ol><h2 id="判断无损连接"><a href="#判断无损连接" class="headerlink" title="判断无损连接"></a>判断无损连接</h2><p>步骤：</p><ol><li>求出最小函数依赖集</li><li>根据最小函数依赖集推表格</li></ol><h2 id="分解为3NF"><a href="#分解为3NF" class="headerlink" title="分解为3NF"></a>分解为3NF</h2><ol><li>基于最小函数依赖集构建子关系模式</li><li>强制包含候选键的关系模式（加一个就行）</li><li>合并冗余表（把被包含的去掉）</li></ol><p><img src="/img/db_img/%E5%88%86%E8%A7%A3%E4%B8%BA3nf.png"></p><h2 id="分解为BCNF"><a href="#分解为BCNF" class="headerlink" title="分解为BCNF"></a>分解为BCNF</h2><p>步骤：</p><ol><li>确定候选键</li><li>检查违反BCNF的依赖</li><li>分解关系，如果分解后仍然不满足需要继续分解</li></ol><p><img src="/img/db_img/%E5%88%86%E8%A7%A3%E4%B8%BAbcnf.png"></p><h1 id="简答题"><a href="#简答题" class="headerlink" title="简答题"></a>简答题</h1><ol><li><p>什么是数据、数据库、数据库管理系统、数据库系统</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数据（Data）：数据是数据库中存储的基本对象<br>数据库（Database）：数据库是长期存储在计算机内、有组织的、可共享的大量数据集合<br>数据库管理系统（DBMS）：数据库管理系统是一种软件系统，用于管理和组织数据库，确保数据库的安全性和完整性，提供对数据的存储、访问、处理和保护等功能，支持多个用户同时或不同时刻对数据库进行操作<br>数据库系统（DBS）：数据库系统指在计算机系统中引入数据库的系统，由数据库、数据库管理系统（及其开发工具）、应用系统、数据库管理员构成<br></code></pre></td></tr></table></figure></li><li><p>什么是事务，事务的特征，事务和程序的区别</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">事务：事务是用户定义的数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位<br>事务的特征：<br>原子性：要么全部成功，要么全部失败<br>一致性：事务执行前后，数据库必须保持一致性状态<br>隔离性：多个并发事务的执行是相互隔离的，一个事务的操作不会影响其他事务<br>持久性：一旦事务提交成功，其对数据库的修改就是永久性的，即使系统发生故障也不会丢失<br>事务和程序的区别：一个事务可以是一条或一组SQL语句；一个应用程序通常包含多个事务<br></code></pre></td></tr></table></figure></li><li><p>什么是计算机系统完整性，完整性约束对象作用的对象是</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">完整性：数据的正确性和相容性，防止不合语义的数据进入数据库<br>作用对象：<br>列：对属性的取值类型、范围、精度等的约束条件<br>元组：对元组各个属性列间的联系的约束<br>关系：对若干元组、关系之间以及关系集合上的联系的约束<br></code></pre></td></tr></table></figure></li><li><p>什么是封锁，什么是排它锁和共享锁</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">封锁是数据库管理系统中用于实现并发控制的一种机制，它允许事务在操作数据之前对数据对象加锁<br>排它锁：排它锁是一种独占锁，当一个事务对数据对象加排它锁后，其他事务既不能读取也不能修改该数据对象，直到锁被释放<br>共享锁：共享锁是一种非独占锁，当一个事务对数据对象加共享锁后，其他事务可以读取该数据对象，但不能修改它，直到锁被释放<br></code></pre></td></tr></table></figure></li><li><p>数据库设计的基本步骤</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">需求分析<br>概念结构设计<br>逻辑结构设计<br>物理结构设计<br>数据库实施<br>数据库的运行和维护<br></code></pre></td></tr></table></figure></li><li><p>什么是活锁和死锁</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">活锁：某些事务可能因为优先级低或其他原因，始终无法获得资源，导致事务无法完成，处于永久等待状态<br>死锁：指两个或两个以上的事务分别请求封锁对方已经封锁的数据，导致循环等待而无法继续运行下去<br></code></pre></td></tr></table></figure></li><li><p>简述关系数据库规范化理论，并给出2NF，3MF、BCNF的定义</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">规范化理论是以关系模型为背景，进行数据库逻辑设计的有力工具。其逐步消除数据依赖中不合适的部分，使关系模型中的各个关系模式达到某种程度的分离<br>2NF: 所有非主属性都完全函数依赖于主码<br>3NF: 所有非主属性都不传递依赖于主码<br>BCNF: 对于每一个非平凡的函数依赖 X → Y，X 必须是超键<br></code></pre></td></tr></table></figure></li><li><p>简述数据库体系结构及其数据独立性的关系</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数据库体系结构可以概括为三级模式和二级映像，三级模式分别为外模式、模式和内模式，二级映像为外模式/模式映像、模式/内模式映像。<br>外模式是数据库与外部应用程序对应的局部逻辑描述，一个数据库可以有多个外模式；<br>模式是数据库整体逻辑结构的描述，一个数据库对应一个模式；<br>内模式是数据库存储及物理环境相关的逻辑描述，一个数据库对应一个内模式；<br>数据的独立性分为逻辑独立性和物理独立性。逻辑独立性是指外部的应用程序不会因为数据库逻辑结构的改变而改变，是由外模式/模式映像支持的；物理独立性是指外部应用程序不必因为数据库内部存储结构的改变而改变，是由模式/内模式映像支持的<br></code></pre></td></tr></table></figure></li><li><p>试给出二级封锁协议的内容并举例说明其如何解决读脏数据问题</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">一级封锁协议：事务T在修改数据R之前必须对其加X锁，直到事务结束才释放；<br>二级封锁协议：在一级基础上，事务T在读取数据R之前必须先对其加S锁，读完释放<br></code></pre></td></tr></table></figure></li><li><p>数据库系统管理数据的主要特点</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数据结构化；<br>数据独立性高；<br>数据共享性高、冗余度低、易扩充；<br>数据由DBMS统一管理和控制<br></code></pre></td></tr></table></figure></li><li><p>简述并发操作的可串行性</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">DBMS对并发事务不同的调度可能会产生不同的结果，当且仅当其结果和按某一次序串行的执行这些事务时的结果相同时，多个事务的并发执行是正确的。称这种调度策略为并发执行的可串行性，这也是判断并发调度策略正确与否的唯一标准<br></code></pre></td></tr></table></figure></li><li><p>关系数据库管理系统的数据字典存储哪些内容</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数据字典通常包括数据项、数据结构、数据流、数据存储和处理过程5个部分。<br>其中，数据项是数据的最小组成单位，若干个数据项可以组成一个数据结构，数据字典通过对数据项和数据结构的定义来描述数据流、数据存储的逻辑内容<br></code></pre></td></tr></table></figure></li><li><p>数据字典的作用是什么</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数据字典是关于数据库中数据的描述，在需求分析阶段建立，是下一步进行概念设计的基础，并在数据库设计过程中不断修改、充实和完善<br></code></pre></td></tr></table></figure></li><li><p>试描述DBMS查询优化的一般准则</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">1.选择运算应尽可能先做<br>2.把投影运算和选择运算同时进行<br>3.把投影同其前或后的双目运算结合起来执行<br>4.把某些选择同在它前面要执行的笛卡尔积结合起来成为一个连接运算<br>5.找出公共子表达式<br>6.选取合适的连接算法<br></code></pre></td></tr></table></figure></li><li><p>三类完整性约束是什么</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">1.实体完整性：基本关系的所有主属性都不能取空值<br>2.参照完整性：在两个关系之间建立联系时，必须满足某些条件，以保证数据的一致性和完整性<br>3.用户定义完整性：用于保证数据的语义正确性，常见有唯一性、条件检查和非空性<br></code></pre></td></tr></table></figure></li><li><p>什么是自主存取控制和强制存取控制</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">自主存取控制方法允许拥有者自主决定哪些用户可以访问其数据，并可以将其拥有的存取权限转授给其他用户。这种控制方法相对灵活，适用于需要高度自定义权限的场景。但存在权限滥用的风险，影响数据的安全性<br>强制存取控制方法由系统对数据对象的存取进行强制性的约束和控制。每一个数据对象都被标记为一定的密级，而每一个用户也被授予某个级别的许可证。只有用户的许可证级别高于或等于数据对象的密级时，才能访问该数据对象。这种控制方法相对严格，可以减少权限滥用的风险，从而提高数据的安全性。<br></code></pre></td></tr></table></figure></li><li><p>什么是数据的完整性约束，什么是数据库的独立性</p>  <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">数据完整性约束可以防止无效的、不一致的或缺失的数据进入数据库，从而提高数据的质量和可靠性。数据完整性约束可以分为三类：实体完整性、参照完整性和用户定义完整性。<br>数据库的独立性是指应用程序的数据独立于数据库系统中的数据，即数据的改变不会影响应用程序的正确性，包括逻辑独立性和物理独立性。<br>逻辑独立性：是用户的应用程序与数据库的逻辑结构是相互独立的。<br>当模式改变时，数据库管理员修改外模式/模式映像，可以使外模式保持不变，应用程序是根据外模式编写的，从而应用程序不必修改，保证了数据与程序的逻辑独立性。<br>物理独立性：是用户的应用程序与存储在磁盘上的数据库中的数据是相互独立的<br>当数据库的存储结构改变时，数据库管理员修改模式/内模式映像，可以使模式保持不变，从而应用程序不必修改，保证了数据与程序的物理独立性。<br></code></pre></td></tr></table></figure></li><li><p>DBMS的五大功能</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">1.数据定义：提供DDL来创建、修改和删除数据库中的数据结构，如创建表、定义字段、设置约束等<br>2.数据操作：提供DML进行增删改查等操作，常用的命令包括SELECT、INSERT、UPDATE和DELETE<br>3.数据维护：包括数据备份、恢复优化和维护等功能<br>4.数据控制：提供DCL用于管理数据库的访问权限，如GRANT和REVOKE命令<br>5.事务管理：包括事务的提交、回滚和隔离等功能<br></code></pre></td></tr></table></figure></li><li><p>为什么要有数据库数据恢复子系统</p> <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs TEXT">因为计算机系统中硬件的故障、软件的错误、操作员的失误以及恶意的破坏是不可避免的，影响数据的正确性，因此必须有恢复子系统<br>恢复子系统的功能是把数据库从错误状态恢复到某一已知的正确状态<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计网</title>
    <link href="/2025/01/01/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%BD%91/"/>
    <url>/2025/01/01/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h2><ol><li><p>速率：数据的传输速率，也称为比特率或数据率</p></li><li><p>带宽：信号具有的频率成分范围，信道的频带宽度</p></li><li><p>吞吐量：单位时间通过信道、接口等的数据量</p></li><li><p><strong>时延</strong>：传输所需时间</p><ol><li>发送时延</li><li>传播时延（传播速度看做是固定的，<strong>200m&#x2F;us</strong>）</li><li>处理时延（分析首部、提取数据、差错检验、查找路由等）</li><li>排队时延（在输入输出队列中排毒的时间）</li></ol><blockquote><p>时延带宽积：以比特为单位的链路长度</p><p>时延带宽积 &#x3D; 传播时延 * 带宽</p></blockquote></li><li><p>利用率：有数据通过时间 &#x2F; 总时间，利用率并非越高越好</p></li></ol><h2 id="五层协议"><a href="#五层协议" class="headerlink" title="五层协议"></a>五层协议</h2><p>结合了 OSI七层结构 和 TCP四层结构</p><p><img src="/img/internet_img/%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png" alt="体系结构"></p><p><img src="/img/internet_img/%E5%90%84%E5%B1%82%E4%BD%9C%E7%94%A8.png" alt="各层作用"></p><blockquote><p>PDU(Protocol Data Unit)：</p></blockquote><h1 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h1><blockquote><p>编码：数据 –&gt; 数字信号</p><p>调制：数据 –&gt; 模拟信号</p></blockquote><h2 id="编码方式"><a href="#编码方式" class="headerlink" title="编码方式"></a>编码方式</h2><ol><li>非归零编码：正电平1，负电平0</li><li>归零编码：正脉冲1，负脉冲0</li><li>曼彻斯特编码：高到低跳变1，低到高跳变0（也可以反过来）</li><li>差分曼彻斯特编码：每一位的中心始终都有跳变。开始边界有跳变为0，没有为1</li></ol><p><img src="/img/internet_img/%E7%BC%96%E7%A0%81%E6%96%B9%E5%BC%8F.png"></p><h2 id="信道"><a href="#信道" class="headerlink" title="信道"></a>信道</h2><p><strong>信道带宽</strong>：信道能通过的频率范围</p><p><strong>奈氏准则</strong>（奈奎斯特定理）：</p><p>​为了避免码间串扰，码元的传输速率上限为2W<strong>波特</strong>（W是信道的带宽，单位Hz）</p><p>​理想低通道下的极限数据传输率为<strong>2Wlog2(v)</strong> (<strong>比特</strong>&#x2F;秒)（v为每个码元能表示的比特数）</p><blockquote><p>波特：码元传输速率单位，他说明单位时间传输了多少个码元</p><p>比特：每秒传输 二进制代码 位数</p><p>码元：数字通信中用来承载信息的基本单位，一个码元可以表示一个或多个比特</p></blockquote><p><strong>信噪比</strong>：S &#x2F; N（信号的平均功率 &#x2F; 噪声的平均功率），用分贝作为度量单位，dB &#x3D; 10 * log10(S&#x2F;N)</p><p>​如S&#x2F;N &#x3D; 1000，信噪比为10 * log10(30) &#x3D; 30 dB</p><p><strong>香农定理</strong>：</p><p>​在带宽受限及有高斯白噪声干扰下，信道的极限、无差错的信息传输速率</p><p>​<strong>C &#x3D; W log2(1 + S&#x2F;N)</strong>  (bit &#x2F; s)</p><blockquote><p>当两个定理算出来的值不相等时，以小的为准</p></blockquote><h2 id="信道复用"><a href="#信道复用" class="headerlink" title="信道复用"></a>信道复用</h2><ul><li><p><strong>频分复用</strong>（FDM）</p><p>  使用调制的方法，把各路信号分别搬移到适当的频率位置，各路信号在同样的时间占用不同的带宽资源</p></li><li><p><strong>时分复用</strong>（TDM）</p><p>  将时间划分为一段段等长的时分复用帧，每一路信号在每一个 TDM帧中占用固定序号的时隙</p></li></ul><p><img src="/img/internet_img/%E4%BF%A1%E9%81%93%E5%A4%8D%E7%94%A81.png"></p><ul><li><p><strong>波分复用</strong>（WDM）</p><p>  光的频分复用</p></li><li><p><strong>码分复用</strong>（CDM）</p><p>  各用户使用经过特殊挑选的不同码型，彼此之间不会干扰</p><p>  <img src="/img/internet_img/%E7%A0%81%E5%88%86%E5%A4%8D%E7%94%A8.png"></p></li></ul><blockquote><p>码分复用例题</p><p><img src="/img/internet_img/%E7%A0%81%E5%88%86%E5%A4%8D%E7%94%A8%E4%BE%8B%E9%A2%98.png"></p></blockquote><h2 id="线缆"><a href="#线缆" class="headerlink" title="线缆"></a>线缆</h2><h3 id="1-双绞线（Twisted-Pair）"><a href="#1-双绞线（Twisted-Pair）" class="headerlink" title="1. 双绞线（Twisted Pair）"></a>1. <strong>双绞线（Twisted Pair）</strong></h3><ul><li><strong>结构</strong>：由两根绝缘铜线相互绞合而成，减少电磁干扰。</li><li><strong>类型</strong>：<ul><li><strong>非屏蔽双绞线（UTP, Unshielded Twisted Pair）</strong>：<ul><li>常见于以太网（如 Cat5、Cat6）。</li><li>成本低，易于安装。</li></ul></li><li><strong>屏蔽双绞线（STP, Shielded Twisted Pair）</strong>：<ul><li>外层有屏蔽层，抗干扰能力强。</li><li>适用于高干扰环境。</li></ul></li></ul></li><li><strong>应用</strong>：<ul><li>局域网（LAN）、电话线路。</li></ul></li><li><strong>标准</strong>：<ul><li>Cat5：支持 100 Mbps（100 米）。</li><li>Cat6：支持 1 Gbps（100 米）。</li></ul></li></ul><hr><h3 id="2-同轴电缆（Coaxial-Cable）"><a href="#2-同轴电缆（Coaxial-Cable）" class="headerlink" title="2. 同轴电缆（Coaxial Cable）"></a>2. <strong>同轴电缆（Coaxial Cable）</strong></h3><ul><li><strong>结构</strong>：由内导体、绝缘层、屏蔽层和外护套组成。</li><li><strong>类型</strong>：<ul><li><strong>细同轴电缆（Thinnet）</strong>：<ul><li>直径较小，适用于短距离传输。</li></ul></li><li><strong>粗同轴电缆（Thicknet）</strong>：<ul><li>直径较大，适用于长距离传输。</li></ul></li></ul></li><li><strong>应用</strong>：<ul><li>早期以太网、有线电视（CATV）。</li></ul></li><li><strong>特点</strong>：<ul><li>抗干扰能力强，但成本较高，安装复杂。</li></ul></li></ul><hr><h3 id="3-光纤（Fiber-Optic-Cable）"><a href="#3-光纤（Fiber-Optic-Cable）" class="headerlink" title="3. 光纤（Fiber Optic Cable）"></a>3. <strong>光纤（Fiber Optic Cable）</strong></h3><ul><li><strong>结构</strong>：由玻璃或塑料纤维制成，通过光信号传输数据。</li><li><strong>类型</strong>：<ul><li><strong>单模光纤（Single-Mode Fiber）</strong>：<ul><li>芯径小，传输距离远（可达数十公里）。</li><li>适用于长距离、高速传输。</li></ul></li><li><strong>多模光纤（Multi-Mode Fiber）</strong>：<ul><li>芯径较大，传输距离较短（通常 2 公里以内）。</li><li>适用于短距离、高速传输。</li></ul></li></ul></li><li><strong>应用</strong>：<ul><li>数据中心、广域网（WAN）、电信网络。</li></ul></li><li><strong>特点</strong>：<ul><li>带宽高，抗干扰能力强，但成本较高。</li></ul></li></ul><hr><h3 id="4-串行电缆（Serial-Cable）"><a href="#4-串行电缆（Serial-Cable）" class="headerlink" title="4. 串行电缆（Serial Cable）"></a>4. <strong>串行电缆（Serial Cable）</strong></h3><ul><li><strong>结构</strong>：用于串行通信，通常为多芯电缆。</li><li><strong>类型</strong>：<ul><li><strong>RS-232</strong>：用于短距离通信（如计算机与调制解调器）。</li><li><strong>RS-485</strong>：支持多点通信，适用于工业环境。</li></ul></li><li><strong>应用</strong>：<ul><li>串行通信、工业控制。</li></ul></li></ul><hr><h3 id="5-USB-电缆（Universal-Serial-Bus-Cable）"><a href="#5-USB-电缆（Universal-Serial-Bus-Cable）" class="headerlink" title="5. USB 电缆（Universal Serial Bus Cable）"></a>5. <strong>USB 电缆（Universal Serial Bus Cable）</strong></h3><ul><li><strong>结构</strong>：用于连接计算机与外部设备，支持数据传输和供电。</li><li><strong>类型</strong>：<ul><li>USB 2.0：传输速率 480 Mbps。</li><li>USB 3.0：传输速率 5 Gbps。</li><li>USB-C：支持正反插，传输速率可达 40 Gbps（USB 4.0）。</li></ul></li><li><strong>应用</strong>：<ul><li>外设连接（如打印机、移动硬盘）。</li></ul></li></ul><hr><h3 id="6-电力线通信（Power-Line-Communication-PLC）"><a href="#6-电力线通信（Power-Line-Communication-PLC）" class="headerlink" title="6. 电力线通信（Power Line Communication, PLC）"></a>6. <strong>电力线通信（Power Line Communication, PLC）</strong></h3><ul><li><strong>结构</strong>：利用电力线传输数据。</li><li><strong>应用</strong>：<ul><li>家庭网络、智能电网。</li></ul></li><li><strong>特点</strong>：<ul><li>无需额外布线，但受电力线干扰影响。</li></ul></li></ul><hr><h3 id="7-无线介质（Wireless-Media）"><a href="#7-无线介质（Wireless-Media）" class="headerlink" title="7. 无线介质（Wireless Media）"></a>7. <strong>无线介质（Wireless Media）</strong></h3><ul><li><strong>类型</strong>：<ul><li><strong>无线电波</strong>：如 Wi-Fi、蓝牙。</li><li><strong>微波</strong>：如卫星通信。</li><li><strong>红外线</strong>：如遥控器。</li></ul></li><li><strong>应用</strong>：<ul><li>无线网络、移动通信。</li></ul></li></ul><h1 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h1><p>节点与节点之间传输</p><h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><ul><li>链路：节点之间的物理通道</li><li>数据链路：节点间的逻辑通道，既数据链路 &#x3D; 链路 + 协议</li><li>帧：链路层的协议数据单元，封装网络层的数据报</li></ul><h2 id="三个基本功能"><a href="#三个基本功能" class="headerlink" title="三个基本功能"></a>三个基本功能</h2><ol><li><p>封装成帧</p><p> 把若干比特打包成帧，便于检错和判断帧开始与帧结束</p><ul><li>帧的数据部分不能超过<strong>MTU</strong>（最大传输单元）</li><li>帧定界符：<strong>SOH</strong>（Start Of Header）、<strong>EOT</strong>（End Of Transmission）</li></ul></li><li><p>透明传输</p><p> 成帧的标识可作为数据传输</p><ul><li>数据部分出现定界符时前插<strong>ESC</strong>（转义字符），传给网络层时删除</li></ul></li><li><p>差错检测</p><p> 检测帧的传输是否有比特错误</p><ul><li><p>检错</p><ol><li><p>奇偶校验</p></li><li><p>循环冗余校验CRC</p><p> <img src="/img/internet_img/CRC%E5%86%97%E4%BD%99%E6%A0%A1%E9%AA%8C%E7%A0%81.png"></p><p> 只要信息位不要太长，余数不为0时表示第几位出现了错误，因此循环冗余校验有一定的纠错能力</p></li></ol></li><li><p>纠错</p><ol><li><p>海明校验码</p><p> 将信息位分为k组进行偶校验。</p><p> 注意：2^k ≥ n + k + 1；校验位Pi放在2^(i - 1)位置上</p><p> 1位纠错能力、2位检错能力</p><p> <img src="/img/internet_img/%E6%B5%B7%E6%98%8E%E7%A0%81%E6%B1%82%E8%A7%A3%E6%AD%A5%E9%AA%A4.png"></p></li></ol></li></ul></li></ol><h2 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h2><ol><li><p><strong>停止-等待协议（SW）</strong></p><p> 发送窗口 &#x3D; 1；接收窗口 &#x3D; 1</p><p> 用多少bit给帧编号：2^n &gt;&#x3D; WT + WR（n为bit数，WT为发送窗口，WR为接收窗口）</p></li><li><p><strong>后退N帧协议（GBN）</strong></p><p> 发送窗口 &gt; 1；接收窗口 &#x3D; 1</p><p> 发送帧丢失：若发送方对于某一个帧迟迟未收到ack，则这个帧之后所有已发送的帧都要重传</p><p> 确认帧丢失：因为是只对最后一个收到的帧发送ack，故发送方没收到ack就要重传整个发送窗口的帧</p></li><li><p><strong>选择重传协议（SR）</strong></p><p> 发送窗口 &gt; 1；接收窗口 &gt; 1，接收窗口不能比发送窗口大</p><p> <strong>每个帧都需要返回ack</strong></p><p> 数据帧丢失：一组里面哪个丢了，超时后就重传哪个帧</p><p> 数据帧出错：发送出错的帧的编号nak（主动请求），发送方重传</p><p> 确认帧丢失：超时重传，接收方收到重复帧也返回对应的ack</p></li></ol><h2 id="介质访问控制"><a href="#介质访问控制" class="headerlink" title="介质访问控制"></a>介质访问控制</h2><ol><li><p>信道换分：</p><ul><li><p><strong>时分复用</strong>（TDM）</p><p>  将时间分成等长的TDM帧，每个帧又分为m个等长的时隙，并分配给m个用户使用</p><p>  缺点：信道利用率低</p></li><li><p><strong>统计时分复用</strong>（STDM）</p><p>  又称异步时分复用，动态按需分配时隙</p></li><li><p><strong>频分复用</strong>（FDM）</p><p>  将信道的总频带划分为多个子频带</p><p>  优点：各个节点可同时发送信号</p><p>  缺点：只能用于模拟信号</p></li><li><p><strong>波分复用</strong>（WDM）</p><p>  光的频分复用，将各节点发出的不同波长的光信号复合到光纤上</p></li><li><p><strong>码分复用</strong>（CDM）</p><p>  给每个节点赋予专属的码片序列，节点发送1时发送码片，0时发送码片的反码。码片序列需要相互正交（内积为0）</p><p>  收到数据后，用节点的码片乘之，再除以码片的维度，就能得到这个节点发送的信号（因为正交，乘其他节点的码片得到的都是0）</p></li></ul></li><li><p>随机访问：</p><ul><li><p><strong>ALOHA协议</strong></p><p>  帧准备好后<strong>直接</strong>发送到信道上，等到收到ack后再传下个帧。如果因为冲突传送失败了，在等待随机一段时间后会重传</p></li><li><p><strong>时隙ALOHA协议</strong></p><p>  只有在每个时隙开始时才能发送到信道上，降低冲突发生的概率</p></li><li><p><strong>CSMA协议</strong>（载波监听多路访问协议）</p><p>  在ALOHA协议基础上，发送数据前先监听信道是否空闲，只有空闲时才会尝试发送</p><ul><li><p><strong>1-坚持CSMA协议</strong></p><p>  一直监听</p></li><li><p><strong>非坚持CSMA协议</strong></p><p>  监听到信道不空闲后放弃监听，随机一段时间后再监听</p><p>  当多个节点准备好数据时，这么做可以错开发送数据的时间，降低冲突概率</p></li><li><p><strong>p-坚持CSMA协议</strong></p><p>  监听到信道<strong>空闲</strong>后有p概率直接发送，1-p概率推迟一段时间再发送。监听到信道<strong>不空闲</strong>坚持监听</p><p>  降低先到空闲时一起发送数据产生的冲突概率</p></li></ul></li><li><p>✨<strong>CSMA&#x2F;CD协议</strong>（CD: 冲突检测）</p><ol><li>用于早期的有线以太网（总线型）；</li><li>最短帧长：2 * 最大单向传播时延 * 信道带宽（为了当数据传到最远时仍没有发完，此时检测到冲突可停止发送。如果发完了但产生了冲突，就不会检测到冲突，但实际产生冲突了）；</li><li>最长帧长：防止某些节点一直占用信道；</li><li>CSMA没有ack机制，发完了就当成功了；</li><li>以太网规定：最短帧长64B，最长帧长1518B；</li></ol><p>  <img src="/img/internet_img/CSMACD%E5%8D%8F%E8%AE%AE.png"></p><p>  <img src="/img/internet_img/CSMACD%E5%8D%8F%E8%AE%AE%E6%80%BB%E7%BB%93.png" alt="总结">  </p></li><li><p><strong>CSMA&#x2F;CA协议</strong>（CA: 冲突避免）</p><ol><li>适用于无线局域网</li></ol><p>  <img src="/img/internet_img/CSMACA%E5%8D%8F%E8%AE%AE%E6%9C%AA%E8%80%83%E8%99%91%E9%9A%90%E8%94%BD%E7%AB%99.png" alt="未考虑隐蔽站"></p><p>  <img src="/img/internet_img/CSMACA%E5%8D%8F%E8%AE%AE%E8%80%83%E8%99%91%E9%9A%90%E8%94%BD%E7%AB%99.png" alt="解决隐蔽站问题"></p><blockquote><p>RTS: Request To Send 请求发送</p><p>CTS: Clear To Send 允许发送</p></blockquote><p>  <img src="/img/internet_img/CSMACA%E5%8D%8F%E8%AE%AE%E6%80%BB%E7%BB%93.png" alt="总结"></p></li></ul></li><li><p>轮询访问：</p><p> <strong>令牌传递协议</strong></p><p> <img src="/img/internet_img/%E4%BB%A4%E7%89%8C%E4%BC%A0%E9%80%92%E5%8D%8F%E8%AE%AE.png" alt="总结"></p></li></ol><h2 id="局域网"><a href="#局域网" class="headerlink" title="局域网"></a>局域网</h2><p><strong>特点</strong>：</p><ol><li>覆盖范围小</li><li>较低的时延和误码率</li><li>节点间以帧为单位传输</li><li>支持单播、广播和多播</li></ol><p><img src="/img/internet_img/%E5%B1%80%E5%9F%9F%E7%BD%91.png" alt="局域网"></p><p><img src="/img/internet_img/%E7%A1%AC%E4%BB%B6%E6%9E%B6%E6%9E%84.png" alt="硬件架构"></p><p><strong>IEEE802.3以太网标准</strong>（物理层）</p><blockquote><p>IEEE802的分层划分为：物理层、介质访问控制层（类似数据链路层）、逻辑链路控制层</p></blockquote><p>全双工半双工：</p><ul><li>同轴电缆只能<strong>半双工</strong></li><li>双绞线：速率&lt; 2.5Gbps可支持<strong>半双工or全双工** ；速率&gt;&#x3D;2.5Gbps仅支持</strong>全双工**（节点连接时协商）</li><li>光纤只支持<strong>全双工</strong></li><li>默认交换机连接的终端节点都可以全双工，集线器的半双工</li></ul><p><strong>常见以太网MAC层标准</strong></p><p><img src="/img/internet_img/%E4%BB%A5%E5%A4%AA%E7%BD%91MAC%E5%B8%A7.png" alt="以太网MAC帧"></p><ul><li>V2标准和IEEE802.3标准的不同是一个是类型（网络层协议类型）一个是长度（数据部分长度）</li><li>当目的地址全为1时为广播帧，广播只会在局域网广播，即路由器不会把广播帧传出去</li></ul><p><strong>VLAN</strong></p><p>作用：</p><ol><li>可以将局域网划分为多个VLAN，每个VLAN是一个广播域</li></ol><p>划分方式：</p><ol><li>基于交换机的接口</li><li>基于设备的MAC地址</li><li>基于IP地址（需要网络层支持，让VLAN可以跨越路由器）</li></ol><blockquote><p>使用VLAN需要用支持VLAN的交换机</p><p><strong>交换机与交换机之间</strong>传输的是802.1Q帧，与标准以太网帧的区别是类型字段前面加了4字节的VLAN标签，用于标记发送方的VID</p></blockquote><p><strong>无线局域网</strong>（IEEE802.11）</p><p>门户（Portal）：将两类局域网（有线和无线）连接，变成一个更大的局域网</p><p><img src="/img/internet_img/80211%E6%95%B0%E6%8D%AE%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="数据帧格式"></p><h2 id="广域网"><a href="#广域网" class="headerlink" title="广域网"></a>广域网</h2><p>链路层协议：</p><ol><li><p>PPP协议</p><ul><li><p>只支持全双工</p></li><li><p>无需纠错、无需序号、无需流量控制</p></li><li><p>用字节填充法</p><ul><li>将0x7E(帧定界符) –&gt; 0x7D  0x5E</li><li>将0x7D–&gt; 0x7D  0x5D</li></ul></li><li><p>帧错误就丢弃</p></li><li><p>数据部分最大传输单元MTU</p></li></ul><p> <img src="/img/internet_img/PPP%E5%8D%8F%E8%AE%AE%E5%B8%A7%E6%A0%BC%E5%BC%8F.png" alt="PPP协议帧格式"></p><ul><li>地址字段：通常固定为<code>0xFF</code>，表示广播地址，由于PPP是点对点协议，地址字段的实际意义不大</li><li>协议字段<ul><li><code>0x0021</code>：IPv4</li><li><code>0x0057</code>：IPv6</li><li><code>0xC021</code>：链路控制协议（LCP）</li><li><code>0x8021</code>：网络控制协议（NCP）</li></ul></li></ul></li></ol><blockquote><p>PPP面向字节，使用字节填充法</p><p>HDLC（High-level Data Link Control）面向比特，使用比特填充法（每5个连续1则添加一个0）</p></blockquote><h2 id="以太网交换机"><a href="#以太网交换机" class="headerlink" title="以太网交换机"></a>以太网交换机</h2><p><strong>自学习功能</strong>：</p><ul><li>交换表：记录MAC地址和端口号的映射关系<ol><li>初始交换表为空，收到要转发的帧时不知道要转给谁，于是向所有端口广播</li><li>每次将发送方的MAC地址和端口记录到交换表中</li><li>每个表项有个有效期，过期作废，解决MAC地址和端口号的对应关系发生改变</li></ol></li></ul><p><strong>交换方式</strong>：</p><ul><li><p>直通交换</p><p>  交换机仅需接收并处理目的地址的6个字节</p><p>  <img src="/img/internet_img/%E7%9B%B4%E9%80%9A%E4%BA%A4%E6%8D%A2.png"></p></li><li><p>存储转发交换</p><p>  <img src="/img/internet_img/%E5%AD%98%E5%82%A8%E8%BD%AC%E5%8F%91%E4%BA%A4%E6%8D%A2.png"></p></li></ul><h2 id="HDLC"><a href="#HDLC" class="headerlink" title="HDLC"></a>HDLC</h2><p>High-Leve Data Link Control，高级数据链路控制协议</p><p><strong>面向比特传输</strong>，使用<strong>零比特插入法</strong>，属于数据链路层协议</p><p><strong>HDLC帧结构</strong></p><p><img src="/img/internet_img/HDLC%E5%B8%A7%E7%BB%93%E6%9E%84.png"></p><p><strong>HDLC帧类型</strong></p><ol><li>信息帧（I-frame）<ul><li>用于<strong>传输用户数据</strong>。</li><li>包含序列号（N(S) 和 N(R)），用于流量控制和确认。</li></ul></li><li>监控帧（S-frame）<ul><li>用于<strong>流量控制和错误控制</strong>。</li><li>包含确认号（N(R)），但不携带用户数据。</li><li>常见的监控帧类型：<ul><li>RR（Receive Ready）：准备接收下一帧。</li><li>RNR（Receive Not Ready）：暂时无法接收数据。</li><li>REJ（Reject）：请求重传指定帧。</li></ul></li></ul></li><li>无编号帧（U-frame）<ul><li>用于<strong>链路管理</strong>（如建立和释放连接）。</li><li>不包含序列号。</li><li>常见的无编号帧类型：<ul><li>SABM（Set Asynchronous Balanced Mode）：设置异步平衡模式。</li><li>DISC（Disconnect）：断开连接。</li><li>UA（Unnumbered Acknowledgment）：确认无编号帧。</li></ul></li></ul></li></ol><h2 id="IEEE-局域网模型"><a href="#IEEE-局域网模型" class="headerlink" title="IEEE 局域网模型"></a>IEEE 局域网模型</h2><h3 id="1-物理层（Physical-Layer）"><a href="#1-物理层（Physical-Layer）" class="headerlink" title="1. 物理层（Physical Layer）"></a>1. <strong>物理层（Physical Layer）</strong></h3><ul><li><strong>功能</strong>：<ul><li>负责在物理介质上传输原始的比特流。</li><li>定义电气、机械、功能和规程特性（如电缆类型、信号编码、传输速率）。</li></ul></li><li><strong>主要任务</strong>：<ul><li>比特流的传输和同步。</li><li>物理介质的连接和管理。</li></ul></li></ul><h3 id="2-介质访问控制子层（MAC-Medium-Access-Control）"><a href="#2-介质访问控制子层（MAC-Medium-Access-Control）" class="headerlink" title="2. 介质访问控制子层（MAC, Medium Access Control）"></a>2. <strong>介质访问控制子层（MAC, Medium Access Control）</strong></h3><ul><li><strong>功能</strong>：<ul><li>控制设备对共享传输介质的访问。</li><li>负责帧的封装和解封装，以及错误检测。</li></ul></li><li><strong>主要任务</strong>：<ul><li>MAC 地址的寻址和管理。</li><li>介质访问控制（如 CSMA&#x2F;CD、CSMA&#x2F;CA）。</li><li>帧的发送和接收。</li></ul></li></ul><h3 id="3-逻辑链路控制子层（LLC-Logical-Link-Control）"><a href="#3-逻辑链路控制子层（LLC-Logical-Link-Control）" class="headerlink" title="3. 逻辑链路控制子层（LLC, Logical Link Control）"></a>3. <strong>逻辑链路控制子层（LLC, Logical Link Control）</strong></h3><ul><li><strong>功能</strong>：<ul><li>提供与上层（网络层）的接口，实现可靠的数据传输。</li><li>负责流量控制、错误控制和帧的复用。</li></ul></li><li><strong>主要任务</strong>：<ul><li>建立和维护逻辑链路。</li><li>提供不同的服务类型（如无确认无连接、面向连接）。</li></ul></li></ul><h1 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h1><p>主机与主机之间传输</p><h2 id="网络层的功能"><a href="#网络层的功能" class="headerlink" title="网络层的功能"></a>网络层的功能</h2><ol><li>异构网络互联</li><li>路由与转发</li><li>拥塞控制</li></ol><h2 id="IPv4"><a href="#IPv4" class="headerlink" title="IPv4"></a>IPv4</h2><p><img src="/img/internet_img/%E5%90%84%E7%A7%8D%E5%8D%8F%E8%AE%AE%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB.png" alt="各种协议之间的关系"></p><p><img src="/img/internet_img/ip%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png" alt="ip数据报格式"></p><h3 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h3><p>受数据链路层最大帧长MTU的影响，网络层的IP数据报可能会被分片</p><p><img src="/img/internet_img/%E5%B8%A7%E5%88%86%E7%89%87.png"></p><p><img src="/img/internet_img/%E5%88%86%E7%89%87%E7%94%A8%E5%88%B0%E7%9A%84%E9%A6%96%E9%83%A8%E4%BF%A1%E6%81%AF.png" alt="分片用到的首部信息"></p><h3 id="ip地址分配"><a href="#ip地址分配" class="headerlink" title="ip地址分配"></a>ip地址分配</h3><p><strong>最初分配方案</strong></p><p><img src="/img/internet_img/%E6%9C%80%E5%88%9D%E7%9A%84ip%E5%9C%B0%E5%9D%80%E5%88%86%E7%B1%BB%E6%96%B9%E6%A1%88.png" alt="最初的ip地址分类方案"></p><p><img src="/img/internet_img/%E7%89%B9%E6%AE%8A%E7%94%A8%E9%80%94ip.png" alt="特殊用途ip"></p><h3 id="子网划分"><a href="#子网划分" class="headerlink" title="子网划分"></a>子网划分</h3><p>将一部分主机号拿出来划分子网号</p><p>子网掩码：</p><ul><li>1的位置对应网路号和子网号，0的位置对应主机号。和ip与运算后获得网络前缀，可用来判断是否在同一个子网</li><li>路由器要想使用子网掩码，转发表格式变为&lt;目的网络号，子网掩码，转发接口&gt;</li></ul><h3 id="无分类编址CIDR"><a href="#无分类编址CIDR" class="headerlink" title="无分类编址CIDR"></a>无分类编址CIDR</h3><p>网络号不再只有固定分发，可以根据需要来确定网络号的位数</p><p><strong>子网划分</strong></p><ol><li><p>定长子网划分</p><p> 子网号的位数固定，可能造成子网里的主机号利用率低</p></li><li><p>变长子网划分</p><p> 更灵活分配子网</p></li></ol><p><strong>路由聚合</strong></p><p>把路由表里<strong>转发接口</strong>相同，<strong>部分网络前缀</strong>也相同的几个表项聚合为一条，<strong>按照最长前缀匹配原则</strong>。</p><p>减少内存占用，加快查询速度</p><h3 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h3><p>Net Address Translation网络地址转换</p><p>作用：让一个局域网内的主机共享一个ip</p><p><img src="/img/internet_img/NAT%E6%80%BB%E7%BB%93.png" alt="总结"></p><h3 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h3><p>ARP协议用于查询同一网络中的&lt;IP地址，MAC地址&gt;之间的映射关系，存储在ARP表中。</p><p>在ARP表中还没有对应项时，通过ARP请求分组（广播）来找，之后目的主机通过ARP响应分组（单播）来告诉它的MAC地址。</p><p>ARP分组占28字节</p><h3 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h3><p>动态主机配置协议（应用层协议）</p><p><strong>作用</strong>：给刚接入网络的主机动态分配IP地址、配置默认网关、子网掩码</p><p><strong>过程</strong>：</p><blockquote><p>客户端UDP端口号68，服务器端UDP端口号67</p></blockquote><ol><li><p>发现报文（DISCOVER）</p><p> <img src="/img/internet_img/%E5%8F%91%E7%8E%B0%E6%8A%A5%E6%96%87.png" alt="新接入的客户端发送"></p><ul><li>还没分配IP地址，源地址填全0</li><li>目的MAC全1表示广播帧</li></ul></li><li><p>提供报文（OFFER）</p><p> <img src="/img/internet_img/%E6%8F%90%E4%BE%9B%E6%8A%A5%E6%96%87.png" alt="DHCP服务器响应给客户端"></p><ul><li>目的MAC从发现报文里知道了</li><li>目的IP仍然是全1广播</li><li>IP地址都是有有效期的</li></ul></li><li><p>请求报文（REQUEST）</p><p> <img src="/img/internet_img/%E8%AF%B7%E6%B1%82%E6%8A%A5%E6%96%87.png" alt="客户端发送"></p><ul><li>用于表示客户端收到了提供报文</li><li><strong>目的MAC还是全1广播，因为DHCP服务器可能不止一台，客户端收到的提供报文不知道是哪一台发的</strong></li><li>目的IP同理</li><li>接收的IP此时还不属于客户端，源IP仍然是全0</li></ul></li><li><p>确认报文（ACKNOWLEDGE）</p><p> 内容和提供报文一样的，表示DHCP服务器确认了</p></li></ol><h2 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h2><p><strong>首部</strong></p><p><img src="/img/internet_img/IPv6%E9%A6%96%E9%83%A8.png"></p><p><img src="/img/internet_img/IPv6%E5%9F%BA%E6%9C%AC%E9%A6%96%E9%83%A8.png" alt="基本首部"></p><p><strong>和IPv4的区别</strong></p><ol><li>地址为由4B扩展到<strong>16B</strong></li><li>移除校验和字段</li><li>移出了首部中的可选字段，变成了<strong>扩展首部</strong></li><li><strong>不需要DHCP</strong></li><li>首部长度由4B的倍数变为<strong>8B的倍数</strong></li><li><strong>只能在主机处分片</strong>，IPv4可以在路由器和主机处分片</li><li>取消了协议字段，改成了下一个首部字段</li><li>取消了总长度字段，改为有效载荷字段（因为首部固定40B）</li></ol><p><strong>基本地址类型</strong></p><ul><li>单播：一对一</li><li>多播：一对多</li><li>任播：一对多中的一个通信，是一种网络寻址和路由的策略，使得资料可以根据路由拓扑来决定送到“最近”或“最好”的目的地</li></ul><p><strong>IPv4向IPv6过渡策略</strong></p><ul><li><p>双栈协议</p><p>  主机同时用4和6的地址，路由器的不同接口分别配置了4和6的地址</p></li><li><p>隧道技术</p><p>  把IPv6作为数据部分封装到IPv4中来传输</p></li></ul><h2 id="IP组播（多播）"><a href="#IP组播（多播）" class="headerlink" title="IP组播（多播）"></a>IP组播（多播）</h2><p>​发送方只发送一次数据，通过组播理由协议传递数据到用户端尽可能近的节点后，才开始复制和分发</p><ul><li><p>组播地址范围为224.0.0.0~239.255.255.255（D类）</p></li><li><p>基于UDP，不产生ICMP差错报文</p></li><li><p>组播MAC地址开头为01-00-5E，余下的6个十六进制位根据IP组播组地址的最后23位来定</p><p>  <img src="/img/internet_img/%E7%BB%84%E6%92%ADMAC%E5%9C%B0%E5%9D%80.png"></p></li></ul><p><strong>IGMP协议</strong></p><p>网络层协议，让路由器知道本局域网上是否有主机参与或退出了某个组播组</p><p>过程：</p><ol><li>主机要想加入某组播组，向组播组的组播地址发送IGMP报文，路由器通过组播路由选择协议把这组成员关系发送到网上的其他组播路由协议</li><li>路由器周期性探寻本地局域网上的主机，以便知道这些主机是否还是组播组的成员</li></ol><p><strong>组播路由选择协议</strong></p><ol><li>基于链路状态的路由选择</li><li>基于距离-向量的路由选择</li><li>协议无关的组播</li></ol><h2 id="路由算法和路由协议"><a href="#路由算法和路由协议" class="headerlink" title="路由算法和路由协议"></a>路由算法和路由协议</h2><h3 id="路由算法"><a href="#路由算法" class="headerlink" title="路由算法"></a>路由算法</h3><blockquote><p>静态路由：手动配置每一条路由</p><p>动态路由：根据网络流量负载和拓扑结构动态调整自身路由表</p></blockquote><p><strong>常见的动态路由算法</strong></p><ol><li><p>距离-向量路由算法</p><p> x节点到y节点的最短花费为min{x到相邻节点的花费 + 相邻节点到y的花费}</p><p> 每个节点维护这些信息：</p><ol><li>到相邻节点的链路费用</li><li>到网络中其他节点的费用。这是一组距离，称为距离向量</li><li>收到的每个相邻节点的距离向量</li></ol><p> <img src="/img/internet_img/%E8%B7%9D%E7%A6%BB%E5%90%91%E9%87%8F%E8%B7%AF%E7%94%B1%E7%AE%97%E6%B3%95.png"></p><p> 节点间定期向每个邻居发送它的距离向量副本；</p><p> 收到邻居的副本后可更新自己的距离向量，并向邻居发送更新报文</p><p> 缺点：在大型网络中会导致很大的更新报文</p><p> 常见有RIP算法</p></li><li><p>链路状态路由算法</p><p> 要求每个节点都具有全网拓扑结构图；</p><p> 主动测试<strong>所有相邻节点</strong>的状态，定期的将链路状态广播给<strong>所有其他节点</strong></p><p> 通过Dijkstra最短路径算法计算到达其他节点的最短路径</p><p> 优点：适用于大型网络，有更好的扩展性</p><p> 常见有OSPF算法</p></li></ol><h3 id="路由协议"><a href="#路由协议" class="headerlink" title="路由协议"></a>路由协议</h3><blockquote><p>自治系统AS：整个互联网划分为许多较小的系统</p><p><img src="/img/internet_img/%E8%87%AA%E6%B2%BB%E7%B3%BB%E7%BB%9F.png"></p></blockquote><p><strong>内部网关协议（IGP，Interior Gateway Protocol）</strong></p><p>自治系统内使用的</p><ul><li><p>RIP（Routing Info Protocol，路由信息协议）</p><p>  应用层协议、UDP、520端口</p><p>  规定：</p><ol><li>每个节点维护距离向量</li><li>使用<strong>跳数</strong>作为花费</li><li>一条路径最多15跳，16跳认为不可达，因此适用于小型网络</li><li>路由表项&lt;目的网络，距离，下一跳路由器地址&gt;</li><li>定期(如<strong>30s</strong>)向相邻路由器交换路由信息</li></ol><p>  <img src="/img/internet_img/RIP%E7%A4%BA%E4%BE%8B.png" alt="示例"></p><p>  优缺点：</p><ol><li>实现简单、开销小、收敛过程快</li><li>发现距离更短路由消息传播的快</li><li>发现故障传播的慢</li></ol></li><li><p>OSPF（开放最短路径优先）</p><p>  网络层协议、IP数据包</p><p>  规定：</p><ol><li>使用泛洪法向自治系统中所有路由器发送消息</li><li>使用迪杰斯特拉算法计算最短路径</li></ol></li></ul><p><strong>外部网关协议（EGP，External Gateway Protocol）</strong></p><p>自治系统间使用的</p><ul><li><p>BGP（Border Gateway Protocol，边界网关协议）</p><p>  应用层协议、基于TCP</p><p>  <img src="/img/internet_img/BGP1.png"></p><p>  <img src="/img/internet_img/BGP2.png"></p></li></ul><p><strong>三种路由协议比较</strong></p><p><img src="/img/internet_img/%E4%B8%89%E7%A7%8D%E8%B7%AF%E7%94%B1%E5%8D%8F%E8%AE%AE%E6%AF%94%E8%BE%83.png"></p><h1 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h1><h2 id="传输层的功能"><a href="#传输层的功能" class="headerlink" title="传输层的功能"></a>传输层的功能</h2><p><strong>端口</strong></p><p>分类：</p><ul><li><p>服务器使用的端口号：</p><ul><li><p>熟知端口号0~1023</p><p>  <img src="/img/internet_img/%E7%86%9F%E7%9F%A5%E7%AB%AF%E5%8F%A3%E5%8F%B7.png"></p></li><li><p>登记端口号1024~49151</p></li></ul></li><li><p>客户端使用的端口号：</p><ul><li>49152~65535（16bit）</li></ul></li></ul><p>注意点：</p><ul><li>两台主机的端口号是相互独立的</li><li>TCP、UDP的端口号也是相互独立的</li></ul><p><strong>套接字（Socket）</strong></p><p>（IP地址 : 端口号）</p><p><strong>差错检测</strong></p><p>TCP和UDP都会检错，出错了TCP会通知对方重传，UDP直接丢弃</p><h2 id="UDP和TCP比较"><a href="#UDP和TCP比较" class="headerlink" title="UDP和TCP比较"></a>UDP和TCP比较</h2><ul><li>首部大小：UDP 8B；TCP 20~60B</li><li>拆分：UDP不支持拆分；TCP支持拆分，因此可传输长报文</li><li>可靠：UDP无连接、不可靠；TCP有连接、可靠、支持拥塞控制</li><li>对象数量：UDP支持一对一、一对多；TCP仅支持一对一</li><li>传输对象：UDP面向报文；TCP面向字节流</li></ul><h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><p><strong>首部</strong></p><p><img src="/img/internet_img/UDP%E9%A6%96%E9%83%A8.png"></p><p><strong>校验</strong></p><p>发送方：</p><ol><li>计算前需要添加伪首部进行校验</li><li>每16bit为一组进行二进制加法，</li><li>如果最高位有进位，需要加回到最低位，</li><li>最后得到一个16bit的结果，取反得到校验和</li><li>封装到网络层前需要把伪首部去掉</li></ol><p><img src="/img/internet_img/UDP%E6%A0%A1%E9%AA%8C.png"></p><p>接收方：</p><ol><li>添加伪首部，将收到的数据每16bit为一组进行二进制加法</li><li>再加上校验和，结果全1就通过校验</li></ol><h2 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h2><h3 id="TCP报文段"><a href="#TCP报文段" class="headerlink" title="TCP报文段"></a>TCP报文段</h3><p><img src="/img/internet_img/TCP%E6%8A%A5%E6%96%87%E6%AE%B5.png"></p><ul><li>序号（sequence）：数据部分在原始字节流中的偏移量，起始序号不一定是0，由发送方自己定</li><li>确认号（ack、ack_seq）：表示这个序号之前的字节都已收到</li><li>标志位<ul><li>URG：紧急位，1为应尽快插队发送</li><li>✨ACK：0表示ack_seq无效，1表示ack_seq有效。只在第一次握手时是0</li><li>PSH：推送位，1为希望接收方尽快回复</li><li>RST：复位位：1为出现严重差错，必须释放连接</li><li>✨SYN：同步位，1为连接请求或连接接收报文，在第一、二次握手时为1</li><li>✨FIN：终止位，在第一、三次挥手时为1</li></ul></li><li>数据偏移：TCP首部长度，单位为4B，取值范围为0~15</li><li>紧急指针：表示紧急数据的序号，和序号是独立的</li><li>窗口（rwnd、rcvwnd）：receive window，接收缓冲区剩余大小</li><li>校验和：同UDP，伪首部里的17改为6</li></ul><h3 id="连接管理"><a href="#连接管理" class="headerlink" title="连接管理"></a>连接管理</h3><p><strong>建立连接</strong></p><p><img src="/img/internet_img/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="三次握手"></p><ul><li>第一、二次握手虽然没有数据，但序号要+1</li><li>第三次握手可以携带数据，若携带数据则会消耗序号，没有则不会</li></ul><p><img src="/img/internet_img/TCP%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A21.png" alt="TCP状态转换"></p><p><strong>数据传输</strong></p><p><strong>释放连接</strong></p><p><img src="/img/internet_img/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png" alt="四次挥手"></p><ul><li>第一、三次挥手需要序号+1</li><li>第二次挥手可以携带数据</li><li>第四次挥手之后会等待2 MSL（最长报文寿命），防止服务器端没有收到第四次挥手；如果服务器在时间段内没有收到第四次挥手，则会再发第三次挥手，客户端会重置等待时间</li></ul><p><img src="/img/internet_img/TCP%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A22.png" alt="TCP状态转换"></p><h3 id="可靠传输、流量控制"><a href="#可靠传输、流量控制" class="headerlink" title="可靠传输、流量控制"></a>可靠传输、流量控制</h3><p>关键是rwnd字段</p><p>累计确认：服务器端可以收到多个数据后一起确认；若连续收到两个长度为MSS的报文段，则应该立即返回ack段；等待收到多个报文的时间间隔最多不超过0.5s</p><p>捎带数据：在返回ack报文时可以带上要发送的数据</p><p>重传机制：</p><ul><li><p>超时重传</p></li><li><p>快重传：基于立即确认机制，每收到一个报文段就立即确认，即使是失序的报文段也要返回ACK</p><p>  <img src="/img/internet_img/%E5%BF%AB%E9%87%8D%E4%BC%A0.png" alt="快重传"></p></li></ul><h3 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h3><blockquote><p>流量控制：控制端到端的数据发送量（局部的）</p><p>拥塞控制：控制整个网络中每台主机的数据发送量（全局的）</p></blockquote><p><strong>慢开始算法和拥塞控制</strong></p><p><img src="/img/internet_img/%E6%85%A2%E5%BC%80%E5%A7%8B%E7%AE%97%E6%B3%951.png"></p><p><img src="/img/internet_img/%E6%85%A2%E5%BC%80%E5%A7%8B%E7%AE%97%E6%B3%952.png" alt="慢开始算法示例"></p><ul><li><strong>立即确认</strong>：慢开始算法里每收到一个报文段就要回一个ack</li><li>拥塞避免算法：发生超时重传时拥塞避免的阈值变为当前发送窗口的一半</li><li>拥塞避免阶段每次加一个MSS（最大段长）</li><li>发送窗口 &#x3D; min(拥塞窗口, 接收窗口)</li></ul><p><strong>快重传和快恢复</strong></p><p><img src="/img/internet_img/%E5%BF%AB%E6%81%A2%E5%A4%8D%E7%AE%97%E6%B3%95.png"></p><ul><li>快重传：当收到三个确认号相同的冗余ACK时，立即重传对应报文段</li><li>快恢复算法：发生快重传时，将阈值和发送窗口都设为当前发送窗口的一半，然后切换为拥塞避免算法</li></ul><h1 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h1><h2 id="网络应用模型"><a href="#网络应用模型" class="headerlink" title="网络应用模型"></a>网络应用模型</h2><p><strong>C&#x2F;S</strong></p><p>服务器：</p><ol><li>永久提供服务</li><li>永久性地址&#x2F;域名</li></ol><p>客户端：</p><ol><li>间歇性接入网络</li><li>可能使用动态IP地址</li><li>不与其他客户机直接通信</li></ol><p>应用：Web、FTP、远程登录、电子邮件等</p><p><strong>P2P</strong></p><ol><li>不存在永远在线的服务器</li><li>每个主机都可以提供和请求服务</li><li>节点间可以直接通信</li><li>可扩展性好，健壮性强</li></ol><h2 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h2><p><strong>作用</strong>：域名 –&gt; ip地址</p><p><img src="/img/internet_img/%E5%9F%9F%E5%90%8D%E6%A0%91.png"></p><p><strong>查询顺序</strong>：本地域名服务器  –&gt; 根域名服务器 –&gt; 顶级域名服务器 –&gt; </p><p>权限域名服务器</p><p><strong>查询方式</strong>：递归查询（别人帮查）、迭代查询（自己查）</p><h2 id="FTP"><a href="#FTP" class="headerlink" title="FTP"></a>FTP</h2><p>使用TCP实现可靠传输</p><p>21为TCP控制连接端口，用于发送请求</p><p>20为TCP数据连接端口，用于发送文件</p><p>主动模式：客户端向21端口发送请求并监听20端口收文件</p><p>被动模式：客户端向21端口发送请求，服务器随机一个&gt;1024的端口发送给客户端，客户端连接这个端口来收数据</p><h2 id="电子邮件"><a href="#电子邮件" class="headerlink" title="电子邮件"></a>电子邮件</h2><p>发邮件协议：SMTP（端口号25）、MIME（对SMTP的扩充）</p><p>收邮件协议：POP3（端口号110）、IMAP、HTTP（基于万维网时）</p><h2 id="万维网"><a href="#万维网" class="headerlink" title="万维网"></a>万维网</h2><p>HTTP 端口80</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线代强化</title>
    <link href="/2024/10/26/%E8%80%83%E7%A0%94/%E7%BA%BF%E4%BB%A3%E5%BC%BA%E5%8C%96/"/>
    <url>/2024/10/26/%E8%80%83%E7%A0%94/%E7%BA%BF%E4%BB%A3%E5%BC%BA%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="线代强化"><a href="#线代强化" class="headerlink" title="线代强化"></a>线代强化</h1><h2 id="行列式的定义、性质与计算"><a href="#行列式的定义、性质与计算" class="headerlink" title="行列式的定义、性质与计算"></a>行列式的定义、性质与计算</h2><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%983.png" alt="行列式函数的导数"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%984.png" alt="爪形行列式"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%985.png" alt="行相等加列 列相等加行"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%986.png" alt="展开定理"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%987.png"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%988.png" alt="么形行列式"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%989.png" alt="补边"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9810.png" alt="三对角行列式"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9811.png" alt="所有代数余子式之和"></p><blockquote><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9812.png" alt="求所有代数余子式之和的另一种方法"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9813.png" alt="带特殊值"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9814.png" alt="范德蒙行列式"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9815.png" alt="补行 范德蒙行列式"></p><p><img src="/img/xiandai_qianghua_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9816.png" alt="补行 范德蒙行列式"></p><h2 id="抽象行列式、矩阵运算"><a href="#抽象行列式、矩阵运算" class="headerlink" title="抽象行列式、矩阵运算"></a>抽象行列式、矩阵运算</h2><p><strong>分块行列式</strong></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%981.png" alt="分块行列式"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%982.png" alt="凑分块"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%983.png" alt="凑分块"></p><p><strong>抽象行列式运算</strong></p><blockquote><p>行列式性质</p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%984.png"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%987.png" alt="题里常见的条件"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%988.png" alt="加法化乘法"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%989.png" alt="秩性质"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9810.png" alt="克拉默法则"></p><p><strong>矩阵的基本运算</strong></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9811.png" alt="矩阵性质"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9812.png" alt="矩阵性质"></p><p><strong>方阵的幂</strong>✨</p><p>三种方法：</p><ol><li>找规律</li><li>成比例</li><li>可对角化</li></ol><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9813.png" alt="找规律 坍缩矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9814.png" alt="成比例"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9815.png" alt="成比例"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9816.png" alt="可对角化"></p><p><strong>伴随矩阵</strong>✨</p><blockquote><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9817.png" alt="伴随矩阵性质"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9818.png" alt="分块 伴随"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9819.png" alt="伴随"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9820.png" alt="伴随 把题目条件翻译成式子"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9821.png" alt="伴随"></p><blockquote><p>总结</p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%9822.png" alt="运算规则"></p></blockquote><h2 id="逆、初等矩阵、秩"><a href="#逆、初等矩阵、秩" class="headerlink" title="逆、初等矩阵、秩"></a>逆、初等矩阵、秩</h2><p><strong>矩阵的逆</strong></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%981.png" alt="凑逆的定理"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%982.png" alt="凑逆的定理"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%983.png" alt="判断是否可逆"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%984.png" alt="凑逆的定理"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%985.png" alt="分块矩阵的逆"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%986.png" alt="逆的性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%987.png"></p><p><strong>初等矩阵</strong></p><blockquote><p>初等矩阵定义：单位矩阵作<strong>一次</strong>初等变换所得的矩阵</p><p>初等矩阵的性质</p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%988.png"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%989.png" alt="初等矩阵性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9810.png" alt="初等矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9811.png" alt="初等矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9812.png" alt="初等矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9813.png" alt="初等矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9814.png" alt="初等矩阵"></p><p><strong>可逆矩阵方程</strong></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9815.png"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9816.png"></p><p><strong>矩阵的秩</strong>✨</p><blockquote><p>秩的性质</p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9817.png"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9818.png"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9819.png" alt="秩性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9820.png" alt="秩性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9821.png" alt="秩性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9822.png" alt="分块矩阵 秩性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9823.png" alt="分块矩阵 秩性质"></p><p><img src="/img/xiandai_qianghua_img/%E9%80%86%E5%88%9D%E7%AD%89%E7%A7%A9%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%9824.png" alt="分块矩阵"></p><h2 id="向量组的线性相关性"><a href="#向量组的线性相关性" class="headerlink" title="向量组的线性相关性"></a>向量组的线性相关性</h2><p><strong>向量组的线性相关性</strong></p><p>求法：</p><ol><li>先看秩</li><li>不行在用定义</li></ol><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%987.png"></p><p><strong>向量组的线性表示</strong></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%989.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9810.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9811.png"></p><p><strong>向量组等价</strong></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9812.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9813.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9814.png"></p><p><strong>向量组的极大无关组和秩</strong></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9815.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9816.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9817.png" alt="向量空间"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9818.png" alt="过渡矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9819.png" alt="过渡矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%9A%84%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E6%80%A7%E4%BE%8B%E9%A2%9820.png" alt="过渡矩阵"></p><h2 id="线性方程组"><a href="#线性方程组" class="headerlink" title="线性方程组"></a>线性方程组</h2><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/xiandai_qianghua_img/%E7%BA%BF%E6%80%A7%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%987.png" alt="具体方程的求解"></p><h2 id="抽象方程组"><a href="#抽象方程组" class="headerlink" title="抽象方程组"></a>抽象方程组</h2><p><strong>不可逆矩阵求解</strong></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%982.png" alt="列分块"></p><p><strong>解的结构</strong></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%986.png" alt="非齐次通解"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%987.png" alt="非齐次通解"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%988.png" alt="齐次通解"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%989.png"></p><p><strong>公共解</strong></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%9810.png"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%9811.png" alt="公共解"></p><blockquote><p>证明方程组A、B同解：</p><ol><li>方法1：将A的通解带入B，系数取任何值都成立，此时表示A的解都包含在B中，再证系数矩阵秩相同，则表示AB同解</li><li>方法2：证明两个方程组矩阵的行向量组等价，即两个方程组可以互相线性表示</li></ol></blockquote><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%9812.png" alt="同解"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%9813.png" alt="同解"></p><p><img src="/img/xiandai_qianghua_img/%E6%8A%BD%E8%B1%A1%E6%96%B9%E7%A8%8B%E7%BB%84%E4%BE%8B%E9%A2%9814.png" alt="同解"></p><h2 id="特征值、特征向量与相似矩阵"><a href="#特征值、特征向量与相似矩阵" class="headerlink" title="特征值、特征向量与相似矩阵"></a>特征值、特征向量与相似矩阵</h2><blockquote><p>求特征值：解| λE - A | &#x3D; 0，得所有的特征值λ</p><p>求特征向量：解( λE - A )X &#x3D; 0，求出基础解系α1, α2, …,则k1α1 + k2α2 + … 为特征向量（k不全为0）</p></blockquote><blockquote><p>特征值性质：</p><ol><li>特征值之和 &#x3D; 矩阵对角线之和 &#x3D; 迹</li><li>特征值之积 &#x3D; 矩阵的行列式</li></ol><p>特征向量性质：</p><ol><li>不同特征值的特征向量是线性无关的</li><li>m重特征值对应的特征向量 &lt;&#x3D; m</li></ol><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%981.png"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%982.png" alt="特征值"></p><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%983.png" alt="特征值"></p><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%984.png" alt="特征值"></p><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%985.png" alt="特征值"></p><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%986.png" alt="特征值"></p><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%987.png" alt="特征向量"></p><p><img src="/img/xiandai_qianghua_img/%E7%89%B9%E5%BE%81%E5%80%BC%E4%BE%8B%E9%A2%988.png" alt="特征向量"></p><p><strong>相似矩阵</strong></p><blockquote><p>相似矩阵</p><p>若A ~ B，则秩、迹、行列式相等</p></blockquote><blockquote><p>相似对角化</p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%981.png" alt="判断是否可相似对角化"></p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%982.png" alt="判断是否可相似对角化 步骤"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%983.png" alt="相似矩阵"></p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%984.png" alt="相似矩阵"></p><p><strong>对角化</strong></p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%985.png" alt="对角化"></p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%986.png" alt="相似对角化"></p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%987.png" alt="新颖题"></p><p><img src="/img/xiandai_qianghua_img/%E7%9B%B8%E4%BC%BC%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%988.png" alt="判断是否可相似对角化"></p><h2 id="实对称矩阵"><a href="#实对称矩阵" class="headerlink" title="实对称矩阵"></a>实对称矩阵</h2><blockquote><p>实对称矩阵性质：</p><ol><li>不同特征值的特征向量是相互正交的</li><li>实对称矩阵必可相似对角化，存在正交矩阵Q，Q^T A Q &#x3D; diag(λ1，λ2，…，λn)</li></ol></blockquote><p><img src="/img/xiandai_qianghua_img/%E5%AE%9E%E5%AF%B9%E7%A7%B0%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%981.png" alt="对角化"></p><p><img src="/img/xiandai_qianghua_img/%E5%AE%9E%E5%AF%B9%E7%A7%B0%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%982.png" alt="合同对角化"></p><p><img src="/img/xiandai_qianghua_img/%E5%AE%9E%E5%AF%B9%E7%A7%B0%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/xiandai_qianghua_img/%E5%AE%9E%E5%AF%B9%E7%A7%B0%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%984.png" alt="特征值个数"></p><h2 id="二次型"><a href="#二次型" class="headerlink" title="二次型"></a>二次型</h2><blockquote><p>二次型化为标准型方法：</p><ol><li><p>用正交变换化为二次型为标准型</p><p> <img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%981.png"></p></li><li><p>配方法化为二次型</p><p> <img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%982.png"></p></li></ol></blockquote><blockquote><p>二次型f(x1, x2, x3) &#x3D; 1 表示的二次曲面</p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%983.png"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%984.png" alt="基本概念"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%985.png" alt="正惯性指数"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%986.png" alt="正负惯性指数"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%987.png" alt="二次曲面"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%988.png" alt="化标准型"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%989.png" alt="化标准型"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9810.png" alt="化规范型"></p><blockquote><p>正定二次型</p><p>判别正定二次型：</p><ol><li><p>充要条件</p><ol><li>定义：对任意X ≠ 0，X^T A X &gt; 0</li><li>A的<strong>特征值</strong>都大于0</li><li><strong>正惯性指数</strong>为n</li><li><strong>顺序主子式</strong>全大于0，（负定的奇数阶顺序主子式小于0，偶数阶大于0）</li></ol></li><li><p>必要条件</p><p> 若正定，则|A| &gt; 0，主对角元素都大于0</p></li></ol></blockquote><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9811.png" alt="判断正定二次型"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9812.png" alt="正定二次型特征值的性质"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9813.png" alt="正定二次型值的性质"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9814.png" alt="判断分块矩阵正定"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9815.png" alt="证明抽象矩阵正定"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9816.png" alt="证明抽象矩阵正定"></p><blockquote><p>两个矩阵的关系</p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9817.png"></p></blockquote><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9818.png" alt="两个矩阵的关系"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9819.png" alt="两个矩阵的关系"></p><p><img src="/img/xiandai_qianghua_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%9820.png" alt="两个矩阵的关系"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>概率论强化</title>
    <link href="/2024/10/18/%E8%80%83%E7%A0%94/%E6%A6%82%E7%8E%87%E8%AE%BA%E5%BC%BA%E5%8C%96/"/>
    <url>/2024/10/18/%E8%80%83%E7%A0%94/%E6%A6%82%E7%8E%87%E8%AE%BA%E5%BC%BA%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="强化例题"><a href="#强化例题" class="headerlink" title="强化例题"></a>强化例题</h1><h2 id="随机事件和概率"><a href="#随机事件和概率" class="headerlink" title="随机事件和概率"></a>随机事件和概率</h2><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%981.png" alt="概率计算"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%982.png" alt="概率计算"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%983.png" alt="完备事件组"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%984.png" alt="化简"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%985.png" alt="古典概型 有放回"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%986.png" alt="无放回"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%987.png" alt="几何概型"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%988.png" alt="事件独立"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%989.png" alt="事件独立"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%9810.png" alt="事件独立"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%9811.png" alt="全概率"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%9812.png" alt="不等式"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%9813.png" alt="独立性✨"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%9814.png" alt="射击"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E4%BA%8B%E4%BB%B6%E5%92%8C%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%9815.png" alt="抽签原理 反直觉✨"></p><h2 id="随机变量及其分布"><a href="#随机变量及其分布" class="headerlink" title="随机变量及其分布"></a>随机变量及其分布</h2><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="分布函数"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%982.png" alt="分布函数"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%983.png" alt="分布函数"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%984.png" alt="离散型随机变量"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%985.png" alt="条件概率"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%986.png" alt="几何分布"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%987.png" alt="泊松分布"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%988.png" alt="求分布函数"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%989.png" alt="连续型概率密度"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9810.png" alt="指数分布"></p><blockquote><p>正态分布的关键在于标准化</p></blockquote><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9811.png" alt="正态分布"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9812.png" alt="正态分布"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9813.png" alt="正态分布期望方差"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9814.png" alt="正态分布比大小"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9815.png" alt="随机变量函数的分布"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9816.png" alt="随机变量函数的分布"></p><p><img src="/img/gailv_qianghua_img/%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%85%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9817.png" alt="分布函数的分布函数"></p><h2 id="多维随机变量及分布"><a href="#多维随机变量及分布" class="headerlink" title="多维随机变量及分布"></a>多维随机变量及分布</h2><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="二维分布函数"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%982.png" alt="规范性"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%984.png" alt="二维离散型"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9810.png" alt="二维离散型"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%985.png" alt="独立性"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%987.png" alt="联合概率密度"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%988.png" alt="独立性"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%989.png" alt="独立性"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9811.png" alt="帕斯卡分布"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9812.png" alt="二维连续型"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9813.png" alt="二维连续型"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9814.png" alt="二维正态"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9815.png" alt="二维正态相关系数"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9816.png" alt="二维正态相关系数结论"></p><blockquote><p>公式法记住解法就行</p></blockquote><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9817.png" alt="求二维随机变量概率密度 公式法"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9818.png" alt="求二维随机变量概率密度 公式法"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9819.png"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9820.png"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9821.png"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%9A%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%8F%8A%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%9822.png"></p><h2 id="数字特征"><a href="#数字特征" class="headerlink" title="数字特征"></a>数字特征</h2><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%981.png" alt="期望"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%982.png" alt="期望"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%983.png" alt="期望 绝对值分段积分"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%984.png" alt="期望"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%985.png" alt="抽签原理"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%986.png" alt="方差"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%987.png" alt="综合题"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%988.png" alt="看似均匀分布 其实是二项分布"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%989.png"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9810.png"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9811.png"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9812.png"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9813.png" alt="指数分布"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9814.png" alt="正态分布"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9815.png" alt="正态分布"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9816.png" alt="特殊函数"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9817.png" alt="特殊函数"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9818.png" alt="结论在上面的有道题中有证明"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9819.png"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9820.png" alt="相关系数"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9821.png" alt="相关系数"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9822.png" alt="相关系数性质"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9823.png" alt="协方差"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9824.png" alt="相关和独立"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9825.png" alt="相关和独立"></p><p><img src="/img/gailv_qianghua_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%9826.png" alt="相关系数"></p><h2 id="大数定律与中心极限定理"><a href="#大数定律与中心极限定理" class="headerlink" title="大数定律与中心极限定理"></a>大数定律与中心极限定理</h2><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%981.png" alt="切比雪夫不等式"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%982.png" alt="切比雪夫不等式"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%983.png" alt="大数定律"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%984.png" alt="大数定律"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%985.png" alt="中心极限定理"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%986.png" alt="样本的数字特征"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%987.png" alt="样本的数字特征"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%988.png" alt="样本的期望"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%989.png" alt="样本的数字特征"></p><p><img src="/img/gailv_qianghua_img/%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B%E4%B8%8E%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86%E4%BE%8B%E9%A2%9810.png" alt="样本的数字特征"></p><p><strong>三大抽样分布</strong></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="卡方分布"></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%982.png" alt="t分布"></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%983.png" alt="F分布"></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%984.png" alt="F分布"></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%985.png" alt="分位点"></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%986.png" alt="独立"></p><p><img src="/img/gailv_qianghua_img/%E4%B8%89%E5%A4%A7%E6%8A%BD%E6%A0%B7%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%987.png" alt="t分布"></p><h2 id="参数估计与假设检验"><a href="#参数估计与假设检验" class="headerlink" title="参数估计与假设检验"></a>参数估计与假设检验</h2><p><strong>参数估计</strong></p><blockquote><p>直接背解题过程</p></blockquote><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%981.png" alt="参数估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%982.png" alt="参数估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%983.png" alt="参数估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%984.png" alt="参数估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%985.png" alt="参数估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%986.png" alt="参数估计"></p><blockquote><p>估计量的评选标准</p><ol><li><p>无偏性</p><p> θ的估计量θ1，E(θ1) &#x3D; θ，则θ1为θ的无偏估计量</p></li><li><p>有效性</p><p> 比较无偏估计量哪个更有效</p><p> D(θ1) &lt;&#x3D; D(θ2)，则θ1比θ2更有效</p></li><li><p>一致性</p><p> n -&gt; ∞时，θ1依概率收敛于θ，则θ1为θ的一致估计量或<strong>相合估计量</strong></p></li></ol></blockquote><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%987.png" alt="估计量的评选标准"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%988.png" alt="无偏估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%989.png" alt="无偏估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%9810.png" alt="一致估计"></p><blockquote><p>区间估计</p><p>置信区间 &#x3D; 1 - α</p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%9811.png" alt="推导"></p></blockquote><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%9812.png" alt="区间估计"></p><p><img src="/img/gailv_qianghua_img/%E5%8F%82%E6%95%B0%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%9813.png" alt="区间估计"></p><p><strong>假设检验</strong></p><blockquote><p>一般步骤</p><p><img src="/img/gailv_qianghua_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C%E4%BE%8B%E9%A2%981.png"></p><p>两类错误：</p><ol><li>第一类错误：拒绝真假设H0（弃真）</li><li>第二类错误：接收假假设H1（纳伪）</li></ol></blockquote><p><img src="/img/gailv_qianghua_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gailv_qianghua_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C%E4%BE%8B%E9%A2%983.png" alt="拒绝域"></p><p><img src="/img/gailv_qianghua_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C%E4%BE%8B%E9%A2%984.png" alt="假设检验"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据结构</title>
    <link href="/2024/08/15/%E8%80%83%E7%A0%94/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    <url>/2024/08/15/%E8%80%83%E7%A0%94/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><h2 id="图"><a href="#图" class="headerlink" title="图"></a>图</h2><h3 id="最小生成树"><a href="#最小生成树" class="headerlink" title="最小生成树"></a>最小生成树</h3><p><strong>定义</strong>：带权连通无向图，权值之和最小的那棵生成树</p><p><strong>性质</strong>：</p><ol><li>若存在权值相同的边，最小生成树可能不唯一</li><li>各边权值互不相等，生成树唯一</li><li>若无向连通图边数比顶点数少1，则最小生成树为自身</li></ol><p><strong>最小生成树算法</strong>：</p><p><strong>Prim（普里姆）算法</strong></p><p>步骤：</p><ol><li><p>贪心，初始时从图中任取一点加入T</p></li><li><p>之后选择与T最近的顶点加入T，直到选完所有点</p></li></ol><p>时间复杂度O(|V|²)，与边数无关，适合边稠密图</p><p><img src="/img/ds_img/Prim%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91%E8%BF%87%E7%A8%8B.png" alt="最小生成树过程"></p><p><strong>Kruskal（克鲁斯卡尔）算法</strong></p><p>步骤：</p><ol><li>贪心，权值由小到大选择</li><li>若该边依附的点在T中不同的连通分量，则将边加入T，直至所有点都在一个连通分量上</li></ol><p>时间复杂度O( |E|log2(|E|) )，适合边稀疏而顶点较多的图</p><p><img src="/img/ds_img/Kruskal%E6%9C%80%E5%B0%8F%E7%94%9F%E6%88%90%E6%A0%91%E8%BF%87%E7%A8%8B.png" alt="最小生成树过程"></p><h3 id="最短路径"><a href="#最短路径" class="headerlink" title="最短路径"></a>最短路径</h3><p><strong>定义</strong>：</p><ol><li>带权路径长度：从一个顶点到另一个顶点路径上边的权值之和</li><li>最短路径：权值之和最短的路径</li></ol><p><strong>最短路径算法</strong>：</p><p><strong>Dijkstra（迪杰斯特拉）算法</strong></p><p>求单源最短路径</p><p>贪心，边不能为负数</p><p><img src="/img/ds_img/%E8%BF%AA%E6%9D%B0%E6%96%AF%E7%89%B9%E6%8B%89%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84%E8%BF%87%E7%A8%8B.png"></p><p>时间复杂度O(|V|²)</p><p><strong>Floyd（弗洛伊德）算法</strong></p><p>求每对顶点间的最短距离</p><p><img src="/img/ds_img/%E5%BC%97%E6%B4%9B%E4%BC%8A%E5%BE%B7%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84%E8%BF%87%E7%A8%8B.png"></p><p>时间复杂度O(|V|³)</p><h3 id="拓扑排序"><a href="#拓扑排序" class="headerlink" title="拓扑排序"></a>拓扑排序</h3><p><strong>概念</strong>：</p><ol><li>AOV网：顶点表示活动的网络</li><li>DAG图：有向无环图</li><li>AOE网：边表示活动的网络，点表示事件</li></ol><p><img src="/img/ds_img/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F%E6%AD%A5%E9%AA%A4.png"></p><p><img src="/img/ds_img/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F%E8%BF%87%E7%A8%8B.png"></p><h3 id="关键路径"><a href="#关键路径" class="headerlink" title="关键路径"></a>关键路径</h3><p><strong>定义</strong>：</p><p>关键路径：AOE网中，具有最大路径长度的路径</p><p>关键活动：关键路径上的活动</p><p>最早发生时间ve(k)：从源点到顶点vk的最长路径长度，决定了从vk开始的活动的最早开工时间</p><p>最迟发生时间vl(k)：在不推迟整个工程完成的前提下，事件必须开始的最迟时间</p><p><img src="/img/ds_img/%E5%85%B3%E9%94%AE%E8%B7%AF%E5%BE%84%E8%BF%87%E7%A8%8B1.png"></p><p><img src="/img/ds_img/%E5%85%B3%E9%94%AE%E8%B7%AF%E5%BE%84%E8%BF%87%E7%A8%8B2.png"></p><h2 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h2><h3 id="二叉查找树"><a href="#二叉查找树" class="headerlink" title="二叉查找树"></a>二叉查找树</h3><p><img src="/img/ds_img/%E4%BA%8C%E5%8F%89%E6%9F%A5%E6%89%BE%E6%A0%91_%E5%8D%A1%E7%89%B9%E5%85%B0%E6%95%B0.png"></p><h3 id="平衡二叉树"><a href="#平衡二叉树" class="headerlink" title="平衡二叉树"></a>平衡二叉树</h3><ol><li><p>构造深度为h的平衡二叉树的最少节点数</p><p> n0 &#x3D; 0, n1 &#x3D; 1, nh &#x3D; 1 + n(h-1) + n(h-2)</p></li><li><p>顺序插入时，平衡二叉树的高度</p><p> 如果结点个数为2^k - 1则为满二叉树</p></li></ol><h3 id="B-树"><a href="#B-树" class="headerlink" title="B-树"></a>B-树</h3><p>度为m的B-数性质</p><ol><li>每个非根节点<strong>最多</strong>可以有 m 个孩子，<strong>最少</strong>有 m&#x2F;2(向上取整) 个孩子</li><li>每个非根节点<strong>最多</strong>可以有 m-1 个key，<strong>最少</strong>有 m&#x2F;2(向上取整)  - 1个key</li><li>根节点不是终端节点，则根节点至少 1 个key，至少有两个孩子</li><li>所有的叶子节点都在同一层，表示查找失败节点</li></ol><p><strong>例题</strong></p><ol><li>节点数的上下限</li></ol><p><img src="/img/ds_img/b%E6%A0%91%E4%BE%8B%E9%A2%981.png"></p><h3 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h3><p><strong>注意点</strong></p><ol><li>平均查找长度与装填因子α直接相关，不直接依赖于表长或表中已有元素</li><li>聚集是因为选择了处理不当的处理冲突方式</li></ol><p><strong>例题</strong></p><p><img src="/img/ds_img/%E5%93%88%E5%B8%8C%E8%A1%A8%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/ds_img/%E5%93%88%E5%B8%8C%E8%A1%A8%E4%BE%8B%E9%A2%982.png"></p><h1 id="面试简答"><a href="#面试简答" class="headerlink" title="面试简答"></a>面试简答</h1><p><strong>1.稀疏的无向图用什么存储最好</strong></p><p>使用邻接表存储最好，仅需 O(n+2e) 空间（n 为节点数，e为边数）；</p><p>而邻接矩阵需要O(n^2)的空间</p><p><strong>2.空串和空格串是否一样？</strong></p><p>不一样。空串是一个长度为 0 的字符串，不包含任何字符；</p><p>空格串是一个由空格字符组成的字符串，长度至少为 1。</p><p><strong>3.怎么判断一个图是否有环？解释拓扑排序的过程</strong></p><p>常用的方法有 深度优先搜索（DFS） 和 拓扑排序</p><p>在 DFS 遍历过程中，如果遇到一个已经被访问过且仍在递归栈中的节点，则说明图中存在环。</p><p>拓扑排序仅适用于有向无环图（DAG）。如果图中存在环，则无法完成拓扑排序。</p><p>拓扑排序步骤：</p><ol><li>计算每个节点的入度（即有多少条边指向该节点）。</li><li>将所有入度为 0 的节点加入队列。</li><li>从队列中取出一个节点，将其加入拓扑排序结果中，并减少其所有邻居的入度。</li><li>如果某个邻居的入度变为 0，则将其加入队列。</li><li>重复上述过程，直到队列为空。</li><li>如果拓扑排序结果中的节点数小于总节点数，则说明图中存在环。</li></ol><p><strong>4.循环队列怎么判断队列满&#x2F;空</strong></p><p>当队头指针和队尾指针指向同一位置时，说明队列中没有元素；</p><p>判断队列满有两种办法：</p><ol><li>牺牲一个存储空间，队尾指针的下一个位置是队头指针时，说明队列已满。</li><li>维护一个变量 <code>size</code> 记录队列中的元素数量，当 <code>size</code> 等于 <code>capacity</code>时，说明队列已满；</li></ol><p><strong>5.什么是稀疏矩阵</strong></p><p>稀疏矩阵是指矩阵中非零元素的数量远少于零元素的数量</p><p>我们可以存储非零元素的行索引、列索引和值来压缩存储稀疏矩阵</p><p><strong>6.强连通图，N个顶点最多和最少有多少个边</strong></p><p>强连通图是指在有向图中，任意两个顶点之间都存在双向路径</p><p>假设顶点数为n，边数最少的情况是图形成一个有向环，边数内n</p><p>边数最多的情况是图是一个完全有向图，即图中任意两个顶点之间都有双向边，此时边数为n*(n-1)</p><p><strong>7.如何存储二叉树</strong></p><p>通常有两种主要方法：顺序存储和链式存储</p><p>顺序存储通过数组来表示二叉树，适用于完全二叉树或满二叉树。对于一般的二叉树，顺序存储会浪费空间</p><p>链式存储通过节点和指针来表示二叉树，每个节点包含数据域和指向左右子节点的指针</p><p><strong>8.什么是广义表</strong></p><p>广义表的元素可以是原子或子表，可以表示线性表、树、图等复杂数据结构</p><p><strong>9.什么是AOE网，什么是AOV网</strong></p><p>AOE 网AOE 网是一种边表示活动、顶点表示事件的有向无环图，描述活动的时间安排和关键路径</p><p>AOV 网是一种顶点表示活动、边表示活动之间的先后关系的有向无环图，描述活动之间的先后关系</p><p><strong>10.树的基本定义</strong></p><p>树（Tree）是计算机科学中一种非常重要的非线性数据结构，它由节点（Node）和边（Edge）组成的层次化、无环的连通数据结构</p><p><strong>11.顺序表有什么特点</strong></p><p>顺序表使用连续的内存空间存储数据元素</p><p>数据元素在内存中按顺序排列，逻辑顺序与物理顺序一致。</p><p>特点：支持随机访问，存储密度高，插入或删除元素效率低</p><p><strong>12.什么是数据元素</strong></p><p>是数据结构中的基本单位，也称为元素或节点，它是数据结构中存储和处理的最小逻辑单元</p><p><strong>13.顺序表和链表的异同</strong></p><p>相同：都是线性数据结构，都适用于需要存储和处理线性数据的场景</p><p>不同：</p><table><thead><tr><th align="center">特性</th><th align="center">顺序表</th><th align="center">链表</th></tr></thead><tbody><tr><td align="center"><strong>存储方式</strong></td><td align="center">连续内存空间</td><td align="center">非连续内存空间，通过指针链接</td></tr><tr><td align="center"><strong>访问方式</strong></td><td align="center">随机访问，<em>O</em>(1)</td><td align="center">顺序访问，<em>O</em>(<em>n</em>)</td></tr><tr><td align="center"><strong>插入删除</strong></td><td align="center">平均 <em>O</em>(<em>n</em>)</td><td align="center"><em>O</em>(1)（已知位置）</td></tr><tr><td align="center"><strong>空间效率</strong></td><td align="center">存储密度高，可能内存浪费</td><td align="center">存储密度低，动态分配内存</td></tr><tr><td align="center"><strong>扩容方式</strong></td><td align="center">固定容量，扩容成本高</td><td align="center">动态扩容，扩容成本低</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>日语生词短语语法</title>
    <link href="/2024/07/22/%E8%80%83%E7%A0%94/%E6%97%A5%E8%AF%AD%E7%94%9F%E8%AF%8D%E7%9F%AD%E8%AF%AD%E8%AF%AD%E6%B3%95/"/>
    <url>/2024/07/22/%E8%80%83%E7%A0%94/%E6%97%A5%E8%AF%AD%E7%94%9F%E8%AF%8D%E7%9F%AD%E8%AF%AD%E8%AF%AD%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="日语生词短语语法"><a href="#日语生词短语语法" class="headerlink" title="日语生词短语语法"></a>日语生词短语语法</h1><h2 id="真题"><a href="#真题" class="headerlink" title="真题"></a>真题</h2><h3 id="2024"><a href="#2024" class="headerlink" title="2024"></a>2024</h3><p><strong>完形填空</strong></p><ol><li><p>手短<strong>に</strong>言えば</p><p> 简而言之</p><p> 手短に言えば、彼は仕事を辞めたんです</p></li><li><p>ひっきりなしに</p><p> 不断地，接连不断地</p><p> 雨がひっきりなしに降り続いている</p><p> 電話がひっきりなしに鳴っている</p></li><li><p>はず和べき的区别</p><p> はず：语气较为温和，表示<strong>预期</strong>或逻辑上的必然性。</p><p> べき：语气较为强烈，表示义务、责任或强烈<strong>建议</strong>。</p></li><li><p>エッセンス（essence）</p><p> 本质、精华</p><p> この本のエッセンスを理解することが重要です</p></li><li><p>転がる</p><p> 滚动、滚落、<strong>摆着</strong></p><p> 石が坂道を転がっていく</p><p> その辺には本がたくさん転がっている</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>遊興性（ゆうきょうせい）</p><p> 娱乐性质、消遣倾向</p><p> 遊興性のある場所でリラックスしたい</p></li><li><p>みすぼらしい</p><p> 破旧的，寒酸的，邋遢的，不体面的</p><p> 彼はみすぼらしい服を着ていた</p></li><li><p>台頭する（たいとうする）</p><p> 崛起，兴起，显现</p><p> 新しい技術が台頭してきている</p></li><li><p>見て取る</p><p> 看出、察觉、理解</p><p> 彼の表情から緊張していることを見て取ることができた</p><p> その場の雰囲気を見て取り、すぐに行動した</p></li><li><p>担い手（にないて）</p><p> 挑东西的人;中坚;肩负重任的人</p><p> 一家の担い手</p></li><li><p>における和において的区别</p><p>  における：表示“在…方面”或“在…的情况下”</p><p>  において：表示“在…的场所、领域或情况下”</p><p>  教育における問題</p><p>  会議において</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>原発（げんぱつ）</p><p> 原子力発電所的缩写</p><p> 福島の原発事故は世界的に注目を集めた</p></li><li><p>直後（ちょくご）</p><p> 正后方，刚…不久</p><p> 地震の直後に余震が続いた</p></li><li><p>萎縮（いしゅく）</p><p> 経済の不況により、多くの企業が萎縮している</p></li><li><p>ハードディスク</p><p> hard disk,硬盘</p></li><li><p>滅多に（めったに）</p><p> 很少，不常，几乎不，<strong>与否定形式动词搭配</strong></p><p> 彼は滅多に映画を見に行かない</p></li><li><p>壊滅的（かいめつてき）</p><p> 壊滅的な地震が都市を襲った</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>俗説(ぞくせつ)</p><p> 俗说，民间传说</p><p> その病気について多くの俗説がある</p></li><li><p>くしゃくしゃ</p><p> 皱巴巴，揉成一团</p><p> 紙をくしゃくしゃにして捨てた</p></li><li><p>利口</p><p> 聪明，伶俐，机灵</p><p> 利口な子供</p></li><li><p>驚異的(きょういてき)</p><p> 惊人的，可惊的，令人瞠目的</p><p> 驚異的な記録</p></li><li><p>欠如(けつじょ)</p><p> 缺乏，缺少</p><p> 責任感が欠如している。</p></li><li><p>芸当(げいとう)</p><p> 绝技，把戏</p><p> 彼女のダンスの芸当はプロ並みだ</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>躊躇(ちゅうちょ)</p><p> 躊躇することなく引き受けた</p></li><li><p>どんぶり鉢(どんぶりばち)</p><p> 丼ものや麺類などを盛り付ける際に使う食器で、プラスチック製や陶器製、木製などがあります</p></li><li><p>一年坊主（いちねんぼうず）</p><p> 形容那些在某件事情上刚开始时非常热心，但很快就失去兴趣并放弃的人</p><p> 新しい趣味を始めても、一年坊主にならないように気をつけている</p></li><li><p>多分に甘美で、どこかに秘密にしなければならぬような影を持った物哀しさがあった</p><p> 描述某种情感或氛围，特别是带有复杂感情的情景</p><p> 过于的甜蜜，带有某种必须隐瞒的阴影的忧伤感</p></li></ol><p><strong>翻译</strong></p><ol><li><p>呼び寄せる</p><p> 召唤、叫来</p><p> 鳥を呼び寄せる笛の音</p></li><li><p>孕む（はらむ）</p><p> 怀有，包含</p><p> 危険性をはらんでいます</p></li><li><p>図式（ずしき）</p><p> 图表、示意图</p><p> この本には多くの図式が含まれています</p></li></ol><h3 id="2023"><a href="#2023" class="headerlink" title="2023"></a>2023</h3><p><strong>完型</strong></p><ol><li><p>すがすがしい</p><p> 神清气爽的，清新舒畅的</p><p> すがすがしい朝の空気</p></li><li><p>口ずさむ</p><p> 小声哼唱，小声哼诵诗歌等</p><p> 唐詩を口ずさみながら散歩している</p></li><li><p>首を傾げる（くびをかしげる）</p><p> 歪着头想，纳闷，觉得奇怪</p><p> 彼はどうしてまだ電話してくれないの、首を傾げた</p></li><li><p>仕草（しぐさ）</p><p> 动作，举止，态度</p><p> あいつの仕草が気に入らない</p></li><li><p>治療にあたらせる</p><p> 让（某人）进行治疗　或　安排（某人）进行治疗</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>水掛け論</p><p> 抬杠，没有休止的争论</p><p> 水掛け論を続けるよりも、解決策を見つけることが重要だ</p></li><li><p>揚げ足取り</p><p>揭短，找茬</p><p>彼はいつも人の揚げ足取りばかりしている</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>かたじけない（片付けない）</p><p> 通常用于对对方的恩惠表示深深的感激</p><p> このような親切をしていただき、かたじけない</p></li><li><p>節句（せっく）</p><p> 传统节日</p></li><li><p>なにもかも</p><p> 一切、所有的事物</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>狩猟(しゅりょう)</p><p> 狩猟に出かける</p></li><li><p>獲物(えもの)</p><p> 猎物</p><p> 獲物を追って山野を駆けめぐる</p></li><li><p>営み(いとなみ)</p><p> 行为，工作，事情，准备</p><p> 冬の営みをいそぐ</p></li><li><p>露地（ろじ）</p><p> 大地，露天的地面</p><p> 露地栽培</p></li><li><p>呻き（うめき）</p><p> 呻吟，哼哼</p><p> 呻き声</p></li><li><p>病い（やまい）</p><p> 心の病いは見えにくい</p></li><li><p>振り絞る</p><p> 竭尽全力</p><p> 彼女は勇気を振り絞って、告白した</p></li><li><p>抗う（あらがう）</p><p> 争；反抗</p><p> あらがいがたい運命</p></li><li><p>渾身（こんしん）</p><p> 浑身，全身</p><p> 渾身の力</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>分岐点（ぶんきてん）</p></li><li><p>ハーモニカ</p><p> harmonica 口琴</p></li><li><p>天辺（てっぺん）</p></li><li><p>差し引く</p><p> 减去</p></li><li><p>やけに</p><p> 非常</p><p> やけに寒い</p></li><li><p>手付き</p><p> 动作、手法</p><p> 器用な手付きで箸を使う</p></li><li><p>煮しめ</p><p> 红烧</p></li><li><p>物色（ぶっしょく）</p></li><li><p>胡坐（あぐら）</p><p> 盘腿坐</p></li><li><p>頬張る</p><p>大口吃；把嘴塞满</p><p>お菓子を頬張る</p></li><li><p>うっとり</p><p>因神魂颠倒而发呆状</p><p>うっとり（と）見とれる</p></li><li><p>午睡（ごすい）</p></li></ol><p><strong>翻译</strong></p><ol><li><p>それからまた</p><p> 然后又、另外</p></li><li><p>打ち砕く（うちくだく）</p><p> 打烂，粉碎</p><p> 頭を打ち砕かれて死ぬ</p></li><li><p>突き抜ける（つきぬける）</p><p> 穿透，扎透</p><p> 天井を突き抜ける</p></li></ol><h3 id="2022"><a href="#2022" class="headerlink" title="2022"></a>2022</h3><p><strong>完型</strong></p><ol><li><p>見当（けんとう）</p><p> 方位，方向，估计</p><p> 寺はこの見当にある</p></li><li><p>賽（さい）</p><p> 骰子</p><p> 賽を投げる</p></li><li><p>機縁（きえん）</p><p> 机缘</p><p> これを機縁に今後もよろしく</p></li><li><p>違算（いさん）</p><p> 算错;误算;计划错误;估计错</p><p> 違算を生ずる</p></li><li><p>気の向く</p><p> 随心所欲</p><p> 今日は気の向くままに過ごそう</p></li><li><p>うっかり</p><p> 不注意，不留神。无意中，稀里糊涂，漫不经心。</p><p> うっかりして乗り越す</p></li><li><p>行李（こうり）</p><p> 行李，装衣的箱笼</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>とりわけ</p><p> 特别，尤其</p><p> 彼女はどの料理も好きだが、とりわけ寿司が大好きだ</p></li><li><p>手っ取り早い</p><p> 迅速的、简单的、快捷的</p><p> 手っ取り早く終わらせたいなら、この方法がいい</p></li><li><p>紙片（しへん）</p><p> 紙片が散らばっている</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>寝そべる</p><p> 躺着、趴着</p><p> 彼はソファに寝そべってテレビを見ている</p></li><li><p>寝室（しんしつ）</p></li><li><p>常態（じょうたい）</p></li><li><p>耐久（たいきゅう）</p></li><li><p>嵩張る</p><p> 体积大、占地方、笨重</p><p> この箱は中身が少ないのに、嵩張る</p></li><li><p>闖入（ちんにゅう）</p></li><li><p>だの。。。だの</p><p> 用于列举多种例子或情况，通常带有负面的语气，又是…又是…</p><p> 彼はいつも忙しいだの、疲れているだの、言い訳ばかりしている</p></li><li><p>デンと腰をすえる</p><p> 沉着地安坐</p><p> デンと：模仿声音的拟声词，在这里表示稳重、沉稳的姿态</p><p> 彼はデンと腰をすえて、プロジェクトに取り組む決心をした</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>リアリズム</p><p> realism，现实主义</p><p> 映画監督はリアリズムの手法を用いて、戦争の現実を描いた</p></li><li><p>張りつめた弦（はりつめたげん）</p></li><li><p>鋭敏（えいびん）</p><p> 鋭敏な頭の働き</p></li><li><p>形作る（かたちづくる）</p><p> 化妆；打扮；形成；构成</p><p> 性格は幼児期に形作られる。</p></li><li><p>大正のころの写真術が現代のように、人間の生態を動的に捉えることができなかった<strong>という事情が働いているでしょう</strong></p><p> <strong>という事情が働いているでしょう</strong>：表示推测，意思是“这样的情况在起作用吧”</p><p> 大正时期的摄影技术无法像现代一样动态地捕捉人类的生态，这应该是由于当时的技术条件所限。</p></li><li><p>もたらされたもの</p><p> 带来的结果</p><p> この技術革新がもたらされたものは多大な利益です</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>いずれ先</p><p> 不久、迟早、总有一天</p><p> いずれ先のことを考えなければならない</p></li><li><p>親父（おやじ）</p></li><li><p>問屋</p><p> 批发商，批发店</p></li><li><p>仕合せ（しあわせ）</p><p> 同　　幸せ</p></li><li><p>切迫（せっぱく）</p><p> 紧迫，吃紧、逼近</p><p> 切迫した情勢</p></li><li><p>帰り<strong>がけに</strong></p><p> 在……的路上、在……的时候</p></li><li><p>跡取り（あととり）</p><p> 后嗣</p></li></ol><p><strong>翻译</strong></p><ol><li><p>顕著(けんちょ)</p><p> 顕著な事実</p></li><li><p>基礎（きそ）</p><p> 根基，础石</p><p> 基礎がしっかりしている</p></li><li><p>明記（めいき）</p><p>写明，记明，标明，清楚记载</p><p>住所氏名を明記する</p></li><li><p>ギャップ</p><p>gap, 裂口，裂缝，间隙，差距</p><p>世代間のギャップを感ずる</p></li><li><p>フィット</p><p> fit；合身，适合</p><p> 体にフィットした服</p></li><li><p>迷走（めいそう）</p><p> 迷路，迷航，陷入困境</p><p> 彼は新しいプロジェクトで迷走している</p></li></ol><h3 id="2021"><a href="#2021" class="headerlink" title="2021"></a>2021</h3><p><strong>完型</strong></p><ol><li><p>「気」总结</p><ol><li><p>気がする：心里感到，好像；总觉得；有心思；动心</p><p> どこかで見たことがあるような気がする</p></li><li><p>気になる：担心；忧虑；介意；有意；有心；想要</p><p> 彼女のことが気になる</p></li><li><p>気にする：介意，担心、挂念</p><p> 失敗を気にするな</p></li><li><p>気がつく：意识到，注意到、苏醒，清醒</p><p> 間違ったところに気がついた</p></li></ol></li><li><p>赤褐色（せっかっしょく）</p></li><li><p>長いなじみ</p><p> 熟悉、熟识</p><p> 彼とは長いなじみだから、何でも話せる</p></li><li><p>早朝（そうちょう）</p></li><li><p>色艶（いろつや）</p><p> 光泽，色泽；气色，面色；肤色</p><p> 顔の色艶がよい</p></li><li><p>朗らか（ほがらか）</p><p> 明朗；开朗；爽快；晴朗</p><p> 朗らかに晴れわたった空</p></li><li><p>往き来する（いききする）</p><p> 来往、往返、进出</p><p> 彼は毎日学校と家の間を往き来している</p></li><li><p>もがき</p><p>  苦战；挣扎；抵抗</p><p>  最後のもがき</p></li><li><p>如く（ごとく）</p><p> 女の髪の如く</p></li><li><p>まざまざ</p><p>清清楚楚，清晰，历历</p><p>まざまざ（と）思い出す</p></li><li><p>不断に（ふだんに）</p></li><li><p>快活（かいかつ）</p><p> 快活；爽快；干脆；开朗；爽朗</p><p> 快活に笑う</p></li><li><p>萎れる（しおれる）</p><p> 花が萎れた</p></li><li><p>湿り（しめり）</p><p> 湿气，潮湿，湿润</p><p> 火薬に湿りがあって発火しなかった</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>レール</p><p> rail,轨道,事先的准备</p><p> レールを敷く</p></li><li><p>いざ</p><p> 表示关键时刻或重要时刻的到来，通常带有一种紧张感或转折感</p></li><li><p>基礎(きそ)</p></li><li><p>漠然と取り組む</p><p> 在模糊、不明确的状态下进行埋头苦干</p></li><li><p>ロールプレイングゲーム</p><p> Role-Playing Game，缩写为RPG</p></li><li><p>陥る（おちいる）</p></li><li><p>答えが載っているので自分で調べる<strong>くせがつかない</strong></p><p> 没有养成……的习惯</p></li><li><p>何らかの成果をもたらす</p><p> 某种行动或努力产生了某种成果</p></li><li><p>地道に（じみちに）</p><p> 脚踏实地</p><p> 彼は地道に勉強を続けて、ついに大学に合格した</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>罰当番（ばつとうばん）</p><p> 罚做值日</p></li><li><p>箒（ほうき）</p><p> 帚，笤帚，扫帚</p></li><li><p>掃き（はき）</p></li><li><p>下駄（げた）</p><p> 木履，木屐</p></li><li><p>渦巻き（うずまき）</p><p> 漩涡</p></li><li><p>労わる（いたわる）</p><p> 体贴，安慰，慰劳</p><p> 手伝いの人をいたわることば</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>頭が柔軟な若い時代</p><p> 思维灵活的年轻时代</p><p> 頭が柔軟な若い時代に、できるだけ多くのことを学ぶべきだ</p></li><li><p>老婆心（ろうばしん）</p><p> 婆心，恳切之心</p><p> 老婆心ながら言いますが、健康には十分気を付けてください</p></li></ol><p><strong>阅读4</strong></p><ol><li><p><strong>ぶつかり合い</strong>は何としてでも避ける</p><p> 冲突</p></li><li><p>色調（しきちょう）</p><p> この絵の色調はとてもよい</p></li><li><p>影がさしている</p><p> 影子投射在某处、表示某种不好的预感、阴影或征兆</p><p> 夕日が沈むとき、木々の影がさしている</p><p> 二人の関係に影がさしていることに気付いた</p></li><li><p>愛想</p><p> 亲切，和蔼、招待，款待、礼貌 </p><p> 彼女は誰にでも愛想がよい</p></li><li><p>あるいは愛想を意識してのことである</p><p> 或者是出于对礼貌的考虑</p></li><li><p>というのもあらゆる欠如にもかかわらず、日本文化は肯定的でもあり得るのだから</p><p> 欠如（けつじょ）</p><p> にもかかわらず：惯用表达，意思是“尽管……”、“虽然……”</p><p> あり得る：表示“有可能”</p><p> 这是因为，尽管存在各种不足，日本文化仍然有可能是积极的</p></li><li><p>形而上学（けいじじょうがく）</p></li><li><p>ずれ込む</p><p> 延迟，推后</p><p> 会期が翌月にずれ込んだ</p></li><li><p>对峙（たいじ）</p></li><li><p>慣性（かんせい）</p></li><li><p>敵対（てきたい）</p></li><li><p>世俗（せぞく）</p></li></ol><p><strong>翻译</strong></p><ol><li><p>あたかも</p><p> 恰似，犹如，宛如，正好</p><p> 日差しが暖かであたかも春の様だ</p></li><li><p>～もさることながら</p><p> ……自不必说，……更是如此</p><p> 健康もさりながら、日々の生活習慣が大切だ</p></li></ol><h3 id="2020"><a href="#2020" class="headerlink" title="2020"></a>2020</h3><p><strong>完型</strong></p><ol><li><p>願いを抱く</p><p> 怀有梦想</p></li><li><p>相対的な事柄<strong>でさえない</strong>のだとしたら</p><p> 如果连相对的事情都不是的话</p><p> でさえない：表示“甚至连……都不是”的意思。这里用于强调程度，指连最基本的相对性都不具备。</p></li><li><p>たちまち</p><p> 忽，忽然，突然、不一会儿；转眼间；立刻；眨眼之间</p><p> 緊張した空気は、たちまち和らいできた</p></li><li><p>実践（じっせん）</p></li><li><p>ながら用法</p><ol><li><p>逆接（虽然……但是……）</p><p> 彼は忙しいと言いながら、手伝ってくれた</p></li><li><p>动作的同时进行（并行）</p><p> 音楽を聞きながら勉強する</p></li><li><p>原样；原封不动；如……一样</p><p> この種の大根は皮ながら食べたほうがおいしい</p></li><li><p>全部，都，表示同类事物处于相同状态中</p><p> 兄弟三人ながら人気のある歌舞伎俳優である</p></li></ol></li></ol><p><strong>阅读1</strong></p><ol><li><p>類似（るいじ）</p></li><li><p>東洋の諸言語が外国語から無意識に除外されているからである</p><p> 因为东方的诸多语言在无意识中被排除在外语之外</p></li><li><p>具える（そなえる）</p><p> 准备;防备;设置;备置;(生来)具备;具有</p><p> 徳と才能をともに具える</p></li><li><p>英語が非日本語型言語の典型などではありえないこと</p><p> 英语不可能是非日本语型语言的典型</p></li><li><p>平然（へいぜん）</p><p> 沉着，冷静，镇静</p><p> 坦然，泰然，不在乎</p><p> 平然たる態度</p></li><li><p>前述（ぜんじゅつ）</p><p> 前述，上述</p><p> 前述のとおり</p></li><li><p>查定（さてい）</p><p> 核定，查定，审定；估定；评定</p><p> 値段を査定する</p></li><li><p>媒体（ばいたい）</p><p> 媒介物，手段，（理）介质</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>トルストイが人間が自然をどんなに<strong>虐げ</strong>、春はやはり春だと言っている</p><p> 虐げる(しいたげる)：虐待，欺负</p><p> 托尔斯泰说，无论人类如何虐待自然，春天依然是春天（即使人类再怎么虐待和破坏自然，春天还是会如期而至）</p></li><li><p>石畳（いしだたみ）</p><p> 石级，石阶</p></li><li><p>凋落（ちょうらく）</p><p> 草木凋落の候</p></li><li><p>照応（しょうおう）</p><p> 照应，呼应</p><p> 首尾（しゅび）が照応している</p></li><li><p>逸脱（いつだつ）</p><p> 越出，脱离</p><p> 本来の目的から逸脱している</p></li><li><p>帯びる（おびる）</p><p> 雨を帯びた雲</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>生老病死（しょうろうびょうし）</p></li><li><p>そこでどうするかというと</p><p> “那么，在这种情况下，我们该怎么办呢？”或“那么，接下来该怎么做呢？”这个表达通常用来引出某种行动或解决方案</p><p> 生老病死をなぜかみな嫌がります、できれば考えたくない。<strong>そこでどうするかというと</strong>、例えば人間が生まれるのも特別なことだから、病院へ行ってくれというのです</p><p> 那么，接下来该怎么办呢？比如说，人类的诞生是一件特别的事情，所以需要去医院</p></li><li><p>なりゆき（成り行き）</p><p> 动向，趋势；发展，过程；推移，变迁，演变；结果，结局</p><p> 成り行き次第で考えなくてはならない</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>行き届く（ゆきとどく）</p><p> 周到，无微不至。</p><p> 私のゆき届かないところはどうぞご意見を出してください</p></li><li><p>威勢（いせい）</p><p> 朝气，精神</p><p> 威勢のいい若者</p></li><li><p>一回り（ひとまわり）</p><p> 一圈，一周</p><p> 得意先を一回りする</p></li><li><p>ぞろぞろ</p><p> 一个跟着一个，络绎不绝</p></li><li><p>決まりが悪い</p><p> 感到难为情、不好意思、尴尬</p></li><li><p>当分（とうぶん）</p><p> 现在，目前、暂时，一时</p><p> 当分外出できない</p></li><li><p>ぞんざい</p><p> 粗草，草率，马虎、粗鲁，没礼貌</p><p> ぞんざいなことば</p></li><li><p>お母さんらしい<strong>やと</strong>私たちは大笑いしながら</p><p> やと：这是一个口语化的表达，相当于“だと”的口语形式</p></li><li><p>追い込みにかかっていた仕事に区切りをつけ</p><p> 为进入最后冲刺阶段的工作告一段落</p><ol><li>追い込みにかかっていた（おいこみにかかっていた）：动词短语，“追い込み”意思是“最后冲刺”或“最后阶段的努力”，“かかっていた”表示“正在进行中”或“已经开始”。整个短语指的是某项工作已经进入了最后的紧张阶段。</li><li>区切りをつけ（くぎりをつけ）：动词短语，“区切り”意思是“段落”或“阶段”，“つける”意思是“做标记”或“告一段落”。整个短语表示将某件事告一段落，完成某个阶段。</li></ol></li></ol><p><strong>翻译</strong></p><ol><li><p>代表格</p><p> 代表资格</p><p> 彼はその分野の代表格だ（他是那个领域的代表性人物）</p></li><li><p>門を出る時、「门槛」を踏んではいけません。<strong>またいで</strong>越えるのです</p><p> 跨ぐ（またぐ）：跨过</p><p> 出门的时候，不要踩门槛。要跨过去</p></li></ol><h3 id="2019"><a href="#2019" class="headerlink" title="2019"></a>2019</h3><p><strong>完型</strong></p><ol><li><p>覚醒剤（かくせいざい）</p><p> 兴奋剂</p></li><li><p>任意（にんい）</p><p> 随意</p><p> 各自任意の行動をとる</p></li><li><p>証拠（しょうこ）</p><p>  证据，证明</p><p> 証拠を挙げる</p></li><li><p>冤罪（えんざい）</p></li><li><p>密室（みっしつ）</p></li><li><p>拘留（こうりゅう）</p></li><li><p>押しかけ</p><p> 不请自来</p><p> 押しかけ女房</p></li><li><p>ペンライト</p><p> penlite ;（笔型）手电筒</p></li><li><p>肩がぶつかっただけでも逮捕されかねない</p><p> 即使只是肩膀碰了一下，也有可能会被逮捕</p></li><li><p>にわたって</p><p>在……范围内、涉及……</p><p>3年間にわたってこのプロジェクトに取り組んできました</p><p>彼は全国にわたって講演活動を行った</p></li><li><p>に応じて</p><p>“根据……”、“按照……”、“依照……”</p><p>状況に応じて、計画を変更する必要がある</p></li><li><p>にもかかわらず</p><p>“尽管……但是……”、“虽然……却……”</p><p>雨が降っていたにもかかわらず、彼らは試合を続けた</p></li><li><p>あたかも</p><p>恰似，犹如，宛如，正好。</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>さもなければ</p><p> “否则”、“不然的话”、“要不然”</p><p> 早く出発しなさい。さもなければ、遅刻しますよ</p></li><li><p>憤り（いきどおり）</p></li><li><p>詠嘆（えいたん）</p><p> 赞叹、感叹，叹声</p><p> 見事な演技に詠嘆する</p></li><li><p>ご無理ごもっとも</p><p> “您的意见或要求合情合理”、“确实有道理”</p><p> ご無理ごもっともですが、現在の状況では対応が難しいです</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>思い思い</p><p> 各随己愿</p><p> 思い思いの意見を述べる</p></li><li><p>睨む（にらむ）</p><p> 盯视，瞪眼</p><p> あの人に睨まれたら最後だ</p></li><li><p>抜け道</p><p> 近路、小路</p><p> 规避途径。钻法律或规则等的空子以逃避责任的方法</p><p> あらかじめ抜け道を用意しておく</p></li><li><p>いたずら書き（いたずらがき）</p><p> 涂鸦</p></li><li><p>周縁（しゅうえん）</p><p> 周边</p></li><li><p>悪童（あくどう）</p></li><li><p>遊戯（ゆうぎ）</p></li><li><p>一瞥（いちべつ）</p></li><li><p>歓ぶ（よろこぶ）</p></li><li><p>𠮟声（しっせい）</p></li><li><p>黙認（もくにん）</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>志村（しむら）</p></li><li><p>気安さ（きやすさ）</p><p> “随意”、“轻松”、“亲切”或“无拘无束”的感觉</p><p> 彼の家はとても気安さを感じる場所だ</p></li><li><p>ごつごつ</p><p> 不平滑，凹凸不平</p></li><li><p>脳裏（のうり）</p></li><li><p>樹皮（じゅひ）</p></li><li><p>神髓（しんずい）</p><p> 精髓，精华，真髓，蕴奥</p></li><li><p>それを発している人類全体の世界を<strong>いや応なしに</strong>背負ってしまうとこうにあるからである</p><p> いや応なしに：不得不</p><p> 因为一旦发出这个（某种行为或言论），人类整体的世界将被无可奈何地背负起来。</p></li></ol><p><strong>翻译</strong></p><ol><li><p>クローズアップ</p><p> close up；特写，特写镜头，大书特书，作为一个大问题提出来。</p><p> エネルギー問題がクローズアップされてきた</p></li><li><p>棲む（すむ）</p><p> 居住，栖息</p><p> 水に棲む動物</p></li><li><p>脚光に浴びる（きゃっこうにあびる）</p><p> 引人注目、受到瞩目</p><p> 彼は新人賞を受賞し、一気に脚光に浴びた</p></li><li><p>ひたすら</p><p> 只顾。一味。一心一意。一个劲儿</p><p> ひたすら勉学に励む</p></li><li><p>一貫（いっかん）</p><p> 一贯，自始至终，始终如一，贯彻到底。</p><p> 一貫した経済政策</p></li><li><p>えご</p><p> 个人主义，自我主义，利己主义</p><p> エゴの強い人</p></li><li><p>何でもかんでも</p><p> 一切;什么都;无论如何;务必</p><p> 何でもかんでも大事にしまう</p></li><li><p>シンポジウム</p><p> symposium；讨论会，座谈会，专题论文集。</p></li></ol><h3 id="2018"><a href="#2018" class="headerlink" title="2018"></a>2018</h3><p><strong>完型</strong></p><ol><li><p>果ては</p><p> 最后，终于</p></li><li><p>なんてこと</p><p> 表达惊讶、难以置信、失望、愤怒等情感</p><p> なんてこと、彼がこんなに上手に歌えるとは思わなかった</p></li><li><p>もっとも</p><ol><li>转折</li><li>理所当然</li><li>最…</li></ol></li><li><p>なりに</p><p> “按照……的方式”或“以……的能力”</p><p> 若者は若者なりに一生懸命考えて行動している</p></li><li><p>であったり</p><p> 由“である”（“です”的书面体）和助词“たり”组合而成，表示列举</p><p> 彼は教師であったり、作家であったり、多彩なキャリアを持っている</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>チンパンジー</p><p> 黑猩猩</p></li><li><p>思い込む</p><p> 深信，确信；以为，认定</p><p> 思い込んで疑わない</p></li><li><p>嗅ぐ（かぐ）</p><p> 闻，嗅。用鼻子感知气味</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>石垣</p><p>  石垣，石墙，石围墙。</p></li><li><p>カーブ</p><p> curve；弯曲，弯</p><p> 道のカーブにかかる。（到了（道路的）转弯处）</p></li><li><p>いうに及ばず</p><p> 自不必说</p></li><li><p>連中（れんじゅう）</p><p> 伙伴，同伙</p></li><li><p>亭主（ていしゅ）</p><p> 丈夫，当家的，主任</p></li><li><p>によるものではない</p><p> 并非由于……</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>そこは紅白歌合戦<strong>もなければ</strong>、大晦日の夜の鐘の音も聞こえてこなかった</p><p> もなければ：表示“既没有……也没有……”，用来列举多个不存在的事物。</p></li><li><p>今回は日本と欧米との年の区切りのちがい<strong>ばかり</strong>が、気になった</p><p> <strong>ばかりが</strong>：意思是“只”或“仅仅”，表示在意的重点只集中在某个方面。</p><p> 这次我只是特别在意日本和欧美在年终时段划分上的不同</p></li><li><p>紅白歌合戦は「明けましておめでとう」を強調した<strong>ものを</strong>、年が明けてからやろうではないか</p><p> “ものを”带有遗憾或抱怨的语气，意思是“明明是……却……”</p><p> 红白歌合战是强调‘新年快乐’的活动，为什么不等到跨年之后再举办呢？</p></li><li><p>いわゆる春節では<strong>それはそれは</strong>大変で</p><p> “それはそれは”用于强调，表示某件事情的程度非常强烈</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>人がせっかくよい気持ちに<strong>眠りかかったところ</strong>をと、<strong>生返事</strong>するか、<strong>でなければ</strong>狸寝入りをするのであるが</p><p> <strong>眠りかかったところ</strong>：指“快要睡着的时候”</p><p> <strong>生返事</strong>：敷衍地回应</p><p> <strong>でなければ</strong>：“否则”或“要不然”</p><p> <strong>狸寝入り</strong>（たぬきねいり）：假装睡觉</p></li><li><p>無愛想（ぶあいそう）</p><p> 简慢，不和气，冷淡</p></li><li><p>思索（しさく）</p></li><li><p>場合にぶつかる</p><p> 遇到某种情况</p></li><li><p>耽る（ふける）</p><p> 耽于，沉湎，入迷，沉溺</p></li><li><p>ともすると</p><p> 表示一种行为或情况容易发生，常伴随不自觉地、有意无意地表现出某种特定行为</p></li><li><p>あたかも</p><p> “宛如”、“仿佛”、“好像”</p><p> 彼はあたかも何事もなかったかのように振る舞った</p></li><li><p>煩わしい</p><p> 繁琐的，麻烦的，复杂的</p></li></ol><p><strong>翻译</strong></p><ol><li><p>思い込みによるものがある</p><p> 由于思维定式造成的</p><p> によるものがある：“由……引起的”或“由于……造成的”</p></li><li><p>曰く（いわく）</p><p> 曰，云，所说，所言，说道</p></li><li><p>啞然（あぜん）</p><p> 哑然。目瞪口呆</p></li><li><p>適性というものなど<strong>ありえない</strong></p><p> 所谓的适性根本不存在、适性这种东西是不存在的</p><p> <strong>ありえない</strong>：意思是不可能存在、不能成立</p></li></ol><h3 id="2017"><a href="#2017" class="headerlink" title="2017"></a>2017</h3><p><strong>完型</strong></p><ol><li><p>鮮明(せんめい)</p></li><li><p>蹴る(ける)</p><p> 踢，踹，蹬,拒绝，驳回,愤然离开。气冲冲地退场</p></li><li><p>威張る（いばる）</p><p> 逞威风，自以为了不起；了不起，理所当然。</p><p> 威張って歩く</p></li><li><p>阻止（そし）</p></li><li><p>嫌味（いやみ）</p><p> 讨厌，令人生厌。给人不快的感觉</p><p> 人に嫌味を言う</p></li><li><p>憤然（ふんぜん）</p><p> 憤然として席を立つ</p></li><li><p>この話を聞きながら、コトンと胸に落ちたことがあった</p><p> <strong>胸に落ちる</strong>：納得がいく</p><p> 听这番话时，我突然明白了什么。</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>葉書（はがき）</p></li><li><p>ことごとく</p><p> 全部，一个不剩，所有，一切</p><p> そのことはことごとく承っています（承る　うけたまわる　知道，敬悉）</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>お稽古事（おけいこごと）</p><p> 课外兴趣班、才艺学习</p><p> 娘はピアノのお稽古事に通っています</p></li><li><p>タイプライター</p><p> typewriter、打字机</p></li><li><p>慎みがちになる（つつしみがちになる）</p><p> 变得比较谨慎</p></li><li><p>せっせと</p><p> 勤勉地、努力地</p></li><li><p>通り掛かりで見てはっと納得した光景</p><p> 路过时看到的情景，突然让我感到深有体会</p></li><li><p>逢う（あう）</p><p> 遇见，碰见</p></li><li><p>項垂れる（うなだれる）</p><p> （因悲观、失望、担心、羞耻等）垂头,低头</p><p> 恥しさのあまり項垂れた</p></li><li><p>怠け者（なまけもの）</p><p> 懒汉</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>というわけです</p><p> “也就是说”、“因此”、“所以的意思是”</p><p> 彼がここに来たのは、その問題を解決するためだというわけです</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>呪術（じゅじゅつ）</p></li><li><p>肘付き（ひじつき）</p></li><li><p>安楽（あんらく）</p><p> 安乐，舒适</p><p> 今では安楽に暮している</p></li><li><p>ずばり</p><p> 击中要害，直截了当，一针见血</p><p> ずばりといえば</p><p> 痛い事をずばり（と）言ってのける</p></li></ol><p><strong>翻译</strong></p><ol><li><p>記述（きじゅつ）</p><p> 描述、记述</p><p> 事件の経過を記述する</p></li><li><p>きわめて簡単に言ってしまえば</p><p> 简而言之</p></li></ol><h3 id="2016"><a href="#2016" class="headerlink" title="2016"></a>2016</h3><p><strong>完型</strong></p><ol><li><p>邁進（まいしん）</p><p> 迈进，挺进</p></li><li><p>五節句（ごせっく）</p><p> 五个节日。明治维新后因采用新历法，所以节日过的都是阳历。日本古时一年中五个节日的总称。指一月七日（人日、七草）、三月三日（上巳、雏、桃等）、五月五日（端午、菖蒲等）、七月七日（七夕）和九月九日（重阳、菊花等）</p></li><li><p><strong>を</strong>始めとする</p><p> 以…为首</p></li><li><p>仲秋の名月（ちゅうしゅうのめいげつ）</p><p> 中秋之名月</p><p> 今夜は仲秋の名月だから、家族と一緒にお月見をする予定です</p></li><li><p>盛夏（せいか）</p></li><li><p>时间名词＋には</p><p> 用于描述一个特定时间点或时间范围，强调在那个时间或为了那个时间发生某个动作或情况</p><p> 朝には出発しなければならない</p><p> 来月には準備が完了する予定です</p><p> 夏休みには旅行に行こうと思っています</p></li><li><p>日付（ひづけ）</p><p> 日期；年月日</p><p> 日付を書き込む</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>就職を控える</p><p> 临近就职</p><p> <strong>控える（ひかえる）</strong>：有“接近”、“即将到来”的意思，表示某个重要的事情即将发生。此外，它也可以表示“准备”、“等待”或“有所节制”。</p></li><li><p>掟（おきて）</p><p> 成规；规章；法令</p><p> 国の掟によって裁く</p></li><li><p>証券（しょうけん）</p></li><li><p>足蹴（あしげ）</p></li><li><p>平然（へいぜん）</p><p> 沉着，冷静，镇静、坦然，泰然，不在乎。</p><p> 平然たる態度</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>思案（しあん）</p></li><li><p>吟味（ぎんみ）</p><p> 吟诵诗歌仔细体会其含义，玩味、斟酌，考虑</p><p> 品物はよく吟味してから買いなさい</p></li><li><p>骨格（こっかく）</p><p> 骨骼</p></li><li><p>お名残惜しいことですな</p><p>“真是依依不舍啊”或“实在让人难以割舍啊”</p><p>お名残（おなごり）：离别，临别纪念</p><p>この場所を離れるのは、お名残惜しいことですな</p></li><li><p>わきに</p><p>在旁边；在一边；另外；旁白；背躬</p></li><li><p>思いがけないこと</p><p> 意想不到的是</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>巡回（じゅんかい）</p></li><li><p>アクセント</p><p> 语调，口音</p></li><li><p>舌足らずで、もどかしい（、もどかしい）</p><p> 舌足らず（したたらずで）：字面意思是“舌头不够”，引申为表达能力不足、语言不够流畅，或者说话时词不达意、不能很好地表达自己的意思。可以指口齿不清或表达能力欠缺。</p><p> もどかしい：意思是“令人着急的”、“焦急的”或“令人懊恼的”，通常用来形容无法如愿或进展不顺利时的焦急感。</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>投げかける</p><p> 投，扔过去，投到</p></li><li><p>借用（しゃくよう）</p></li><li><p>閃く（ひらめく）</p><p> 闪耀，闪烁、闪现，忽然想出</p></li><li><p>抑陽（よくよう）</p><p> 抑扬顿挫</p></li></ol><p><strong>翻译</strong>✨</p><ol><li><p>いい気になりすぎる</p><p> “得意忘形”、“太得意”、“过于自满”之意。</p></li><li><p>思い込む</p><p> 深信，确信；以为，认定</p></li><li><p>心を奪われる</p><p> 痴迷于</p></li><li><p>背を向けている</p><p> 逃避（某事物）、拒绝</p></li><li><p>というのも</p><p> 原因。之所以…是因为…</p></li><li><p>いい加減ですませている</p><p> “敷衍了事”、“草草了事”</p></li><li><p>自分の新しく知った知識に<strong>しがみつき</strong></p><p> しがみつく：“紧抓住”或“抱住不放”</p></li><li><p>刻々に（こくこくに）</p><p> 時時刻刻</p></li><li><p>とりもなおざず</p><p> 不管怎样</p><p> 彼の決断はとりもなおざず重要だ</p></li><li><p>知識は余裕を伴わねば、教養のうちに取り入られません</p><p>知识如果没有余裕，就无法融入教养之中。</p></li></ol><h3 id="2015"><a href="#2015" class="headerlink" title="2015"></a>2015</h3><p><strong>完型</strong></p><ol><li><p>うとうと</p><p> 迷迷糊糊</p></li><li><p>半分夢を見ているような感じだった</p><p> 感觉像是在半梦半醒之间</p></li><li><p>遠くに<strong>なだらか</strong>な山が見える</p><p> なだらか：坡度小，不陡、平稳；顺利</p><p> 远处映入眼帘的是连绵的山脉</p></li><li><p>うっすらと</p><p> 稍微，隐约，薄薄地</p></li><li><p>傷口（きずぐち）</p></li><li><p>そっと</p><p> 轻轻地，悄悄地；偷偷地，暗中；不惊动，不管，不理</p></li></ol><p><strong>阅读1</strong></p><ol><li><p>力量（りきりょう）</p></li><li><p>ゆえ</p><p> 因…故…；因为…所以…</p></li><li><p>過ち（あやまち）</p><p> 犯错、失误</p></li><li><p>ふさわしい</p><p> 适合，相称</p></li><li><p>戒める（いましめる）</p><p> 劝戒，劝告，规劝</p></li></ol><p><strong>阅读2</strong></p><ol><li><p>ふとしたことから</p><p> 出于某个偶然的事情</p></li><li><p>よそ行き</p><p> 客气，一本正经，郑重其事的态度或谈吐</p></li><li><p>半世紀あまり</p><p> 超过50年</p></li><li><p>しなやか</p><p> 柔软，软和</p></li><li><p>テンポ</p><p> tempo;速度，拍子</p></li><li><p>プロセス</p><p> process；经过，过程</p></li></ol><p><strong>阅读3</strong></p><ol><li><p>居眠り</p><p> 打盹</p></li><li><p>鷗（かもめ）</p></li><li><p>差し掛かる（さしかかる）</p><p> 来到，临到，靠近，路过</p></li><li><p>ひらりと</p><p> 敏捷地。轻轻地</p></li><li><p>上気（じょうき）</p><p> 脸上发烧，面红耳赤</p><p> はずかしくて上気する</p></li><li><p>ぶら下がる</p><p> 吊垂，悬，耷拉</p></li><li><p>ついぞ</p><p> 从来（没有），从（未），一向</p><p> ついぞ読んだことがない</p></li><li><p>胸を張り断髪を振り（むねをはりだんぱつをふり）</p><p> 挺胸而立，摇动着短发</p></li><li><p>肩で刻むように息をしながら目がキラキラ光っている</p><p> 肩で刻むように息をしながら：“刻印”或“雕刻”，这里比喻肩膀的起伏像是有节奏地在刻画</p></li><li><p>勝気（かちき）</p><p>干劲</p></li><li><p>項垂れる（うなだれる）</p><p>垂头,低头</p></li></ol><p><strong>阅读4</strong></p><ol><li><p>揃いも揃って</p><p> （多用于不好的事物）全都是，净是</p></li></ol><p><strong>翻译</strong></p><ol><li><p>そうではないと思いたい</p><p> 不想承认</p></li><li><p>どう転んでもたいした違いはない</p><p> 転ぶ：意思是“翻转”或“变化”，在这里表示结果或情况的变化。</p><p> 无论怎么变化，差别都不大</p></li><li><p>選択を楽しむ、という程度の意味しかあるまい</p><p> 大概只有‘享受选择’这样的意味了</p></li><li><p>個々の選択はいい加減にできないが</p><p> 虽然每一个选择都不能草率地做出</p></li><li><p>然るべく</p><p> 适当地。尽量好些地</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>高数题目</title>
    <link href="/2024/07/21/%E8%80%83%E7%A0%94/%E9%AB%98%E6%95%B0%E9%A2%98%E7%9B%AE/"/>
    <url>/2024/07/21/%E8%80%83%E7%A0%94/%E9%AB%98%E6%95%B0%E9%A2%98%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="解微分方程总结"><a href="#解微分方程总结" class="headerlink" title="解微分方程总结"></a>解微分方程总结</h1><h2 id="可分离变量"><a href="#可分离变量" class="headerlink" title="可分离变量"></a>可分离变量</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%931.png"></p><h2 id="齐次方程"><a href="#齐次方程" class="headerlink" title="齐次方程"></a>齐次方程</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%932.png"></p><h2 id="一阶线性方程"><a href="#一阶线性方程" class="headerlink" title="一阶线性方程"></a>一阶线性方程</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%933.png"></p><h2 id="伯努利方程"><a href="#伯努利方程" class="headerlink" title="伯努利方程"></a>伯努利方程</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%934.png"></p><h2 id="高阶常系数齐次线性方程"><a href="#高阶常系数齐次线性方程" class="headerlink" title="高阶常系数齐次线性方程"></a>高阶常系数齐次线性方程</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%935.png"></p><h2 id="二阶常系数非齐次线性方程"><a href="#二阶常系数非齐次线性方程" class="headerlink" title="二阶常系数非齐次线性方程"></a>二阶常系数非齐次线性方程</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%936.png"></p><h2 id="可降阶"><a href="#可降阶" class="headerlink" title="可降阶"></a>可降阶</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%937.png"></p><h2 id="欧拉方程"><a href="#欧拉方程" class="headerlink" title="欧拉方程"></a>欧拉方程</h2><p><img src="/img/gaoshu_practice_img/%E8%A7%A3%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E6%80%BB%E7%BB%938.png"></p><h1 id="多元函数积分总结"><a href="#多元函数积分总结" class="headerlink" title="多元函数积分总结"></a>多元函数积分总结</h1><h2 id="三重积分"><a href="#三重积分" class="headerlink" title="三重积分"></a>三重积分</h2><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%931.png" alt="轮换对称性和奇偶性可降低计算难度"></p><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%932.png" alt="积分区域为球时可用球坐标"></p><h2 id="高斯公式"><a href="#高斯公式" class="headerlink" title="高斯公式"></a>高斯公式</h2><p>使用条件：</p><ol><li>曲面封闭</li><li><strong>函数可导</strong>（注意不可导点）</li></ol><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%933.png" alt="轮换对称性和奇偶性可降低计算难度"></p><h2 id="旋转曲面、投影曲面"><a href="#旋转曲面、投影曲面" class="headerlink" title="旋转曲面、投影曲面"></a>旋转曲面、投影曲面</h2><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%934.png"></p><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%935.png" alt="第一类曲面积分计算"></p><h2 id="格林公式"><a href="#格林公式" class="headerlink" title="格林公式"></a>格林公式</h2><p>使用条件：</p><ol><li>封闭，正向（往曲线方向走时左手边）</li><li>有一阶连续导数</li></ol><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%936.png" alt="第一类曲面积分计算"></p><h2 id="斯托克斯公式"><a href="#斯托克斯公式" class="headerlink" title="斯托克斯公式"></a>斯托克斯公式</h2><p>使用条件</p><ol><li>封闭，正向（右手法则，向上为正）</li><li>有一阶连续导数</li></ol><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86%E6%80%BB%E7%BB%937.png" alt="第一类曲面积分计算"></p><h1 id="级数求和总结"><a href="#级数求和总结" class="headerlink" title="级数求和总结"></a>级数求和总结</h1><h2 id="整式型级数求和"><a href="#整式型级数求和" class="headerlink" title="整式型级数求和"></a>整式型级数求和</h2><p><img src="/img/gaoshu_practice_img/%E6%95%B4%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E5%B8%B8%E7%94%A8%E5%85%AC%E5%BC%8F.png"></p><p><img src="/img/gaoshu_practice_img/%E6%95%B4%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E6%95%B4%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E6%95%B4%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%983.png"></p><h2 id="分式型级数求和"><a href="#分式型级数求和" class="headerlink" title="分式型级数求和"></a>分式型级数求和</h2><p><img src="/img/gaoshu_practice_img/%E5%88%86%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E5%B8%B8%E7%94%A8%E5%85%AC%E5%BC%8F.png"></p><p><img src="/img/gaoshu_practice_img/%E5%88%86%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E5%B8%B8%E7%94%A8%E5%85%AC%E5%BC%8F%E6%8E%A8%E5%AF%BC.png"></p><p><img src="/img/gaoshu_practice_img/%E5%88%86%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%88%86%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E5%88%86%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%88%86%E5%BC%8F%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%984.png"></p><h2 id="阶乘型级数求和"><a href="#阶乘型级数求和" class="headerlink" title="阶乘型级数求和"></a>阶乘型级数求和</h2><p><img src="/img/gaoshu_practice_img/%E9%98%B6%E4%B9%98%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E5%B8%B8%E7%94%A8%E5%85%AC%E5%BC%8F.png"></p><p><img src="/img/gaoshu_practice_img/%E9%98%B6%E4%B9%98%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E9%98%B6%E4%B9%98%E5%9E%8B%E7%BA%A7%E6%95%B0%E6%B1%82%E5%92%8C%E4%BE%8B%E9%A2%982.png"></p><h1 id="660"><a href="#660" class="headerlink" title="660"></a>660</h1><h2 id="660-极限"><a href="#660-极限" class="headerlink" title="660(极限)"></a>660(极限)</h2><h3 id="1-函数和定积分"><a href="#1-函数和定积分" class="headerlink" title="1-函数和定积分"></a>1-函数和定积分</h3><p><img src="/img/gaoshu_practice_img/660_1.png"></p><p><strong>补充题</strong></p><p><img src="/img/gaoshu_practice_img/660_1_%E8%A1%A5%E5%85%851.png" alt="拆积分区间"></p><p><img src="/img/gaoshu_practice_img/660_1_%E8%A1%A5%E5%85%852.png" alt="周期和拆积分区间"></p><h3 id="4-1的∞次方型"><a href="#4-1的∞次方型" class="headerlink" title="4-1的∞次方型"></a>4-1的∞次方型</h3><p><img src="/img/gaoshu_practice_img/660_4.png"></p><p>1的∞次方、∞的0次方、0的0次方都用这种方法做</p><h3 id="5-∞-∞型"><a href="#5-∞-∞型" class="headerlink" title="5-∞-∞型"></a>5-∞-∞型</h3><p><img src="/img/gaoshu_practice_img/660_5.png"></p><h3 id="6-泰勒公式计算极限"><a href="#6-泰勒公式计算极限" class="headerlink" title="6-泰勒公式计算极限"></a>6-泰勒公式计算极限</h3><p><img src="/img/gaoshu_practice_img/660_6.png"></p><h3 id="7-可爱因子"><a href="#7-可爱因子" class="headerlink" title="7-可爱因子"></a>7-可爱因子</h3><p><img src="/img/gaoshu_practice_img/660_7.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_7_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="10-底数相同的情况"><a href="#10-底数相同的情况" class="headerlink" title="10-底数相同的情况"></a>10-底数相同的情况</h3><p><img src="/img/gaoshu_practice_img/660_10.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_10_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="12-拉格朗日中值定理"><a href="#12-拉格朗日中值定理" class="headerlink" title="12-拉格朗日中值定理"></a>12-拉格朗日中值定理</h3><p><img src="/img/gaoshu_practice_img/660_12.png"></p><h3 id="15-左右极限"><a href="#15-左右极限" class="headerlink" title="15-左右极限"></a>15-左右极限</h3><p><img src="/img/gaoshu_practice_img/660_15.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_15_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE1.png" alt="补充题目1"></p><p><img src="/img/gaoshu_practice_img/660_15_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE2.png" alt="补充题目2"></p><h3 id="17-泰勒展开"><a href="#17-泰勒展开" class="headerlink" title="17-泰勒展开"></a>17-泰勒展开</h3><p><img src="/img/gaoshu_practice_img/660_17.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_17_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="19"><a href="#19" class="headerlink" title="19"></a>19</h3><p><img src="/img/gaoshu_practice_img/660_19.png"></p><h3 id="25-函数连续性"><a href="#25-函数连续性" class="headerlink" title="25-函数连续性"></a>25-函数连续性</h3><p><img src="/img/gaoshu_practice_img/660_25.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_25_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><p><img src="/img/gaoshu_practice_img/%E9%97%B4%E6%96%AD%E7%82%B9%E7%9A%84%E5%88%86%E7%B1%BB.png" alt="间断点的分类"></p><h3 id="126-夹逼定理"><a href="#126-夹逼定理" class="headerlink" title="126-夹逼定理"></a>126-夹逼定理</h3><p><img src="/img/gaoshu_practice_img/660_126.png"></p><h3 id="128-常见不等式"><a href="#128-常见不等式" class="headerlink" title="128-常见不等式"></a>128-常见不等式</h3><p><img src="/img/gaoshu_practice_img/660_128.png"></p><p><strong>补充知识点</strong></p><p><img src="/img/gaoshu_practice_img/660_128_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B91.png"></p><p><img src="/img/gaoshu_practice_img/660_128_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B92.png"></p><h3 id="132-和差化积"><a href="#132-和差化积" class="headerlink" title="132-和差化积"></a>132-和差化积</h3><p><img src="/img/gaoshu_practice_img/660_132.png" alt="法一"></p><p><img src="/img/gaoshu_practice_img/660_132_%E6%B3%95%E4%BA%8C.png" alt="法二"></p><p><strong>补充知识点</strong></p><p><img src="/img/gaoshu_practice_img/660_132_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B9.png"></p><h3 id="135-极限和无穷小的关系"><a href="#135-极限和无穷小的关系" class="headerlink" title="135-极限和无穷小的关系"></a>135-极限和无穷小的关系</h3><p><img src="/img/gaoshu_practice_img/660_135.png"></p><h3 id="137-放缩求值"><a href="#137-放缩求值" class="headerlink" title="137-放缩求值"></a>137-放缩求值</h3><p><img src="/img/gaoshu_practice_img/660_137.png"></p><h3 id="138-等价无穷小"><a href="#138-等价无穷小" class="headerlink" title="138-等价无穷小"></a>138-等价无穷小</h3><p><img src="/img/gaoshu_practice_img/660_138.png"></p><h3 id="147-母0子必0"><a href="#147-母0子必0" class="headerlink" title="147-母0子必0"></a>147-母0子必0</h3><p><img src="/img/gaoshu_practice_img/660_147.png"></p><h3 id="150-导数周期"><a href="#150-导数周期" class="headerlink" title="150-导数周期"></a>150-导数周期</h3><p><img src="/img/gaoshu_practice_img/660_150.png"></p><h3 id="152-泰勒展开的两种形式"><a href="#152-泰勒展开的两种形式" class="headerlink" title="152-泰勒展开的两种形式"></a>152-泰勒展开的两种形式</h3><p><img src="/img/gaoshu_practice_img/660_152.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_152_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="154-导数和导数极限的关系"><a href="#154-导数和导数极限的关系" class="headerlink" title="154-导数和导数极限的关系"></a>154-导数和导数极限的关系</h3><p><img src="/img/gaoshu_practice_img/660_154.png"></p><p><strong>补充知识点</strong></p><p><img src="/img/gaoshu_practice_img/660_154_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B91.png"></p><p><img src="/img/gaoshu_practice_img/660_154_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B92.png"></p><h3 id="168-导数和原函数有界无界"><a href="#168-导数和原函数有界无界" class="headerlink" title="168-导数和原函数有界无界"></a>168-导数和原函数有界无界</h3><p><img src="/img/gaoshu_practice_img/660_168.png"></p><h3 id="173-讨论函数大小关系"><a href="#173-讨论函数大小关系" class="headerlink" title="173-讨论函数大小关系"></a>173-讨论函数大小关系</h3><p><img src="/img/gaoshu_practice_img/660_173.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_173_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="174-渐近线"><a href="#174-渐近线" class="headerlink" title="174-渐近线"></a>174-渐近线</h3><p><img src="/img/gaoshu_practice_img/660_174.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_174_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h2 id="660-积分"><a href="#660-积分" class="headerlink" title="660(积分)"></a>660(积分)</h2><h3 id="29-导数定义"><a href="#29-导数定义" class="headerlink" title="29-导数定义"></a>29-导数定义</h3><p><img src="/img/gaoshu_practice_img/660_29.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_29_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="34-曲率"><a href="#34-曲率" class="headerlink" title="34-曲率"></a>34-曲率</h3><p><img src="/img/gaoshu_practice_img/660_34.png"></p><h3 id="39-复合函数求导"><a href="#39-复合函数求导" class="headerlink" title="39-复合函数求导"></a>39-复合函数求导</h3><p><img src="/img/gaoshu_practice_img/660_39.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_39_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="41-曲率半径"><a href="#41-曲率半径" class="headerlink" title="41-曲率半径"></a>41-曲率半径</h3><p><img src="/img/gaoshu_practice_img/660_41.png"></p><h3 id="42-驻点"><a href="#42-驻点" class="headerlink" title="42-驻点"></a>42-驻点</h3><p><img src="/img/gaoshu_practice_img/660_42.png"></p><h3 id="52-积分"><a href="#52-积分" class="headerlink" title="52-积分"></a>52-积分</h3><p><img src="/img/gaoshu_practice_img/660_54.png"></p><h3 id="57-二倍角公式"><a href="#57-二倍角公式" class="headerlink" title="57-二倍角公式"></a>57-二倍角公式</h3><p><img src="/img/gaoshu_practice_img/660_57.png"></p><h3 id="60-积分换元"><a href="#60-积分换元" class="headerlink" title="60-积分换元"></a>60-积分换元</h3><p><img src="/img/gaoshu_practice_img/660_60.png"></p><h3 id="61-周期"><a href="#61-周期" class="headerlink" title="61-周期"></a>61-周期</h3><p><img src="/img/gaoshu_practice_img/660_61.png"></p><h3 id="64-区间在现"><a href="#64-区间在现" class="headerlink" title="64-区间在现"></a>64-区间在现</h3><p><img src="/img/gaoshu_practice_img/660_64.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_64_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="69-反常积分"><a href="#69-反常积分" class="headerlink" title="69-反常积分"></a>69-反常积分</h3><p><img src="/img/gaoshu_practice_img/660_69.png"></p><h3 id="70-摆线"><a href="#70-摆线" class="headerlink" title="70-摆线"></a>70-摆线</h3><p><img src="/img/gaoshu_practice_img/660_70.png"></p><h3 id="70-积分几何应用"><a href="#70-积分几何应用" class="headerlink" title="70-积分几何应用"></a>70-积分几何应用</h3><p><img src="/img/gaoshu_practice_img/660_71.png"></p><h3 id="73-质心"><a href="#73-质心" class="headerlink" title="73-质心"></a>73-质心</h3><p><img src="/img/gaoshu_practice_img/660_73.png"></p><h3 id="74-物理应用"><a href="#74-物理应用" class="headerlink" title="74-物理应用"></a>74-物理应用</h3><p><img src="/img/gaoshu_practice_img/660_74.png"></p><h3 id="176-原函数"><a href="#176-原函数" class="headerlink" title="176-原函数"></a>176-原函数</h3><p><img src="/img/gaoshu_practice_img/660_176.png"></p><h3 id="177-积分性质"><a href="#177-积分性质" class="headerlink" title="177-积分性质"></a>177-积分性质</h3><p><img src="/img/gaoshu_practice_img/660_177.png"></p><h3 id="181-积分性质"><a href="#181-积分性质" class="headerlink" title="181-积分性质"></a>181-积分性质</h3><p><img src="/img/gaoshu_practice_img/660_181.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_181_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="183-定积分比大小"><a href="#183-定积分比大小" class="headerlink" title="183-定积分比大小"></a>183-定积分比大小</h3><p><img src="/img/gaoshu_practice_img/660_183.png"></p><p><strong>总结</strong></p><p><img src="/img/gaoshu_practice_img/660_183_%E6%80%BB%E7%BB%93.png"></p><h3 id="184-定积分比大小奇偶性化简"><a href="#184-定积分比大小奇偶性化简" class="headerlink" title="184-定积分比大小奇偶性化简"></a>184-定积分比大小奇偶性化简</h3><p><img src="/img/gaoshu_practice_img/660_184.png"></p><h3 id="186-莱布尼茨公式注意事项"><a href="#186-莱布尼茨公式注意事项" class="headerlink" title="186-莱布尼茨公式注意事项"></a>186-莱布尼茨公式注意事项</h3><p><img src="/img/gaoshu_practice_img/660_186.png">、</p><h3 id="188-定积分计算"><a href="#188-定积分计算" class="headerlink" title="188-定积分计算"></a>188-定积分计算</h3><p><img src="/img/gaoshu_practice_img/660_188.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_188_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="199-原函数存在条件"><a href="#199-原函数存在条件" class="headerlink" title="199-原函数存在条件"></a>199-原函数存在条件</h3><p><img src="/img/gaoshu_practice_img/660_199.png"></p><h3 id="203-反常积分审敛"><a href="#203-反常积分审敛" class="headerlink" title="203-反常积分审敛"></a>203-反常积分审敛</h3><p><img src="/img/gaoshu_practice_img/660_203.png"></p><h3 id="208-平面曲线质心"><a href="#208-平面曲线质心" class="headerlink" title="208-平面曲线质心"></a>208-平面曲线质心</h3><p><img src="/img/gaoshu_practice_img/660_208.png"></p><p><img src="/img/gaoshu_practice_img/660_208_%E7%9F%A5%E8%AF%86%E7%82%B9.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_204.png"></p><h2 id="660-微分方程"><a href="#660-微分方程" class="headerlink" title="660(微分方程)"></a>660(微分方程)</h2><h3 id="76-一阶线性微分方程通解"><a href="#76-一阶线性微分方程通解" class="headerlink" title="76-一阶线性微分方程通解"></a>76-一阶线性微分方程通解</h3><p><img src="/img/gaoshu_practice_img/660_76.png"></p><h3 id="78-y-x2F-x型齐次方程"><a href="#78-y-x2F-x型齐次方程" class="headerlink" title="78-y&#x2F;x型齐次方程"></a>78-y&#x2F;x型齐次方程</h3><p><img src="/img/gaoshu_practice_img/660_78.png"></p><h3 id="79-自因变量互换"><a href="#79-自因变量互换" class="headerlink" title="79 -自因变量互换"></a>79 -自因变量互换</h3><p><img src="/img/gaoshu_practice_img/660_79.png"></p><h3 id="80-二阶降阶"><a href="#80-二阶降阶" class="headerlink" title="80-二阶降阶"></a>80-二阶降阶</h3><p><img src="/img/gaoshu_practice_img/660_80.png"></p><h3 id="81-常系数非齐次求特解"><a href="#81-常系数非齐次求特解" class="headerlink" title="81-常系数非齐次求特解"></a>81-常系数非齐次求特解</h3><p><img src="/img/gaoshu_practice_img/660_81.png"></p><p><strong>知识点</strong></p><p><img src="/img/gaoshu_practice_img/660_81_%E9%BD%90%E6%AC%A1%E6%96%B9%E7%A8%8B%E9%80%9A%E8%A7%A3.png" alt="齐次方程通解"></p><p><img src="/img/gaoshu_practice_img/660_81_%E9%9D%9E%E9%BD%90%E6%AC%A1%E6%96%B9%E7%A8%8B%E7%89%B9%E8%A7%A3.png" alt="非齐次方程特解"></p><h3 id="86-偏导化为普通导数"><a href="#86-偏导化为普通导数" class="headerlink" title="86-偏导化为普通导数"></a>86-偏导化为普通导数</h3><p><img src="/img/gaoshu_practice_img/660_86.png"></p><h3 id="90-复合函数求偏导"><a href="#90-复合函数求偏导" class="headerlink" title="90-复合函数求偏导"></a>90-复合函数求偏导</h3><p><img src="/img/gaoshu_practice_img/660_90.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_90_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="91-混合偏导"><a href="#91-混合偏导" class="headerlink" title="91-混合偏导"></a>91-混合偏导</h3><p><img src="/img/gaoshu_practice_img/660_91.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_91_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="92-链式求导"><a href="#92-链式求导" class="headerlink" title="92-链式求导"></a>92-链式求导</h3><p><img src="/img/gaoshu_practice_img/660_92.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_92_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="101-求全微分"><a href="#101-求全微分" class="headerlink" title="101-求全微分"></a>101-求全微分</h3><p><img src="/img/gaoshu_practice_img/660_101.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_101_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="104-多元函数求极值"><a href="#104-多元函数求极值" class="headerlink" title="104-多元函数求极值"></a>104-多元函数求极值</h3><p><img src="/img/gaoshu_practice_img/660_104.png"></p><h3 id="217-叠加原理"><a href="#217-叠加原理" class="headerlink" title="217-叠加原理"></a>217-叠加原理</h3><p><img src="/img/gaoshu_practice_img/660_217.png"></p><h3 id="223-伯努利方程"><a href="#223-伯努利方程" class="headerlink" title="223-伯努利方程"></a>223-伯努利方程</h3><p><img src="/img/gaoshu_practice_img/660_223.png"></p><h3 id="224-求全微分"><a href="#224-求全微分" class="headerlink" title="224-求全微分"></a>224-求全微分</h3><p><img src="/img/gaoshu_practice_img/660_224.png"></p><h3 id="225-欧拉方程"><a href="#225-欧拉方程" class="headerlink" title="225-欧拉方程"></a>225-欧拉方程</h3><p><img src="/img/gaoshu_practice_img/660_225.png"></p><p><strong>推导</strong></p><p><img src="/img/gaoshu_practice_img/660_225_%E6%8E%A8%E5%AF%BC.png"></p><h3 id="227-判断是否连续"><a href="#227-判断是否连续" class="headerlink" title="227-判断是否连续"></a>227-判断是否连续</h3><p><img src="/img/gaoshu_practice_img/660_227.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_227_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="243-二阶导数定义"><a href="#243-二阶导数定义" class="headerlink" title="243-二阶导数定义"></a>243-二阶导数定义</h3><p><img src="/img/gaoshu_practice_img/660_243.png"></p><h3 id="245-由条件求全微分"><a href="#245-由条件求全微分" class="headerlink" title="245-由条件求全微分"></a>245-由条件求全微分</h3><p><img src="/img/gaoshu_practice_img/660_245.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_245_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="248-多元函数判断极值点"><a href="#248-多元函数判断极值点" class="headerlink" title="248-多元函数判断极值点"></a>248-多元函数判断极值点</h3><p><img src="/img/gaoshu_practice_img/660_248.png"></p><h3 id="249-隐函数存在定理"><a href="#249-隐函数存在定理" class="headerlink" title="249-隐函数存在定理"></a>249-隐函数存在定理</h3><p><img src="/img/gaoshu_practice_img/660_249.png"></p><h3 id="251-闭区域求最值"><a href="#251-闭区域求最值" class="headerlink" title="251-闭区域求最值"></a>251-闭区域求最值</h3><p><img src="/img/gaoshu_practice_img/660_251.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_252.png"></p><h2 id="660-多重积分"><a href="#660-多重积分" class="headerlink" title="660(多重积分)"></a>660(多重积分)</h2><h3 id="106-直角交换积分次序"><a href="#106-直角交换积分次序" class="headerlink" title="106-直角交换积分次序"></a>106-直角交换积分次序</h3><p><img src="/img/gaoshu_practice_img/660_106.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_106_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png" alt="直角坐标转极坐标"></p><p><img src="/img/gaoshu_practice_img/660_106_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE2.png" alt="补充题目2"></p><h3 id="109-极坐标交换积分次序"><a href="#109-极坐标交换积分次序" class="headerlink" title="109-极坐标交换积分次序"></a>109-极坐标交换积分次序</h3><p><img src="/img/gaoshu_practice_img/660_109_%E6%B3%95%E4%B8%80.png" alt="法一"></p><p><img src="/img/gaoshu_practice_img/660_109_%E6%B3%95%E4%BA%8C.png" alt="法二"></p><p><strong>补充知识点</strong></p><p><img src="/img/gaoshu_practice_img/660_109_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B9.png"></p><h3 id="113-定积分定义"><a href="#113-定积分定义" class="headerlink" title="113-定积分定义"></a>113-定积分定义</h3><p><img src="/img/gaoshu_practice_img/660_113.png"></p><p><strong>补充知识点</strong></p><p><img src="/img/gaoshu_practice_img/660_113_%E8%A1%A5%E5%85%85%E7%9F%A5%E8%AF%86%E7%82%B9.png"></p><h3 id="114-平移换元"><a href="#114-平移换元" class="headerlink" title="114-平移换元"></a>114-平移换元</h3><p><img src="/img/gaoshu_practice_img/660_114.png"></p><h3 id="115-轮换对称性"><a href="#115-轮换对称性" class="headerlink" title="115-轮换对称性"></a>115-轮换对称性</h3><p><img src="/img/gaoshu_practice_img/660_115.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_115_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="116-偶倍奇零"><a href="#116-偶倍奇零" class="headerlink" title="116-偶倍奇零"></a>116-偶倍奇零</h3><p><img src="/img/gaoshu_practice_img/660_116.png"></p><h3 id="262-平移坐标轴"><a href="#262-平移坐标轴" class="headerlink" title="262-平移坐标轴"></a>262-平移坐标轴</h3><p><img src="/img/gaoshu_practice_img/660_262.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_262_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="269-区间在现"><a href="#269-区间在现" class="headerlink" title="269-区间在现"></a>269-区间在现</h3><p><img src="/img/gaoshu_practice_img/660_269.png"></p><h3 id="270-比较大小"><a href="#270-比较大小" class="headerlink" title="270-比较大小"></a>270-比较大小</h3><p><img src="/img/gaoshu_practice_img/660_270.png"></p><h3 id="272-轮换对称性"><a href="#272-轮换对称性" class="headerlink" title="272-轮换对称性"></a>272-轮换对称性</h3><p><img src="/img/gaoshu_practice_img/660_272.png"></p><h3 id="273-二重积分中值定理"><a href="#273-二重积分中值定理" class="headerlink" title="273-二重积分中值定理"></a>273-二重积分中值定理</h3><p><img src="/img/gaoshu_practice_img/660_273.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/660_273_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h1 id="严选题"><a href="#严选题" class="headerlink" title="严选题"></a>严选题</h1><h2 id="严选题（极限）"><a href="#严选题（极限）" class="headerlink" title="严选题（极限）"></a>严选题（极限）</h2><h3 id="7-极限和点的关系"><a href="#7-极限和点的关系" class="headerlink" title="7-极限和点的关系"></a>7-极限和点的关系</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_7.png"></p><h3 id="8-极限存在"><a href="#8-极限存在" class="headerlink" title="8-极限存在"></a>8-极限存在</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_8.png"></p><p><strong>补充题目</strong></p><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_8_%E8%A1%A5%E5%85%85.png"></p><h3 id="22-∞-∞型"><a href="#22-∞-∞型" class="headerlink" title="22-∞-∞型"></a>22-∞-∞型</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_22.png"></p><h3 id="23-1-∞型"><a href="#23-1-∞型" class="headerlink" title="23-1^∞型"></a>23-1^∞型</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_23.png"></p><h3 id="32-0-x2F-0型"><a href="#32-0-x2F-0型" class="headerlink" title="32-0&#x2F;0型"></a>32-0&#x2F;0型</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_32.png"></p><h3 id="34-∞-x2F-∞型"><a href="#34-∞-x2F-∞型" class="headerlink" title="34-∞&#x2F;∞型"></a>34-∞&#x2F;∞型</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_34.png"></p><h3 id="35-1-∞型"><a href="#35-1-∞型" class="headerlink" title="35-1^∞型"></a>35-1^∞型</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_35.png"></p><h3 id="37-综合题"><a href="#37-综合题" class="headerlink" title="37-综合题"></a>37-综合题</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_37.png"></p><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_37_%E8%A1%A5%E5%85%85.png" alt="用泰勒公式做"></p><h3 id="38-n项和的数列极限"><a href="#38-n项和的数列极限" class="headerlink" title="38-n项和的数列极限"></a>38-n项和的数列极限</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_38.png"></p><h3 id="40-数列夹逼和定积分共用"><a href="#40-数列夹逼和定积分共用" class="headerlink" title="40-数列夹逼和定积分共用"></a>40-数列夹逼和定积分共用</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_40.png"></p><h3 id="43-证明数列有极限"><a href="#43-证明数列有极限" class="headerlink" title="43-证明数列有极限"></a>43-证明数列有极限</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_43.png"></p><h3 id="44-数列地推关系"><a href="#44-数列地推关系" class="headerlink" title="44-数列地推关系"></a>44-数列地推关系</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_44.png"></p><h3 id="13-无穷小量的最高阶"><a href="#13-无穷小量的最高阶" class="headerlink" title="13-无穷小量的最高阶"></a>13-无穷小量的最高阶</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_13.png"></p><h3 id="29-无穷小求未知数"><a href="#29-无穷小求未知数" class="headerlink" title="29-无穷小求未知数"></a>29-无穷小求未知数</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_1_29.png"></p><h2 id="严选题（导数）"><a href="#严选题（导数）" class="headerlink" title="严选题（导数）"></a>严选题（导数）</h2><h3 id="1-可导的充分条件"><a href="#1-可导的充分条件" class="headerlink" title="1-可导的充分条件"></a>1-可导的充分条件</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_1.png"></p><h3 id="2-导数存在但不连续的例子"><a href="#2-导数存在但不连续的例子" class="headerlink" title="2-导数存在但不连续的例子"></a>2-导数存在但不连续的例子</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_2.png"></p><h3 id="7-找不可导点"><a href="#7-找不可导点" class="headerlink" title="7-找不可导点"></a>7-找不可导点</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_7.png"></p><h3 id="8-找不可导点"><a href="#8-找不可导点" class="headerlink" title="8-找不可导点"></a>8-找不可导点</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_8.png"></p><h3 id="29-换元"><a href="#29-换元" class="headerlink" title="29-换元"></a>29-换元</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_29.png"></p><h3 id="33-讨论导数连续性"><a href="#33-讨论导数连续性" class="headerlink" title="33-讨论导数连续性"></a>33-讨论导数连续性</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_33.png"></p><h3 id="16-求渐近线"><a href="#16-求渐近线" class="headerlink" title="16-求渐近线"></a>16-求渐近线</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_16.png"></p><h3 id="26-罗尔定理求零点个数"><a href="#26-罗尔定理求零点个数" class="headerlink" title="26-罗尔定理求零点个数"></a>26-罗尔定理求零点个数</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_26.png"></p><h3 id="35-二阶导判断极值点"><a href="#35-二阶导判断极值点" class="headerlink" title="35-二阶导判断极值点"></a>35-二阶导判断极值点</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_35.png"></p><h3 id="36-二阶导判断参数方程性质"><a href="#36-二阶导判断参数方程性质" class="headerlink" title="36-二阶导判断参数方程性质"></a>36-二阶导判断参数方程性质</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_36.png"></p><h3 id="28-单调区间求根数量"><a href="#28-单调区间求根数量" class="headerlink" title="28-单调区间求根数量"></a>28-单调区间求根数量</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_28.png"></p><h3 id="37-通过一阶导判断根数量"><a href="#37-通过一阶导判断根数量" class="headerlink" title="37-通过一阶导判断根数量"></a>37-通过一阶导判断根数量</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_37.png" alt="注意函数奇偶性可以简化计算"></p><h3 id="39-分离参数求根数量"><a href="#39-分离参数求根数量" class="headerlink" title="39-分离参数求根数量"></a>39-分离参数求根数量</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_39.png"></p><h3 id="40-两函数交点求根数量"><a href="#40-两函数交点求根数量" class="headerlink" title="40-两函数交点求根数量"></a>40-两函数交点求根数量</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_40.png"></p><h3 id="43-取对数证明不等式"><a href="#43-取对数证明不等式" class="headerlink" title="43-取对数证明不等式"></a>43-取对数证明不等式</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_2_43.png"></p><h2 id="严选题（积分）"><a href="#严选题（积分）" class="headerlink" title="严选题（积分）"></a>严选题（积分）</h2><h3 id="14-凑分母"><a href="#14-凑分母" class="headerlink" title="14-凑分母"></a>14-凑分母</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_14.png"></p><h3 id="10-缩放夹逼"><a href="#10-缩放夹逼" class="headerlink" title="10-缩放夹逼"></a>10-缩放夹逼</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_10.png"></p><h3 id="19-常见换元"><a href="#19-常见换元" class="headerlink" title="19-常见换元"></a>19-常见换元</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_19.png"></p><h3 id="21-积分的奇偶性"><a href="#21-积分的奇偶性" class="headerlink" title="21-积分的奇偶性"></a>21-积分的奇偶性</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_21.png"></p><h3 id="23-常见换元"><a href="#23-常见换元" class="headerlink" title="23-常见换元"></a>23-常见换元</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_23.png"></p><h3 id="24-两端积分"><a href="#24-两端积分" class="headerlink" title="24-两端积分"></a>24-两端积分</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_24.png"></p><h3 id="28-积分求极限"><a href="#28-积分求极限" class="headerlink" title="28-积分求极限"></a>28-积分求极限</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_28.png"></p><h3 id="44-缩放夹逼"><a href="#44-缩放夹逼" class="headerlink" title="44-缩放夹逼"></a>44-缩放夹逼</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_44.png"></p><h3 id="30-变上限积分"><a href="#30-变上限积分" class="headerlink" title="30-变上限积分"></a>30-变上限积分</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_30.png"></p><h3 id="37-变上限积分"><a href="#37-变上限积分" class="headerlink" title="37-变上限积分"></a>37-变上限积分</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_37.png"></p><h3 id="43-变上限夹逼缩放"><a href="#43-变上限夹逼缩放" class="headerlink" title="43-变上限夹逼缩放"></a>43-变上限夹逼缩放</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_43.png"></p><h3 id="46-罗尔定理"><a href="#46-罗尔定理" class="headerlink" title="46-罗尔定理"></a>46-罗尔定理</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_46.png"></p><h3 id="47-罗尔定理"><a href="#47-罗尔定理" class="headerlink" title="47-罗尔定理"></a>47-罗尔定理</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_47.png"></p><h3 id="48-找原函数-罗尔定理"><a href="#48-找原函数-罗尔定理" class="headerlink" title="48-找原函数 罗尔定理"></a>48-找原函数 罗尔定理</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_48.png"></p><h3 id="49-找原函数-罗尔定理"><a href="#49-找原函数-罗尔定理" class="headerlink" title="49-找原函数 罗尔定理"></a>49-找原函数 罗尔定理</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_49.png"></p><h3 id="50-积分中值定理"><a href="#50-积分中值定理" class="headerlink" title="50-积分中值定理"></a>50-积分中值定理</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_50.png"></p><h3 id="33-定积分应用-函数图像"><a href="#33-定积分应用-函数图像" class="headerlink" title="33-定积分应用 函数图像"></a>33-定积分应用 函数图像</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_33.png"></p><h3 id="55-做功"><a href="#55-做功" class="headerlink" title="55-做功"></a>55-做功</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_55.png"></p><h3 id="61-心形线"><a href="#61-心形线" class="headerlink" title="61-心形线"></a>61-心形线</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_3_61.png"></p><h2 id="严选题（微分方程）"><a href="#严选题（微分方程）" class="headerlink" title="严选题（微分方程）"></a>严选题（微分方程）</h2><h3 id="11-非齐次方程通解"><a href="#11-非齐次方程通解" class="headerlink" title="11-非齐次方程通解"></a>11-非齐次方程通解</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_4_11.png"></p><h3 id="14-非齐次方程通解"><a href="#14-非齐次方程通解" class="headerlink" title="14-非齐次方程通解"></a>14-非齐次方程通解</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_4_14.png"></p><h3 id="19-x2F-20-知特解求通解-x2F-颠倒x、y"><a href="#19-x2F-20-知特解求通解-x2F-颠倒x、y" class="headerlink" title="19&#x2F;20-知特解求通解&#x2F;颠倒x、y"></a>19&#x2F;20-知特解求通解&#x2F;颠倒x、y</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A5%E9%80%89%E9%A2%98_4_19.png"></p><h1 id="强化例题（极限-导数）"><a href="#强化例题（极限-导数）" class="headerlink" title="强化例题（极限 导数）"></a>强化例题（极限 导数）</h1><h2 id="强化例题（函数）"><a href="#强化例题（函数）" class="headerlink" title="强化例题（函数）"></a>强化例题（函数）</h2><h3 id="有界条件"><a href="#有界条件" class="headerlink" title="有界条件"></a>有界条件</h3><p>f(x)在(a, b)连续，f(a)、f(b)有定义</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%981.png"></p><h3 id="导数和有界的关系"><a href="#导数和有界的关系" class="headerlink" title="导数和有界的关系"></a>导数和有界的关系</h3><p>f’(x)在有限区间有界，f(x)也有界</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%982.png"></p><h3 id="导数和单调性的关系"><a href="#导数和单调性的关系" class="headerlink" title="导数和单调性的关系"></a>导数和单调性的关系</h3><p>一个点的导数值不能说明小区域内的单调性</p><p>而如果导数连续，则由保号性可知存在一个小区域是单调的</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%983.png"></p><h3 id="单调性"><a href="#单调性" class="headerlink" title="单调性"></a>单调性</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%984.png"></p><h2 id="强化例题（极限性质）"><a href="#强化例题（极限性质）" class="headerlink" title="强化例题（极限性质）"></a>强化例题（极限性质）</h2><h3 id="极限性质"><a href="#极限性质" class="headerlink" title="极限性质"></a>极限性质</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%981.png"></p><h3 id="数列极限"><a href="#数列极限" class="headerlink" title="数列极限"></a>数列极限</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%982.png"></p><h3 id="数列敛散"><a href="#数列敛散" class="headerlink" title="数列敛散"></a>数列敛散</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%983.png"></p><h3 id="数列极限性质"><a href="#数列极限性质" class="headerlink" title="数列极限性质"></a>数列极限性质</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%984.png"></p><h3 id="数列极限证明题"><a href="#数列极限证明题" class="headerlink" title="数列极限证明题"></a>数列极限证明题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%985.png"></p><h3 id="极限性质-1"><a href="#极限性质-1" class="headerlink" title="极限性质"></a>极限性质</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%986.png"></p><h2 id="强化例题（求极限方式）✨"><a href="#强化例题（求极限方式）✨" class="headerlink" title="强化例题（求极限方式）✨"></a>强化例题（求极限方式）✨</h2><h3 id="等价无穷小代换"><a href="#等价无穷小代换" class="headerlink" title="等价无穷小代换"></a>等价无穷小代换</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%981.png"></p><h3 id="泰勒展开"><a href="#泰勒展开" class="headerlink" title="泰勒展开"></a>泰勒展开</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%982.png"></p><p><strong>补充</strong></p><p><img src="/img/gaoshu_practice_img/%E5%B8%B8%E8%A7%81%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F.png"></p><h3 id="夹逼准则"><a href="#夹逼准则" class="headerlink" title="夹逼准则"></a>夹逼准则</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%983.png"></p><h3 id="定积分定义"><a href="#定积分定义" class="headerlink" title="定积分定义"></a>定积分定义</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%984.png"></p><h3 id="单调有界则有极限"><a href="#单调有界则有极限" class="headerlink" title="单调有界则有极限"></a>单调有界则有极限</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%985.png"></p><h2 id="强化例题（极限7种不定式）✨"><a href="#强化例题（极限7种不定式）✨" class="headerlink" title="强化例题（极限7种不定式）✨"></a>强化例题（极限7种不定式）✨</h2><h3 id="0-x2F-0型"><a href="#0-x2F-0型" class="headerlink" title="0&#x2F;0型"></a>0&#x2F;0型</h3><p><strong>常用方法</strong>：</p><ol><li>洛必达</li><li>等价无穷小代换</li><li>泰勒公式</li></ol><p>化简常用方法：</p><ol><li>非零因子带入</li><li>有理化</li><li>变量代换</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%986.png" alt="有理化"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%987.png" alt="非0因子代入"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%988.png" alt="变量代换"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%989.png" alt="带积分的变量代换"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9810.png" alt="变量代换"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9811.png" alt="泰勒公式"></p><h3 id="∞-x2F-∞型"><a href="#∞-x2F-∞型" class="headerlink" title="∞&#x2F;∞型"></a>∞&#x2F;∞型</h3><p><strong>常用方法</strong>：</p><ol><li>洛必达</li><li>分子分母同除以分子和分母各项中最高阶的无穷大</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9812.png" alt="分子分母同除以分子和分母各项中最高阶的无穷大"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9813.png" alt="分子分母同除以分子和分母各项中最高阶的无穷大"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9814.png" alt="分子分母同除以分子和分母各项中最高阶的无穷大"></p><h3 id="∞-∞型"><a href="#∞-∞型" class="headerlink" title="∞ - ∞型"></a>∞ - ∞型</h3><p><strong>常用方法</strong></p><ol><li>分式差：通分为0&#x2F;0</li><li>根式差：根式有理化</li><li>提无穷因子，然后等价代换或变量代换、泰勒公式</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9815.png" alt="分式差"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9816.png" alt="根式差"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9817.png" alt="提无穷因子"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9818.png" alt="分式差"></p><h3 id="0-∞型"><a href="#0-∞型" class="headerlink" title="0 * ∞型"></a>0 * ∞型</h3><p><strong>常用方法</strong></p><ol><li>化为0&#x2F;0或∞&#x2F;∞</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9819.png"></p><h3 id="1-∞型"><a href="#1-∞型" class="headerlink" title="1^∞型"></a>1^∞型</h3><p><strong>常用方法</strong></p><p><img src="/img/gaoshu_practice_img/1%E7%9A%84%E6%97%A0%E7%A9%B7%E6%AC%A1%E6%96%B9%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9820.png" alt="三种方法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9821.png" alt="凑标准型"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9822.png" alt="凑标准型"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9823.png" alt="凑标准型"></p><h3 id="0-0型和∞-0型"><a href="#0-0型和∞-0型" class="headerlink" title="0^0型和∞^0型"></a>0^0型和∞^0型</h3><p><strong>常用方法</strong></p><ol><li>取对数</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9824.png" alt="取对数"></p><h3 id="确认极限中参数"><a href="#确认极限中参数" class="headerlink" title="确认极限中参数"></a>确认极限中参数</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9825.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9826.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%B1%82%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%9827.png"></p><h2 id="强化例题（数列极限）"><a href="#强化例题（数列极限）" class="headerlink" title="强化例题（数列极限）"></a>强化例题（数列极限）</h2><h3 id="不定式"><a href="#不定式" class="headerlink" title="不定式"></a>不定式</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%981.png" alt="要化成函数才能洛必达"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%982.png"></p><h3 id="n项和的数列极限"><a href="#n项和的数列极限" class="headerlink" title="n项和的数列极限"></a>n项和的数列极限</h3><p>常用方法</p><ol><li>夹逼原理（变化部分是主体的次量级）</li><li>定积分定义（变化部分是主体的同量级）</li><li>级数求和</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%983.png" alt="夹逼原理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%984.png" alt="定积分定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%985.png" alt="前两种方法综合"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%986.png" alt="出现累加+不定式情况时要统一"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%987.png" alt="结论"></p><h3 id="n项乘的数列极限"><a href="#n项乘的数列极限" class="headerlink" title="n项乘的数列极限"></a>n项乘的数列极限</h3><p>常用方法</p><ol><li>夹逼定理</li><li>取对数化为和的形式</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%988.png" alt="夹逼"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%95%B0%E5%88%97%E6%9E%81%E9%99%90%E4%BE%8B%E9%A2%989.png" alt="取对数化为和"></p><h3 id="递推关系（难点）"><a href="#递推关系（难点）" class="headerlink" title="递推关系（难点）"></a>递推关系（难点）</h3><p>常用方法</p><ol><li>证数列收敛（单调有界），然后求极限</li><li>先令极限为A，然后等式两端取极限解得A，最后证明极限为A</li></ol><p>单调性判定常用方法</p><ol><li><p>Xn+1 - Xn</p></li><li><p>同号时，Xn+1 &#x2F; Xn</p></li><li><p>X1 &#x3D; a，Xn+1 &#x3D; f(Xn)</p><p> f(x)单调增，则x1&lt;&#x3D;x2时，数列单调增</p><p> f(x)单调增，则x1&gt;&#x3D;x2时，数列单调减</p></li><li><p>f(x)单调减，数列不单调</p></li></ol><h2 id="强化例题（无穷小量的比较）"><a href="#强化例题（无穷小量的比较）" class="headerlink" title="强化例题（无穷小量的比较）"></a>强化例题（无穷小量的比较）</h2><p>比较两个无穷小的常用方法</p><ol><li>洛必达</li><li>等价无穷小代换</li><li>泰勒公式</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E5%B0%8F%E6%AF%94%E8%BE%83%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E5%B0%8F%E6%AF%94%E8%BE%83%E4%BE%8B%E9%A2%982.png" alt="估计无穷小的阶数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E5%B0%8F%E6%AF%94%E8%BE%83%E4%BE%8B%E9%A2%983.png" alt="泰勒公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E5%B0%8F%E6%AF%94%E8%BE%83%E4%BE%8B%E9%A2%984.png" alt="等价无穷小"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E5%B0%8F%E6%AF%94%E8%BE%83%E4%BE%8B%E9%A2%985.png" alt="泰勒公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E5%B0%8F%E6%AF%94%E8%BE%83%E4%BE%8B%E9%A2%986.png" alt="无穷小比较"></p><h2 id="强化例题（连续）"><a href="#强化例题（连续）" class="headerlink" title="强化例题（连续）"></a>强化例题（连续）</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><strong>连续</strong>：极限值等于这个点函数的值</p><p><strong>左（右）连续</strong>：左（右）极限等于函数值</p><p><strong>定理</strong>：f(x)连续 &lt;&#x3D;&#x3D;&gt; f(x)左连续且右连续</p><p><strong>间断点</strong>：f(x)在x0某<strong>去心邻域</strong>有定义，但在x0处不连续，则x0为间断点</p><p><strong>间断点分类</strong>：</p><ol><li><p>第一类间断点：左右极限均存在</p><p> 可去间断点：左右极限相等</p><p> 跳跃间断点：左右极限不等</p></li><li><p>第二类间断点：左右极限至少有一个不存在</p><p> 无穷间断点</p><p> 振荡间断点</p></li></ol><p><strong>零点定理</strong>：f(x)在[a, bn]上连续，且f(a)f(b)&lt;0，则存在一点∈(a, b)使f&#x3D;0</p><h3 id="讨论连续性及间断点类型"><a href="#讨论连续性及间断点类型" class="headerlink" title="讨论连续性及间断点类型"></a>讨论连续性及间断点类型</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%983.png" alt="找间断点"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%984.png" alt="找间断点"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%986.png" alt="函数是以极限形式给出的情况"></p><h3 id="介值定理、最值定理和零点定理的证明题"><a href="#介值定理、最值定理和零点定理的证明题" class="headerlink" title="介值定理、最值定理和零点定理的证明题"></a>介值定理、最值定理和零点定理的证明题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%987.png" alt="介值定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%988.png" alt="零点定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E8%BF%9E%E7%BB%AD%E6%80%A7%E4%BE%8B%E9%A2%989.png" alt="保号性和零点定理"></p><h2 id="强化例题（导数）"><a href="#强化例题（导数）" class="headerlink" title="强化例题（导数）"></a>强化例题（导数）</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p><strong>导数</strong>：</p><p><img src="/img/gaoshu_practice_img/%E5%AF%BC%E6%95%B0%E5%AE%9A%E7%90%86.png"></p><p>可导 &lt;&#x3D;&#x3D;&gt; 左右导数存在且相等</p><p><strong>微分</strong>：</p><p><img src="/img/gaoshu_practice_img/%E5%BE%AE%E5%88%86%E5%AE%9A%E7%90%86.png"></p><p>几何意义：</p><ol><li>导数：切线斜率</li><li>微分：切线上的增量</li></ol><p><img src="/img/gaoshu_practice_img/%E5%AF%BC%E6%95%B0%E5%92%8C%E5%BE%AE%E5%88%86%E7%9A%84%E5%87%A0%E4%BD%95%E6%84%8F%E4%B9%89.png"></p><p>f(x)n阶可导 &#x3D;&#x3D;&gt; 洛必达能用到n-1次导数</p><p>f(x)n阶连续且可导 &#x3D;&#x3D;&gt; 洛必达能用到n次导数</p><h3 id="导数定义求极限"><a href="#导数定义求极限" class="headerlink" title="导数定义求极限"></a>导数定义求极限</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%981.png" alt="凑导数定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%982.png" alt="凑导数定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%983.png" alt="凑导数定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%984.png" alt="凑导数定义"></p><h3 id="导数定义求导数"><a href="#导数定义求导数" class="headerlink" title="导数定义求导数"></a>导数定义求导数</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%986.png" alt="分段函数间断点一般用定义做"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%987.png" alt="分段函数间断点一般用定义做"></p><h3 id="导数定义判断可导性✨"><a href="#导数定义判断可导性✨" class="headerlink" title="导数定义判断可导性✨"></a>导数定义判断可导性✨</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%989.png" alt="难题,有结论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%9810.png" alt="有结论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%9811.png" alt="用上一题结论做"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%9812.png" alt="上一题的补充题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%9813.png" alt="原函数可导和绝对值的关系"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%9814.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E4%BE%8B%E9%A2%9815.png"></p><h3 id="导数几何意义"><a href="#导数几何意义" class="headerlink" title="导数几何意义"></a>导数几何意义</h3><p>重点在求dy&#x2F;dx</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%981.png" alt="求切线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%982.png" alt="参数方程求法线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%983.png" alt="极坐标求切线法线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%984.png" alt="极坐标求切线法线"></p><h3 id="求导计算✨"><a href="#求导计算✨" class="headerlink" title="求导计算✨"></a>求导计算✨</h3><p><strong>复合函数求导</strong></p><p>重点在链式求导</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%981.png" alt="导数奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%982.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%983.png" alt="分段函数求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%984.png" alt="分段函数求导"></p><p><strong>隐函数求导</strong></p><p>重点在左右分别求导</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%985.png" alt="左右分别求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%986.png" alt="简化计算"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%987.png" alt="左右分别求导"></p><p><strong>参数方程求导</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%988.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%989.png" alt="隐函数就套公式"></p><p><strong>反函数求导</strong></p><p>函数和反函数的导数互为倒数</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%9810.png"></p><p><strong>对数求导</strong></p><p>适用于幂指函数，连乘，连除，开方，乘方</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%9811.png"></p><p><strong>高阶导数</strong></p><p>常用方法</p><ol><li>归纳</li><li>泰勒公式</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%9812.png" alt="归纳法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%9813.png" alt="归纳法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%9814.png" alt="套公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%9815.png" alt="套公式"></p><h2 id="强化例题（导数应用）"><a href="#强化例题（导数应用）" class="headerlink" title="强化例题（导数应用）"></a>强化例题（导数应用）</h2><h3 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h3><p><strong>四个微分中值定理</strong>：</p><p><img src="/img/gaoshu_practice_img/%E5%BE%AE%E5%88%86%E4%B8%AD%E5%80%BC%E5%AE%9A%E7%90%86.png"></p><p><strong>找极值</strong>：在驻点和不可导点上找</p><p><strong>找最值</strong>：在驻点、不可导点和端点上找</p><p><strong>极值的充分条件</strong>：</p><p><img src="/img/gaoshu_practice_img/%E6%9E%81%E5%80%BC%E7%9A%84%E5%85%85%E5%88%86%E6%9D%A1%E4%BB%B6.png"></p><p><strong>找凹凸区间</strong>：二阶导 &gt; 0，凹；二阶导 &lt; 0，凸；</p><p><strong>找拐点</strong>：凹凸性相反的点（x0, f(x0)）</p><p>判断点左右两边二阶导的正负，</p><p>不好判断则看三阶导是否等于0</p><p>或判断第一个不为0的高阶导，奇为拐点</p><p><strong>渐近线</strong>：</p><p><img src="/img/gaoshu_practice_img/%E6%B8%90%E8%BF%91%E7%BA%BF.png"></p><p><strong>曲率</strong>：</p><p><img src="/img/gaoshu_practice_img/%E6%9B%B2%E7%8E%87.png"></p><h3 id="函数单调性、极值、最值"><a href="#函数单调性、极值、最值" class="headerlink" title="函数单调性、极值、最值"></a>函数单调性、极值、最值</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%981.png" alt="列表格求单调区间和极值"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%982.png" alt="二阶导求极值"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%985.png"></p><h3 id="凹点、拐点、渐近线及曲率"><a href="#凹点、拐点、渐近线及曲率" class="headerlink" title="凹点、拐点、渐近线及曲率"></a>凹点、拐点、渐近线及曲率</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%986.png" alt="高阶导判断拐点"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%987.png" alt="综合"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%988.png" alt="渐近线计算"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%989.png" alt="找斜渐近线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9810.png" alt="曲率圆"></p><h3 id="方程根的数量"><a href="#方程根的数量" class="headerlink" title="方程根的数量"></a>方程根的数量</h3><p>罗尔定理推论：n阶导不等于0，则f(x) &#x3D; 0<strong>最多</strong>有n个实根</p><p><img src="/img/gaoshu_practice_img/%E7%BD%97%E5%B0%94%E5%AE%9A%E7%90%86%E6%8E%A8%E8%AE%BA%E8%AF%81%E6%98%8E.png" alt="罗尔定理推论证明"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9811.png" alt="设原函数求方程的根"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9812.png" alt="用单调区间求根"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9813.png" alt="罗尔定理推论求根"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9814.png" alt="分离参数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9815.png" alt="分离参数和画函数草图"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9816.png" alt="罗尔定理推论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9817.png" alt="零点定理做"></p><h3 id="证明不等式"><a href="#证明不等式" class="headerlink" title="证明不等式"></a>证明不等式</h3><p><strong>常用方法</strong></p><ol><li>单调性</li><li>最大最小值</li><li>拉格朗日中值定理</li><li>泰勒公式</li><li>凹凸性</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9818.png" alt="单调性证明不等式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9819.png" alt="设函数后单调性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9820.png" alt="设函数后单调性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9821.png" alt="泰勒展开"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9822.png" alt="构造辅助函数"></p><h2 id="强化例题（微分中值定理证明题）✨"><a href="#强化例题（微分中值定理证明题）✨" class="headerlink" title="强化例题（微分中值定理证明题）✨"></a>强化例题（微分中值定理证明题）✨</h2><h3 id="证明存在一点使得F-x-f-x-f’-x-x3D-0"><a href="#证明存在一点使得F-x-f-x-f’-x-x3D-0" class="headerlink" title="证明存在一点使得F(x, f(x), f’(x)) &#x3D; 0"></a>证明存在一点使得F(x, f(x), f’(x)) &#x3D; 0</h3><p><strong>构造辅助函数常用方法</strong></p><ol><li>分析法：分析找出原方程</li><li>微分方程法：求出通解H(x, y) &#x3D; C，设辅助函数g(x) &#x3D; H(x, f(x))</li><li><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9825.png" alt="常见方程构造辅助函数的结论"></li></ol><blockquote><p>构造辅助函数的过程不用写</p></blockquote><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9823.png" alt="分析法和微分方程法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9824.png" alt="微分方程法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9826.png" alt="用结论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9827.png" alt="零点定理和罗尔定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9828.png" alt="结合奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9829.png" alt="罗尔定理推论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9830.png" alt="积分中值定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9831.png" alt="用结论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9832.png" alt="不存在点要单独设出来"></p><h3 id="证明存在两点使得F-x-y-f-x-f’-x-f-y-f’-y-x3D-0"><a href="#证明存在两点使得F-x-y-f-x-f’-x-f-y-f’-y-x3D-0" class="headerlink" title="证明存在两点使得F(x, y, f(x), f’(x), f(y), f’(y)) &#x3D; 0"></a>证明存在两点使得F(x, y, f(x), f’(x), f(y), f’(y)) &#x3D; 0</h3><blockquote><p>注意双中值类型是两个未知数都在<strong>导数</strong>里</p></blockquote><p><strong>常用方法</strong>：</p><ol><li><p>没说x ≠ y的情况</p><p> 用两次中值定理（拉氏、柯西）</p></li><li><p>说了x ≠ y的情况</p><p> 分为两个子区间，分别用拉氏中值定理</p><p> 定两个子区间时一般用到逆推法</p></li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9833.png" alt="没说x ≠ y的情况"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9834.png" alt="没说x ≠ y的情况"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9835.png" alt="没说x ≠ y的情况 和第一种题型的结合"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9836.png" alt="说了x ≠ y的情况"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9837.png" alt="逆推法"></p><h3 id="证明存在一个点使F-x-f-n-x-gt-x3D-0-n-gt-x3D-2"><a href="#证明存在一个点使F-x-f-n-x-gt-x3D-0-n-gt-x3D-2" class="headerlink" title="证明存在一个点使F(x, f^n(x)) &gt;&#x3D; 0 (n&gt;&#x3D;2)"></a>证明存在一个点使F(x, f^n(x)) &gt;&#x3D; 0 (n&gt;&#x3D;2)</h3><p>（<strong>难点，比较玄学</strong>）</p><p><strong>常用方法</strong></p><ol><li>用带<strong>拉格朗日余项</strong>的泰勒公式，在题目中提供信息多的点展开</li></ol><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9838.png" alt="两个点知道的信息一样多 都要展开"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9839.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AF%BC%E6%95%B0%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%9840.png"></p><h1 id="强化例题（积分）"><a href="#强化例题（积分）" class="headerlink" title="强化例题（积分）"></a>强化例题（积分）</h1><h2 id="强化例题（不定积分）"><a href="#强化例题（不定积分）" class="headerlink" title="强化例题（不定积分）"></a>强化例题（不定积分）</h2><h3 id="概念-3"><a href="#概念-3" class="headerlink" title="概念"></a>概念</h3><p>原函数存在性：</p><ol><li>f(x)在区间I上<strong>连续</strong>，则在区间I上必有原函数</li><li>在区间I上有第一类间断点（可取、跳跃），则在区间I上没有原函数</li></ol><p>基本积分公式：</p><p><img src="/img/gaoshu_practice_img/%E5%9F%BA%E6%9C%AC%E7%A7%AF%E5%88%86%E5%85%AC%E5%BC%8F.png"></p><p><strong>三种主要积分法</strong>：</p><p><img src="/img/gaoshu_practice_img/%E4%B8%89%E7%A7%8D%E4%B8%BB%E8%A6%81%E7%A7%AF%E5%88%86%E6%B3%95.png"></p><p><strong>三类常见可积函数积分</strong>：</p><p><img src="/img/gaoshu_practice_img/%E4%B8%89%E7%B1%BB%E5%B8%B8%E8%A7%81%E5%8F%AF%E7%A7%AF%E5%87%BD%E6%95%B0%E7%A7%AF%E5%88%86.png"></p><h3 id="不定积分例题"><a href="#不定积分例题" class="headerlink" title="不定积分例题"></a>不定积分例题</h3><p>例题比较杂，不好分类</p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%987.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%8D%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%989.png"></p><h2 id="强化例题（定积分）"><a href="#强化例题（定积分）" class="headerlink" title="强化例题（定积分）"></a>强化例题（定积分）</h2><h3 id="定积分性质"><a href="#定积分性质" class="headerlink" title="定积分性质"></a>定积分性质</h3><p><img src="/img/gaoshu_practice_img/%E5%AE%9A%E7%A7%AF%E5%88%86%E6%80%A7%E8%B4%A8.png"></p><p><img src="/img/gaoshu_practice_img/%E5%88%A9%E7%94%A8%E5%85%AC%E5%BC%8F%E7%AE%97%E5%AE%9A%E7%A7%AF%E5%88%86.png" alt="常利用的公式"></p><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png" alt="变上限求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png" alt="积分中值定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%983.png" alt="定积分定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%984.png" alt="定积分定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%985.png" alt="缩放"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%986.png" alt="奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%987.png" alt="周期性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%988.png" alt="利用公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%989.png" alt="周期性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9810.png" alt="变上限和分部积分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9811.png" alt="变限积分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9812.png" alt="题型"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9813.png" alt="区间不变"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9814.png" alt="分离变量"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9815.png"></p><h2 id="强化例题（变上限积分）"><a href="#强化例题（变上限积分）" class="headerlink" title="强化例题（变上限积分）"></a>强化例题（变上限积分）</h2><h3 id="考点"><a href="#考点" class="headerlink" title="考点"></a>考点</h3><p><strong>连续性</strong></p><p>若f(x)在[a, b]上可积，则∫(x, a) f(t) dt 在[a, b]上连续</p><p><strong>可导性</strong></p><p><img src="/img/gaoshu_practice_img/%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E5%8F%AF%E5%AF%BC%E6%80%A7.png"></p><p><strong>奇偶性</strong></p><p><img src="/img/gaoshu_practice_img/%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E5%A5%87%E5%81%B6%E6%80%A7.png"></p><h3 id="例题-1"><a href="#例题-1" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png" alt="连续性和奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png" alt="连续性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%983.png" alt="奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%985.png" alt="积分中值定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%986.png" alt="用图像做"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%987.png" alt="反函数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%98%E4%B8%8A%E9%99%90%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%988.png"></p><h2 id="强化例题（积分不等式）"><a href="#强化例题（积分不等式）" class="headerlink" title="强化例题（积分不等式）"></a>强化例题（积分不等式）</h2><p><strong>常用方法</strong>：</p><ol><li><p>定积分不等式</p></li><li><p>变量代换</p></li><li><p>积分中值定理</p></li><li><p>变上限积分</p></li><li><p>柯西积分不等式</p><p> <img src="/img/gaoshu_practice_img/%E6%9F%AF%E8%A5%BF%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F.png" alt="柯西积分不等式"></p></li></ol><h3 id="例题-2"><a href="#例题-2" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F%E4%BE%8B%E9%A2%981.png" alt="常见不等式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F%E4%BE%8B%E9%A2%982.png" alt="积分中值定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F%E4%BE%8B%E9%A2%983.png" alt="通过设函数做"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F%E4%BE%8B%E9%A2%984.png" alt="通过设函数做"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F%E4%BE%8B%E9%A2%985.png" alt="导数与原函数连接的桥梁"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A7%AF%E5%88%86%E4%B8%8D%E7%AD%89%E5%BC%8F%E4%BE%8B%E9%A2%986.png" alt="柯西积分不等式"></p><h2 id="强化例题（反常积分）"><a href="#强化例题（反常积分）" class="headerlink" title="强化例题（反常积分）"></a>强化例题（反常积分）</h2><h3 id="考点-1"><a href="#考点-1" class="headerlink" title="考点"></a>考点</h3><p><strong>无穷区间上的反常积分</strong></p><p><img src="/img/gaoshu_practice_img/%E6%97%A0%E7%A9%B7%E5%8C%BA%E9%97%B4%E4%B8%8A%E7%9A%84%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E8%A7%A3%E6%B3%95.png"></p><p><strong>无界函数的反常积分</strong></p><p><img src="/img/gaoshu_practice_img/%E6%97%A0%E7%95%8C%E5%87%BD%E6%95%B0%E7%9A%84%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E8%A7%A3%E6%B3%95.png"></p><p><strong>伽马函数</strong></p><p><img src="/img/gaoshu_practice_img/%E4%BC%BD%E9%A9%AC%E5%87%BD%E6%95%B0.png"></p><h3 id="例题-3"><a href="#例题-3" class="headerlink" title="例题"></a>例题</h3><p><strong>判断敛散性</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png" alt="判断敛散"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png" alt="知敛散定参数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%983.png" alt="同敛散"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%984.png" alt="结论"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%985.png" alt="知敛散定参数"></p><p><strong>反常积分计算</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%986.png" alt="分部积分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%987.png" alt="换元"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%988.png"></p><h2 id="强化例题（定积分应用）"><a href="#强化例题（定积分应用）" class="headerlink" title="强化例题（定积分应用）"></a>强化例题（定积分应用）</h2><h3 id="例题-4"><a href="#例题-4" class="headerlink" title="例题"></a>例题</h3><p><strong>几何应用</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%982.png" alt="计算"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%983.png" alt="旋转体体积"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%984.png" alt="极坐标"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%985.png" alt="星形线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%986.png" alt="常见形状"></p><p><strong>物理应用</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%987.png" alt="压强"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%AE%9A%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%988.png" alt="做功"></p><h1 id="强化例题（常微分方程）"><a href="#强化例题（常微分方程）" class="headerlink" title="强化例题（常微分方程）"></a>强化例题（常微分方程）</h1><h2 id="强化例题（一阶微分方程）"><a href="#强化例题（一阶微分方程）" class="headerlink" title="强化例题（一阶微分方程）"></a>强化例题（一阶微分方程）</h2><h3 id="常见题型"><a href="#常见题型" class="headerlink" title="常见题型"></a>常见题型</h3><p><strong>可分离变量方程</strong></p><p>形式：y’ &#x3D; f(x)g(y)</p><p>解法：分离变量，两端积分。g(y)dy &#x3D; f(x)dx</p><p><strong>齐次方程</strong></p><p>形式：dy &#x2F; dx &#x3D; φ(y&#x2F;x)</p><p>解法：令u &#x3D; y&#x2F;x，y’ &#x3D; u + xu’，从而化为可分离变量</p><p><strong>一阶线性方程</strong></p><p>形式：y’ + P(x)y &#x3D; Q(x)</p><p>解法：套公式</p><p><img src="/img/gaoshu_practice_img/%E4%B8%80%E9%98%B6%E7%BA%BF%E6%80%A7%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E8%A7%A3%E6%B3%95.png"></p><p><strong>伯努利方程</strong></p><p>形式：y’ + P(x)y &#x3D;Q(x)<strong>y^n</strong></p><p>解法：令u &#x3D; y^(1 - n)化为一阶线性方程</p><p><strong>全微分方程</strong></p><p>形式：du(x, y) &#x3D; P(x, y)dx + Q(x, y)dy</p><blockquote><p>不是上面的题型，则可尝试x、y对调或变量代换</p></blockquote><h3 id="例题-5"><a href="#例题-5" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%981.png" alt="可分离变量"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%982.png" alt="齐次方程"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%983.png" alt="xy对调"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%984.png" alt="变量代换"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%986.png"></p><h2 id="强化例题（可降阶的高阶方程）"><a href="#强化例题（可降阶的高阶方程）" class="headerlink" title="强化例题（可降阶的高阶方程）"></a>强化例题（可降阶的高阶方程）</h2><h3 id="常见题型-1"><a href="#常见题型-1" class="headerlink" title="常见题型"></a>常见题型</h3><p>y’’ &#x3D; f(x)：两边求积分</p><p>y’’ &#x3D; f(x, y’)：y’ &#x3D; p, y’’ &#x3D; dp &#x2F; dx</p><p>y’’ &#x3D; f(y, y’)：y’ &#x3D; p, y’’ &#x3D; p (dp&#x2F;dy)</p><h3 id="例题-6"><a href="#例题-6" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%987.png" alt="可降阶不含y"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%988.png" alt="可降阶不含x"></p><h2 id="强化例题（高阶线性方程）"><a href="#强化例题（高阶线性方程）" class="headerlink" title="强化例题（高阶线性方程）"></a>强化例题（高阶线性方程）</h2><h3 id="常见题型-2"><a href="#常见题型-2" class="headerlink" title="常见题型"></a>常见题型</h3><p><strong>线性微分方程的解的结构</strong></p><p>齐次方程：y’’ + p(x)y’ + q(x)y &#x3D; 0</p><p>非齐次方程：y’’ + p(x)y’ + q(x)y &#x3D; f(x)</p><p>两个线性无关特解C1 y1(x) + C2 y2(x) &#x3D; y 为齐次通解</p><p>C1y1(x) + C2y2(x) + y*(x) &#x3D; y 为非齐次通解</p><p>两个非齐次特解y1*(x) - y2 *(x) &#x3D; y(x) 为齐次的解</p><p><strong>常系数齐次线性微分方程通解</strong></p><p><img src="/img/gaoshu_practice_img/%E5%B8%B8%E7%B3%BB%E6%95%B0%E9%BD%90%E6%AC%A1%E7%BA%BF%E6%80%A7%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E9%80%9A%E8%A7%A3.png"></p><p><strong>常系数非齐次线性微分方程特解</strong></p><p><img src="/img/gaoshu_practice_img/%E5%B8%B8%E7%B3%BB%E6%95%B0%E9%9D%9E%E9%BD%90%E6%AC%A1%E7%BA%BF%E6%80%A7%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E7%89%B9%E8%A7%A3.png"></p><p><strong>欧拉方程</strong></p><p><img src="/img/gaoshu_practice_img/%E6%AC%A7%E6%8B%89%E6%96%B9%E7%A8%8B.png"></p><h3 id="例题-7"><a href="#例题-7" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%989.png" alt="特解形式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9810.png" alt="特解形式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9811.png" alt="非常系数特解"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9812.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9813.png"></p><h2 id="强化例题（综合题）"><a href="#强化例题（综合题）" class="headerlink" title="强化例题（综合题）"></a>强化例题（综合题）</h2><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9814.png" alt="换元两边求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9815.png" alt="拆开"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9816.png" alt="换元"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9817.png" alt="导数定义"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9818.png" alt="反函数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9819.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9820.png" alt="几何应用题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9821.png" alt="几何应用题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9822.png" alt="几何应用题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B8%B8%E5%BE%AE%E5%88%86%E6%96%B9%E7%A8%8B%E4%BE%8B%E9%A2%9823.png" alt="物理应用题"></p><h1 id="强化例题（多元函数微分）"><a href="#强化例题（多元函数微分）" class="headerlink" title="强化例题（多元函数微分）"></a>强化例题（多元函数微分）</h1><h2 id="强化例题（概念理论）"><a href="#强化例题（概念理论）" class="headerlink" title="强化例题（概念理论）"></a>强化例题（概念理论）</h2><h3 id="考点-2"><a href="#考点-2" class="headerlink" title="考点"></a>考点</h3><p><strong>重积分</strong></p><p>定义：</p><p>点(x, y)在区域D内以<strong>任意方式</strong>趋近于(x0, y0)时，函数趋近于常数A，否则极限不存在</p><p><img src="/img/gaoshu_practice_img/%E9%87%8D%E7%A7%AF%E5%88%86.png"></p><p><strong>连续性</strong></p><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E8%BF%9E%E7%BB%AD%E6%80%A7.png"></p><p><strong>偏导数</strong></p><p>定义：</p><p><img src="/img/gaoshu_practice_img/%E5%81%8F%E5%AF%BC%E6%95%B0%E5%AE%9A%E4%B9%89.png"></p><p><strong>全微分</strong></p><p>定义：</p><p><img src="/img/gaoshu_practice_img/%E5%85%A8%E5%BE%AE%E5%88%86%E5%AE%9A%E4%B9%89.png"></p><p>判断是否可微：</p><p><img src="/img/gaoshu_practice_img/%E5%85%A8%E5%BE%AE%E5%88%86%E5%88%A4%E6%96%AD.png"></p><p>连续、可导、可微的关系：</p><p><img src="/img/gaoshu_practice_img/%E8%BF%9E%E7%BB%AD%E5%8F%AF%E5%AF%BC%E5%8F%AF%E5%BE%AE%E7%9A%84%E5%85%B3%E7%B3%BB.png"></p><h3 id="例题-8"><a href="#例题-8" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%981.png" alt="重极限计算"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%982.png" alt="判断极限是否存在"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%983.png" alt="判断是否连续"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%984.png" alt="偏导计算"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%985.png" alt="偏导存在判断"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%986.png" alt="综合"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%987.png" alt="连续偏导微分关系"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%988.png" alt="可微条件"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%989.png" alt="可微条件"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9810.png" alt="可微的等价命题"></p><blockquote><p><img src="/img/gaoshu_practice_img/%E5%8F%AF%E5%BE%AE%E7%9A%84%E7%AD%89%E4%BB%B7%E5%91%BD%E9%A2%98.png"></p></blockquote><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9811.png" alt="可微和偏导定义"></p><h2 id="强化例题（计算）"><a href="#强化例题（计算）" class="headerlink" title="强化例题（计算）"></a>强化例题（计算）</h2><h3 id="考点-3"><a href="#考点-3" class="headerlink" title="考点"></a>考点</h3><p><strong>链式求导法</strong></p><p><img src="/img/gaoshu_practice_img/%E9%93%BE%E5%BC%8F%E6%B1%82%E5%AF%BC%E6%B3%95.png"></p><p><strong>全微分形式不变性</strong></p><p><img src="/img/gaoshu_practice_img/%E5%85%A8%E5%BE%AE%E5%88%86%E5%BD%A2%E5%BC%8F%E4%B8%8D%E5%8F%98%E6%80%A7.png"></p><p><strong>隐函数求导法</strong></p><p><img src="/img/gaoshu_practice_img/%E9%9A%90%E5%87%BD%E6%95%B0%E6%B1%82%E5%AF%BC%E6%B3%95.png" alt="一个方程所确定的隐函数"></p><p><img src="/img/gaoshu_practice_img/%E9%9A%90%E5%87%BD%E6%95%B0%E6%B1%82%E5%AF%BC%E6%B3%952.png" alt="由方程组所确定的隐函数"></p><p><strong>例题</strong></p><p><strong>求一点处的偏导数和全微分</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9812.png" alt="分界点求偏导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9813.png" alt="先带后导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9814.png" alt="全微分"></p><p><strong>求给出具体函数的偏导数和全微分</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9815.png" alt="求偏导和全微分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9816.png" alt="求偏导和全微分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9817.png" alt="偏积分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9818.png" alt="偏积分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9819.png" alt="全微分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9820.png" alt="全微分"></p><p><strong>含有抽象函数的复合函数的偏导数和全微分</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9821.png" alt="求全微分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9822.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9823.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9824.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9825.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9826.png" alt="链式求导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9827.png" alt="链式求导"></p><p><strong>隐函数的偏导数和全微分</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9828.png" alt="隐函数求导公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9829.png" alt="隐函数求导公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9830.png" alt="隐函数求全微分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9831.png" alt="全微分不变性 上一题也可用"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9832.png" alt="全微分不变性"></p><h2 id="强化例题（极值最值）"><a href="#强化例题（极值最值）" class="headerlink" title="强化例题（极值最值）"></a>强化例题（极值最值）</h2><h3 id="考点-4"><a href="#考点-4" class="headerlink" title="考点"></a>考点</h3><p><strong>无条件极值</strong></p><p><img src="/img/gaoshu_practice_img/%E5%88%A4%E6%96%AD%E6%9E%81%E5%80%BC%E6%96%B9%E6%B3%95.png"></p><p><strong>条件极值</strong></p><p><img src="/img/gaoshu_practice_img/%E6%8B%89%E6%A0%BC%E6%9C%97%E6%97%A5%E4%B9%98%E6%95%B0%E6%B3%95.png"></p><p><strong>最值</strong></p><p>找最值方法：</p><ol><li>找出区域D内部可能的极值点</li><li>找出区域D边界上可能的极值点</li><li>比较</li></ol><h3 id="例题-9"><a href="#例题-9" class="headerlink" title="例题"></a>例题</h3><p><strong>无条件极值</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9833.png" alt="判断极值点"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9834.png" alt="判断极值点 含未知数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9835.png" alt="判断极值点 隐函数"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9836.png" alt="判断极值点 先代后导"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9837.png" alt="保号性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9838.png" alt="保号性"></p><p><strong>最大最小值</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9839.png" alt="有条件极值 直接代入"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9840.png" alt="拉格朗日乘数法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9841.png" alt="拉格朗日乘数法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9842.png" alt="拉格朗日乘数法"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9843.png" alt="应用题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E4%BE%8B%E9%A2%9844.png" alt="应用题"></p><h1 id="强化例题（二重积分）"><a href="#强化例题（二重积分）" class="headerlink" title="强化例题（二重积分）"></a>强化例题（二重积分）</h1><h2 id="例题-10"><a href="#例题-10" class="headerlink" title="例题"></a>例题</h2><p><strong>二重积分计算</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png" alt="奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png" alt="对称性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%983.png" alt="对称性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%984.png" alt="对称性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%987.png" alt="移坐标轴"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%989.png" alt="摆线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9810.png" alt="全平面"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9811.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9812.png" alt="xy全部做对调 值不变"></p><p><strong>交换积分次序</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9813.png" alt="交换积分次序"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9814.png" alt="极坐标交换积分次序"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9815.png" alt="交换积分次序 重定图像"></p><p><strong>综合题</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9816.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9817.png" alt="结合积分中值定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9818.png" alt="结合积分中值定理"></p><p><strong>不等式问题</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9819.png" alt="比大小"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9820.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9821.png"></p><h1 id="强化例题（无穷级数）"><a href="#强化例题（无穷级数）" class="headerlink" title="强化例题（无穷级数）"></a>强化例题（无穷级数）</h1><h2 id="概念-4"><a href="#概念-4" class="headerlink" title="概念"></a>概念</h2><p><img src="/img/gaoshu_practice_img/%E7%BA%A7%E6%95%B0%E6%A6%82%E5%BF%B5%E5%92%8C%E6%80%A7%E8%B4%A8.png"></p><h2 id="级数审敛法✨"><a href="#级数审敛法✨" class="headerlink" title="级数审敛法✨"></a>级数审敛法✨</h2><p><strong>正项级数的判别法</strong></p><blockquote><p>正项级数：每项都 &gt; 0</p></blockquote><ol><li><p>比较判别法</p><p> 大的收敛，小的必收敛；小的发散，大的必发散。</p></li><li><p>比较法极限形式</p><p> <img src="/img/gaoshu_practice_img/%E6%AF%94%E8%BE%83%E6%B3%95%E6%9E%81%E9%99%90%E5%BD%A2%E5%BC%8F.png"></p></li><li><p>比值法</p><p> <img src="/img/gaoshu_practice_img/%E7%BA%A7%E6%95%B0%E6%AF%94%E5%80%BC%E6%B3%95.png"></p></li><li><p>根值法</p><p> <img src="/img/gaoshu_practice_img/%E7%BA%A7%E6%95%B0%E6%A0%B9%E5%80%BC%E6%B3%95.png"></p></li><li><p>积分判别法</p><p> 少部分题好用</p><p> <img src="/img/gaoshu_practice_img/%E7%A7%AF%E5%88%86%E5%88%A4%E5%88%AB%E6%B3%95.png"></p></li></ol><p><strong>交错级数的判别法</strong></p><blockquote><p>交错级数：每项正负交替</p></blockquote><ol><li><p>莱布尼兹准则</p><p> <img src="/img/gaoshu_practice_img/%E8%8E%B1%E5%B8%83%E5%B0%BC%E5%85%B9%E5%87%86%E5%88%99.png"></p></li></ol><p><strong>任意项级数</strong></p><blockquote><p>任意项级数：每项为任意实数</p></blockquote><blockquote><p>绝对收敛：加了绝对值收敛，则原函数必收敛</p><p>条件收敛：原级数收敛，<strong>但加了绝对值发散</strong></p><p><strong>绝对收敛的条件要求更高</strong></p></blockquote><p>条件收敛的级数的所有正项（负项）构成的级数一定发散</p><h2 id="例题-11"><a href="#例题-11" class="headerlink" title="例题"></a>例题</h2><p><strong>正项级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%984.png"></p><p><strong>交错级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%986.png"></p><p><strong>任意项级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%987.png" alt="缩放 等价无穷小"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%989.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9810.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9811.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9812.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9813.png"></p><p><strong>综合题</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9814.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9815.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9816.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E6%97%A0%E7%A9%B7%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%9817.png" alt="结合泰勒"></p><h1 id="强化例题（幂级数）"><a href="#强化例题（幂级数）" class="headerlink" title="强化例题（幂级数）"></a>强化例题（幂级数）</h1><h2 id="概念-5"><a href="#概念-5" class="headerlink" title="概念"></a>概念</h2><p><strong>幂级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%B9%82%E7%BA%A7%E6%95%B0.png"></p><p><strong>阿贝尔定理</strong></p><p><img src="/img/gaoshu_practice_img/%E9%98%BF%E8%B4%9D%E5%B0%94%E5%AE%9A%E7%90%86.png"></p><p><strong>收敛半径、收敛区间和收敛域</strong></p><p><img src="/img/gaoshu_practice_img/%E6%94%B6%E6%95%9B%E5%8D%8A%E5%BE%84.png"></p><p><strong>幂级数性质</strong></p><p><img src="/img/gaoshu_practice_img/%E5%B9%82%E7%BA%A7%E6%95%B0%E6%9C%89%E7%90%86%E8%BF%90%E7%AE%97.png" alt="幂级数有理运算"></p><p><img src="/img/gaoshu_practice_img/%E5%B9%82%E7%BA%A7%E6%95%B0%E7%9A%84%E5%92%8C%E5%87%BD%E6%95%B0%E6%80%A7%E8%B4%A8.png" alt="幂级数的和函数性质"></p><h2 id="函数的幂函数展开"><a href="#函数的幂函数展开" class="headerlink" title="函数的幂函数展开"></a>函数的幂函数展开</h2><p>将函数在收敛半径内展开为幂函数</p><p><img src="/img/gaoshu_practice_img/%E5%B9%82%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E5%AE%9A%E7%90%86.png" alt="幂函数展开定理"></p><p><img src="/img/gaoshu_practice_img/%E5%B8%B8%E8%A7%81%E5%B9%82%E5%87%BD%E6%95%B0%E5%B1%95%E5%BC%80%E5%BC%8F.png" alt="常见幂函数展开式"></p><p>幂函数展开方法：</p><ol><li>直接法：求出各阶导数，泰勒级数，再判断余项是否为0</li><li>间接展开法：向已有的展开式的形式靠近</li></ol><h2 id="例题-12"><a href="#例题-12" class="headerlink" title="例题"></a>例题</h2><p><strong>求收敛区域和收敛域</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%983.png" alt="阿贝尔定理"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%984.png"></p><p><strong>函数展开为幂级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%987.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%B9%82%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%989.png"></p><p><strong>级数求和</strong></p><h1 id="强化例题（傅里叶级数）"><a href="#强化例题（傅里叶级数）" class="headerlink" title="强化例题（傅里叶级数）"></a>强化例题（傅里叶级数）</h1><h2 id="概念-6"><a href="#概念-6" class="headerlink" title="概念"></a>概念</h2><p><strong>傅里叶系数和傅里叶级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%82%85%E9%87%8C%E5%8F%B6%E7%B3%BB%E6%95%B0%E5%92%8C%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0.png"></p><p><strong>收敛定理</strong></p><p><img src="/img/gaoshu_practice_img/%E7%8B%84%E5%88%A9%E5%85%8B%E9%9B%B7%E5%AE%9A%E7%90%86.png"></p><p><strong>周期为2π的函数展开为傅里叶级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E5%B1%95%E5%BC%801.png"></p><p><strong>周期为2l的函数展开为傅里叶级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E5%B1%95%E5%BC%802.png"></p><h2 id="例题-13"><a href="#例题-13" class="headerlink" title="例题"></a>例题</h2><p><strong>收敛定理</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%982.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%985.png" alt="真题"></p><p><strong>函数展开为傅里叶级数</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%986.png" alt="真题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%82%85%E9%87%8C%E5%8F%B6%E7%BA%A7%E6%95%B0%E4%BE%8B%E9%A2%987.png"></p><h1 id="强化例题（空间几何）"><a href="#强化例题（空间几何）" class="headerlink" title="强化例题（空间几何）"></a>强化例题（空间几何）</h1><h2 id="概念-7"><a href="#概念-7" class="headerlink" title="概念"></a>概念</h2><h3 id="向量代数"><a href="#向量代数" class="headerlink" title="向量代数"></a>向量代数</h3><p><strong>数量积</strong></p><p>a ・ｂ &#x3D; |a| |b| cosθ</p><p>a ・ｂ &#x3D; axbx +ayby + azbz</p><p>判定两向量垂直：a ・ｂ &#x3D; 0</p><p><strong>向量积</strong></p><p>|a x b| &#x3D; |a| |b| sinθ</p><p>判定两向量<strong>平行</strong>：a x b &#x3D; 0</p><p><strong>混合积</strong></p><p>(abc) &#x3D; (a x b)・c</p><p>几何上表示六面体体积</p><p>判定三向量共面：(abc) &#x3D; 0</p><p><strong>轮换对称性</strong>：(abc) &#x3D; (bca) &#x3D; (cab)</p><p><strong>交换变号</strong>：(abc) &#x3D; -(acb)</p><h3 id="空间直线和平面"><a href="#空间直线和平面" class="headerlink" title="空间直线和平面"></a>空间直线和平面</h3><p><img src="/img/gaoshu_practice_img/%E5%B9%B3%E9%9D%A2%E4%B8%8E%E7%9B%B4%E7%BA%BF%E7%9A%84%E6%96%B9%E7%A8%8B.png"></p><h3 id="曲面与空间曲线"><a href="#曲面与空间曲线" class="headerlink" title="曲面与空间曲线"></a>曲面与空间曲线</h3><p><img src="/img/gaoshu_practice_img/%E6%9B%B2%E7%BA%BF%E4%B8%8E%E7%A9%BA%E9%97%B4%E6%9B%B2%E7%BA%BF.png"></p><h3 id="多元函数微分在几何上的应用"><a href="#多元函数微分在几何上的应用" class="headerlink" title="多元函数微分在几何上的应用"></a>多元函数微分在几何上的应用</h3><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E5%87%BD%E6%95%B0%E5%BE%AE%E5%88%86%E5%9C%A8%E5%87%A0%E4%BD%95%E4%B8%8A%E7%9A%84%E5%BA%94%E7%94%A8.png"></p><h3 id="方向导数和梯度"><a href="#方向导数和梯度" class="headerlink" title="方向导数和梯度"></a>方向导数和梯度</h3><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E6%96%B9%E5%90%91%E5%AF%BC%E6%95%B0%E5%92%8C%E6%A2%AF%E5%BA%A6.png"></p><h2 id="例题-14"><a href="#例题-14" class="headerlink" title="例题"></a>例题</h2><h3 id="向量代数-1"><a href="#向量代数-1" class="headerlink" title="向量代数"></a>向量代数</h3><p><strong>向量运算</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%982.png"></p><p><strong>向量运算的应用</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%984.png"></p><h3 id="空间直线和平面-1"><a href="#空间直线和平面-1" class="headerlink" title="空间直线和平面"></a>空间直线和平面</h3><p>重点在直线的方向向量和平面的法向量</p><p><strong>建立直线方程</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%986.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%989.png" alt="直线间距离"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9810.png"></p><p><strong>建立平面方程</strong></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%987.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%988.png"></p><h3 id="曲面与空间曲线-1"><a href="#曲面与空间曲线-1" class="headerlink" title="曲面与空间曲线"></a>曲面与空间曲线</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9811.png" alt="柱面方程"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9812.png" alt="建立旋转面方程"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9813.png" alt="建立旋转面方程"></p><h3 id="多元函数微分在几何上的应用-1"><a href="#多元函数微分在几何上的应用-1" class="headerlink" title="多元函数微分在几何上的应用"></a>多元函数微分在几何上的应用</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9814.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9815.png" alt="真题"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9816.png" alt="建立空间曲线的切线和法平面"></p><h3 id="方向导数和梯度-1"><a href="#方向导数和梯度-1" class="headerlink" title="方向导数和梯度"></a>方向导数和梯度</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9817.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9818.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9819.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E7%A9%BA%E9%97%B4%E5%87%A0%E4%BD%95%E4%BE%8B%E9%A2%9820.png" alt="结合条件极值"></p><h1 id="强化例题（多元函数积分）"><a href="#强化例题（多元函数积分）" class="headerlink" title="强化例题（多元函数积分）"></a>强化例题（多元函数积分）</h1><h2 id="概念-8"><a href="#概念-8" class="headerlink" title="概念"></a>概念</h2><h3 id="三重积分-1"><a href="#三重积分-1" class="headerlink" title="三重积分"></a>三重积分</h3><p><strong>三种坐标轴</strong></p><ol><li><p>直角坐标</p></li><li><p>柱面坐标</p><p> <img src="/img/gaoshu_practice_img/%E6%9F%B1%E9%9D%A2%E5%9D%90%E6%A0%87.png"></p></li><li><p>球坐标</p><p> <img src="/img/gaoshu_practice_img/%E7%90%83%E5%9D%90%E6%A0%87.png"></p></li></ol><h3 id="对弧长的线积分（第一类积分）"><a href="#对弧长的线积分（第一类积分）" class="headerlink" title="对弧长的线积分（第一类积分）"></a>对弧长的线积分（第一类积分）</h3><p>求弧的质量，与积分路径无关</p><p><strong>计算方式</strong></p><p><img src="/img/gaoshu_practice_img/%E5%AF%B9%E5%BC%A7%E9%95%BF%E7%9A%84%E7%BA%BF%E7%A7%AF%E5%88%86.png"></p><h3 id="对坐标的线积分（第二类积分）"><a href="#对坐标的线积分（第二类积分）" class="headerlink" title="对坐标的线积分（第二类积分）"></a>对坐标的线积分（第二类积分）</h3><p>求变力在弧线上做功，与积分路径有关</p><p><strong>计算方法</strong></p><p><img src="/img/gaoshu_practice_img/%E5%AF%B9%E5%9D%90%E6%A0%87%E7%9A%84%E7%BA%BF%E7%A7%AF%E5%88%86.png" alt="平面上"></p><p><img src="/img/gaoshu_practice_img/%E5%AF%B9%E5%9D%90%E6%A0%87%E7%9A%84%E7%BA%BF%E7%A7%AF%E5%88%862.png" alt="空间上"></p><p><strong>线积分与路径无关的判定</strong></p><p><img src="/img/gaoshu_practice_img/%E7%BA%BF%E7%A7%AF%E5%88%86%E4%B8%8E%E8%B7%AF%E5%BE%84%E6%97%A0%E5%85%B3%E7%9A%84%E5%88%A4%E5%AE%9A.png"></p><h3 id="对面积的面积分（第一类面积分）"><a href="#对面积的面积分（第一类面积分）" class="headerlink" title="对面积的面积分（第一类面积分）"></a>对面积的面积分（第一类面积分）</h3><p>值与积分曲面的方向无关</p><p>计算：</p><ol><li><p>直接法</p><p> <img src="/img/gaoshu_practice_img/%E5%AF%B9%E9%9D%A2%E7%A7%AF%E7%9A%84%E9%9D%A2%E7%A7%AF%E5%88%86.png"></p></li><li><p>奇偶性</p></li><li><p>对称性</p></li></ol><h3 id="对坐标的面积分（第二类面积分）"><a href="#对坐标的面积分（第二类面积分）" class="headerlink" title="对坐标的面积分（第二类面积分）"></a>对坐标的面积分（第二类面积分）</h3><p>值与积分曲面的方向有关</p><p>计算：</p><ol><li><p>直接法</p><p> <img src="/img/gaoshu_practice_img/%E5%AF%B9%E5%9D%90%E6%A0%87%E7%9A%84%E9%9D%A2%E7%A7%AF%E5%88%86.png"></p></li><li><p>高斯公式</p><p> <img src="/img/gaoshu_practice_img/%E9%AB%98%E6%96%AF%E5%85%AC%E5%BC%8F.png"></p></li><li><p>补面用高斯公式</p></li></ol><h3 id="两类面积分的联系"><a href="#两类面积分的联系" class="headerlink" title="两类面积分的联系"></a>两类面积分的联系</h3><p><img src="/img/gaoshu_practice_img/%E4%B8%A4%E7%B1%BB%E9%9D%A2%E7%A7%AF%E5%88%86%E7%9A%84%E8%81%94%E7%B3%BB.png"></p><h2 id="例题-15"><a href="#例题-15" class="headerlink" title="例题"></a>例题</h2><h3 id="三重积分计算"><a href="#三重积分计算" class="headerlink" title="三重积分计算"></a>三重积分计算</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png" alt="上一题的法二"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%983.png" alt="变量对称性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%984.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%985.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%986.png" alt="球坐标"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%987.png" alt="圆柱坐标"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%988.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%989.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9810.png"></p><h3 id="对弧长的线积分计算（第一类）"><a href="#对弧长的线积分计算（第一类）" class="headerlink" title="对弧长的线积分计算（第一类）"></a>对弧长的线积分计算（第一类）</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9811.png" alt="奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9812.png" alt="奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9813.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9814.png"></p><h3 id="对坐标的线积分计算（第二类）"><a href="#对坐标的线积分计算（第二类）" class="headerlink" title="对坐标的线积分计算（第二类）"></a>对坐标的线积分计算（第二类）</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9815.png" alt="改换路径"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9816.png" alt="格林公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9817.png" alt="补线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9818.png" alt="有奇异点"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9819.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9820.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9821.png" alt="补线"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9822.png" alt="格林公式"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9823.png" alt="化为平面线积分"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9824.png" alt="化为平面线积分"></p><h3 id="对面积的面积分计算（第一类）"><a href="#对面积的面积分计算（第一类）" class="headerlink" title="对面积的面积分计算（第一类）"></a>对面积的面积分计算（第一类）</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9825.png" alt="两类面积分互相转化"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9826.png" alt="对称性 奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9827.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9828.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9829.png" alt="奇偶性 对称性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9830.png"></p><h3 id="对坐标的面积分计算（第二类）"><a href="#对坐标的面积分计算（第二类）" class="headerlink" title="对坐标的面积分计算（第二类）"></a>对坐标的面积分计算（第二类）</h3><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9831.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9832.png" alt="补面高斯 重点"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9833.png" alt="高斯 奇偶性"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9834.png" alt="高斯 挖洞"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%9835.png" alt="一二类积分互相转换"></p><h1 id="强化例题（多元积分应用）"><a href="#强化例题（多元积分应用）" class="headerlink" title="强化例题（多元积分应用）"></a>强化例题（多元积分应用）</h1><h2 id="考点-5"><a href="#考点-5" class="headerlink" title="考点"></a>考点</h2><p><img src="/img/gaoshu_practice_img/%E5%A4%9A%E5%85%83%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8.png"></p><p><img src="/img/gaoshu_practice_img/%E5%9C%BA%E8%AE%BA.png"></p><h2 id="例题-16"><a href="#例题-16" class="headerlink" title="例题"></a>例题</h2><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%981.png" alt="算体积"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%982.png" alt="算体积"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%983.png"></p><p><img src="/img/gaoshu_practice_img/%E5%BC%BA%E5%8C%96%E5%A4%9A%E5%85%83%E7%A7%AF%E5%88%86%E5%BA%94%E7%94%A8%E4%BE%8B%E9%A2%984.png" alt="转动惯量"></p><p><img src="/img/gaoshu_practice_img/%E5%9C%BA%E8%AE%BA%E4%BE%8B%E9%A2%98.png" alt="场论相关题会带公式就行"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线代题目</title>
    <link href="/2024/07/16/%E8%80%83%E7%A0%94/%E7%BA%BF%E4%BB%A3%E9%A2%98%E7%9B%AE/"/>
    <url>/2024/07/16/%E8%80%83%E7%A0%94/%E7%BA%BF%E4%BB%A3%E9%A2%98%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="线代题目"><a href="#线代题目" class="headerlink" title="线代题目"></a>线代题目</h1><h2 id="660"><a href="#660" class="headerlink" title="660"></a>660</h2><h3 id="354"><a href="#354" class="headerlink" title="354"></a>354</h3><p><img src="/img/xiandai_practice_img/660_354.png"></p><p><strong>补充结论</strong></p><p><img src="/img/xiandai_practice_img/660_354_%E8%A1%A5%E5%85%85%E7%BB%93%E8%AE%BA.png"></p><h3 id="357"><a href="#357" class="headerlink" title="357"></a>357</h3><p><img src="/img/xiandai_practice_img/660_357.png"></p><p><strong>补充题目</strong></p><p><img src="/img/xiandai_practice_img/660_357_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="分块矩阵常见结论"><a href="#分块矩阵常见结论" class="headerlink" title="分块矩阵常见结论"></a>分块矩阵常见结论</h3><p><img src="/img/xiandai_practice_img/%E5%88%86%E5%9D%97%E7%9F%A9%E9%98%B5%E5%B8%B8%E8%A7%81%E7%BB%93%E8%AE%BA.png"></p><h3 id="370-特征值重数"><a href="#370-特征值重数" class="headerlink" title="370-特征值重数"></a>370-特征值重数</h3><p><img src="/img/xiandai_practice_img/660_370.png"></p><p><strong>补充题目</strong></p><p><img src="/img/xiandai_practice_img/660_370_%E8%A1%A5%E5%85%85%E9%A2%98%E7%9B%AE.png"></p><h3 id="408"><a href="#408" class="headerlink" title="408"></a>408</h3><p><img src="/img/xiandai_practice_img/660_408.png"></p><h3 id="411"><a href="#411" class="headerlink" title="411"></a>411</h3><p><img src="/img/xiandai_practice_img/660_411.png"></p><h3 id="412"><a href="#412" class="headerlink" title="412"></a>412</h3><p><img src="/img/xiandai_practice_img/660_412.png"></p><h3 id="413-特征向量性质"><a href="#413-特征向量性质" class="headerlink" title="413-特征向量性质"></a>413-特征向量性质</h3><p><img src="/img/xiandai_practice_img/660_413.png"></p><h3 id="414-相似对角化"><a href="#414-相似对角化" class="headerlink" title="414-相似对角化"></a>414-相似对角化</h3><p><img src="/img/xiandai_practice_img/660_414.png"></p><h3 id="417-相似"><a href="#417-相似" class="headerlink" title="417-相似"></a>417-相似</h3><p><img src="/img/xiandai_practice_img/660_417.png"></p><h3 id="419"><a href="#419" class="headerlink" title="419"></a>419</h3><p><img src="/img/xiandai_practice_img/660_419.png"></p><h3 id="421-规范型"><a href="#421-规范型" class="headerlink" title="421-规范型"></a>421-规范型</h3><p><img src="/img/xiandai_practice_img/660_421.png"></p><h3 id="422"><a href="#422" class="headerlink" title="422"></a>422</h3><p><img src="/img/xiandai_practice_img/660_422.png"></p><h3 id="423-正定矩阵"><a href="#423-正定矩阵" class="headerlink" title="423-正定矩阵"></a>423-正定矩阵</h3><p><img src="/img/xiandai_practice_img/660_423.png"></p><h3 id="425-合同矩阵"><a href="#425-合同矩阵" class="headerlink" title="425-合同矩阵"></a>425-合同矩阵</h3><p><img src="/img/xiandai_practice_img/660_425.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>概率论基础</title>
    <link href="/2024/06/16/%E8%80%83%E7%A0%94/%E6%A6%82%E7%8E%87%E8%AE%BA%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/06/16/%E8%80%83%E7%A0%94/%E6%A6%82%E7%8E%87%E8%AE%BA%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="概率论基础"><a href="#概率论基础" class="headerlink" title="概率论基础"></a>概率论基础</h1><h2 id="事件和概率"><a href="#事件和概率" class="headerlink" title="事件和概率"></a>事件和概率</h2><blockquote><p>事件可以算出概率，概率推不出事件</p></blockquote><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><strong>样本空间</strong>：随机试验的所有可能结果组成的集合</p><p><strong>样本点</strong>：随机试验的每个结果</p><p><strong>随机事件</strong>：包含若干样本点的集合，某个样本点的出现叫做事件发生</p><p><strong>排列和组合</strong>：</p><p><img src="/img/gailvlun_img/%E6%8E%92%E5%88%97%E5%92%8C%E7%BB%84%E5%90%88.png"></p><h3 id="古典概型"><a href="#古典概型" class="headerlink" title="古典概型"></a>古典概型</h3><ol><li>样本空间只包含有限个样本点</li><li>每个样本点发生的概率相同</li></ol><p>P(A) &#x3D; A中包含的基础事件数量 &#x2F; 基础事件的总数</p><p><strong>例题</strong></p><p>注意点：</p><ol><li>分类讨论用加法、分步进行用乘法</li><li>有些问题用1减去对立事件发生的概率更好做</li></ol><p><img src="/img/gailvlun_img/%E5%8F%A4%E5%85%B8%E6%A6%82%E5%9E%8B%E4%BE%8B%E9%A2%981.png" alt="古典概型例题1"></p><p><img src="/img/gailvlun_img/%E5%8F%A4%E5%85%B8%E6%A6%82%E5%9E%8B%E4%BE%8B%E9%A2%982.png" alt="古典概型例题2"></p><p>实际推断原理：概率很小的事件再一次实验中几乎不发生，如果在一次实验中发生了，有理由怀疑假设的正确性</p><h3 id="几何概型"><a href="#几何概型" class="headerlink" title="几何概型"></a>几何概型</h3><ol><li>样本空间只包含<strong>无限个</strong>样本点</li><li>每个样本点发生的概率都是“相同的”，为0</li></ol><p>P(A) &#x3D; A的测度（长度、体积、面积） &#x2F; 总的测度</p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E5%87%A0%E4%BD%95%E6%A6%82%E5%9E%8B%E4%BE%8B%E9%A2%981.png" alt="几何概型例题1"></p><h3 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h3><p><img src="/img/gailvlun_img/%E4%BA%8B%E4%BB%B61.png" alt="加奇减偶"></p><p><img src="/img/gailvlun_img/%E4%BA%8B%E4%BB%B62.png" alt="差事件"></p><p><img src="/img/gailvlun_img/%E8%BF%90%E7%AE%97%E5%BE%8B.png" alt="运算律"></p><p>互斥关系：没有交集，AB &#x3D; ∅，P(AB) &#x3D; 0</p><p>对立关系：AB &#x3D; ∅，A∪B &#x3D; Ω</p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8B%E4%BB%B6%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/%E4%BA%8B%E4%BB%B6%E4%BE%8B%E9%A2%982.png" alt="差事件例题"></p><h3 id="条件概率"><a href="#条件概率" class="headerlink" title="条件概率"></a>条件概率</h3><p>P(B|A) &#x3D; P(AB) &#x2F; P(A)，在事件A发生的条件下事件B发生的概率</p><p><strong>乘法公式</strong>：P(AB) &#x3D; P(B|A)P(A)</p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E6%9D%A1%E4%BB%B6%E6%A6%82%E7%8E%87%E4%BE%8B%E9%A2%981.png"></p><h3 id="全概率公式和贝叶斯公式"><a href="#全概率公式和贝叶斯公式" class="headerlink" title="全概率公式和贝叶斯公式"></a>全概率公式和贝叶斯公式</h3><p><strong>全概率公式</strong>：</p><p>A发生的概率等于在各种条件下A发生的概率之和</p><p>P(A) &#x3D; P(AB1) + P(AB2) + P(AB3) + … + P(ABn)</p><p>&#x3D; P(A | B1)P(B1) + P(A | B2)P(B2) + P(A | B3)P(B3) + … + P(A | Bn)P(Bn)</p><p><strong>贝叶斯公式</strong>：</p><p>在A发生的条件下，是某个条件的概率</p><p>P(Bi | A) &#x3D; P(A | Bi)P(Bi) &#x2F; P(A)</p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E5%85%A8%E6%A6%82%E7%8E%87%E5%85%AC%E5%BC%8F%E5%92%8C%E8%B4%9D%E5%8F%B6%E6%96%AF%E5%85%AC%E5%BC%8F%E4%BE%8B%E9%A2%981.png"></p><h3 id="独立性"><a href="#独立性" class="headerlink" title="独立性"></a>独立性</h3><p>A、B事件相互独立，</p><p>则 P(B|A) &#x3D; P(AB) &#x2F; P(A) &#x3D; P(B)</p><p>∴ <strong>P(AB) &#x3D; P(A)P(B)</strong></p><p>因此，一个事件的发生与否不改变另一个事件发生的概率</p><p><strong>注意</strong>：</p><ul><li>只要不影响概率就是相互独立的，两件事不一定毫无关系</li><li>P(A)&gt;0，P(B)&gt;0，如果A、B互斥，那么A发生B就不发生，A、B<strong>不</strong>相互独立</li><li>A包含B，则A、B不相互独立</li><li>用P(AB) &#x3D; P(A)P(B)判断独立性，不要凭感觉</li><li>三个事件相互独立，则两两也独立</li></ul><blockquote><p><img src="/img/gailvlun_img/%E7%8B%AC%E7%AB%8B%E6%80%A7%E4%BE%8B%E5%AD%90.png" alt="例子"></p></blockquote><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E7%8B%AC%E7%AB%8B%E6%80%A7%E4%BE%8B%E9%A2%981.png" alt="例题1"></p><p><img src="/img/gailvlun_img/%E7%8B%AC%E7%AB%8B%E6%80%A7%E4%BE%8B%E9%A2%982.png" alt="例题2"></p><h2 id="一维随机变量及其分布"><a href="#一维随机变量及其分布" class="headerlink" title="一维随机变量及其分布"></a>一维随机变量及其分布</h2><h3 id="随机变量"><a href="#随机变量" class="headerlink" title="随机变量"></a>随机变量</h3><p>随机试验结果数值化</p><p><strong>分类</strong>：</p><ol><li>离散型</li><li>连续性</li><li>混合型</li></ol><h3 id="离散型随机变量"><a href="#离散型随机变量" class="headerlink" title="离散型随机变量"></a>离散型随机变量</h3><p><strong>常见离散型分布</strong></p><ol><li><p>(0-1)分布</p><p> X~B(1, 概率)</p><p> <img src="/img/gailvlun_img/01%E5%88%86%E5%B8%83.png"></p></li><li><p>二项分布</p><p> X~B(重复次数, 概率)</p><p> <img src="/img/gailvlun_img/%E4%BA%8C%E9%A1%B9%E5%88%86%E5%B8%83.png"></p></li><li><p>几何分布</p><p> X~G(概率)</p><p> <img src="/img/gailvlun_img/%E5%87%A0%E4%BD%95%E5%88%86%E5%B8%83.png"></p></li><li><p>负二项分布</p><p> <img src="/img/gailvlun_img/%E8%B4%9F%E4%BA%8C%E9%A1%B9%E5%88%86%E5%B8%83.png"></p></li></ol><blockquote><p>几何级数公式推导↓</p><p><img src="/img/gailvlun_img/%E5%87%A0%E4%BD%95%E7%BA%A7%E6%95%B0.png"></p></blockquote><ol start="5"><li><p>泊松分布</p><p> k可以看成粒子流在单位时间内通过的粒子个数，只能是整数</p><p> X~π(λ)</p><p> <img src="/img/gailvlun_img/%E6%B3%8A%E6%9D%BE%E5%88%86%E5%B8%83.png"></p></li></ol><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E9%A1%B9%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="二项分布例题1"></p><p><img src="/img/gailvlun_img/%E5%87%A0%E4%BD%95%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="几何分布例题1"></p><p><img src="/img/gailvlun_img/%E6%B3%8A%E6%9D%BE%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="泊松分布例题1"></p><h3 id="分布函数"><a href="#分布函数" class="headerlink" title="分布函数"></a>分布函数</h3><p>X是随机变量，x是任意实数，F(x) &#x3D; P{X &lt;&#x3D; x}，称为X的分布函数</p><p>用于计算区间上的概率之和</p><p><strong>基本性质</strong>：</p><ol><li>F(x) 是一个单调不减的函数</li><li>规范性：F(-∞) &#x3D; 0，F(+∞) &#x3D; 1</li><li>F(x + 0) &#x3D; F(x)，即右连续</li></ol><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E5%88%86%E5%B8%83%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%981.png" alt="分布函数例题1"></p><h3 id="连续型随机变量"><a href="#连续型随机变量" class="headerlink" title="连续型随机变量"></a>连续型随机变量</h3><p><strong>概率密度</strong>：用密度来表示这个点的概率</p><ol><li>P{X &#x3D; x} &#x3D; f(x)dx</li><li>∫(+∞, -∞) f(x) &#x3D; 1</li><li>f(x) &gt;&#x3D; 0，X的取值范围为f(x) &gt; 0的区域</li><li>分布函数：F(x) &#x3D; P{X &lt;&#x3D; x} &#x3D; ∫(x, -∞) f(t)dt。F’(x) &#x3D; f(x),不考虑不可导点</li><li>F(x)连续，因为一个点的概率为0</li></ol><p>分类：</p><ol><li>均匀分布</li><li>指数分布</li><li>正态分布</li></ol><p><strong>均匀分布</strong></p><p><img src="/img/gailvlun_img/%E5%9D%87%E5%8C%80%E5%88%86%E5%B8%83.png"></p><p><strong>指数分布</strong></p><p>λ &gt; 0</p><p>X~E(λ)</p><p><img src="/img/gailvlun_img/%E6%8C%87%E6%95%B0%E5%88%86%E5%B8%83.png"></p><p><img src="/img/gailvlun_img/%E6%8C%87%E6%95%B0%E5%88%86%E5%B8%83%E7%9A%84%E6%97%A0%E8%AE%B0%E5%BF%86%E6%80%A7.png" alt="指数分布的无记忆性"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E4%BE%8B%E9%A2%981.png" alt="分布函数例题1"></p><p><img src="/img/gailvlun_img/%E5%9D%87%E5%8C%80%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="均匀分布例题1"></p><p><img src="/img/gailvlun_img/%E6%8C%87%E6%95%B0%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="指数分布例题1"></p><h3 id="正态分布"><a href="#正态分布" class="headerlink" title="正态分布"></a>正态分布</h3><p><img src="/img/gailvlun_img/%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83.png"></p><blockquote><p>利用正态分布计算反常积分</p><p><img src="/img/gailvlun_img/%E5%88%A9%E7%94%A8%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%E6%B1%82%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%861.png"></p><p><img src="/img/gailvlun_img/%E5%88%A9%E7%94%A8%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%E6%B1%82%E5%8F%8D%E5%B8%B8%E7%A7%AF%E5%88%862.png"></p></blockquote><p><img src="/img/gailvlun_img/%E6%A0%87%E5%87%86%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83.png" alt="标准正态分布"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E6%A0%87%E5%87%86%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png"></p><h2 id="二维随机变量及其分布"><a href="#二维随机变量及其分布" class="headerlink" title="二维随机变量及其分布"></a>二维随机变量及其分布</h2><h3 id="离散型"><a href="#离散型" class="headerlink" title="离散型"></a>离散型</h3><p><strong>分布律</strong></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E7%A6%BB%E6%95%A3%E5%9E%8B%E5%88%86%E5%B8%83%E5%88%86%E5%B8%83%E5%BE%8B%E4%BE%8B%E9%A2%981.png"></p><p><strong>分布函数</strong></p><ol><li>单调不减</li><li>右连续</li><li>规范型</li><li>概率&gt;&#x3D;0</li></ol><h3 id="连续型"><a href="#连续型" class="headerlink" title="连续型"></a>连续型</h3><p><strong>概率密度</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E8%BF%9E%E7%BB%AD%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6.png"></p><p><strong>分布函数</strong></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E8%BF%9E%E7%BB%AD%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E8%BF%9E%E7%BB%AD%E5%9E%8B%E5%9D%87%E5%8C%80%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="均匀分布例题"></p><h3 id="二维正态分布"><a href="#二维正态分布" class="headerlink" title="二维正态分布"></a>二维正态分布</h3><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83.png"></p><h3 id="边缘分布"><a href="#边缘分布" class="headerlink" title="边缘分布"></a>边缘分布</h3><p>二维随机变量里面只研究一个随机变量</p><p><strong>离散型</strong></p><p><img src="/img/gailvlun_img/%E7%A6%BB%E6%95%A3%E5%9E%8B%E8%BE%B9%E7%BC%98%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="例题"></p><p><strong>连续型</strong></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E8%BE%B9%E7%BC%98%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6.png"></p><p>做题时一定要画图</p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E8%BE%B9%E7%BC%98%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E4%BE%8B%E9%A2%981.png" alt="例题"></p><h3 id="条件分布"><a href="#条件分布" class="headerlink" title="条件分布"></a>条件分布</h3><p><strong>离散型</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E6%9D%A1%E4%BB%B6%E5%88%86%E5%B8%83%E5%BE%8B.png"></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E7%A6%BB%E6%95%A3%E5%9E%8B%E6%9D%A1%E4%BB%B6%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png" alt="例题"></p><p><strong>连续型</strong></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E6%9D%A1%E4%BB%B6%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E4%BE%8B%E9%A2%981.png" alt="例题1"></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E8%BF%9E%E7%BB%AD%E5%9E%8B%E6%9D%A1%E4%BB%B6%E6%A6%82%E7%8E%87%E5%AF%86%E5%BA%A6%E4%BE%8B%E9%A2%981.png" alt="例题2"></p><h3 id="独立性-1"><a href="#独立性-1" class="headerlink" title="独立性"></a>独立性</h3><ol><li>连续型判断独立性：概率密度f(x, y) &#x3D; fX(x)fY(y)</li><li>离散型判断独立性：同时发生的概率为各自发生概率的乘积P{X &#x3D; xi, Y &#x3D; yj} &#x3D; P{X &#x3D; xi}P{Y &#x3D; yj}</li></ol><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E4%BA%8C%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E7%8B%AC%E7%AB%8B%E6%80%A7%E4%BE%8B%E9%A2%981.png" alt="例题"></p><h2 id="随机变量函数"><a href="#随机变量函数" class="headerlink" title="随机变量函数"></a>随机变量函数</h2><p><strong>一维例题</strong></p><p>:star:</p><p><img src="/img/gailvlun_img/%E7%A6%BB%E6%95%A3%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%981.png" alt="离散型例题1"></p><p>分布函数法，求导得概率密度</p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%981.png" alt="连续性例题1"></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%982.png" alt="正态分布的随机变量函数还是正态分布"></p><p><img src="/img/gailvlun_img/%E6%B7%B7%E5%90%88%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%981.png" alt="混合型随机变量函数例题1"></p><p><strong>二维例题</strong></p><p><img src="/img/gailvlun_img/%E7%A6%BB%E6%95%A3%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%982.png" alt="离散型例题2"></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%983.png" alt="连续性例题2"></p><blockquote><p>如果题目中Z &#x3D; max(X, Y)或Z &#x3D; min(X, Y)的情况时</p><p><img src="/img/gailvlun_img/%E6%9C%80%E5%80%BC%E5%87%BD%E6%95%B01.png" alt="max的情况"></p><p><img src="/img/gailvlun_img/%E6%9C%80%E5%80%BC%E5%87%BD%E6%95%B02.png" alt="min的情况"></p></blockquote><p><img src="/img/gailvlun_img/%E6%9C%80%E5%80%BC%E5%87%BD%E6%95%B0%E4%BE%8B%E9%A2%981.png" alt="min的情况"></p><h2 id="数字特征"><a href="#数字特征" class="headerlink" title="数字特征"></a>数字特征</h2><h3 id="期望"><a href="#期望" class="headerlink" title="期望"></a>期望</h3><p>期望也就是理论平均值</p><p><img src="/img/gailvlun_img/%E4%B8%80%E7%BB%B4%E9%9A%8F%E6%9C%BA%E5%8F%98%E9%87%8F%E7%9A%84%E6%9C%9F%E6%9C%9B.png"></p><p><strong>常见分布的期望</strong></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%9C%9F%E6%9C%9B1.png" alt="一维离散型"></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%9C%9F%E6%9C%9B2.png" alt="一维连续型"></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%9C%9F%E6%9C%9B3.png" alt="二维"></p><p><strong>性质</strong></p><ol><li>设C是常数，则有E(C) &#x3D; C</li><li>X是随机变量，C是常数，则E(CX) &#x3D; CE(X)</li><li>X、Y是随机变量，则E(X+Y) &#x3D; E(X) + E(Y)</li><li>X、Y是随机变量，且相互独立，则有E(XY) &#x3D; E(X)E(Y)</li></ol><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%9C%9F%E6%9C%9B4.png" alt="通过性质3可以推出二项分布的期望"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E6%9C%9F%E6%9C%9B%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/%E6%9C%9F%E6%9C%9B%E4%BE%8B%E9%A2%982.png" alt="复杂事件期望等于简单事件期望的和"></p><h3 id="方差"><a href="#方差" class="headerlink" title="方差"></a>方差</h3><p>描述了随机变量在期望上下波动的程度</p><p>方差为偏离程度的平均值(期望)</p><p><img src="/img/gailvlun_img/%E6%96%B9%E5%B7%AE.png"></p><p><strong>性质</strong></p><ol><li><p>C是常数，D(C) &#x3D; 0</p></li><li><p>C是常数，D(CX) &#x3D; C²D(X)，D(X + C) &#x3D; D(X)</p></li><li><p>D(X+Y) &#x3D; D(X) + D(Y) + 2E{ (X - E(X)(Y - E(Y))) }</p><p> 若X、Y相互独立，则D(X+Y) &#x3D; D(X) + D(Y)</p></li><li><p>D(X) &#x3D; 0  &lt;&#x3D;&#x3D;&gt;  P{X &#x3D; E(X)} &#x3D; 1</p></li></ol><p><strong>常见分布的方差</strong></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%96%B9%E5%B7%AE1.png" alt="一维离散型1"></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%96%B9%E5%B7%AE2.png" alt="一维离散型2"></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%96%B9%E5%B7%AE4.png" alt="一维离散型3"></p><p><img src="/img/gailvlun_img/%E5%B8%B8%E8%A7%81%E5%88%86%E5%B8%83%E7%9A%84%E6%96%B9%E5%B7%AE3.png" alt="一维连续型"></p><blockquote><p>伽马函数</p><p><img src="/img/gailvlun_img/%E4%BC%BD%E9%A9%AC%E5%87%BD%E6%95%B0.png" alt="通过伽马函数简化计算"></p></blockquote><p>正态分布的方差是σ²</p><h3 id="协方差"><a href="#协方差" class="headerlink" title="协方差"></a>协方差</h3><p><img src="/img/gailvlun_img/%E5%8D%8F%E6%96%B9%E5%B7%AE.png" alt="定义"></p><p>​协方差是两个随机变量 X 和 Y 之间线性关系的度量。协方差为正表示 X 和 Y 具有正相关关系，即当 X 增大时，Y 也倾向于增大；协方差为负表示 X 和 Y 具有负相关关系，即当 X 增大时，Y 倾向于减小</p><p><strong>性质</strong></p><ol><li>a，b为常数，Cov(aX, bY) &#x3D; ab Cov(X, Y)</li><li>Cov(X1 + X2, Y) &#x3D; Cov(X1, Y) + Cov(X2, Y)</li><li>若X、Y相互独立，则Cov(X, Y) &#x3D; 0</li><li>C为常数，Cov(X, C) &#x3D; 0</li><li>Cov(X, X) &#x3D; E(X - EX)(X - EX) &#x3D; DX</li></ol><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E5%8D%8F%E6%96%B9%E5%B7%AE%E4%BE%8B%E9%A2%981.png"></p><h3 id="相关系数"><a href="#相关系数" class="headerlink" title="相关系数"></a>相关系数</h3><p>相当于将协方差标准化，使取值范围在[-1, 1]之间，都是用于描述两个随机变量的相关性</p><p><img src="/img/gailvlun_img/%E7%9B%B8%E5%85%B3%E7%B3%BB%E6%95%B0.png"></p><p><strong>性质</strong></p><ol><li>|ρXY| &lt;&#x3D; 1</li><li>|ρXY| &#x3D; 1  充要条件是 P{Y &#x3D; aX + b} &#x3D; 1</li><li>相互独立则ρXY &#x3D; 0</li></ol><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E7%9B%B8%E5%85%B3%E7%B3%BB%E6%95%B0%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/%E7%9B%B8%E5%85%B3%E7%B3%BB%E6%95%B0%E4%BE%8B%E9%A2%982.png" alt="综合题"></p><h3 id="矩"><a href="#矩" class="headerlink" title="矩"></a>矩</h3><p><img src="/img/gailvlun_img/%E7%9F%A9.png"></p><h3 id="总结和例题"><a href="#总结和例题" class="headerlink" title="总结和例题"></a>总结和例题</h3><p><img src="/img/gailvlun_img/%E6%9C%9F%E6%9C%9B%E6%96%B9%E5%B7%AE%E6%80%BB%E7%BB%93.png" alt="总结"></p><p><img src="/img/gailvlun_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%981.png" alt="例题1"></p><p><img src="/img/gailvlun_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%982.png" alt="例题2"></p><p><img src="/img/gailvlun_img/%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%81%E4%BE%8B%E9%A2%983.png" alt="例题3-伽马函数应用"></p><h2 id="大数定律"><a href="#大数定律" class="headerlink" title="大数定律"></a>大数定律</h2><h3 id="切比雪夫不等式"><a href="#切比雪夫不等式" class="headerlink" title="切比雪夫不等式"></a>切比雪夫不等式</h3><p>用于描述随机变量与其均值之间的偏离程度</p><p><img src="/img/gailvlun_img/%E5%88%87%E6%AF%94%E9%9B%AA%E5%A4%AB%E4%B8%8D%E7%AD%89%E5%BC%8F.png"></p><blockquote><p>用于去掉异常数据</p><p><img src="/img/gailvlun_img/3%CF%83%E5%8E%9F%E5%88%99.png" alt="3σ原则"></p></blockquote><h3 id="依概率收敛"><a href="#依概率收敛" class="headerlink" title="依概率收敛"></a>依概率收敛</h3><p>大量样本的平均值具有稳定性</p><p><img src="/img/gailvlun_img/%E4%BE%9D%E6%A6%82%E7%8E%87%E6%94%B6%E6%95%9B.png"></p><h3 id="大数定理"><a href="#大数定理" class="headerlink" title="大数定理"></a>大数定理</h3><p><strong>弱大数定理</strong></p><p><img src="/img/gailvlun_img/%E5%BC%B1%E5%A4%A7%E6%95%B0%E5%AE%9A%E7%90%86.png"></p><p><strong>伯努利大数定理</strong></p><p><img src="/img/gailvlun_img/%E4%BC%AF%E5%8A%AA%E5%88%A9%E5%A4%A7%E6%95%B0%E5%AE%9A%E7%90%86.png"></p><p><strong>切比雪夫大数定律</strong></p><p><img src="/img/gailvlun_img/%E5%88%87%E6%AF%94%E9%9B%AA%E5%A4%AB%E5%A4%A7%E6%95%B0%E5%AE%9A%E5%BE%8B.png"></p><h3 id="中心极限定理"><a href="#中心极限定理" class="headerlink" title="中心极限定理"></a>中心极限定理</h3><p><img src="/img/gailvlun_img/%E4%B8%AD%E5%BF%83%E6%9E%81%E9%99%90%E5%AE%9A%E7%90%86.png"></p><p><img src="/img/gailvlun_img/%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E5%AE%9A%E7%90%86.png"></p><h1 id="数理统计基础"><a href="#数理统计基础" class="headerlink" title="数理统计基础"></a>数理统计基础</h1><h2 id="统计量"><a href="#统计量" class="headerlink" title="统计量"></a>统计量</h2><p>统计量是用来描述和总结一组数据的数值指标。</p><p>X1、X2、…、Xn独立同分布，则称为从分布函数F得到的容量为n的<strong>简单随机样本</strong></p><p><img src="/img/gailvlun_img/%E7%BB%9F%E8%AE%A1%E9%87%8F1.png"></p><p><img src="/img/gailvlun_img/%E7%BB%9F%E8%AE%A1%E9%87%8F2.png"></p><p><strong>统计量的数字特征</strong></p><p><img src="/img/gailvlun_img/%E7%BB%9F%E8%AE%A1%E9%87%8F%E7%9A%84%E6%95%B0%E5%AD%97%E7%89%B9%E5%BE%811.png"></p><h2 id="抽样分布"><a href="#抽样分布" class="headerlink" title="抽样分布"></a>抽样分布</h2><p>统计量的分布</p><h3 id="x²分布"><a href="#x²分布" class="headerlink" title="x²分布"></a>x²分布</h3><p>注意是标准正态分布的抽样分布</p><p><img src="/img/gailvlun_img/x%C2%B2%E5%88%86%E5%B8%83.png"></p><p><strong>性质</strong></p><p><img src="/img/gailvlun_img/x%C2%B2%E5%88%86%E5%B8%83%E6%80%A7%E8%B4%A8.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/x%C2%B2%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/x%C2%B2%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%982.png" alt="分位点例题"></p><h3 id="t分布"><a href="#t分布" class="headerlink" title="t分布"></a>t分布</h3><p><img src="/img/gailvlun_img/t%E5%88%86%E5%B8%83.png"></p><p><img src="/img/gailvlun_img/t%E5%88%86%E5%B8%83%E7%9A%84%E5%88%86%E4%BD%8D%E7%82%B9.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/t%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%98.png"></p><h3 id="F分布"><a href="#F分布" class="headerlink" title="F分布"></a>F分布</h3><p><img src="/img/gailvlun_img/F%E5%88%86%E5%B8%83.png"></p><p><img src="/img/gailvlun_img/F%E5%88%86%E5%B8%83%E6%80%A7%E8%B4%A8.png"></p><p><img src="/img/gailvlun_img/%E4%B8%80%E8%88%AC%E6%AD%A3%E6%80%81%E5%88%86%E5%B8%83%E7%9A%84%E6%A0%B7%E6%9C%AC%E5%9D%87%E5%80%BC%E5%92%8C%E6%A0%B7%E6%9C%AC%E6%96%B9%E5%B7%AE%E7%9A%84%E5%88%86%E5%B8%83.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/F%E5%88%86%E5%B8%83%E4%BE%8B%E9%A2%981.png"></p><h2 id="参数估计与假设检验"><a href="#参数估计与假设检验" class="headerlink" title="参数估计与假设检验"></a>参数估计与假设检验</h2><h3 id="点估计"><a href="#点估计" class="headerlink" title="点估计"></a>点估计</h3><p>X的分布函数已知，但一个或多个参数未知，通过样本来来估计未知参数的值称为参数的点估计问题</p><p><strong>矩估计</strong></p><p>用样本的原点矩、中心矩来近似整体的期望和方差</p><p><img src="/img/gailvlun_img/%E7%9F%A9%E4%BC%B0%E8%AE%A1.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E7%9F%A9%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/%E7%9F%A9%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%982.png"></p><h3 id="最大似然估计"><a href="#最大似然估计" class="headerlink" title="最大似然估计"></a>最大似然估计</h3><p>假设我们有一个参数化的概率分布模型 P(X; θ)，其中X表示观测数据，θ表示需要估计的参数。最大似然估计的目标是找到参数θ的值，使得在给定观测数据X时，数据出现的概率（似然函数）最大。</p><p><strong>离散型</strong></p><p><img src="/img/gailvlun_img/%E7%A6%BB%E6%95%A3%E5%9E%8B%E4%BC%BC%E7%84%B6%E4%BC%B0%E8%AE%A1.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E7%A6%BB%E6%95%A3%E5%9E%8B%E4%BC%BC%E7%84%B6%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%981.png"></p><p><strong>连续型</strong></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E4%BC%BC%E7%84%B6%E4%BC%B0%E8%AE%A1.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E4%BC%BC%E7%84%B6%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/gailvlun_img/%E8%BF%9E%E7%BB%AD%E5%9E%8B%E4%BC%BC%E7%84%B6%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%982.png"></p><h3 id="估计量的评选标准"><a href="#估计量的评选标准" class="headerlink" title="估计量的评选标准"></a>估计量的评选标准</h3><p>用来评价哪种估计方法好</p><p><strong>无偏性</strong></p><p>E(估计值) &#x3D; 待估参数</p><p><strong>有效性</strong></p><p>D(θ1) &lt;&#x3D; D(θ2)，则θ1比θ2有效</p><p><strong>一致性（相合性）</strong></p><p><img src="/img/gailvlun_img/%E4%B8%80%E8%87%B4%E6%80%A7.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E6%97%A0%E5%81%8F%E4%BC%B0%E8%AE%A1%E9%87%8F%E4%BE%8B%E9%A2%981.png" alt="无偏性例题1"></p><p><img src="/img/gailvlun_img/%E6%9C%89%E6%95%88%E6%80%A7%E4%BE%8B%E9%A2%981.png" alt="有效性例题1"></p><h3 id="区间估计"><a href="#区间估计" class="headerlink" title="区间估计"></a>区间估计</h3><p><img src="/img/gailvlun_img/%E5%8C%BA%E9%97%B4%E4%BC%B0%E8%AE%A1.png"></p><p>显著性水平：犯错率(α)</p><p>置信度：正确率(1 - α)</p><p>置信区间：估计的值所在的区间</p><p>区间估计：估计的值在置信区间的概率要等于1 - α</p><p><strong>题型</strong></p><p><img src="/img/gailvlun_img/%E5%8C%BA%E9%97%B4%E4%BC%B0%E8%AE%A1%E7%9A%84%E5%87%A0%E7%A7%8D%E6%83%85%E5%86%B5.png" alt="区间估计的几种情况"></p><p><img src="/img/gailvlun_img/%E5%8C%BA%E9%97%B4%E4%BC%B0%E8%AE%A1%E4%BE%8B%E9%A2%982.png" alt="第一种情况的推导"></p><h3 id="假设检验"><a href="#假设检验" class="headerlink" title="假设检验"></a>假设检验</h3><p>对样本的均值进行检验，如果落在拒绝域则认为有问题</p><p><img src="/img/gailvlun_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C.png"></p><p><strong>题型</strong></p><p><img src="/img/gailvlun_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C%E9%A2%98%E5%9E%8B.png"></p><p><strong>例题</strong></p><p><img src="/img/gailvlun_img/%E5%81%87%E8%AE%BE%E6%A3%80%E9%AA%8C%E4%BE%8B%E9%A2%98.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线代基础</title>
    <link href="/2024/05/09/%E8%80%83%E7%A0%94/%E7%BA%BF%E4%BB%A3%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/05/09/%E8%80%83%E7%A0%94/%E7%BA%BF%E4%BB%A3%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="线代基础"><a href="#线代基础" class="headerlink" title="线代基础"></a>线代基础</h1><h2 id="行列式"><a href="#行列式" class="headerlink" title="行列式"></a>行列式</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p><strong>全排列</strong>：n个数排成一列</p><p><strong>标准排列</strong>：由小到大排列</p><p><strong>逆序</strong>：排列中两个元素，大的数在小的数之前</p><p><strong>逆序数</strong>：一个排列中所有逆序的总数</p><p><strong>奇（偶）排列</strong>：逆序数为奇（偶）数</p><p><img src="/img/xiandai_img/%E9%80%86%E5%BA%8F%E6%95%B0%E4%BE%8B%E9%A2%98.png"></p><p><strong>对换</strong>：在排列中，将任意两个元素对换</p><ul><li>一个排列中的任意两个元素对换，排列改变奇偶性</li><li>奇排列对换成标准排列的对换次数为奇数，偶排列对换成标准排列的对换次数为偶数</li></ul><p><strong>三阶行列式</strong>：</p><p><img src="/img/xiandai_img/%E4%B8%89%E9%98%B6%E8%A1%8C%E5%88%97%E5%BC%8F.png"></p><p><strong>n阶行列式</strong>：n!项<strong>不同行不同列</strong>元素乘积的代数和</p><p><img src="/img/xiandai_img/n%E9%98%B6%E8%A1%8C%E5%88%97%E5%BC%8F.png"></p><p><strong>上（下）三角形行列式</strong>：主对角线以下（上）都是0</p><p><strong>对角线行列式</strong>：主对角线上下都是0</p><h4 id="性质（化简行列式）"><a href="#性质（化简行列式）" class="headerlink" title="性质（化简行列式）"></a>性质（化简行列式）</h4><p><strong>转置行列式</strong>：</p><p><img src="/img/xiandai_img/%E8%BD%AC%E7%BD%AE%E8%A1%8C%E5%88%97%E5%BC%8F.png"></p><p>性质1：行列式与它的转置行列式相等</p><p>性质2：对换行列式的两行（列），行列式变号</p><ul><li>如果行列式有两行（列）完全相同，则此行列式等于零</li></ul><p>性质3：行列式的某一行（列）中所有的元素都乘同一数 k，等于用数 k 乘此行列式</p><ul><li>行列式中某一行（列）的所有元素的公因子可以提到行列式记号的外面</li></ul><p>性质4：行列式中如果有两行（列）元素成比例，则此行列式等于零</p><p>性质5：</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%80%A7%E8%B4%A85.png"></p><p><strong>性质6</strong>：把行列式的某一行（列）的各元素乘同一数然后加到另一行（列）对 应的元素上去，行列式不变</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%80%A7%E8%B4%A86.png"></p><h4 id="典型题型"><a href="#典型题型" class="headerlink" title="典型题型"></a>典型题型</h4><ol><li><p>化为上（下）三角</p><p> <img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%981.png"></p></li><li><p>n阶ab型行列式</p><p> <img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%982.png"></p><p> 结论</p><p> <img src="/img/xiandai_img/n%E9%98%B6ab%E5%9E%8B%E8%A1%8C%E5%88%97%E5%BC%8F.png"></p></li><li><p>拉普拉斯展开式</p><p> 设A为m阶矩阵，B为n阶矩阵</p><p> <img src="/img/xiandai_img/%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E5%B1%95%E5%BC%80%E5%BC%8F.png"></p><p> <img src="/img/xiandai_img/%E6%8B%89%E6%99%AE%E6%8B%89%E6%96%AF%E5%B1%95%E5%BC%80%E5%BC%8F%E4%BE%8B%E9%A2%98.png" alt="拉普拉斯展开式例题"></p></li><li><p>范德蒙行列式</p><p> 由1阶、2阶、3阶…归纳法得出</p><p> <img src="/img/xiandai_img/%E8%8C%83%E5%BE%B7%E8%92%99%E8%A1%8C%E5%88%97%E5%BC%8F.png"></p><p> <img src="/img/xiandai_img/%E8%8C%83%E5%BE%B7%E8%92%99%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%981.png" alt="范德蒙行列式例题"></p><p> <img src="/img/xiandai_img/%E8%8C%83%E5%BE%B7%E8%92%99%E8%A1%8C%E5%88%97%E5%BC%8F%E4%BE%8B%E9%A2%982.png" alt="范德蒙行列式例题"></p></li></ol><h2 id="行列式展开"><a href="#行列式展开" class="headerlink" title="行列式展开"></a>行列式展开</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>余子式：把i行和j列去掉后剩下的n-1阶行列式，记作M(i,j)</p><p>代数余子式：A(i,j) &#x3D; (-1)^(i+j) M</p><h3 id="行列式按行（列）展开法则"><a href="#行列式按行（列）展开法则" class="headerlink" title="行列式按行（列）展开法则"></a>行列式按行（列）展开法则</h3><p>行列式等于它的任一行（列）的各元素与其对应的代数余子式乘积之和</p><p>行列式某一行（列）的元素与<strong>另一行</strong>（列）的对应元素的代数余子式 乘积之和等于零</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%8C%89%E8%A1%8C%EF%BC%88%E5%88%97%EF%BC%89%E5%B1%95%E5%BC%80%E6%B3%95%E5%88%99.png"></p><h3 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h3><p><strong>例题1</strong></p><p>有很多0，考虑用按行展开</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%8C%89%E8%A1%8C%E5%B1%95%E5%BC%80%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%8C%89%E8%A1%8C%E5%B1%95%E5%BC%80%E4%BE%8B%E9%A2%981%E5%8F%A6%E4%B8%80%E7%A7%8D%E8%A7%A3%E6%B3%95.png" alt="另一种解法"></p><p><strong>例题2</strong></p><p>余子式、代数余子式求和</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%8C%89%E8%A1%8C%E5%B1%95%E5%BC%80%E4%BE%8B%E9%A2%982-1.png"></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E6%8C%89%E8%A1%8C%E5%B1%95%E5%BC%80%E4%BE%8B%E9%A2%982-2.png"></p><h2 id="行列式的公式"><a href="#行列式的公式" class="headerlink" title="行列式的公式"></a>行列式的公式</h2><p>注意A、B为矩阵</p><p>公式<strong>1</strong></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F1.png"></p><p><strong>公式2</strong></p><p>乘积的行列式等于行列式的乘积</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F2.png"></p><p><strong>公式3</strong></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F3.png"></p><p><strong>公式4</strong></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F4.png"></p><p><strong>公式5</strong></p><p>伴随矩阵</p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F5.png"></p><p><strong>公式6</strong></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F6.png"></p><p><strong>公式7</strong></p><p><img src="/img/xiandai_img/%E8%A1%8C%E5%88%97%E5%BC%8F%E5%85%AC%E5%BC%8F7.png"></p><h2 id="Cramer法则"><a href="#Cramer法则" class="headerlink" title="Cramer法则"></a>Cramer法则</h2><p><img src="/img/xiandai_img/%E5%85%8B%E6%8B%89%E9%BB%98%E6%B3%95%E5%88%99.png"></p><h2 id="矩阵"><a href="#矩阵" class="headerlink" title="矩阵"></a>矩阵</h2><h3 id="概念-2"><a href="#概念-2" class="headerlink" title="概念"></a>概念</h3><p>n阶矩阵（n阶方阵）：行数与列数都等于n的矩阵</p><p>行（列）矩阵：只有一行（列）的矩阵</p><p>零矩阵：元素都是零的矩阵</p><p>单位矩阵：</p><p><img src="/img/xiandai_img/%E5%8D%95%E4%BD%8D%E7%9F%A9%E9%98%B5.png"></p><p><strong>矩阵乘法</strong>：</p><p><img src="/img/xiandai_img/%E7%9F%A9%E9%98%B5%E4%B9%98%E6%B3%95.png"></p><p>注意：</p><ol><li>只有当第一个矩阵（左矩阵）的列数等于第二个矩阵（右矩阵）的 行数时，两个矩阵才能相乘</li><li>矩阵乘法不满足交换律，不满足因式分解</li><li>矩阵的乘法中必须注意矩阵相乘的顺序</li></ol><p><strong>伴随矩阵</strong>：</p><p>各个元素的代数余子式 Aij所构成的矩阵</p><p>二阶的伴随矩阵为：主对角线互换，副对角线变号</p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5.png"></p><p>性质：</p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A81.png" alt="性质1"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A82.png" alt="性质2"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A83.png" alt="性质3"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A84.png" alt="性质4"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A85.png" alt="性质5"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A86.png" alt="性质6"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A87.png" alt="性质7"></p><p><img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A88.png" alt="性质8"></p><h3 id="矩阵转置"><a href="#矩阵转置" class="headerlink" title="矩阵转置"></a>矩阵转置</h3><p><img src="/img/xiandai_img/%E7%9F%A9%E5%BD%A2%E8%BD%AC%E7%BD%AE.png"></p><p>对称矩阵：A的转置&#x3D;A</p><p>反对称矩阵：A的转置&#x3D;-A</p><h3 id="逆矩阵"><a href="#逆矩阵" class="headerlink" title="逆矩阵"></a>逆矩阵</h3><p>如果有一个n阶矩阵B，使AB &#x3D; BA &#x3D; E，则矩阵A是可逆的</p><p>注意：</p><ol><li>如果矩阵 A 是可逆的，那么 A 的逆矩阵是惟一的</li><li>可逆的矩阵一定是个方阵</li><li>若|A| ≠ 0，则矩阵A可逆</li></ol><p>可逆的充要条件：</p><ol><li>|A|≠0</li><li>r(A)&#x3D;n</li><li>行（列）向量组线性无关</li><li>齐次线性方程组Ax&#x3D;0只有零解</li><li>非齐次线性方程组Ax&#x3D;b有唯一解</li><li>Ade特征值均不为零</li></ol><p>性质：</p><p><img src="/img/xiandai_img/%E7%9F%A9%E9%98%B5%E9%80%86%E7%9A%84%E6%80%A7%E8%B4%A8.png"></p><p>例题1：</p><p><img src="/img/xiandai_img/%E9%80%86%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%981.png"></p><h3 id="逆的求法"><a href="#逆的求法" class="headerlink" title="逆的求法"></a>逆的求法</h3><ol><li><p>定义法：AB&#x3D;E或BA&#x3D;E</p></li><li><p>初等变换法：</p><p> <img src="/img/xiandai_img/%E5%88%9D%E7%AD%89%E5%8F%98%E6%8D%A2%E6%B3%95.png"></p><p> <img src="/img/xiandai_img/%E5%88%9D%E7%AD%89%E5%8F%98%E6%8D%A2%E6%B3%95%E4%BE%8B%E9%A2%981.png" alt="初等变换法例题1"></p></li><li><p>伴随矩阵法：</p><p> <img src="/img/xiandai_img/%E4%BC%B4%E9%9A%8F%E7%9F%A9%E9%98%B5%E6%B3%95%E6%B1%82%E9%80%86.png"></p></li></ol><h3 id="初等变换"><a href="#初等变换" class="headerlink" title="初等变换"></a>初等变换</h3><p><strong>初等变换：</strong></p><ol><li>对换两行（列）</li><li>数k乘以某行（列）(k !&#x3D; 0)</li><li>某行（列）* k加到另一行（列）</li></ol><p><strong>初等矩阵</strong>：</p><p>​单位矩阵E经过一次初等变换得到的矩阵</p><ol><li>E(i, j)：i, j两行（列）互换</li><li>E(i(k))：i行乘以k</li><li>E(ij(k))：j行乘k加到i行（或i列乘k加到j列）</li></ol><p><strong>矩阵等价</strong>：</p><p>​矩阵A经有限次初等变换变成矩阵B，就称矩阵A与B等价，记作A~B</p><p><strong>行阶梯形矩阵</strong>：</p><ol><li>非零行在零行的上面</li><li>非零行的首非 零元所在列在上一行（如果存在的话）的首非零元所在列的右面</li></ol><p><strong>行最简形矩阵</strong>：</p><ol><li>非零行的首非零元为1</li><li>首非零元的上下都是0</li></ol><p><strong>性质</strong>：</p><ol><li>设 A 是一个 m×n 矩阵，对 A 施行一次初等行变换，相当于在 A 的 左边乘相应的 m 阶初等矩阵；对 A 施行一次初等列变换，相当于在 A 的右边乘 相应的 n 阶初等矩阵</li><li><img src="/img/xiandai_img/%E5%88%9D%E7%AD%89%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A82.png"></li></ol><h3 id="秩"><a href="#秩" class="headerlink" title="秩"></a>秩</h3><p><strong>概念</strong></p><p>秩：非零子式的最高阶数</p><p>满秩矩阵：秩等于矩阵的阶数，可逆</p><p>降秩矩阵：秩小于矩阵的阶数，不可逆</p><p><strong>性质</strong></p><ol><li>0 ≤ R（A ）≤min{m，n}，A为m*n的矩阵</li><li>max {R(A), R(B)} ≤ R(A, B) ≤ R(A) + R(B)</li><li>R（A B）≤ min｛R（A），R（B）｝</li><li>R(A ^ T) &#x3D; R(A)</li><li>若A~B，则R(A) &#x3D; R(B)</li><li>R(A+B) &lt;&#x3D; R(A)+R(B)</li><li>若P、Q可逆，则R（PAQ）&#x3D;R（A）</li><li>若 A m×n Bn×l &#x3D; O，则 R（A）+R（B） ≤　n</li><li>矩阵乘法的消去律： A B &#x3D; O，若 A 为列满秩矩阵，则 B &#x3D; O</li></ol><p>中文描述：秩小于等于行数和列数、和的秩等于秩的和、乘积的秩小于两个矩阵、</p><p>联立的秩大于等于最大的小于等于秩的和、乘非零系数秩不变、左乘可逆矩阵秩不变、</p><p>右乘可逆矩阵秩不变、左乘列满秩矩阵秩不变、右乘行满秩矩阵秩不变、乘转置矩阵秩不变、</p><p>A(mxn)，B(nxs)，AB&#x3D;O则r(A)+r(B)≤n</p><p><strong>求法</strong></p><ol><li>A为数字矩阵时，作初等变换化为行阶梯矩阵，r（A）&#x3D; 非零行行数</li><li>A为抽象矩阵时，用定义或性质</li></ol><h3 id="分块矩阵"><a href="#分块矩阵" class="headerlink" title="分块矩阵"></a>分块矩阵</h3><p><strong>运算</strong></p><p>加法、数乘和普通矩阵一样</p><p>乘法：前列后行分发相同</p><p>转置：整个矩阵转置了，每个小块里面也要转置</p><p>逆：</p><p><img src="/img/xiandai_img/%E5%88%86%E5%9D%97%E7%9F%A9%E9%98%B5%E7%9A%84%E9%80%86%E8%BF%90%E7%AE%97.png"></p><h2 id="向量"><a href="#向量" class="headerlink" title="向量"></a>向量</h2><h3 id="概念-3"><a href="#概念-3" class="headerlink" title="概念"></a>概念</h3><p>n维向量：n个有次序的数 组成的数组，向量也是矩阵</p><p>内积：<img src="/img/xiandai_img/%E5%90%91%E9%87%8F%E5%86%85%E7%A7%AF.png"></p><p>正交：[a, b] &#x3D; 0，几何上垂直</p><p>向量长度：<img src="/img/xiandai_img/%E5%90%91%E9%87%8F%E9%95%BF%E5%BA%A6.png"></p><h3 id="正交矩阵"><a href="#正交矩阵" class="headerlink" title="正交矩阵"></a>正交矩阵</h3><p>A为n阶矩阵，A * A^T &#x3D; A^T * A &#x3D; E</p><p><strong>充要条件</strong></p><ol><li>A^T &#x3D; A^(-1)</li><li>A的列（行）向量组为单位正交的向量组</li></ol><p><strong>性质</strong></p><ol><li><img src="/img/xiandai_img/%E6%AD%A3%E4%BA%A4%E7%9F%A9%E9%98%B5%E7%9A%84%E6%80%A7%E8%B4%A81.png" alt="性质1"></li><li><img src="/img/xiandai_img/%E6%AD%A3%E4%BA%A4%E7%9F%A9%E9%98%B5%E6%80%A7%E8%B4%A82.png" alt="性质2"></li></ol><p><strong>Schmidt正交化</strong></p><p><img src="/img/xiandai_img/Schmidt%E6%AD%A3%E4%BA%A4%E5%8C%96.png"></p><h2 id="向量组"><a href="#向量组" class="headerlink" title="向量组"></a>向量组</h2><h3 id="概念-4"><a href="#概念-4" class="headerlink" title="概念"></a>概念</h3><p>向量组：若干同维度的列向量组成的集合</p><h3 id="线性表示"><a href="#线性表示" class="headerlink" title="线性表示"></a>线性表示</h3><p>向量组a1,a2…am，存在一组数λ1,λ2,…,λm，向量组b能由λ1a1 + λ2a2 + … +λmam表示</p><p>秩相等才能线性表示</p><h3 id="线性表示的充要条件"><a href="#线性表示的充要条件" class="headerlink" title="线性表示的充要条件"></a>线性表示的充要条件</h3><p><img src="/img/xiandai_img/%E7%BA%BF%E6%80%A7%E8%A1%A8%E7%A4%BA%E7%9A%84%E5%85%85%E8%A6%81%E6%9D%A1%E4%BB%B6.png"></p><h3 id="线性表示的求法"><a href="#线性表示的求法" class="headerlink" title="线性表示的求法"></a>线性表示的求法</h3><p>求的是系数矩阵</p><p><img src="/img/xiandai_img/%E7%B3%BB%E6%95%B0%E7%9F%A9%E9%98%B5.png" alt="系数矩阵"></p><p><img src="/img/xiandai_img/%E7%BA%BF%E6%80%A7%E8%A1%A8%E7%A4%BA%E7%9A%84%E6%B1%82%E6%B3%95.png" alt="求法"></p><h3 id="向量组等价"><a href="#向量组等价" class="headerlink" title="向量组等价"></a>向量组等价</h3><p>两个向量组可以互相线性表示</p><p><img src="/img/xiandai_img/%E5%90%91%E9%87%8F%E7%BB%84%E7%AD%89%E4%BB%B7%E4%BE%8B%E9%A2%981.png" alt="例题1"></p><h3 id="向量组等价的充要条件"><a href="#向量组等价的充要条件" class="headerlink" title="向量组等价的充要条件"></a>向量组等价的充要条件</h3><p>向量组A与向量组 B</p><p>等价的充要条件是R(A) &#x3D; R(A,B) &#x3D; R(B)</p><h3 id="线性相关"><a href="#线性相关" class="headerlink" title="线性相关"></a>线性相关</h3><p>向量组a1,a2,a3…，存在一组非全零的k1,k2,k3…</p><p>使得k1a1 + k2a2 + k3a3…. &#x3D; 0</p><p>则为线性相关</p><blockquote><p>两个向量线性相关的几何意义是两个向量共线</p><p>三个向量线性相关的几何意义是三个向量共面</p></blockquote><blockquote><p>一个向量线性相关，则向量为零向量</p><p>两个向量线性相关，则两个向量成比例</p></blockquote><h3 id="线性相关的充要条件"><a href="#线性相关的充要条件" class="headerlink" title="线性相关的充要条件"></a>线性相关的充要条件</h3><p><img src="/img/xiandai_img/%E7%BA%BF%E6%80%A7%E7%9B%B8%E5%85%B3%E7%9A%84%E5%85%85%E8%A6%81%E6%9D%A1%E4%BB%B6.png"></p><h3 id="线性相关的充分条件"><a href="#线性相关的充分条件" class="headerlink" title="线性相关的充分条件"></a>线性相关的充分条件</h3><ol><li>含有零向量的向量组线性相关</li><li>部分相关，则整体相关</li><li>高维相关，则低维相关</li><li>向量组a1,a2,…as可由向量组b1,b2,…bt线性表示，则s&gt;t</li><li>n+1个n维向量线性相关</li></ol><h3 id="向量组的秩"><a href="#向量组的秩" class="headerlink" title="向量组的秩"></a>向量组的秩</h3><p><strong>极大线性无关组</strong>：A0：a1， a2，…，ar 线性无关，向量组 A 中任意 r+1 个向量都线性相关</p><p>称向量组A0是向量组A的一个最大线性无关向量组</p><p><strong>秩</strong>： r称为向量组 A 的秩</p><blockquote><p>极大线性无关组不唯一</p><p>矩阵的秩等于其（行&#x2F;列）向量组的秩</p></blockquote><p><strong>极大线性无关组的求法</strong>：化为行阶梯型矩阵，每行第一个首非零元对应的列向量构成极大线性无关组</p><p><img src="/img/xiandai_img/%E6%9E%81%E5%A4%A7%E7%BA%BF%E6%80%A7%E6%97%A0%E5%85%B3%E7%BB%84%E4%BE%8B%E9%A2%98.png" alt="例题"></p><h2 id="线性方程组的解"><a href="#线性方程组的解" class="headerlink" title="线性方程组的解"></a>线性方程组的解</h2><h3 id="解向量"><a href="#解向量" class="headerlink" title="解向量"></a>解向量</h3><p>若 x1 &#x3D;ξ11 ，x2 &#x3D;ξ21，…，xn &#x3D;ξn 1为方程的解，则x &#x3D; (ξ11，ξ21，…，ξn1)^T为解向量</p><h3 id="基础解系"><a href="#基础解系" class="headerlink" title="基础解系"></a>基础解系</h3><p><strong>齐次</strong>线性方程组的解集的最大无关组（Ax &#x3D; 0解的极大线性无关组），</p><p>特点：基础解系不唯一、线性无关、能表示其他解</p><p>求法：化为行最简型，自由变量取1,0,0…、0,1,0…、….、…0,0,1。<strong>最重要的是求出基础解系的秩!!!</strong></p><h3 id="解的性质"><a href="#解的性质" class="headerlink" title="解的性质"></a>解的性质</h3><p>齐次方程：</p><ol><li>若 x &#x3D;ξ1，x &#x3D;ξ2 为齐次方程的解，则 x &#x3D;ξ1 +ξ2 也是齐次方程的解</li><li>若 x &#x3D;ξ1 为齐次方程的解，k 为实数，则 x &#x3D; kξ1 也是齐次方程的解</li><li><strong>设 m×n 矩阵 A 的秩 R（A）&#x3D; r，则基础解系的秩R &#x3D; n-r</strong>（未知数个数 - 主变量个数）</li><li>当矩阵 A 与 B 的列数相等时，要证 R（A）&#x3D; R（B），只需证明齐次方程 Ax &#x3D; 0 与 Bx &#x3D; 0同解</li></ol><p>非齐次方程：</p><ol><li>设 x &#x3D;η1 及 x &#x3D; η2 都是非齐次的解，则 x &#x3D;η1-η2 为对应的<strong>齐次</strong>线性方程组的解</li><li>设 x &#x3D;η是非齐次的解，x &#x3D;ξ是齐次的解，则 x &#x3D;ξ+η仍是非齐次的解</li><li>非齐次方程的通解 &#x3D;对应的齐次方程的通解+非齐次方程的一个特解</li><li>特解求法：增广矩阵化为行最简型，自由变量都取0</li></ol><p><img src="/img/xiandai_img/%E9%9D%9E%E9%BD%90%E6%AC%A1%E6%96%B9%E7%A8%8B%E8%A7%A3%E4%BE%8B%E9%A2%98.png" alt="非齐次方程的通解例题"></p><h3 id="是否有解的判断"><a href="#是否有解的判断" class="headerlink" title="是否有解的判断"></a>是否有解的判断</h3><p>Ax &#x3D; 0只有零解 &lt;&#x3D;&#x3D;&gt; r(A) &#x3D; n</p><p>Ax &#x3D; 0有非零解 &lt;&#x3D;&#x3D;&gt; r(A) &lt; n</p><p><img src="/img/xiandai_img/%E6%98%AF%E5%90%A6%E6%9C%89%E8%A7%A3%E5%88%A4%E6%96%AD%E4%BE%8B%E9%A2%981.png" alt="例题"></p><p>Ax &#x3D; b无解 &lt;&#x3D;&#x3D;&gt; r(A) &lt; r(A的增广) &lt;&#x3D;&#x3D;&gt; r(A) &#x3D; r(A的增广) - 1</p><p>Ax &#x3D; b有唯一解 &lt;&#x3D;&#x3D;&gt; r(A) &#x3D; r(A的增广) &#x3D; n</p><p>Ax &#x3D; b有无穷多解 &lt;&#x3D;&#x3D;&gt; r(A) &#x3D; r(A的增广) &lt; n</p><p><img src="/img/xiandai_img/%E6%98%AF%E5%90%A6%E6%9C%89%E8%A7%A3%E5%88%A4%E6%96%AD%E4%BE%8B%E9%A2%982.png" alt="例题"></p><h3 id="公共解"><a href="#公共解" class="headerlink" title="公共解"></a>公共解</h3><p><strong>定义</strong></p><p>若a即为线性方程组I的解也为线性方程组II的解，则a为I与II的公共解</p><p><strong>求法</strong></p><ol><li>知道两个方程组，联立</li><li>知道一个方程组和一个方程组的通解，则将通解带入方程组确定参数</li><li>知道两个通解，令其相等来确认参数</li></ol><h3 id="例题-1"><a href="#例题-1" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/xiandai_img/%E5%9F%BA%E7%A1%80%E8%A7%A3%E7%B3%BB%E4%BE%8B%E9%A2%981.png" alt="基础解系表示其他解"></p><p><img src="/img/xiandai_img/%E5%9F%BA%E7%A1%80%E8%A7%A3%E7%B3%BB%E4%BE%8B%E9%A2%982.png" alt="基础解系秩的个数"></p><p><img src="/img/xiandai_img/%E5%9F%BA%E7%A1%80%E8%A7%A3%E7%B3%BB%E4%BE%8B%E9%A2%983.png" alt="根据A的秩求基础解系"></p><p><img src="/img/xiandai_img/%E5%9F%BA%E7%A1%80%E8%A7%A3%E7%B3%BB%E4%BE%8B%E9%A2%984.png" alt="齐次方程通解"></p><p><img src="/img/xiandai_img/%E5%9F%BA%E7%A1%80%E8%A7%A3%E7%B3%BB%E4%BE%8B%E9%A2%985.png" alt="齐次方程通解"></p><p><img src="/img/xiandai_img/%E5%9F%BA%E7%A1%80%E8%A7%A3%E7%B3%BB%E4%BE%8B%E9%A2%986.png" alt="非齐次方程通解"></p><h2 id="向量空间"><a href="#向量空间" class="headerlink" title="向量空间"></a>向量空间</h2><h3 id="概念-5"><a href="#概念-5" class="headerlink" title="概念"></a>概念</h3><p><strong>向量空间</strong>：</p><p>设 V 为 n 维向量的集合，如果集合 V非空，且集合 V 对于向量的加 法及数乘两种运算封闭，那么就称集合 V为<strong>向量空间</strong></p><blockquote><p>封闭，是指在集合 V 中可以进行向量的加法及数乘两种运算.具体地说，就是：若 a∈V，b∈V，则 a+b∈V；若 a ∈V， λ∈R，则λa∈V</p></blockquote><p><strong>子空间</strong>：</p><p>设有向量空间 V1 及 V2，若V1被包含于V2 ，就称 V1 是 V2 的子空间</p><p><strong>r维向量空间</strong>：</p><p>向量组 a1 ，a2 ，…， ar 线性无关，V中向量可由这个向量组表示</p><p>就称为向量空间 V 的一个<strong>基</strong>（极大无关组），r称为向量空间V的<strong>维数</strong>（秩），并称V为<strong>r维向量空间</strong></p><blockquote><p>0维向量只含一个零向量</p><p>单位坐标向量组e1,e2,e3…组成的基称为自然基</p></blockquote><p><strong>坐标</strong>：</p><p>在向量空间 V 中取定一个基 a1，a2，… ，ar，那么 V 中任一向量 x 可惟一地表示为</p><p>x &#x3D;λ1 a1 +λ2 a2 + … +λr ar</p><p>数组λ1，λ2， …，λr 称为向量量x在基a1，a2 ，… ，ar 中的<strong>坐标</strong></p><h3 id="性质"><a href="#性质" class="headerlink" title="性质"></a>性质</h3><ol><li>n元齐次方程的解集是一个向量空间</li><li>n元<strong>非</strong>齐次方程的解集<strong>不是</strong>一个向量空间</li></ol><h3 id="过渡矩阵"><a href="#过渡矩阵" class="headerlink" title="过渡矩阵"></a>过渡矩阵</h3><p><img src="/img/xiandai_img/%E8%BF%87%E6%B8%A1%E7%9F%A9%E9%98%B5.png" alt="新旧基转换"></p><p><img src="/img/xiandai_img/%E6%96%B0%E6%97%A7%E5%9D%90%E6%A0%87%E8%BD%AC%E6%8D%A2.png" alt="新旧坐标转换"></p><h2 id="相似矩阵"><a href="#相似矩阵" class="headerlink" title="相似矩阵"></a>相似矩阵</h2><h3 id="内积"><a href="#内积" class="headerlink" title="内积"></a>内积</h3><p><strong>定义</strong></p><p>x &#x3D; (x1,x2,x3…,xn)^T</p><p>y &#x3D; (y1,y2,y3…,yn)^T</p><p><strong>内积</strong>：[x,y] &#x3D; x1y1 + x2y2 + x3y3 … + xnyn，结果是一个实数</p><p><strong>长度</strong>：||x|| &#x3D; √[x,x] &#x3D; √(x1^2 + x2^2 + …)</p><p><strong>夹角</strong>：arccos ( [x, y] &#x2F; ||x|| ||y|| )</p><blockquote><p>当[x, y] &#x3D; 0时，向量间正交（垂直）</p><p>x&#x3D;0与任何向量正交</p></blockquote><p><strong>性质</strong></p><ul><li>[x，y] &#x3D; [y，x] </li><li>[λx，y] &#x3D; λ[x，y]</li><li>[x+y，z] &#x3D; [x，z] + [y，z]</li><li>当 x &#x3D; 0 时，[x，x] &#x3D; 0；当 x≠0时，[x，x]＞0</li><li>施瓦茨（Schwarz）不等式：[x,y]^2 &lt;&#x3D; [x,x] [y, y]</li></ul><h3 id="正交向量组"><a href="#正交向量组" class="headerlink" title="正交向量组"></a>正交向量组</h3><p><strong>定义</strong></p><p>正交向量组：一组两两正交的非零向量</p><p>标准正交基：一个基e1，…，er 两两正交，且都是单位向量</p><p>单位向量：||x|| &#x3D; 1</p><p>单位化：x &#x3D; a &#x2F; ||a||</p><p><strong>性质</strong></p><ul><li>若 n 维向量 a1，a2， … ，ar 是一组两两正交的非零向量，则 a1， a2，…，ar线性无关</li></ul><h3 id="施密特正交化"><a href="#施密特正交化" class="headerlink" title="施密特正交化"></a>施密特正交化</h3><p><img src="/img/xiandai_img/%E6%96%BD%E5%AF%86%E7%89%B9%E6%AD%A3%E4%BA%A4%E5%8C%96.png"></p><h3 id="正交矩阵-1"><a href="#正交矩阵-1" class="headerlink" title="正交矩阵"></a>正交矩阵</h3><p><strong>定义</strong></p><p>正交矩阵：A^T A &#x3D; E （即 A ^(-1) &#x3D; A^T）</p><p>正交变换：若P为正交矩阵，则线性变换y&#x3D;Px称为正交变换</p><p><strong>性质</strong></p><ul><li>A 的列向量都是<strong>单位向量</strong>，且<strong>两两正交</strong></li><li>若 A 为正交矩阵，则 A^(-1) &#x3D; A^T 也是正交矩阵，且|A| &#x3D; 1 或（-1）</li><li>若 A 和 B 都是正交矩阵，则 A B 也是正交矩阵</li><li>正交变换后线段长度不变：||y|| &#x3D; √(y^T y) &#x3D; √(x^T p^T p x) &#x3D; √(x^T x) &#x3D; ||x||</li><li>|A+E| &#x3D; 0</li></ul><h3 id="相似矩阵-1"><a href="#相似矩阵-1" class="headerlink" title="相似矩阵"></a>相似矩阵</h3><p><strong>定义</strong></p><p>有可逆矩阵P，使得P^-1 A P &#x3D; B，称A与B相似，记作A~B</p><p><img src="/img/xiandai_img/P%E7%9A%84%E7%BB%84%E6%88%90.png" alt="P的组成"></p><p><strong>性质</strong></p><ul><li>A和B相似，则特征多项式、特征值、行列式、秩、迹（对角线元素之和）相同</li><li>若n阶矩阵A与对角矩阵相似，则对角线上元素λ1，λ2，…，λn 即是 A 的n个特征值</li><li>n 阶矩阵 A 与对角矩阵相似（即 A 能对角化）的充分必要条件是 A 有 n 个线性无关的特征向量</li><li>如果 n 阶矩阵 A 的 n 个特征值互不相等，则 A 与对角矩阵相似</li></ul><p><strong>充要条件</strong></p><p>n阶矩阵可相似对角化 &lt;&#x3D;&#x3D;&gt;</p><p>A有n个线性无关的特征向量 &lt;&#x3D;&#x3D;&gt;</p><p>k重特征值有k个线性无关的特征向量</p><p><strong>充分条件</strong></p><p>n阶矩阵可相似对角化 &lt;&#x3D;&#x3D;</p><ol><li>A有n个不同的特征值</li><li>A为实对称矩阵（A &#x3D; A^T）</li></ol><h3 id="相似矩阵例题"><a href="#相似矩阵例题" class="headerlink" title="相似矩阵例题"></a>相似矩阵例题</h3><p><img src="/img/xiandai_img/%E6%98%AF%E5%90%A6%E8%83%BD%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_img/%E7%9B%B8%E4%BC%BC%E7%9F%A9%E9%98%B5%E4%BE%8B%E9%A2%982.png" alt="相似矩阵求特征值"></p><h2 id="特征值、特征向量"><a href="#特征值、特征向量" class="headerlink" title="特征值、特征向量"></a>特征值、特征向量</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p><strong>特征值</strong>：设A是<strong>n阶矩阵</strong>，如果数λ和 n 维非零列向量 x 使关系式 A x &#x3D;λx成立，那么数λ称为矩阵A的特征值</p><p><strong>特征向量</strong>：<strong>非零向量</strong>x称为A的对应于特征值λ的特征向量</p><p><strong>特征方程和特征多项式</strong>：</p><p><img src="/img/xiandai_img/%E7%89%B9%E5%BE%81%E6%96%B9%E7%A8%8B%E5%92%8C%E7%89%B9%E5%BE%81%E5%A4%9A%E9%A1%B9%E5%BC%8F.png"></p><h3 id="性质-1"><a href="#性质-1" class="headerlink" title="性质"></a>性质</h3><ol><li>λ1 +λ2 +…+λn &#x3D; a11 +a22 +…+ann &#x3D; tr(A)（特征值之和等于对角线元素相加）</li><li>λ1 λ2 … λn &#x3D; |A|。若特征值不全为0，则A可逆</li><li><strong>若r(A) &#x3D; 1，则λ1 &#x3D; α^Tβ &#x3D; αβ^T &#x3D; tr(A)，其他特征值为0</strong>（α为极大无关组，β为系数）</li><li>n阶矩阵有n个特征值</li><li>若λ是 A 的特征值，则λ^k 是 A^k 的特征值</li><li><strong>若λ是 A 的特征值，则φ（λ）是 φ（A）的特征值</strong>（其中φ（λ）&#x3D; a0 +a1λ+…+am λ^m 是λ的多项式，φ（A）&#x3D; a0 E + a1 A +…+am A^m 是矩阵 A 的多项式）</li><li>特征值各不相同，对应的特征向量线性无关</li><li>两个特征值不同，对应的向量组线性无关</li><li>不同特征值的特征向量之和不是特征向量</li><li><img src="/img/xiandai_img/A%E4%B8%8E%E7%89%B9%E5%BE%81%E5%80%BC%E7%9A%84%E5%85%B3%E7%B3%BB.png"></li></ol><h3 id="例题-2"><a href="#例题-2" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/xiandai_img/%E6%B1%82%E7%89%B9%E5%BE%81%E5%80%BC%E5%92%8C%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F%E4%BE%8B%E9%A2%981.png" alt="求2阶矩阵的特征值和特征向量"></p><p><img src="/img/xiandai_img/%E6%B1%82%E7%89%B9%E5%BE%81%E5%80%BC%E5%92%8C%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F%E7%9A%84%E4%BE%8B%E9%A2%982.png" alt="求3阶矩阵的特征值和特征向量"></p><p><img src="/img/xiandai_img/%E7%89%B9%E5%BE%81%E5%80%BC%E6%80%A7%E8%B4%A85%E7%9A%84%E4%BE%8B%E9%A2%98.png" alt="特征值性质5的例题"></p><h2 id="实对称矩阵"><a href="#实对称矩阵" class="headerlink" title="实对称矩阵"></a>实对称矩阵</h2><h3 id="性质-2"><a href="#性质-2" class="headerlink" title="性质"></a>性质</h3><ul><li>特征值均为实数</li><li>实对称矩阵可相似对角化</li><li>r(A) &#x3D; 非零特征值的个数</li><li>不同特征值的特征向量正交</li><li>k重特征值有k个线性无关的特征向量</li><li>设 A 为 n 阶对称矩阵，则必有正交矩阵 P，使 P^-1 A P &#x3D; P^T A P &#x3D;Λ，其 中Λ 是以 A 的 n 个特征值为对角元的对角矩阵</li></ul><h3 id="实对称矩阵对角化"><a href="#实对称矩阵对角化" class="headerlink" title="实对称矩阵对角化"></a>实对称矩阵对角化</h3><p><strong>步骤</strong></p><ol><li>求n个特征值λ1，…，λn</li><li>求n个线性无关的特征向量</li><li>将特征向量正交化、单位化得正交矩阵P，从而P^-1 A P &#x3D; P^T A P &#x3D; Λ</li></ol><h3 id="知特征值和特征向量求原矩阵"><a href="#知特征值和特征向量求原矩阵" class="headerlink" title="知特征值和特征向量求原矩阵"></a>知特征值和特征向量求原矩阵</h3><p><img src="/img/xiandai_img/%E7%9F%A5%E7%89%B9%E5%BE%81%E5%80%BC%E5%92%8C%E7%89%B9%E5%BE%81%E5%90%91%E9%87%8F%E6%B1%82%E7%9F%A9%E9%98%B5.png"></p><h3 id="例题-3"><a href="#例题-3" class="headerlink" title="例题"></a>例题</h3><p><img src="/img/xiandai_img/%E5%AF%B9%E8%A7%92%E5%8C%96%E4%BE%8B%E9%A2%981.png" alt="求正交矩阵"></p><h2 id="二次型"><a href="#二次型" class="headerlink" title="二次型"></a>二次型</h2><h3 id="二次型-1"><a href="#二次型-1" class="headerlink" title="二次型"></a>二次型</h3><p><strong>定义</strong></p><p>含有 n 个变量 x1， x 2 ，… ， xn 的二次齐次函数 f(x1, x2, …, xn) &#x3D; (a11 x1^2) + (a22 x2^2) + … + (ann xn^2) + (2a12 x1 x2) + (2a13 x1 x3) + … + (2an-1,n xn-1 xn)，称为二次型</p><p>二次型可以用矩阵记作<strong>f &#x3D; x^T A x</strong>，<strong>A为实对称矩阵</strong>，实对称矩阵和二次型一一对应</p><p>秩：实对称矩阵A的秩就为二次型的秩</p><p><img src="/img/xiandai_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E5%AE%9A%E4%B9%89.png"></p><h3 id="二次型-例题"><a href="#二次型-例题" class="headerlink" title="二次型(例题)"></a>二次型(例题)</h3><p><img src="/img/xiandai_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%981.png" alt="求二次型的秩"></p><h3 id="标准型、规范型"><a href="#标准型、规范型" class="headerlink" title="标准型、规范型"></a>标准型、规范型</h3><p>标准型：只含平方项的二次型</p><p>规范型：系数都为1、-1、0的<strong>标准型</strong></p><p>正惯性指数p：标准型中系数为正的个数</p><p>负惯性指数q：标准型中系数为负的个数</p><p>惯性定理：二次型的标准型不是唯一的，但标准型的正负惯性指数个数是相同的</p><h3 id="合同矩阵"><a href="#合同矩阵" class="headerlink" title="合同矩阵"></a>合同矩阵</h3><p><strong>定义</strong></p><p><img src="/img/xiandai_img/%E5%90%88%E5%90%8C%E7%9F%A9%E9%98%B5%E5%AE%9A%E4%B9%89.png"></p><p><strong>充要条件</strong></p><p>A、B合同 &lt;&#x3D;&#x3D;&gt;</p><p>r(A) &#x3D; r(B) &lt;&#x3D;&#x3D;&gt;</p><p>二次型x^T A x 和x^T B x有相同的正、负惯性指数 &lt;&#x3D;&#x3D;&gt;</p><p>A、B有相同的正、负特征值的个数</p><h3 id="二次型化标准型求法"><a href="#二次型化标准型求法" class="headerlink" title="二次型化标准型求法"></a>二次型化标准型求法</h3><ul><li><strong>正交变换法</strong></li></ul><ol><li>求A的n个特征值</li><li>求A的n个线性无关的特征向量</li><li>将特征向量正交化得正交矩阵Q，x &#x3D; Qy，二次型化为标准型f &#x3D; (λ1 y1^2) + (λ2 y2^2) + … + (λn yn^2)</li></ol><ul><li><strong>拉格朗日配方法</strong></li></ul><h3 id="标准型-例题"><a href="#标准型-例题" class="headerlink" title="标准型(例题)"></a>标准型(例题)</h3><p><img src="/img/xiandai_img/%E4%BA%8C%E6%AC%A1%E5%9E%8B%E5%8C%96%E4%B8%BA%E6%A0%87%E5%87%86%E5%9E%8B%E4%BE%8B%E9%A2%981.png"></p><p><img src="/img/xiandai_img/%E9%85%8D%E6%96%B9%E6%B3%95%E5%8C%96%E4%BA%8C%E6%AC%A1%E5%9E%8B%E4%BE%8B%E9%A2%981.png" alt="配方法(含平方时)"></p><h3 id="正定二次型"><a href="#正定二次型" class="headerlink" title="正定二次型"></a>正定二次型</h3><p><strong>定义</strong></p><p>二次型f &#x3D; x^T A x，对任意的x ≠ 0，有x^T A x &gt; 0，则f为正定二次型，A为正定矩阵</p><p>如果x^T A x &lt; 0，则为负定二次型</p><p><strong>充要条件</strong></p><p>f &#x3D; x^T A x正定 &lt;&#x3D;&#x3D;&gt;</p><ul><li>正惯性指数为n</li><li>A与E合同，则存在可逆矩阵C，使得C^T A C &#x3D; E</li><li>A的特征值均大于0</li><li><strong>A的顺序主子式均大于0</strong></li></ul><blockquote><p><img src="/img/xiandai_img/%E9%A1%BA%E5%BA%8F%E4%B8%BB%E5%AD%90%E5%BC%8F.png" alt="顺序主子式"></p></blockquote><h3 id="正定二次型-例题"><a href="#正定二次型-例题" class="headerlink" title="正定二次型(例题)"></a>正定二次型(例题)</h3><p><img src="/img/xiandai_img/%E6%AD%A3%E5%AE%9A%E4%BA%8C%E9%A1%B9%E5%BC%8F%E4%BE%8B%E9%A2%981.png" alt="正定二次型性质"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>日语</title>
    <link href="/2024/04/24/%E8%80%83%E7%A0%94/%E6%97%A5%E8%AF%AD/"/>
    <url>/2024/04/24/%E8%80%83%E7%A0%94/%E6%97%A5%E8%AF%AD/</url>
    
    <content type="html"><![CDATA[<h1 id="日语"><a href="#日语" class="headerlink" title="日语"></a>日语</h1><h2 id="时间相关"><a href="#时间相关" class="headerlink" title="时间相关"></a>时间相关</h2><h3 id="が早いか"><a href="#が早いか" class="headerlink" title="が早いか"></a>が早いか</h3><p>意味：ほぼ同時発生</p><p>接续：动词原型 + が早いか，后文跟意志动词，陈述</p><p>例：</p><p>１．チャイムが鳴るが早いか学生は教室を飛び出した</p><p>２．久しぶりの彼女の顔を見るが早いか、すぐに抱きしめた</p><h3 id="や否や"><a href="#や否や" class="headerlink" title="や否や"></a>や否や</h3><p>意味：</p><p>​ある動作をすると、ほぼ同時に別の出来事が起こる。</p><p>​和～か～ないかのうちに意思相同</p><p>接续：Vる＋や否や，后文跟意志型较多</p><p>例：</p><p>１．お店が開店するや否や、多くの人々がお店に入っていった</p><p>２．日付が変わるや否や、彼女は私の誕生日を祝ってくれた</p><h3 id="なり"><a href="#なり" class="headerlink" title="なり"></a>なり</h3><p>意味：同時に</p><p>接续：Vる＋なり，后跟不好、预料外的事</p><p>例：</p><p>１．会うなりビンタされるとは思わなかった</p><h3 id="そばから"><a href="#そばから" class="headerlink" title="そばから"></a>そばから</h3><p>意味：すぐに同じことが繰り返される様子を表します</p><p>接续：Vる・Vた＋そばから</p><p>例：</p><p>１．覚えたそばから忘れていく</p><p>２．トイレ行ったそばからもうトイレ行きたい</p><h3 id="てからというもの"><a href="#てからというもの" class="headerlink" title="てからというもの"></a>てからというもの</h3><p>意味：自那之后</p><p>接续：Vて＋からというもの</p><p>例：</p><p>１．彼女ができてからというもの、お洒落を気にするようになった</p><h3 id="にあって"><a href="#にあって" class="headerlink" title="にあって"></a>にあって</h3><p>意味：において</p><p>接续：N＋にあって，前面为特殊的情况</p><p>例：</p><p>１．この不景気にあって、私たちがすべきことは何だと思いますか</p><p>２．相互理解と言うのは、戦場にあっては難しい</p><h2 id="范围相关"><a href="#范围相关" class="headerlink" title="范围相关"></a>范围相关</h2><h3 id="～を皮切りに（して）・～を皮切りとして"><a href="#～を皮切りに（して）・～を皮切りとして" class="headerlink" title="～を皮切りに（して）・～を皮切りとして"></a>～を皮切りに（して）・～を皮切りとして</h3><p>意味：以…为开始、出発点，后面跟<strong>同类事物</strong></p><p>接续：N＋を皮切りに（して）、Vる&#x2F;た＋の＋を皮切りに（して）</p><p>例：</p><p>１．日本を皮切りにして、現在はいろんな国に旅をしている</p><p>２．彼が意見を言ったのを皮切りに、皆意見を言い始めた</p><h3 id="～に至るまで"><a href="#～に至るまで" class="headerlink" title="～に至るまで"></a>～に至るまで</h3><p>意味：从<del>到</del>，范围广</p><p>接续：（～から）＋N＋に至るまで</p><p>例：</p><p>１．病気は完治に至るまで、１０年ほどかかった</p><p>２．子供から大人に至るまで人気がある</p><h3 id="～を限りに"><a href="#～を限りに" class="headerlink" title="～を限りに"></a>～を限りに</h3><p>意味：以..时间为界（残念な気持ちを含む）</p><p>接续：N＋を限りに</p><p>例：</p><p>１．今日を限りにタバコをやめます</p><p>２．二人はその日を限りに、二度と合わなかった</p><h3 id="～をもって"><a href="#～をもって" class="headerlink" title="～をもって"></a>～をもって</h3><p>意味：開始あるいは終了</p><p>接续：N＋をもって</p><p>例：</p><p>１．9月をもって、閉店します</p><h3 id="～といったところだ"><a href="#～といったところだ" class="headerlink" title="～といったところだ"></a>～といったところだ</h3><p>意味：程度は最高でも，顶天不过是…</p><p>接续：数词＋といったところだ</p><p>例：</p><p>１．今年の夏のボーナスは手取りで４０万といったところだろう</p><h2 id="限定、非限定"><a href="#限定、非限定" class="headerlink" title="限定、非限定"></a>限定、非限定</h2><h3 id="をおいて"><a href="#をおいて" class="headerlink" title="~をおいて"></a>~をおいて</h3><p>意味：除了…之外就没有了</p><p>接续：N＋をおいて</p><p>例：</p><p>１．この仕事を任せるのは山田さんをおいて他にいないです</p><p>２．転職するなら今をおいて他にない</p><p>３．何をおいても必ず出席したい</p><h3 id="～ならでは"><a href="#～ならでは" class="headerlink" title="～ならでは"></a>～ならでは</h3><p>意味：只有…才有的特征</p><p>接续：N＋ならでは</p><p>例：</p><p>１．この味はこの店ならではだ</p><h3 id="～にとどまらず"><a href="#～にとどまらず" class="headerlink" title="～にとどまらず"></a>～にとどまらず</h3><p>意味：不局限于…范围</p><p>接续：N・V（普通形）＋にとどまらず</p><p>例：</p><p>１．癌は肺にとどまらず、全身へと移転している</p><p>２．女性にとどまらず、男性にも人気だそうだ</p><p>３．留学センターでは日本語の知識を教えるにとどまらず、就職や進学のサポートも行なっている</p><h3 id="～はおろか"><a href="#～はおろか" class="headerlink" title="～はおろか"></a>～はおろか</h3><p>意味：…A就不用说了，B更甚</p><p>接续：N＋はおろか</p><p>例：</p><p>１．私は車はおろか自転車にも乗れません</p><p>２．走ることはおろか、歩くことさえも難しい</p><h3 id="～もさることながら"><a href="#～もさることながら" class="headerlink" title="～もさることながら"></a>～もさることながら</h3><p>意味：…自不必说、然る事ながら</p><p>接续：N＋もさることながら</p><p>例：</p><p>１．その顔の美しさもさろことながら、何より声が素敵</p><p>２．給料がいいのもさることながら、人間関係がいい</p><h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><h3 id="～なり…なり"><a href="#～なり…なり" class="headerlink" title="～なり…なり"></a>～なり…なり</h3><p>意味：AでもBでもいいから、とりあえず。。。</p><p>接续：V・N＋なり＋V・N＋なり</p><p>例：</p><p>１．大学なり専門学校なり、とにかくどこでもいいから学校に入りたい</p><p>２．わからないことがあったら、先生に聞くなり、辞書で調べるなりしてください</p><h3 id="～であれ…であれ・～であろうと…であろうと"><a href="#～であれ…であれ・～であろうと…であろうと" class="headerlink" title="～であれ…であれ・～であろうと…であろうと"></a>～であれ…であれ・～であろうと…であろうと</h3><p>意味：～でも～でも関係なく</p><p>接续：N＋であれ＋N＋であれ</p><p>例：</p><p>１．私は仕事であれ遊びであれ、なんでも一生懸命にやる</p><p>２．正社員であろうとアルバイトであろうと、お客様には丁寧に接客してください</p><h3 id="～といい…といい"><a href="#～といい…といい" class="headerlink" title="～といい…といい"></a>～といい…といい</h3><p>意味：举出方面评价</p><p>接续：N＋といい＋N＋といい</p><p>例：</p><p>１．彼は顔といい性格といい、全てはパーフェクトだ</p><p>２．このホテルは部屋といいサービスといい、とても素晴らしい</p><h3 id="～といわず…といわず"><a href="#～といわず…といわず" class="headerlink" title="～といわず…といわず"></a>～といわず…といわず</h3><p>意味：不论…都</p><p>接续：N＋といわず＋N＋といわず</p><p>例：</p><p>１．息子は食事中といわず入浴といわず、ずっとスマホを見ている</p><p>２．男といわず女といわず、人は誰でも平等であるべきだ</p><h2 id="有关、无关"><a href="#有关、无关" class="headerlink" title="有关、无关"></a>有关、无关</h2><h3 id="～いかんだ"><a href="#～いかんだ" class="headerlink" title="～いかんだ"></a>～いかんだ</h3><p>意味：次第だ</p><p>接续：N（の）＋いかんだ</p><p>例：</p><p>１．N1に合格できるかどうかは君たちの努力いかんだ</p><p>２．入学試験の結果いかんで、奨学金がもらえるかどうかが決まる</p><p>３．今期の業績のいかんでは、ボーナスが減る可能性もある</p><p>４．今後君の態度いかんによっては考えないこともない</p><h3 id="～いかんにかかわらず・～いかんによらず・～いかを問わず"><a href="#～いかんにかかわらず・～いかんによらず・～いかを問わず" class="headerlink" title="～いかんにかかわらず・～いかんによらず・～いかを問わず"></a>～いかんにかかわらず・～いかんによらず・～いかを問わず</h3><p>意味：与…无关、にかかわらず</p><p>接续：N（の）＋いかんにかかわらず</p><p>例：</p><p>１．天候のいかんにかかわらず、開会式は予定通り行います</p><p>２．試験成績のいかん<strong>を</strong>問わず、出席率が８０パーセント未満の学生は進級できません</p><h3 id="～をものともせず（に）"><a href="#～をものともせず（に）" class="headerlink" title="～をものともせず（に）"></a>～をものともせず（に）</h3><p>意味：不畏…困难，克服…困难</p><p>接续：N＋をものともせず（に）</p><p>例：</p><p>１．彼は足の怪我をものともせず大会に出場することを決まる</p><p>２．A社は不況の影響をものともせずに、順調に業績を伸ばしている</p><h3 id="～をよそに"><a href="#～をよそに" class="headerlink" title="～をよそに"></a>～をよそに</h3><p>意味：不在意…的感情、意见</p><p>接续：N＋をよそに</p><p>例：</p><p>１．親の反対をよそに、彼と結婚しました</p><p>２．家族の心配をよそに、彼女はYoutuberになることを決めた</p><h3 id="～ならいざしらず"><a href="#～ならいざしらず" class="headerlink" title="～ならいざしらず"></a>～ならいざしらず</h3><p>意味：如果是…也好，但现在…</p><p>接续：N＋Vる＋ならいざしらず</p><p>例：</p><p>１．１５年前ならいざしらず、現在はスマホなしでは生活できないよ</p><p>２．始めてとか2回目とかいざしらず、経験者が失敗するのは許されない</p><h2 id="样子"><a href="#样子" class="headerlink" title="样子"></a>样子</h2><h3 id="んばかりだ"><a href="#んばかりだ" class="headerlink" title="~んばかりだ"></a>~んばかりだ</h3><p>意味：動作の程度</p><p>接续：動ない形＋んばかり</p><p>例：</p><p>１．頭が割れんばかりの頭痛に悩んでいる</p><p>２．合格通知を受け取った学生は、今に飛び上がらんばかりに喜んだ</p><p>３．部長の態度は、今回の失敗は僕の責任だと言わんばかりだ</p><h3 id="～とばかり（に）"><a href="#～とばかり（に）" class="headerlink" title="～とばかり（に）"></a>～とばかり（に）</h3><p>意味：像是要…的样子</p><p>接续：発話文＋とばかりに</p><p>例：</p><p>１．大変な仕事を頼まれたが、彼は任せろとばかりに胸を叩いた</p><p>２．今がチャンスとばかりに、チャンピオンは猛烈な攻撃が始めた</p><h3 id="～ともかく・ともなしに"><a href="#～ともかく・ともなしに" class="headerlink" title="～ともかく・ともなしに"></a>～ともかく・ともなしに</h3><p>意味：无意识的做某事，不知道从..开始</p><p>接续：Vる＋ともかく・疑問詞＋（助词）＋ともなく</p><p>例：</p><p>１．考えともなく仕事のことを考えていたら・レポートを忘れていることを思い出した</p><p>２．長い間日本に住んでいたら、覚えともなく自然と日本語が身に付きました</p><p>３．社長が歌い始めると、誰からともなしに手拍子を始める</p><p>４．彼はいつからともなくクラスのリーダー的存在になっていた</p><h3 id="～ながらに（して）"><a href="#～ながらに（して）" class="headerlink" title="～ながらに（して）"></a>～ながらに（して）</h3><p>意味：そのまま変化しないで続く状態や様子を表す</p><p>接续：N・Vます＋ながら</p><p>例：</p><p>１．彼女は生まれながらにして、ピアノの才能があった</p><p>２．うちにいながらにして、世界中の人と交流することができる</p><h3 id="～きらいがある"><a href="#～きらいがある" class="headerlink" title="～きらいがある"></a>～きらいがある</h3><p>意味：良くない傾向がある</p><p>接续：Vる・ない＋きらいがある、N＋のきらいがある</p><p>例：</p><p>１．彼は大げさに話すきらいがある</p><p>２．最近の若い学生は少し積極性に欠けるきらいがある</p><h2 id="附属行动"><a href="#附属行动" class="headerlink" title="附属行动"></a>附属行动</h2><h3 id="～がてら"><a href="#～がてら" class="headerlink" title="～がてら"></a>～がてら</h3><p>意味：顺便、一个动作两个目的</p><p>接续：動ます形・名詞＋がてら</p><p>例：</p><p>１．友人を駅まで送りがてら、買い物して来た</p><p>２．仕事で大阪に行きがてら、観光しました</p><p>３．療養中の父の様子を見に行きがてら、実家に帰った</p><h3 id="～かたがた"><a href="#～かたがた" class="headerlink" title="～かたがた"></a>～かたがた</h3><p>意味：正式场合，一个行动两个目的</p><p>接续：N＋かたがた</p><p>例：</p><p>１．近くに寄ったので、先日のお礼かたがた挨拶に伺いました</p><p>２．結婚のお祝いかたがた私の近況をご報告します</p><h3 id="～かたわら"><a href="#～かたわら" class="headerlink" title="～かたわら"></a>～かたわら</h3><p>意味：边做本职工作边。。。</p><p>接续：名詞＋のかたわら、動詞形＋かたわら</p><p>例：</p><p>１．佐藤さんは会社勤務のかたわら、大学院で言語学を研究している</p><p>２．彼女はアイドルとして活動するかたわら、人気ミステリー小説を書いている</p><h2 id="转折"><a href="#转折" class="headerlink" title="转折"></a>转折</h2><h3 id="ところを"><a href="#ところを" class="headerlink" title="~ところを"></a>~ところを</h3><p>意味：迷惑・負担をかけて申し訳ない</p><p>接续：普通形＋ところ（を）</p><p>例：</p><p>１．お忙しいところを申し訳ございませんが、よろしくお願いします</p><p>２．お休みのところ大変申し訳ございませんが、急ぎですのでこの書類に目を通していただけませんか</p><h3 id="～ものを"><a href="#～ものを" class="headerlink" title="～ものを"></a>～ものを</h3><p>意味：明明…就好了，却没有那么做。责备语气</p><p>接续：V普＋ものを</p><p>例：</p><p>１．薬を飲んだら良くなるものを</p><p>２．黙っていれば誰にも知らなかったものを</p><h3 id="～とはいえ"><a href="#～とはいえ" class="headerlink" title="～とはいえ"></a>～とはいえ</h3><p>意味：～だが、それでもやはり～だ</p><p>接续：普通形＋とはいえ</p><p>例：</p><p>１．春になったとはいえ、まだ寒い日もある</p><p>２．家族とはいえ、お金の貸し借りはしないほうがいい</p><h3 id="～といえども"><a href="#～といえども" class="headerlink" title="～といえども"></a>～といえども</h3><p>意味：就算是…，但是…</p><p>接续：普通形＋といえども</p><p>例：</p><p>１．いかに体にいいといえども、たべすぎたら意味がない</p><p>２．どんなに美味しいと、唐揚げに一万円は出せない</p><p>３．ぎりぎりだといえども、合格したことは喜ぶべきだ</p><h3 id="～（か）と思いきや"><a href="#～（か）と思いきや" class="headerlink" title="～（か）と思いきや"></a>～（か）と思いきや</h3><p>意味：以为是..却不是</p><p>接续：動詞普通形・名詞＋の・文＋（か）と思いきや</p><p>例：</p><p>１．女の人だと思いきや髪が長い男の人だった</p><p>２．会議にギリギリ間に合ったかと思いきや、部屋を間違えてしまった</p><p>３．二人は付き合っていると思いきや、ただの友達だと言われた</p><h2 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h2><h3 id="～とあれば"><a href="#～とあれば" class="headerlink" title="～とあれば"></a>～とあれば</h3><p>意味：特別な条件</p><p>接续：普通形＋とあれば</p><p>例：</p><p>１．両親に挨拶に行ったとあれば、彼がプロポーズするのも時間の問題だ</p><p>２．彼は金のためとあれば、手段を選ばない</p><h3 id="～たら最後・たが最後"><a href="#～たら最後・たが最後" class="headerlink" title="～たら最後・たが最後"></a>～たら最後・たが最後</h3><p>意味：一旦Aをしたら、その後ずっとBだ</p><p>接续：V（タ形）＋ら最後・が最後</p><p>例：</p><p>１．彼にお金を貸したら最後、連絡がつかなくなるから気を付けて</p><p>２．このアプリを起動したら最後、ついつい何時間も使ってしまう</p><h3 id="～ようでは"><a href="#～ようでは" class="headerlink" title="～ようでは"></a>～ようでは</h3><p>意味：もしその様子だったら、いつか良くない結果になる</p><p>接续：普通形＋ようでは</p><p>例：</p><p>１．文句ばかり言っているようでは、幸せになる日は遠いだろう</p><p>２．ご飯も食べずに働いているようでは、体を壊してしてしまいますよ</p><h3 id="～なしに（は）・～なしでは・～なくして（は）"><a href="#～なしに（は）・～なしでは・～なくして（は）" class="headerlink" title="～なしに（は）・～なしでは・～なくして（は）"></a>～なしに（は）・～なしでは・～なくして（は）</h3><p>意味：もしAがなかったら、Bができない</p><p>接续：V（辞書形）＋ことなしに・N＋なしに</p><p>例：</p><p>１．子育てを取り巻く環境を整えることなしに、少子化は止められない</p><p>2.彼なしに、このプロジェクトの成功は有り得なかった</p><h3 id="～くらいなら"><a href="#～くらいなら" class="headerlink" title="～くらいなら"></a>～くらいなら</h3><p>意味：与其..宁可</p><p>接续：V（辞書形）＋くらいなら</p><p>例：</p><p>１．何もしないで後悔するくらいなら、行動して後悔したほうがいい</p><p>２．あんな人と結婚するぐらいなら、一生独身のままでいたほうがいい</p><h2 id="逆接条件"><a href="#逆接条件" class="headerlink" title="逆接条件"></a>逆接条件</h2><h3 id="ようとも・～ようが"><a href="#ようとも・～ようが" class="headerlink" title="~ようとも・～ようが"></a>~ようとも・～ようが</h3><p>意味：とも関係なく…だ</p><p>接续：</p><p>​V（意向形）＋が</p><p>​イA<del>い</del>＋かろうが</p><p>​ナAだろう＋が</p><p>​Nだろう＋が</p><p>例：</p><p>１．使わないものは、いくら安かろうと買う必要はない</p><p>２．誰に何を言われようと決意は変わらない</p><h3 id="～ようと～まいと・よいが～まいが"><a href="#～ようと～まいと・よいが～まいが" class="headerlink" title="～ようと～まいと・よいが～まいが"></a>～ようと～まいと・よいが～まいが</h3><p>意味：～しても、しなくても、同じだ</p><p>例：</p><p>１．両親が賛成しようとするまいと、彼と結婚します</p><p>２．学歴があろうとなかろうと、優秀であればどんな人でも採用したい</p><p>３．君が信じようが信じまいが、俺は盗んでない</p><p>４．親が納得しようがしまいが、私は自分の選んだ道を進むと決めました</p><h3 id="～であれ・～であろうと"><a href="#～であれ・～であろうと" class="headerlink" title="～であれ・～であろうと"></a>～であれ・～であろうと</h3><p>意味：Aでも関係なく</p><p>接续：N・疑問詞＋であれ・であろうと</p><p>例：</p><p>１．結果がどうであれ、努力することが大切だ</p><p>２．たとえ仲がいい友達であれ、お金の貸し借りはしないほがいい</p><h3 id="～たところで"><a href="#～たところで" class="headerlink" title="～たところで"></a>～たところで</h3><p>意味：たとえAになっても、無駄だ</p><p>接续：た形＋ところで</p><p>例：</p><p>１．いまからタクシーで行ったところで、飛行機に間に合わない</p><p>２．いくら文法を勉強したところで、話さなければ日本語は上手にならない</p><h3 id="～ば～で・～なら～で・～たら～たで"><a href="#～ば～で・～なら～で・～たら～たで" class="headerlink" title="～ば～で・～なら～で・～たら～たで"></a>～ば～で・～なら～で・～たら～たで</h3><p>意味：想像と違い、問題はない・問題がある</p><p>接续：～れば～で</p><p>例：</p><p>１．恋人がいたらいたで、面倒なことが多くなるよ</p><p>２．試験に落ちたらおちたで、また来年受けるだけだ</p><p>３．背が高ければ高いで、いろんな所にぶつかるし、乗り物の座席は狭いし、大変です</p><h2 id="目的・手段"><a href="#目的・手段" class="headerlink" title="目的・手段"></a>目的・手段</h2><h3 id="べく"><a href="#べく" class="headerlink" title="~べく"></a>~べく</h3><p>意味：はっきりした目的を解決ために</p><p>接续：動詞辞書形＋べく</p><p>例：</p><p>１．人手不足という問題を解決すべく、社内で緊急会議が開かれた</p><p>２．顧客の期待に応えるべく、商品開発を進めてきました</p><p>３．市は子供の命を守るべく、防犯カメラを増やすことを決定した</p><h3 id="～んがため（に）"><a href="#～んがため（に）" class="headerlink" title="～んがため（に）"></a>～んがため（に）</h3><p>意味：～するために</p><p>接续：V（ナイ形）＋んがため（に）</p><p>例：</p><p>１．息子を大学に合格させんがために、大学に裏金を渡した</p><p>２．JLPTに合格せんがために、毎日１０時間以上勉強を続けている</p><h3 id="～をもって-1"><a href="#～をもって-1" class="headerlink" title="～をもって"></a>～をもって</h3><p>意味：Aを使って</p><p>接续：名詞＋をもって</p><p>例：</p><p>１．審査の結果は、２週間以内に書面をもってお知らせします</p><p>２．レポートの提出をもって卒業試験の代わりとする</p><h2 id="原因、理由"><a href="#原因、理由" class="headerlink" title="原因、理由"></a>原因、理由</h2><h3 id="ばこそ"><a href="#ばこそ" class="headerlink" title="~ばこそ"></a>~ばこそ</h3><p>意味：からこそ</p><p>接续：ば形＋こそ</p><p>例：</p><p>１．愛していればこそ、別れという選択をする人もいるのだ</p><p>２．娘の将来を思えばこそ、彼との結婚には賛成できない</p><p>３．頭が良ければこそ、他の人には理解できない悩みがあるんです</p><h3 id="～とあって"><a href="#～とあって" class="headerlink" title="～とあって"></a>～とあって</h3><p>意味：特殊なAという状況なので、当然Bだ</p><p>接续：普通形＋とあって</p><p>例：</p><p>１．2年ぶりの再会とあって、お互い話したいことが山のようにあった</p><p>２．このうどん屋は量が多くて安いとあって、学生に人気があります</p><h3 id="～ではあるまいし"><a href="#～ではあるまいし" class="headerlink" title="～ではあるまいし"></a>～ではあるまいし</h3><p>意味：Aじゃないのだから、B</p><p>接续：N＋ではあるまいし・V普＋わけではあるまいし</p><p>例：</p><p>１．子供じゃあるまいし、そんなこと自分で考えろ</p><p>２．一生会えないわけではあるまいし、いつまでも泣くんじゃない</p><h3 id="～手前"><a href="#～手前" class="headerlink" title="～手前"></a>～手前</h3><p>意味：Aしてしまったから、Bしなければならない</p><p>接续：Vる・Vた＋手前、Nの手前</p><p>例：</p><p>１．参加すると言ってしまった手前、今さら飲み会をキャンセルなんてできない</p><p>２．彼女の手前、この試合に負けるわけにはいかない</p><h3 id="～ゆえ（に）"><a href="#～ゆえ（に）" class="headerlink" title="～ゆえ（に）"></a>～ゆえ（に）</h3><p>意味：AだからB</p><p>接续：普通形・名詞（の）＋ゆえ（に）</p><p>例：</p><p>１．我思う、ゆえに我あり</p><p>２．失敗を恐れるゆえに、挑戦しない若者が増えてきている</p><h2 id="可能、不可能"><a href="#可能、不可能" class="headerlink" title="可能、不可能"></a>可能、不可能</h2><h3 id="～にかたくない"><a href="#～にかたくない" class="headerlink" title="～にかたくない"></a>～にかたくない</h3><p>意味：Aすることは難しくない</p><p>接续：動詞辞書形・名詞＋にかたくない</p><p>例：</p><p>１．彼の生い立ちを聞くと、子供のときの彼の苦しみは想像に難くない</p><h3 id="～に～ない・～（よ）うにも～ない"><a href="#～に～ない・～（よ）うにも～ない" class="headerlink" title="～に～ない・～（よ）うにも～ない"></a>～に～ない・～（よ）うにも～ない</h3><p>意味：Aしたいけど、理由があってできない</p><p>接续：動詞の辞書形・意向形＋に＋可能動詞の否定形</p><p>例：</p><p>１．彼女から１週間も連絡が来なくて、勉強するに勉強できない</p><p>２．うるさくて、寝ようにも寝られません</p><h3 id="～て（は）いられない"><a href="#～て（は）いられない" class="headerlink" title="～て（は）いられない"></a>～て（は）いられない</h3><p>意味：余裕がかくて、このままAを続けることはできない</p><p>接续：動詞て＋（は）いられない</p><p>例：</p><p>１．あの政治家の差別的な発言には、国民が黙ってはいられなかった</p><p>２．あと半年試験だから、のんびりしてはいられない</p><h3 id="～べくもない"><a href="#～べくもない" class="headerlink" title="～べくもない"></a>～べくもない</h3><p>意味：Aをしようとしてもできない</p><p>接续：動詞辞書形＋べくもない</p><p>例：</p><p>１．いつも明るい彼が抱えている悩みなど、みんな想像するべくもない</p><p>２．どんな芸術作品を生み出そうが、自然の美しさには敵うべくもない</p><h3 id="～べからず・～べからざる"><a href="#～べからず・～べからざる" class="headerlink" title="～べからず・～べからざる"></a>～べからず・～べからざる</h3><p>意味：Aを禁止する</p><p>接续：動詞辞書形＋べからず。べからざる＋名詞</p><p>例：</p><p>１．この先事故のため、通るべからず</p><p>２．お金を奪い取るなど許すべからざる行為だ</p><h3 id="～まじき"><a href="#～まじき" class="headerlink" title="～まじき"></a>～まじき</h3><p>意味：ある立場としてAしてはいけない</p><p>接续：動詞辞書形＋まじき＋名詞</p><p>例：</p><p>１．生徒に暴力を振るうなんて、教師としてあるまじき行為だ</p><p>２．酒を飲んで運転するなど警官にあるまじき行為だ</p><h2 id="话题、评价"><a href="#话题、评价" class="headerlink" title="话题、评价"></a>话题、评价</h2><h3 id="～ときたら"><a href="#～ときたら" class="headerlink" title="～ときたら"></a>～ときたら</h3><p>意味：说到…，就有…不满、抱怨的情绪</p><p>接续：N＋ときたら</p><p>例：</p><p>１．私の彼氏ときたら、一緒にいてもいつもスマホばかりいじっている</p><p>２．彼女ときたら、僕と会話をしないで、料理の写真ばかり撮っている</p><h3 id="～ともなると・～ともなれば"><a href="#～ともなると・～ともなれば" class="headerlink" title="～ともなると・～ともなれば"></a>～ともなると・～ともなれば</h3><p>意味：特別な立場になると</p><p>接续：N＋ともなると</p><p>例：</p><p>１．国の首相ともなると、自由に外出することもできない</p><p>２．４月ともなると、だいぶん寒さもましになり過ごしやすい</p><h3 id="～ともあろう"><a href="#～ともあろう" class="headerlink" title="～ともあろう"></a>～ともあろう</h3><p>意味：作为…，做出了与身份不相符的事情</p><p>接续：N＋ともあろう</p><p>例：</p><p>１．警察官ともあろう者が泥棒をするなんて許せない</p><p>２．学校のアイドルともあろう女の子に告白されて、天に登る気持ちだ</p><h3 id="～たるもの（は）"><a href="#～たるもの（は）" class="headerlink" title="～たるもの（は）"></a>～たるもの（は）</h3><p>意味：作为…，（不）应该做…</p><p>接续：N＋たる</p><p>例：</p><p>１．教師たるもの、学生の見本となるような行動すべきだ</p><p>２．親たるもの、子供の選択に余計な干渉をすべきではない</p><h3 id="～なりに"><a href="#～なりに" class="headerlink" title="～なりに"></a>～なりに</h3><p>意味：与…相配的程度</p><p>接续：（普通形）・N・イA・ナA＋なりに</p><p>例：</p><p>１．私なりに頑張ったつもりだったが、結果はダメだった</p><p>２．彼は英語が下手なりに、身振り手振りでコミュニケーションを取ろうとした</p><h2 id="比较"><a href="#比较" class="headerlink" title="比较"></a>比较</h2><h3 id="～にひきかえ"><a href="#～にひきかえ" class="headerlink" title="～にひきかえ"></a>～にひきかえ</h3><p>意味：两个东西比较</p><p>接续：V（普通形）＋のにひきかえ・N＋にひきかえ</p><p>例：</p><p>１．一流企業で働いている長男にひきかえ次男はニートです</p><p>２．去年は一年中忙しかったのにひきかえ、今年は暇な毎日だ</p><h3 id="～にもまして"><a href="#～にもまして" class="headerlink" title="～にもまして"></a>～にもまして</h3><p>意味：与…相比，程度更高</p><p>接续：N＋にもまして</p><p>例：</p><p>１．去年にもまして今年の夏は暑い日が続いている</p><p>２．今日は他の日にもまして道が込んでいます</p><h3 id="～ないまでも"><a href="#～ないまでも" class="headerlink" title="～ないまでも"></a>～ないまでも</h3><p>意味：虽然没有到…，但是</p><p>接续：Vない＋までも</p><p>例：</p><p>１．このホテルは満足できるとは言えないまでも、食事も美味しいし、まあまあのホテルだった</p><p>２．新婚旅行はヨーロッパには行けないまでも、せめて国内ではなくて海外に行きたい</p><h2 id="结果、最终状态"><a href="#结果、最终状态" class="headerlink" title="结果、最终状态"></a>结果、最终状态</h2><h3 id="～に至って・～に至っても"><a href="#～に至って・～に至っても" class="headerlink" title="～に至って・～に至っても"></a>～に至って・～に至っても</h3><p>意味：到了…的地步</p><p>接续：動詞辞書形・名詞＋に至って</p><p>例：</p><p>１．１ヶ月連絡が来ない状況に至って、やっと彼女が怒ってることが分かった</p><p>２．話し合いは深夜に至っても、まだ終わりそうにない</p><h3 id="～に至っては"><a href="#～に至っては" class="headerlink" title="～に至っては"></a>～に至っては</h3><p>意味：极端情况</p><p>接续：名詞＋に至っては</p><p>例：</p><p>１．今年は不景気で、どの会社も募集が少ない、B社に至っては採用すらしないそうだ</p><h3 id="～始末だ"><a href="#～始末だ" class="headerlink" title="～始末だ"></a>～始末だ</h3><p>意味：甚至到了…不好的情况</p><p>接续：Vる＋（という）始末だ</p><p>例：</p><p>１．夫はギャンブルにハマって、借金する始末だ</p><p>２．さっき掃除したばかりなのに、息子が小学校から帰るとこの始末だ</p><h3 id="～っぱなしだ"><a href="#～っぱなしだ" class="headerlink" title="～っぱなしだ"></a>～っぱなしだ</h3><p>意味：。。。という状態が続いている</p><p>接续：動詞ます＋っぱなし</p><p>例：</p><p>１．昨日は電気をつけっぱなしで寝てしまった</p><p>２．友達に半年も本を借りっぱなしになっている</p><h2 id="强调"><a href="#强调" class="headerlink" title="强调"></a>强调</h2><h3 id="たりとも…ない"><a href="#たりとも…ない" class="headerlink" title="~たりとも…ない"></a>~たりとも…ない</h3><p>意味：连（最小单位）都不(都没有)…</p><p>接续：N＋たりとも～ない</p><p>例：</p><p>１．試験まであと１週間。今は一日たりとも無駄にできない</p><p>２．同じ人間は一人たりとも存在しないから、自分の命は大切にしよう</p><h3 id="～すら"><a href="#～すら" class="headerlink" title="～すら"></a>～すら</h3><p>意味：举出极端条件</p><p>接续：N＋すら</p><p>例：</p><p>１．日本語の勉強を始めたばかりで、ひらがなすら読めない</p><p>２．去年も同じクラスだったけど、彼の名前すら知らない</p><h3 id="～だに"><a href="#～だに" class="headerlink" title="～だに"></a>～だに</h3><p>意味：连…都</p><p>接续：Vる・N＋だに</p><p>例：</p><p>１．突然を失った彼女の気持ちを考えるだに胸が痛くなる</p><p>２．生意気な後輩のことは、思い出すだに腹が立つ</p><h3 id="～にして"><a href="#～にして" class="headerlink" title="～にして"></a>～にして</h3><p>意味：强调</p><p>接续：N＋にして</p><p>例：</p><p>１．木村さんは18歳にして、社長になった</p><p>２．頼んでいた仕事を彼は一日にして全て終わらせてしまった</p><h3 id="～あっての"><a href="#～あっての" class="headerlink" title="～あっての"></a>～あっての</h3><p>意味：有了…才有的…</p><p>接续：N＋あっての＋N</p><p>例：</p><p>１．お金あっての幸せだよ</p><p>２．あなたあっての私だから、あなたがいないと生きていけないのよ</p><h3 id="～からある・～からする・～からの"><a href="#～からある・～からする・～からの" class="headerlink" title="～からある・～からする・～からの"></a>～からある・～からする・～からの</h3><p>意味：强调数量多</p><p>接续：数词＋からある・からする・からの＋名詞</p><p>例：</p><p>１．彼は毎日往復１０キロからある通学路を歩いて学校に行っている</p><p>２．３万人からの観客が集まっている</p><h2 id="主观、判断"><a href="#主观、判断" class="headerlink" title="主观、判断"></a>主观、判断</h2><h3 id="～までもない"><a href="#～までもない" class="headerlink" title="～までもない"></a>～までもない</h3><p>意味：必要はない</p><p>接续：動辞形＋までもない</p><p>例：</p><p>１．痴漢が犯罪であることは言うまでもない</p><p>２．リスクがある。そんなことは承知の上だ。君に言われるまでもない</p><h3 id="～までだ・までのことだ"><a href="#～までだ・までのことだ" class="headerlink" title="～までだ・までのことだ"></a>～までだ・までのことだ</h3><p>意味：覚悟（る）、軽い理由（た）</p><p>接续：Vる（た）＋までだ・までのことだ</p><p>例：</p><p>１．もし彼女との結婚を反対されたら、両親と縁をきるまでだ</p><p>２．子供がやりたいと言ったなら、親としては応援するまでのことだ</p><p>３．当然のことをしたまでですから、お礼は本当に結構ですよ</p><h3 id="～ばそれまでだ"><a href="#～ばそれまでだ" class="headerlink" title="～ばそれまでだ"></a>～ばそれまでだ</h3><p>意味：…的话，就到此为止了吧</p><p>接续：ば・たらそれまでだ</p><p>例：</p><p>１．とにかく人生は諦めたらそれまでだ</p><p>２．勝てる可能性はほとんどなかったと言われればそれまでなんだけど、それでも奇跡が起こるかもしれないと思っていたんだ</p><h3 id="～には当たらない"><a href="#～には当たらない" class="headerlink" title="～には当たらない"></a>～には当たらない</h3><p>意味：不到…的程度</p><p>接续：Vる＋には当たらない</p><p>例：</p><p>１．合格したことは驚くには当たらない</p><p>２．人にはそれぞれの生き方があるので、高校に行かないことは避難するには当たらない</p><h3 id="～でなくてなんだろう"><a href="#～でなくてなんだろう" class="headerlink" title="～でなくてなんだろう"></a>～でなくてなんだろう</h3><p>意味：不是…又是什么呢</p><p>接续：N＋でなくてなんだろう</p><p>例：</p><p>１．友達は飛行機で隣に座った人と結婚したそうだ、これが運命でなくてなんだろう</p><h1 id="作文模板"><a href="#作文模板" class="headerlink" title="作文模板"></a>作文模板</h1><h3 id="个人成长"><a href="#个人成长" class="headerlink" title="个人成长"></a>个人成长</h3><p>​個人の成長は人生において非常に重要なテーマだ。成長とは、単に年齢を重ねることではなく、自分の内面やスキル、知識を向上させることを意味する。それには自己理解、目標設定、挑戦、そして反省のプロセスが含まれている。個人の成長を意識的に追求することで、より充実した人生を送ることができるだろう。</p><p>​まず、個人の成長には自分理解が不可欠だ。自分が何を大切にし、何を目指しているのかを理解することが、成長の第一歩となる。自己分析を通じて、自分の強みや弱みを把握し、それに基づいて具体的な目標を設定することが大切だ。自分の価値観や興味を反映した目標を持つことで、成長へのモチベーションが高まる。</p><p>​次に、挑戦に恐れないことも個人の成長において重要だ。新しいことに挑戦することは、時に不安や困難を伴うが、それを乗り越えることで新たなスキルや知識を得ることができる。失敗を恐れず、積極的に学ぶ姿勢を持つことで、成長の幅が広がる。また、困難を乗り越えることで自己信頼感が増し、次の挑戦への意欲が湧いてくるものだ。</p><p>​さらに、反省も成長の大切な要素だ。日々の経験を振り返り、何を学んだか、どう改善できるかを考えることが成長に繋がる。反省を通じて、自分の行動や考え方を見直し、次に同じミスを繰り返さないようにすることができるからだ。成長には継続的な努力が必要であり、それに自己の反省と改善が欠かせない。</p><p>​結論として、個人の成長は自分理解、挑戦、反省の積み重ねによって実現されるものだ。日々の生活の中で成長を意識し、小さな変化を積み重ねることで、大きな成長を遂げることができる。自分の可能性を信じて、成長を楽しむことが、より豊かな人生を切り開く鍵となるだろう。</p><h3 id="学习方法"><a href="#学习方法" class="headerlink" title="学习方法"></a>学习方法</h3><p>​私の学習方法は、まず自分が何を学びたいのかを明確にすることから始める。目標を設定することで、学習の方向性が決まる。そして、効率的に学ぶために計画を立てる。私は、時間を無駄にしないために、毎日のスケジュールを作成し、優先順位をつけて取り組むことを大切にしている。</p><p>​次に、自分に合った教材を選ぶ。インターネットや図書館で情報を収集し、自分の理解しやすい教材を見つけることがポイントだ。また、同じテーマについて異なる資料を使うことで、より深い理解することができる。</p><p>​学んだことを他の人に教えることも、私の学習方法の一つだ。誰かに説明することで、自分の理解がより深まりますし、自分の考えを整理するのに役立つ。さらに、グループディスカッション（小组讨论）に参加することで、ほかの人の意見や考え方を知ることができ、自分の視野を広げることができる。</p><p>​最後に、復習を忘れないことだ。学んだことを定期に復習し、自分の知識を整理することで、忘れにくくなる。私は、ノートを見直す時間を週に一度設けており、その時に新たな発見があることも多い。このようにして、自分の学習方法を工夫し、常に成長し続けることを心がけている。</p><h3 id="人际关系"><a href="#人际关系" class="headerlink" title="人际关系"></a>人际关系</h3><p>​大学生活における人間関係は、学業と同じぐらい大切な要素だ。高校までとは異なり、大学ではより多くの自由と選択肢が与えられ、その結果として多様な人々と出会う機会が増える。人間関係を築くことは、学問や将来のキャリア（职业）だけでなく、自分成長にも繋がる重要な経験だ。</p><p>​まず、大学での友人やクラスメートの交流は、勉強や課題の共有を通じてお互いに学び合い、支え合う（支持）貴重な機会を提供してくれる。異なる専門分野やバックグラウンド（背景）を持つ人々と話すことで、新しい視点や考え方を得ることができ、自己理解を深めることができる。また、共同でプロジェクトを行うことで、協力し合う力やコミュニケーション能力を高めることができる。</p><p>​さらに、サークル活動やアルバイトを通じて築かれる人間関係も、大学生活を豊かにする重要な要素だ。サークルでは、趣味や興味を共有する仲間と出会い、楽しい時間を過ごすだけでなく、チームワークやリーダーシップを学ぶことができる。アルバイト先での人間関係も、社会性を養い、将来の人脈作りに役立つ経験となる。</p><p>​しかし、人間関係には時に困難も伴う、意見の食い違いや価値観の違いが原因で、対立や摩擦が生じることもあります。そのような時には、お互いの意見を尊重し、相手の立場に立って考えることが大切だ。相互理解を深める努力をすることで、より強固で信頼できる人間関係を築くことができるだろう。</p><p>​結論として、大学での人間関係は、学びと成長の場を広げるための大切な要素だ。多様な人々との交流を通じて、自分自身をより深く理解し、社会で生きる力を養うことができるだろう。</p><h3 id="珍惜时间"><a href="#珍惜时间" class="headerlink" title="珍惜时间"></a>珍惜时间</h3><p>​時間は私たちにとって最も貴重な資源の一つだ。誰にとっても一日は２４時間しかなく、その使い方次第で人生の質が大きく変わる。だからこそ、時間を大切にすることは非常に重要だ。無駄に過ごすのではなく、意識的に使うことで、充実した人生を送ることができる。</p><p>​まず、時間を大切ににするためには、優先順位を考えることが必要だ。何が本当に大切かを見極め、重要なことに時間を割くようにしよう。例えば、学生であれば、勉強や将来に役立つスキルの習得に時間を使うことが賢明だ。また、社会人であれば、仕事だけでなく、家族や友人との時間も大切にするべきだ。バランスを保ちながら、生活の質を向上させるために、計画的に時間を使うことが求められる。</p><p>​さらに、時間を無駄にしないためには、習慣の改善も重要だ。無駄なスマートフォンの使用や長時間のテレビ鑑賞を減らし、より有意義な活動に時間を費やすように努めることが大切だ。読書や運動、趣味に時間を使うことで、心身の健康を保つことができますし、新たな知識やスキルを身につけることができる。</p><p>​時間を大切にすることは、未来を創造することでもある。毎日を無駄にせず、少しずつでも目標に向かって進むことで、長い目で見れば大きな成果を得ることができるだろう。一度失った時間は二度と戻らないため、今この瞬間を大切にし、意識的に過ごすことが求められる。</p><p>​結論として、時間を大切にすることは、より良い人生を送るための基本だ。時間を有効に活用し、自分の目標や夢に向かって前進することで、充実した毎日を過ごすことができるだろう。</p><h3 id="运动与健康"><a href="#运动与健康" class="headerlink" title="运动与健康"></a>运动与健康</h3><p>​健康な生活を送るためには、運動が欠かせない。現代社会では、多くの人が座りがちな生活を送っており、運動不足が原因でさまざまな健康問題が発生している。そこで、日常生活に適度な運動を取り入れることが重要だ。運動は、体力を向上させるだけでなく、心の健康にも良い影響を与える。</p><p>​まず、運動をすることによって、体力や筋力が向上する。定期的な運動は、筋肉や骨を強化し、心肺機能を高める効果がある。これにより、日常生活での体の動きがスムーズになり、疲れにくくなるだけでなく、けがや病気の予防にもつながる。また、代謝が活発になることで、体重管理や肥満防止にも役立つ。</p><p>​さらに、時間を無駄にしないためには、習慣の改善も重要だ。無駄なスマートフォンの使用や長時間のテレビ鑑賞を減らし、より有意義な活動に時間を費やすように努めることが大切だ。読書や運動、趣味に時間を使うことで、心身の健康を保つことができますし、新たな知識やスキルを身につけることができる。</p><p>​時間を大切にすることは、未来を創造することでもある。毎日を無駄にせず、少しずつでも目標に向かって進むことで、長い目で見れば大きな成果を得ることができるだろう。一度失った時間は二度と戻らないため、今この瞬間を大切にし、意識的に過ごすことが求められる。</p><p>​結論として、時間を大切にすることは、より良い人生を送るための基本だ。時間を有効に活用し、自分の目標や夢に向かって前進することで、充実した毎日を過ごすことができるだろう。</p><h3 id="科技发展"><a href="#科技发展" class="headerlink" title="科技发展"></a>科技发展</h3><p>​テクノロジーの発展は、現代社会において多大な恩恵をもたらしている。情報通信技術の進化、人工知能の開発、自動運転車の導入など、テクノロジーの進歩により、私たちの生活は便利で快適なものとなった。しかし、テクノロジーの発展は一方で新たな問題やリスクも生み出しており、それはまさに「両刃の剣」と言える。テクノロジーをどのように利用するかを慎重に考える必要がある。</p><p>​まず、テクノロジーの進歩は、私たちの生活を大きく変え、効率化した。スマートフォンやインターネットを使って、いつでもどこでも情報を入手し、人とコミュニケーションを取ることができるようになった。医療分野でも、テクノロジーの進化により、治療法の改善や診断の迅速化が進み、健康管理が向上している。また、人工知能の発展により、工業やサービス業の分野での自動化が進み、労働生産性が向上している。</p><p>​しかし、テクノロジーの発展にはデメリットもある。例えば、情報技術の普及による個人情報の流出やサイバー（cyber；电脑、网络）攻撃のリスク（risk ；风险）が増加している。また、人工知能やロボット技術の進展により、一部の仕事が自動化され、人間の雇用機会が減少する懸念もある。さらに、テクノロジー依存症の問題も深刻化しており、人々のコミュニケーション能力や集中力の低下が指摘されている。</p><p>​このように、テクノロジーの発展は、利便性や効率性を高める一方で、新たな問題やリスクを伴う。これらの課題を解決するためには、理論的な観点からテクノロジーの利用方法を考えることが求められる。特に、教育や政策において、テクノロジーのメリットとデメリットをバランスよく理解し、健全な社会の発展を目指すことが重要だ。</p><p>​結論として、テクノロジーの発展は両刃の剣だ。その利便性を享受するためには、リスクや問題点にも目を向け、適切な対策を講じる必要がある。私たちはテクノロジーを賢く利用し、より良い未来を築くために努力しなければならない。</p><h3 id="旅游意义"><a href="#旅游意义" class="headerlink" title="旅游意义"></a>旅游意义</h3><p>​旅行は私たちにとって、ただのレジャーやリフレッシュの手段にとどまらず、人生において大きな意味を持つものだ。旅行を通じて、新しい場所や文化、そして人々と出会うことで、自分の視野を広げることができる。</p><p>​まず、旅行は私たちに未知の世界を体験する機会を提供してくれる。普段の生活では味わえない景色や風景、人々の生活様式を直接見ることで、私たちの価値観や考え方が豊かになる。異なる文化や考え方に触れることで、自分自身を見つめ直し、新たな発見をすることができるのだ。</p><p>​また、旅行は自分の成長にもつながる。知らない場所での挑戦や不便な状況に対応することで、問題解決能力や柔軟性が養われる。特に、言葉や習慣の異なる場所での旅は、コミュニケーション能力を高め、人とのつながりを深める大きなチャンスとなる。</p><p>​さらに、旅行は日常のストレスから解放される大切な時間でもある。忙しい日々の中で、心と体をリセットし、新たなエネルギーを得ることができる。自然や歴史、アート（art）に触れることで、心の安らぎ（平静）やインスピレーション（inspiration ;灵感）を感じることができるのだ。</p><p>​結論として、旅行は単なる娯楽ではなく、私たちが成長し、学び、リフレッシュするための大切な活動だ。新しい経験を通じて、自分自身を深く理解し、人生の意味を見つけることができるだろう。</p><h3 id="成长瞬间"><a href="#成长瞬间" class="headerlink" title="成长瞬间"></a>成长瞬间</h3><p>​大学時代、私は勉強だけでなく、多くの経験を通じて成長を実感した。特に印象的なのは、サークル活動を通じて人との関わり方を学んだ瞬間である。</p><p>​私は大学に入学してから、ある音楽サークルに参加した。初めての集まりでは、緊張と不安でいっぱいだった。しかし、サークルのメンバーはとてもフレンドリーで、すぐに打ち解けることができた。最初は演奏に自信が持てなかったが、仲間たちと共に練習を重ねるうちに、徐々に自分の演奏にも自信を持つようになった。特に、ある発表会でリーダーを任され、全体をまとめる役割を担ったことが、自分の成長を感じる大きな転機となった。</p><p>​発表会では、準備の段階から本番まで、数々の問題が発生した。例えば、メンバー間で意見の食い違いや練習の進行が遅れることがあり、私はその調整に苦労した。しかし、こうした経験を通じて、私は問題解決のスキルや、リーダーとしての責任感を学んだ。また、メンバーとのコミュニケーションを大切にし、彼らの意見を尊重しながら全体をまとめることの重要性にも気づいた。</p><p>​発表会を無事に終えた後、私は自分の成長を実感した。以前よりも他人との協力や自分の意見をしっかり伝える力が身についていた。これらの経験は、社会に出たときにも大いに役立つと感じている。</p><h1 id="自我介绍"><a href="#自我介绍" class="headerlink" title="自我介绍"></a>自我介绍</h1><p>​先生方（がた）、こんにちは。本日は貴重な面接（めんせつ）の機会をいただき、誠にありがとうございます。では、自己紹介をさせていただきます。</p><p>​大学の時、私は勉強に励み、一等賞の奨学金を獲得しました。学業の傍ら、就職活動にも積極的に取り組み、企業説明会やインターンシップにも参加してきました。いろいろな実践経験を積んで、大学生活も豊かになりました。</p><p>​大学時代から、私はずっとコンピューターに興味を持っています。御校（おんこう）はとても環境がよく、学術的な雰囲気に溢れ、ここで学ぶことはきっと素晴らしい経験になると確信しております。そのため、御校に入り、優秀な先生と一緒に研究に力を入れたいと思います。</p><p>​私は明るくてやる気がある人で、いつも前向きな考え方を持っています。粘り強い（ねばりづよい）性格（せいかく）ですから、どんなことにあっても諦めないです。これはきっと将来の勉強や研究に役立つと思います。</p><p>​私はまだ研究スキルや専門知識に不足（ぶそく）を感じておりますが、もし御校に入学できましたら、これからの三年間でそれらを磨き、さらなる成長を目指して努力したいと思います。</p><p>​以上は私の自己紹介でした、よろしくお願いいたします。</p><p><strong>中文自我介绍</strong></p><p>​各位尊敬的老师，下午好，很高兴能够进入到贵校研究生考试复试环节。<br>​下面，我先进行一下简单的自我介绍。</p><p>​我是一名来自计算机专业的学生，在本科期间，我积极参加学科竞赛，先后获得了蓝桥杯国赛三等奖、全国高校计算机能力挑战赛国赛一等奖、团体程序设计天梯赛省三等奖等奖项。同时在校期间还获得过校一等奖学金，考取了中级软件设计师证书。以上是我本科期间获得过的一些奖项。</p><p>​下面我来介绍下我的毕业设计。本科期间我主要学习的编程语言是Java语言，因此我的毕业设计选择的课题是《校园招聘平台的设计与实现》，这个项目源于传统线下招聘效率低、信息不对称等痛点，旨在为在校大学生和企业搭建一个高效的线上对接平台，为企业提供更便捷的招聘渠道，促进校企双方的合作。系统采用前后端分离架构，前端使用Vue3+ElementPlus实现响应式界面，后端基于SpringBoot+MyBatis构建RESTful API，用户端有查看职位，在线沟通，投递简历等功能，企业端有编辑企业信息，发布职位，招聘等功能。系统通过SpringSecurity实现登录用户的认证和授权；通过WebSocket让浏览器和服务器端建立TCP连接，实现心跳检测、超时重连和发送消息等功能，让用户和企业hr能够实时在线沟通，提高求职效率。系统还会将用户上传的简历，照片等文件，存储在云端OSS中。以上是我毕业设计的简单介绍。</p><p>​在大学中我遇到了许多好的老师和朋友，从他们身上我也学到了很多东西。在本科学习期间，我感受到我的专业知识还有待提高，因此我选择读研进一步深造，完善我的专业知识。和更优秀的人一起奋斗，不断提升自我。</p><p>​以上就是我的自我介绍，感谢各位老师的耐心倾听。</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>操作系统</title>
    <link href="/2024/04/11/%E8%80%83%E7%A0%94/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/04/11/%E8%80%83%E7%A0%94/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="操作系统基础"><a href="#操作系统基础" class="headerlink" title="操作系统基础"></a>操作系统基础</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="什么是操作系统"><a href="#什么是操作系统" class="headerlink" title="什么是操作系统"></a>什么是操作系统</h3><p>​操作系统（Operating System， OS）是指控制和<strong>管理</strong>整个计算机系统的<strong>硬件和软件资源</strong>，并合理地组织调度计算机的工作和资源的分配；以提供给用户和其他软件方便的接口和环境；它是计算机系统中最基本的系统<strong>软件</strong></p><h3 id="操作系统提供的功能"><a href="#操作系统提供的功能" class="headerlink" title="操作系统提供的功能"></a>操作系统提供的功能</h3><ul><li>处理机（CPU）管理</li><li>存储器管理</li><li>文件管理</li><li>设备管理</li></ul><h3 id="操作系统的目标"><a href="#操作系统的目标" class="headerlink" title="操作系统的目标"></a>操作系统的目标</h3><ul><li>作为系统资源的管理者</li><li>向上提供方便易用的服务<ul><li>图形界面GUI</li><li>命令接口<ul><li>联机命令接口：交互式，用户一句，系统一句，如cmd</li><li>脱机命令接口：批处理，如bat</li><li>程序接口：在代码中通过<strong>系统调用</strong>（广义接口）来使用</li></ul></li></ul></li></ul><h3 id="操作系统的特征"><a href="#操作系统的特征" class="headerlink" title="操作系统的特征"></a>操作系统的特征</h3><ul><li><p><strong>并发</strong></p><p>  并发：同一时间交替运行多个程序</p><p>  并行：同一时间同时运行多个程序（多核CPU）</p></li><li><p><strong>共享</strong></p><p>  互斥共享：一个时间段内只允许一个进程访问该资源（临界资源）</p><p>  同时访问：同一时间段内多个进程”同时“访问</p><p>  <strong>并发和共享是操作系统两个最基本的特征</strong></p></li><li><p><strong>虚拟</strong></p><p>  空分复用：内存分给多个进程使用，让用户觉得能使用的内存大于物理内存（虚拟内存）</p><p>  时分复用：处理机在各个微小的时间段内交替为各个进程服务</p></li><li><p><strong>异步</strong></p><p>  进程以不可预知的速度执行</p><p>  只有系统拥有并发性，才有可能导致异步</p></li></ul><h3 id="操作系统的发展和分类"><a href="#操作系统的发展和分类" class="headerlink" title="操作系统的发展和分类"></a>操作系统的发展和分类</h3><p><img src="/img/os_img/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%8F%91%E5%B1%95%E5%8E%86%E5%8F%B2.png"></p><ul><li><p><strong>手工操作阶段</strong>：用户独占，资源利用率底，（无操作系统）</p></li><li><p><strong>批处理阶段</strong></p><ul><li><p><strong>单道批处理系统</strong>：</p><p>  将一批作业放入磁带执行，一次只能执行一道程序，<strong>监督系统负责作业的输入输出</strong>，CPU有大量时间在等待IO完成</p><p>  <img src="/img/os_img/%E5%8D%95%E9%81%93%E6%89%B9%E5%A4%84%E7%90%86.png"></p></li><li><p><strong>多道批处理系统</strong>：</p><ul><li><p>优点：</p><p>  在输入和输出程序的时候也能进行计算；</p><p>  当某道程序因为请求IO操作而暂停运行时，CPU变去运行另一道程序；</p><p>  多道、宏观并行、微观串行（轮流使用CPU）；</p></li><li><p>缺点：</p><p>  响应时间较长，不提供人机交互；</p></li></ul><p>  <img src="/img/os_img/%E5%A4%9A%E9%81%93%E6%89%B9%E5%A4%84%E7%90%86.png"></p></li></ul></li><li><p><strong>分时操作系统</strong></p><p>  以<strong>时间片</strong>为单位轮流为各个用户&#x2F;作业服务，请求能被及时响应，主要用于<strong>交互式作业</strong>。但不能优先处理一些紧急任务</p></li><li><p><strong>实时操作系统</strong></p><ul><li>硬实时系统：必须在觉得严格的规定时间内完成</li><li>软实时系统：能接收偶尔超时</li></ul></li><li><p>个人计算操作系统、网络操作系统、分布式操作系统。。。</p></li></ul><blockquote><p>求CPU使用率的题用甘特图比较好求</p><p><img src="/img/os_img/%E7%94%98%E7%89%B9%E5%9B%BE%E4%BE%8B%E9%A2%98.png"></p></blockquote><h3 id="操作系统运行环境"><a href="#操作系统运行环境" class="headerlink" title="操作系统运行环境"></a>操作系统运行环境</h3><p><strong>指令</strong>：</p><ul><li>特权指令：不允许用户直接用的指令，如IO指令、关中断指令等</li><li>非特权指令：仅限于访问用户的地址空间</li></ul><p><strong>CPU的运行模式</strong>：</p><ul><li>用户态（目态）：应用程序运行在用户态</li><li>内核态（管态）：操作系统内核运行在内核态</li><li>内核态 –&gt; 用户态：执行特权指令，修改<strong>PSW（程序状态字寄存器）</strong>标志位</li><li>用户态 –&gt; 内核态：<strong>中断</strong>，硬件自动完成切换</li></ul><p><strong>操作系统的内核组成</strong>：</p><ul><li>与硬件关联较紧密的模块<ol><li>时钟管理：给用户提供系统时间、分时操作系统的时钟中断来切换进程、实时操作系统的截止时间</li><li>中断处理：保护和回复中断现场的信息，转移控制权到相关处理程序</li><li>原语：原子性，最接近硬件的部分，调用频繁</li><li>管理：进程管理、存储器管理、设备管理</li></ol></li><li>运行频率较高的模块</li></ul><h3 id="中断和异常"><a href="#中断和异常" class="headerlink" title="中断和异常"></a>中断和异常</h3><ul><li><p>作用<br>  中断是让操作系统内核夺回CPU使用权的<strong>唯一手段</strong>，发生中断时会立即切换回核心态</p></li><li><p>中断的类型</p><ul><li><p><strong>内中断</strong>（异常、例外）：<br>  中断信号来源于CPU内部</p><ol><li>陷阱、陷入指令（trap指令、访管指令）：程序请求内核的服务时使用</li><li>故障：错误条件引发，如缺页故障、地址越界</li><li>终止：使得CPU无法继续执行的硬件故障</li></ol></li><li><p><strong>外中断</strong>（中断）：<br>  中断信号<strong>来源于CPU外部</strong>，如时钟中断</p><ol><li>可屏蔽中断：通过INTR线（Interrupt Request line）发出中断请求，可多重中断</li><li>不可屏蔽中断：通过INM线（Non-Maskable Interrupt line）发出请求，多为硬件故障</li></ol><ul><li>时钟中断：表示一个固定的时间片已到</li><li>IO中断请求：表示输入输出处理已经完成</li></ul></li></ul></li><li><p>中断基本原理<br>  CPU根据中断的类型去查询<strong>中断向量表</strong>，找到对应<strong>中断处理程序</strong>的入口地址</p><p>  如果处理程序能够解决问题，则通过<strong>中断返回指令</strong>返回用户程序继续执行</p><p>  如果是不可恢复的致命错误，则终止用户程序</p></li></ul><h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><ul><li><p>作用</p><p>  应用程序通过系统调用来请求操作系统内核提供的服务，</p><p>  主要有设备管理、文件管理、进程管理、进程通信和内存管理，</p><p>  这些对系统影响非常大的指令必须由操作系统执行，以保证稳定性和安全性</p></li><li><p>何时会用到系统调用</p><p>  与<strong>共享资源</strong>有关的操作（存储分配、IO操作、文件管理等）</p></li><li><p>系统调用过程</p><ol><li>先通过传参指令将参数传到寄存器中</li><li>再通过陷入指令转入中断处理程序、<strong>硬件自动保护中断现场</strong>（程序计数器PC、PSW、通用寄存器）</li><li>处理完后<strong>恢复现场</strong>、返回用户程序</li></ol></li></ul><h3 id="内核结构"><a href="#内核结构" class="headerlink" title="内核结构"></a>内核结构</h3><ol><li><p><strong>宏内核</strong>（单内核、大内核）</p><p> 系统的主要功能模块都运行在核心态</p></li><li><p><strong>微内核</strong></p><p> 只保留最基本的功能在内核，如与硬件处理紧密相关的部分</p><ol><li>进程管理</li><li>低级存储器管理</li><li>中断和陷入处理</li></ol><p> <strong>特点</strong>：</p><ol><li>足够小的内核</li><li>基于客户&#x2F;服务器模式</li><li>应用“机制与策略分离”原理</li><li>采用面向对象</li></ol><p> 优点：扩展灵活、可靠安全、可移植性、分布式计算</p><p> 缺点：微内核用户态和内核态的转换比宏内核频繁，<strong>性能偏低</strong></p></li><li><p><strong>分成结构</strong></p><p> <img src="/img/os_img/%E5%88%86%E6%88%90%E7%BB%93%E6%9E%84%E5%9B%BE.png"></p><p> 每层只能调用紧邻的下一层</p><p> 优点：便于维护、易扩展</p><p> 缺点：合理定义每层比较困难、不可跨层调用效率低</p></li><li><p><strong>模块化</strong></p><p> <img src="/img/os_img/%E6%A8%A1%E5%9D%97%E5%8C%96%E5%9B%BE.png"></p><p> 衡量标准：高内聚、低耦合</p><p> 优点：加速开发、可理解、可维护</p><p> 缺点：接口规定难以满足实际需求，模块间相互依赖，难以调试</p></li><li><p><strong>外核</strong></p><p> 在内核中运行，为虚拟机分配未经抽象的硬件资源</p><p> 优点：减少了硬件资源的“映射层”，提升效率</p><p> 缺点：降低了系统的一致性，使系统更复杂</p></li></ol><h3 id="操作系统引导"><a href="#操作系统引导" class="headerlink" title="操作系统引导"></a>操作系统引导</h3><p>作用：让操作系统运行起来</p><p>步骤：</p><ol><li><p>激活CPU：开始执行BIOS指令</p></li><li><p>硬件自检：在内存最开始的地方<strong>构建中断向量表</strong>，通电检查硬件</p></li><li><p>加载带有操作系统的硬盘</p></li><li><p>加载主引导记录<strong>MBR</strong>（Master Boot Recored）：作用是告诉CPU去哪个硬盘分区（<strong>活动分区</strong>）找操作系统</p></li><li><p>扫描硬盘分区</p></li><li><p>加载分区引导记录<strong>PBR</strong>：找到启动管理器</p></li><li><p>加载<strong>启动管理器</strong>：找到并激活引导操作系统的程序</p></li><li><p>加载操作系统</p><p> <img src="/img/os_img/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%BC%95%E5%AF%BC.png"></p></li></ol><h3 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h3><p><strong>第一类虚拟机管理系统</strong></p><p>虚拟机管理程序运行在<strong>内核态</strong></p><p>向上提供若干虚拟机，虚拟机作为<strong>用户态</strong>的一个进程运行，所在的内核态为<strong>虚拟内核态</strong></p><p><strong>第二类虚拟机管理系统</strong></p><p>在宿主操作系统上运行，如VMWare</p><p><img src="/img/os_img/%E8%99%9A%E6%8B%9F%E6%9C%BA.png"></p><h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p><strong>概念</strong>：进程是一个正在执行程序的实例，<strong>是资源分配的基本单位</strong></p><p><strong>组成</strong>：</p><ol><li><p>进程控制块<strong>PCB</strong>（Process Control Block）：</p><p> 进程创建时新建一个PCB，进程结束时回收PCB，<strong>进程存在的唯一标志</strong></p><p> <img src="/img/os_img/PCB%E5%8C%85%E5%90%AB%E7%9A%84%E5%86%85%E5%AE%B9.png"></p></li><li><p>程序段：程序的代码段</p></li><li><p>数据段：运行时产生的数据</p></li></ol><p><strong>PCB组织方式</strong>：</p><ol><li>链接方式：同一状态的PCB在同一队列</li><li>索引方式：同一状态的PCB在同一索引表</li></ol><p><strong>特征</strong>：</p><ol><li>动态性：动态地产生、变化和消亡</li><li>并发性：多个进程间并发执行</li><li>独立性：资源分配的基本单位</li><li>异步性：运行速度不可预知</li></ol><h3 id="进程状态"><a href="#进程状态" class="headerlink" title="进程状态"></a>进程状态</h3><p><img src="/img/os_img/%E8%BF%9B%E7%A8%8B%E7%8A%B6%E6%80%81.png"></p><p>就绪态 –&gt; 运行态：获得CPU时间片</p><p>运行态 –&gt; 就绪态：1. 时间片用完；2. 有优先级更高的进程在就绪态</p><p>运行态 –&gt; 阻塞态：请求某一资源或等待某一事件发生（主动）</p><p>阻塞态 –&gt; 就绪态：等待的事件到来时（被动）</p><h3 id="进程控制"><a href="#进程控制" class="headerlink" title="进程控制"></a>进程控制</h3><p>创建&#x2F;撤销&#x2F;转换进程</p><p><strong>原语</strong>：</p><ul><li><p>原子性：运行必须一气呵成，不可中断</p></li><li><p>通过关中断和开中断实现原子性</p><p>  <img src="/img/os_img/%E5%85%B3%E4%B8%AD%E6%96%AD%E5%92%8C%E5%BC%80%E4%B8%AD%E6%96%AD.png"></p></li></ul><p><strong>创建进程过程</strong>：</p><ol><li>分配PID，申请空白PCB</li><li>分配运行所需资源</li><li>初始化PCB：包括标志信息、CPU状态信息、CPU控制信息和进程优先级等</li><li>插入就绪队列</li></ol><p><strong>终止进程过程</strong>（正常结束、异常结束、外界干预）：</p><ol><li>从PCB中读取进程状态</li><li>（如果在运行）终止运行、终止子进程</li><li>将资源归还父进程&#x2F;操作系统</li><li>将PCB从队列中删除</li></ol><p><strong>阻塞进程操作</strong>（主动行为）：</p><ol><li>调用<strong>阻塞原语</strong></li><li>通过PID找到PCB</li><li>（如果在运行）<strong>保护现场</strong>，将上下文保存到PCB中</li><li>将PCB插入到相应等待队列</li></ol><p><strong>唤醒进程操作</strong>（被动行为）：</p><ol><li>调用<strong>唤醒原语</strong></li><li>在等待队列中找到该PCB</li><li>从阻塞队列中移除，设置为就绪态，插入到就绪队列</li></ol><h3 id="进程通信"><a href="#进程通信" class="headerlink" title="进程通信"></a>进程通信</h3><p>高级通信主要有三种方式：</p><ol><li><p>共享存储</p><p> 基于数据结构或共享空间，互斥访问</p><p> <img src="/img/os_img/%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8.png"></p></li><li><p>消息传递</p><p> 通过原语传递指定格式的消息，直接发给对方进程或发给信箱</p><p> <img src="/img/os_img/%E6%B6%88%E6%81%AF%E4%BC%A0%E9%80%92.png"></p></li><li><p>管道通信</p><p> 半双工通信，固定大小，先进先出</p><p> 满时写进程堵塞，空时读进程堵塞</p></li></ol><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p>引入线程的目的是减小程序在并发执行时所付出的时空开销</p><p>TCB由线程ID、PC、寄存器集合、运行状态、优先级和堆栈指针等组成</p><p><img src="/img/os_img/TCB.png"></p><p><strong>线程是调度的最小单位</strong></p><h3 id="线程特点"><a href="#线程特点" class="headerlink" title="线程特点"></a>线程特点</h3><ul><li>不同线程可以执行相同程序</li><li>同一进程的线程共享进程资源</li><li>各个CPU可为一个进程内的各线程服务，缩短进程的处理时间</li><li>被终止但尚未释放资源的线程被其他线程调用时，从终止态重新开始运行</li></ul><h3 id="线程实现方式"><a href="#线程实现方式" class="headerlink" title="线程实现方式"></a>线程实现方式</h3><ol><li><p>用户级线程（UTL）</p><p> 用代码模拟线程，内核感知不到线程的存在</p><p> 优点：</p><ol><li>节省了模式切换的开销</li></ol><p> 缺点：</p><ol><li>一个线程阻塞，所有线程都阻塞</li><li>每次只能运行一个线程</li></ol><p> <img src="/img/os_img/%E7%94%A8%E6%88%B7%E7%BA%A7%E7%BA%BF%E7%A8%8B.png"></p></li><li><p>内核级线程（KTL）</p><p> 在内核的支持下运行的</p><p> 优点：</p><ol><li>发挥多核CPU的优势</li><li>一个线程阻塞，其他线程不会跟着阻塞</li></ol><p> 缺点：</p><ol><li>线程切换需要切换到核心态，开销较大</li></ol><p> <img src="/img/os_img/%E5%86%85%E6%A0%B8%E7%BA%A7%E7%BA%BF%E7%A8%8B.png"></p></li><li><p>组合方式</p><p> <img src="/img/os_img/%E7%BB%84%E5%90%88%E6%96%B9%E5%BC%8F.png"></p><p> <img src="/img/os_img/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B.png"></p></li></ol><h2 id="CPU调度"><a href="#CPU调度" class="headerlink" title="CPU调度"></a>CPU调度</h2><p>为什么要CPU调度：CPU和外部设备的速度差距大，等待外部设备会浪费CPU资源</p><h3 id="调度的层次"><a href="#调度的层次" class="headerlink" title="调度的层次"></a>调度的层次</h3><table><thead><tr><th>类型</th><th>作用</th><th>方向</th><th>频率</th></tr></thead><tbody><tr><td><strong>作业调度</strong>（高级调度）</td><td>从外存后备队列选择一个作业，创建进程</td><td>外存 -&gt; 内存</td><td>低</td></tr><tr><td><strong>内存调度</strong>（中级调度）</td><td>从外存将挂起的的作业调回内存</td><td>外存 -&gt; 内存</td><td>中</td></tr><tr><td><strong>进程调度</strong>（低级调度）</td><td>从就绪队列中选择一个进程分配给处理机</td><td>内存 -&gt; CPU</td><td>高</td></tr></tbody></table><blockquote><p>中级调度的作用是为了提高内存的利用率，将暂时不能运行的进程挂起来</p><p>挂起和阻塞的区别：挂起的进程在外存，阻塞的进程还在内存；就绪态和阻塞态的进程可能会被挂起</p></blockquote><h3 id="star-评价指标"><a href="#star-评价指标" class="headerlink" title=":star:评价指标"></a>:star:评价指标</h3><table><thead><tr><th>指标</th><th>怎么算</th><th>意义</th></tr></thead><tbody><tr><td>CPU利用率</td><td>有效工作时间 &#x2F; (有效工作时间 + 空闲等待时间)</td><td></td></tr><tr><td>系统吞吐量</td><td>完成作业数 &#x2F; 花费时间</td><td>单位时间完成的作业量</td></tr><tr><td>周转时间</td><td>作业完成时间 - 作业提交时间</td><td>作业提交到完成的时间</td></tr><tr><td>平均周转时间</td><td></td><td></td></tr><tr><td>带权周转时间</td><td>周转时间 &#x2F; 实际运行时间</td><td>&gt;1，周转时间为运行时间的多少倍</td></tr><tr><td>平均带权周转时间</td><td></td><td></td></tr><tr><td>等待时间</td><td>等待CPU的时间</td><td>进程等待时间不包括IO时间</td></tr><tr><td>响应时间</td><td>首次响应时间 - 提交时间</td><td></td></tr></tbody></table><h3 id="调度实现"><a href="#调度实现" class="headerlink" title="调度实现"></a>调度实现</h3><p><img src="/img/os_img/%E8%B0%83%E5%BA%A6%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84.png"></p><ul><li>排队器：将就绪进程按照一定策略排成一个或多个队列</li><li>分派器：分配CPU给新进程（进程调度）</li><li>上下文切换器：切换进程上下文（进程切换）</li></ul><h3 id="调度时机"><a href="#调度时机" class="headerlink" title="调度时机"></a>调度时机</h3><ol><li>创建新进程时，CPU选择运行父进程还是子进程</li><li>运行的进程正常结束或异常终止</li><li>阻塞时（IO请求、信号量操作等）</li><li>IO完成后的IO中断</li><li>有更高优先级的进程进入就绪队列</li><li>时间片用完</li></ol><blockquote><p>操作系统内核程序临界区：一般是访问某种内核数据结构，不能进行调度和切换</p><p>临界区：访问临界资源，等待IO时应该进行进程切换</p></blockquote><p><strong>不能进行进程调度和切换的场景</strong></p><ol><li>在处理中断的过程</li><li>屏蔽中断的原子操作过程（加解锁、保护中断现场等）</li></ol><p><strong>调度方式</strong></p><ol><li><p>非抢占调度方式</p><p> 优点：实现简单、开销小，适合早期批处理系统</p><p> 缺点：不能用于分时系统和大多数实时系统</p></li><li><p>抢占调度方式</p><p> 提高吞吐率和响应效率有好处</p><p> 根据优先权、短进程优先、时间片原则等判断优先级</p></li></ol><h3 id="star-调度算法"><a href="#star-调度算法" class="headerlink" title=":star:调度算法"></a>:star:调度算法</h3><p><strong>早期批处理系统中使用的调度算法</strong>：</p><table><thead><tr><th></th><th>说明</th><th>是否抢占</th><th>是否导致饥饿</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>先来先服务(FCFS)</td><td>按作业提交时间执行</td><td>×</td><td>×</td><td>简单</td><td>对短作业不利，效率低</td></tr><tr><td>短作业优先(SJF)</td><td>每次调度时选择就绪队列里运行时间最短的</td><td>×</td><td>√</td><td>平均等待时间、平均周转时间相对较短</td><td>对长作业不利</td></tr><tr><td>最短剩余时间优先(SRTN)</td><td>每次调度、进程进入就绪队列时选择就绪队列里剩余运行时间最短的</td><td>√</td><td>√</td><td>平均等待时间、平均周转时间“最”优</td><td>对长作业不利</td></tr><tr><td>高响应比优先(HRRN)</td><td>每次调度时选择就绪队列里响应比<strong>最高的</strong>(响应比：(等待时间 + 运行时间) &#x2F; 运行时间)</td><td>×</td><td>×</td><td>综合考虑了等待时间和运行时间</td><td></td></tr></tbody></table><blockquote><p>这些算法没有关注响应时间和任务的紧急程度，交互性差</p></blockquote><p><strong>分时操作系统中使用的调度算法：</strong></p><table><thead><tr><th></th><th>说明</th><th>是否抢占</th><th>是否导致饥饿</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>时间片轮转(RR)</td><td>每隔一段时间产生一个时钟中断，激活调度程序调度，时间片设计最好使切换开销占比不超过1%</td><td>√</td><td>×</td><td>公平，响应快</td><td>不区分紧急任务，时间片设置不合理开销大</td></tr><tr><td>优先级调度算法</td><td>调度时选择在就绪队列中优先级最高的进程</td><td>×</td><td>√</td><td>可灵活调整对进程的偏好</td><td>可能导致饥饿</td></tr><tr><td>多级反馈队列调度算法</td><td>如下图</td><td>√</td><td>√</td><td>兼顾长短作业，有较好的响应时间，通用</td><td>复杂</td></tr></tbody></table><p><img src="/img/os_img/%E5%A4%9A%E7%BA%A7%E5%8F%8D%E9%A6%88%E9%98%9F%E5%88%97%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95.png"></p><blockquote><p>静态优先级：创建时决定优先级，之后一直不变</p><p>动态优先级：创建时有一个初始值，根据情况调整优先级</p><p>优先级从以下几点考虑：</p><p>通常：</p><ul><li>系统进程 &gt; 用户进程</li><li>前台进程 &gt; 后台进程</li><li>IO型进程 &gt; 计算型进程</li><li>交互型进程 &gt; 非交互型进程</li></ul></blockquote><h2 id="同步与互斥"><a href="#同步与互斥" class="headerlink" title="同步与互斥"></a>同步与互斥</h2><h3 id="临界资源和临界区"><a href="#临界资源和临界区" class="headerlink" title="临界资源和临界区"></a>临界资源和临界区</h3><p>临界资源：一次仅允许一个进程使用的资源</p><p>临界区：访问临界资源的那段代码</p><blockquote><p>临界资源的访问过程：</p><p>1） 进入区：检查是否可进入临界区、设置正在访问临界区标志</p><p>2） 临界区：又称临界段</p><p>3） 退出区：秦楚正在访问临界区标志</p><p>4） 剩余区：代码其他部分</p></blockquote><h3 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h3><p>直接制约关系</p><p>多个进程合作完成同一个任务</p><h3 id="互斥"><a href="#互斥" class="headerlink" title="互斥"></a>互斥</h3><p>间接制约关系</p><p>进程间互斥地访问临界资源</p><p><strong>实现互斥的准则</strong></p><ol><li>空闲让进：临界区空闲时，允许一个进程进入</li><li>忙则等待：有进程进入临界区时，其他进程等待</li><li>有限等待：要保证进程在有限时间里进入临界区</li><li>让权等待：进程不能进入临界区时，要让出CPU</li></ol><h3 id="基本实现方式"><a href="#基本实现方式" class="headerlink" title="基本实现方式"></a>基本实现方式</h3><p><strong>软件实现方式</strong></p><ol><li><p>单标志法</p><p> 用一个turn表示能访问临界区的进程号</p><p> 若一个进程不再进入临界区，则另一个也无法进入，违反“空闲等待”</p><p> <img src="/img/os_img/%E5%8D%95%E6%A0%87%E5%BF%97%E6%B3%95.png"></p></li><li><p>双标志先检查法</p><p> 一个数组flag[2]表示进程想要进入的意愿</p><p> 可能导致两个进程都通过进入区，违反“忙则等待”</p><p> <img src="/img/os_img/%E5%8F%8C%E6%A0%87%E5%BF%97%E5%85%88%E6%A3%80%E6%9F%A5%E6%B3%95.png"></p></li><li><p>双标志后检查法</p><p> 先设置意愿，再进入进入区</p><p> 可能导致都卡在进入区，违反“空闲等待”、“有限等待”，导致饥饿</p><p> <img src="/img/os_img/%E5%8F%8C%E6%A0%87%E5%BF%97%E5%90%8E%E6%A3%80%E6%9F%A5%E6%B3%95.png"></p></li><li><p>Peterson算法</p><p> 同时有表示意愿的flag[]和表示能访问临界区的进程号的turn</p><p> 如果只有一个进程要进入临界区，会导致一直在while里，违反“让权等待”</p><p> <img src="/img/os_img/peterson%E7%AE%97%E6%B3%95.png"></p></li></ol><p><strong>硬件实现方式</strong></p><ol><li><p>中断屏蔽</p><p> 通过关中断、开中断实现互斥</p><p> 缺点：开关中断需要切换到内核态，效率低；只能在单处理机上使用</p></li><li><p>TestAndSet指令</p><p> 原子操作，设置和检查一气呵成，不能实现“让权等待”</p><p> <img src="/img/os_img/TS%E6%8C%87%E4%BB%A41.png"></p><p> <img src="/img/os_img/TS%E6%8C%87%E4%BB%A42.png"></p></li><li><p>Swap指令</p><p> 原子操作，互换两个变量的值。</p><p> 和TS指令区别不大，只是将保存原来值的操作放到方法外</p></li></ol><p>TAS和Swap是<strong>硬件</strong>指令</p><p>相比于软件实现，硬件实现简单，支持任意多个线程。但硬件实现不能“让权等待”，会产生饥饿</p><h3 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h3><p>mutex lock，互斥锁，自旋锁</p><p>acquire()：获得锁，release()：释放锁，操作都是原子性的</p><p>在多处理器系统中，自旋的消耗比进程切换小，因此常用与多处理器系统。</p><h3 id="信号量"><a href="#信号量" class="headerlink" title="信号量"></a>信号量</h3><p><strong>整型信号量</strong></p><p>用一个整型S表示剩余资源数，如果为0则while不断尝试，不遵循“让权等待”。</p><p><strong>记录型信号量</strong></p><p>遵循“让权等待”</p><p>伪代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>    <span class="hljs-type">int</span> value;<span class="hljs-comment">// 剩余资源数</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">process</span> *<span class="hljs-title">L</span>;</span><span class="hljs-comment">// 等待队列</span><br>&#125; semaphore;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">wait</span><span class="hljs-params">(semaphore S)</span> &#123;<br>    S.value--;<br>    <span class="hljs-keyword">if</span> (S.value &lt; <span class="hljs-number">0</span>) &#123;<br>        add this process to S.L;<span class="hljs-comment">// 进入阻塞队列</span><br>        block(S.L)<span class="hljs-comment">// 阻塞当前进程</span><br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">signal</span><span class="hljs-params">(semaphore S)</span> &#123;<br>    S.value++;<br>    <span class="hljs-keyword">if</span> (S.value &lt;= <span class="hljs-number">0</span>) &#123;<br>        remove a proceess P from S.L;<span class="hljs-comment">// 将一个进程从阻塞队列中移除</span><br>        wakeup(P);<span class="hljs-comment">// 唤醒进程</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="经典同步问题"><a href="#经典同步问题" class="headerlink" title="经典同步问题"></a>经典同步问题</h3><p><strong>生产者-消费者问题</strong></p><p>信号量设置：</p><ol><li>mutex：互斥信号量，用于控制互斥访问缓冲池</li><li>full：记录“满”的缓冲区数，初值0</li><li>empty：记录“空”的缓冲区数，初值n</li></ol><p>注意：</p><p>要先判断“空”&#x2F;“满”的缓冲区数，再获取mutex，否则可能抱着锁阻塞，导致<strong>死锁</strong></p><p>释放锁和“空”&#x2F;“满”的缓冲区数 + 1的顺序可以互换</p><p><strong>读者-写者问题</strong></p><p>读写、写写互斥；读读共享</p><p>信号量设置：</p><ol><li>count：当前读者数量，初值0</li><li>mutex：互斥信号量，用于控制互斥访问count，防止读进程重复对rw上锁</li><li>rw：互斥访问文件，初值1</li></ol><p><strong>哲学家进餐问题</strong></p><p><img src="/img/os_img/%E5%93%B2%E5%AD%A6%E5%AE%B6%E8%BF%9B%E9%A4%90%E9%97%AE%E9%A2%98.png"></p><p>信号量设置：</p><ol><li>chopstick[5]&#x3D;[1,1,1,1,1]</li></ol><p>注意：</p><p>如果采用贪心来获取筷子，会导致死锁</p><p><strong>吸烟者问题</strong></p><p>三个抽烟者，三种材料，每个抽烟者都缺两种不同的材料，缺的都不同。</p><p>一个提供者，每次提供两种材料</p><p>信号量设置：</p><ol><li>offer1、offer2、offer3，分别表示两种材料的组合，初值为0</li><li>finish：用于表示吸烟者吸完烟了，之后提供者才能放材料，初值为0</li></ol><h3 id="管程"><a href="#管程" class="headerlink" title="管程"></a>管程</h3><p>管理共享资源的资源管理器，封装了对共享资源的操作</p><p>各进程只能串行访问管程里的方法</p><p><strong>条件变量</strong>：带有阻塞队列和入队出队操作的数据结构</p><h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><h3 id="死锁和饥饿的区别"><a href="#死锁和饥饿的区别" class="headerlink" title="死锁和饥饿的区别"></a>死锁和饥饿的区别</h3><p>进程数：死锁要两个及以上进程；饥饿可以只有一个进程</p><p>进程状态：死锁进程必定处于阻塞态；饥饿进程可能处于就绪态或阻塞态</p><p>产生原因：死锁是由于多个进程应竞争资源而造成的僵局；饥饿是由于申请的资源不能在有限时间内获取</p><h3 id="死锁产生的原因"><a href="#死锁产生的原因" class="headerlink" title="死锁产生的原因"></a>死锁产生的原因</h3><ol><li>系统资源的竞争</li><li>进程推进顺序非法</li></ol><h3 id="star-死锁的必要条件"><a href="#star-死锁的必要条件" class="headerlink" title=":star:死锁的必要条件"></a>:star:死锁的必要条件</h3><ol><li><p><strong>互斥条件</strong>：资源最多被一个进程所占有</p></li><li><p><strong>不可剥夺</strong>：资源在未使用完之前不能被其他进程抢夺走，只能主动释放</p></li><li><p><strong>请求并保持</strong>：需要获取多个资源，对已经获得的部分资源保持不放</p></li><li><p><strong>循环等待</strong>：进程间都在等待其他进程释放自己需要的资源，形成了一条等待链。每个资源的数量都是1</p><p> <img src="/img/os_img/%E5%BE%AA%E7%8E%AF%E7%AD%89%E5%BE%85.png"></p></li></ol><h3 id="预防死锁"><a href="#预防死锁" class="headerlink" title="预防死锁"></a>预防死锁</h3><table><thead><tr><th></th><th>说明</th><th>缺点</th></tr></thead><tbody><tr><td>破坏互斥条件</td><td>将互斥使用的资源改造成共享资源</td><td>可能导致系统不安全，很多时候要保护互斥性</td></tr><tr><td>破坏不可剥夺</td><td>请求新的资源而得不到满足时，它必须释放已经保存的所有资源</td><td>复杂，反复申请和释放资源增加系统开销，吞吐量降低</td></tr><tr><td>破坏请求与保持</td><td>方法一：预先静态分配：一次性将所需要的资源在运行前都给进程。方法二：进程获取运行初期需要的资源后就开始运行，后面要新的资源需要将已有的资源全部释放</td><td>简单，但资源浪费严重，暂时用不到的资源可能被长时间占有。</td></tr><tr><td>破坏循环等待</td><td>给资源编号，只能按顺序获取</td><td>不便于新增资源，可能造成资源浪费，编程麻烦</td></tr></tbody></table><h3 id="star-避免死锁（银行家算法）"><a href="#star-避免死锁（银行家算法）" class="headerlink" title=":star:避免死锁（银行家算法）"></a>:star:避免死锁（银行家算法）</h3><p>能找到安全序列则系统处于安全状态，否则处于不安全状态，<strong>可能</strong>导致死锁</p><p>定义的变量：</p><ol><li>可利用资源向量Available：Available[j] &#x3D; K表示系统中j类资源的可用数为K个</li><li>最大需求矩阵Max:Max[i, j] &#x3D; K表示i进程需要j类资源K个</li><li>分配矩阵Allocation：Allocation[i, j]&#x3D;K表示i进程已获得了j类资源K个</li><li>需求矩阵Need：Need[i, j] &#x3D; K表示i进程还需要j类资源K个。Need &#x3D; Max - Allocation</li></ol><h3 id="死锁检测与消除"><a href="#死锁检测与消除" class="headerlink" title="死锁检测与消除"></a>死锁检测与消除</h3><p><strong>资源分配图</strong></p><p><img src="/img/os_img/%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E5%9B%BE.png"></p><p>阻塞进程：剩余资源数无法满足需求的点</p><p>孤立点：可分配资源并已完成分配的点，可将连着的线都去掉</p><p>可完全简化：将所有点变成孤立点，此时一定没有发生死锁</p><p>死锁定理：不可完全简化表示发生死锁</p><p><strong>死锁解除</strong></p><ol><li>资源剥夺法：将某些死锁进程挂起，剥夺其资源。要注意防止饥饿发生</li><li>撤销进程法：将某些死锁进程撤销，剥夺其所有资源，撤销进程的代价可能很大</li><li>进程回退法：回退到没有发送死锁的时点，要设置还原点，复杂</li></ol><blockquote><p>因为撤销进程后，之前运行的东西就作废了，所以代价可能很大</p><p>选择撤销进程时考虑的点：</p><ol><li>进程优先级</li><li>已执行时间</li><li>已经使用了多少资源</li><li>交互式还是批处理</li></ol></blockquote><h2 id="内存管理"><a href="#内存管理" class="headerlink" title="内存管理"></a>内存管理</h2><h3 id="程序链接与装入"><a href="#程序链接与装入" class="headerlink" title="程序链接与装入"></a>程序链接与装入</h3><p>将代码装入的内存的步骤：</p><ol><li>编译：将代码编译成若干模块</li><li>链接：将编译后的模块和所需库函数链接在一起，形成完整的装入模块</li><li>装入：由装入模块将转入模块装入内存</li></ol><p><strong>装入方式</strong></p><ol><li><p>绝对装入</p><p> 只适合单道程序环境</p><p> 程序中的逻辑地址与内存地址完全相同</p><p> 绝对地址在编译或汇编时给出，或由程序员给出</p></li><li><p>可重定位装入（静态重定位）</p><p> 只适合早期多道批处理环境</p><p> 在装入时将相对地址改为绝对地址</p><p> 缺点：作业一旦进入内存，整个运行期间就不能在内存中移动，也不能再申请内存空间</p><p> <img src="/img/os_img/%E9%9D%99%E6%80%81%E9%87%8D%E5%AE%9A%E4%BD%8D.png"></p></li><li><p>动态运行时装入（动态重定位）</p><p> 装入内存时不修改相对地址，到真正运行时才进行内存转换，需要<strong>重定位寄存器</strong></p><p> 优点：不需要连续内存块，可动态申请内存块</p><p> <img src="/img/os_img/%E5%8A%A8%E6%80%81%E9%87%8D%E5%AE%9A%E4%BD%8D.png"></p></li></ol><p><strong>链接方式</strong></p><ol><li><p>静态链接</p><p> 运行前将目标模块和库链接成完整的装入程序，之后不再拆开</p></li><li><p>装入时动态链接</p><p> 边装入边链接，便于修改和链接</p></li><li><p>运行时动态链接</p><p> 运行时需要什么模块才对它进行链接，可加快装入速度，减少内存使用，便于共享模块</p></li></ol><h3 id="内存保护"><a href="#内存保护" class="headerlink" title="内存保护"></a>内存保护</h3><p>保护用户进程不影响操作系统、用户进程间不互相影响</p><p><strong>上下限寄存器</strong></p><p>存放进程的上下限地址，指令访问地址时会进行检查是否越界</p><p><strong>重定位寄存器、界地址寄存器</strong></p><p>重定位寄存器存放起始的<strong>物理地址</strong></p><p>界地址寄存器存放进程的最大<strong>逻辑地址</strong></p><p>修改这两个寄存器的值必须使用特权指令，即只有操作系统能改</p><p><img src="/img/os_img/%E7%95%8C%E5%9C%B0%E5%9D%80%E5%AF%84%E5%AD%98%E5%99%A8.png"></p><h3 id="进程的内存映像"><a href="#进程的内存映像" class="headerlink" title="进程的内存映像"></a>进程的内存映像</h3><p>进程的内存映像一般包括：</p><ol><li>代码段：只读、共享</li><li>数据段：全局变量、静态变量</li><li>PCB：进程控制块</li><li>堆：存放动态分配的变量</li><li>栈：用来实现函数调用</li></ol><p><img src="/img/os_img/%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%86%85%E5%AD%98%E6%98%A0%E5%83%8F1.png"></p><p><img src="/img/os_img/%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%86%85%E5%AD%98%E6%98%A0%E5%83%8F2.png"></p><h3 id="内存扩充"><a href="#内存扩充" class="headerlink" title="内存扩充"></a>内存扩充</h3><p><strong>覆盖技术</strong></p><p>将程序分为多个段，常用的常驻内存（固定区），不常用的需要时再放入内存（覆盖区）</p><p>必须由程序员声明覆盖结构，只用于早期操作系统</p><p><strong>交换技术</strong></p><p>内存空间紧张时，将某些进程暂时换出外存，将已具备运行条件的进程换入内存（中级调度）</p><p><strong>PCB是常驻再内存的</strong></p><p>磁盘分为：</p><ol><li>对换区：连续分配方式，速度快于文件区，追求换入换出速度</li><li>文件区：离散分配方式，追求存储空间的利用率</li></ol><blockquote><p>覆盖是在同一进程或程序中的，交换在不同进程、作业间的</p></blockquote><h3 id="连续分配"><a href="#连续分配" class="headerlink" title="连续分配"></a>连续分配</h3><p><strong>单一连续分配</strong></p><p>描述：内存被分为系统区（低地址）和用户区（高地址），用户区存放用户程序，只能存一道</p><p>优点：简单，无外部碎片</p><p>缺点：只能用在单任务的操作系统中，有内部碎片，内存利用率极低</p><p><img src="/img/os_img/%E5%8D%95%E4%B8%80%E8%BF%9E%E7%BB%AD%E5%88%86%E9%85%8D.png"></p><p><strong>固定连续分配</strong></p><p>描述：</p><p>​将用户区换分为多个分区（可以不相等），每个分区只能装一道程序</p><p>​需要<strong>分区说明表</strong>来实现内存的分配于回收</p><p>优点：简单，无外部碎片</p><p>缺点：程序太大时需要使用覆盖技术，有内部碎片，内存利用率低</p><p><img src="/img/os_img/%E5%88%86%E5%8C%BA%E8%AF%B4%E6%98%8E%E8%A1%A8.png"></p><p><img src="/img/os_img/%E5%9B%BA%E5%AE%9A%E5%88%86%E5%8C%BA%E5%88%86%E9%85%8D.png"></p><p><strong>动态分区分配</strong></p><p>描述：</p><p>​不会预先划分内存区，根据进程大小动态建立分区，也叫可变分区分配</p><p>​用<strong>空闲分区表</strong>或<strong>空闲分区链</strong>记录内存的使用情况</p><p><img src="/img/os_img/%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA%E8%A1%A8%E5%92%8C%E5%86%85%E5%AD%98%E5%88%86%E5%8C%BA%E9%93%BE.png"></p><p>优点：无内部碎片，可根据进程大小动态建立分区</p><p>缺点：有外部碎片，可通过“紧凑”技术解决，但相对费时</p><blockquote><p>内部碎片：分配给进程的内存中没有用上的部分</p><p>外部碎片：内存中小的难以被利用上的内存块</p></blockquote><h3 id="动态分区分配算法"><a href="#动态分区分配算法" class="headerlink" title="动态分区分配算法"></a>动态分区分配算法</h3><p><strong>顺序分配算法</strong></p><table><thead><tr><th></th><th>描述</th><th>分区排序顺序</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>首次适应算法（First Fit）</td><td>每次都顺序查找空闲分区，将第一个满足大小的分区分配给作业</td><td>按地址递增顺序排列</td><td>保留了高位地址的大空闲区，有利于后续大作业的装入</td><td>低地址会出现许多小碎片，每次查找都会经过一遍，增加了开销</td></tr><tr><td>最佳适应算法（Best Fit）</td><td>将第一个能满足大小的空闲分区分配给作业</td><td>按容量递增</td><td>能流出更多大空闲分区</td><td>会留下<strong>最多</strong>外部碎片，性能很差</td></tr><tr><td>最坏适应算法（Worst Fit）</td><td>将第一个能满足大小的空闲分区分配给作业</td><td>按容量递减</td><td>不容易产生外部碎片</td><td>没有很多大分区可用，性能很差</td></tr><tr><td>临近适应算法（Next Fit）</td><td>也称循环首次适应算法，对First Fit的修改，每次从上一次查找结束的位置开始查找</td><td>按地址递增顺序排列</td><td>让高低地址的空闲分区以同等概率被分配出去</td><td>导致高地址没有大块空闲分区可用，<strong>通常比First Fit的效果差</strong></td></tr></tbody></table><p><strong>索引分配算法</strong></p><p>当系统很大时，空闲分区链可能很长，此时用顺序分配算法的时间开销会很大，此时往往采用索引分配算法</p><p>大致思想是：大小相同的空闲分区单独设立空闲分区链，再设置索引表管理这些空闲分区链</p><table><thead><tr><th></th><th>描述</th><th>分区排序顺序</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>快速适应算法</td><td>找到能够容纳进程的最小分区链，然后取出第一块分配给进程</td><td></td><td>效率高，不产生内部碎片</td><td>回收分区时，要合理合并分区，算法复杂，开销大</td></tr><tr><td>伙伴系统</td><td></td><td></td><td></td><td></td></tr><tr><td>哈希算法</td><td>建立以空闲区大小为关键字的哈希表，分配时根据大小计算空闲区所在位置</td><td></td><td></td><td></td></tr></tbody></table><h3 id="分页存储"><a href="#分页存储" class="headerlink" title="分页存储"></a>分页存储</h3><p><strong>概念</strong></p><p>page frame&#x3D;页框&#x3D;页帧&#x3D;物理块&#x3D;内存块：内存分为若干固定大小的分区，页面大小应是2的整数次幂</p><p>页&#x3D;页面：逻辑空间的分区，大小和物理块相同</p><p>页号：页面的编号，从0开始</p><p>分页管理优点：不产生外部碎片，只产生很小的内部碎片（页内碎片）</p><p>逻辑地址结构：</p><p><img src="/img/os_img/%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80%E7%BB%93%E6%9E%84.png"></p><p>页表（页面映射表）：</p><p>实现从页号到物理块号的映射</p><p><img src="/img/os_img/%E9%A1%B5%E8%A1%A8.png"></p><p>页表寄存器：存放了页表始址和页表长度</p><p>地址变换机构：</p><p><img src="/img/os_img/%E5%9C%B0%E5%9D%80%E5%8F%98%E6%8D%A2%E6%9C%BA%E6%9E%84.png"></p><p><strong>计算</strong></p><p>页号&#x3D;逻辑地址&#x2F;页大小</p><p>偏移量&#x3D;逻辑地址%页大小</p><p>页表项地址&#x3D;页表始址+页号*<strong>页表项</strong>大小，里面存的就是对应的物理块号</p><p>物理地址&#x3D;物理块号*页面大小+偏移量</p><p><strong>页表项的大小</strong>：如果以字节编制，则大小应为字节的整数倍，且表示的大小要≥总页数</p><p>有时为了方便计算或存储其他信息，会加大页表项的长度</p><p><img src="/img/os_img/%E9%A1%B5%E8%A1%A8%E9%A1%B9%E5%A4%A7%E5%B0%8F%E8%AE%A1%E7%AE%97%E7%A4%BA%E4%BE%8B.png"></p><p><strong>快表</strong></p><p>又称联想寄存器（TLB，Translation Lookaside Buffer），属于高速缓存，是硬件，用来存放最近访问的页表项</p><p><img src="/img/os_img/%E5%BF%AB%E8%A1%A8.png"></p><p>如果在快表中找到要访问页表项，则只需<strong>一次访存+一次访快表</strong>就能完成存取数据</p><p>如果未找到，则需要<strong>两次访存+一次访快表</strong>才行</p><p>如果没有快表，则每次都需要<strong>两次访存</strong></p><blockquote><p>局部性原理</p><p>时间局部性：如果程序中的某条指令一旦执行，则不久之后该指令可能再次被执行；如果某数据被访问，则不久之后该数据可能再次被访问。</p><p>空间局部性：一旦程序访问了某个存储单元，则不久之后，其附近的存储单元也将被访问。</p></blockquote><p><img src="/img/os_img/%E5%BF%AB%E8%A1%A8%E8%AE%A1%E7%AE%97%E4%BE%8B%E9%A2%98.png"></p><p><strong>多级页表</strong></p><p>单级页表存在的问题有：</p><ol><li>页表需要连续的内存空间</li><li>可能占用很多内存</li></ol><p>多级页表可以使页表离散存储</p><p><img src="/img/os_img/%E4%BA%8C%E7%BA%A7%E9%A1%B5%E8%A1%A8.png"></p><p><strong>注意</strong>：</p><ol><li>多级页表中各级页表的大小不能超过一个页面</li><li>随着级数越多，访存的次数也会增加</li></ol><h3 id="分段存储"><a href="#分段存储" class="headerlink" title="分段存储"></a>分段存储</h3><p>分段管理是考虑了程序员和用户，以满足方便编程、信息保护和共享、动态增长及动态链接等多方面的需要</p><p><strong>概念</strong></p><p>段表：保存逻辑空间和内存空间的映射关系</p><p>段表项：记录了始值和段长，长度是固定的</p><p>段表寄存器：存放段表始址和段表长度</p><p>地址变换机构：</p><p><img src="/img/os_img/%E6%AE%B5%E8%A1%A8%E5%9C%B0%E5%9D%80%E5%8F%98%E6%8D%A2%E6%9C%BA%E6%9E%84.png"></p><p>段内偏移量也需要判断是否越界</p><h3 id="分页和分段的比较"><a href="#分页和分段的比较" class="headerlink" title="分页和分段的比较"></a>分页和分段的比较</h3><p>相同点：</p><ol><li>都是非连续分配方式</li><li>都需要通过地址变换机构实现地址变换</li><li>都可以使用快表减少地址变换时间</li></ol><p>不同点：</p><ol><li>页是信息的物理单位；段是信息的逻辑单位</li><li>目的：分页是提高内存利用率；分段是为了更好地满足用户需求</li><li>长度：页的大小固定且由系统决定，对用户透明；段的大小不固定由用户决定，对用户可见</li><li>地址空间：分页管理的地址空间是一维的；分段管理的地址空间是二维的（分页只需要给出一个逻辑地址就能计算出页号和偏移量，由操作系统来完成；分段需要给出段号和段内偏移量，因为分段是用户决定的）</li></ol><table><thead><tr><th></th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>分页管理</td><td>不会产生外部碎片，空间利用率高</td><td>不方便按照逻辑模块实现信息的共享和保护</td></tr><tr><td>分段管理</td><td>方便进行共享和保护</td><td>段太长为其分配连续空间不方便，会产生外部碎片</td></tr></tbody></table><h3 id="段页式管理"><a href="#段页式管理" class="headerlink" title="段页式管理"></a>段页式管理</h3><p>将进程按逻辑模块分段，再将各段分页。结合了分页和分段的优点</p><p><img src="/img/os_img/%E6%AE%B5%E9%A1%B5%E5%BC%8F%E7%AE%A1%E7%90%86.png"></p><p><strong>概念</strong></p><p>逻辑地址：由段号、页号、页内偏移量组成</p><p>段表项：段号（隐含的）、页表长度、页表存放块号</p><p>页表项：页号（隐含的）、内存块号</p><p>分页对于用户是不可见的，系统会根据段内地址自动划分页号和页内偏移量</p><p>用户要提供段号和段内偏移量（二维）</p><p><strong>逻辑地址转换为物理地址过程</strong></p><p><img src="/img/os_img/%E6%AE%B5%E9%A1%B5%E5%BC%8F%E7%AE%A1%E7%90%86%E6%B5%81%E7%A8%8B.png"></p><p>段号和页号都要检查是否越界</p><h2 id="虚拟内存"><a href="#虚拟内存" class="headerlink" title="虚拟内存"></a>虚拟内存</h2><p>建立了“内存-外存”的两级存储器结构，利用<strong>局部性原理</strong>实现高速缓存</p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ol><li>多次性：无需将作业一次性全部装入内存，只需要当前运行的那部分程序和数据装入内存即可运行</li><li>对换性：将需要的程序调入内存（换进），将暂不需要的调入外存（换出），由操作系统完成</li><li>虚拟性：用户看到的内存容量，远大于实际容量</li></ol><h3 id="管理方式"><a href="#管理方式" class="headerlink" title="管理方式"></a>管理方式</h3><p><strong>页表机制</strong></p><p>基本分页的页表项：页号、物理块号</p><p>请求分页的页表项新增：</p><ol><li>状态位：是否已调入内存</li><li>访问字段：在一段时间被访问的次数</li><li>修改位：调入内存后是否被修改过</li><li>外存地址：该页在外存的存放地址</li></ol><p><strong>缺页中断机构</strong></p><p>要访问的页面不在内存时，产生缺页异常（内部异常），阻塞缺页的线程</p><p>将要访问的页面调入内存（没有空位要淘汰其他页面），修改页表项</p><p>若页面被淘汰，根据是否修改来判断是否要写回外存</p><p><strong>地址变换机构</strong></p><p><img src="/img/os_img/%E8%AF%B7%E6%B1%82%E5%88%86%E9%A1%B5%E4%B8%AD%E7%9A%84%E5%9C%B0%E5%9D%80%E5%8F%98%E6%8D%A2%E8%BF%87%E7%A8%8B.png"></p><h3 id="页框分配"><a href="#页框分配" class="headerlink" title="页框分配"></a>页框分配</h3><p>驻留集：给一个进程分配的页框的集合，一般不小于工作集的大小</p><p>工作集：某个时间段内进程实际访问的页面集合</p><p>抖动：刚刚换入（换出）的页面马上又换出（换入）页面，说明分配给进程的物理块太少</p><p>分配策略</p><table><thead><tr><th></th><th>说明</th><th>优缺点</th></tr></thead><tbody><tr><td><strong>固定分配局部置换</strong></td><td>分配固定数目的物理块，缺页只能从分配给自己的内存中进行替换</td><td>难以确定应分配的物理块数，太少会频繁出现缺页中断，太多会降低资源利用率</td></tr><tr><td><strong>可变分配全局置换</strong></td><td>先分配一定数目的物理块，后从空闲物理块中根据情况增减，缺页则从空闲物理块队列中取出一块进行分配或淘汰一个未锁定的页面来分配</td><td>比上一种灵活，盲目增加物理块会降低系统并发度</td></tr><tr><td><strong>可变分配局部置换</strong></td><td>先分配一定数目的物理块，缺页只能从分配给自己的内存中进行替换，根据缺页率动态增减分配的物理块</td><td>复杂</td></tr></tbody></table><h3 id="页面置换算法"><a href="#页面置换算法" class="headerlink" title="页面置换算法"></a>页面置换算法</h3><p>缺页率：缺页次数 &#x2F; 总访问页面次数</p><table><thead><tr><th></th><th>说明</th><th>优缺点</th></tr></thead><tbody><tr><td>最佳置换算法（OPT，Optimal）</td><td>优先淘汰最长时间不会被访问的页面</td><td>性能最好，只在理论上，用来评估其他算法的性能</td></tr><tr><td>先进先出置换算法（FIFO）</td><td>优先淘汰最先进入内存的页面</td><td>简单，性能差，可能出现Belady异常（驻留集越大，性能反而差）</td></tr><tr><td>最近最久未使用算法（LRU，least recently used）</td><td>有限淘汰最近最久没访问的页面</td><td>性能好，但<strong>需要硬件支持</strong>，开销大</td></tr><tr><td>时钟置换算法（clock）、最近未使用算法（NRU）</td><td>循环扫描，淘汰第一个访问位为0的页面，将经过的访问位1改为0</td><td>简单，开销小，未考虑页面是否被修改过</td></tr><tr><td>改进型时钟置换算法</td><td>（访问位，修改位）形式</td><td>开销小，性能也不错</td></tr></tbody></table><p><img src="/img/os_img/%E6%9C%80%E8%BF%91%E6%9C%80%E4%B9%85%E6%9C%AA%E4%BD%BF%E7%94%A8%E7%BD%AE%E6%8D%A2%E7%AE%97%E6%B3%95%E4%BE%8B%E9%A2%98.png" alt="最近最久未使用置换算法例题"></p><p><img src="/img/os_img/%E6%94%B9%E8%BF%9B%E5%9E%8B%E6%97%B6%E9%92%9F%E7%BD%AE%E6%8D%A2%E7%AE%97%E6%B3%95%E4%BE%8B%E9%A2%98.png" alt="改进型时钟置换算法例题"></p><h3 id="内存映射文件"><a href="#内存映射文件" class="headerlink" title="内存映射文件"></a>内存映射文件</h3><p>操作系统向应用程序提供的一个系统调用。</p><p>在磁盘文件与进程的虚拟地址空间之间建立映射关系，将一个文件当做内存中的一个大字符数组来访问，而不通过文件IO操作来访问</p><p>内存映射还能用来共享内存</p><p><img src="/img/os_img/%E5%86%85%E5%AD%98%E6%98%A0%E5%B0%84%E6%9D%A5%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98.png" alt="改进型时钟置换算法例题"></p><h2 id="文件管理"><a href="#文件管理" class="headerlink" title="文件管理"></a>文件管理</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>文件(File)：以硬盘为载体的存储在计算机上的信息集合。用户输入输出以文件为基本单位</p><p>文件的构成：存储空间、分类、索引和访问权限等</p><p>文件的属性：名称、类型、创建者、所有者、位置、大小、保护、创建&#x2F;修改&#x2F;存取时间</p><p>数据项：文件系统中最低级的数据组织形式</p><p>记录：一组相关的数据项的集合</p><h3 id="文件逻辑结构"><a href="#文件逻辑结构" class="headerlink" title="文件逻辑结构"></a>文件逻辑结构</h3><p>指从用户角度出发看到的文件的组织形式</p><p><strong>无结构文件</strong></p><p>由字符流构成，又称流式文件，如txt文件</p><p><strong>有结构文件</strong></p><p>由一个及以上的记录构成的文件，又称记录式文件。</p><p>根据记录的长度，分为：</p><ol><li>定长记录：所有记录长度相同</li><li>变长记录：各个记录长度不一定相同</li></ol><p>根据记录的组织形式，分为：</p><ol><li><p>顺序文件：记录按顺序排列，定长的<strong>可随机存取</strong></p></li><li><p>索引文件：为<strong>每个记录</strong>在索引表中设置一个索引表项，包含记录的指针和长度。索引表是定长的顺序文件</p><p> <img src="/img/os_img/%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6.png"></p><p> 需要额外的索引表，增加了存储开销</p></li><li><p>索引顺序文件</p><p> 顺序文件和索引文件的结合，<strong>一组记录</strong>对应一个索引表项提高了查找效率</p><p> <img src="/img/os_img/%E9%A1%BA%E5%BA%8F%E7%B4%A2%E5%BC%95%E8%A1%A8.png"></p></li><li><p>散列文件：</p><p> 通过记录的hash值直接计算出物理地址。具有很高的存取速度，但存在hash冲突</p></li></ol><h3 id="文件物理结构"><a href="#文件物理结构" class="headerlink" title="文件物理结构"></a>文件物理结构</h3><p>指将文件存储在外存上的存储组织形式，<strong>磁盘块</strong>的大小通常与内存的页面大小相同</p><p>文件分配方式：</p><ul><li><p>连续分配</p><p>  要求每个文件在磁盘上占有一组连续的块，进程访问磁盘时的寻道数和寻道时间最小</p><p>  优点：支持顺序访问和直接访问，速度快</p><p>  缺点：要连续的存储空间，可能产生外部碎片；要事先知道文件的长度，无法动态增长</p></li><li><p>链接分配</p><p>  离散分配</p><ul><li><p>隐式分配：指向下一个的指针在磁盘块中</p><p>  只支持顺序访问，访问磁盘次数多，效率低</p></li><li><p>显式分配：将指针都存放在一张内存中的<strong>文件分配表</strong>（File Allocation Table）里（一个磁盘对应一张，开机时调入内存）</p><p>  支持顺序和直接访问，减少了访问磁盘的次数，但FAT需要占用一定内存</p></li></ul></li><li><p>索引分配</p><p>  打开文件时，没必要将整个FAT都读入内存，因此将文件的盘块号集中成一个索引表（块）读入内存</p><ul><li><p>单级索引分配方式</p><p>  优点：支持直接访问</p><p>  缺点：索引表占用内存太大</p></li><li><p>多级索引分配方式</p><p>  <img src="/img/os_img/%E4%BA%8C%E7%BA%A7%E7%B4%A2%E5%BC%95%E5%88%86%E9%85%8D.png"></p><p>  优点：加快了对大型文件的查找效率</p><p>  缺点：对于小文件来说，访问磁盘的次数增加了</p></li><li><p>混合索引分配方式</p><p>  为了照顾小、中、大文件而采用混合索引</p><p>  小文件采用直接索引，大文件采用间接索引</p><p>  <img src="/img/os_img/%E6%B7%B7%E5%90%88%E7%B4%A2%E5%BC%95%E6%96%B9%E5%BC%8F.png"></p></li></ul></li></ul><h3 id="文件控制块"><a href="#文件控制块" class="headerlink" title="文件控制块"></a>文件控制块</h3><p>File Control Block，存放控制文件需要的各种信息，以实现<strong>按名存取</strong></p><p>FCB的有序集合称为<strong>文件目录</strong></p><p>文件目录也是文件，称为<strong>目录文件</strong></p><p>为了减小FCB的体积，将除了文件名的其他信息放到<strong>索引节点</strong>中，FCB只存文件名和索引节点的指针</p><p>存放在磁盘上的索引节点称为<strong>磁盘索引节点</strong></p><p>存放在内存中的索引节点称为<strong>内存索引节点</strong>，相比磁盘索引节点新增了索引节点号、状态、访问计数等</p><h3 id="文件目录"><a href="#文件目录" class="headerlink" title="文件目录"></a>文件目录</h3><p>目录管理要实现按名存取</p><p>目录结构：</p><ul><li><p>单级目录结构</p><p>  只建立一张目录表，每个文件占一个目录项</p><p>  缺点：查找速度慢，文件不允许重名，不便于共享文件</p><p>  <img src="/img/os_img/%E5%8D%95%E7%BA%A7%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png"></p></li><li><p>二级目录结构</p><p>  分为主文件目录和用户文件目录</p><p>  解决了多用户间的文件重名问题，可以实现访问限制</p><p>  缺点：缺乏灵活性，不能文件分类</p><p>  <img src="/img/os_img/%E4%B8%A4%E7%BA%A7%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png"></p></li><li><p>树形目录结构</p><p>  缺点：不便于文件共享</p><p>  <img src="/img/os_img/%E6%A0%91%E5%BD%A2%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png"></p></li><li><p>无环图目录结构</p><p>  在树形目录结构的基础上增加了一些指向同一节点的有向边，使整个目录成为一个有向无环图</p><p>  便于共享文件</p><p>  <img src="/img/os_img/%E6%97%A0%E7%8E%AF%E5%9B%BE%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png"></p></li></ul><h3 id="存储空间管理"><a href="#存储空间管理" class="headerlink" title="存储空间管理"></a>存储空间管理</h3><p><strong>概念</strong></p><p>卷（volume）：包含文件系统的分区。包含目录区和文件区</p><p>目录区：存放FCB</p><p>文件区：存放文件数据</p><p><strong>管理方式</strong></p><table><thead><tr><th></th><th>说明</th><th>分配</th><th>回收</th><th>优缺点</th></tr></thead><tbody><tr><td>空闲表法</td><td>连续分配方式。空闲表（第一个空闲盘块号，空闲盘块数）</td><td>与内存相似</td><td>与内存相似</td><td>分配速度快</td></tr><tr><td>空闲链表法</td><td>空闲盘块链、空闲盘区链</td><td>盘块的按盘块分配、盘区的从盘区里面裁出来或几个盘区合一块</td><td></td><td>盘块简单、效率低；盘区效率高、复杂</td></tr><tr><td>位示图法</td><td>每个二进制位对应一个盘块</td><td>改为“1”</td><td>改为“0”</td><td>容易找到空闲盘块，位示图大小可能会很大</td></tr><tr><td>成组链接法</td><td>超级快，存放下一组空闲盘块数和空闲块号</td><td></td><td></td><td></td></tr></tbody></table><p><img src="/img/os_img/%E7%A9%BA%E9%97%B2%E9%93%BE%E8%A1%A8%E6%B3%95.png" alt="空闲链表法"></p><p><img src="/img/os_img/%E8%B6%85%E7%BA%A7%E5%9D%97.png" alt="成组链接法"></p><h3 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h3><p><strong>创建</strong>：</p><ol><li>在外存中找到文件所需空间</li><li>在目录中创建对应的目录项</li></ol><p><strong>删除</strong>：</p><ol><li>找到目录中的目录项</li><li>回收占用的磁盘块</li><li>删除对应的目录项</li></ol><p><strong>读</strong>：</p><ol><li>给出要读的文件在打开文件表中的索引号（<strong>文件描述符</strong>）</li><li>给出要读入多少内容、放在内存哪里</li></ol><p><strong>写</strong>：</p><ol><li>给出要写的文件在打开文件表中的索引号（<strong>文件描述符</strong>）</li><li>给出要写回多少数据、数据在内存哪里</li></ol><p><strong>打开</strong>：</p><ol><li>找到目录中的目录项</li><li>将目录项复制到<strong>打开文件表</strong>中（避免多次重复检索目录）</li><li>之后用户使用打开文件表的编号来指明要操作的文件（不再使用文件名）</li></ol><p><strong>关闭</strong>：</p><ol><li>删除打开文件表中的对应表项</li><li>回收内存空间</li><li><strong>系统打开文件表</strong>的打开计数器cnt-1，若cnt&#x3D;0则删除表项</li></ol><h3 id="文件共享"><a href="#文件共享" class="headerlink" title="文件共享"></a>文件共享</h3><ul><li><p>硬链接：</p><p>  只有cnt&#x3D;0时外存中的文件才会被删除</p></li></ul><p><img src="/img/os_img/%E7%A1%AC%E9%93%BE%E6%8E%A5.png"></p><ul><li><p>软连接：</p><p>  类似于windows的快捷方式，共享文件被删除后就无法访问</p></li></ul><h3 id="文件保护"><a href="#文件保护" class="headerlink" title="文件保护"></a>文件保护</h3><ul><li>口令保护：为文件设置一个口令，用户提供口令以访问文件。口令存在系统中，不安全</li><li>加密保护：用一个密码对文件加密，用户提供密码对文件反向解密。加解密需要耗费时间</li><li>访问控制：用访问控制表(ACL)，记录用户&#x2F;组的访问权限。灵活，可以实现复杂的文件保护功能</li></ul><h3 id="文件系统层次结构"><a href="#文件系统层次结构" class="headerlink" title="文件系统层次结构"></a>文件系统层次结构</h3><p><img src="/img/os_img/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84.png"></p><ul><li>用户需要通过操作系统提供的接口发出上述请求——用户接口</li><li>由于用户提供的是文件的存放路径，因此需要操作系统一层一层地查找目录，找到对应的目录 项——文件目录系统</li><li>不同的用户对文件有不同的操作权限，因此为了保证安全，需要检查用户是否有访问权限—— 存取控制模块（存取控制验证层）</li><li>验证了用户的访问权限之后，需要把用户提供的“记录号”转变为对应的逻辑地址——逻辑文 件系统与文件信息缓冲区</li><li>知道了目标记录对应的逻辑地址后，还需要转换成实际的物理地址——物理文件系统</li><li>要删除这条记录，必定要对磁盘设备发出请求——设备管理程序模块</li><li>删除这些记录后，会有一些盘块空闲，因此要将这些空闲盘块回收——辅助分配模块</li></ul><h3 id="文件系统布局"><a href="#文件系统布局" class="headerlink" title="文件系统布局"></a>文件系统布局</h3><ul><li><p>在磁盘中的结构</p><p>  <img src="/img/os_img/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%B8%83%E5%B1%80%E7%A3%81%E7%9B%98.png"></p></li><li><p>在内存中的结构</p><ul><li>目录结构缓存</li><li>系统打开文件表</li><li>进程打开文件表</li></ul></li></ul><h3 id="虚拟文件系统"><a href="#虚拟文件系统" class="headerlink" title="虚拟文件系统"></a>虚拟文件系统</h3><p>屏蔽不同文件系统的差异和操作细节，向上为用户提供了文件操作的统一调用接口</p><p><img src="/img/os_img/%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F.png"></p><p>虚拟节点用来统一在<strong>主存</strong>中的文件数据结构</p><p><img src="/img/os_img/vnode.png"></p><p><strong>文件系统挂载</strong></p><p>在VFS中注册新挂载的文件系统。内存中的挂载表（mount table）包含每个文件系统的相关信息，包含文件系统类型、容量大小等。</p><h2 id="IO设备"><a href="#IO设备" class="headerlink" title="IO设备"></a>IO设备</h2><h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p><img src="/img/os_img/%E7%A3%81%E7%9B%98%E7%BB%93%E6%9E%84.png"></p><p>磁盘地址用 柱面号、盘面号、扇区号 决定</p><p>磁盘分类：</p><ol><li>固定头磁盘：磁头不动，每个磁道一个磁头</li><li>活动头磁盘：磁头通过磁头臂移动，每个盘面一个，<strong>所有磁头共进退</strong></li><li>固定盘磁盘：盘片不能换</li><li>可换盘磁盘：盘片可以换</li></ol><p>传统磁盘：扇区按固定圆心角度划分，存储密度从最外道向里道增加</p><p>现代磁盘：盘面划分若干环带，同一环带内的所有磁道具有相同的扇区数。越外层扇区越多</p><h3 id="磁盘调度算法"><a href="#磁盘调度算法" class="headerlink" title="磁盘调度算法"></a>磁盘调度算法</h3><p>一次操作的时间：</p><p>​寻道时间（启动磁头臂+移动磁头（<strong>调度算法决定</strong>））+ </p><p>​旋转延迟时间（找到目标扇区所需的时间）+</p><p>​传输时间（读写速度）</p><table><thead><tr><th></th><th>说明</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>先来先服务（FCFS）</td><td></td><td>公平</td><td>性能差</td></tr><tr><td>最短寻找时间优先（SSTF）</td><td>优先处理离磁头最近的磁道</td><td>性能较好，平均寻道时间短</td><td>会产生饥饿</td></tr><tr><td>扫描算法（SCAN、电梯算法）</td><td>移到头了才会转向</td><td>不会产生饥饿</td><td>时间比SSTF长，各磁道的响应时间不平均</td></tr><tr><td>LOOK调度算法</td><td>在当前方向上没有请求了就转向</td><td>比SCAN速度更快</td><td></td></tr><tr><td>循环扫描算法（C-SCAN）</td><td>只有一个方向处理请求，到头了迅速返回起点</td><td>各磁道的响应时间平均</td><td>比SCAN寻道时间长</td></tr><tr><td>C-LOOK调度算法</td><td>只有一个方向处理请求，没请求了迅速返回起点</td><td></td><td></td></tr></tbody></table><p><strong>减少延迟时间的方法</strong></p><p>交替编号（同一盘面内）：磁头读入一个扇区后需要短暂的处理时间。逻辑上相邻的块物理上保持一定间隔，在间隔的时间里处理数据</p><p>错位命名（不同盘面间）：</p><p><img src="/img/os_img/%E9%94%99%E4%BD%8D%E5%91%BD%E5%90%8D.png"></p><h3 id="磁盘管理"><a href="#磁盘管理" class="headerlink" title="磁盘管理"></a>磁盘管理</h3><p>低级格式化（物理格式化）：划分扇区</p><p>高级格式化（逻辑格式化）：将若干柱面分区，如C盘、D盘</p><p>初始化程序（自举程序）：初始化CPU、寄存器、内存等</p><p>自举装入程序：方便修改自举程序，将自举程序放在磁盘，自举装入程序负责将自举程序读入内存</p><p>坏块：损坏的扇区</p><h3 id="固态硬盘"><a href="#固态硬盘" class="headerlink" title="固态硬盘"></a>固态硬盘</h3><p>固态硬盘（SSD，Solid State Disk），基于闪存</p><p>闪存翻译层：将CPU的逻辑读写请求翻译成对物理设备的读写控制信号</p><p><img src="/img/os_img/%E5%9B%BA%E6%80%81%E7%A1%AC%E7%9B%98.png"></p><p>读写：数据以页来读写，一个页可写一次读多次。只有整个块被擦除后才能再写。访问任何地址速度是一样的</p><p>读快写慢：要修改一页，需要将整块复制到一个新块上再对页进行修改（以块为单位擦除）</p><p>磨损均衡：</p><ol><li>动态磨损均衡：写入时自动选择较新的闪存块</li><li>静态磨损均衡：读多写少的数据挪到老块，腾出较新的闪存块</li></ol><h3 id="设备控制器"><a href="#设备控制器" class="headerlink" title="设备控制器"></a>设备控制器</h3><p>也叫IO接口，CPU可控制IO接口，由IO接口来控制设备</p><p><img src="/img/os_img/%E8%AE%BE%E5%A4%87%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E7%BB%84%E6%88%90.png"></p><p><strong>设备控制器与CPU间</strong>：</p><p>一对一</p><ul><li>数据线：传送读写数据、控制信息和状态信息</li><li>地址线：传送IO接口中的寄存器编号</li><li>控制线：传送读写等控制信息</li></ul><p><strong>设备控制器与设备间</strong>：</p><p>一对多</p><ul><li>数据信号</li><li>控制信号</li><li>状态信号</li></ul><p><strong>寄存器</strong>：</p><ul><li>数据寄存器：保存CPU或设备传来的数据</li><li>控制寄存器：保存CPU传来的控制信息</li><li>状态寄存器：保存设备的执行结果或状态信息</li></ul><p><strong>寄存器编址方式</strong>：</p><ul><li>内存映射编址（统一编址）：将主存地址空间分出一部分IO端口进行编址</li><li>寄存器独立编址（独立编址）：寄存器地址和主存分开编址</li></ul><h3 id="IO控制方式"><a href="#IO控制方式" class="headerlink" title="IO控制方式"></a>IO控制方式</h3><ul><li><p>程序直接控制</p><p>  CPU不断询问是否已准备好数据，当发现状态寄存器已就绪，则读数据寄存器一个字到CPU寄存器中，再把CPU寄存器中的内容放入内存</p><p>  优点：简单</p><p>  缺点：CPU空转，利用率低</p></li><li><p>中断驱动</p><p>  设备准备完后，设备控制器发出中断信号来告知CPU。CPU读取一个字的数据到CPU寄存器，然后再存到主存，之后阻塞进程，继续执行其他操作</p><p>  优点：不再需要轮询，提升了利用率</p><p>  缺点：以字（节）为单位进行干预，效率仍然低</p></li><li><p>DMA</p><p>  直接存储器存取，IO设备将数据直接放到内存</p><p>  优点：以块为单位传输，CPU只在传输的开始和结束有干预</p><p>  缺点：CPU每发出一条IO指令，只能读写一个或多个连续的块</p></li><li><p>通道控制</p><p>  将IO任务存在内存中（通道程序），告诉通道任务在内存中的位置，由通道来完成规定的IO任务，完成后发出中断信号告知CPU。一个通道可对应多个IO控制器</p><p>  优点：一次传输一组块</p></li></ul><h3 id="IO软件层次结构"><a href="#IO软件层次结构" class="headerlink" title="IO软件层次结构"></a>IO软件层次结构</h3><p><img src="/img/os_img/IO%E8%BD%AF%E4%BB%B6%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84.png"></p><h3 id="IO接口"><a href="#IO接口" class="headerlink" title="IO接口"></a>IO接口</h3><ol><li><p>字符设备接口</p><p> 以字符为单位存取和传输，如键盘、打印机等</p><p> 特征：传输速率低、不可寻址</p></li><li><p>块设备接口</p><p> 以数据块块为单位存取和传输，如磁盘等</p><p> 特征：传输速率快、可寻址</p></li><li><p>网络设备接口</p><p> 网卡</p></li></ol><p>阻塞IO和非阻塞IO：</p><ol><li>阻塞：用户进程调用IO操作时，进程就被阻塞。如字符设备接口</li><li>非阻塞：用户进程调用IO操作时，不阻塞进程。如块设备接口</li></ol><h3 id="缓存和缓冲区"><a href="#缓存和缓冲区" class="headerlink" title="缓存和缓冲区"></a>缓存和缓冲区</h3><ul><li><p>磁盘高速缓存</p><p>  利用内存中的存储空间来暂存从磁盘中读出的一系列盘块中的信息</p></li><li><p>缓冲区</p><ul><li>单缓冲</li><li>双缓冲</li><li>循环缓冲</li><li>缓冲池</li></ul></li></ul><blockquote><p>缓存用于存放经常要访问的数据</p><p>缓冲用于高速设备和低速设备的数据交换，缓和高速设备和低速设备之间速度的差距</p></blockquote><h3 id="设备分配和回收"><a href="#设备分配和回收" class="headerlink" title="设备分配和回收"></a>设备分配和回收</h3><p><strong>数据结构</strong>：</p><ul><li>设备控制表（DCT）：每个设备对应一张</li><li>控制器控制表（COCT）：每个控制器对应一张</li><li>通道控制表（CHCT）：每个通道对应一张</li><li>系统设备表（SDT）：记录整个系统中所有设备的情况</li></ul><p>安全分配：进程获得设备后便会阻塞，直到IO操作完成</p><p>不安全分配：进程发出IO请求后仍然继续运行，可以拥有多个设备，可能造成死锁</p><p><strong>分配步骤</strong>：</p><ol><li>分配设备：查询SDT中的DCT</li><li>分配控制器：根据DCT找到COCT</li><li>分配通道：根据COCT找到CHCT</li></ol><p><strong>SPOOLING技术（假脱机）</strong>：</p><p>脱机：IO输入不需要人来输入，如磁带</p><p>假脱机：用软件实现脱机</p><p><img src="/img/os_img/%E5%81%87%E8%84%B1%E6%9C%BA%E6%8A%80%E6%9C%AF.png"></p><h3 id="驱动程序接口"><a href="#驱动程序接口" class="headerlink" title="驱动程序接口"></a>驱动程序接口</h3><p>接收上层应用发来的抽象IO请求，将它们转换为具体要求后发送给设备控制器</p><h1 id="复试简答题"><a href="#复试简答题" class="headerlink" title="复试简答题"></a>复试简答题</h1><p><strong>1.文件链接方式</strong></p><ul><li><strong>隐式链接</strong>：文件的所有块通过指针链接在一起，形成一个链表，随机访问效率低。</li><li><strong>显式链接</strong>：文件的块位置信息存储在外部数据结构中，而不是存储在块本身，随机访问效率高。</li><li><strong>索引链接</strong>：使用索引块存储文件块位置，适合大文件，随机访问效率高。</li></ul><p><strong>FAT</strong>（File Allocation Table，文件分配表）是一种用于管理磁盘上文件存储的数据结构。它是<strong>显式链接</strong>的一种实现方式，用于记录文件在磁盘上的存储位置和分配情况。</p><p><strong>2.什么是分时系统，分时系统的特点</strong></p><p><strong>分时系统（Time-Sharing System）</strong> 是一种操作系统的设计模式，允许多个用户通过终端同时使用计算机资源。在分时系统中，CPU 的时间被划分为很小的时间片（Time Slice），每个用户或任务轮流使用 CPU 的时间片，从而实现多个用户或任务“同时”执行的效果。</p><p><strong>特点</strong>：</p><ol><li>允许多个用户通过终端同时访问系统</li><li>每个任务或用户轮流使用 CPU</li><li>用户可以通过终端与系统实时交互</li><li>系统响应速度较快</li></ol><p><strong>3.死锁的四个必要条件</strong></p><p><strong>死锁（Deadlock）</strong> 是指多个进程或线程在执行过程中，因为竞争资源而互相等待，导致它们都无法继续执行的状态</p><ol><li>互斥条件：资源一次只能被一个进程占用</li><li>请求和保持：进程已经占有了至少一个资源，同时又在等待获取其他被占用的资源</li><li>不可抢占：进程已经占有的资源不能被强行剥夺，必须由进程主动释放</li><li>循环等待：存在一个进程等待的循环链，每个进程都在等待下一个进程所占有的资源</li></ol><p><strong>4.进程和线程的区别</strong></p><p><strong>进程</strong> 进程是程序的一次执行实例，是操作系统资源分配的基本单位，具有独立的内存空间和资源，进程切换的开销较大</p><p><strong>线程</strong> 是 CPU 调度的基本单位，共享进程的内存空间和资源，线程切换的开销较小</p><p><strong>5.什么是抖动</strong></p><p>当系统频繁地在内存和磁盘之间进行页面交换（Page Swapping）时，会导致 CPU 的大部分时间都花在处理页面置换上，而不是执行实际的任务，从而导致系统性能急剧下降。这种现象被称为抖动</p><p>原因：内存不足；页面置换算法不合理</p><p><strong>6.简述PCB的内容</strong></p><p>PCB 是操作系统中用于管理和控制进程的核心数据结构，包含了进程的标识信息、状态信息、调度信息、上下文信息、内存管理信息、文件管理信息、资源使用信息、进程通信信息和统计信息。通过 PCB，操作系统可以高效地管理进程的生命周期、资源分配和上下文切换。</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>高数基础</title>
    <link href="/2024/04/01/%E8%80%83%E7%A0%94/%E9%AB%98%E6%95%B0%E5%9F%BA%E7%A1%80/"/>
    <url>/2024/04/01/%E8%80%83%E7%A0%94/%E9%AB%98%E6%95%B0%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="高数基础"><a href="#高数基础" class="headerlink" title="高数基础"></a>高数基础</h1><h2 id="极限"><a href="#极限" class="headerlink" title="极限"></a>极限</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p><img src="/img/math_img/%E4%B8%80/%E6%9E%81%E9%99%90%E5%AE%9A%E4%B9%89.png"></p><h3 id="极限运算"><a href="#极限运算" class="headerlink" title="极限运算"></a>极限运算</h3><ol><li>有限个无穷小的和为无穷小</li><li><strong>有界函数 x 无穷小 &#x3D; 无穷小</strong></li></ol><h3 id="夹逼定理"><a href="#夹逼定理" class="headerlink" title="夹逼定理"></a>夹逼定理</h3><p><img src="/img/math_img/%E4%B8%80/%E5%A4%B9%E9%80%BC%E5%AE%9A%E7%90%86.png"></p><h3 id="重要极限"><a href="#重要极限" class="headerlink" title="重要极限"></a>重要极限</h3><ol><li><p><img src="/img/math_img/%E4%B8%80/%E9%87%8D%E8%A6%81%E6%9E%81%E9%99%901.png"></p><p> 根据夹逼定理证明</p></li><li><p><img src="/img/math_img/%E4%B8%80/%E9%87%8D%E8%A6%81%E6%9E%81%E9%99%902.png"></p><p> 单调函数必有界证明</p></li></ol><h3 id="无穷小比较"><a href="#无穷小比较" class="headerlink" title="无穷小比较"></a>无穷小比较</h3><p>α和β存在极限且都是无穷小时：</p><p><img src="/img/math_img/%E4%B8%80/%E6%97%A0%E7%A9%B7%E5%B0%8F%E7%9A%84%E6%AF%94%E8%BE%83.png"></p><p><strong>常见等价无穷小</strong>：</p><p><strong>求两个无穷小之比的极限时，分子及分母都可用等价无穷小来替代</strong></p><p><img src="/img/math_img/%E4%B8%80/%E5%B8%B8%E8%A7%81%E7%AD%89%E4%BB%B7%E6%97%A0%E7%A9%B7%E5%B0%8F.png"></p><h3 id="泰勒公式"><a href="#泰勒公式" class="headerlink" title="泰勒公式"></a>泰勒公式</h3><p><strong>泰勒公式的作用</strong>：用一个多项式函数去逼近一个给定的函数，逼近的时候一定是从函数图像上的某个点展开</p><p><img src="/img/math_img/%E4%B8%80/%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F.png"></p><p>其中Rn(x)表示余项，是泰勒公式与原函数之间的误差</p><p><strong>余项的常见形式</strong>：</p><ol><li><p>拉格朗日余项</p><p> 给出了泰勒展开式中误差的精确表达式</p><p> <img src="/img/math_img/%E4%B8%80/%E6%8B%89%E6%A0%BC%E6%9C%97%E6%97%A5%E4%BD%99%E9%A1%B9.png"></p></li><li><p>佩亚诺余项</p><p> 给出了泰勒展开式中误差的一个渐近表达式，描述了误差的一个渐近行为，而不是一个具体的数值</p><p> <img src="/img/math_img/%E4%B8%80/%E4%BD%A9%E4%BA%9A%E8%AF%BA%E4%BD%99%E9%A1%B9.png"></p></li><li><p>区别</p><ul><li>拉格朗日余项适用于需要具体误差估计的情况，例如在数值计算中。</li><li>佩亚诺余项适用于理论分析，特别是在<strong>证明某些极限</strong>或渐近性质时</li></ul></li></ol><p><strong>常见的泰勒公式</strong></p><p><img src="/img/math_img/%E4%B8%80/%E5%B8%B8%E8%A7%81%E7%9A%84%E5%B8%A6%E4%BD%A9%E4%BA%9A%E8%AF%BA%E4%BD%99%E9%A1%B9%E7%9A%84%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F.png"></p><p><strong>例题</strong></p><p><img src="/img/math_img/%E4%B8%80/%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F%E4%BE%8B%E9%A2%981.png" alt="展开到与分母同幂"></p><p><img src="/img/math_img/%E4%B8%80/%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F%E4%BE%8B%E9%A2%982.png" alt="分母幂未知,展开到不为零的最低次幂"></p><p><img src="/img/math_img/%E4%B8%80/%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F%E4%BE%8B%E9%A2%983.png" alt="分母也需要展开,先展开分母"></p><p><img src="/img/math_img/%E4%B8%80/%E6%B3%B0%E5%8B%92%E5%85%AC%E5%BC%8F%E4%BE%8B%E9%A2%984.png" alt="易错题"></p><h3 id="拉格朗日中值定理"><a href="#拉格朗日中值定理" class="headerlink" title="拉格朗日中值定理"></a>拉格朗日中值定理</h3><p><img src="/img/math_img/%E4%B8%80/%E6%8B%89%E6%A0%BC%E6%9C%97%E6%97%A5%E4%B8%AD%E5%80%BC%E5%AE%9A%E7%90%86.png"></p><h2 id="向量代数与空间几何"><a href="#向量代数与空间几何" class="headerlink" title="向量代数与空间几何"></a>向量代数与空间几何</h2><h3 id="数量积和向量积"><a href="#数量积和向量积" class="headerlink" title="数量积和向量积"></a>数量积和向量积</h3><ol><li><p>数量积（点乘、是数）</p><p> 公式：</p><p> <img src="/img/math_img/%E5%85%AB/%E6%95%B0%E9%87%8F%E7%A7%AF%E5%85%AC%E5%BC%8F1.png"></p><p> <img src="/img/math_img/%E5%85%AB/%E6%95%B0%E9%87%8F%E7%A7%AF%E5%85%AC%E5%BC%8F2.png"></p><p> 注意点：</p><ol><li>数量积<strong>满足</strong>分配律和交换律</li><li>点乘为0表示a⊥b</li></ol></li><li><p>向量积（叉乘、是向量）</p><p> 公式：</p><p> <img src="/img/math_img/%E5%85%AB/%E5%90%91%E9%87%8F%E7%A7%AF%E5%85%AC%E5%BC%8F1.png"></p><p> <img src="/img/math_img/%E5%85%AB/%E5%90%91%E9%87%8F%E7%A7%AF%E5%85%AC%E5%BC%8F2.png"></p><p> 注意点：</p><ol><li>向量积<strong>不满足</strong>交换律</li><li>叉乘为0表示a∥b</li><li>向量积方向垂直于两个向量所在平面</li></ol></li><li><p>混合积</p><p> 公式：(a x b) · c，绝对值可表示为六面体的体积</p></li></ol><h3 id="平面"><a href="#平面" class="headerlink" title="平面"></a>平面</h3><ol><li><p>表示平面的方程</p><ol><li><p><strong>点法式</strong>：法向量+平面内一点</p><p> <img src="/img/math_img/%E5%85%AB/%E5%B9%B3%E9%9D%A2%E7%82%B9%E6%B3%95%E5%BC%8F.png"></p></li><li><p><strong>一般方程</strong></p><p> Ax + By + Cz + D &#x3D; 0 </p><p> <img src="/img/math_img/%E5%85%AB/%E5%B9%B3%E9%9D%A2%E4%B8%80%E8%88%AC%E6%96%B9%E7%A8%8B.png"></p></li><li><p><strong>截距式</strong></p><p> <img src="/img/math_img/%E5%85%AB/%E5%B9%B3%E9%9D%A2%E6%88%AA%E8%B7%9D%E5%BC%8F.png"></p></li></ol></li><li><p>平面夹角</p><p> <img src="/img/math_img/%E5%85%AB/%E5%B9%B3%E9%9D%A2%E5%A4%B9%E8%A7%92.png"></p></li><li><p>点到平面的距离</p><p> <img src="/img/math_img/%E5%85%AB/%E7%82%B9%E5%88%B0%E5%B9%B3%E9%9D%A2%E7%9A%84%E8%B7%9D%E7%A6%BB.png"></p></li></ol><h3 id="直线"><a href="#直线" class="headerlink" title="直线"></a>直线</h3><ol><li><p>表示直线的方程</p><ol><li><p>一般方程：两个平面的交线</p><p> <img src="/img/math_img/%E5%85%AB/%E7%9B%B4%E7%BA%BF%E4%B8%80%E8%88%AC%E6%96%B9%E7%A8%8B.png"></p></li><li><p>对称式：和方向向量成比例</p><p> <img src="/img/math_img/%E5%85%AB/%E7%9B%B4%E7%BA%BF%E5%AF%B9%E7%A7%B0%E5%BC%8F.png"></p></li><li><p>参数方程</p><p> <img src="/img/math_img/%E5%85%AB/%E7%9B%B4%E7%BA%BF%E5%8F%82%E6%95%B0%E6%96%B9%E7%A8%8B.png"></p></li></ol></li><li><p>直线夹角</p><p> <img src="/img/math_img/%E5%85%AB/%E7%9B%B4%E7%BA%BF%E5%A4%B9%E8%A7%92.png"></p></li><li><p>直线与平面的夹角</p><p> <strong>注意</strong>：是直线与平面的夹角，不是直线与法线的夹角</p><p> <img src="/img/math_img/%E5%85%AB/%E7%9B%B4%E7%BA%BF%E4%B8%8E%E5%B9%B3%E9%9D%A2%E7%9A%84%E5%A4%B9%E8%A7%92.png"></p></li></ol><h3 id="平面束"><a href="#平面束" class="headerlink" title="平面束"></a>平面束</h3><p>通过一条直线的所有平面的集合称为平面束</p><p><img src="/img/math_img/%E5%85%AB/%E5%B9%B3%E9%9D%A2%E6%9D%9F.png"></p><h3 id="曲面"><a href="#曲面" class="headerlink" title="曲面"></a>曲面</h3><p><strong>常见曲面方程</strong></p><ol><li><p>球面</p><p> <img src="/img/math_img/%E5%85%AB/%E7%90%83%E9%9D%A2.png"></p></li><li><p>旋转曲面</p><p> 如一个曲线绕f(0, y, z) &#x3D; 0绕z轴旋转，则到z轴的距离为 根号(x²+y²) ，方程为f(±根号(x²+y²), z)</p><p> <strong>绕谁转谁不变</strong></p></li><li><p>单叶双曲线</p><p> xOz面上的双曲线(x²&#x2F;a² - y²&#x2F;c²) &#x3D; 1 绕z轴旋转得到 </p><p> <img src="/img/math_img/%E5%85%AB/%E5%8D%95%E5%8F%B6%E5%8F%8C%E6%9B%B2%E7%BA%BF.png"></p></li><li><p>双叶双曲线</p><p> xOz面上的双曲线(x²&#x2F;a² - y²&#x2F;c²) &#x3D; 1 绕x轴旋转得到 </p><p> <img src="/img/math_img/%E5%85%AB/%E5%8F%8C%E5%8F%B6%E5%8F%8C%E6%9B%B2%E7%BA%BF.png"></p></li><li><p>柱面</p><p> 方程：x² + y² &#x3D; R²，没有规定z轴，所以z轴为母线，x² + y² &#x3D; R²为基准线</p></li><li><p>二次曲面</p><p> 三元<strong>二次</strong>方程表示的曲面</p><ol><li><p>椭圆锥面：<img src="/img/math_img/%E5%85%AB/%E6%A4%AD%E5%9C%86%E9%94%A5%E9%9D%A2.png"></p><p> <img src="/img/math_img/%E5%85%AB/%E6%A4%AD%E5%9C%86%E9%94%A5%E9%9D%A2%E5%9B%BE%E5%83%8F.png"></p></li><li><p>椭球面 ：</p><p> <img src="/img/math_img/%E5%85%AB/%E6%A4%AD%E7%90%83%E9%9D%A2.png"></p></li></ol></li></ol><h2 id="多元函数微分"><a href="#多元函数微分" class="headerlink" title="多元函数微分"></a>多元函数微分</h2><h3 id="偏导数"><a href="#偏导数" class="headerlink" title="偏导数"></a>偏导数</h3><p>求偏导时将其他变量看做常数</p><p>偏导存在，不能保证函数在该点连续</p><h3 id="全微分"><a href="#全微分" class="headerlink" title="全微分"></a>全微分</h3><p>全增量：各个 变量 都取得增量时 因变量 所获得的增量</p><p><img src="/img/math_img/%E4%B9%9D/%E5%85%A8%E5%A2%9E%E9%87%8F.png"></p><p>全微分：全增量的近似，全增量 &#x3D; 全微分 + 高阶无穷小</p><p>偏导存在是全微分的 必要不充分条件</p><p><img src="/img/math_img/%E4%B9%9D/%E5%85%A8%E5%BE%AE%E5%88%86.png"></p><p>全微分等于偏微分之和</p><p><img src="/img/math_img/%E4%B9%9D/%E5%85%A8%E5%BE%AE%E5%88%862.png"></p><h3 id="多元复合函数求导"><a href="#多元复合函数求导" class="headerlink" title="多元复合函数求导"></a>多元复合函数求导</h3><p>原函数先对复合函数求偏导，复合函数再求偏导</p><p><img src="/img/math_img/%E4%B9%9D/%E5%A4%9A%E5%85%83%E5%A4%8D%E5%90%88%E5%87%BD%E6%95%B0%E6%B1%82%E5%AF%BC.png"></p><h3 id="隐函数求导"><a href="#隐函数求导" class="headerlink" title="隐函数求导"></a>隐函数求导</h3><p>隐函数：如F(x, f(x))的f(x)，F(x,y,f(x,y))的f(x,y)</p><p><img src="/img/math_img/%E4%B9%9D/%E9%9A%90%E5%87%BD%E6%95%B0%E5%AD%98%E5%9C%A8%E5%AE%9A%E7%90%861.png"></p><p><strong>雅可比式</strong></p><p>在<strong>方程组</strong>的情况下用</p><p><img src="/img/math_img/%E4%B9%9D/%E9%9B%85%E5%8F%AF%E6%AF%94.png"></p><p><img src="/img/math_img/%E4%B9%9D/%E9%9B%85%E5%8F%AF%E6%AF%942.png"></p><h3 id="几何应用"><a href="#几何应用" class="headerlink" title="几何应用"></a>几何应用</h3><p><strong>空间曲线</strong></p><p>切向量：</p><ol><li>参数方程时：求导</li><li>y、z为关于x的方程：x&#x3D;1，y、z求导</li><li>两个平面的交线形式：雅可比求出y、z导数，x设为1</li></ol><p><img src="/img/math_img/%E4%B9%9D/%E7%A9%BA%E9%97%B4%E6%9B%B2%E7%BA%BF%E5%88%87%E7%BA%BF%E6%96%B9%E7%A8%8B.png"></p><p><img src="/img/math_img/%E4%B9%9D/%E7%A9%BA%E9%97%B4%E6%9B%B2%E7%BA%BF%E6%B3%95%E5%B9%B3%E9%9D%A2.png"></p><p><strong>曲面</strong></p><p>法向量n：</p><ol><li>F(x,y,z)&#x3D;0：n&#x3D;(Fx, Fy, Fz)</li><li>z是关于x，y的方程：z移到x、y一边然后求偏导</li></ol><p><img src="/img/math_img/%E4%B9%9D/%E6%9B%B2%E9%9D%A2.png"></p><h3 id="方向导数与梯度"><a href="#方向导数与梯度" class="headerlink" title="方向导数与梯度"></a>方向导数与梯度</h3><p><strong>方向导数</strong>：自变量变化时，给定方向的变化率。方向导数是数</p><p><img src="/img/math_img/%E4%B9%9D/%E6%96%B9%E5%90%91%E5%AF%BC%E6%95%B0.png"></p><p><strong>梯度</strong>：F(x,y)的梯度是(Fx,Fy)。梯度是向量。方向导数&#x3D;梯度 x 单位向量。二元以上的函数才有梯度</p><p><strong>梯度的方向</strong>：自变量变化的方向中，使因变量变化率最快的方向</p><h3 id="多元函数极值"><a href="#多元函数极值" class="headerlink" title="多元函数极值"></a>多元函数极值</h3><p>驻点：一阶偏导为0的点，不一定为极值点</p><p>极值点：在某个范围内的极大(极小)值</p><p>判断驻点是不是极值点：</p><p><img src="/img/math_img/%E4%B9%9D/%E5%88%A4%E6%96%AD%E6%9E%81%E5%80%BC.png"></p><p><strong>偏导不存在的点也有可能是极值点，需要加以判断</strong></p><p><strong>条件极值</strong>：对自变量有附加条件的极值</p><p>求解方法：</p><ol><li>将条件极值化为无条件极值</li><li>拉格朗日数乘法</li></ol><p><img src="/img/math_img/%E4%B9%9D/%E6%8B%89%E6%A0%BC%E6%9C%97%E6%97%A5%E6%95%B0%E4%B9%98%E6%B3%95.png"></p><h2 id="重积分"><a href="#重积分" class="headerlink" title="重积分"></a>重积分</h2><h3 id="二重积分定义"><a href="#二重积分定义" class="headerlink" title="二重积分定义"></a>二重积分定义</h3><p>常用于算体积</p><p><img src="/img/math_img/%E5%8D%81/%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E5%AE%9A%E4%B9%89.png"></p><h3 id="二重积分估值"><a href="#二重积分估值" class="headerlink" title="二重积分估值"></a>二重积分估值</h3><p>用于估计二重积分的值的范围</p><p><img src="/img/math_img/%E5%8D%81/%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%BC%B0%E5%80%BC.png"></p><h3 id="二重积分中值定义"><a href="#二重积分中值定义" class="headerlink" title="二重积分中值定义"></a>二重积分中值定义</h3><p><img src="/img/math_img/%E5%8D%81/%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E4%B8%AD%E5%80%BC%E5%AE%9A%E7%90%86.png"></p><h3 id="二重积分计算"><a href="#二重积分计算" class="headerlink" title="二重积分计算"></a>二重积分计算</h3><p>将二重积分转化为二次积分来计算</p><p>要选择合适的坐标系来计算</p><p><strong>直角坐标</strong></p><p>X型：x轴的积分范围为两个常数</p><p>Y型：y轴的积分范围为两个常数</p><p><strong>极坐标</strong></p><p>适用范围</p><ol><li>积分区域为圆、圆环、扇形</li><li>f(x²+y²)、f(y&#x2F;x)、f(x&#x2F;y)这种不好积分的函数</li></ol><p><img src="/img/math_img/%E5%8D%81/%E6%9E%81%E5%9D%90%E6%A0%87%E8%AE%A1%E7%AE%97%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86.png"></p><p><strong>换元法</strong></p><p>适用范围</p><ol><li>被积函数不好积</li><li>积分区域不好表示</li></ol><p><img src="/img/math_img/%E5%8D%81/%E4%BA%8C%E9%87%8D%E7%A7%AF%E5%88%86%E6%8D%A2%E5%85%83%E6%B3%95.png"></p><h3 id="三重积分计算"><a href="#三重积分计算" class="headerlink" title="三重积分计算"></a>三重积分计算</h3><p><strong>直角坐标</strong></p><p>计算三重积分时，可以先计算一个定积分，再计算一个二重积分</p><p><strong>柱面坐标</strong></p><p><img src="/img/math_img/%E5%8D%81/%E6%9F%B1%E9%9D%A2%E5%9D%90%E6%A0%87%E8%AE%A1%E7%AE%97%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86.png"></p><p><strong>球面坐标</strong></p><p><img src="/img/math_img/%E5%8D%81/%E7%90%83%E9%9D%A2%E5%9D%90%E6%A0%87%E8%AE%A1%E7%AE%97%E4%B8%89%E9%87%8D%E7%A7%AF%E5%88%86.png"></p><h2 id="曲线积分"><a href="#曲线积分" class="headerlink" title="曲线积分"></a>曲线积分</h2><h3 id="对弧长的曲线积分"><a href="#对弧长的曲线积分" class="headerlink" title="对弧长的曲线积分"></a>对弧长的曲线积分</h3><p>第一类曲线积分</p><p>可看做求一段弧的质量（描述<strong>标量场</strong>对曲线的作用 ）</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86.png"></p><p><strong>计算</strong></p><p>ds的各种表达</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%971.png"></p><p>弧长用参数方程表达，如果是算质量，因为质量大于0下限要小于上限</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%972.png"></p><p>扩展到三维空间</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%973.png"></p><p>用对称性简化计算</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%974.png"></p><h3 id="对坐标的曲线积分"><a href="#对坐标的曲线积分" class="headerlink" title="对坐标的曲线积分"></a>对坐标的曲线积分</h3><p>第二类曲线积分</p><p>可看做变力沿曲线做功（描述<strong>向量场</strong>对曲线的作用 ）</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%861.png"></p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%862.png"></p><p><strong>计算</strong></p><p>下限不一定小于上限</p><p>二维空间</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%971.png"></p><p>直角坐标下和三维空间下</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%972.png"></p><p>奇偶性不要乱用，和对弧长的不一样</p><h3 id="两类曲线积分的联系"><a href="#两类曲线积分的联系" class="headerlink" title="两类曲线积分的联系"></a>两类曲线积分的联系</h3><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E4%B8%A4%E7%B1%BB%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E7%9A%84%E8%81%94%E7%B3%BB.png"></p><h3 id="star-格林公式"><a href="#star-格林公式" class="headerlink" title=":star:格林公式"></a>:star:格林公式</h3><p>平面闭区域上的二重积分与边界曲线的曲线积分的关系</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%A0%BC%E6%9E%97%E5%85%AC%E5%BC%8F.png"></p><p>包含奇点的例题</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%A0%BC%E6%9E%97%E5%85%AC%E5%BC%8F%E4%BE%8B%E9%A2%981.png"></p><p>格林公式计算面积</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%A0%BC%E6%9E%97%E5%85%AC%E5%BC%8F%E8%AE%A1%E7%AE%97%E9%9D%A2%E7%A7%AF.png"></p><p>曲线积分与路径无关的条件</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%9B%B2%E7%BA%BF%E7%A7%AF%E5%88%86%E4%B8%8E%E8%B7%AF%E5%BE%84%E6%97%A0%E5%85%B3%E7%9A%84%E6%9D%A1%E4%BB%B6.png"></p><h3 id="star-斯托克斯公式"><a href="#star-斯托克斯公式" class="headerlink" title=":star:斯托克斯公式"></a>:star:斯托克斯公式</h3><p>格林公式的推广，空间曲面与便捷曲线的曲线积分的关系</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%96%AF%E6%89%98%E5%85%8B%E6%96%AF%E5%85%AC%E5%BC%8F1.png"></p><p>斯托克斯公式的其他表达方式</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%96%AF%E6%89%98%E5%85%8B%E6%96%AF%E5%85%AC%E5%BC%8F2.png"></p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%96%AF%E6%89%98%E5%85%8B%E6%96%AF%E5%85%AC%E5%BC%8F3.png"></p><p>空间曲线与路径无关的条件</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%A9%BA%E9%97%B4%E6%9B%B2%E7%BA%BF%E4%B8%8E%E8%B7%AF%E5%BE%84%E6%97%A0%E5%85%B3%E7%9A%84%E6%9D%A1%E4%BB%B6.png"></p><p>环流量与旋度</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%8E%AF%E6%B5%81%E9%87%8F.png"></p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%97%8B%E5%BA%A6.png"></p><h2 id="曲面积分"><a href="#曲面积分" class="headerlink" title="曲面积分"></a>曲面积分</h2><h3 id="对面积的曲面积分"><a href="#对面积的曲面积分" class="headerlink" title="对面积的曲面积分"></a>对面积的曲面积分</h3><p>第一类曲面积分</p><p>看做计算曲面的质量</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86.png"></p><p><strong>计算</strong></p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%B8%80%E7%B1%BB%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86%E8%AE%A1%E7%AE%97.png"></p><h3 id="对坐标的全面积分"><a href="#对坐标的全面积分" class="headerlink" title="对坐标的全面积分"></a>对坐标的全面积分</h3><p>第二类曲面积分</p><p>看做通过曲面的流量</p><p>法向量n的指向为上侧</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86.png"></p><p>:star:<strong>计算</strong></p><ol><li><p>化为二重积分：1投2代3定符号</p><p> <img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%981.png"></p></li><li><p>化为第一类曲面积分</p><p> <img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86%E5%8C%96%E4%B8%BA%E7%AC%AC%E4%B8%80%E7%B1%BB.png"></p></li><li><p>更换投影坐标面</p><p> <img src="/img/math_img/%E5%8D%81%E4%B8%80/%E7%AC%AC%E4%BA%8C%E7%B1%BB%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86%E4%BE%8B%E9%A2%982.png"></p></li><li><p>高斯公式</p><p> <img src="/img/math_img/%E5%8D%81%E4%B8%80/%E9%AB%98%E6%96%AF%E5%85%AC%E5%BC%8F.png"></p></li></ol><h3 id="star-高斯公式"><a href="#star-高斯公式" class="headerlink" title=":star:高斯公式"></a>:star:高斯公式</h3><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E9%AB%98%E6%96%AF%E5%85%AC%E5%BC%8F.png"></p><p>沿闭曲面积分为零的条件</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%B2%BF%E9%97%AD%E6%9B%B2%E9%9D%A2%E7%A7%AF%E5%88%86%E4%B8%BA%E9%9B%B6%E7%9A%84%E6%9D%A1%E4%BB%B6.png"></p><p>通量和散度</p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E9%80%9A%E9%87%8F.png"></p><p><img src="/img/math_img/%E5%8D%81%E4%B8%80/%E6%95%A3%E5%BA%A6.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>考研</category>
      
    </categories>
    
    
    <tags>
      
      <tag>考研</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>树莓派</title>
    <link href="/2023/12/12/%E5%85%B6%E4%BB%96/%E6%A0%91%E8%8E%93%E6%B4%BE/"/>
    <url>/2023/12/12/%E5%85%B6%E4%BB%96/%E6%A0%91%E8%8E%93%E6%B4%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="树莓派"><a href="#树莓派" class="headerlink" title="树莓派"></a>树莓派</h1><h2 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h2><h3 id="方法1-ssh-cpolar"><a href="#方法1-ssh-cpolar" class="headerlink" title="方法1: ssh + cpolar"></a>方法1: ssh + cpolar</h3><ol><li><p>开启ssh</p><p> 拔下sd卡，通过读卡器读取，在目录下创建名字为<code>ssh</code>的文件，装回sd卡即可</p></li><li><p>树莓派安装cpolar</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">下载</span><br>curl -L https://www.cpolar.com/static/downloads/install-release-cpolar.sh | sudo bash<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看版本</span><br>cpolar version<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">token认证，在官网可以找到token</span><br>cpolar authtoken xxxxxxxxxxxxxxxxxx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置cpolar开机自启动</span><br>sudo systemctl enable cpolar<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">守护进程方式，启动cpolar</span><br>sudo systemctl start cpolar<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看cpolar守护进程状态, active为启动</span><br>sudo systemctl status cpolar<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">外网ssh连接，官网找地址</span><br>ssh 用户名@映射的网址 -p 端口号<br></code></pre></td></tr></table></figure></li></ol><h3 id="方法2：无线网络-远程桌面连接"><a href="#方法2：无线网络-远程桌面连接" class="headerlink" title="方法2：无线网络 + 远程桌面连接"></a>方法2：无线网络 + 远程桌面连接</h3><ol><li><p>添加无线网络信息</p><p> 电脑连接sd卡，创建配置文件wpa_supplicant.conf（这步不知道为什么没有生效，直接通过桌面设置的wifi）</p><p> priority：优先级，数字越大优先级越高</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">country=CN<br>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev<br>update_config=1<br>network=&#123;<br>ssid=&quot;无线网名称&quot;<br>psk=&quot;密码&quot;<br>priority=10<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">有其他wifi可以继续配置</span><br>network=&#123;<br>ssid=&quot;无线网名称&quot;<br>psk=&quot;密码&quot;<br>priority=10<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>树莓派安装xrdp</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install xrdp<br></code></pre></td></tr></table></figure></li><li><p>windows电脑打开无线热点，查看连接到的设备ip</p></li><li><p>打开windows自带的远程桌面连接工具，输入设备的ip及用户名密码来连接桌面</p></li><li><p>也可以用其他shell软件来ssh连接树莓派，如用FinalShell还可以进行文件传输</p></li></ol><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><ol><li><p>关机</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo poweroff关闭电源<br>sudo shutdown -h now 立刻关机<br>sudo shutdown -r now 立刻重启<br>sodo shutdown -h +2 2分钟后关机<br></code></pre></td></tr></table></figure></li><li><p>命令别名</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">打开文件</span><br>vim ~/.bashrc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加下面代码</span><br>lias ll=&#x27;ls -l&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新配置文件</span><br>source ~/.bashrc<br></code></pre></td></tr></table></figure></li><li><p>基本命令</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">ls    <br>pwd<br>cd <br>mkdir<br></code></pre></td></tr></table></figure></li></ol><h2 id="安装软件-x2F-环境"><a href="#安装软件-x2F-环境" class="headerlink" title="安装软件&#x2F;环境"></a>安装软件&#x2F;环境</h2><h3 id="Vim"><a href="#Vim" class="headerlink" title="Vim"></a>Vim</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install vim<br></code></pre></td></tr></table></figure><h3 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h3><p>树莓派4B自带了python3</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>go反射</title>
    <link href="/2023/11/24/go/go%E5%8F%8D%E5%B0%84/"/>
    <url>/2023/11/24/go/go%E5%8F%8D%E5%B0%84/</url>
    
    <content type="html"><![CDATA[<h2 id="go反射"><a href="#go反射" class="headerlink" title="go反射"></a>go反射</h2><h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><ul><li>在运行时动态创建对象 </li><li>在运行时动态修改对象的属性 </li><li>在运行时动态调用对象的方法 </li><li>在运行时动态判断对象的类型 </li><li>在运行时动态序列化和反序列化对象</li></ul><h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><ul><li>reflect.TypeOf() ：获取变量的类型。 </li><li>reflect.ValueOf() ：获取变量的值。 </li><li>reflect.Value.Type()：获取reflect.Value的类型</li><li>reflect.Value.Interface()：将reflect.Value转换为接口类型</li><li>reflect.Value.Elem()：获取指向变量的指针的reflect.Value</li><li>reflect.Value.SetInt()&#x2F;setFlout()&#x2F;setString()：设置值</li><li>reflect.New()：返回一个指向类型的新实例的</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 示例</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">TestReflect</span><span class="hljs-params">(a *testing.T)</span></span> &#123;<br>i := <span class="hljs-number">10</span><br><br>t := reflect.TypeOf(i)<br>fmt.Println(t) <span class="hljs-comment">// int</span><br><br>v := reflect.ValueOf(i)<br>fmt.Println(v) <span class="hljs-comment">// 10</span><br><br>value := reflect.ValueOf(&amp;i)<br>fmt.Println(value.Type())             <span class="hljs-comment">// *int</span><br>fmt.Println(value.Interface().(*<span class="hljs-type">int</span>)) <span class="hljs-comment">// i的地址</span><br>fmt.Println(value.Elem())             <span class="hljs-comment">// 10</span><br>value.Elem().SetInt(<span class="hljs-number">20</span>)<br>fmt.Println(i) <span class="hljs-comment">// 20</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ProtocolBuffers</title>
    <link href="/2023/11/16/go/ProtocolBuffers/"/>
    <url>/2023/11/16/go/ProtocolBuffers/</url>
    
    <content type="html"><![CDATA[<h2 id="ProtocolBuffers"><a href="#ProtocolBuffers" class="headerlink" title="ProtocolBuffers"></a>ProtocolBuffers</h2><p><a href="https://blog.csdn.net/m0_45971439/article/details/129351032">windows下go安装并使用protobuf</a></p><p>结构化数据存储格式，性能和效率优于Json和Xml，是以二进制方式存储，占用空间小</p><p>Protobuf 在 <code>.proto</code> 定义需要处理的结构化数据，可以通过 <code>protoc</code> 工具，将 <code>.proto</code> 文件转换为 C、C++、Golang、Java、Python 等多种语言的代码，兼容性好，易于使用</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><strong>protoc</strong>：</p><p> <a href="https://github.com/protocolbuffers/protobuf/releases">protoc下载地址</a>, windows下载-win64结尾的那个</p><p>下载完后将<code>protoc.exe</code>放到<code>%GOPATH%/bin</code>目录下</p><p><strong>protoc-gen-go</strong>：</p><p>protoc本身不能将proto编译成go语言，需要安装插件</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">go install google.golang.org/protobuf/<span class="hljs-built_in">cmd</span>/protoc-gen-go@latest<br></code></pre></td></tr></table></figure><p>下载完后可以在<code>%GOPATH%/bin</code>找到</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmd"># 检查是否安装成功<br>protoc --version<br>protoc-gen-go --version<br></code></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li>创建<code>test.proto</code>文件，<code>.proto</code>文件：用于定义需要传输的message格式</li></ol><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs protobuf">syntax = <span class="hljs-string">&quot;proto3&quot;</span>; <span class="hljs-comment">//版本号</span><br><span class="hljs-keyword">package</span> protobuf;  <span class="hljs-comment">//包名</span><br><span class="hljs-keyword">option</span> go_package = <span class="hljs-string">&quot;./protobuf&quot;</span>;<span class="hljs-comment">// 生成在当前文件下的目录</span><br><br><span class="hljs-keyword">enum </span><span class="hljs-title class_">ClassName</span>&#123;<span class="hljs-comment">//枚举</span><br>  class1 = <span class="hljs-number">0</span>;  <span class="hljs-comment">//标号 必须从 0开始</span><br>  class2 = <span class="hljs-number">1</span>;<br>  class3 = <span class="hljs-number">2</span>;<br>&#125;<br><br><span class="hljs-keyword">message </span><span class="hljs-title class_">Student</span>&#123;<span class="hljs-comment">//消息，对应于Go的结构体</span><br>  <span class="hljs-type">string</span> name = <span class="hljs-number">1</span>; <span class="hljs-comment">//1:标号，唯一 即可（相当于数据库中的Id，不一定要从1 ，2的顺序依次排列。）</span><br>  <span class="hljs-type">int32</span> age = <span class="hljs-number">2</span>;  <span class="hljs-comment">//必须指定整型的范围，如int32，int64</span><br>  <span class="hljs-type">string</span> address = <span class="hljs-number">3</span>;<br>  ClassName cn = <span class="hljs-number">4</span>;<br>&#125;<br><span class="hljs-keyword">message </span><span class="hljs-title class_">Students</span>&#123;<br>  <span class="hljs-keyword">repeated</span> Student person = <span class="hljs-number">1</span>;  <span class="hljs-comment">// repeated 修饰，相当于Go中切片</span><br>  <span class="hljs-type">string</span> school = <span class="hljs-number">2</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><ol start="2"><li><p>命令<code>protoc --go_out=. test.proto</code>生成对应go文件，会看到生成&#x2F;protobuf&#x2F;student.pb.go文件</p></li><li><p>测试</p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    student := &amp;protobuf.Student&#123;<br>        Name:    <span class="hljs-string">&quot;Huzhen&quot;</span>,<br>        Age:     <span class="hljs-number">27</span>,<br>        Address: <span class="hljs-string">&quot;aaa&quot;</span>,<br>        Cn:      protobuf.ClassName_class1,<br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;student: &quot;</span>, student)<br>    <span class="hljs-comment">// 编码: 将person对象进行序列化，得到二进制文件</span><br>    data, err := proto.Marshal(student)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;encode err: &quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;data: &quot;</span>, data)<br><br>    <span class="hljs-comment">// 解码(反序列化)</span><br>    person2 := &amp;protobuf.Student&#123;&#125;<br>    err = proto.Unmarshal(data, person2)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;decode err: &quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    fmt.Println(<span class="hljs-string">&quot;person2: &quot;</span>, person2)<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go操作redis</title>
    <link href="/2023/11/06/go/go%E6%93%8D%E4%BD%9Credis/"/>
    <url>/2023/11/06/go/go%E6%93%8D%E4%BD%9Credis/</url>
    
    <content type="html"><![CDATA[<h2 id="go操作redis"><a href="#go操作redis" class="headerlink" title="go操作redis"></a>go操作redis</h2><p><a href="https://www.mszlu.com/go/go-redis/01/01.html#_1-%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B">参考</a></p><h2 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">go get github.com/go-redis/redis/v8<br></code></pre></td></tr></table></figure><h2 id="创建客户端"><a href="#创建客户端" class="headerlink" title="创建客户端"></a>创建客户端</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;context&quot;</span><br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;github.com/go-redis/redis/v8&quot;</span><br>)<br><br><span class="hljs-keyword">var</span> (<br>    rdb *redis.Client          <span class="hljs-comment">// redis客户端</span><br>    ctx = context.Background() <span class="hljs-comment">// 上下文</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 创建redis客户端</span><br>    rdb = redis.NewClient(&amp;redis.Options&#123;<br>        Addr:     <span class="hljs-string">&quot;localhost:6379&quot;</span>,<br>        Password: <span class="hljs-string">&quot;&quot;</span>,<br>        DB:       <span class="hljs-number">0</span>,<br>    &#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    result, err := rdb.Ping(ctx).Result()<br>    checkErr(err)<br>    fmt.Println(result)<span class="hljs-comment">// PONG</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkErr</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><h3 id="获取所有keykeys"><a href="#获取所有keykeys" class="headerlink" title="获取所有keykeys()"></a>获取所有key<code>keys()</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    keys, err := rdb.Keys(ctx, <span class="hljs-string">&quot;*&quot;</span>).Result()<br>    checkErr(err)<br>    fmt.Println(keys)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="获取key对应值的类型Type"><a href="#获取key对应值的类型Type" class="headerlink" title="获取key对应值的类型Type()"></a>获取key对应值的类型<code>Type()</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    res, err := rdb.Type(ctx, <span class="hljs-string">&quot;aaa&quot;</span>).Result()<br>    checkErr(err)<br>    fmt.Println(res)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="超时时间"><a href="#超时时间" class="headerlink" title="超时时间"></a>超时时间</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 设置超时时间</span><br>    res, err := rdb.Expire(ctx, <span class="hljs-string">&quot;aaa&quot;</span>,  time.Hour).Result()<br>    checkErr(err)<br>    fmt.Println(res)<br><br>    <span class="hljs-comment">// 获取超时时间</span><br>    res, err := rdb.TTL(ctx, <span class="hljs-string">&quot;aaa&quot;</span>).Result()<br>    checkErr(err)<br>    fmt.Println(res)<span class="hljs-comment">// 57m18s</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="设置值"><a href="#设置值" class="headerlink" title="设置值"></a>设置值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// string</span><br>    res, err := rdb.Set(ctx, <span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;bbb&quot;</span>, time.Hour).Result()<br>    checkErr(err)<br>    fmt.Println(res)<span class="hljs-comment">// OK</span><br>    <br>    <span class="hljs-comment">// 不存在才设置值</span><br>    res, err := rdb.SetNX(ctx, <span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;ccc&quot;</span>, time.Hour).Result()<br>checkErr(err)<br>fmt.Println(res) <span class="hljs-comment">// false</span><br>    <br>    <span class="hljs-comment">// 递增递减</span><br>    rdb.SetNX(ctx, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-number">1</span>, time.Hour)<br>    val, err := rdb.Incr(ctx, <span class="hljs-string">&quot;key&quot;</span>).Result()<br>    val, err := rdb.Decr(ctx, <span class="hljs-string">&quot;key&quot;</span>).Result()<br>    <br>    <span class="hljs-comment">// hash基本上在前面加个H</span><br>    <span class="hljs-comment">// listLPush/RPop...</span><br>    <span class="hljs-comment">// setSAdd/SRem/SisMember...</span><br>    <span class="hljs-comment">// sorted setZAdd/ZRem/ZScore/ZRank...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="获取值"><a href="#获取值" class="headerlink" title="获取值"></a>获取值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// string</span><br>    res, err := rdb.Get(ctx, <span class="hljs-string">&quot;aaa&quot;</span>).Result()<br>    checkErr(err)<br>    fmt.Println(res) <span class="hljs-comment">// bbb</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="删除值"><a href="#删除值" class="headerlink" title="删除值"></a>删除值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 一个或多个</span><br>    res, err := rdb.Del(ctx, <span class="hljs-string">&quot;aaa&quot;</span>).Result()<br>    checkErr(err)<br>    fmt.Println(res) <span class="hljs-comment">// 1</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Redis作为消息队列"><a href="#Redis作为消息队列" class="headerlink" title="Redis作为消息队列"></a>Redis作为消息队列</h2><h3 id="发送消息到队列"><a href="#发送消息到队列" class="headerlink" title="发送消息到队列"></a>发送消息到队列</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    rdb.Publish(ctx, <span class="hljs-string">&quot;channel1&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="订阅主题来接收消息"><a href="#订阅主题来接收消息" class="headerlink" title="订阅主题来接收消息"></a>订阅主题来接收消息</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// PSubscribe 支持模式匹配的订阅主题</span><br>    sub := rdb.Subscribe(ctx, <span class="hljs-string">&quot;channel1&quot;</span>)<br><br>    <span class="hljs-keyword">for</span> msg := <span class="hljs-keyword">range</span> sub.Channel() &#123;<br>        <span class="hljs-comment">// 打印收到的消息</span><br>        fmt.Println(msg.Channel, msg.Payload)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><h3 id="通过pipeline实现"><a href="#通过pipeline实现" class="headerlink" title="通过pipeline实现"></a>通过pipeline实现</h3><blockquote><p>pipeline是Redis提供的一种批量执行命令的机制。它可以将多个命令一次性发送给Redis服务器执行，减少了网络通信的开销，提高了性能。</p><p>使用Pipeline可以在客户端批量发送多个命令，而不需要等待每个命令的响应。这样可以减少网络延迟和服务器响应时间，特别适用于需要执行大量命令的场景。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 开启一个TxPipeline事务</span><br>    pipe := rdb.TxPipeline()<br><br>    <span class="hljs-comment">// 执行事务操作，可以通过pipe读写redis</span><br>    incr := pipe.Incr(ctx,<span class="hljs-string">&quot;tx_pipeline_counter&quot;</span>)<br>    pipe.Expire(ctx,<span class="hljs-string">&quot;tx_pipeline_counter&quot;</span>, time.Hour)<br><br>    <span class="hljs-comment">// 上面代码等同于执行下面redis命令</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">//     MULTI</span><br>    <span class="hljs-comment">//     INCR pipeline_counter</span><br>    <span class="hljs-comment">//     EXPIRE pipeline_counts 3600</span><br>    <span class="hljs-comment">//     EXEC</span><br><br>    <span class="hljs-comment">// 通过Exec函数提交redis事务</span><br>    _, err := pipe.Exec(ctx)<br><br>    <span class="hljs-comment">// 提交事务后，我们可以查询事务操作的结果</span><br>    <span class="hljs-comment">// 前面执行Incr函数，在没有执行exec函数之前，实际上还没开始运行。</span><br>    fmt.Println(incr.Val(), err)<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go操作数据库</title>
    <link href="/2023/11/01/go/go%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    <url>/2023/11/01/go/go%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    
    <content type="html"><![CDATA[<h2 id="go操作数据库"><a href="#go操作数据库" class="headerlink" title="go操作数据库"></a>go操作数据库</h2><blockquote><p>Go官方没有提供数据库驱动，而是为开发数据库驱动定义了一些标准接口<code>database/sql</code>，开发者可以根据定义的接口来开发相应的数据库驱动</p></blockquote><table><thead><tr><th>接口</th><th>说明</th></tr></thead><tbody><tr><td>sql.Register(name string, driver driver.Driver)</td><td>注册驱动，通过map来保存多个驱动</td></tr><tr><td>Driver.Open(name string) (Conn, error)</td><td>返回一个数据库的连接，只能在一个goroutine中使用</td></tr><tr><td>Conn.Prepare(query string) (Stmt, error)</td><td>返回与当前连接相关的执行Sql语句的准备状态，用于增删改查</td></tr><tr><td>Conn.Close() error</td><td>关闭连接</td></tr><tr><td>Conn.Begin() (Tx, error)</td><td>返回事务，用于提交、回滚事务</td></tr><tr><td>Stmt.Exec(args []Value) (Result, error)</td><td>执行增删改语句</td></tr><tr><td>Stmt.Query(args []Value) (Rows, error)</td><td>执行查询语句</td></tr></tbody></table><p>。。。</p><h2 id="sqlx"><a href="#sqlx" class="headerlink" title="sqlx"></a>sqlx</h2><h3 id="操作Mysql"><a href="#操作Mysql" class="headerlink" title="操作Mysql"></a>操作Mysql</h3><ol><li><p>导包</p> <figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cmd">// mysql驱动<br>go get github.com/go-sql-driver/mysql <br><br>// go操作数据库<br>go get github.com/jmoiron/sqlx<br></code></pre></td></tr></table></figure></li><li><p>注册驱动</p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    _ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br>    <span class="hljs-string">&quot;github.com/jmoiron/sqlx&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 用户名:密码@tcp(ip:port)/数据库名</span><br>    database, err := sqlx.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;root:123456@tcp(127.0.0.1:3306)/test&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;open mysql failed,&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    fmt.Println(database)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>插入操作<code>db.Exec</code></p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br>_ <span class="hljs-string">&quot;github.com/go-sql-driver/mysql&quot;</span><br><span class="hljs-string">&quot;github.com/jmoiron/sqlx&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>UserId   <span class="hljs-type">int</span>    <span class="hljs-string">`db:&quot;user_id&quot;`</span><br>Username <span class="hljs-type">string</span> <span class="hljs-string">`db:&quot;username&quot;`</span><br>Sex      <span class="hljs-type">string</span> <span class="hljs-string">`db:&quot;sex&quot;`</span><br>Email    <span class="hljs-type">string</span> <span class="hljs-string">`db:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-keyword">var</span> db *sqlx.DB<br><br><span class="hljs-comment">// 注册驱动，创建操作对象</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>database, err := sqlx.Open(<span class="hljs-string">&quot;mysql&quot;</span>, <span class="hljs-string">&quot;root:123456@tcp(127.0.0.1:3306)/test&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;open mysql failed,&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>db = database<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// sql语句</span><br>sql := <span class="hljs-string">&quot;INSERT INTO test_go_user(`username`, `sex`, `email`) VALUES (?, ?, ?)&quot;</span><br>value := [<span class="hljs-number">3</span>]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;user01&quot;</span>, <span class="hljs-string">&quot;man&quot;</span>, <span class="hljs-string">&quot;user01@qq.com&quot;</span>&#125;<br><br><span class="hljs-comment">// 执行sql</span><br>res, err := db.Exec(sql, value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>], value[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;exec failed, &quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// 查看最后一个初入的id</span><br>id, err := res.LastInsertId()<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;exec failed&quot;</span>, err)<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Println(<span class="hljs-string">&quot;insert success&quot;</span>, id)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>查询操作<code>db.Select</code></p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    sql := <span class="hljs-string">&quot;SELECT * FROM test_go_user&quot;</span><br><br>    <span class="hljs-keyword">var</span> users []User<br><br>    err := db.Select(&amp;users, sql)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;select failed, &quot;</span>, err)<br>    &#125;<br>    fmt.Println(users)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改操作<code>db.Exec</code></p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    sql := <span class="hljs-string">&quot;UPDATE test_go_user SET username=? WHERE user_id = ?&quot;</span><br>    value := []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;user02&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>&#125;<br><br>    res, err := db.Exec(sql, value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;exec failed, &quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    row, err := res.RowsAffected()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;exec failed, &quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br>    fmt.Println(<span class="hljs-string">&quot;影响的行数：&quot;</span>, row)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>删除操作</p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>    sql := <span class="hljs-string">&quot;delete from test_go_user where user_id=?&quot;</span><br><br>    res, err := db.Exec(sql, <span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;exce failed,&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    row, err := res.RowsAffected()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;row failed, &quot;</span>, err)<br>    &#125;<br>    fmt.Println(<span class="hljs-string">&quot;delete succ: &quot;</span>, row)<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="操作Mysql事务Begin-Rollback-Commit"><a href="#操作Mysql事务Begin-Rollback-Commit" class="headerlink" title="操作Mysql事务Begin()/Rollback()/Commit()"></a>操作Mysql事务<code>Begin()/Rollback()/Commit()</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">//开启事务</span><br>    conn, err := db.Begin()<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;begin failed :&quot;</span>, err)<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">//执行插入语句</span><br>    err = insert(<span class="hljs-string">&quot;user01&quot;</span>, <span class="hljs-string">&quot;man&quot;</span>, <span class="hljs-string">&quot;usre01@163.com&quot;</span>, conn)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;exec failed, &quot;</span>, err)<br>        conn.Rollback() <span class="hljs-comment">//出现异常，进行回滚操作</span><br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">//执行插入语句</span><br>    err = insert(<span class="hljs-string">&quot;user02&quot;</span>, <span class="hljs-string">&quot;man&quot;</span>, <span class="hljs-string">&quot;user02@163.com&quot;</span>, conn)<br>    err = errors.New(<span class="hljs-string">&quot;测试回滚&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(<span class="hljs-string">&quot;exec failed, &quot;</span>, err)<br>        conn.Rollback()<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>    <span class="hljs-comment">// 提交事务</span><br>    conn.Commit()<br>    fmt.Println(<span class="hljs-string">&quot;insert success&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="gorm"><a href="#gorm" class="headerlink" title="gorm"></a>gorm</h2><p><a href="https://www.mszlu.com/go/gorm/01/01.html">参考</a></p><blockquote><p>Go Object Relational Mapping</p></blockquote><h3 id="导包"><a href="#导包" class="headerlink" title="导包"></a>导包</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cmd">// 安装MySQL驱动<br>go get -u gorm.io/driver/mysql<br>// 安装gorm包<br>go get -u gorm.io/gorm<br></code></pre></td></tr></table></figure><h3 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> DB *gorm.DB<br><br><span class="hljs-comment">// 连接数据库</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>    username := <span class="hljs-string">&quot;root&quot;</span><br>    password := <span class="hljs-string">&quot;123456&quot;</span><br>    host := <span class="hljs-string">&quot;127.0.0.1&quot;</span><br>    port := <span class="hljs-number">3306</span><br>    dbName := <span class="hljs-string">&quot;test&quot;</span><br><br>    <span class="hljs-comment">// data source name</span><br>    <span class="hljs-comment">// root:123456@tcp(127.0.0.1:3306)/test?charset=utf8&amp;parseTime=True&amp;loc=Local</span><br>    dsn := fmt.Sprintf(<span class="hljs-string">&quot;%s:%s@tcp(%s:%d)/%s?charset=utf8&amp;parseTime=True&amp;loc=Local&quot;</span>, username, password, host, port, dbName)<br>    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config&#123;<br>        Logger: logger.Default.LogMode(logger.Info),<br>    &#125;)<br>    checkErr(err)<br>    DB = db<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h3><p><strong>实体类</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 默认字段映射为数据库：create_time -&gt; 实体类：createTime</span><br><span class="hljs-comment">// 如果有CreatedAt和UpdateAt会自动填充</span><br><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>    ID         <span class="hljs-type">int64</span><br>    Username   <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:username&quot;`</span><br>    Password   <span class="hljs-type">string</span> <span class="hljs-string">`gorm:&quot;column:password&quot;`</span><br>    CreateTime <span class="hljs-type">int64</span>  <span class="hljs-string">`gorm:&quot;column:createtime&quot;`</span><br>&#125;<br><br><span class="hljs-comment">// TableName 返回表名</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span></span> TableName() <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;test_go_user&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 新增一条数据</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">saveUser</span><span class="hljs-params">()</span></span> &#123;<br>    user := &amp;User&#123;<br>        Username:   <span class="hljs-string">&quot;zhangsan&quot;</span>,<br>        Password:   <span class="hljs-string">&quot;123456&quot;</span>,<br>        CreateTime: time.Now().UnixMilli(),<br>    &#125;<br>    res := DB.Create(user)<br>    checkErr(res.Error)<br>&#125;<br><br><span class="hljs-comment">// 查一条</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getById</span><span class="hljs-params">()</span></span> &#123;<br>    id := <span class="hljs-number">1</span><br>    user := User&#123;&#125;<br>    <span class="hljs-comment">// First默认主键排序后取一条，Take不考虑排序</span><br>    res := DB.Where(<span class="hljs-string">&quot;id=?&quot;</span>, id).First(&amp;user)<br>    checkErr(res.Error)<br>    fmt.Println(user)<br>&#125;<br><br><span class="hljs-comment">// 查所有</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getAll</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> users []User<br>    res := DB.Find(&amp;users)<br>    checkErr(res.Error)<br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(users); i++ &#123;<br>        fmt.Println(users[i])<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 改</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">updateById</span><span class="hljs-params">()</span></span> &#123;<br>    id := <span class="hljs-number">1</span><br>    res := DB.Model(&amp;User&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, id).Update(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;lisi&quot;</span>)<br>    checkErr(res.Error)<br>&#125;<br><br><span class="hljs-comment">// 删</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">deleteById</span><span class="hljs-params">()</span></span> &#123;<br>    id := <span class="hljs-number">2</span><br>    res := DB.Where(<span class="hljs-string">&quot;id=?&quot;</span>, id).Delete(&amp;User&#123;&#125;)<br>    checkErr(res.Error)<br>&#125;<br><br><span class="hljs-comment">// 原生sql执行增删改</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sql</span><span class="hljs-params">()</span></span> &#123;<br>    db.Exec(<span class="hljs-string">&quot;insert into users (username,password,createtime) values (?,?,?)&quot;</span>, user.Username, user.Password, user.CreateTime)<br>&#125;<br><br><span class="hljs-comment">// 原生sql执行查</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sql2</span><span class="hljs-params">()</span></span> &#123;<br>    sql := <span class="hljs-string">&quot;SELECT type, count(*) as  total FROM `goods` where create_time &gt; ? GROUP BY type HAVING (total &gt; 0)&quot;</span><br>    db.Raw(sql, <span class="hljs-string">&quot;2022-11-06 00:00:00&quot;</span>).Scan(&amp;results)<br>    fmt.Println(results)<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p><strong>自动事务</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">autoTransaction</span><span class="hljs-params">()</span></span> &#123;<br>    id := <span class="hljs-number">1</span><br>    err := DB.Transaction(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(tx *gorm.DB)</span></span> <span class="hljs-type">error</span> &#123;<br>        res := tx.Model(&amp;User&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, id).Update(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>        <span class="hljs-comment">// 返回error就会回滚</span><br>        <span class="hljs-keyword">if</span> res.Error != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> res.Error<br>        &#125;<br><br>        res = tx.Model(&amp;User&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, id).Update(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>        res.Error = errors.New(<span class="hljs-string">&quot;测试回滚&quot;</span>)<br>        <span class="hljs-keyword">if</span> res.Error != <span class="hljs-literal">nil</span> &#123;<br>            <span class="hljs-keyword">return</span> res.Error<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>    &#125;)<br>    checkErr(err)<br>&#125;<br></code></pre></td></tr></table></figure><p>手动提交事务</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">transaction</span><span class="hljs-params">()</span></span> &#123;<br>    tx := DB.Begin()<br><br>    id := <span class="hljs-number">1</span><br>    res := tx.Model(&amp;User&#123;&#125;).Where(<span class="hljs-string">&quot;id = ?&quot;</span>, id).Update(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br><br>    res.Error = errors.New(<span class="hljs-string">&quot;测试回滚&quot;</span>)<br>    <span class="hljs-keyword">if</span> res.Error != <span class="hljs-literal">nil</span> &#123;<br>        fmt.Println(res.Error)<br>        <span class="hljs-comment">// 回滚</span><br>        tx.Rollback()<br>    &#125;<br>    <span class="hljs-comment">// 提交</span><br>    tx.Commit()<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>通过保存点来回滚部分事务</p><p>SavePoint(“保存点名”); RollBackTo(“保存点名”)</p></blockquote><h3 id="回调"><a href="#回调" class="headerlink" title="回调"></a>回调</h3><p>在回调中如果返回error则会回滚事务，可以用来做入参、出参检查等操作</p><p>结构体实现对应的回调，</p><p>增：BeforeCreate、AfterCreate</p><p>删：BeforeDelete、AfterDelete</p><p>改：BeforeUpdate、AfterUpdate</p><p>查：AfterFind</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 在新插入数据前会调用</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span></span> BeforeCreate(tx *gorm.DB) <span class="hljs-type">error</span> &#123;<br>    <span class="hljs-comment">// 判断是否有相同username的回调</span><br>    username := u.Username<br><br>    <span class="hljs-keyword">var</span> count <span class="hljs-type">int64</span><br>    DB.Model(&amp;User&#123;&#125;).Where(<span class="hljs-string">&quot;username = ?&quot;</span>, username).Count(&amp;count)<br>    <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">0</span> &#123;<br>        <span class="hljs-keyword">return</span> errors.New(<span class="hljs-string">&quot;存在相同username：&quot;</span> + username + <span class="hljs-string">&quot;，回滚&quot;</span>)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br><br><span class="hljs-comment">// 在新插入数据后会调用</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(u *User)</span></span> AfterCreate(tx *gorm.DB) <span class="hljs-type">error</span> &#123;<br>fmt.Println(<span class="hljs-string">&quot;插入数据成功, id: &quot;</span>, u.ID)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Gin</title>
    <link href="/2023/10/22/go/Gin/"/>
    <url>/2023/10/22/go/Gin/</url>
    
    <content type="html"><![CDATA[<h2 id="Gin"><a href="#Gin" class="headerlink" title="Gin"></a>Gin</h2><blockquote><p>Web框架，封装比较优雅，API友好。具有快速灵活，容错方便等特点</p></blockquote><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">go get -u github.com/gin-gonic/gin<br></code></pre></td></tr></table></figure><p><strong>hello world</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><span class="hljs-comment">// 创建路由</span><br>ginServer := gin.Default()<br><br><span class="hljs-comment">// 访问地址</span><br>    <span class="hljs-comment">// gin.Context，封装了request和response</span><br>ginServer.GET(<span class="hljs-string">&quot;/hello&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>context.JSON(<span class="hljs-number">200</span>, gin.H&#123;<span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;hello&quot;</span>&#125;)<br>&#125;)<br><br><span class="hljs-comment">// 启动服务</span><br>err := ginServer.Run(<span class="hljs-string">&quot;:8082&quot;</span>)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br><span class="hljs-keyword">return</span><br>&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="响应页面"><a href="#响应页面" class="headerlink" title="响应页面"></a>响应页面</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 创建路由</span><br>    ginServer := gin.Default()<br><br>    <span class="hljs-comment">// 在项目目录下创建文件夹templates及页面index.html</span><br>    <span class="hljs-comment">// 加载静态页面</span><br>    ginServer.LoadHTMLGlob(<span class="hljs-string">&quot;templates/*&quot;</span>)<br><br>    <span class="hljs-comment">// 访问地址</span><br>    ginServer.GET(<span class="hljs-string">&quot;/index&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(context *gin.Context)</span></span> &#123;<br>        context.HTML(http.StatusOK, <span class="hljs-string">&quot;index.html&quot;</span>, gin.H&#123;<span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;你好&quot;</span>&#125;)<br>    &#125;)<br><br>    <span class="hljs-comment">// 启动服务</span><br>    err := ginServer.Run(<span class="hljs-string">&quot;:8082&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        <span class="hljs-keyword">return</span><br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="获取请求参数"><a href="#获取请求参数" class="headerlink" title="获取请求参数"></a>获取请求参数</h3><p>路径参数<code>c.Param()</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">r.GET(<span class="hljs-string">&quot;/user/:name/*action&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>    name := c.Param(<span class="hljs-string">&quot;name&quot;</span>)<br>    action := c.Param(<span class="hljs-string">&quot;action&quot;</span>)<br>    <span class="hljs-comment">//截取/</span><br>    action = strings.Trim(action, <span class="hljs-string">&quot;/&quot;</span>)<br>    c.String(http.StatusOK, name+<span class="hljs-string">&quot; is &quot;</span>+action)<br>&#125;)<br></code></pre></td></tr></table></figure><p>URL参数<code>c.Query()/DefaultQuery()</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">r.GET(<span class="hljs-string">&quot;/user&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>    <span class="hljs-comment">//DefaultQuery指定默认值</span><br>    <span class="hljs-comment">//http://localhost:8080/user 才会打印出来默认的值</span><br>    name := c.DefaultQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;枯藤&quot;</span>)<br>    c.String(http.StatusOK, fmt.Sprintf(<span class="hljs-string">&quot;hello %s&quot;</span>, name))<br>&#125;)<br></code></pre></td></tr></table></figure><p>表单参数<code>c.PostForm()/DefaultPostForm()</code></p><p>表单格式常见有：</p><ul><li>application&#x2F;json json格式</li><li>application&#x2F;x-www-form-urlencoded             表单</li><li>application&#x2F;xml                     xml</li><li>multipart&#x2F;form-data               文件</li></ul><p>文件<code>c.FormFile()</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//限制上传最大尺寸</span><br>r.MaxMultipartMemory = <span class="hljs-number">8</span> &lt;&lt; <span class="hljs-number">20</span><br>r.POST(<span class="hljs-string">&quot;/upload&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> &#123;<br>    file, err := c.FormFile(<span class="hljs-string">&quot;file&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        c.String(<span class="hljs-number">500</span>, <span class="hljs-string">&quot;上传图片出错&quot;</span>)<br>    &#125;<br>    <span class="hljs-comment">// c.JSON(200, gin.H&#123;&quot;message&quot;: file.Header.Context&#125;)</span><br>    c.SaveUploadedFile(file, file.Filename)<br>    c.String(http.StatusOK, file.Filename)<br>&#125;)<br></code></pre></td></tr></table></figure><p>提取请求路径的公共头部分</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go">v1 := r.Group(<span class="hljs-string">&quot;/v1&quot;</span>)<br><span class="hljs-comment">// &#123;&#125; 是书写规范</span><br>&#123;<br>    v1.GET(<span class="hljs-string">&quot;/login&quot;</span>, login)<br>    v1.GET(<span class="hljs-string">&quot;submit&quot;</span>, submit)<br>&#125;<br><br><span class="hljs-comment">// 请求路径/v1/login</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计网</title>
    <link href="/2023/10/09/%E5%85%B6%E4%BB%96/%E8%AE%A1%E7%BD%91/"/>
    <url>/2023/10/09/%E5%85%B6%E4%BB%96/%E8%AE%A1%E7%BD%91/</url>
    
    <content type="html"><![CDATA[<h1 id="计网"><a href="#计网" class="headerlink" title="计网"></a>计网</h1><h2 id="三次握手四次挥手"><a href="#三次握手四次挥手" class="headerlink" title="三次握手四次挥手"></a>三次握手四次挥手</h2><p>建立TCP连接时三次挥手：</p><ol><li>客户端                     SYN—&gt;                        服务器</li><li>客户端                     &lt;—SYN-ACK                服务器</li><li>客户端                     ACK—&gt;                        服务器</li></ol><p>终止TCP连接时四次挥手：</p><ol><li>客户端                     FIN—&gt;                        服务器</li><li>客户端                     &lt;—ACK                       服务器</li><li>客户端                     &lt;—FIN                        服务器</li><li>客户端                     ACK—&gt;                       服务器</li></ol><ul><li>SYN(Synchronize)：请求报文</li><li>SYN-ACK(Synchronize-Acknowledge)：确认报文</li><li>FIN(Finish)：释放请求报文</li></ul><p><strong>为什么三次挥手？</strong></p><p>三次挥手可以让客户端和服务器确认自己返送和接收都正常</p><p>如果有滞留的SYN请求到服务器，服务器第二次握手时不会收到客户端的确认报文，也就不会出现服务器空等客户端的情况</p><p><strong>为什么四次挥手？</strong></p><p>第一次挥手表示客户端不再发送消息</p><p>第二次挥手表示服务器同意客户端关闭连接，服务器还能把没发完的数据继续发给客户端</p><p>第三次挥手表示服务器发送完数据要关闭连接了</p><p>第四次挥手表示客户端确认关闭</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java代理</title>
    <link href="/2023/10/08/java/java%E4%BB%A3%E7%90%86/"/>
    <url>/2023/10/08/java/java%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="java代理"><a href="#java代理" class="headerlink" title="java代理"></a>java代理</h2><h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><p>给某一个对象提供一个代理，并由代理对象控制真实对象的访问</p><p>代理模式中的角色：</p><ul><li>Subject：接口，定义了被代理的方法</li><li>RealSubject：被代理对象</li><li>Proxy：代理对象</li></ul><h3 id="静态代理和动态代理"><a href="#静态代理和动态代理" class="headerlink" title="静态代理和动态代理"></a>静态代理和动态代理</h3><h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><ul><li>静态代理在代码运行前已经生成代理类的字节码文件，即运行前已经确认代理和被代理对象间的关系；</li><li>动态代理在代码运行后通过反射动态生成代理类的字节码文件</li></ul><h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><p>代理对象将被代理对象作为成员对象来进行代理</p><p>优点：</p><ul><li>代码不侵入代理对象</li><li>简单</li></ul><p>缺点：</p><ul><li>如果一个代理类代理多个目标，代理类的代码会变得非常复杂</li><li>如果一个代理类代理一个目标，会创建过多代理类</li><li>修改被代理类的方法时要同时修改代理类</li></ul><h4 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><p>动态代理就是根据接口或目标对象，计算出代理类的字节码，然后再加载到JVM中使用</p><p>常见动态代理实现方式：</p><ul><li>JDK动态代理</li><li>CGLIB动态代理</li></ul><p><strong>JDK动态代理</strong></p><p>根据接口创建代理类</p><p>用<code>java.lang.reflect.InvocationHandler</code>定义代理类要执行的操作</p><p>用<code>java.lang.reflect.Proxy</code>创建代理对象</p><p>代理对象通过反射获取方法，然后交给<code>InvocationHandler</code>来执行具体的代理逻辑</p><p><strong>CGLIB动态代理</strong></p><p>通过继承创建代理类</p><p>缺点：</p><ul><li>需要额外引入CGLIB包</li><li>只能代理非final的public方法</li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>go多线程</title>
    <link href="/2023/09/24/go/go%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    <url>/2023/09/24/go/go%E5%A4%9A%E7%BA%BF%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="go多线程"><a href="#go多线程" class="headerlink" title="go多线程"></a>go多线程</h2><p>go语言中不是通过共享内存通信，而是<strong>通过通信共享内存</strong></p><h3 id="协程goroutine"><a href="#协程goroutine" class="headerlink" title="协程goroutine"></a>协程goroutine</h3><p>goroutine，即轻量级线程，创建Goroutine的成本很小，它就是一段代码，一个函数入口。以及在堆上为其分配的一个堆栈（初始大小为4K，会随着程序的执行自动增长删除）。因此它非常廉价，Go应用程序可以并发运行数千个Goroutines。</p><p>案例</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-comment">// 通过协程同时执行多个方法</span><br>start := time.Now()<br><br>apis := []<span class="hljs-type">string</span>&#123;<br><span class="hljs-string">&quot;https://management.azure.com&quot;</span>,<br><span class="hljs-string">&quot;https://dev.azure.com&quot;</span>,<br><span class="hljs-string">&quot;https://api.github.com&quot;</span>,<br><span class="hljs-string">&quot;https://outlook.office.com/&quot;</span>,<br><span class="hljs-string">&quot;https://api.somewhereintheinternet.com/&quot;</span>,<br><span class="hljs-string">&quot;https://graph.microsoft.com&quot;</span>,<br>&#125;<br><span class="hljs-keyword">for</span> _, api := <span class="hljs-keyword">range</span> apis &#123;<br><span class="hljs-keyword">go</span> checkAPI(api) <span class="hljs-comment">// 每次请求都创建一个协程</span><br>&#125;<br>time.Sleep(<span class="hljs-number">3</span> * time.Second) <br><br>elapsed := time.Since(start)<br>fmt.Printf(<span class="hljs-string">&quot;Done! It took %v seconds!\n&quot;</span>, elapsed.Seconds())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkAPI</span><span class="hljs-params">(api <span class="hljs-type">string</span>)</span></span> &#123;<br>_, err := http.Get(api)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>fmt.Printf(<span class="hljs-string">&quot;ERROR: %s is down!\n&quot;</span>, api)<br><span class="hljs-keyword">return</span><br>&#125;<br>fmt.Printf(<span class="hljs-string">&quot;SUCCESS: %s is up and running!\n&quot;</span>, api)<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="协程通信channel"><a href="#协程通信channel" class="headerlink" title="协程通信channel"></a>协程通信channel</h3><p>使用管道</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 创建了可以传递int类型数据的管道</span><br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">int</span>)<br><br>ch &lt;- x<span class="hljs-comment">// 发送数据到管道</span><br>x = &lt;-ch<span class="hljs-comment">// 从管道接收数据</span><br>&lt;-ch<span class="hljs-comment">// 读取但不接收数据</span><br><br><span class="hljs-comment">// 关闭管道</span><br><span class="hljs-built_in">close</span>(ch)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">send</span><span class="hljs-params">(ch <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-type">string</span>)</span></span>&#123;&#125;<span class="hljs-comment">// 只写管道</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">read</span><span class="hljs-params">(ch &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span>&#123;&#125;<span class="hljs-comment">// 只读管道</span><br></code></pre></td></tr></table></figure><p>案例1：无缓冲channel</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;fmt&quot;</span><br><span class="hljs-string">&quot;net/http&quot;</span><br><span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>start := time.Now()<br><br>apis := []<span class="hljs-type">string</span>&#123;<br><span class="hljs-string">&quot;https://management.azure.com&quot;</span>,<br><span class="hljs-string">&quot;https://dev.azure.com&quot;</span>,<br><span class="hljs-string">&quot;https://api.github.com&quot;</span>,<br><span class="hljs-string">&quot;https://outlook.office.com/&quot;</span>,<br><span class="hljs-string">&quot;https://api.somewhereintheinternet.com/&quot;</span>,<br><span class="hljs-string">&quot;https://graph.microsoft.com&quot;</span>,<br>&#125;<br><br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)<span class="hljs-comment">// 创建管道</span><br><span class="hljs-keyword">for</span> _, api := <span class="hljs-keyword">range</span> apis &#123;<br><span class="hljs-keyword">go</span> checkAPI(api, ch) <span class="hljs-comment">// 每次请求都创建一个协程</span><br>&#125;<br><span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(apis); i++ &#123;<br>fmt.Print(&lt;-ch) <span class="hljs-comment">// 会阻塞等待</span><br>&#125;<br><br>elapsed := time.Since(start)<br>fmt.Printf(<span class="hljs-string">&quot;Done! It took %v seconds!\n&quot;</span>, elapsed.Seconds())<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">checkAPI</span><span class="hljs-params">(api <span class="hljs-type">string</span>, ch <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123;<br>_, err := http.Get(api)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>ch &lt;- fmt.Sprintf(<span class="hljs-string">&quot;ERROR: %s is down!\n&quot;</span>, api)<br><span class="hljs-keyword">return</span><br>&#125;<br>ch &lt;- fmt.Sprintf(<span class="hljs-string">&quot;SUCCESS: %s is up and running!\n&quot;</span>, api)<br>&#125;<br></code></pre></td></tr></table></figure><p>案例2：有缓冲channel</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 可以存10条数据的管道</span><br><span class="hljs-comment">// 往满了的管道里发送数据会阻塞</span><br>ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>, <span class="hljs-number">10</span>)<br></code></pre></td></tr></table></figure><p><strong>区别</strong></p><p>无缓冲的channel在发送数据时，发送者会被阻塞，直到有接收者接收数据。</p><p>有缓冲的channel则当缓冲区未满的时候会继续往下执行</p><h3 id="多路复用select"><a href="#多路复用select" class="headerlink" title="多路复用select"></a>多路复用select</h3><p>语法和switch类似，作用是当case后面的对管道的操作执行成功后，会执行对应的方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">process</span><span class="hljs-params">(ch <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123;<br>    time.Sleep(<span class="hljs-number">3</span> * time.Second)<br>    ch &lt;- <span class="hljs-string">&quot;Done processing!&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">replicate</span><span class="hljs-params">(ch <span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> &#123;<br>    time.Sleep(<span class="hljs-number">1</span> * time.Second)<br>    ch &lt;- <span class="hljs-string">&quot;Done replicating!&quot;</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    ch1 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)<br>    ch2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)<br>    <span class="hljs-keyword">go</span> process(ch1)<br>    <span class="hljs-keyword">go</span> replicate(ch2)<br><br>    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">2</span>; i++ &#123;<br>        <span class="hljs-keyword">select</span> &#123;<br>        <span class="hljs-keyword">case</span> process := &lt;-ch1:<br>            fmt.Println(process)<br>        <span class="hljs-keyword">case</span> replicate := &lt;-ch2:<br>            fmt.Println(replicate)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java文件IO</title>
    <link href="/2023/08/31/java/Java%E6%96%87%E4%BB%B6IO/"/>
    <url>/2023/08/31/java/Java%E6%96%87%E4%BB%B6IO/</url>
    
    <content type="html"><![CDATA[<h1 id="Java文件IO"><a href="#Java文件IO" class="headerlink" title="Java文件IO"></a>Java文件IO</h1><h2 id="按字符读写Reader、Writer"><a href="#按字符读写Reader、Writer" class="headerlink" title="按字符读写Reader、Writer"></a>按字符读写Reader、Writer</h2><p>FileWrite、FileReader</p><p><code>FileWriter writer = new FileWriter(file, true)</code>为追加写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">dir</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\aaa.txt&quot;</span>;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(dir);<br>    <span class="hljs-comment">//如果文件不存在，创建文件</span><br>    <span class="hljs-keyword">if</span> (!file.exists())<br>        file.createNewFile();<br>    <span class="hljs-comment">//创建FileWriter对象</span><br>    <span class="hljs-type">FileWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(file);<br>    <span class="hljs-comment">//向文件中写入内容</span><br>    writer.write(<span class="hljs-string">&quot;aaa&quot;</span>);<br>    writer.flush();<br>    writer.close();<br><br>    <span class="hljs-comment">//创建FileReader对象，读取文件中的内容</span><br>    <span class="hljs-type">FileReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(file);<br>    <span class="hljs-type">char</span>[] ch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">100</span>];<br>    reader.read(ch);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : ch) &#123;<br>        System.out.print(c);<br>    &#125;<br>    System.out.println();<br>    reader.close();<br>&#125;<br></code></pre></td></tr></table></figure><p>通过套一层BufferedWrite、BufferedReader，可以一行行来读</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">dir</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\aaa.txt&quot;</span>;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(dir);<br>    <span class="hljs-comment">//如果文件不存在，创建文件</span><br>    <span class="hljs-keyword">if</span> (!file.exists())<br>        file.createNewFile();<br>    <span class="hljs-comment">//创建BufferedWriter对象</span><br>    <span class="hljs-type">BufferedWriter</span> <span class="hljs-variable">bw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(file));<br>    <span class="hljs-comment">//向文件中写入内容</span><br>    bw.write(<span class="hljs-string">&quot;aaa&quot;</span>);<br>    bw.flush();<br>    bw.close();<br><br>    <span class="hljs-comment">//创建BufferedReader对象，读取文件中的内容</span><br>    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(file));<br>    String line;<br>    <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>        System.out.println(line);<br>    &#125;<br>    System.out.println();<br>    br.close();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="按字节读写InputStream、OutputStream"><a href="#按字节读写InputStream、OutputStream" class="headerlink" title="按字节读写InputStream、OutputStream"></a>按字节读写InputStream、OutputStream</h2><p>FileOutputStream、FileInputStream</p><p><code>FileOutputStream fos = new FileOutputStream(file, true)</code>为追加写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">dir</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;E:\\aaa.txt&quot;</span>;<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(dir);<br>    <span class="hljs-comment">//如果文件不存在，创建文件</span><br>    <span class="hljs-keyword">if</span> (!file.exists())<br>        file.createNewFile();<br>    <span class="hljs-comment">//创建FileOutputStream对象，写入内容</span><br>    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);<br>    <span class="hljs-comment">//向文件中写入内容</span><br>    fos.write(<span class="hljs-string">&quot;aaa&quot;</span>.getBytes());<br>    fos.close();<br><br>    <span class="hljs-comment">//创建FileInputStream对象，读取文件内容</span><br>    <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);<br>    <span class="hljs-type">byte</span>[] bys = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">100</span>];<br>    <span class="hljs-keyword">while</span> (fis.read(bys, <span class="hljs-number">0</span>, bys.length) != -<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">//将字节数组转换为字符串</span><br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bys));<br>    &#125;<br>    fis.close();<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>java集合框架</title>
    <link href="/2023/08/24/java/java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/"/>
    <url>/2023/08/24/java/java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="java集合框架"><a href="#java集合框架" class="headerlink" title="java集合框架"></a>java集合框架</h2><p><img src="/img/java_img/java%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6.png" alt="整体的继承关系"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>黑马头条笔记</title>
    <link href="/2023/08/07/%E5%85%B6%E4%BB%96/%E9%BB%91%E9%A9%AC%E5%A4%B4%E6%9D%A1%E7%AC%94%E8%AE%B0/"/>
    <url>/2023/08/07/%E5%85%B6%E4%BB%96/%E9%BB%91%E9%A9%AC%E5%A4%B4%E6%9D%A1%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="App端"><a href="#App端" class="headerlink" title="App端"></a>App端</h1><h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>用户可以选择登录和不登录</p><ul><li>登录后有查看和操作的权限</li><li>不登录只有查看的权限</li></ul><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><h4 id="用户密码加密"><a href="#用户密码加密" class="headerlink" title="用户密码加密"></a>用户密码加密</h4><p>注册时</p><ol><li>用户输入密码，生成随机的盐值，把密码和盐值拼接后，经过MD5生成秘钥并保存</li><li>盐值也需要一同保存到数据库</li></ol><p>登录时</p><ol><li>把用户输入的密码和数据库中保存的盐值进行MD5加密，生成的秘钥和数据库中的秘钥进行比对</li></ol><blockquote><p>MD5生成的秘钥是不可逆的</p></blockquote><h4 id="接口文档"><a href="#接口文档" class="headerlink" title="接口文档"></a>接口文档</h4><p><strong>swagger</strong></p><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.swagger;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SwaggerConfiguration</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">buildDocket</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(buildApiInfo())<br>                .select()<br>                <span class="hljs-comment">// 要扫描的API(Controller)基础包</span><br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.heima&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">buildApiInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Contact</span> <span class="hljs-variable">contact</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Contact</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                .title(<span class="hljs-string">&quot;黑马头条-平台管理API文档&quot;</span>)<br>                .description(<span class="hljs-string">&quot;黑马头条后台api&quot;</span>)<br>                .contact(contact)<br>                .version(<span class="hljs-string">&quot;1.0.0&quot;</span>).build();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>访问</p><p><code>localhost:51801/swagger-ui.html</code></p><p><strong>knife4j</strong></p><p>swagger对应的包也要导</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.common.swagger;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-meta">@EnableKnife4j</span><br><span class="hljs-meta">@Import(BeanValidatorPluginsConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Swagger2Configuration</span> &#123;<br><br>    <span class="hljs-meta">@Bean(value = &quot;defaultApi2&quot;)</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">defaultApi2</span><span class="hljs-params">()</span> &#123;<br>        Docket docket=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                <span class="hljs-comment">//分组名称</span><br>                .groupName(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                .select()<br>                <span class="hljs-comment">//这里指定Controller扫描包路径</span><br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.heima&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>        <span class="hljs-keyword">return</span> docket;<br>    &#125;<br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                .title(<span class="hljs-string">&quot;黑马头条API文档&quot;</span>)<br>                .description(<span class="hljs-string">&quot;黑马头条API文档&quot;</span>)<br>                .version(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>访问</p><p><code>localhost:51801/doc.html</code></p><h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><blockquote><p>授权、限流、登录、日志、跨域</p></blockquote><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加本地配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">51601</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">leadnews-app-gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:8848</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yml</span><br></code></pre></td></tr></table></figure><p>nacos添加配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">add-to-simple-url-handler-mapping:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">corsConfigurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span><br>            <span class="hljs-attr">allowedHeaders:</span> <span class="hljs-string">&quot;*&quot;</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span><br>            <span class="hljs-attr">allowedMethods:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">POST</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">DELETE</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">PUT</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-string">OPTION</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-comment"># 平台管理</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://leadnews-user</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><strong>网关的过滤器</strong></p><blockquote><p>实现GlobalFilter和Ordered接口</p><p>GlobalFilter的filter方法为具体的过滤逻辑</p><p>Ordered为设置过滤器的优先级，数值越小优先级越高</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.app.gateway.filter;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 判断是否登录的过滤器，没有验证用户身份</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ordered</span>, GlobalFilter &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        <span class="hljs-comment">// 访问登录接口，放行</span><br>        <span class="hljs-keyword">if</span> (request.getURI().getPath().contains(<span class="hljs-string">&quot;/login&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br>        <span class="hljs-comment">// 判断是否登录</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeaders().getFirst(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(token)) &#123;<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> AppJwtUtil.getClaimsBody(token);<br>            <span class="hljs-comment">// 判断token是否过期</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> AppJwtUtil.verifyToken(claims);<br>            <span class="hljs-keyword">if</span> (result == <span class="hljs-number">1</span> || result == <span class="hljs-number">2</span>) &#123;<br>                response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>                <span class="hljs-keyword">return</span> response.setComplete();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            response.setStatusCode(HttpStatus.UNAUTHORIZED);<br>            <span class="hljs-keyword">return</span> response.setComplete();<br>        &#125;<br>        <span class="hljs-comment">// 放行</span><br>        <span class="hljs-keyword">return</span> chain.filter(exchange);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h4><blockquote><p>反向代理，负载均衡，部署前端项目</p></blockquote><ol><li>配置nginx.conf文件</li><li>通过<code>nginx</code>命令启动nginx</li></ol><p>在<code>conf</code>文件夹下创建新的文件夹来放自己编写的<code>conf</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs conf"># 配置了反向代理<br>upstream  heima-app-gateway&#123;<br>    server localhost:51601;<br>&#125;<br><br>server &#123;<br>listen 8801;<br>location / &#123;<br>root D:/workspace/app-web/;<br>index index.html;<br>&#125;<br><br>location ~/app/(.*) &#123;<br>proxy_pass http://heima-app-gateway/$1;<br>proxy_set_header HOST $host;  # 不改变源请求头的值<br>proxy_pass_request_body on;  #开启获取请求体<br>proxy_pass_request_headers on;  #开启获取请求头<br>proxy_set_header X-Real-IP $remote_addr;   # 记录真实发出请求的客户端IP<br>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  #记录代理信息<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在<code>conf</code>文件夹下的<code>nginx.conf</code>里导入自己编写的<code>conf</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs conf"><br>#user  nobody;<br>worker_processes  1;<br><br>events &#123;<br>    worker_connections  1024;<br>&#125;<br>http &#123;<br>    include       mime.types;<br>    default_type  application/octet-stream;<br>    sendfile        on;<br>    keepalive_timeout  65;<br># 引入自定义配置文件<br>include leadnews.conf/*.conf;<br>&#125;<br></code></pre></td></tr></table></figure><p>重新加载配置文件<code>nginx -s reload</code>并重启</p><h2 id="查看文章"><a href="#查看文章" class="headerlink" title="查看文章"></a>查看文章</h2><h3 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h3><p><strong>刷新</strong></p><p>上拉刷新：加载最新文章</p><p>下拉刷新：加载早先的文章</p><p> <strong>展示文章详情</strong></p><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><h4 id="拆分表"><a href="#拆分表" class="headerlink" title="拆分表"></a>拆分表</h4><p>ap_article：文章概述</p><p>ap_article_config：文章配置（是否删除等）</p><p>ap_article_content：文章详情</p><p>垂直分表：将一个表的字段分散到多个表中</p><p>好处：</p><ol><li>减少锁表的几率，查看文章概述和详情互不影响</li><li>查询文章详情数据效率低，不会影响到查询文章概述</li></ol><p>拆分规则：</p><ol><li>不常用字段单独放一张表</li><li>把大字段拆分出来单独一张表</li><li>经常组合查询的字段单独一张表</li></ol><h4 id="FreeMarker模板引擎"><a href="#FreeMarker模板引擎" class="headerlink" title="FreeMarker模板引擎"></a>FreeMarker模板引擎</h4><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8881</span> <span class="hljs-comment">#服务端口</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">freemarker-demo</span> <span class="hljs-comment">#指定服务名</span><br>  <span class="hljs-attr">freemarker:</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span>  <span class="hljs-comment">#关闭模板缓存，方便测试</span><br>    <span class="hljs-attr">settings:</span><br>      <span class="hljs-attr">template_update_delay:</span> <span class="hljs-number">0</span> <span class="hljs-comment">#检查模板更新延迟时间，设置为0表示立即检查，如果时间大于0会有缓存不方便进行模板测试</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.ftl</span>               <span class="hljs-comment">#指定Freemarker模板文件的后缀名</span><br></code></pre></td></tr></table></figure><p>添加模板</p><blockquote><p>在resources&#x2F;templates&#x2F;下</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=&quot;utf-8&quot;&gt;<br>    &lt;title&gt;Hello World!&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;b&gt;普通文本 String 展示：&lt;/b&gt;&lt;br&gt;&lt;br&gt;<br>Hello $&#123;name&#125; &lt;br&gt;<br>&lt;hr&gt;<br>&lt;b&gt;对象Student中的数据展示：&lt;/b&gt;&lt;br/&gt;<br>姓名：$&#123;stu.name&#125;&lt;br/&gt;<br>年龄：$&#123;stu.age&#125;<br>&lt;hr&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.freemarker.controller;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(Model model)</span> &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;freemarker&quot;</span>);<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;zs&quot;</span>);<br>        student.setAge(<span class="hljs-number">18</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;stu&quot;</span>, student);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;01-basic&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h4><p>分布式对象存储服务</p><p><strong>概念</strong></p><ul><li>bucket：类似目录</li><li>Object：类似文件</li><li>Keys：类似文件名</li></ul><p><strong>docker安装</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -p <span class="hljs-number">9000</span>:<span class="hljs-number">9000</span> --name minio -d --restart=always -e <span class="hljs-string">&quot;MINIO_ACCESS_KEY=minio&quot;</span> -e <span class="hljs-string">&quot;MINIO_SECRET_KEY=minio123&quot;</span> -v <span class="hljs-regexp">/home/</span>data:<span class="hljs-regexp">/data -v /</span>home<span class="hljs-regexp">/config:/</span>root<span class="hljs-regexp">/.minio minio/mi</span>nio server /data<br></code></pre></td></tr></table></figure><p>访问控制台<code>192.168.200.130:9000</code></p><p><strong>使用java上传文件</strong></p><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.minio<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>minio<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 准备文件</span><br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;d:\\list.html&quot;</span>);<br>            <span class="hljs-comment">// MinIO连接信息</span><br>            <span class="hljs-type">MinioClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> MinioClient.builder()<br>                .credentials(<span class="hljs-string">&quot;minio&quot;</span>, <span class="hljs-string">&quot;minio123&quot;</span>)<br>                .endpoint(<span class="hljs-string">&quot;http://192.168.200.130:9000&quot;</span>)<br>                .build();<br>            <span class="hljs-comment">// 上传文件</span><br>            <span class="hljs-type">PutObjectArgs</span> <span class="hljs-variable">putObjectArgs</span> <span class="hljs-operator">=</span> PutObjectArgs.builder()<br>                .object(<span class="hljs-string">&quot;list.html&quot;</span>)    <span class="hljs-comment">// 文件在MinIO中的文件名</span><br>                .contentType(<span class="hljs-string">&quot;text/html&quot;</span>)   <span class="hljs-comment">// 文件类型</span><br>                .bucket(<span class="hljs-string">&quot;leadnews&quot;</span>) <span class="hljs-comment">// 桶名称</span><br>                .stream(fileInputStream, fileInputStream.available(), -<span class="hljs-number">1</span>)   <span class="hljs-comment">// 上传的文件</span><br>                .build();<br>            client.putObject(putObjectArgs);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;上传成功&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>使用：</p><p>​通过FreeMarker将文章数据和模板绑定后生成静态文件，把静态的html文件保存到MinIO中，之后访问对应的文章页面就直接从MinIO中返回，不用再查询数据库</p><h2 id="保存文章"><a href="#保存文章" class="headerlink" title="保存文章"></a>保存文章</h2><p>自媒体端发布文章，审核通过后，App端需要保存文章信息 </p><p>通过<strong>Feign</strong>远程让自媒体端远程调用</p><p>有带文章id：</p><ul><li>修改文章</li><li>更新文章、文章内容</li></ul><p>没有带文章id：</p><ul><li>新增的文章</li><li>要保存文章、文章配置、文章内容</li></ul><h2 id="文章搜索"><a href="#文章搜索" class="headerlink" title="文章搜索"></a>文章搜索</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><h4 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h4><p><strong>安装</strong></p><ol><li><p>拉取镜像</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">docker pull elasticsearch:<span class="hljs-number">7.4</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure></li><li><p>创建容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">docker run -id --name elasticsearch -d --restart=always -p <span class="hljs-number">9200</span>:<span class="hljs-number">9200</span> -p <span class="hljs-number">9300</span>:<span class="hljs-number">9300</span> -v /usr/share/elasticsearch/plugins:/usr/share/elasticsearch/plugins -e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> elasticsearch:<span class="hljs-number">7.4</span><span class="hljs-number">.0</span><br></code></pre></td></tr></table></figure></li><li><p>设置ik分词器</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">把ik分词器上传到挂载的目录<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/elasticsearch/</span>plugins中解压<br>重启es<br></code></pre></td></tr></table></figure></li><li><p>测试</p></li></ol><p><strong>添加映射</strong></p><ol><li><p>添加语法：put请求发送<code>ip:端口/映射名</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span>:<span class="hljs-number">9200</span>/app_info_article<br><br>&#123;<br>    <span class="hljs-string">&quot;mappings&quot;</span>:&#123;<br>        <span class="hljs-string">&quot;properties&quot;</span>:&#123;<br>            <span class="hljs-string">&quot;id&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;long&quot;</span><br>            &#125;,<br>            <span class="hljs-string">&quot;publishTime&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;date&quot;</span><br>            &#125;,<br>            <span class="hljs-string">&quot;layout&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;integer&quot;</span><br>            &#125;,<br>            <span class="hljs-string">&quot;images&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-literal">false</span><br>            &#125;,<br>            <span class="hljs-string">&quot;staticUrl&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;keyword&quot;</span>,<br>                <span class="hljs-string">&quot;index&quot;</span>: <span class="hljs-literal">false</span><br>            &#125;,<br>            <span class="hljs-string">&quot;authorId&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;long&quot;</span><br>            &#125;,<br>            <span class="hljs-string">&quot;authorName&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span><br>            &#125;,<br>            <span class="hljs-string">&quot;title&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;ik_smart&quot;</span><br>            &#125;,<br>            <span class="hljs-string">&quot;content&quot;</span>:&#123;<br>                <span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;text&quot;</span>,<br>                <span class="hljs-string">&quot;analyzer&quot;</span>:<span class="hljs-string">&quot;ik_smart&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>其他操作</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET请求查询映射：http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.130</span>:<span class="hljs-number">9200</span>/app_info_article<br><br>DELETE请求，删除索引及映射：http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.130</span>:<span class="hljs-number">9200</span>/app_info_article<br><br>GET请求，查询所有文档：http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.130</span>:<span class="hljs-number">9200</span><span class="hljs-regexp">/app_info_article/</span>_search<br></code></pre></td></tr></table></figure></li></ol><p><strong>初始化索引库</strong></p><ol><li><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入依赖模块 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.heima<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>heima-leadnews-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- Spring boot starter --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--elasticsearch--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jsoup<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsoup<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.13.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>es配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;elasticsearch&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElasticSearchConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> String host;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RestHighLevelClient <span class="hljs-title function_">client</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestHighLevelClient</span>(RestClient.builder(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHost</span>(<br>                        host,<br>                        port,<br>                        <span class="hljs-string">&quot;http&quot;</span><br>                )<br>        ));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">es-article</span><br><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/leadnews_article?useUnicode=true&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br><span class="hljs-comment"># 设置Mapper接口所对应的XML文件位置，如果你在Mapper接口中有自定义方法，需要进行该配置</span><br><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath*:mapper/*.xml</span><br>  <span class="hljs-comment"># 设置别名包扫描路径，通过该属性可以给包中的类注册别名</span><br>  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.heima.model.article.pojos</span><br><br><br><span class="hljs-comment">#自定义elasticsearch连接配置</span><br><span class="hljs-attr">elasticsearch:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9200</span><br><br></code></pre></td></tr></table></figure></li><li><p>创建实体、mapper</p></li><li><p>导入数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApArticleTest</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> ApArticleMapper apArticleMapper;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestHighLevelClient restHighLevelClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 初始化es中的数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 查询文章</span><br>        List&lt;SearchArticleVo&gt; searchArticleVos = apArticleMapper.loadArticleList();<br><br>        <span class="hljs-comment">// 批量导入es</span><br>        <span class="hljs-type">BulkRequest</span> <span class="hljs-variable">bulkRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>(<span class="hljs-string">&quot;app_info_article&quot;</span>);<br>        <span class="hljs-keyword">for</span> (SearchArticleVo searchArticleVo : searchArticleVos) &#123;<br>            <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">indexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>()<br>                .id(searchArticleVo.getId().toString())<br>                .source(JSON.toJSONString(searchArticleVo), XContentType.JSON);<br>            bulkRequest.add(indexRequest);<br>        &#125;<br><br>        restHighLevelClient.bulk(bulkRequest, RequestOptions.DEFAULT);<br>        System.out.println(<span class="hljs-string">&quot;文章信息导入es完成&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol><h4 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h4><p>搜索栏</p><p>创建文章时添加文档到索引</p><h2 id="搜索记录"><a href="#搜索记录" class="headerlink" title="搜索记录"></a>搜索记录</h2><p>每个用户都需要存储搜搜记录，数据量较大，使用MongoDB来存</p><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><p><strong>MongoDB</strong></p><p>docker安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull mongo<br><br>docker run -di --name mongo-service --restart=always -p 27017:27017 -v ~/data/mongodata:/data mongo<br></code></pre></td></tr></table></figure><p>spring集成mongodb</p><ol><li><p>导入依赖</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;<br>    &lt;/dependency&gt;<br></code></pre></td></tr></table></figure></li><li><p>添加配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9998</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span><br>      <span class="hljs-attr">database:</span> <span class="hljs-string">leadnews-history</span><br></code></pre></td></tr></table></figure></li><li><p>映射类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(&quot;ap_associate_words&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApAssociateWords</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 联想词</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String associateWords;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 创建时间</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Date createdTime;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest(classes = MongoApplication.class)</span><br><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoTest</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ApAssociateWords</span> <span class="hljs-variable">apAssociateWords</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApAssociateWords</span>();<br>        apAssociateWords.setAssociateWords(<span class="hljs-string">&quot;test&quot;</span>);<br>        apAssociateWords.setCreatedTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        mongoTemplate.save(apAssociateWords);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findByIdTest</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">ApAssociateWords</span> <span class="hljs-variable">apAssociateWords</span> <span class="hljs-operator">=</span> mongoTemplate.findById(<span class="hljs-string">&quot;64b65971d91a9f14ddf8da6a&quot;</span>, ApAssociateWords.class);<br>        System.out.println(apAssociateWords);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findByWordsTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> Query.query(Criteria.where(<span class="hljs-string">&quot;associateWords&quot;</span>).is(<span class="hljs-string">&quot;test&quot;</span>))<br>            .with(Sort.by(Sort.Direction.DESC, <span class="hljs-string">&quot;createdTime&quot;</span>));<br>        List&lt;ApAssociateWords&gt; apAssociateWordsList = mongoTemplate.find(query, ApAssociateWords.class);<br>        System.out.println(apAssociateWordsList);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDel</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> Query.query(Criteria.where(<span class="hljs-string">&quot;associateWords&quot;</span>).is(<span class="hljs-string">&quot;test&quot;</span>));<br>        mongoTemplate.remove(query, ApAssociateWords.class);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol><h3 id="需求-3"><a href="#需求-3" class="headerlink" title="需求"></a>需求</h3><p>保存用户的最新的10条记录在mongodb中</p><p>如果记录在历史中，更新时间</p><p>如果不在历史中，删掉最旧的一条记录再添加</p><h2 id="用户行为"><a href="#用户行为" class="headerlink" title="用户行为"></a>用户行为</h2><h3 id="需求-4"><a href="#需求-4" class="headerlink" title="需求"></a>需求</h3><p>所有用户行为信息都要存到Redis中</p><h4 id="点赞-x2F-取消点赞"><a href="#点赞-x2F-取消点赞" class="headerlink" title="点赞&#x2F;取消点赞"></a>点赞&#x2F;取消点赞</h4><p>用户点赞后记录到redis中，取消点赞时从redis中删除</p><h4 id="阅读数"><a href="#阅读数" class="headerlink" title="阅读数"></a>阅读数</h4><p>将文章阅读数以hash结构存到redis</p><p>key：Article:viewCont；key：articleId；value：阅读数</p><h4 id="展示用户行为数据"><a href="#展示用户行为数据" class="headerlink" title="展示用户行为数据"></a>展示用户行为数据</h4><p>通过用户id和文章id查找redis的set中是否有对应的value</p><h4 id="关注-x2F-取关"><a href="#关注-x2F-取关" class="headerlink" title="关注&#x2F;取关"></a>关注&#x2F;取关</h4><p>CRUD，同时改关注表和粉丝表</p><h4 id="收藏"><a href="#收藏" class="headerlink" title="收藏"></a>收藏</h4><p>CRUD</p><h2 id="热门文章"><a href="#热门文章" class="headerlink" title="热门文章"></a>热门文章</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><h4 id="xxl-job"><a href="#xxl-job" class="headerlink" title="xxl-job"></a>xxl-job</h4><p>分布式任务调度框架</p><p>spring传统的定时任务@Scheduled，但是这样存在这一些问题 ：</p><ul><li>做集群任务的重复执行问题</li><li>cron表达式定义在代码之中，修改不方便</li><li>定时任务失败了，无法重试也没有统计</li><li>如果任务量过大，不能有效的分片执行</li></ul><p><strong>部署</strong></p><p>windows</p><ol><li>下载源码：<a href="https://gitee.com/xuxueli0323/xxl-job">https://gitee.com/xuxueli0323/xxl-job</a></li><li>执行sql</li><li>修改<code>xxl-job-admin</code>下的数据库配置</li><li>启动<code>XxlJobAdminApplication</code></li><li>访问<code>http://localhost:8080/xxl-job-admin/</code>，账号admin，密码123456</li></ol><p>docker</p><ol><li><p>创建mysql容器，执行xxl-job的sql脚本</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -p 3306:3306 --name mysql57 \<br>-v /opt/mysql/conf:/etc/mysql \<br>-v /opt/mysql/logs:/var/log/mysql \<br>-v /opt/mysql/data:/var/lib/mysql \<br>-e MYSQL_ROOT_PASSWORD=root \<br>-d mysql:5.7<br></code></pre></td></tr></table></figure></li><li><p>拉取xxl-job镜像</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull xuxueli/xxl-job-admin:2.3.0<br></code></pre></td></tr></table></figure></li><li><p>创建xxl-job容器</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -e PARAMS=&quot;--spring.datasource.url=jdbc:mysql://192.168.200.130:3306/xxl_job?Unicode=true&amp;characterEncoding=UTF-8 \<br>--spring.datasource.username=root \<br>--spring.datasource.password=root&quot; \<br>-p 8888:8080 -v /tmp:/data/applogs \<br>--name xxl-job-admin --restart=always  -d xuxueli/xxl-job-admin:2.3.0<br></code></pre></td></tr></table></figure></li><li><p>访问测试</p></li></ol><p><strong>使用</strong></p><ol><li><p>导包</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.xuxueli<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xxl-job-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置类，可以从官方的源码里找到</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.xxlJob.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XxlJobConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(XxlJobConfig.class);<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String adminAddresses;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String appname;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> XxlJobSpringExecutor <span class="hljs-title function_">xxlJobExecutor</span><span class="hljs-params">()</span> &#123;<br>        logger.info(<span class="hljs-string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);<br>        <span class="hljs-type">XxlJobSpringExecutor</span> <span class="hljs-variable">xxlJobSpringExecutor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XxlJobSpringExecutor</span>();<br>        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);<br>        xxlJobSpringExecutor.setAppname(appname);<br>        xxlJobSpringExecutor.setPort(port);<br>        <span class="hljs-keyword">return</span> xxlJobSpringExecutor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>添加配置</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8881</span><br><br><span class="hljs-attr">xxl:</span><br>  <span class="hljs-attr">job:</span><br>    <span class="hljs-attr">admin:</span><br>      <span class="hljs-attr">addresses:</span> <span class="hljs-string">http://192.168.200.130:8888/xxl-job-admin</span><br>    <span class="hljs-attr">executor:</span><br>      <span class="hljs-attr">appname:</span> <span class="hljs-string">sample</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span>    <span class="hljs-comment"># 随意</span><br><br></code></pre></td></tr></table></figure></li><li><p>编写要执行的方法</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.xxlJob.jpb;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloJob</span> &#123;<br>    <span class="hljs-meta">@XxlJob(&quot;demoJobHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;job test&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在控制台添加执行器管理和任务管理</p></li><li><p>在任务管理里运行定时任务</p></li></ol><p><strong>路由策略</strong></p><ol><li>轮询：服务器轮流执行任务</li><li>分片广播：将任务序号取模来分配到服务器上</li></ol><h4 id="KafkaStream"><a href="#KafkaStream" class="headerlink" title="KafkaStream"></a>KafkaStream</h4><p>Kafka Stream是Apache Kafka从0.10版本引入的一个新Feature。它是提供了对存储于Kafka内的数据进行<strong>流式处理和分析</strong>的功能。</p><p><strong>概念</strong></p><p>Source Processor：源处理器，从Topic中生成输入流，转发给其他处理器进行处理</p><p>Sink Processor：将处理器处理完的数据转发给指定的Topic</p><p><strong>入门案例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * kafka stream 流式处理</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaStreamQuickStart</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 配置</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        prop.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="hljs-string">&quot;192.168.200.130:9092&quot;</span>);<br>        prop.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        prop.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        prop.put(StreamsConfig.APPLICATION_ID_CONFIG,<span class="hljs-string">&quot;streams-quickstart&quot;</span>);<br>        <span class="hljs-comment">// builder</span><br>        <span class="hljs-type">StreamsBuilder</span> <span class="hljs-variable">streamsBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamsBuilder</span>();<br><br>        <span class="hljs-comment">// 流式计算</span><br>        streamProcessor(streamsBuilder);<br><br>        <span class="hljs-comment">// 创建kafkaStream</span><br>        <span class="hljs-type">KafkaStreams</span> <span class="hljs-variable">kafkaStreams</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaStreams</span>(streamsBuilder.build(), prop);<br>        <span class="hljs-comment">// 开启</span><br>        kafkaStreams.start();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">streamProcessor</span><span class="hljs-params">(StreamsBuilder streamsBuilder)</span> &#123;<br>        <span class="hljs-comment">// 指定从哪个topic中获取消息</span><br>        KStream&lt;String, String&gt; stream = streamsBuilder.stream(<span class="hljs-string">&quot;itcast_topic_input&quot;</span>);<br><br>        stream.flatMapValues(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueMapper</span>&lt;String, Iterable&lt;String&gt;&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Iterable&lt;String&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(String s)</span> &#123;<br>                <span class="hljs-keyword">return</span> Arrays.asList(s.split(<span class="hljs-string">&quot; &quot;</span>));<br>            &#125;<br>        &#125;)<br>            <span class="hljs-comment">// 按照value进行聚合</span><br>            .groupBy((key, value) -&gt; value)<br>            <span class="hljs-comment">// 计算时间间隔</span><br>            .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="hljs-number">10</span>)))<br>            <span class="hljs-comment">// 统计单词个数</span><br>            .count()<br>            .toStream()<br>            .map((key, value) -&gt; &#123;<br>                System.out.println(<span class="hljs-string">&quot;key: &quot;</span> + key + <span class="hljs-string">&quot;, value&quot;</span> + value);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>&lt;&gt;(key.key().toString(), value.toString());<br>            &#125;)<br>            <span class="hljs-comment">// 发送消息</span><br>            .to(<span class="hljs-string">&quot;itcast_topic_out&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>往<code>itcast_topic_input</code>发送消息，<code>itcast_topic_out</code>接收消息</p><p><strong>springboot整合kafkaStream</strong></p><ol><li><p>添加配置</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kafka:</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">$&#123;spring.application.name&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置类</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.config;<br><br><span class="hljs-meta">@Getter</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableKafkaStreams</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;kafka&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaStreamConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_MESSAGE_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>* <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-keyword">private</span> String hosts;<br><br>    <span class="hljs-keyword">private</span> String group;<br><br>    <span class="hljs-meta">@Bean(name = KafkaStreamsDefaultConfiguration.DEFAULT_STREAMS_CONFIG_BEAN_NAME)</span><br>    <span class="hljs-keyword">public</span> KafkaStreamsConfiguration <span class="hljs-title function_">defaultKafkaStreamsConfig</span><span class="hljs-params">()</span> &#123;<br>        Map&lt;String, Object&gt; props = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, hosts);<br>        props.put(StreamsConfig.APPLICATION_ID_CONFIG, <span class="hljs-built_in">this</span>.getGroup()+<span class="hljs-string">&quot;_stream_aid&quot;</span>);<br>        props.put(StreamsConfig.CLIENT_ID_CONFIG, <span class="hljs-built_in">this</span>.getGroup()+<span class="hljs-string">&quot;_stream_cid&quot;</span>);<br>        props.put(StreamsConfig.RETRIES_CONFIG, <span class="hljs-number">10</span>);<br>        props.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        props.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaStreamsConfiguration</span>(props);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>添加监听器，处理流数据</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.listener;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaStreamHelloListener</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> KStream&lt;String,String&gt; <span class="hljs-title function_">kStream</span><span class="hljs-params">(StreamsBuilder streamsBuilder)</span>&#123;<br>        <span class="hljs-comment">//创建kstream对象，同时指定从那个topic中接收消息</span><br>        KStream&lt;String, String&gt; stream = streamsBuilder.stream(<span class="hljs-string">&quot;itcast-topic-input&quot;</span>);<br>        stream.flatMapValues(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueMapper</span>&lt;String, Iterable&lt;String&gt;&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Iterable&lt;String&gt; <span class="hljs-title function_">apply</span><span class="hljs-params">(String value)</span> &#123;<br>                <span class="hljs-keyword">return</span> Arrays.asList(value.split(<span class="hljs-string">&quot; &quot;</span>));<br>            &#125;<br>        &#125;)<br>            <span class="hljs-comment">//根据value进行聚合分组</span><br>            .groupBy((key,value)-&gt;value)<br>            <span class="hljs-comment">//聚合计算时间间隔</span><br>            .windowedBy(TimeWindows.of(Duration.ofSeconds(<span class="hljs-number">10</span>)))<br>            <span class="hljs-comment">//求单词的个数</span><br>            .count()<br>            .toStream()<br>            <span class="hljs-comment">//处理后的结果转换为string字符串</span><br>            .map((key,value)-&gt;&#123;<br>                System.out.println(<span class="hljs-string">&quot;key:&quot;</span>+key+<span class="hljs-string">&quot;,value:&quot;</span>+value);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyValue</span>&lt;&gt;(key.key().toString(),value.toString());<br>            &#125;)<br>            <span class="hljs-comment">//发送消息</span><br>            .to(<span class="hljs-string">&quot;itcast-topic-out&quot;</span>);<br>        <span class="hljs-keyword">return</span> stream;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="需求-5"><a href="#需求-5" class="headerlink" title="需求"></a>需求</h3><p>定时计算：</p><p>​为每个频道缓存热度最高的30条文章（5天之内的）：</p><p>​根据文章的阅读，点赞，评论，收藏加权（1,3,5,8）来判断文章的热度</p><p>​feign调用wemedia，获取所有频道</p><p>​根据频道来分组文章并排序，缓存热度最高的30条文章</p><p>实时计算：</p><p>​behavior微服务中，在记录用户行为后，发送消息到kafka的一个topic中</p><p>​article微服务中，创建handle获取kafka的消息，记录、转换后发送到另一个topic中</p><p>​之后article里面创建一个listener来监听这个topic来更新数据库和缓存</p><h1 id="自媒体端"><a href="#自媒体端" class="headerlink" title="自媒体端"></a>自媒体端</h1><h2 id="登录-1"><a href="#登录-1" class="headerlink" title="登录"></a>登录</h2><p>同app端的登录</p><h2 id="上传素材"><a href="#上传素材" class="headerlink" title="上传素材"></a>上传素材</h2><ol><li><p>获取登录用户id</p><p>1.1 在wemedia网关中将token中的载荷userId存到header中</p><p>1.2 wemedia服务中通过拦截器，将header中的id存到ThreadLocal中</p></li><li><p>保存素材到minIO</p><p>2.1 校验参数，UUID随机生成素材名称</p><p>2.2 保存到minIO后，将访问地址保存到数据库中</p><p>2.3 返回素材数据供前端回显</p></li></ol><h2 id="展示素材列表"><a href="#展示素材列表" class="headerlink" title="展示素材列表"></a>展示素材列表</h2><p>分页查询，查询条件为是全部还是已收藏的素材</p><p>根据ThreadLocal中的userId查找用户的素材</p><h2 id="发布文章"><a href="#发布文章" class="headerlink" title="发布文章"></a>发布文章</h2><ul><li>如果文章状态为草稿<ul><li>只保存文章信息，文章和图片的对应关系暂不保存</li></ul></li><li>不为草稿<ul><li>保存文章信息和文章与图片的对应关系</li></ul></li><li>判断文章封面图片<ul><li>选择无图、单图、三图：选择文章中的图片</li><li>选择自动：根据文章中图片的数量来决定</li></ul></li></ul><h2 id="展示文章"><a href="#展示文章" class="headerlink" title="展示文章"></a>展示文章</h2><p>同展示素材列表</p><h2 id="文章审核"><a href="#文章审核" class="headerlink" title="文章审核"></a>文章审核</h2><p>接入阿里云的内容安全服务，通过调用第三方接口对文章内容进行审查</p><p>需要开通阿里云内容安全服务，accessKeyId，secret</p><p><a href="https://help.aliyun.com/document_detail/433565.html?spm=a2c4g.464388.0.0.4b822d46lSWB0h">文本审核增强版 (aliyun.com)</a></p><p>审核完图片和文章后，调用App端微服务的保存文章<strong>Feign</strong>接口</p><p><strong>服务降级</strong>：</p><ol><li>实现feign远程接口，编写降级逻辑</li><li>在<code>@FeignClient</code>注解中指定降级逻辑</li><li>在自媒体端中添加配置类来扫描服务降级类所在的包</li><li>在自媒体端的远程配置中开启服务降级</li></ol><p><strong>异步调用</strong></p><ul><li>自媒体端保存文章时异步调用文章审核</li><li>开启异步调用@EnableAsync</li><li>在审核文章方法上加@Async</li></ul><h2 id="敏感词过滤"><a href="#敏感词过滤" class="headerlink" title="敏感词过滤"></a>敏感词过滤</h2><p><strong>文本过滤方案</strong></p><table><thead><tr><th><strong>方案</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>数据库模糊查询</td><td>效率太低</td></tr><tr><td>String.indexOf(“”)查找</td><td>数据库量大的话也是比较慢</td></tr><tr><td>全文检索</td><td>分词再匹配</td></tr><tr><td><strong>DFA算法</strong></td><td>确定有穷自动机(一种数据结构)</td></tr></tbody></table><p>DFA算法类似字典树来匹配敏感词</p><p><strong>图片过滤方案</strong></p><blockquote><p>OCR （Optical Character Recognition，光学字符识别）是指电子设备（例如扫描仪或数码相机）检查纸上打印的字符，通过检测暗、亮的模式确定其形状，然后用字符识别方法将形状翻译成计算机文字的过程</p></blockquote><table><thead><tr><th><strong>方案</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>百度OCR</td><td>收费</td></tr><tr><td>Tesseract-OCR</td><td>Google维护的开源OCR引擎，支持Java，Python等语言调用</td></tr><tr><td><strong>Tess4J</strong></td><td>封装了Tesseract-OCR  ，支持Java调用</td></tr></tbody></table><p><strong>Tess4J</strong>使用</p><ol><li><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.sourceforge.tess4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tess4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 本地图片文件</span><br>            <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\ASUS\\Desktop\\aaa.jpg&quot;</span>);<br>            <span class="hljs-comment">// 创建Tesseract对象</span><br>            <span class="hljs-type">Tesseract</span> <span class="hljs-variable">tesseract</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tesseract</span>();<br>            <span class="hljs-comment">// 设置字体库路径</span><br>            tesseract.setDatapath(<span class="hljs-string">&quot;D:\\download\\&quot;</span>);<br>            <span class="hljs-comment">// 设置具体字体库</span><br>            tesseract.setLanguage(<span class="hljs-string">&quot;chi_sim&quot;</span>);<br>            <span class="hljs-comment">// 识别图片文字</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> tesseract.doOCR(file);<br>            result = result.replace(<span class="hljs-string">&quot;\\r|\\n&quot;</span>, <span class="hljs-string">&quot;-&quot;</span>);<br>            System.out.println(<span class="hljs-string">&quot;识别结果：&quot;</span> + result);<br>        &#125; <span class="hljs-keyword">catch</span> (TesseractException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="文章定时发布"><a href="#文章定时发布" class="headerlink" title="文章定时发布"></a>文章定时发布</h2><h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><p><strong>DelayQueue</strong>：</p><p>JDK自带的延迟队列，队列元素实现<strong>Delayed</strong>接口（获取剩余时间，排序），之后将元素添加到<code>DelayerQueue</code>中，只有过期的元素才能poll()出来</p><p>缺点：</p><ol><li>服务关闭就丢失队列中的任务</li></ol><p><strong>RabbitMQ</strong>：</p><p>通过死信交换机实现延迟队列，当消息过期后会被发送到死信交换机中</p><p><strong>Redis</strong>：</p><p>先将任务添加到数据库中实现持久化，</p><p>然后把未来5分钟之内要执行的任务添加到zSet，zSet再把当前要执行的任务放到list中</p><p><strong>Redis实现定时发布</strong></p><ol><li><p>拉取、启动redis</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull redis<br><br>docker run -d --name redis --restart=always -p 6379:6379 redis --requirepass &quot;leadnews&quot;<br></code></pre></td></tr></table></figure></li><li><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- redis依赖commons-pool 这个依赖一定要添加 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置，测试</p></li></ol><p><strong>生产任务</strong></p><p>先将任务及日志添加到数据库中实现持久化，</p><p>然后把未来5分钟之内要执行的任务添加到zSet，zSet再把当前要执行的任务放到list中</p><p><strong>取消任务</strong></p><p>将任务从数据库中删除，更改对应日志的状态，</p><p>然后删除redis中的任务</p><p><strong>消费任务</strong></p><p>删除redis、db中任务，更新日志，返回任务</p><p><strong>从zSet中刷新任务</strong></p><p>将zSet中的到期任务刷到对应list中</p><p>使用<code>scan</code>来获取一定数量的任务，<code>keys *</code>占用cpu太多不使用</p><p>通过定时任务实现定时刷新</p><p>通过redis的<code>setnx</code>实现分布式锁，让多个定时任务同时只能有一个执行刷新任务</p><p><strong>从DB中同步任务</strong></p><p>先清空redis中的任务，保证任务不会重复存在于redis中</p><p>从DB中将5分钟之内的数据刷新到redis中</p><p><code>heima-leadnews-schedule</code>通过Feign向外提供服务</p><h2 id="文章上架下架"><a href="#文章上架下架" class="headerlink" title="文章上架下架"></a>文章上架下架</h2><h3 id="知识点-5"><a href="#知识点-5" class="headerlink" title="知识点"></a>知识点</h3><h4 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h4><p>mq比较</p><ul><li>RabbitMQ：性能较好，数据量没有那么大</li><li>RocketMQ：可靠性好</li><li>Kafka：吞吐量高</li></ul><p><strong>概念</strong></p><ul><li>producer：发布消息的对象称之为主题生产者（Kafka topic producer）</li><li><strong>topic</strong>：Kafka将消息分门别类，每一类的消息称之为一个主题（Topic），一个topic可以在集群上的不同机器上有分区</li><li>consumer：订阅消息并处理发布的消息的对象称之为主题消费者（consumers）</li><li>broker：已发布的消息保存在一组服务器中，称之为Kafka集群。集群中的每一个服务器都是一个代理（Broker）。 消费者可以订阅一个或多个主题（topic），并从Broker拉数据，从而消费这些已发布的消息。</li></ul><p><strong>安装</strong></p><ol><li><p>安装zookeeper</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull zookeeper:3.4.14<br><br>docker run -d --name zookeeper -p 2181:2181 zookeeper:3.4.14<br></code></pre></td></tr></table></figure></li><li><p>安装kafka</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull wurstmeister/kafka:2.12-2.3.1<br><br>docker run -d --name kafka \<br>--env KAFKA_ADVERTISED_HOST_NAME=192.168.200.130 \<br>--env KAFKA_ZOOKEEPER_CONNECT=192.168.200.130:2181 \<br>--env KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://192.168.200.130:9092 \<br>--env KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \<br>--env KAFKA_HEAP_OPTS=&quot;-Xmx256M -Xms256M&quot; \<br>--net=host wurstmeister/kafka:2.12-2.3.1<br></code></pre></td></tr></table></figure></li><li><p>测试</p><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.sample;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerQuickStart</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//1.kafka的配置信息</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        <span class="hljs-comment">//kafka的连接地址</span><br>        properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,<span class="hljs-string">&quot;192.168.200.130:9092&quot;</span>);<br>        <span class="hljs-comment">//发送失败，失败的重试次数</span><br>        properties.put(ProducerConfig.RETRIES_CONFIG,<span class="hljs-number">5</span>);<br>        <span class="hljs-comment">//消息key的序列化器</span><br>        properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,<span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br>        <span class="hljs-comment">//消息value的序列化器</span><br>        properties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,<span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringSerializer&quot;</span>);<br><br>        <span class="hljs-comment">// 生产者</span><br>        KafkaProducer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;&gt;(properties);<br><br>        <span class="hljs-comment">// 消息</span><br>        ProducerRecord&lt;String, String&gt; record = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">&quot;topic001&quot;</span>,<span class="hljs-string">&quot;key001&quot;</span>,<span class="hljs-string">&quot;hello kafka&quot;</span>);<br><br>        <span class="hljs-comment">// 发送消息</span><br>        producer.send(record);<br>        System.out.println(<span class="hljs-string">&quot;=======消息发送成功&quot;</span>);<br><br>        <span class="hljs-comment">// 关闭消息通道，消息才能发送出去</span><br>        producer.close();<br><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.kafka.sample;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerQuickStart</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//1.添加kafka的配置信息</span><br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        <span class="hljs-comment">//kafka的连接地址</span><br>        properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="hljs-string">&quot;192.168.200.130:9092&quot;</span>);<br>        <span class="hljs-comment">//消费者组，同一个组里的同时只能有一个消费者接收到消息</span><br>        properties.put(ConsumerConfig.GROUP_ID_CONFIG, <span class="hljs-string">&quot;group2&quot;</span>);<br>        <span class="hljs-comment">//消息的反序列化器</span><br>        properties.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);<br>        properties.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, <span class="hljs-string">&quot;org.apache.kafka.common.serialization.StringDeserializer&quot;</span>);<br><br>        <span class="hljs-comment">//2.消费者对象</span><br>        KafkaConsumer&lt;String, String&gt; consumer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaConsumer</span>&lt;String, String&gt;(properties);<br><br>        <span class="hljs-comment">//3.订阅主题</span><br>        consumer.subscribe(Collections.singletonList(<span class="hljs-string">&quot;topic001&quot;</span>));<br><br>        <span class="hljs-comment">// 接收消息</span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>            <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>                System.out.println(record.key());<br>                System.out.println(record.value());<br>            &#125;<br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p><strong>kafka高可用</strong></p><ol><li><p>集群</p><p>集群中的一台服务器称为Broker，即一台服务器宕机了，任然可以对外提供服务</p></li><li><p>备份</p><p>主节点：Leader Replica；从节点：Follower Replica</p><p>从节点又分为ISR（in-sync replica）和普通节点。</p><p>ISR需要同步备份，从节点异步备份。</p><p>所以如果主节点宕机了，如果要数据可靠，则从ISR节点中选择一个作为主节点；如果要高可用，则从任意一个活着的节点中选一个作为主节点</p></li></ol><p><strong>生产者</strong></p><ol><li><p>同步发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RecordMetadata</span> <span class="hljs-variable">recordMetadata</span> <span class="hljs-operator">=</span> producer.send(record).get();<br>System.out.println(<span class="hljs-string">&quot;偏移量：&quot;</span> + recordMetadata.offset());<br></code></pre></td></tr></table></figure></li><li><p>异步发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">producer.send(record, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCompletion</span><span class="hljs-params">(RecordMetadata recordMetadata, Exception e)</span> &#123;<br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>)<br>            e.printStackTrace();<br>        System.out.println(<span class="hljs-string">&quot;偏移量：&quot;</span> + recordMetadata.offset());<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure></li><li><p>部分配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 发送失败，失败的重试次数</span><br>properties.put(ProducerConfig.RETRIES_CONFIG,<span class="hljs-number">5</span>);<br><span class="hljs-comment">// 应答方式 0： 不需要应答 1： 主节点收到后应答（默认） 2： 同步给所有从节点后应答</span><br>properties.put(ProducerConfig.ACKS_CONFIG, <span class="hljs-string">&quot;all&quot;</span>);<br><span class="hljs-comment">// 压缩方式 snappy，lz4，gzip</span><br>properties.put(ProducerConfig.COMPRESSION_TYPE_CONFIG, <span class="hljs-string">&quot;snappy&quot;</span>);<br></code></pre></td></tr></table></figure></li></ol><p><strong>消费者</strong></p><ol><li><p>消费者组</p><p>一个消息在消费者组中只能被一个消费者消费</p><p>一个消息可以被不同组的消费者消费</p></li><li><p>消息有序性</p><p>一个Topic的分区里的消息是按顺序消费的，但不同分区不能保证有序性。</p><p>要保证有序性那就只能提供一个分区</p><blockquote><p>场景：聊天，多次转账的越变更通知</p></blockquote></li><li><p>偏移量</p><p>消费者每处理完一批消息，就会往’_consumer_offset’这个Topic里提交偏移量，偏移量用于确定消息队列中哪些消息被消费了</p><p><strong>自动提交</strong>偏移量可能带来的问题</p><ol><li><p>重复消费</p><p>如果消费者处理一批消息到一半宕机了，但还没有提交偏移量，其他消费者就会来接手分区继续处理消息，此时就会重复消费消息</p></li><li><p>消息丢失</p><p>如果正在处理消息时就提交偏移量，此时宕机了，那么正在处理的消息就会丢失</p></li></ol><p><strong>手动提交</strong>可以解决这些问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 取消自动提交偏移量</span><br>properties.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, <span class="hljs-literal">false</span>);<br><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// 消费消息</span><br>        ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">1000</span>));<br>        <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;<br>            System.out.println(record.key());<br>            System.out.println(record.value());<br>        &#125;<br>        consumer.commitAsync(); <span class="hljs-comment">// 异步提交偏移量，如果出现异常不会重试</span><br>    &#125;<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    e.printStackTrace();<br>    System.out.println(<span class="hljs-string">&quot;错误信息：&quot;</span> + e);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    consumer.commitSync();      <span class="hljs-comment">// 同步提交，如果之前异步提交失败了，这里会不断重试知道发送成功</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="Spring集成Kafka"><a href="#Spring集成Kafka" class="headerlink" title="Spring集成Kafka"></a>Spring集成Kafka</h4><ol><li><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--spring集成kafka--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--Kafka--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kafka-clients<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9991</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">kafka-demo</span><br>  <span class="hljs-attr">kafka:</span><br>    <span class="hljs-comment"># Kafka地址</span><br>    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.130</span><span class="hljs-string">:9092</span><br>    <span class="hljs-comment"># 生产者配置</span><br>    <span class="hljs-attr">producer:</span><br>      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span><br>      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span><br>    <span class="hljs-comment"># 消费者配置</span><br>    <span class="hljs-attr">consumer:</span><br>      <span class="hljs-attr">group-id:</span> <span class="hljs-string">$&#123;spring.application.name&#125;-test</span><br>      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br>      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span><br></code></pre></td></tr></table></figure></li><li><p>生产消息，要发送对象可以转Json</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 发送消息到&#x27;test-topic&#x27;</span><br>        kafkaTemplate.send(<span class="hljs-string">&quot;test-topic&quot;</span>, <span class="hljs-string">&quot;message&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>监听Topic</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloListener</span> &#123;<br><br>    <span class="hljs-comment">// 从&#x27;test-topic&#x27;中接收消息</span><br>    <span class="hljs-meta">@KafkaListener(topics = &#123;&quot;test-topic&quot;&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String message)</span> &#123;<br>        System.out.println(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="需求-6"><a href="#需求-6" class="headerlink" title="需求"></a>需求</h3><p>自媒体端设置文章上下架，通过kafka将文章配置同步到app端</p><h1 id="平台管理端"><a href="#平台管理端" class="headerlink" title="平台管理端"></a>平台管理端</h1><h2 id="登录-2"><a href="#登录-2" class="headerlink" title="登录"></a>登录</h2><p>登录接口：根据传来的用户名密码，和数据库中的进行加盐比对来判断是否登录成功</p><p>网关：解析token，将解析出来的userId放到请求头中</p><p>nginx：将请求反向代理到网关，网关再路由到登录接口</p><h2 id="频道管理"><a href="#频道管理" class="headerlink" title="频道管理"></a>频道管理</h2><p>CRUD</p><h2 id="敏感词管理"><a href="#敏感词管理" class="headerlink" title="敏感词管理"></a>敏感词管理</h2><p>CRUD</p><h2 id="用户认证审核"><a href="#用户认证审核" class="headerlink" title="用户认证审核"></a>用户认证审核</h2><p>CRUD</p><h2 id="文章人工审核"><a href="#文章人工审核" class="headerlink" title="文章人工审核"></a>文章人工审核</h2><p>CRUD</p><h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h2><p>持续集成（ Continuous integration ， 简称 CI ）指的是，频繁地（一天多次）将代码集成到主干</p><p>一个自动构建过程， 从检出代码、 编译构建、 运行测试、 结果记录、 测试统计等都是自动完成的， 无需人工干预。</p><h3 id="知识点-6"><a href="#知识点-6" class="headerlink" title="知识点"></a>知识点</h3><h4 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h4><p>Jenkins  是一款流行的开源持续集成（Continuous Integration）工具，广泛用于项目开发，具有自动化构建、测试和部署等功能</p><p><a href="http://jenkins-ci.org/">http://jenkins-ci.org/</a></p><p>流程：提交代码到git -&gt; jenkins拉取代码，使用jdk、maven等对代码进行编译、打包等操作 -&gt; 最后把生成的jar或war分发到服务器上</p><p><strong>安装</strong></p><blockquote><p>centos7</p></blockquote><p>yum安装</p><ol><li><p>添加安装源</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo wget -O /etc/yum.repos.d/jenkins.repo https://pkg.jenkins.io/redhat-stable/jenkins.repo --no-check-certificate<br><br>sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key<br></code></pre></td></tr></table></figure></li><li><p>命令安装</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install jenkins<br></code></pre></td></tr></table></figure></li><li><p>修改配置</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/sysconfig/jenkins<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改为对应的目标用户， 这里使用的是root</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">JENKINS_USER=<span class="hljs-string">&quot;root&quot;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">服务监听端口</span><br>JENKINS_PORT=&quot;16060&quot;<br></code></pre></td></tr></table></figure> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改目录权限</span><br><br>chown -R root:root /var/lib/jenkins<br>chown -R root:root /var/cache/jenkins<br>chown -R root:root /var/log/jenkins<br></code></pre></td></tr></table></figure></li><li><p>重启</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart jenkins<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">如果报错</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Starting Jenkins bash: /usr/bin/java: No such file or directory</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">需要创建java环境的软链接</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">ln</span> -s /usr/local/jdk/bin/java /usr/bin/java</span><br></code></pre></td></tr></table></figure></li><li><p>访问控制台</p><p> <a href="http://192.168.200.100:16060/">http://192.168.200.100:16060/</a></p><p> 获取管理密码</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cat /var/lib/jenkins/secrets/initialAdminPassword<br></code></pre></td></tr></table></figure></li></ol><p><strong>安装插件</strong></p><p>jenkins的功能需要安装插件来添加</p><p>安装方式：</p><ol><li><p>进入【系统管理】-【插件管理】</p></li><li><p>点击标签页的【可选插件】</p></li></ol><p><strong>安装环境</strong></p><p>在linux系统中安装jdk、git、maven等应用</p><p>然后到控制台的Manager Jenkins的Global Tools Configuration中指定所在位置</p><h4 id="多环境开发"><a href="#多环境开发" class="headerlink" title="多环境开发"></a>多环境开发</h4><ul><li>Development ：开发环境</li><li>Production ：生产环境</li><li>Test ：测试环境</li></ul><p>添加配置指定使用哪个环境的配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br><span class="hljs-attr">profiles:</span><br><span class="hljs-attr">active:</span> <span class="hljs-string">dev</span><br></code></pre></td></tr></table></figure><p>在nacos中添加<code>$&#123;spring.application.name&#125;-环境.yml</code>来设置不同环境的配置文件</p><h4 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h4><ol><li>代码提交到远程仓库</li><li>Jenkins拉取代码，用maven打包，dockerfile创建镜像</li><li>服务器上运行容器</li></ol><p>(示例)</p><p>添加maven插件，自动生成镜像</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>heima-leadnews-user<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>$&#123;java.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.spotify<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dockerfile-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>$&#123;docker.image&#125;/$&#123;project.artifactId&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">buildArgs</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">JAR_FILE</span>&gt;</span>target/$&#123;project.build.finalName&#125;.jar<span class="hljs-tag">&lt;/<span class="hljs-name">JAR_FILE</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">buildArgs</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>添加Dockerfile</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs txt"># 设置JAVA版本<br>FROM java:8<br># 指定存储卷, 任何向/tmp写入的信息都不会记录到容器存储层<br>VOLUME /tmp<br># 拷贝运行JAR包<br>ARG JAR_FILE<br>COPY $&#123;JAR_FILE&#125; app.jar<br># 设置JVM运行参数， 这里限定下内存大小，减少开销<br>ENV JAVA_OPTS=&quot;\<br>-server \<br>-Xms256m \<br>-Xmx512m \<br>-XX:MetaspaceSize=256m \<br>-XX:MaxMetaspaceSize=512m&quot;<br>#空参数，方便创建容器时传参<br>ENV PARAMS=&quot;&quot;<br># 入口点， 执行JAVA运行命令<br>ENTRYPOINT [&quot;sh&quot;,&quot;-c&quot;,&quot;java -jar $JAVA_OPTS /app.jar $PARAMS&quot;]<br></code></pre></td></tr></table></figure><p>将工程上传到远程仓库</p><p>Jenkins工作台 -&gt; 新建Item -&gt; Freestyle project</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bean的生命周期</title>
    <link href="/2023/06/13/spring/bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/"/>
    <url>/2023/06/13/spring/bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    
    <content type="html"><![CDATA[<h1 id="bean的生命周期"><a href="#bean的生命周期" class="headerlink" title="bean的生命周期"></a>bean的生命周期</h1><p>BV1L14y1S7cf的笔记</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="五步骤版本"><a href="#五步骤版本" class="headerlink" title="五步骤版本"></a>五步骤版本</h3><ol><li>实例化：创建对象</li><li>依赖注入：给成员变量赋值</li><li>初始化：执行自定义的初始化方法</li><li>使用</li><li>销毁</li></ol><p><strong>例子</strong></p><p>Dog类，有成员变量name，自定义的初始化和销毁方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;1. 实例化&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;2. 依赖注入&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myInit</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;3. 初始化&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myDestroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;5. 销毁bean&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过配置文件将Dog类交给Spring管理，并指定初始化和销毁方法，还有给成员变量赋值</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xw.bean.Dog&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;myInit&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;myDestroy&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;旺财&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;spring.xml&quot;</span>);<br>        <span class="hljs-type">Dog</span> <span class="hljs-variable">dog</span> <span class="hljs-operator">=</span> applicationContext.getBean(Dog.class);<br>        System.out.println(<span class="hljs-string">&quot;4.使用bean&quot;</span>);<br>        applicationContext.close();<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 打印</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    1. 实例化</span><br><span class="hljs-comment">    2. 依赖注入</span><br><span class="hljs-comment">    3. 初始化</span><br><span class="hljs-comment">    4.使用bean</span><br><span class="hljs-comment">    5. 销毁bean</span><br><span class="hljs-comment">    旺财</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="七步骤版本"><a href="#七步骤版本" class="headerlink" title="七步骤版本"></a>七步骤版本</h3><ol><li><p>实例化：创建对象</p></li><li><p>依赖注入：给成员变量赋值</p><p><font color='red'>初始化前执行 BeanPostProcessor before方法</font></p></li><li><p>初始化：执行自定义的初始化方法</p><p><font color='red'>初始化前执行 BeanPostProcessor after方法</font></p></li><li><p>使用</p></li><li><p>销毁</p></li></ol><p><strong>例子</strong></p><p>创建自定义的Bean后置处理器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Dog &amp;&amp; <span class="hljs-string">&quot;dog&quot;</span>.equals(beanName))<br>            System.out.println(<span class="hljs-string">&quot;    执行后置处理器的before方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> BeanPostProcessor.<span class="hljs-built_in">super</span>.postProcessBeforeInitialization(bean, beanName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Dog &amp;&amp; <span class="hljs-string">&quot;dog&quot;</span>.equals(beanName))<br>            System.out.println(<span class="hljs-string">&quot;    执行后置处理器的after方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> BeanPostProcessor.<span class="hljs-built_in">super</span>.postProcessAfterInitialization(bean, beanName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>交给Spring管理</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dog&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xw.bean.Dog&quot;</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;myInit&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;myDestroy&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;旺财&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;myBeanPostProcessor&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xw.bean.MyBeanPostProcessor&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 打印</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    1. 实例化</span><br><span class="hljs-comment">    2. 依赖注入</span><br><span class="hljs-comment">        执行后置处理器的before方法</span><br><span class="hljs-comment">    3. 初始化</span><br><span class="hljs-comment">        执行后置处理器的after方法</span><br><span class="hljs-comment">    4.使用bean</span><br><span class="hljs-comment">    5. 销毁bean</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h3 id="十步骤版本"><a href="#十步骤版本" class="headerlink" title="十步骤版本"></a>十步骤版本</h3><ol><li><p>实例化：创建对象</p></li><li><p>依赖注入：给成员变量赋值</p><p><font color='blue'>执行回调函数…Aware</font></p><p><font color='red'>初始化前执行 BeanPostProcessor before方法</font></p><p><font color='blue'>执行正在初始化bean函数</font></p></li><li><p>初始化：执行自定义的初始化方法</p><p><font color='red'>初始化前执行 BeanPostProcessor after方法</font></p></li><li><p>使用</p><p><font color='blue'>执行销毁bean方法</font></p></li><li><p>销毁</p></li></ol><p><strong>例子</strong></p><p>实现BeanNameAware, InitializingBean, DisposableBean接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanNameAware</span>, InitializingBean, DisposableBean &#123;<br><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;1. 实例化&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;2. 依赖注入&quot;</span>);<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myInit</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;3. 初始化&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myDestroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;5. 销毁bean&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;    执行回调函数&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;    执行正在初始化bean函数&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;    执行销毁bean方法&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 打印</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">1. 实例化</span><br><span class="hljs-comment">2. 依赖注入</span><br><span class="hljs-comment">    执行回调函数</span><br><span class="hljs-comment">    执行后置处理器的before方法</span><br><span class="hljs-comment">    执行正在初始化bean函数</span><br><span class="hljs-comment">3. 初始化</span><br><span class="hljs-comment">    执行后置处理器的after方法</span><br><span class="hljs-comment">4.使用bean</span><br><span class="hljs-comment">    执行销毁bean方法</span><br><span class="hljs-comment">5. 销毁bean</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">进程已结束，退出代码为 0</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h2 id="InitializingBean作用"><a href="#InitializingBean作用" class="headerlink" title="InitializingBean作用"></a>InitializingBean作用</h2><p>InitializingBean的afterPropertiesSet()是在依赖注入完、执行完回调、执行完后处理器的before后调用的。这个时候成员变量已经实例化完，可以通过afterPropertiesSet()方法来给变量进行一些初始化操作</p><p>如：</p><ol><li>数据库连接池的初始化<br>在连接池的初始化过程中，可以通过实现InitializingBean接口，在Bean初始化完成后自动调用afterPropertiesSet()方法，进行连接池的初始化工作。</li><li>配置文件加载<br>在Spring中，可以通过实现InitializingBean接口，使用afterPropertiesSet()方法，在Bean属性设置完成后，进行配置文件的加载工作，从而减少了代码量和配置文件的加载时间。</li><li>线程池初始化<br>在Java中创建线程池时，可以通过实现InitializingBean接口，使用afterPropertiesSet()方法，在Bean属性设置完成后，进行线程池的初始化工作。</li><li>数据初始化<br>在某些场景下，需要在Bean初始化完成后，进行数据初始化的操作。可以通过实现InitializingBean接口，在Bean属性设置完成后，使用afterPropertiesSet()方法，进行相关数据的初始化工作。</li></ol><h2 id="BeanPostProcessor作用"><a href="#BeanPostProcessor作用" class="headerlink" title="BeanPostProcessor作用"></a>BeanPostProcessor作用</h2><p>BeanPostProcessor是Spring IoC容器提供的一个扩展接口，主要作用是在Spring IoC容器实例化Bean对象后，对其进行加工和装饰，添加功能</p><p>如：</p><ol><li>AOP代理<br>通过before或after方法，在Bean对象装配之后，对Bean对象进行AOP代理，从而在不修改原有代码的情况下，实现对Bean对象的增强或切面操作，如事务管理、权限控制、日志记录、性能监控等。</li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringSecurity</title>
    <link href="/2023/06/06/spring/SpringSecurity/"/>
    <url>/2023/06/06/spring/SpringSecurity/</url>
    
    <content type="html"><![CDATA[<h2 id="SpringSecurity"><a href="#SpringSecurity" class="headerlink" title="SpringSecurity"></a>SpringSecurity</h2><p>SpringSecurity是一个强大的可高度定制的认证和授权框架，对于Spring应用来说它是一套Web安全标准</p><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p><img src="/img/spring_img/%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B.png" alt="认证流程"> </p><p><img src="/img/spring_img/%E9%89%B4%E6%9D%83%E6%B5%81%E7%A8%8B.png" alt="鉴权流程"></p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>实例</p><p>详细见 –&gt; <a href="https://github.com/Xwww12/mall-learning.git%E7%9A%84%60%E6%95%B4%E5%90%88SpringSecurity%60%E7%9A%84tag">https://github.com/Xwww12/mall-learning.git的`整合SpringSecurity`的tag</a></p><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--SpringSecurity--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--JWT--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写SpringSecurity配置类</p><blockquote><p>主要配置：需要鉴权的访问路径、获取用户信息方式、密码认证方式、认证token方式、自定义未授权和未登录结果的返回</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableWebSecurity</span><br><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Lazy</span>   <span class="hljs-comment">// 防止嵌套</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IUmsAdminService adminService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestfulAccessDeniedHandler restfulAccessDeniedHandler;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RestAuthenticationEntryPoint restAuthenticationEntryPoint;<br><br>    <span class="hljs-comment">// 用于配置需要拦截的url路径、jwt过滤器及出异常后的处理器</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        httpSecurity.csrf()<br>            .disable()<br>            .sessionManagement()<span class="hljs-comment">// 基于token，所以不需要session</span><br>            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br>            .and()<br>            .authorizeRequests()<br>            .antMatchers(HttpMethod.GET, <span class="hljs-comment">// 允许对于网站静态资源的无授权访问</span><br>                         <span class="hljs-string">&quot;/&quot;</span>,<br>                         <span class="hljs-string">&quot;/*.html&quot;</span>,<br>                         <span class="hljs-string">&quot;/favicon.ico&quot;</span>,<br>                         <span class="hljs-string">&quot;/**/*.html&quot;</span>,<br>                         <span class="hljs-string">&quot;/**/*.css&quot;</span>,<br>                         <span class="hljs-string">&quot;/**/*.js&quot;</span>,<br>                         <span class="hljs-string">&quot;/swagger-resources/**&quot;</span>,<br>                         <span class="hljs-string">&quot;/v2/api-docs/**&quot;</span><br>                        )<br>            .permitAll()<br>            .antMatchers(<span class="hljs-string">&quot;/admin/login&quot;</span>, <span class="hljs-string">&quot;/admin/register&quot;</span>)<span class="hljs-comment">// 对登录注册要允许匿名访问</span><br>            .permitAll()<br>            .antMatchers(HttpMethod.OPTIONS)<span class="hljs-comment">//跨域请求会先进行一次options请求</span><br>            .permitAll()<br>            <span class="hljs-comment">//                .antMatchers(&quot;/**&quot;)//测试时全部运行访问</span><br>            <span class="hljs-comment">//                .permitAll()</span><br>            .anyRequest()<span class="hljs-comment">// 除上面外的所有请求全部需要鉴权认证</span><br>            .authenticated();<br>        <span class="hljs-comment">// 禁用缓存</span><br>        httpSecurity.headers().cacheControl();<br>        <span class="hljs-comment">// 添加JWT filter</span><br>        httpSecurity.addFilterBefore(jwtAuthenticationTokenFilter(), UsernamePasswordAuthenticationFilter.class);<br>        <span class="hljs-comment">//添加自定义未授权和未登录结果返回</span><br>        httpSecurity.exceptionHandling()<br>            .accessDeniedHandler(restfulAccessDeniedHandler)<br>            .authenticationEntryPoint(restAuthenticationEntryPoint);<br>    &#125;<br><br>    <span class="hljs-comment">// 用于配置UserDetailsService及PasswordEncoder</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        auth.userDetailsService(userDetailsService())<br>            .passwordEncoder(passwordEncoder());<br>    &#125;<br><br>    <span class="hljs-comment">// SpringSecurity定义的用于对密码进行编码及比对的接口</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 用于根据用户名获取用户信息</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//获取登录用户信息</span><br>        <span class="hljs-keyword">return</span> username -&gt; &#123;<br>            <span class="hljs-type">UmsAdmin</span> <span class="hljs-variable">admin</span> <span class="hljs-operator">=</span> adminService.getAdminByUsername(username);<br>            <span class="hljs-keyword">if</span> (admin != <span class="hljs-literal">null</span>) &#123;<br>                List&lt;UmsPermission&gt; permissionList = adminService.getPermissionList(admin.getId());<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdminUserDetails</span>(admin,permissionList);<br>            &#125;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernameNotFoundException</span>(<span class="hljs-string">&quot;用户名或密码错误&quot;</span>);<br>        &#125;;<br>    &#125;<br><br>    <span class="hljs-comment">// 在用户名和密码校验前添加的过滤器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> JwtAuthenticationTokenFilter <span class="hljs-title function_">jwtAuthenticationTokenFilter</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationTokenFilter</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 当访问接口没有权限时，自定义的返回结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestfulAccessDeniedHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccessDeniedHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setContentType(<span class="hljs-string">&quot;application/json&quot;</span>);<br>        response.getWriter().println(JSONUtil.parse(CommonResult.forbidden(e.getMessage())));<br>        response.getWriter().flush();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 当未登录或者token失效访问接口时，自定义的返回结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestAuthenticationEntryPoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationEntryPoint</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        response.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setContentType(<span class="hljs-string">&quot;application/json&quot;</span>);<br>        response.getWriter().println(JSONUtil.parse(CommonResult.unauthorized(authException.getMessage())));<br>        response.getWriter().flush();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>自定义的用户信息类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminUserDetails</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br>    <span class="hljs-keyword">private</span> UmsAdmin umsAdmin;<br>    <span class="hljs-keyword">private</span> List&lt;UmsPermission&gt; permissionList;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AdminUserDetails</span><span class="hljs-params">(UmsAdmin umsAdmin, List&lt;UmsPermission&gt; permissionList)</span> &#123;<br>        <span class="hljs-built_in">this</span>.umsAdmin = umsAdmin;<br>        <span class="hljs-built_in">this</span>.permissionList = permissionList;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        <span class="hljs-comment">// 获取当前用户权限</span><br>        <span class="hljs-keyword">return</span> permissionList.stream()<br>            .filter(permissionList -&gt; permissionList.getValue() != <span class="hljs-literal">null</span>)<br>            .map(permission -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleGrantedAuthority</span>(permission.getValue()))<br>            .collect(Collectors.toList());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> umsAdmin.getPassword();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> umsAdmin.getUsername();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> umsAdmin.getStatus().equals(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>验证token</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationTokenFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOGGER</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(JwtAuthenticationTokenFilter.class);<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> JwtTokenUtil jwtTokenUtil;<br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.tokenHeader&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String tokenHeader;<span class="hljs-comment">// Authorization</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.tokenHead&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String tokenHead;<span class="hljs-comment">// Bearer</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request,</span><br><span class="hljs-params">                                    HttpServletResponse response,</span><br><span class="hljs-params">                                    FilterChain chain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">authHeader</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-built_in">this</span>.tokenHeader);<br>        <span class="hljs-keyword">if</span> (authHeader != <span class="hljs-literal">null</span> &amp;&amp; authHeader.startsWith(<span class="hljs-built_in">this</span>.tokenHead)) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">authToken</span> <span class="hljs-operator">=</span> authHeader.substring(<span class="hljs-built_in">this</span>.tokenHead.length());<span class="hljs-comment">// The part after &quot;Bearer &quot;</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> jwtTokenUtil.getUserNameFromToken(authToken);<br>            LOGGER.info(<span class="hljs-string">&quot;checking username:&#123;&#125;&quot;</span>, username);<br>            <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-type">UserDetails</span> <span class="hljs-variable">userDetails</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userDetailsService.loadUserByUsername(username);<br>                <span class="hljs-keyword">if</span> (jwtTokenUtil.validateToken(authToken, userDetails)) &#123;<br>                    <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(userDetails, <span class="hljs-literal">null</span>, userDetails.getAuthorities());<br>                    authentication.setDetails(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebAuthenticationDetailsSource</span>().buildDetails(request));<br>                    LOGGER.info(<span class="hljs-string">&quot;authenticated user:&#123;&#125;&quot;</span>, username);<br>                    SecurityContextHolder.getContext().setAuthentication(authentication);<br>                &#125;<br>            &#125;<br>        &#125;<br>        chain.doFilter(request, response);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在需要鉴权的方法上添加</span><br><span class="hljs-meta">@PreAuthorize(&quot;hasAuthority(&#x27;pms:brand:read&#x27;)&quot;)</span><br></code></pre></td></tr></table></figure></li><li><p>注意</p><blockquote><p>如果使用了swagger<br>在配置Docket时<br>securitySchemes要传入需要登录认证的路径，否则不会主动带上头信息</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> List&lt;SecurityContext&gt; <span class="hljs-title function_">securityContexts</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//设置需要登录认证的路径</span><br>    List&lt;SecurityContext&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    result.add(getContextByPath(<span class="hljs-string">&quot;/brand/.*&quot;</span>));<br>    result.add(getContextByPath(<span class="hljs-string">&quot;/admin/.*&quot;</span>));<br>    result.add(getContextByPath(<span class="hljs-string">&quot;/esProduct/.*&quot;</span>));<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>场景：前端传来用户名和密码，后台认证后返回token并把用户信息存到redis中</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;userName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xw&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1234&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI3YTgzYmM3NGNjOTQ0ZDgxOTExZjQ3YTgxMGYyMTk2MiIsInN1YiI6IjEiLCJpc3MiOiJ4dyIsImlhdCI6MTY3ODk1NDk2NiwiZXhwIjoxNjc5MDQxMzY2fQ.OqHhpCJBQX_L5pMTWexnm23DJ69tIPMyETSNMAji0b8&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;userInfoVo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;avatar&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fi0.hdslb.com%2Fbfs%2Farticle%2F3bf9c263bc0f2ac5c3a7feb9e218d07475573ec8.gi&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;23412332@qq.com&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;nickName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;xw123&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;sex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;操作成功&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><h5 id="流程-1"><a href="#流程-1" class="headerlink" title="流程"></a>流程</h5><p><img src="/img/spring_img/%E5%A4%A7%E8%87%B4%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B.png"> </p><h5 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h5><p>User，映射数据库表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@TableName(&quot;sys_user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//主键</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-comment">//用户名</span><br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-comment">//昵称</span><br>    <span class="hljs-keyword">private</span> String nickName;<br>    <span class="hljs-comment">//密码</span><br>    <span class="hljs-keyword">private</span> String password;<br>    <span class="hljs-comment">//用户类型：0代表普通用户，1代表管理员</span><br>    <span class="hljs-keyword">private</span> String type;<br>    <span class="hljs-comment">//账号状态（0正常 1停用）</span><br>    <span class="hljs-keyword">private</span> String status;<br>    <span class="hljs-comment">//邮箱</span><br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-comment">//手机号</span><br>    <span class="hljs-keyword">private</span> String phonenumber;<br>    <span class="hljs-comment">//用户性别（0男，1女，2未知）</span><br>    <span class="hljs-keyword">private</span> String sex;<br>    <span class="hljs-comment">//头像</span><br>    <span class="hljs-keyword">private</span> String avatar;<br>    <span class="hljs-comment">//创建人的用户id</span><br>    <span class="hljs-keyword">private</span> Long createBy;<br>    <span class="hljs-comment">//创建时间</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br>    <span class="hljs-comment">//更新人</span><br>    <span class="hljs-keyword">private</span> Long updateBy;<br>    <span class="hljs-comment">//更新时间</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<br>    <span class="hljs-comment">//删除标志（0代表未删除，1代表已删除）</span><br>    <span class="hljs-keyword">private</span> Integer delFlag;<br>&#125;<br></code></pre></td></tr></table></figure><p>实现UserDetails</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginUser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetails</span> &#123;<br><br>    <span class="hljs-keyword">private</span> User user;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> user.getPassword();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> user.getUserName();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BlogUserLoginVo，返回前端的Vo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogUserLoginVo</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String token;<br><br>    <span class="hljs-keyword">private</span> UserInfoVo userInfoVo;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Accessors(chain = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfoVo</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Long id;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 昵称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String nickName;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 头像</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String avatar;<br><br>    <span class="hljs-keyword">private</span> String sex;<br><br>    <span class="hljs-keyword">private</span> String email;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="实现UserDetailsService"><a href="#实现UserDetailsService" class="headerlink" title="实现UserDetailsService"></a>实现UserDetailsService</h5><p>用于查询用户信息，返回UserDetails，被AuthenticationManager所调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取用户身份信息的方法，替换默认的SpringSecurity的获取身份信息方式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 根据用户名查询用户信息</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;User&gt;()<br>                                         .eq(User::getUserName, username));<br>        <span class="hljs-keyword">if</span> (Objects.isNull(user)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号或密码错误&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// TODO 查询用户权限信息</span><br><br>        <span class="hljs-comment">// 返回用户信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginUser</span>(user);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="SpringSecurity配置类"><a href="#SpringSecurity配置类" class="headerlink" title="SpringSecurity配置类"></a>SpringSecurity配置类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebSecurityConfigurerAdapter</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        http<br>            <span class="hljs-comment">// 关闭csrf防范</span><br>            .csrf().disable()<br>            <span class="hljs-comment">// 不通过Session获取SecurityContext</span><br>            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br>            .and()<br>            .authorizeRequests()<br>            <span class="hljs-comment">// 允许匿名访问的接口</span><br>            .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).anonymous()<br>            .anyRequest().permitAll();<br>        http.logout().disable();<br>        <span class="hljs-comment">// 允许跨域</span><br>        http.cors();<br>    &#125;<br><br>    <span class="hljs-comment">// 密码编码器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();<br>    &#125;<br><br>    <span class="hljs-comment">// 注入身份认证器</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title function_">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.authenticationManagerBean();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Service层"><a href="#Service层" class="headerlink" title="Service层"></a>Service层</h5><p>通过身份认证器进行身份验证</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogLoginServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlogLoginService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisCache redisCache;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-comment">// 创建用于用户身份认证的token</span><br>        <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(user.getUserName(), user.getPassword());<br>        <span class="hljs-comment">// 调用Manager的身份认证方法实现认证</span><br>        <span class="hljs-type">Authentication</span> <span class="hljs-variable">authenticate</span> <span class="hljs-operator">=</span> authenticationManager.authenticate(authenticationToken);<br>        <span class="hljs-keyword">if</span> (Objects.isNull(authenticate)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;用户名或密码异常&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">// 通过用户id生成jwt</span><br>        <span class="hljs-type">LoginUser</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> (LoginUser) authenticate.getPrincipal();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> String.valueOf(loginUser.getUser().getId());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jwt</span> <span class="hljs-operator">=</span> JwtUtil.createJWT(id);<br>        <span class="hljs-comment">// 存入redis</span><br>        redisCache.setCacheObject(RedisConstants.CACHE_LOGIN_PREFIX + id, loginUser, RedisConstants.CACHE_TTL, TimeUnit.SECONDS);<br><br>        <span class="hljs-comment">// 返回vo</span><br>        <span class="hljs-type">UserInfoVo</span> <span class="hljs-variable">userInfoVo</span> <span class="hljs-operator">=</span> BeanCopyUtils.copyBean(loginUser.getUser(), UserInfoVo.class);<br>        <span class="hljs-type">BlogUserLoginVo</span> <span class="hljs-variable">blogUserLoginVo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlogUserLoginVo</span>(jwt, userInfoVo);<br>        <span class="hljs-keyword">return</span> ResponseResult.okResult(blogUserLoginVo);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Controller层"><a href="#Controller层" class="headerlink" title="Controller层"></a>Controller层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogLoginController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> BlogLoginService blogLoginService;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> blogLoginService.login(user);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h4><p>每次发送请求时都会在响应头中带上<code>token</code>，通过解析token来比对redis中缓存的登录信息来认证</p><h5 id="认证过滤器"><a href="#认证过滤器" class="headerlink" title="认证过滤器"></a>认证过滤器</h5><p>工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 向前端返回json数据</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebUtils</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将字符串渲染到客户端</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> response 渲染对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> string   待渲染的字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> null</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renderString</span><span class="hljs-params">(HttpServletResponse response, String string)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            response.setStatus(<span class="hljs-number">200</span>);<br>            response.setContentType(<span class="hljs-string">&quot;application/json&quot;</span>);<br>            response.setCharacterEncoding(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>            response.getWriter().print(string);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDownLoadHeader</span><span class="hljs-params">(String filename, ServletContext context, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">mimeType</span> <span class="hljs-operator">=</span> context.getMimeType(filename);<span class="hljs-comment">//获取文件的mime类型</span><br>        response.setHeader(<span class="hljs-string">&quot;content-type&quot;</span>, mimeType);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fname</span> <span class="hljs-operator">=</span> URLEncoder.encode(filename, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        response.setHeader(<span class="hljs-string">&quot;Content-disposition&quot;</span>, <span class="hljs-string">&quot;attachment; filename=&quot;</span> + fname);<br><br><span class="hljs-comment">//        response.setContentType(&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;);</span><br><span class="hljs-comment">//        response.setCharacterEncoding(&quot;utf-8&quot;);</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>解析token</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 认证过滤器</span><br><span class="hljs-comment"> * 将用户信息保存到SecurityContextHolder</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationTokenFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OncePerRequestFilter</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisCache redisCache;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            userId = getUserIdFromRequest(request, response, filterChain);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-comment">// token已过期或非法</span><br>            log.info(e.getMessage());<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (userId != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 查询redis中是否有对应用户信息</span><br>            <span class="hljs-type">LoginUser</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> redisCache.getCacheObject(RedisConstants.CACHE_LOGIN_PREFIX + userId);<br>            <span class="hljs-keyword">if</span> (Objects.isNull(loginUser)) &#123;<br>                <span class="hljs-comment">// redis中过期</span><br>                <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>                WebUtils.renderString(response, JSON.toJSONString(result));<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-comment">// 存入SecurityContextHolder</span><br>            <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authenticationToken</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>            SecurityContextHolder.getContext().setAuthentication(authenticationToken);<br>        &#125;<br>        filterChain.doFilter(request, response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getUserIdFromRequest</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-comment">// 获取请求头中的token</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;token&quot;</span>);<br>        <span class="hljs-keyword">if</span> (!StringUtils.hasText(token)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 解析出用户id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtil.parseJWT(token);<br>            userId = claims.getSubject();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN);<br>            WebUtils.renderString(response, JSON.toJSONString(result));<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;token非法或已过期&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> userId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="添加过滤器"><a href="#添加过滤器" class="headerlink" title="添加过滤器"></a>添加过滤器</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// SpringSecurity配置类中注入过滤器</span><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> JwtAuthenticationTokenFilter authenticationTokenFilter;<br><br><span class="hljs-comment">// configure方法中添加过滤器到用户名密码认证前</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http<br>        <span class="hljs-comment">// 关闭csrf防范</span><br>        .csrf().disable()<br>        <span class="hljs-comment">// 不通过Session获取SecurityContext</span><br>        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br>        .and()<br>        .authorizeRequests()<br>        <span class="hljs-comment">// 允许匿名访问的接口</span><br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).anonymous()<br>        .antMatchers(<span class="hljs-string">&quot;/link/getAllLink&quot;</span>).authenticated()<br>        <span class="hljs-comment">// 接口都无需鉴权</span><br>        .anyRequest().permitAll();<br>    http.logout().disable();<br>    <span class="hljs-comment">// 添加对jwt解析的过滤器</span><br>    http.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);<br>    <span class="hljs-comment">// 允许跨域</span><br>    http.cors();<br>&#125;<br></code></pre></td></tr></table></figure><p>自定义返回结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义认证失败返回结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationEntryPointImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AuthenticationEntryPoint</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        log.warn(e.getMessage());<br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> BadCredentialsException) &#123;<br>            result = ResponseResult.errorResult(AppHttpCodeEnum.LOGIN_ERROR.getCode(), e.getMessage());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> InsufficientAuthenticationException) &#123;<br>            result = ResponseResult.errorResult(AppHttpCodeEnum.NEED_LOGIN.getCode(), e.getMessage());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            result = ResponseResult.errorResult(AppHttpCodeEnum.SYSTEM_ERROR.getCode(), <span class="hljs-string">&quot;未知错误&quot;</span>);<br>        &#125;<br>        WebUtils.renderString(response, JSON.toJSONString(result));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义鉴权失败返回结果</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccessDeniedHandlerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccessDeniedHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        log.warn(e.getMessage());<br>        <span class="hljs-type">ResponseResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ResponseResult.errorResult(AppHttpCodeEnum.NO_OPERATOR_AUTH);<br>        WebUtils.renderString(response, JSON.toJSONString(result));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>添加到配置类中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 自定义认证异常处理器</span><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> AuthenticationEntryPointImpl authenticationEntryPoint;<br><br><span class="hljs-comment">// 自定义鉴权异常处理器</span><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> AccessDeniedHandlerImpl accessDeniedHandler;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    http<br>        <span class="hljs-comment">// 关闭csrf防范</span><br>        .csrf().disable()<br>        <span class="hljs-comment">// 不通过Session获取SecurityContext</span><br>        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)<br>        .and()<br>        .authorizeRequests()<br>        <span class="hljs-comment">// 允许匿名访问的接口</span><br>        .antMatchers(<span class="hljs-string">&quot;/login&quot;</span>).anonymous()<br>        .antMatchers(<span class="hljs-string">&quot;/link/getAllLink&quot;</span>).authenticated()<br>        <span class="hljs-comment">// 接口都无需鉴权</span><br>        .anyRequest().permitAll();<br>    <span class="hljs-comment">//配置异常处理器</span><br>    http.exceptionHandling()<br>        .authenticationEntryPoint(authenticationEntryPoint)<br>        .accessDeniedHandler(accessDeniedHandler);<br><br>    http.logout().disable();<br>    <span class="hljs-comment">// 添加对jwt的过滤器</span><br>    http.addFilterBefore(authenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);<br>    <span class="hljs-comment">// 允许跨域</span><br>    http.cors();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="全局异常处理"><a href="#全局异常处理" class="headerlink" title="全局异常处理"></a>全局异常处理</h4><blockquote><p>这里跟SpringSecurity无关</p></blockquote><p>自定义异常</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义异常</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br><br>    <span class="hljs-keyword">private</span> String msg;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> code;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMsg</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> msg;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SystemException</span><span class="hljs-params">(AppHttpCodeEnum httpCodeEnum)</span> &#123;<br>        <span class="hljs-built_in">super</span>(httpCodeEnum.getMsg());<br>        <span class="hljs-built_in">this</span>.code = httpCodeEnum.getCode();<br>        <span class="hljs-built_in">this</span>.msg = httpCodeEnum.getMsg();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>全局异常处理器</p><p>对Controller的增强</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 全局异常处理器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalException</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理自定义异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExceptionHandler(SystemException.class)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">systemExceptionHandler</span><span class="hljs-params">(SystemException e)</span> &#123;<br>          log.error(<span class="hljs-string">&quot;出现了异常：&#123;&#125;&quot;</span>, e.getMsg());<br>          <span class="hljs-keyword">return</span> ResponseResult.errorResult(e.getCode(), e.getMsg());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理其他异常</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br>    <span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">exceptionHandler</span><span class="hljs-params">(Exception e)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;出现了异常：&#123;&#125;&quot;</span>, e.getMessage());<br>        <span class="hljs-keyword">return</span> ResponseResult.errorResult(AppHttpCodeEnum.SYSTEM_ERROR);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="登出"><a href="#登出" class="headerlink" title="登出"></a>登出</h4><p>根据token删除redis中的登录信息</p><h5 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 需要配置logout接口需要认证</span><br>http.antMatchers(<span class="hljs-string">&quot;/logout&quot;</span>).authenticated()<br><span class="hljs-comment">// 关闭默认logout功能</span><br>http.logout().disable();<br></code></pre></td></tr></table></figure><h5 id="Service层-1"><a href="#Service层-1" class="headerlink" title="Service层"></a>Service层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">logout</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Authentication</span> <span class="hljs-variable">authentication</span> <span class="hljs-operator">=</span> SecurityContextHolder.getContext().getAuthentication();<br>    <span class="hljs-type">LoginUser</span> <span class="hljs-variable">loginUser</span> <span class="hljs-operator">=</span> (LoginUser) authentication.getPrincipal();<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> loginUser.getUser().getId();<br><br>    redisCache.deleteObject(RedisConstants.CACHE_LOGIN_PREFIX + userId);<br>    <span class="hljs-keyword">return</span> ResponseResult.okResult();<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Controller层-1"><a href="#Controller层-1" class="headerlink" title="Controller层"></a>Controller层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/logout&quot;)</span><br><span class="hljs-keyword">public</span> ResponseResult <span class="hljs-title function_">logout</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> blogLoginService.logout();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="鉴权"><a href="#鉴权" class="headerlink" title="鉴权"></a>鉴权</h4><h5 id="开启"><a href="#开启" class="headerlink" title="开启"></a>开启</h5><p>在启动类上添加注解，开启先&#x2F;后鉴权的注解。开启后可以使用<code>@PreAuthorize()</code>和<code>@PostAuthorize()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableGlobalMethodSecurity(prePostEnabled = true)</span><br></code></pre></td></tr></table></figure><h5 id="查询权限"><a href="#查询权限" class="headerlink" title="查询权限"></a>查询权限</h5><p>在获取时将用户信息和权限包装成UserDetail一起返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 获取用户身份信息的方法，替换默认的SpringSecurity的获取身份信息方式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserDetailsService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> MenuService menuService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException &#123;<br>        <span class="hljs-comment">// 根据用户名查询用户信息</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectOne(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;User&gt;()<br>                                         .eq(User::getUserName, username));<br>        <span class="hljs-keyword">if</span> (Objects.isNull(user)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;账号或密码错误&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 查询用户权限信息</span><br>        List&lt;String&gt; permissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();;<br>        <span class="hljs-keyword">if</span> (user.getType().equals(SystemConstants.ADMIN)) &#123;<br>            <span class="hljs-comment">// 只有后台管理员需要鉴权</span><br>            permissions = menuService.selectPermsByUserId(user.getId());<br>        &#125;<br>        <span class="hljs-comment">// 返回用户信息</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginUser</span>(user, permissions);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="鉴权-1"><a href="#鉴权-1" class="headerlink" title="鉴权"></a>鉴权</h5><p>编写鉴权逻辑，并作为Service注入Bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service(&quot;ps&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断用户是否具有权限</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> permission</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasPermission</span><span class="hljs-params">(String permission)</span> &#123;<br>        <span class="hljs-comment">// 超级管理员</span><br>        <span class="hljs-keyword">if</span> (SecurityUtils.isAdmin()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        List&lt;String&gt; permissions = SecurityUtils.getLoginUser().getPermissions();<br>        <span class="hljs-keyword">return</span> permissions.contains(permission);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h5><p>在需要鉴权的接口上添加注解，<code>@ps.hasPermission()</code>为自定义的鉴权方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize(&quot;@ps.hasPermission(&#x27;contet:category:export&#x27;)&quot;)</span><br><span class="hljs-meta">@GetMapping(&quot;/export&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">export</span><span class="hljs-params">(HttpServletResponse response)</span> &#123;<br>        ...<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java线程</title>
    <link href="/2023/06/05/java/java%E7%BA%BF%E7%A8%8B/"/>
    <url>/2023/06/05/java/java%E7%BA%BF%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="java线程"><a href="#java线程" class="headerlink" title="java线程"></a>java线程</h1><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="/img/java_img/%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png"></p><p>New：线程正在创建</p><p>Runnable：线程可以运行（可能在等待时间片或正在运行）</p><p>Blocking：线程等待获取锁</p><p>Waiting：当前线程等待其他线程唤醒</p><p>Timed Waiting：当前线程等待一段时间后会自动醒来</p><p>Terminated：线程执行完毕或出现异常</p><h2 id="线程接口"><a href="#线程接口" class="headerlink" title="线程接口"></a>线程接口</h2><p>java中有三种线程的接口&#x2F;类：</p><ul><li>Thread类</li><li>Runnable接口</li><li>Callable接口</li></ul><p><strong>使用</strong></p><p>Thread</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 直接创建线程</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;线程执行&quot;</span>);<br>        &#125;);<br>        thread.start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MainApplication</span> <span class="hljs-variable">mainApplication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>();<br>        mainApplication.start();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 通过继承Thread来使用</span><br>        System.out.println(<span class="hljs-string">&quot;线程执行&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Runnable</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 实现Runnable接口</span><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>());<br>        thread.start();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;线程执行&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Callable</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Callable</span>&lt;Integer&gt; &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-comment">// 实现Callable接口，这种线程任务可以有返回值</span><br>        FutureTask&lt;Integer&gt; futureTask = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>());<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(futureTask);<br>        thread.start();<br>        System.out.println(futureTask.get());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;线程执行&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><p>静态方法</p><table><thead><tr><th align="center">方法</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">Thread.sleep()</td><td align="center">休眠当前正在执行的线程</td></tr><tr><td align="center">Thread.yield()</td><td align="center">当前线程建议让出cpu，由调度器决定是否让出</td></tr><tr><td align="center"></td><td align="center"></td></tr></tbody></table><p>实例方法</p><table><thead><tr><th align="center">方法</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">thread.setDaemon()</td><td align="center">true为设置线程为守护线程</td></tr><tr><td align="center">thread.interrupt()</td><td align="center">中断在休眠中的线程，会抛出异常；在运行的线程则会设置标记，由线程自己决定是否中断</td></tr><tr><td align="center">thread.interrupted()</td><td align="center">获取中断标记</td></tr><tr><td align="center">thread.join()</td><td align="center">调用线程等待被调用线程执行完才会继续执行</td></tr><tr><td align="center">object.wait()</td><td align="center">挂起线程，会释放锁，只能在同步代码块里调用</td></tr><tr><td align="center">object.notify()</td><td align="center">随机唤醒线程，只能在同步代码块里调用</td></tr></tbody></table><p>interrupt</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MainApplication</span> <span class="hljs-variable">mainApplication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>();<br>        mainApplication.start();<br>        mainApplication.interrupt();<span class="hljs-comment">// 中断线程</span><br>        System.out.println(<span class="hljs-string">&quot;Main run&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>            System.out.println(<span class="hljs-string">&quot;Thread run&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 控制台打印</span><br><span class="hljs-comment">// Main run</span><br></code></pre></td></tr></table></figure><p>interrupted</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">MainApplication</span> <span class="hljs-variable">mainApplication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>();<br>        mainApplication.start();<br>        mainApplication.interrupt();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        System.out.println(<span class="hljs-string">&quot;Main run&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (!interrupted()) &#123;<br><br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;Thread run&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 控制台打印</span><br><span class="hljs-comment">// Thread run</span><br><span class="hljs-comment">// Main run</span><br></code></pre></td></tr></table></figure><h2 id="线程互斥-x2F-协作"><a href="#线程互斥-x2F-协作" class="headerlink" title="线程互斥&#x2F;协作"></a>线程互斥&#x2F;协作</h2><p>互斥方式</p><ul><li>synchronized</li><li>Lock</li></ul><p>协作方式</p><ul><li>join()</li><li>wait()、notify() &#x2F; notifyAll()</li><li>await()、single() &#x2F; singleAll()：在Condition上使用</li></ul><h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><blockquote><p>对线程进行统一分配，调优和监控</p></blockquote><p><img src="/img/java_img/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB.png"></p><h3 id="ThreadPoolExecutor"><a href="#ThreadPoolExecutor" class="headerlink" title="ThreadPoolExecutor"></a>ThreadPoolExecutor</h3><p>​一个线程集合workerSet和一个阻塞队列workQueue。当用户向线程池提交一个任务(也就是线程)时，线程池会先将任务放入workQueue中。workerSet中的线程会不断的从workQueue中获取线程然后执行。当workQueue中没有任务的时候，worker就会阻塞，直到队列中有任务了就取出来继续执行。</p><p><img src="/img/java_img/%E7%BA%BF%E7%A8%8B%E6%B1%A0.png"></p><p>获取线程池状态api</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>threadPoolExecutor.getPoolSize()</td><td>当前线程池中的线程数</td></tr><tr><td>threadPoolExecutor.getCorePoolSize()</td><td>当前线程池中核心线程的数量</td></tr><tr><td>threadPoolExecutor.getActiveCount()</td><td>正在执行任务的线程数</td></tr><tr><td>threadPoolExecutor.getCompletedTaskCount()</td><td>已经完成的任务数</td></tr><tr><td>threadPoolExecutor.getTaskCount()</td><td>线程池中已经提交的任务总数</td></tr><tr><td>threadPoolExecutor.isShutdown()</td><td>线程是否已经调用了<code>shutdown</code>方法</td></tr><tr><td>threadPoolExecutor.isTerminated()</td><td>线程是否已经执行完任务并关闭</td></tr></tbody></table><p>创建线程池的参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,// 核心线程数</span><br><span class="hljs-params">                          <span class="hljs-type">int</span> maximumPoolSize,// 允许的最大线程数=核心+非核心</span><br><span class="hljs-params">                          <span class="hljs-type">long</span> keepAliveTime,// 非核心存活时间</span><br><span class="hljs-params">                          TimeUnit unit,// 存活时间单位</span><br><span class="hljs-params">                          BlockingQueue&lt;Runnable&gt; workQueue,// 任务阻塞队列</span><br><span class="hljs-params">                          RejectedExecutionHandler handler// 拒绝策略</span><br><span class="hljs-params">                         )</span><br></code></pre></td></tr></table></figure><p>任务阻塞队列种类：</p><ul><li><p><code>ArrayBlockingQueue</code>: 基于数组结构的有界阻塞队列，按FIFO排序任</p></li><li><p><code>LinkedBlockingQueue</code>: 基于链表结构的阻塞队列，按FIFO排序任务，吞吐量通常要高于ArrayBlockingQueue；</p></li><li><p><code>SynchronousQueue</code>: 一个不存储元素的阻塞队列，每个插入操作必须等到另一个线程调用移除操作，否则插入操作一直处于阻塞状态，吞吐量通常要高于LinkedBlockingQueue；</p></li><li><p><code>PriorityBlockingQueue</code>: 具有优先级的无界阻塞队列；</p></li></ul><p>拒绝策略种类：</p><ul><li><p><code>AbortPolicy</code>: 直接抛出异常，默认策略；</p></li><li><p><code>CallerRunsPolicy</code>: 用调用者所在的线程来执行任务；</p></li><li><p><code>DiscardOldestPolicy</code>: 丢弃阻塞队列中靠最前的任务，并执行当前任务；</p></li><li><p><code>DiscardPolicy</code>: 直接丢弃任务</p></li></ul><p>线程池状态</p><p>​线程池中通过原子整数<code>ctl</code>的前3位来记录线程池状态，后29位记录当前线程数</p><p><img src="/img/java_img/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81.png"></p><h3 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h3><blockquote><p>Executors把工作单元(Runnable)与执行机制分离开</p></blockquote><p>通过Executors可以创建预设好参数的线程池，如固定大小线程池、只有救急线程的线程池等</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            pool.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>());<br>        &#125;<br>        pool.shutdown();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(Thread.currentThread().getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>api</p><table><thead><tr><th align="center">方法</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">pool.shutdown()</td><td align="center">等所有任务执行完成后关闭线程池</td></tr><tr><td align="center">pool.shutdownNow()</td><td align="center">立即关闭线程池，所有线程执行interrupt()</td></tr><tr><td align="center">pool.submit()</td><td align="center">执行有返回值的任务</td></tr><tr><td align="center">pool.execute()</td><td align="center">执行没有返回值的任务</td></tr></tbody></table><p>为什么不建议使用Executor创建线程？</p><p>​使用了无界队列，任务可以无限提交，会导致内存溢出；<code>newCachedThreadPool</code>如果频繁创建销毁线程会导致大量的系统开销和内存溢出</p><h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><blockquote><p>相当于等待队列</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">Condition</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> lock.newCondition();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">MainApplication</span> <span class="hljs-variable">mainApplication</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainApplication</span>();<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>        pool.execute(() -&gt; mainApplication.before());<br>        pool.execute(() -&gt; mainApplication.after());<br>        pool.shutdown();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> &#123;<br>        lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                condition.await();<span class="hljs-comment">// 在condition上等待</span><br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        System.out.println(<span class="hljs-string">&quot;before&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">()</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            condition.signal();<span class="hljs-comment">// 唤醒condition上等待的线程</span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;after&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 控制台打印</span><br><span class="hljs-comment">// after</span><br><span class="hljs-comment">// before</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>java锁</title>
    <link href="/2023/06/02/java/java%E9%94%81/"/>
    <url>/2023/06/02/java/java%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h1 id="java锁"><a href="#java锁" class="headerlink" title="java锁"></a>java锁</h1><p>文章<a href="https://www.cnblogs.com/lifegoeson/p/13683785.html">java里的锁总结</a>的笔记</p><h2 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h2><p>java中锁分为两种</p><ol><li>一种为<code>synchronized</code>关键字，由jvm实现，是隐性的锁</li><li>另一种为<code>Lock</code>接口及其实现类，是显性的锁，需要手动获取释放</li></ol><h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li>加在静态方法上，锁的是整个类</li><li>加在成员方法上，锁的是<code>this</code></li><li><code>synchronized(对象)&#123;&#125;</code>，锁的是对象</li></ol><h3 id="java对象在内存中的布局"><a href="#java对象在内存中的布局" class="headerlink" title="java对象在内存中的布局"></a>java对象在内存中的布局</h3><ol><li><strong>对象头</strong>：存放对象自身运行时的数据。有Hash码、分代年龄、重量级锁的指针、锁记录的指针等，对象头也叫<code>Mark Word</code></li><li><strong>实例数据</strong>：对象中字段的信息</li><li><strong>对齐填充</strong>：对象起始地址得是<code>8字节的整数倍</code>，需要对齐填充</li></ol><p>其中对象头里的重量级锁的指针指向的是一个<strong>Monitor</strong>对象（管程、监视器），和<code>synchronized</code>的实现有关联</p><h3 id="大致原理"><a href="#大致原理" class="headerlink" title="大致原理"></a>大致原理</h3><ol><li>当<code>synchronized</code>修饰方法</li></ol><p>调用方法时需要线程先拥有<strong>Monitor</strong>管程</p><p><strong>Monitor</strong>只能由一个线程拥有</p><p>当方法执行完后出现异常时会自动释放<strong>Monitor</strong></p><ol start="2"><li>当<code>synchronized</code>用于同步代码块</li></ol><p>通过<code>synchronizedenter</code>和<code>synchronizedexit</code>指令来获取和释放<strong>Monitor</strong></p><h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><p><strong>Monitor</strong>的实现需要依赖操作系统底层，所以<strong>需要进行用户态和内核态的转换</strong>，效率较低</p><h3 id="解决问题的方式"><a href="#解决问题的方式" class="headerlink" title="解决问题的方式"></a>解决问题的方式</h3><blockquote><p>通过添加各种锁来实现同步，而不是一上来就加重量级锁<code>synchronized</code></p></blockquote><p>锁的重量有低到高</p><p><strong>偏向锁 -&gt; 自旋锁 -&gt; 轻量级锁 -&gt; 重量级锁</strong></p><ul><li>偏向锁：对象头的<code>Mark Word</code>为偏向锁结构，锁会偏向于第一次获取它的线程，当每次都是这个线程来获取锁时，不需要其他操作</li><li>轻量级锁：当线程间发生竞争时，<code>Mark Word</code>会变为轻量级锁的结构，通过<strong>CAS</strong>(Compare And Swap)操作获取锁</li><li>重量级锁：即<code>synchronized</code>锁</li></ul><p>线程间竞争锁的激烈程度会导致锁升级，锁只能升级不能降级</p><h3 id="按锁的性质分类"><a href="#按锁的性质分类" class="headerlink" title="按锁的性质分类"></a>按锁的性质分类</h3><ol><li>悲观锁：每次读写操作都加锁</li><li>乐观锁：每次写操作都通过<code>CAS</code>操作来尝试加锁</li><li>公平锁：按照FIFO来获取锁</li><li>非公平锁：抢占式的锁，<code>synchronized</code>属于非公平锁</li><li>独占锁：锁只能被一个线程持有</li><li>共享锁：锁可以被多个线程持有</li></ol><h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><h3 id="Lock接口常见实现类"><a href="#Lock接口常见实现类" class="headerlink" title="Lock接口常见实现类"></a>Lock接口常见实现类</h3><ul><li>ReentrantLock，可重入锁</li><li>ReadLock，读锁</li><li>WriteLock，写锁</li></ul><h3 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h3><p>以ReentrantLock为例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Lock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br>lock.lock();<span class="hljs-comment">// 加锁</span><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 代码..</span><br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    lock.unlock();<span class="hljs-comment">// 释放锁</span><br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>方法名称</th><th>描述</th></tr></thead><tbody><tr><td>void lock()</td><td>获取锁</td></tr><tr><td>boolean tryLock()</td><td>尝试获取锁，没获取到锁不会阻塞</td></tr><tr><td>void unlock()</td><td>释放锁</td></tr><tr><td>Condition newCondition()</td><td>创建等待队列，调用wait()方法可以加入等待队列</td></tr></tbody></table><h3 id="AbstractQueuedSynchronizer"><a href="#AbstractQueuedSynchronizer" class="headerlink" title="AbstractQueuedSynchronizer"></a>AbstractQueuedSynchronizer</h3><p>同步器AQS，是实现锁的基础；</p><p><strong>主要方法</strong></p><p>获取&#x2F;设置同步状态</p><table><thead><tr><th align="center">方法</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">int getState()</td><td align="center">获取同步状态</td></tr><tr><td align="center">void setState()</td><td align="center">设置同步状态</td></tr><tr><td align="center">boolean compareAndSetState(int expect, int update)</td><td align="center">CAS设置同步状态</td></tr></tbody></table><p>获取独占锁&#x2F;共享锁，可以覆盖重写</p><table><thead><tr><th align="center">方法</th><th align="center">描述</th></tr></thead><tbody><tr><td align="center">boolean tryAcquire(int arg)</td><td align="center">独占式获取同步状态</td></tr><tr><td align="center">boolean tryRelease(int arg)</td><td align="center">独占式释放同步状态</td></tr><tr><td align="center">int tryAcquireShared(int arg)</td><td align="center">共享式获取同步状态</td></tr><tr><td align="center">boolean tryReleaseShared(int arg)</td><td align="center">共享式私房同步状态</td></tr><tr><td align="center">boolean isHeldExclusively()</td><td align="center">检测当前线程是否获取独占锁</td></tr></tbody></table><p>模板方法</p><table><thead><tr><th align="center">方法</th><th align="center">说明</th></tr></thead><tbody><tr><td align="center">void acquire(int arg)</td><td align="center">独占式获取同步状态，该方法将会调用 tryAcquire 尝试获取同步状态。获取成功则返回，获取失败，线程进入同步队列等待。</td></tr><tr><td align="center">void acquireInterruptibly(int arg)</td><td align="center">响应中断版的 acquire</td></tr><tr><td align="center">boolean tryAcquireNanos(int arg,long nanos)</td><td align="center">超时+响应中断版的 acquire</td></tr><tr><td align="center">void acquireShared(int arg)</td><td align="center">共享式获取同步状态，同一时刻可能会有多个线程获得同步状态。比如读写锁的读锁就是就是调用这个方法获取同步状态的。</td></tr><tr><td align="center">void acquireSharedInterruptibly(int arg)</td><td align="center">响应中断版的 acquireShared</td></tr><tr><td align="center">boolean tryAcquireSharedNanos(int arg,long nanos)</td><td align="center">超时+响应中断版的 acquireShared</td></tr><tr><td align="center">boolean release(int arg)</td><td align="center">独占式释放同步状态</td></tr><tr><td align="center">boolean releaseShared(int arg)</td><td align="center">共享式释放同步状态</td></tr></tbody></table><p>通过<strong>FIFO队列</strong>给来获取锁的线程排队</p><p><img src="/img/java_img/AQS%E9%98%9F%E5%88%97.png"></p><p>节点分为独占式和共享式</p><ul><li>独占式： 首节点获取同步状态，当释放同步状态后，会唤醒队列的下一个节点</li><li>共享式：首节点获取同步状态，若下一个节点也是共享节点，则会唤醒下一个节点</li></ul><h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><p>可重入锁，支持公平非公平，默认非公平</p><p>通过<strong>Unsafe类</strong>的<code>pack()</code>、<code>unpack()</code>、<code>compareAndSwap..()</code>、来实现线程的阻塞、唤醒和CAS操作</p><p>内部类<strong>sync</strong>实现<strong>AbstractQueuedSynchronizer</strong>接口，通过<strong>sync</strong>实现公平锁、非公平锁</p><p>获取锁：</p><ul><li>lock()方法</li><li>通过CAS操作尝试加锁<ul><li>成功则设置自己为当前锁的持有者</li><li>失败则调用<code>acquire()</code>，会再尝试一次，再失败则会阻塞（加入到AQS的等待队列）</li></ul></li></ul><p><img src="/img/java_img/ReentrantLock_lock().png"></p><p>释放锁：</p><ul><li>unlock()方法</li><li>释放锁后通过AQS的等待队列唤醒下一个线程，唤醒的线程回去争抢锁</li></ul><p><img src="/img/java_img/ReentrantLock_unlock().png"></p><p>可重入：</p><ul><li>当前线程每次获取锁时state++</li><li>释放锁时只有state &#x3D;&#x3D; 0才会释放锁</li></ul><h3 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h3><p>是基于<code>ReentrantLock</code>和<code>AbstractQueuedSynchronizer</code>实现的</p><p>本身实现了<code>ReadWriteLock</code>接口</p><p><strong>int state</strong>的前16位表示占有读锁的线程数、后16位表示占有写锁的线程的重入次数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARED_SHIFT</span>   <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;<br><br><span class="hljs-comment">// 获取读锁数量</span><br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sharedCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span>    &#123; <span class="hljs-keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; &#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXCLUSIVE_MASK</span> <span class="hljs-operator">=</span> (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>) - <span class="hljs-number">1</span>;<br><br><span class="hljs-comment">// 获取写锁数量</span><br><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">exclusiveCount</span><span class="hljs-params">(<span class="hljs-type">int</span> c)</span> &#123; <span class="hljs-keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;<br></code></pre></td></tr></table></figure><p>读读互容，写写互斥，读写互斥</p><p>获取读锁时，会判断是否有写锁，然后state的高16位+1表示加读锁</p><p>获取写锁时，会判断state是否为0，然后state置为1，每次重入state+1</p><p>释放读锁时，<code>ThreadLocal</code>保存着每个线程的重入次数，对应的重入次数减为0时state-1</p><p>释放写锁时，state-1，只有当state为0时才会释放</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>SpringAOP</title>
    <link href="/2023/05/28/spring/SpringAOP/"/>
    <url>/2023/05/28/spring/SpringAOP/</url>
    
    <content type="html"><![CDATA[<h1 id="SpringAOP"><a href="#SpringAOP" class="headerlink" title="SpringAOP"></a>SpringAOP</h1><blockquote><p>Aspect Orient Programming，面向切面编程</p></blockquote><h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><ol><li>定义业务组件</li><li>定义切点</li><li>定义增强通知</li></ol><p><a href="https://blog.csdn.net/Cr1556648487/article/details/126777903">使用方式</a></p><h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>采用<strong>JDK动态代理</strong>和<strong>CGLib动态代理</strong>实现</p><ul><li>如果目标对象有实现接口，则使用JDK动态代理</li><li>如果没有实现接口，则使用CGLib动态代理</li></ul><h3 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h3><blockquote><p>通过反射实现代理</p></blockquote><h3 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h3><ol><li>定义实现<strong>InvocationHandler</strong>接口的处理器</li><li>通过**Proxy.newInstance(类加载器，所有代理目标实现的接口，处理器)**来获取代理对象</li><li>使用代理对象的方法</li></ol><p>优点：</p><ol><li>原生，不需要其他依赖</li><li>生成代理类的速度快</li></ol><p>缺点：</p><ol><li>通过接口的方法来织入增强方法，因此目标必须需要实现接口</li><li>执行方法的速度相对较慢</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdkProxySubject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br> <br>    <span class="hljs-keyword">private</span> Subject subject;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JdkProxySubject</span><span class="hljs-params">(Subject subject)</span> &#123;<br>        <span class="hljs-built_in">this</span>.subject = subject;<br>    &#125;<br> <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br> <br>        System.out.println(<span class="hljs-string">&quot;before 前置通知&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br> <br>        <span class="hljs-keyword">try</span> &#123;<br>            result = method.invoke(subject, args);<br>        &#125;<span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            System.out.println(<span class="hljs-string">&quot;ex: &quot;</span> + ex.getMessage());<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;after 后置通知&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123; <br>        <span class="hljs-comment">//获取InvocationHandler对象 在构造方法中注入目标对象 </span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdkProxySubject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RealSubject</span>()); <br><br>        <span class="hljs-comment">//获取代理类对象 </span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">proxySubject</span> <span class="hljs-operator">=</span> (Subject)Proxy.newProxyInstance(Main.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Subject.class&#125;, handler); <br><br>        <span class="hljs-comment">//调用目标方法</span><br>        proxySubject.request();<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="CGLib动态代理"><a href="#CGLib动态代理" class="headerlink" title="CGLib动态代理"></a>CGLib动态代理</h3><blockquote><p>通过操作字节码实现代理</p></blockquote><p>Cglib的实现是在字节码的基础上的，并且使用了开源的ASM读取字节码，对类实现增强功能的。</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MyBatis</title>
    <link href="/2023/05/24/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis/mybatis/"/>
    <url>/2023/05/24/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis/mybatis/</url>
    
    <content type="html"><![CDATA[<h1 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h1><blockquote><p>对于JDBC的封装</p></blockquote><h2 id="JDBC执行步骤"><a href="#JDBC执行步骤" class="headerlink" title="JDBC执行步骤"></a>JDBC执行步骤</h2><blockquote><p>JDBC（Java Data Base Connectivity）</p></blockquote><ol><li>注册驱动</li><li>建立连接</li><li>创建SQL</li><li>执行SQL</li><li>封装结果集</li><li>释放资源</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 注册驱动</span><br>Class.forName(<span class="hljs-string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);<br><span class="hljs-comment">// 建立连接</span><br><span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> DriverManager.getConnection(数据库地址, 用户名, 密码);<br><span class="hljs-comment">// 创建SQL</span><br><span class="hljs-type">Statement</span> <span class="hljs-variable">statement</span> <span class="hljs-operator">=</span> connection.createStatement();<br><span class="hljs-comment">// 执行SQL</span><br><span class="hljs-type">ResultSet</span> <span class="hljs-variable">resultSet</span> <span class="hljs-operator">=</span> statement.executeQueue(sql);<br><span class="hljs-comment">// 处理结果集</span><br>...<br><span class="hljs-comment">// 释放资源</span><br>.....close()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringMVC</title>
    <link href="/2023/05/24/spring/SpringMVC/"/>
    <url>/2023/05/24/spring/SpringMVC/</url>
    
    <content type="html"><![CDATA[<h1 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h1><blockquote><p>MVC（Model-View-Controller），模型-视图-控制器</p></blockquote><h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><p>SpringMVC底层就是Servlet，SpringMVC就是对Servlet进行深层次的封装</p><p><strong>MVC模式</strong>：</p><ul><li><p>Model表示数据和应用逻辑，可能包括数据库操作等。View是用户所看到的界面，它展示Model中的数据并让用户与其进行交互。Controller负责处理用户请求，从View中接收输入并在Model里面读取或修改数据,负责把模块和视图结合起来</p><p>  <img src="/img/spring_img/SpringMVC%E6%95%B4%E4%BD%93.png" alt="SpringMVC执行流程"></p></li></ul><h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><p><img src="/img/spring_img/SpringMVC%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png" alt="SpringMVC执行流程"></p><ol><li>用户发送请求到<strong>前端调度器</strong>（DispatcherServlet）</li><li>调度器收到请求后调用<strong>处理器映射器</strong>（HandlerMapping）</li><li>处理器映射器根据url找到具体的处理器和拦截器，生成执行链，返回给调度器</li><li>调度器通过<strong>处理器适配器</strong>（HandlerAdapter）调用具体的<strong>处理器</strong>（Handler），返回<strong>ModelAndView</strong></li><li>调度器将ModelAndView传给<strong>视图解析器</strong>（ViewReslover）解析，返回<strong>视图对象</strong>（View）</li><li>调度器渲染视图，把视图和数据结合，响应给用户</li></ol><h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><ul><li><strong>前端调度器</strong>（DispatcherServlet）：接收请求，响应数据，需要程序员配置</li><li>处理器映射器（HandlerMapping）：通过url查找Handler</li><li>处理器适配器（Handler Adapter）：执行Handler中的方法</li><li><strong>处理器</strong>（Handler）：业务方法，需要程序员编写</li><li>视图解析器（ViewResolver）：把ModelAndView解析出给用户看的视图</li><li><strong>视图</strong>（View）：展示给用户看的，需要程序员编写</li></ul><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ol><li><p>调度器（DispatcherServlet）如何获取处理器（Handler）？</p><p>调度器里有一个doDispatch()方法，里面调用了getHandler()方法；在getHandler()里面调用了处理器映射器（HandlerMapping）的getHandler()方法来获取处理器</p></li><li><p>调度器如何执行处理器？</p><p>调度器里的doDispatch()方法里，首先通过getHandlerAdapter()方法获取当前处理器的处理器适配器（HandlerAdapter）来做适配，然后执行适配器的handler()方法</p></li><li><p>调度器如何解析视图对象（ModelAndView）的？</p><p>调度器里的doDispatch()方法里，调用processDispatcherResult()方法，方法里调用render()方法，render()方法调用resolveViewName()，通过遍历的方式来找和viewName相同的View</p></li><li><p>三大组件（HandlerMapping、HandlerAdapter、ViewResolver）是谁初始化的？</p><p>SpringMVC中通过DispatcherServlet中的initStrategies()方法，通过默认配置来找到类所在位置，来初始化组件</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pinia</title>
    <link href="/2023/05/10/%E5%89%8D%E7%AB%AF/vue/Pinia/"/>
    <url>/2023/05/10/%E5%89%8D%E7%AB%AF/vue/Pinia/</url>
    
    <content type="html"><![CDATA[<h1 id="Pinia"><a href="#Pinia" class="headerlink" title="Pinia"></a>Pinia</h1><blockquote><p>Pinia是Vue的专属的最新<strong>状态管理库</strong>，是Vuex状态管理工具的替代品，用于组件之间共享数据</p></blockquote><p><a href="https://pinia.vuejs.org/zh/">Pinia中文文档</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol><li><p>下载依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs npm">npm install pinia<br></code></pre></td></tr></table></figure></li><li><p>导入</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// main.js</span><br><br><span class="hljs-comment">// 导入Pinia</span><br><span class="hljs-keyword">import</span> &#123; createPinia &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span><br><span class="hljs-comment">// 创建</span><br><span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()<br><br><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(pinia).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br></code></pre></td></tr></table></figure></li></ol><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><p>使用Pinia实现简易计数器</p><ol><li><p>创建Store，定义变量和方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vue">// stores.counter.js<br>import &#123; ref &#125; from &quot;vue&quot;;<br>import &#123; defineStore &#125; from &quot;pinia&quot;;<br><br>export const useCounterStore = defineStore(&#x27;counter&#x27;, () =&gt; &#123;<br>    const count = ref(0)<br>    function increment() &#123;<br>        count.value++<br>    &#125;<br><br>    return &#123; count, increment &#125;<br>&#125;)<br></code></pre></td></tr></table></figure></li><li><p>其他组件使用Store</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vue">// components.PiniaTest.vue<br>&lt;script setup&gt;<br>    import &#123; useCounterStore &#125; from &#x27;@/stores/counter&#x27;<br><br>    const counter = useCounterStore()<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;div&gt;<br>        &lt;button @click=&quot;counter.increment()&quot;&gt;&#123;&#123; counter.count &#125;&#125;&lt;/button&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure></li></ol><h2 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter</h2><blockquote><p>相当于计算属性</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs vue">import &#123; computed, ref &#125; from &quot;vue&quot;;<br>import &#123; defineStore &#125; from &quot;pinia&quot;;<br><br>export const useCounterStore = defineStore(&#x27;counter&#x27;, () =&gt; &#123;<br>    const count = ref(0)<br>    function increment() &#123;<br>        count.value++<br>    &#125;<br>    // Getter<br>    const doubleCount = computed(() =&gt; count.value * 2)<br><br>    return &#123; <br>        count, <br>        increment,<br>        doubleCount<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><blockquote><p>相当于方法</p></blockquote><p>创建异步获取数据的action</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">// store<br>import &#123; ref &#125; from &quot;vue&quot;;<br>import &#123; defineStore &#125; from &quot;pinia&quot;;<br>import axios from &quot;axios&quot;;<br><br>const API_URL = &#x27;http://geek.itheima.net/v1_0/channels&#x27;<br>export const useCounterStore = defineStore(&#x27;counter&#x27;, () =&gt; &#123;<br>    // Action<br>    const list = ref([])<br>    const getList = async () =&gt; &#123;<br>        const res = await axios.get(API_URL)<br>        list.value = res.data.data.channels<br>    &#125;<br><br>    return &#123;         <br>        list,<br>        getList<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>组件调用store的action</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>    import &#123; useCounterStore &#125; from &#x27;@/stores/counter&#x27;<br>import &#123; onMounted &#125; from &#x27;vue&#x27;;<br><br>    const counter = useCounterStore()<br><br>    onMounted(() =&gt; &#123;<br>        counter.getList()<br>    &#125;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;ul&gt;<br>        &lt;li v-for=&quot;item in counter.list&quot; :key=&quot;item.id&quot;&gt;<br>            &#123;&#123; item.name &#125;&#125;<br>        &lt;/li&gt;<br>    &lt;/ul&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="解构"><a href="#解构" class="headerlink" title="解构"></a>解构</h2><p>可以通过storeToRefs把store解构</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; useCounterStore &#125; from &#x27;@/stores/counter&#x27;<br>import &#123; onMounted &#125; from &#x27;vue&#x27;;<br>import &#123; storeToRefs &#125; from &#x27;pinia&#x27;<br><br>const counter = useCounterStore()<br>// 只能解构出数据(state, getter)，方法(action)解构不出来<br>const &#123; list &#125; = storeToRefs(counter)<br><br>onMounted(() =&gt; &#123;<br>    counter.getList()<br>&#125;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;ul&gt;<br>        &lt;li v-for=&quot;item in list&quot; :key=&quot;item.id&quot;&gt;<br>            &#123;&#123; item.name &#125;&#125;<br>        &lt;/li&gt;<br>    &lt;/ul&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="通过pinia优化请求"><a href="#通过pinia优化请求" class="headerlink" title="通过pinia优化请求"></a>通过pinia优化请求</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/store/category.js</span><br><br><span class="hljs-keyword">import</span> &#123; ref &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;vue&quot;</span><br><span class="hljs-keyword">import</span> &#123; defineStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;pinia&quot;</span><br><span class="hljs-keyword">import</span> &#123; getCategoryAPI &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/apis/layout&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCategoryStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;categoryStore&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// 导航列表</span><br>    <span class="hljs-keyword">const</span> categoryList = <span class="hljs-title function_">ref</span>([])<br>    <span class="hljs-comment">// 获取导航列表</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCategoryList</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCategoryAPI</span>()<br>        categoryList.<span class="hljs-property">value</span> = res.<span class="hljs-property">result</span><br>    &#125;<br><br>    <span class="hljs-keyword">return</span> &#123;<br>        categoryList,<br>        getCategoryList<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>在父组件里发送请求，把数据保存在store中，之后子组件通过store获取数据，不需要再去重新请求数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs vue">// src/views/Layout/index.vue<br><br>&lt;script setup&gt;<br>import LayoutNav from &#x27;./components/LayoutNav.vue&#x27;;<br>import LayoutHeader from &#x27;./components/LayoutHeader.vue&#x27;;<br>import LayoutFooter from &#x27;./components/LayoutFooter.vue&#x27;;<br>import LayoutFixed from &#x27;./components/LayoutFixed.vue&#x27;;<br>import &#123; useCategoryStore &#125; from &#x27;@/stores/category&#x27;;<br>import &#123; onMounted &#125; from &#x27;vue&#x27;;<br><br>// 加载导航列表，让吸顶导航条和导航条只需要一次请求<br>const categoryStore = useCategoryStore()<br>onMounted(() =&gt; &#123;<br>    categoryStore.getCategoryList()<br>&#125;)<br><br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;LayoutFixed/&gt;<br>    &lt;LayoutNav/&gt;<br>    &lt;LayoutHeader/&gt;<br>    &lt;RouterView/&gt;<br>    &lt;LayoutFooter/&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="pinia负责触发action"><a href="#pinia负责触发action" class="headerlink" title="pinia负责触发action"></a>pinia负责触发action</h3><blockquote><p>Pinia负责用户数据相关的state和action，组件中只负责触发action函数并传递参数</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/store/user.js</span><br><span class="hljs-keyword">import</span> &#123; defineStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span><br><span class="hljs-keyword">import</span> &#123; ref &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> &#123; loginAPI &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/apis/user&#x27;</span><br><br><span class="hljs-comment">// 登录用户信息Store</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// 用户数据</span><br>    <span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">ref</span>(&#123;&#125;)<br>    <span class="hljs-comment">// 获取数据方法</span><br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params">&#123;account, password&#125;</span>) &#123;<br>        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loginAPI</span>(&#123; account, password &#125;)<br>        userInfo.<span class="hljs-property">value</span> = res.<span class="hljs-property">result</span><br>    &#125;<br>    <span class="hljs-comment">// 返回</span><br>    <span class="hljs-keyword">return</span> &#123;<br>        userInfo,<br>        getUserInfo<br>    &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>组件通过调用<code>useUserStore</code>来发起请求，并把数据保存在Pinia。Pinia中的数据是保存在内存中的，一刷新就没了，需要进行持久化</p><p><a href="https://prazdevs.github.io/pinia-plugin-persistedstate/zh/guide/">Pinia持久化插件</a></p><p>持久化后，store return的数据会被保存到<code>Local Storage</code>中</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Vue3</title>
    <link href="/2023/05/06/%E5%89%8D%E7%AB%AF/vue/Vue3/"/>
    <url>/2023/05/06/%E5%89%8D%E7%AB%AF/vue/Vue3/</url>
    
    <content type="html"><![CDATA[<h1 id="Vue3"><a href="#Vue3" class="headerlink" title="Vue3"></a>Vue3</h1><p><a href="https://cn.vuejs.org/">官网</a></p><h2 id="声明试渲染"><a href="#声明试渲染" class="headerlink" title="声明试渲染"></a>声明试渲染</h2><p>当状态改变时，HTML 会自动更新</p><p><strong>响应式</strong>：能在改变时触发更新的状态</p><h3 id="组合式"><a href="#组合式" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; reactive, ref &#125; from &#x27;vue&#x27;<br><br>const counter = reactive(&#123; count: 0 &#125;)<br>const message = ref(&#x27;Hello World!&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h1&gt;&#123;&#123; message &#125;&#125;&lt;/h1&gt;<br>  &lt;p&gt;Count is: &#123;&#123; counter.count &#125;&#125;&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p><strong>reactive和ref的比较</strong>：</p><ul><li><p><strong>reactive只能用于定义对象，ref可以定义任何类型</strong></p></li><li><p>reactive是通过创建代理对象来实现响应式，给一个已经通过reactive创建的代理对象再套一层reactive返回的仍是原来的代理对象，代理对象里的属性也是被代理了；因此reactive对原始类型无效(number、string、boolean)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vue">const raw = &#123;&#125;<br>const proxy = reactive(raw)<br><br>console.log(proxy === raw) // false<br>console.log(reactive(raw) === proxy) // true<br>console.log(reactive(proxy) === proxy) // true<br></code></pre></td></tr></table></figure></li><li><p>ref是将传入的值包装为一个带<code>.value</code>属性的对象。ref对象作为顶层元素在模板中使用时会自动解包，不需要<code>.value</code>;作为属性时需要<code>.value</code></p></li></ul><p><code>&lt;script setup&gt;</code>中的setup表示里面定义的变量是响应式的</p><h3 id="选项式"><a href="#选项式" class="headerlink" title="选项式"></a>选项式</h3><p>声明变量和对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      message: &#x27;Hello World!&#x27;,<br>      counter: &#123;<br>        count: 0<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h1&gt;&#123;&#123; message &#125;&#125;&lt;/h1&gt;<br>  &lt;p&gt;Count is: &#123;&#123; counter.count &#125;&#125;&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="属性绑定v-bind"><a href="#属性绑定v-bind" class="headerlink" title="属性绑定v-bind :"></a>属性绑定<code>v-bind :</code></h2><p><code>v-bind:</code>(缩写<code>:</code>)可以用于给标签的属性绑定</p><p>注意：</p><ul><li><p>如果绑定的值为<code>null</code>或者<code>undefined</code>，则属性会被移除</p></li><li><p>如果绑定的值为true或false，则为false时属性会被移除</p></li></ul><h3 id="组合式-1"><a href="#组合式-1" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br><br>const titleClass = ref(&#x27;title&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h1 :class=&quot;titleClass&quot;&gt;Make me red&lt;/h1&gt;<br>&lt;/template&gt;<br><br>&lt;style&gt;<br>.title &#123;<br>  color: red;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure><h3 id="响应式"><a href="#响应式" class="headerlink" title="响应式"></a>响应式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      titleClass: &#x27;title&#x27;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h1 :class=&#x27;titleClass&#x27;&gt;Make me red&lt;/h1&gt; &lt;!-- 此处添加一个动态 class 绑定 --&gt;<br>&lt;/template&gt;<br><br>&lt;style&gt;<br>.title &#123;<br>  color: red;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure><h2 id="事件监听v-on"><a href="#事件监听v-on" class="headerlink" title="事件监听v-on @"></a>事件监听<code>v-on @</code></h2><p>通过<code>v-on:</code>或<code>@</code>来监听事件</p><p><strong>注意</strong>：</p><ul><li>可以直接写一些简单的表示式</li><li>直接绑定方法名，方法可以有一个原生 DOM 事件参数<code>event</code>；绑定<code>方法名(参数)</code>可以传递参数, 但<code>event</code>没了；绑定<code>方法名(参数, ..., $event)</code>可以传入<code>event</code></li></ul><p><strong>事件修饰符</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;!-- 单击事件将停止传递 --&gt;<br>&lt;a @click.stop=&quot;doThis&quot;&gt;&lt;/a&gt;<br><br>&lt;!-- 提交事件将不再重新加载页面 --&gt;<br>&lt;form @submit.prevent=&quot;onSubmit&quot;&gt;&lt;/form&gt;<br><br>&lt;!-- 修饰语可以使用链式书写 --&gt;<br>&lt;a @click.stop.prevent=&quot;doThat&quot;&gt;&lt;/a&gt;<br><br>&lt;!-- 也可以只有修饰符 --&gt;<br>&lt;form @submit.prevent&gt;&lt;/form&gt;<br><br>&lt;!-- 仅当 event.target 是元素本身时才会触发事件处理器 --&gt;<br>&lt;!-- 例如：事件处理器不来自子元素 --&gt;<br>&lt;div @click.self=&quot;doThat&quot;&gt;...&lt;/div&gt;<br></code></pre></td></tr></table></figure><p><strong>按键修饰符</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;!-- 仅在 `key` 为 `Enter` 时调用 `submit` --&gt;<br>&lt;input @keyup.enter=&quot;submit&quot; /&gt;<br><br>&lt;!-- Alt + Enter --&gt;<br>&lt;input @keyup.alt.enter=&quot;clear&quot; /&gt;<br></code></pre></td></tr></table></figure><p>常用的按键的别名：</p><ul><li><code>.enter</code></li><li><code>.tab</code></li><li><code>.delete</code> (捕获“Delete”和“Backspace”两个按键)</li><li><code>.esc</code></li><li><code>.space</code></li><li><code>.up</code></li><li><code>.down</code></li><li><code>.left</code></li><li><code>.right</code></li><li><code>.ctrl</code></li><li><code>.alt</code></li><li><code>.shift</code></li><li><code>.meta</code>（win键）</li><li><code>.left</code>（鼠标左键）</li><li><code>.right</code>（鼠标右键）</li><li><code>.middle</code>（鼠标中键）</li></ul><h3 id="组合式-2"><a href="#组合式-2" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br><br>const count = ref(0)<br>function increment() &#123;<br>  count.value++<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;!-- 使此按钮生效 --&gt;<br>  &lt;button @click=&quot;increment&quot;&gt;count is: &#123;&#123; count &#125;&#125;&lt;/button&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="选项式-1"><a href="#选项式-1" class="headerlink" title="选项式"></a>选项式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      count: 0<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    increment() &#123;<br>      this.count++<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;!-- 使此按钮生效 --&gt;<br>  &lt;button @click=&quot;increment&quot;&gt;count is: &#123;&#123; count &#125;&#125;&lt;/button&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="表单绑定v-model"><a href="#表单绑定v-model" class="headerlink" title="表单绑定v-model"></a>表单绑定<code>v-model</code></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      text: &#x27;&#x27;<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    onInput(e) &#123;<br>      this.text = e.target.value<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;input :value=&quot;text&quot; @input=&quot;onInput&quot; placeholder=&quot;Type here&quot;&gt;<br>  &lt;p&gt;&#123;&#123; text &#125;&#125;&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>上面的写法需要通过<code>v-bind</code>和<code>v-on</code>来双向绑定</p><p>可以用语法糖<code>&lt;input v-model=&quot;text&quot;&gt;</code>，</p><p><code>&lt;textarea&gt;</code>（多行文本）、<code>&lt;input type=&quot;checkbox&quot;&gt;</code>（选择框）、<code>&lt;select&gt;</code>（下拉框）、<code>&lt;input type=&quot;radio&quot;&gt;</code>（单选按钮）等也可以用<code>v-model</code>来简化绑定</p><h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><ul><li><code>.lazy</code>：<code>v-model</code> 会在每次 <code>input</code> 事件后更新数据<code>v-model.lazy</code>会在每次 <code>change</code> 事件后更新数据</li><li><code>.number</code>：用户输入自动转换为数字 </li><li><code>.trim</code>：自动去除用户输入内容中两端的空格</li></ul><h2 id="条件渲染v-if"><a href="#条件渲染v-if" class="headerlink" title="条件渲染v-if"></a>条件渲染<code>v-if</code></h2><p>通过<code>v-if</code>、<code>v-else</code>、<code>v-else-if</code>来选择渲染元素</p><p><code>v-show</code>也可以，不同在于<code>v-show</code>是通过<code>display</code>来控制是否显示，<code>v-if</code>直接把元素删了</p><h3 id="组合式-3"><a href="#组合式-3" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br><br>const awesome = ref(true)<br><br>function toggle() &#123;<br>  awesome.value = !awesome.value<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;button @click=&quot;toggle&quot;&gt;toggle&lt;/button&gt;<br>  &lt;h1 v-if=&quot;awesome&quot;&gt;Vue is awesome!&lt;/h1&gt;<br>  &lt;h1 v-else&gt;Oh no &lt;/h1&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="选项式-2"><a href="#选项式-2" class="headerlink" title="选项式"></a>选项式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      awesome: true<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    toggle() &#123;<br>      this.awesome = !this.awesome<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;button @click=&quot;toggle&quot;&gt;toggle&lt;/button&gt;<br>  &lt;h1 v-if=&quot;awesome&quot;&gt;Vue is awesome!&lt;/h1&gt;<br>  &lt;h1 v-else&gt;Oh no&lt;/h1&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="列表渲染v-for"><a href="#列表渲染v-for" class="headerlink" title="列表渲染v-for"></a>列表渲染<code>v-for</code></h2><p>通过<code>v-for 变量 in 数组</code>来遍历渲染一个数组</p><p><strong>注意</strong>：</p><ul><li><code>:key</code>使得 Vue 能够精确的移动每个 <code>&lt;li&gt;</code>，以匹配对应的对象在数组中的位置。</li><li><code>v-for</code>也可以遍历对象的属性<code>v-for=&quot;(value, key, index) in myObject&quot;</code></li><li>同一个标签里<code>v-if</code>的优先级比<code>v-for</code>高</li></ul><h3 id="组合式-4"><a href="#组合式-4" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br><br>// 给每个 todo 对象一个唯一的 id<br>let id = 0<br><br>const newTodo = ref(&#x27;&#x27;)<br>const todos = ref([<br>  &#123; id: id++, text: &#x27;Learn HTML&#x27; &#125;,<br>  &#123; id: id++, text: &#x27;Learn JavaScript&#x27; &#125;,<br>  &#123; id: id++, text: &#x27;Learn Vue&#x27; &#125;<br>])<br><br>function addTodo() &#123;<br>  todos.value.push(&#123; id: id++, text: newTodo.value &#125;)<br>  newTodo.value = &#x27;&#x27;<br>&#125;<br><br>function removeTodo(todo) &#123;<br>  todos.value = todos.value.filter((t) =&gt; t !== todo)<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;form @submit.prevent=&quot;addTodo&quot;&gt;<br>    &lt;input v-model=&quot;newTodo&quot;&gt;<br>    &lt;button&gt;Add Todo&lt;/button&gt;    <br>  &lt;/form&gt;<br>  &lt;ul&gt;<br>    &lt;li v-for=&quot;todo in todos&quot; :key=&quot;todo.id&quot;&gt;<br>      &#123;&#123; todo.text &#125;&#125;<br>      &lt;button @click=&quot;removeTodo(todo)&quot;&gt;X&lt;/button&gt;<br>    &lt;/li&gt;<br>  &lt;/ul&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="选项式-3"><a href="#选项式-3" class="headerlink" title="选项式"></a>选项式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>// 给每个 todo 对象一个唯一的 id<br>let id = 0<br><br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      newTodo: &#x27;&#x27;,<br>      todos: [<br>        &#123; id: id++, text: &#x27;Learn HTML&#x27; &#125;,<br>        &#123; id: id++, text: &#x27;Learn JavaScript&#x27; &#125;,<br>        &#123; id: id++, text: &#x27;Learn Vue&#x27; &#125;<br>      ]<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    addTodo() &#123;<br>      this.todos.push(&#123; id: id++, text: this.newTodo &#125;)<br>      this.newTodo = &#x27;&#x27;<br>    &#125;,<br>    removeTodo(todo) &#123;<br>      this.todos = this.todos.filter((t) =&gt; t !== todo)<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;form @submit.prevent=&quot;addTodo&quot;&gt;<br>    &lt;input v-model=&quot;newTodo&quot;&gt;<br>    &lt;button&gt;Add Todo&lt;/button&gt;    <br>  &lt;/form&gt;<br>  &lt;ul&gt;<br>    &lt;li v-for=&quot;todo in todos&quot; :key=&quot;todo.id&quot;&gt;<br>      &#123;&#123; todo.text &#125;&#125;<br>      &lt;button @click=&quot;removeTodo(todo)&quot;&gt;X&lt;/button&gt;<br>    &lt;/li&gt;<br>  &lt;/ul&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="计算属性computed"><a href="#计算属性computed" class="headerlink" title="计算属性computed"></a>计算属性<code>computed</code></h2><p><strong>注意</strong>：</p><ul><li>计算属性应当只用来计算，不应该包含其他功能，减少复杂性</li><li>计算属性应该只读</li></ul><h3 id="组合式-5"><a href="#组合式-5" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; reactive, ref, computed &#125; from &#x27;vue&#x27;<br><br>const list = ref([1, 2, 3, 4, 5, 6, 7, 8])<br><br>const computedList = computed(() =&gt; &#123;<br>  return list.value.filter((val) =&gt; val &gt; 2)<br>&#125;)<br><br>// 定时器，3秒后添加元素，计算属性也会重新计算<br>setTimeout(() =&gt; &#123;<br>  list.value.push(9, 10)<br>&#125;, 3000)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;div&gt;<br>    原始数组：&#123;&#123; list &#125;&#125;<br>  &lt;/div&gt; <br>  &lt;br/&gt;<br>  &lt;div&gt;<br>    计算属性数组 &#123;&#123; computedList &#125;&#125;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="模板引用-ref"><a href="#模板引用-ref" class="headerlink" title="模板引用 ref"></a>模板引用 <code>ref</code></h2><p>通过<code>ref</code>来获取指定的DOM元素</p><p><strong>注意</strong>：</p><ul><li>DOM元素是在挂载后才有的</li><li>子组件可以通过<code>defineExpose(&#123;&#125;)</code>来将属性值暴露给父组件</li></ul><h3 id="组合式-6"><a href="#组合式-6" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref, onMounted &#125; from &#x27;vue&#x27;<br><br>// 通过变量名来匹配DOM元素，此时还没挂载完，需要先设为null<br>const a = ref(null)<br><br>onMounted(() =&gt; &#123;<br>  a.value.textContent = &#x27;mounted!&#x27;<br>&#125;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;p ref=&quot;a&quot;&gt;hello&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="选项式-4"><a href="#选项式-4" class="headerlink" title="选项式"></a>选项式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  mounted() &#123;<br>    this.$refs.a.textContent = &#x27;world&#x27;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;p ref=&quot;a&quot;&gt;hello&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><p><img src="/img/qianduan_img/Vue3%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png"></p><h3 id="组合式-7"><a href="#组合式-7" class="headerlink" title="组合式"></a>组合式</h3><p>和选项式的区别在于生命周期的名字前加上了on，除了Created换成了setup</p><p>如果定义了多个相同的生命周期函数，则会依次调用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; onMounted &#125; from &#x27;vue&#x27;<br><br>onMounted(() =&gt; &#123;<br>  console.log(&#x27;asdasd&#x27;)<br>&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h2 id="监听器watch"><a href="#监听器watch" class="headerlink" title="监听器watch"></a>监听器<code>watch</code></h2><p>当<code>data</code>发生改变时触发</p><p><strong>注意</strong></p><ul><li><p>监听器只有在发生改变时触发，如果要<strong>创建时就触发</strong>需要实现<code>handle</code>方法和设置<code>immediate=true</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vue">watch: &#123;<br>    a: &#123;<br>      handler(newA) &#123;<br>        newA = &#x27;b&#x27;<br>        this.a = newA<br>      &#125;,<br>      immediate: true<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure></li><li><p>如果要<strong>监听对象里属性的变化</strong>，需要设置<code>deep:true</code>，这里监听属性是通过遍历实现的，效率很低</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vue">export default &#123;<br>  data() &#123;<br>    return &#123;<br>      a: &#123;<br>        b: &#x27;b&#x27;<br>      &#125;<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    <br>  &#125;,<br>  watch: &#123;<br>    a: &#123;<br>      b: &#123;<br>        handler(newB) &#123;<br>        this.b = newB<br>      &#125;,<br>      deep: true<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>监听器是在属性改变前触发，要改变后触发，需要设置<code>flush: &#39;post&#39;</code></p></li><li><p>通过<code>this.$watch</code>方法创建监听器，好处是可以通过调用返回的方法来停止监听器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vue">export default &#123;<br>  created() &#123;<br>    const w = this.$watch(&#x27;question&#x27;, (newQuestion) =&gt; &#123;<br>      // ...<br>    &#125;)<br>w()<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="组合式-8"><a href="#组合式-8" class="headerlink" title="组合式"></a>组合式</h3><p>组合式要开启深度侦听、立即回调等功能是在watch第三个参数里传一个对象</p><p>如果要精确监听对象的某个值，则第一个参数改为回调函数，返回要监听的那个值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref, watch &#125; from &#x27;vue&#x27;<br><br>const todoId = ref(1)<br>const todoData = ref(null)<br><br>async function fetchData() &#123;<br>  todoData.value = null<br>  const res = await fetch(<br>    `https://jsonplaceholder.typicode.com/todos/$&#123;todoId.value&#125;`<br>  )<br>  todoData.value = await res.json()<br>&#125;<br><br>fetchData()<br>  <br>watch(todoId, (newTodoId) =&gt; &#123;<br>  fetchData()<br>&#125;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;p&gt;Todo id: &#123;&#123; todoId &#125;&#125;&lt;/p&gt;<br>  &lt;button @click=&quot;todoId++&quot;&gt;Fetch next todo&lt;/button&gt;<br>  &lt;p v-if=&quot;!todoData&quot;&gt;Loading...&lt;/p&gt;<br>  &lt;pre v-else&gt;&#123;&#123; todoData &#125;&#125;&lt;/pre&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="选项式-5"><a href="#选项式-5" class="headerlink" title="选项式"></a>选项式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      todoId: 1,<br>      todoData: null<br>    &#125;<br>  &#125;,<br>  methods: &#123;<br>    async fetchData() &#123;<br>      this.todoData = null<br>      const res = await fetch(<br>        `https://jsonplaceholder.typicode.com/todos/$&#123;this.todoId&#125;`<br>      )<br>      this.todoData = await res.json()<br>    &#125;<br>  &#125;,<br>  mounted() &#123;<br>    this.fetchData()<br>  &#125;,<br>  watch: &#123;<br>    todoId(newId) &#123;<br>      this.fetchData()<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;p&gt;Todo id: &#123;&#123; todoId &#125;&#125;&lt;/p&gt;<br>  &lt;button @click=&quot;todoId++&quot;&gt;Fetch next todo&lt;/button&gt;<br>  &lt;p v-if=&quot;!todoData&quot;&gt;Loading...&lt;/p&gt;<br>  &lt;pre v-else&gt;&#123;&#123; todoData &#125;&#125;&lt;/pre&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="组件-import"><a href="#组件-import" class="headerlink" title="组件 import"></a>组件 <code>import</code></h2><h3 id="组合式-9"><a href="#组合式-9" class="headerlink" title="组合式"></a>组合式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp /&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="选项式-6"><a href="#选项式-6" class="headerlink" title="选项式"></a>选项式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>  import ChildComp from &#x27;./ChildComp.vue&#x27;<br>  export default &#123;<br>    // register child component<br>    components: &#123;<br>      ChildComp<br>    &#125;<br>  &#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;!-- render child component --&gt;<br>  &lt;ChildComp /&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="父组件向子组件传值props"><a href="#父组件向子组件传值props" class="headerlink" title="父组件向子组件传值props"></a>父组件向子组件传值<code>props</code></h3><p>子组件定义prop，父组件通过属性绑定传值</p><h4 id="组合式-10"><a href="#组合式-10" class="headerlink" title="组合式"></a>组合式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br><br>const greeting = ref(&#x27;Hello from parent&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp :msg=&#x27;greeting&#x27;/&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>子组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>const props = defineProps(&#123;<br>  msg: String<br>&#125;)<br>console.log(props)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h2&gt;&#123;&#123; msg || &#x27;No props passed yet&#x27; &#125;&#125;&lt;/h2&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h4 id="选项式-7"><a href="#选项式-7" class="headerlink" title="选项式"></a>选项式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br><br>export default &#123;<br>  components: &#123;<br>    ChildComp<br>  &#125;,<br>  data() &#123;<br>    return &#123;<br>      greeting: &#x27;Hello from parent&#x27;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp :msg=&quot;greeting&quot;/&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>子组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  props: &#123;<br>    msg: String<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h2&gt;&#123;&#123; msg || &#x27;No props passed yet&#x27; &#125;&#125;&lt;/h2&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="子组件向父组件传值emits"><a href="#子组件向父组件传值emits" class="headerlink" title="子组件向父组件传值emits"></a>子组件向父组件传值<code>emits</code></h3><p>子组件定义触发器emit，父组件通过事件监听获取子组件的值</p><h4 id="组合式-11"><a href="#组合式-11" class="headerlink" title="组合式"></a>组合式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br><br>const childMsg = ref(&#x27;No child msg yet&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp @response=&#x27;(msg) =&gt; childMsg = msg&#x27;/&gt;<br>  &lt;p&gt;&#123;&#123; childMsg &#125;&#125;&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>子组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>const emit = defineEmits([&#x27;response&#x27;])<br><br>emit(&#x27;response&#x27;, &#x27;hello from child&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h2&gt;Child component&lt;/h2&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h4 id="选项式-8"><a href="#选项式-8" class="headerlink" title="选项式"></a>选项式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br><br>export default &#123;<br>  components: &#123;<br>    ChildComp<br>  &#125;,<br>  data() &#123;<br>    return &#123;<br>      childMsg: &#x27;No child msg yet&#x27;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp @response=&#x27;(msg) =&gt; childMsg = msg&#x27;/&gt;<br>  &lt;p&gt;&#123;&#123; childMsg &#125;&#125;&lt;/p&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>子组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>export default &#123;<br>  emits: [&#x27;response&#x27;],<br>  created() &#123;<br>    this.$emit(&#x27;response&#x27;, &#x27;hello from child&#x27;)<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;h2&gt;Child component&lt;/h2&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="父组件向子组件传模板slot"><a href="#父组件向子组件传模板slot" class="headerlink" title="父组件向子组件传模板slot"></a>父组件向子组件传模板<code>slot</code></h3><p>子组件使用插槽<code>&lt;slot&gt;</code>作为占位符，父组件传来的模板会放到这个位置</p><h4 id="组合式-12"><a href="#组合式-12" class="headerlink" title="组合式"></a>组合式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; ref &#125; from &#x27;vue&#x27;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br><br>const msg = ref(&#x27;from parent&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp&gt;asd&lt;/ChildComp&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>子组件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;slot&gt;Fallback content&lt;/slot&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h4 id="选项式-9"><a href="#选项式-9" class="headerlink" title="选项式"></a>选项式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>import ChildComp from &#x27;./ChildComp.vue&#x27;<br><br>export default &#123;<br>  components: &#123;<br>    ChildComp<br>  &#125;,<br>  data() &#123;<br>    return &#123;<br>      msg: &#x27;from parent&#x27;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>  &lt;ChildComp&gt;asd&lt;/ChildComp&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;slot&gt;Fallback content&lt;/slot&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="跨层传递数据provide-inject"><a href="#跨层传递数据provide-inject" class="headerlink" title="跨层传递数据provide inject"></a>跨层传递数据<code>provide inject</code></h3><p>上层组件通过provide定义数据&#x2F;方法，下层通过inject获取数据&#x2F;方法</p><h4 id="组合式-13"><a href="#组合式-13" class="headerlink" title="组合式"></a>组合式</h4><p>第一层</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; provide, ref &#125; from &#x27;vue&#x27;;<br>import RoomMsgItem from &#x27;./room-msg-item.vue&#x27;<br><br>// 传递普通数据<br>provide(&#x27;data-key&#x27;, &#x27;this is room data&#x27;)<br>// 传递响应式数据<br>const count = ref(0)<br>provide(&#x27;count-key&#x27;, count)<br><br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;div&gt;<br>        顶层组件<br>        &lt;br/&gt; ============ &lt;br/&gt;<br>        &lt;input type=&quot;button&quot; @click=&quot;() =&gt; count++&quot; :value=&quot;count&quot;/&gt;<br>        &lt;div&gt;<br>            &lt;RoomMsgItem/&gt;<br>        &lt;/div&gt;<br>        ============<br>    &lt;/div&gt;<br>    <br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>第二层</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import roomMsgComment from &#x27;./room-msg-comment.vue&#x27;;<br><br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;div&gt;<br>        中间层组件<br>        &lt;br/&gt; -------<br>        &lt;div&gt;<br>            &lt;roomMsgComment/&gt;<br>        &lt;/div&gt;<br>        -------<br>    &lt;/div&gt;<br>    <br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>第三层</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; inject &#125; from &#x27;vue&#x27;;<br><br>const roomData = inject(&#x27;data-key&#x27;)<br>const countData = inject(&#x27;count-key&#x27;)<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>    &lt;div&gt;<br>        底层组件<br>    &lt;/div&gt;<br>    &lt;div&gt;<br>        来自顶层组件中的数据为: &#123;&#123; roomData &#125;&#125;<br>    &lt;/div&gt;<br>    &lt;div&gt;<br>        来自顶层组件的响应式数据为: &#123;&#123; countData &#125;&#125;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="注册全局指令"><a href="#注册全局指令" class="headerlink" title="注册全局指令"></a>注册全局指令</h2><p>标签里使用时<code>v-自定义指令名=&#39;&#39;</code></p>  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/directives/index.js</span><br><br><span class="hljs-keyword">import</span> &#123; useIntersectionObserver &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@vueuse/core&#x27;</span><br><br><span class="hljs-comment">// 自定义全局指令</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> layzPlugin = &#123;<br>    <span class="hljs-title function_">install</span>(<span class="hljs-params">app</span>) &#123;<br>        app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">&#x27;img-lazy&#x27;</span>, &#123;<br>            <span class="hljs-comment">// el: 指令绑定的元素</span><br>            <span class="hljs-comment">// binding: 指令后面的值</span><br>            <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el, binding</span>) &#123;<br><br>                <span class="hljs-comment">// 监听元素是否进入屏幕</span><br>                <span class="hljs-keyword">const</span> &#123;stop&#125; = <span class="hljs-title function_">useIntersectionObserver</span>(<br>                    el,<br>                    <span class="hljs-function">(<span class="hljs-params">[&#123; isIntersecting &#125;]</span>) =&gt;</span> &#123;<br>                        <span class="hljs-keyword">if</span> (isIntersecting) &#123;<br>                            <span class="hljs-comment">// 加载图片</span><br>                            el.<span class="hljs-property">src</span> = binding.<span class="hljs-property">value</span><br>                            <span class="hljs-title function_">stop</span>()  <span class="hljs-comment">// 关闭监听</span><br>                        &#125;<br>                    &#125;,  <br>                )<br>            &#125;<br>        &#125;)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>导入自定义指令</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/main.js</span><br><br><span class="hljs-keyword">import</span> &#123; createApp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> &#123; createPinia &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span><br><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App.vue&#x27;</span><br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./styles/common.scss&#x27;</span><br><span class="hljs-comment">// 自定义懒加载指令</span><br><span class="hljs-keyword">import</span> &#123; layzPlugin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./directives&#x27;</span><br><br><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>    .<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>())<br>    .<span class="hljs-title function_">use</span>(router)<br>    .<span class="hljs-title function_">use</span>(layzPlugin)<br>    .<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br></code></pre></td></tr></table></figure><h2 id="注册全局组件"><a href="#注册全局组件" class="headerlink" title="注册全局组件"></a>注册全局组件</h2><p>和注册全局指令类似，先创建插件，再把插件注册到app中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// /src/components/index.js</span><br><br><span class="hljs-comment">// 将组件进行全局化注册</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ImageView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/ImageView/index.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Sku</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/components/XtxSku/index.vue&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> componentPlugin =&#123;<br>    <span class="hljs-title function_">install</span>(<span class="hljs-params">app</span>) &#123;<br>        app.<span class="hljs-title function_">component</span>(<span class="hljs-string">&#x27;XtxImageView&#x27;</span>, <span class="hljs-title class_">ImageView</span>)<br>        app.<span class="hljs-title function_">component</span>(<span class="hljs-string">&#x27;XtxSku&#x27;</span>, <span class="hljs-title class_">Sku</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/main.js</span><br><br><span class="hljs-keyword">import</span> &#123; createApp &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> &#123; createPinia &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span><br><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./App.vue&#x27;</span><br><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./styles/common.scss&#x27;</span><br><span class="hljs-comment">// 自定义懒加载指令</span><br><span class="hljs-keyword">import</span> &#123; layzPlugin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./directives&#x27;</span><br><span class="hljs-keyword">import</span> &#123; componentPlugin &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/index&#x27;</span><br><br><span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)<br>    .<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>())<br>    .<span class="hljs-title function_">use</span>(router)<br>    .<span class="hljs-title function_">use</span>(layzPlugin)    <span class="hljs-comment">// 图片懒加载</span><br>    .<span class="hljs-title function_">use</span>(componentPlugin)   <span class="hljs-comment">// 全局组件</span><br>    .<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>)<br></code></pre></td></tr></table></figure><h2 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h2><p><code>create-vue</code>是Vue官方新的脚手架工具，底层使用<code>vite</code></p><p><a href="https://cn.vitejs.dev/guide/">Vite文档</a></p><ol><li><p>环境要求：Node.js版本16.0及以上</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">node -v<br></code></pre></td></tr></table></figure></li><li><p>创建Vue应用</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm init vue@latest<br>// 会安装并执行create-vue<br>// 之后选择需要的依赖来初始化项目<br></code></pre></td></tr></table></figure></li><li><p>主要文件&#x2F;文件夹</p><p><img src="/img/qianduan_img/Vue3%E7%9B%AE%E5%BD%95.png"></p><ul><li>package.json：用于描述项目所需依赖包、项目的信息、脚本命令等的元数据文件</li><li>vite.config.js：项目的配置文件，基于Vite的配置</li><li>main.js：项目入口文件</li><li>App.vue：根组件</li></ul></li><li><p>常见的自己创建的文件夹</p><ul><li>apis：API接口文件夹</li><li>composables：组合函数文件夹，放一些从组件中封装出来的函数</li><li>directives：全局指令文件夹</li><li>styles：全局样式文件夹</li><li>utils：工具函数文件夹</li></ul></li></ol><h1 id="Element-Plus"><a href="#Element-Plus" class="headerlink" title="Element Plus"></a>Element Plus</h1><blockquote><p>基于 Vue 3的Element UI</p></blockquote><p><a href="https://element-plus.gitee.io/zh-CN/guide/quickstart.html">Element Plue中文文档</a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol><li><p>安装依赖</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm install element-plus --save<br></code></pre></td></tr></table></figure></li><li><p>按需导入(只加载使用到的组件)需要额外安装插件</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm install -D unplugin-vue-components unplugin-auto-import<br></code></pre></td></tr></table></figure></li><li><p><code>vite.config.js</code>配置导入插件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// vite.config.ts</span><br><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-auto-import/vite&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-vue-components/vite&#x27;</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ElementPlusResolver</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;unplugin-vue-components/resolvers&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-comment">// ...</span><br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-comment">// ...</span><br>    <span class="hljs-title class_">AutoImport</span>(&#123;<br>      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],<br>    &#125;),<br>    <span class="hljs-title class_">Components</span>(&#123;<br>      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>()],<br>    &#125;),<br>  ],<br>&#125;)<br></code></pre></td></tr></table></figure></li><li><p>测试组件是否能用</p></li></ol><h2 id="定制ElementPlus主题样式"><a href="#定制ElementPlus主题样式" class="headerlink" title="定制ElementPlus主题样式"></a>定制ElementPlus主题样式</h2><blockquote><p>组件库里的样式没有合适的，需要自己定制</p></blockquote><p><strong>基于sass定制样式</strong></p><ol><li><p>安装sass(css扩展语言)</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm i sass -D<br></code></pre></td></tr></table></figure></li><li><p>在<code>src/styles/element/index.scss</code>里添加准备好的定制化样式文件</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-comment">// 示例</span><br><span class="hljs-keyword">@forward</span> <span class="hljs-string">&#x27;element-plus/theme-chalk/src/common/var.scss&#x27;</span> with (<br>  <span class="hljs-variable">$colors</span>: (<br>    <span class="hljs-string">&#x27;primary&#x27;</span>: (<br>      // 主色<br>      <span class="hljs-string">&#x27;base&#x27;</span>: <span class="hljs-number">#27ba9b</span>,<br>    ),<br>    <span class="hljs-string">&#x27;success&#x27;</span>: (<br>      // 成功色<br>      <span class="hljs-string">&#x27;base&#x27;</span>: <span class="hljs-number">#1dc779</span>,<br>    ),<br>    <span class="hljs-string">&#x27;warning&#x27;</span>: (<br>      // 警告色<br>      <span class="hljs-string">&#x27;base&#x27;</span>: <span class="hljs-number">#ffb302</span>,<br>    ),<br>    <span class="hljs-string">&#x27;danger&#x27;</span>: (<br>      // 危险色<br>      <span class="hljs-string">&#x27;base&#x27;</span>: <span class="hljs-number">#e26237</span>,<br>    ),<br>    <span class="hljs-string">&#x27;error&#x27;</span>: (<br>      // 错误色<br>      <span class="hljs-string">&#x27;base&#x27;</span>: <span class="hljs-number">#cf4444</span>,<br>    ),<br>  )<br>)<br></code></pre></td></tr></table></figure></li><li><p>修改<code>vite.config.js</code>配置文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 设置elementPlus采用sass样式配色系统</span><br><span class="hljs-title class_">Components</span>(&#123;<br>      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">ElementPlusResolver</span>(&#123; <span class="hljs-attr">importStyle</span>: <span class="hljs-string">&#x27;sass&#x27;</span> &#125;)],<br>    &#125;), <br><br><span class="hljs-comment">// 在plugins同级下设置样式文件位置</span><br><span class="hljs-attr">css</span>: &#123;<br>    <span class="hljs-attr">preprocessorOptions</span>: &#123;<br>      <span class="hljs-attr">scss</span>: &#123;<br>        <span class="hljs-comment">// 自动导入定制化样式文件进行样式覆盖</span><br>        <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`</span><br><span class="hljs-string">          @use &quot;@/styles/element/index.scss&quot; as *;</span><br><span class="hljs-string">        `</span>,<br>      &#125;<br>    &#125;<br>  &#125;<br></code></pre></td></tr></table></figure></li></ol><h1 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h1><h2 id="安装-amp-基础配置"><a href="#安装-amp-基础配置" class="headerlink" title="安装&amp;基础配置"></a>安装&amp;基础配置</h2><ol><li><p>安装依赖</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm install axios<br></code></pre></td></tr></table></figure></li><li><p>基础配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/utils/http.js</span><br><br><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span><br><br><span class="hljs-comment">// 创建axios实例</span><br><span class="hljs-keyword">const</span> httpInstance = axios.<span class="hljs-title function_">create</span>(&#123;<br>    <span class="hljs-comment">// 基地址</span><br>    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&#x27;http://pcapi-xiaotuxian-front-devtest.itheima.net&#x27;</span>,<br>    <span class="hljs-comment">// 超时时间</span><br>    <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span><br>&#125;)<br><br><span class="hljs-comment">// axios请求拦截器</span><br>httpInstance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> config<br>&#125;, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(e))<br><br><span class="hljs-comment">// axios响应式拦截器</span><br>httpInstance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">data</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(e)<br>&#125;)<br><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> httpInstance<br></code></pre></td></tr></table></figure></li><li><p>创建api请求</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// src/apis/testAPI.js</span><br><br><span class="hljs-keyword">import</span> httpInstance <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@/utils/http&quot;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCategory</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">httpInstance</span>(&#123;<br>        <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;home/category/head&#x27;</span><br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; getCategory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/apis/testAPI&#x27;</span><br><span class="hljs-title function_">getCategory</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)<br>&#125;)<br></code></pre></td></tr></table></figure></li></ol><h1 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h1><h2 id="一级路由"><a href="#一级路由" class="headerlink" title="一级路由"></a>一级路由</h2><p>在<code>src/router/index.js</code>文件里添加修改路由信息</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><span class="hljs-comment">// 导入自定义的组件</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/Login/index.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/Layout/index.vue&#x27;</span><br><br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>),<br>  <span class="hljs-comment">// 配置路由</span><br>  <span class="hljs-attr">routes</span>: [<br>    &#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Layout</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Login</span><br>    &#125;<br>  ]<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router<br><br></code></pre></td></tr></table></figure><p>根组件<code>App.vue</code>里记得添加一级<strong>路由出口</strong>(一级路由的组件会被渲染到这个位置)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;!-- 一级路由出口组件 --&gt;<br>  &lt;RouterView /&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="二级路由"><a href="#二级路由" class="headerlink" title="二级路由"></a>二级路由</h2><p>通过<code>children</code>来配置子路由</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123; createRouter, createWebHistory &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Login</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/Login/index.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/Layout/index.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/Home/index.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Category</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/Category/index.vue&#x27;</span><br><br><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>(&#123;<br>  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">BASE_URL</span>),<br>  <span class="hljs-attr">routes</span>: [<br>    &#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>, <br>      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Layout</span>,<br>      <span class="hljs-attr">children</span>: [<br>        <span class="hljs-comment">// path为空则为默认路由</span><br>        &#123;<br>          <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>          <span class="hljs-attr">component</span>: <span class="hljs-title class_">Home</span><br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;category&#x27;</span>,<br>          <span class="hljs-attr">component</span>: <span class="hljs-title class_">Category</span><br>        &#125;,<br>      ]<br>    &#125;,<br><br>    &#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Login</span><br>    &#125;<br>  ]<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router<br><br></code></pre></td></tr></table></figure><p>在父组件里添加路由出口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div&gt;<br>        首页<br>        &lt;RouterView/&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="路由缓存问题"><a href="#路由缓存问题" class="headerlink" title="路由缓存问题"></a>路由缓存问题</h2><p>例如路由为<code>/users/a</code>导航到<code>/users/b</code>时，组件将被重复使用。两个路由中相同的组件会被复用，更加高效。</p><p>但是复用的组件的生命周期钩子函数不会再被调用，导致数据无法更新</p><p><strong>解决方式</strong>：</p><ol><li><p>不让组件复用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;!-- 给RouterView添加:key来避免复用 --&gt;<br>&lt;RouterView :key=&quot;$route.fullPath&quot;/&gt;<br></code></pre></td></tr></table></figure></li><li><p>监听路由变化，变化后更新数据</p><p>在组件里使用<code>router</code>的<code>onBeforeRouteUpdate()</code>函数来监听路由变化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; getCategoryAPI &#125; from &#x27;@/apis/category&#x27;;<br>import &#123; ref, onMounted &#125; from &#x27;vue&#x27;;<br>import &#123; onBeforeRouteUpdate, useRoute &#125; from &#x27;vue-router&#x27;;<br>import &#123; getBannerAPI &#125; from &#x27;@/apis/home&#x27;;<br>import GoodsItem from &#x27;../Home/components/GoodsItem.vue&#x27;;<br><br>// 获取商品分类数据<br>const router = useRoute()<br>const categoryData = ref(&#123;&#125;)<br>async function getCategory(id = router.params.id) &#123;<br>    const res = await getCategoryAPI(id)<br>    categoryData.value = res.result<br>&#125;<br>// 获取轮播图数据<br>const bannerList = ref([])<br>async function getBanner() &#123;<br>  const res = await getBannerAPI(&#123;distributionSite: &#x27;2&#x27;&#125;)<br>  bannerList.value = res.result<br>&#125;<br><br>onMounted(() =&gt; &#123;<br>  getCategory()<br>  getBanner()<br>&#125;)<br><br>// 监听路由变化来更新数据<br>onBeforeRouteUpdate((to) =&gt; &#123;<br>  getCategory(to.params.id)<br>&#125;)<br><br>&lt;/script&gt;<br></code></pre></td></tr></table></figure></li></ol><h1 id="VueUse"><a href="#VueUse" class="headerlink" title="VueUse"></a>VueUse</h1><blockquote><p>基于组合式API的工具集，可以用于如跟踪ref更改，检测元素可见性，简化常见 Vue 模式，键盘&#x2F;鼠标输入等</p></blockquote><p><a href="http://www.vueusejs.com/">中文文档</a></p><p><a href="https://vueuse.org/">英文文档</a></p><h1 id="Swiper"><a href="#Swiper" class="headerlink" title="Swiper"></a>Swiper</h1><p>Swiper是纯javascript打造的滑动特效插件，面向手机、平板电脑等移动终端；Swiper能实现触屏焦点图、触屏Tab切换、触屏<strong>轮播图</strong>切换等常用效果。</p><p><a href="https://swiperjs.com/">官网</a></p><h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><p>安装依赖(以10.1.0为例)</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm install swiper@<span class="hljs-number">10</span>.<span class="hljs-number">1</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>    import &#123; Swiper, SwiperSlide &#125; from &#x27;swiper/vue&#x27;;<br><br>    // 仅包含核心样式<br>    import &#x27;swiper/css&#x27;;<br>    // 所有样式<br>    // import &#x27;swiper/css/bundle&#x27;<br><br>    const onSwiper = (swiper) =&gt; &#123;<br>        console.log(swiper);<br>    &#125;;<br>    const onSlideChange = () =&gt; &#123;<br>        console.log(&#x27;slide change&#x27;);<br>    &#125;;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>&lt;swiper <br>        :slides-per-view=&quot;2&quot;<br>        :space-between=&quot;50&quot;<br>        @swiper=&quot;onSwiper&quot;<br>        @slideChange=&quot;onSlideChange&quot;<br>        &gt;<br>    &lt;swiper-slide&gt;Slide 1&lt;/swiper-slide&gt;<br>    &lt;swiper-slide&gt;Slide 2&lt;/swiper-slide&gt;<br>    &lt;swiper-slide&gt;Slide 3&lt;/swiper-slide&gt;<br>    &lt;/swiper&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><blockquote><p>官网找demo, 然后看API里的属性来设置</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>    // 图片切换淡入淡出效果<br>    import &#123; Swiper, SwiperSlide &#125; from &#x27;swiper/vue&#x27;;<br>    import &#123; EffectFade, Autoplay &#125; from &#x27;swiper/modules&#x27;;<br><br>    import &#x27;swiper/css&#x27;;<br>    import &#x27;swiper/css/effect-fade&#x27;;<br>    import &#x27;swiper/css/autoplay&#x27;;<br><br>    // 淡入淡出, 自动播放<br>    const modules = [EffectFade, Autoplay]<br><br>    const sectionOneData = &#123;<br>        swipeItems: [<br>            &#x27;https://ts1.cn.mm.bing.net/th/id/R-C.3428ce0dc9ffcb71b43de5e4de53c3be?rik=oWeInFhSbuc8ew&amp;riu=http%3a%2f%2fwww.nitutu.com%2fuploads%2fallimg%2f170808%2f2039463303-20.jpg&amp;ehk=lpq14%2bXdQdGE9HANkVnv4hVNUxLwGvK%2bev1nGJ%2fuGAY%3d&amp;risl=&amp;pid=ImgRaw&amp;r=0&#x27;,<br>            &#x27;https://ts1.cn.mm.bing.net/th/id/R-C.e76fb1e2661ae7a2f33ce54a3b192d6a?rik=DzfFM6%2fW%2bBpHGQ&amp;riu=http%3a%2f%2fpic.newface.cn%2farticle%2f2016%2f01%2f20160130095735_9675.jpg&amp;ehk=c00UX3veD414tlKaUbYIW8QsXgKzwfTUATYAU30SQqY%3d&amp;risl=&amp;pid=ImgRaw&amp;r=0&#x27;,<br>            &#x27;https://ts1.cn.mm.bing.net/th/id/R-C.a139d5e3ce46969368baaf05ba1c70e7?rik=83nAr%2bmixceprg&amp;riu=http%3a%2f%2fimgboys1.yohobuy.com%2fcontentimg%2f2019%2f10%2f10%2f22%2f0185fd68a7d869c5e79dfec8609a8e8593.jpg&amp;ehk=TGV5OB8lBfPprp0KFFdZdaIgh%2bJmcGB93KQHZHWVMwk%3d&amp;risl=&amp;pid=ImgRaw&amp;r=0&#x27;,<br>            &#x27;https://ts1.cn.mm.bing.net/th/id/R-C.c86ee2951bf2f3c55e8f13fdc152d561?rik=Biz9aDUCRPU4tA&amp;riu=http%3a%2f%2fimgboys2.yohobuy.com%2fcontentimg%2f2019%2f10%2f10%2f22%2f021bd574784425d516b08715b49d40eb26.jpg&amp;ehk=QRmm0m1XUPBIQXJD%2f9Q4KeKv6d4n4%2fRuFMLc%2fl3B%2fUg%3d&amp;risl=&amp;pid=ImgRaw&amp;r=0&#x27;<br>        ]<br>    &#125;<br>&lt;/script&gt;<br><br>&lt;template&gt;<br>&lt;div class=&quot;swipe-warp&quot;&gt;<br>    &lt;!-- 淡入淡出, 循环播放, 播放间隔3s, 用户拖动图片后不禁用自动播放 --&gt;<br>    &lt;swiper class=&quot;swipe&quot; <br>            :modules=&quot;modules&quot; <br>            :effect=&quot;&#x27;fade&#x27;&quot; <br>            :loop=&quot;true&quot; <br>            :autoplay=&quot;&#123; delay: 3000, disableOnInteraction: false &#125;&quot;&gt; <br>        &lt;swiper-slide v-for=&quot;item in sectionOneData.swipeItems&quot; :key=&quot;item&quot;&gt;<br>            &lt;img :src=&quot;item&quot;/&gt;<br>    &lt;/swiper-slide&gt;<br>    &lt;/swiper&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;style&gt;<br>    .swipe-warp &#123;<br>        .swipe  &#123;<br>            color: #fff;<br>            width: 375px;<br>            height: 375px;<br>            overflow: hidden;   /* 溢出内容隐藏 */<br>            background-color: #39a9ed;<br>            .swiper-slide &gt; img &#123;<br>                width: 100%;<br>                object-fit: cover;  /* 等比例缩放，以填充容器，并保持其宽高比 */<br>            &#125;<br>        &#125;<br>    &#125;<br>&lt;/style&gt;<br><br></code></pre></td></tr></table></figure><h1 id="GSAP"><a href="#GSAP" class="headerlink" title="GSAP"></a>GSAP</h1><p>GreenSock Animation Platform，可以对JavaScript可以操作的所有内容进行动画处理（CSS属性，SVG，React，画布，通用对象等），同时解决了不同浏览器上存在的兼容性问题，而且速度极快</p><p><a href="https://gsap.com/docs/v3/Installation">官网</a></p><h2 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h2><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm install gsap<br></code></pre></td></tr></table></figure><h1 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h1><p>Bootstrap是一个功能强大、功能丰富的前端工具包。在几分钟内即可构建从原型到生产的任何内容。</p><p><a href="https://v5.bootcss.com/docs/getting-started/introduction/">文档</a></p><h2 id="安装-3"><a href="#安装-3" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">npm i --save bootstrap @popperjs/core<br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装额外的依赖Sass来正确导入和捆绑 Bootstrap 的 CSS</span><br>npm i --save-dev sass<br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装图标库</span><br>npm i bootstrap-icons<br></code></pre></td></tr></table></figure><p>创建文件assets&#x2F;styles.scss</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Import all of Bootstrap&#x27;s CSS</span><br>@<span class="hljs-keyword">import</span> <span class="hljs-string">&quot;bootstrap/scss/bootstrap&quot;</span>;<br><span class="hljs-comment">// 图标</span><br>@<span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;bootstrap-icons/font/bootstrap-icons.css&#x27;</span>;<br></code></pre></td></tr></table></figure><p>main.js导入</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./assets/styles.scss&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;@popperjs/core&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;bootstrap&quot;</span>;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>FreeMarker</title>
    <link href="/2023/05/03/%E6%A1%86%E6%9E%B6/FreeMarker/"/>
    <url>/2023/05/03/%E6%A1%86%E6%9E%B6/FreeMarker/</url>
    
    <content type="html"><![CDATA[<h1 id="FreeMarker"><a href="#FreeMarker" class="headerlink" title="FreeMarker"></a>FreeMarker</h1><blockquote><p>模板引擎，视图的模板是固定的，将模板中的数据修改后返回</p><p>模板 + 数据模型 &#x3D; 输出</p></blockquote><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><h3 id="SpringBoot整合FreeMarker"><a href="#SpringBoot整合FreeMarker" class="headerlink" title="SpringBoot整合FreeMarker"></a><strong>SpringBoot整合FreeMarker</strong></h3><ol><li><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">freemarker:</span><br>    <span class="hljs-attr">charset:</span> <span class="hljs-string">UTF-8</span><br>    <span class="hljs-comment"># 指定模板文件后缀 freemarker template langurage</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.ftl</span><br>    <span class="hljs-comment"># 指定模板所在路径</span><br>    <span class="hljs-attr">template-loader-path:</span> <span class="hljs-string">classpath:/templates</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">allow-request-override:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-attr">check-template-location:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">content-type:</span> <span class="hljs-string">text/html</span><br>    <span class="hljs-attr">expose-request-attributes:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">expose-session-attributes:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li><li><p>编写Controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(Model model)</span> &#123;<br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;key1&quot;</span>, <span class="hljs-string">&quot;value1&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;key2&quot;</span>, <span class="hljs-string">&quot;value2&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;myMap&quot;</span>, map);<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;World&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在<code>resources/templates</code>下编写模板<code>hello.ftl</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Hello FreeMarker&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;h1&gt;Hello $&#123;name&#125;!&lt;/h1&gt;<br>    &lt;p&gt;Value for key1: $&#123;myMap[&quot;key1&quot;]&#125;&lt;/p&gt;<br>    &lt;p&gt;Value for key2: $&#123;myMap[&quot;key2&quot;]&#125;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure></li></ol><blockquote><p>运行，访问<code>localhost:8080/hello</code></p></blockquote><h3 id="单独使用"><a href="#单独使用" class="headerlink" title="单独使用"></a>单独使用</h3><ol><li><p>导包、配置</p></li><li><p>编写模板<code>welcome.ftl</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Welcome&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome $&#123;name&#125;!&lt;/h1&gt;<br>&lt;p&gt;Today is $&#123;date?string(&quot;yyyy-MM-dd&quot;)&#125;&lt;/p&gt;<br>&lt;ul&gt;<br>    &lt;#list items as item&gt;<br>        &lt;li&gt;$&#123;item&#125;&lt;/li&gt;<br>    &lt;/#list&gt;<br>&lt;/ul&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure></li><li><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FmTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Configuration</span> <span class="hljs-variable">cfg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(Configuration.VERSION_2_3_31);<br>        <span class="hljs-comment">// 设置模板所在路径和编码</span><br>        cfg.setClassLoaderForTemplateLoading(getClass().getClassLoader(), <span class="hljs-string">&quot;/templates/&quot;</span>);<br>        cfg.setDefaultEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br><br>        Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        data.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;John&quot;</span>);<br>        data.put(<span class="hljs-string">&quot;date&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        data.put(<span class="hljs-string">&quot;items&quot;</span>, Arrays.asList(<span class="hljs-string">&quot;Apple&quot;</span>, <span class="hljs-string">&quot;Banana&quot;</span>, <span class="hljs-string">&quot;Orange&quot;</span>));<br><br>        <span class="hljs-comment">// 获取模板</span><br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> cfg.getTemplate(<span class="hljs-string">&quot;welcome.ftl&quot;</span>);<br>        <span class="hljs-type">Writer</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>        <span class="hljs-comment">// 给数据渲染模板，输出到writer中</span><br>        template.process(data, out);<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">rendered</span> <span class="hljs-operator">=</span> out.toString();<br>        System.out.println(rendered);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="插值-x2F-表达式"><a href="#插值-x2F-表达式" class="headerlink" title="插值&#x2F;表达式"></a>插值&#x2F;表达式</h3><p>使用<code>$&#123;..&#125;</code>来引入变量，如：<code>$&#123;name&#125;</code></p><h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p><code>\</code>需要转义，或者在字符串前面加r</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ftl">$&#123;&quot;hello world&quot;&#125;<br>$&#123;&quot;我的文件保存在C:\\盘&quot;&#125;<br>$&#123;r&quot;我的文件保存在C:\盘&quot;&#125;<br></code></pre></td></tr></table></figure><p>字符串拼接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;&quot;hello $&#123;name&#125;&quot;&#125;&lt;/div&gt;<br>&lt;div&gt;$&#123;&quot;hello &quot;+ name&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure><p>字符串截取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;name[0]&#125;$&#123;name[1]&#125;&lt;/div&gt;<br>&lt;div&gt;$&#123;name[0..2]&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure><h4 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h4><ul><li><p>以钱的形式展示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#assign num=99&gt;<br>&lt;div&gt;$&#123;num?string.currency&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p>百分数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;num?string.percent&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li></ul><h4 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#assign flag=true&gt;<br>&lt;div&gt;$&#123;flag?string(&quot;a&quot;,&quot;b&quot;)&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure><h4 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h4><ul><li><p>直接定义然后输出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#list [&quot;星期一&quot;, &quot;星期二&quot;, &quot;星期三&quot;, &quot;星期四&quot;, &quot;星期五&quot;, &quot;星期六&quot;, &quot;星期天&quot;] as x&gt;<br>    $&#123;x&#125;&lt;br/&gt;<br>&lt;/#list&gt;<br></code></pre></td></tr></table></figure></li><li><p>集合的元素可以是表达式、map</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#list [2+2,&quot;javaboy&quot;] as x&gt;<br>    $&#123;x&#125; &lt;br/&gt;<br>&lt;/#list&gt;<br><br>&lt;#list &#123;&quot;a&quot;:&quot;a&quot;,&quot;b&quot;:&quot;b&quot;&#125;?keys as x&gt;<br>$&#123;x&#125;<br>&lt;/#list&gt;<br>&lt;#list &#123;&quot;a&quot;:&quot;a&quot;,&quot;b&quot;:&quot;b&quot;&#125;?values as x&gt;<br>$&#123;x&#125;<br>&lt;/#list&gt;<br></code></pre></td></tr></table></figure></li></ul><h4 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h4><p><strong>算数运算</strong></p><ol><li><p>&#x3D; 或者 &#x3D;&#x3D; 判断两个值是否相等。</p></li><li><p>!&#x3D; 判断两个值是否不等。</p></li><li><p><code>&gt;</code> 或者 gt 判断左边值是否大于右边值。</p></li><li><p><code>&gt;=</code> 或者 gte 判断左边值是否大于等于右边值。</p></li><li><p><code>&lt;</code> 或者 lt 判断左边值是否小于右边值。</p></li><li><p><code>&lt;=</code> 或者 lte 判断左边值是否小于等于右边值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;<br>    &lt;#assign age=99&gt;<br>    &lt;#if age=99&gt;age=99&lt;/#if&gt;<br>    &lt;#if age gt 99&gt;age gt 99&lt;/#if&gt;<br>    &lt;#if age gte 99&gt;age gte 99&lt;/#if&gt;<br>    &lt;#if age lt 99&gt;age lt 99&lt;/#if&gt;<br>    &lt;#if age lte 99&gt;age lte 99&lt;/#if&gt;<br>    &lt;#if age!=99&gt;age!=99&lt;/#if&gt;<br>    &lt;#if age==99&gt;age==99&lt;/#if&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure></li></ol><p><strong>逻辑运算</strong></p><ol><li><p>逻辑与 <code>&amp;&amp;</code></p></li><li><p>逻辑或 <code>||</code></p></li><li><p>逻辑非 <code>!</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;<br>&lt;#assign age=99&gt;<br>&lt;#if age=99 &amp;&amp; 1==1&gt; age=99 &amp;&amp; 1==1 &lt;/#if&gt;<br>&lt;#if age=99 || 1==0&gt; age=99 || 1==0 &lt;/#if&gt;<br>&lt;#if !(age gt 99)&gt; !(age gt 99) &lt;/#if&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure></li></ol><h4 id="空值处理"><a href="#空值处理" class="headerlink" title="空值处理"></a>空值处理</h4><ul><li><p><code>!</code>指定空值的默认值，后面不写东西则为空字符串</p></li><li><p><code>??</code>判断某个变量是否存在</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt; $&#123;aaa!&quot;bbb&quot;&#125; &lt;/div&gt;<br>&lt;div&gt; $&#123;aaa!&#125; &lt;/div&gt;<br>&lt;div&gt;<br>&lt;#if aaa??&gt; bbb &lt;/#if&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure></li></ul><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>通过Model传值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(Model model)</span> &#123;<br>        List&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            u.setUsername(<span class="hljs-string">&quot;name&quot;</span> + i);<br>            u.setAddress(<span class="hljs-string">&quot;address&quot;</span> + i);<br>            users.add(u);<br>        &#125;<br>        Map&lt;String, Object&gt; info = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        info.put(<span class="hljs-string">&quot;site&quot;</span>, <span class="hljs-string">&quot;site&quot;</span>);<br>        info.put(<span class="hljs-string">&quot;wechat&quot;</span>, <span class="hljs-string">&quot;wechat&quot;</span>);<br>        info.put(<span class="hljs-string">&quot;github&quot;</span>, <span class="hljs-string">&quot;github&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;users&quot;</span>, users);<br>        model.addAttribute(<span class="hljs-string">&quot;info&quot;</span>, info);<br>        model.addAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;myName&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;!DOCTYPE html&gt;<br>&lt;html lang=&quot;en&quot;&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Hello FreeMarker&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;#-- 普通变量 --&gt;<br>    &lt;div&gt;$&#123;name&#125;&lt;/div&gt;<br><br>    &lt;#-- 集合遍历 --&gt;<br>    &lt;div&gt;<br>        &lt;table border=&quot;1&quot;&gt;<br>            &lt;#list users as u&gt;<br>                &lt;tr&gt;<br>                    &lt;#-- 获取下标 --&gt;<br>                    &lt;td&gt;$&#123;u_index&#125;&lt;/td&gt;<br>                    &lt;td&gt;$&#123;u.username&#125;&lt;/td&gt;<br>                    &lt;td&gt;$&#123;u.address&#125;&lt;/td&gt;<br>                &lt;/tr&gt;<br>            &lt;/#list&gt;<br>        &lt;/table&gt;<br>    &lt;/div&gt;<br>    &lt;#-- 集合遍历，指定范围 --&gt;<br>    &lt;div&gt;<br>        &lt;table border=&quot;1&quot;&gt;<br>            &lt;#list users[3..5] as u&gt;<br>                &lt;tr&gt;<br>                    &lt;td&gt;$&#123;u.username&#125;&lt;/td&gt;<br>                    &lt;td&gt;$&#123;u.address&#125;&lt;/td&gt;<br>                &lt;/tr&gt;<br>            &lt;/#list&gt;<br>        &lt;/table&gt;<br>    &lt;/div&gt;<br>    &lt;#-- 指定输出集合中的元素 --&gt;<br>    &lt;div&gt;<br>        $&#123;users[3].username&#125;<br>    &lt;/div&gt;<br><br>    &lt;#-- Map直接获取值 --&gt;<br>    &lt;div&gt;$&#123;info.wechat&#125;&lt;/div&gt;<br>    &lt;div&gt;$&#123;info[&#x27;site&#x27;]&#125;&lt;/div&gt;<br>    &lt;#-- Map获取所有key --&gt;<br>    &lt;div&gt;<br>        &lt;#list info?keys as key&gt;<br>            &lt;div&gt;$&#123;key&#125; -- $&#123;info[key]&#125;&lt;/div&gt;<br>        &lt;/#list&gt;<br>    &lt;/div&gt;<br>    &lt;#-- Map获取所有value --&gt;<br>    &lt;div&gt;<br>        &lt;#list info?values as value&gt;<br>            &lt;div&gt;$&#123;value&#125;&lt;/div&gt;<br>        &lt;/#list&gt;<br>    &lt;/div&gt;<br><br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="内置函数和指令"><a href="#内置函数和指令" class="headerlink" title="内置函数和指令"></a>内置函数和指令</h3><h4 id="常见内置函数"><a href="#常见内置函数" class="headerlink" title="常见内置函数"></a>常见内置函数</h4><ul><li><p><strong>string</strong>函数：将一个非字符串值转换为字符串</p></li><li><p><strong>number</strong>函数：将一个字符串或其他类型的值转换为数字</p></li><li><p><strong>size</strong>函数：返回一个序列（如列表、数组、字符串等）的大小</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;users?size&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p><strong>default</strong>函数：返回第一个非空值</p></li><li><p><strong>length</strong>函数：返回字符串的长度</p></li><li><p><strong>upper_case</strong>函数：将字符串转换为大写形式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;&quot;hello&quot;?upper_case&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p><strong>lower_case</strong>函数：将字符串转换为小写形式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;&quot;HELLO&quot;?lower_case&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p><strong>cap_first</strong>函数：首字母大写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;&quot;hello&quot;?cap_first&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p><strong>trim</strong>：去掉前后空格</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;&quot; hello &quot;?trim&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p><strong>日期转换</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;$&#123;birthday?string(&quot;yyyy-MM-dd&quot;)&#125;&lt;/div&gt;<br></code></pre></td></tr></table></figure></li></ul><h4 id="常见内置指令"><a href="#常见内置指令" class="headerlink" title="常见内置指令"></a>常见内置指令</h4><ul><li><p>#<strong>if</strong>指令：用于条件判断，根据条件判断结果执行相应的操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;div&gt;<br>    &lt;#assign age=23&gt;<br>    &lt;#if (age&gt;60)&gt;老年人<br>    &lt;#elseif (age&gt;40)&gt;中年人<br>    &lt;#elseif (age&gt;20)&gt;青年人<br>    &lt;#else&gt; 少年人<br>    &lt;/#if&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure></li><li><p>#<strong>list</strong>指令：用于遍历集合（如数组、列表）并对其中每个元素执行操作</p></li><li><p>#<strong>assign</strong>指令：用于给变量赋值</p></li><li><p>#<strong>macro</strong>指令：用于定义宏（类似于函数）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#macro book bs&gt;<br>    &lt;table border=&quot;1&quot;&gt;<br>        &lt;#list bs as b&gt;<br>            &lt;tr&gt;<br>                &lt;td&gt;$&#123;b&#125;&lt;/td&gt;<br>            &lt;/tr&gt;<br>        &lt;/#list&gt;<br>    &lt;/table&gt;<br>&lt;/#macro&gt;<br>&lt;@book [&quot;三国演义&quot;,&quot;水浒传&quot;]/&gt;<br></code></pre></td></tr></table></figure><p>可以使用<code>&lt;#nested&gt;</code>作为占位符，调用宏的时候标签里的内容会填充到占位符的位置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#macro book bs&gt;<br>    &lt;table border=&quot;1&quot;&gt;<br>        &lt;#list bs as b&gt;<br>            &lt;tr&gt;<br>                &lt;td&gt;$&#123;b&#125;&lt;/td&gt;<br>            &lt;/tr&gt;<br>        &lt;/#list&gt;<br>    &lt;/table&gt;<br>    &lt;#nested&gt;<br>&lt;/#macro&gt;<br>&lt;@book [&quot;三国演义&quot;,&quot;水浒传&quot;]&gt;<br>    &lt;h1&gt;hello javaboy!&lt;/h1&gt;<br>&lt;/@book&gt;<br></code></pre></td></tr></table></figure></li><li><p>#<strong>include</strong>指令：用于在模板中引入其他模板</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#include &quot;./about.ftl&quot;&gt;<br></code></pre></td></tr></table></figure></li><li><p>#<strong>import</strong>指令：导入外部的模板</p><p>about.ftl</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#macro book bs&gt;<br>    &lt;table border=&quot;1&quot;&gt;<br>        &lt;#list bs as b&gt;<br>            &lt;tr&gt;<br>                &lt;td&gt;$&#123;b&#125;&lt;/td&gt;<br>            &lt;/tr&gt;<br>        &lt;/#list&gt;<br>    &lt;/table&gt;<br>    &lt;#nested&gt;<br>&lt;/#macro&gt;<br></code></pre></td></tr></table></figure><p>hello.ftl</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;#import &quot;./about.ftl&quot; as about&gt;<br><br>&lt;@about.book [&quot;三国演义&quot;,&quot;水浒传&quot;]&gt;<br>&lt;h1&gt;hello javaboy!&lt;/h1&gt;<br>&lt;/@about.book&gt;<br></code></pre></td></tr></table></figure></li><li><p>#<strong>noparse</strong>指令：框起来的FreeMarker语法不会被渲染</p></li></ul><h4 id="常见内置变量"><a href="#常见内置变量" class="headerlink" title="常见内置变量"></a>常见内置变量</h4><ul><li>.now：返回当前时间</li><li>.size：返回一个序列（如列表、数组、字符串等）的大小</li><li>.length：返回字符串的长度</li></ul><h2 id="SpringBoot整合FreeMarker-1"><a href="#SpringBoot整合FreeMarker-1" class="headerlink" title="SpringBoot整合FreeMarker"></a>SpringBoot整合FreeMarker</h2><h3 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h3><p>首先导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>在<code>org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration</code>为FreeMarker的自动配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AutoConfiguration</span><br><span class="hljs-meta">@ConditionalOnClass(&#123;Configuration.class, FreeMarkerConfigurationFactory.class&#125;)</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123;FreeMarkerProperties.class&#125;)</span><br><span class="hljs-meta">@Import(&#123;FreeMarkerServletWebConfiguration.class, FreeMarkerReactiveWebConfiguration.class, FreeMarkerNonWebConfiguration.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreeMarkerAutoConfiguration</span> &#123;<br>    ...<br></code></pre></td></tr></table></figure><ul><li><p><code>@ConditionalOnClass(&#123;Configuration.class, FreeMarkerConfigurationFactory.class&#125;)</code>：</p><p>当导入FreeMarker后，就会存在<code>Configuration</code>和<code>FreeMarkerConfigurationFactory</code>这两个类，自动配置类也就生效了</p></li><li><p><code>@Import(&#123;FreeMarkerServletWebConfiguration.class, </code>：</p><p>剩下的配置在类<code>FreeMarkerServletWebConfiguration</code>中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(</span><br><span class="hljs-meta">    proxyBeanMethods = false</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@ConditionalOnWebApplication(</span><br><span class="hljs-meta">    type = Type.SERVLET</span><br><span class="hljs-meta">)</span><br><span class="hljs-meta">@ConditionalOnClass(&#123;Servlet.class, FreeMarkerConfigurer.class&#125;)</span><br><span class="hljs-meta">@AutoConfigureAfter(&#123;WebMvcAutoConfiguration.class&#125;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FreeMarkerServletWebConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFreeMarkerConfiguration</span> &#123;<br>    ...<br></code></pre></td></tr></table></figure><ul><li><p><code>@ConditionalOnWebApplication(type = Type.SERVLET)</code>：配置在web环境下生效</p></li><li><p><code>@AutoConfigureAfter(&#123;WebMvcAutoConfiguration.class&#125;)</code>：自动化配置在WebMvcAutoConfiguration之后完成</p></li><li><p>这个配置类主要提供了<code>Configuration</code>和<code>freeMarkerViewResolver</code>。<code>Configuration</code>有一些基本配置，如编码、模板所在位置等；<code>freeMarkerViewResolver</code>是视图解析器，配置有后缀等属性</p></li><li><p>这个配置类的构造方法注入了<code>FreeMarkerProperties</code>，里面有一些默认的配置信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreeMarkerProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractTemplateViewResolverProperties</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_TEMPLATE_LOADER_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;classpath:/templates/&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.ftlh&quot;</span>;<br>    <span class="hljs-keyword">private</span> Map&lt;String, String&gt; settings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>    <span class="hljs-keyword">private</span> String[] templateLoaderPath = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;classpath:/templates/&quot;</span>&#125;;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> preferFileSystemAccess;<br>    ...<br></code></pre></td></tr></table></figure></li></ul></li></ul><h3 id="主要配置"><a href="#主要配置" class="headerlink" title="主要配置"></a>主要配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">freemarker:</span><br>    <span class="hljs-comment"># 模板编码</span><br>    <span class="hljs-attr">charset:</span> <span class="hljs-string">UTF-8</span><br>    <span class="hljs-comment"># 模板后缀</span><br>    <span class="hljs-attr">suffix:</span> <span class="hljs-string">.ftl</span><br>    <span class="hljs-comment"># 模板位置</span><br>    <span class="hljs-attr">template-loader-path:</span> <span class="hljs-string">classpath:/templates</span><br>    <span class="hljs-comment"># 是否开启缓存</span><br>    <span class="hljs-attr">cache:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># HttpServletRequest的属性是否可以覆盖controller中model的同名项</span><br>    <span class="hljs-attr">allow-request-override:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># HttpSession的属性是否可以覆盖controller中model的同名项</span><br>    <span class="hljs-attr">allow-session-override:</span> <span class="hljs-literal">false</span><br>    <span class="hljs-comment"># 是否检查模板位置</span><br>    <span class="hljs-attr">check-template-location:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># Content-Type的值</span><br>    <span class="hljs-attr">content-type:</span> <span class="hljs-string">text/html</span><br>    <span class="hljs-comment"># 是否将HttpServletRequest中的属性添加到Model中</span><br>    <span class="hljs-attr">expose-request-attributes:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 是否将HttpSession中的属性添加到Model中</span><br>    <span class="hljs-attr">expose-session-attributes:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>创建User类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String username;<br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-built_in">this</span>.username = username;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAddress</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> address;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAddress</span><span class="hljs-params">(String address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>创建UserController</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/index&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">index</span><span class="hljs-params">(Model model)</span> &#123;<br>        ArrayList&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            user.setId((<span class="hljs-type">long</span>) i);<br>            user.setUsername(<span class="hljs-string">&quot;name&quot;</span> + i);<br>            user.setAddress(<span class="hljs-string">&quot;address&quot;</span> + i);<br>            users.add(user);<br>        &#125;<br>        model.addAttribute(<span class="hljs-string">&quot;users&quot;</span>, users);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;index&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>创建index.ftl视图</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;!DOCTYPE html&gt;<br>&lt;html lang=<span class="hljs-string">&quot;en&quot;</span>&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;table border=<span class="hljs-string">&quot;1&quot;</span>&gt;<br>    &lt;tr&gt;<br>        &lt;td&gt;用户编号&lt;/td&gt;<br>        &lt;td&gt;用户名称&lt;/td&gt;<br>        &lt;td&gt;用户地址&lt;/td&gt;<br>    &lt;/tr&gt;<br>    &lt;#list users as user&gt;<br>        &lt;tr&gt;<br>            &lt;td&gt;$&#123;user.id&#125;&lt;/td&gt;<br>            &lt;td&gt;$&#123;user.username&#125;&lt;/td&gt;<br>            &lt;td&gt;$&#123;user.address&#125;&lt;/td&gt;<br>        &lt;/tr&gt;<br>    &lt;/#list&gt;<br>&lt;/table&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>运行，访问<code>localhost:8080/index</code></p><h2 id="静态输出文件"><a href="#静态输出文件" class="headerlink" title="静态输出文件"></a>静态输出文件</h2><p>步骤：</p><ol><li>指定模板文件</li><li>准备数据</li><li>将数据和模板结合，输出</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ftl">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=&quot;utf-8&quot;&gt;<br>    &lt;title&gt;Hello World!&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;b&gt;普通文本 String 展示：&lt;/b&gt;&lt;br&gt;&lt;br&gt;<br>Hello $&#123;name!&#x27;&#x27;&#125; &lt;br&gt;<br>&lt;hr&gt;<br>&lt;b&gt;对象Student中的数据展示：&lt;/b&gt;&lt;br/&gt;<br>姓名：$&#123;stu.name&#125;&lt;br/&gt;<br>年龄：$&#123;stu.age&#125;<br>&lt;hr&gt;<br><br>$&#123;date?string(&#x27;yyyy年MM月dd日&#x27;)&#125;<br><br>&lt;#assign text=&quot;&#123;&#x27;bank&#x27;:&#x27;工商银行&#x27;,&#x27;account&#x27;:&#x27;10101920201920212&#x27;&#125;&quot; /&gt;<br>&lt;#assign data=text?eval /&gt;<br>开户行：$&#123;data.bank&#125;  账号：$&#123;data.account&#125;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FreeMarkerTest</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> Configuration configuration;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TemplateException &#123;<br>        <span class="hljs-type">Template</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> configuration.getTemplate(<span class="hljs-string">&quot;01-basic.ftl&quot;</span>);<br><span class="hljs-comment">// 输出静态文件</span><br>        template.process(getData(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(<span class="hljs-string">&quot;d:/list.html&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> Map <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> &#123;<br>        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;freemarker&quot;</span>);<br>        map.put(<span class="hljs-string">&quot;date&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>        student.setName(<span class="hljs-string">&quot;zs&quot;</span>);<br>        student.setAge(<span class="hljs-number">18</span>);<br>        map.put(<span class="hljs-string">&quot;stu&quot;</span>, student);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>框架</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>python获取硬件参数</title>
    <link href="/2023/04/29/python/python%E8%8E%B7%E5%8F%96%E7%A1%AC%E4%BB%B6%E5%8F%82%E6%95%B0/"/>
    <url>/2023/04/29/python/python%E8%8E%B7%E5%8F%96%E7%A1%AC%E4%BB%B6%E5%8F%82%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="python获取硬件参数"><a href="#python获取硬件参数" class="headerlink" title="python获取硬件参数"></a>python获取硬件参数</h1><h2 id="psutil"><a href="#psutil" class="headerlink" title="psutil"></a>psutil</h2><blockquote><p>用于获取操作系统以及硬件相关的信息</p></blockquote><p>例</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> psutil<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu参数&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu核心数:&quot;</span>, psutil.cpu_count(logical=<span class="hljs-literal">False</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu线程数:&quot;</span>, psutil.cpu_count())<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu在用户进程上花费的时间:&quot;</span>, psutil.cpu_times().user)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu在内核上花费的时间:&quot;</span>, psutil.cpu_times().system)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu各线程使用率:&quot;</span>)<br><span class="hljs-built_in">print</span>(psutil.cpu_percent(interval=<span class="hljs-number">0.5</span>, percpu=<span class="hljs-literal">True</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;cpu频率:&quot;</span>, psutil.cpu_freq().current)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;======================================&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;内存参数&quot;</span>)<br>total = psutil.virtual_memory().total / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span><br>available = psutil.virtual_memory().available / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;内存总大小(GB):%.2f&quot;</span> % <span class="hljs-built_in">float</span>(total))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;内存剩余量(GB):%.2f&quot;</span> % <span class="hljs-built_in">float</span>(available))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;======================================&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;磁盘参数&quot;</span>)<br><span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> psutil.disk_partitions():<br>    <span class="hljs-built_in">print</span>(p.device[<span class="hljs-number">0</span>], end=<span class="hljs-string">&quot; &quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;磁盘总大小(GB):%.2f&quot;</span> % <span class="hljs-built_in">float</span>(psutil.disk_usage(p.device).total / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>), end=<span class="hljs-string">&quot; &quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;磁盘剩余量(GB):%.2f&quot;</span> % <span class="hljs-built_in">float</span>(psutil.disk_usage(p.device).free / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;======================================&quot;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;网络参数&quot;</span>)<br>last_io_counters = psutil.net_io_counters()<br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    io_counters = psutil.net_io_counters()<br>    up_speed = (io_counters.bytes_sent - last_io_counters.bytes_sent) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span><br>    down_speed = (io_counters.bytes_recv - last_io_counters.bytes_recv) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;上传速度：<span class="hljs-subst">&#123;up_speed:<span class="hljs-number">.2</span>f&#125;</span> MB/s, 下载速度：<span class="hljs-subst">&#123;down_speed:<span class="hljs-number">.2</span>f&#125;</span> MB/s&#x27;</span>)<br>    last_io_counters = io_counters<br>    time.sleep(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>React</title>
    <link href="/2023/04/26/%E5%89%8D%E7%AB%AF/react/React/"/>
    <url>/2023/04/26/%E5%89%8D%E7%AB%AF/react/React/</url>
    
    <content type="html"><![CDATA[<h1 id="React"><a href="#React" class="headerlink" title="React"></a>React</h1><p>官网：<a href="https://react.docschina.org/">React (docschina.org)</a></p><h2 id="安装React"><a href="#安装React" class="headerlink" title="安装React"></a>安装React</h2><h3 id="html中直接导入"><a href="#html中直接导入" class="headerlink" title="html中直接导入"></a>html中直接导入</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.staticfile.org/react/16.4.0/umd/react.development.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.staticfile.org/react-dom/16.4.0/umd/react-dom.development.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://cdn.staticfile.org/babel-standalone/6.26.0/babel.min.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><strong>react.min.js</strong> - React 的核心库</li><li><strong>react-dom.min.js</strong> - 提供与 DOM 相关的功能</li><li><strong>babel.min.js</strong> - Babel 可以将 ES6 代码转为 ES5 代码，这样我们就能在目前不支持 ES6 浏览器上执行 React 代码。Babel 内嵌了对 JSX 的支持。通过将 Babel 和 babel-sublime 包（package）一同使用可以让源码的语法渲染上升到一个全新的水平。</li></ul><h3 id="使用create-react-app构建项目"><a href="#使用create-react-app构建项目" class="headerlink" title="使用create-react-app构建项目"></a>使用create-react-app构建项目</h3><blockquote><p>create-react-app 是来自于 Facebook，通过该命令我们无需配置就能快速构建 React 开发环境</p></blockquote><p>官网：<a href="https://create-react-app.dev/">Create React App (create-react-app.dev)</a></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npx create-react-app my-app<br><span class="hljs-built_in">cd</span> my-app<br>npm <span class="hljs-built_in">start</span><br></code></pre></td></tr></table></figure><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h3><p>JavaScript + XML，js的语法扩展，可以在JavaScript中写XML</p><blockquote><p>使用create-react-app创建的项目中有babel，经过babel编译处理后才能在浏览器环境中使用</p></blockquote><p>例子</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span><br><br><span class="hljs-comment">// JSX来创建react元素</span><br><span class="hljs-keyword">const</span> element = (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, JSX<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>); <br><br><span class="hljs-comment">// 版本17及之前</span><br><span class="hljs-comment">// 表示将 element 这个 JSX 渲染到 id 为 root 的元素上</span><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<br>  element,<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>)<br>);<br><br><span class="hljs-comment">// 18之后的版本用ReactDOM.createRoot()</span><br><span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>));<br>root.<span class="hljs-title function_">render</span>(<br>  element<br>);<br></code></pre></td></tr></table></figure><p>注意点：</p><ol><li>React元素的属性名使用驼峰命名法</li><li>特殊属性名要转换成对应写法：class -&gt; className、for -&gt; htmlFor、tabindex -&gt; tablndex</li><li>没有子节点的React元素可以用<code>/&gt;</code>结束</li><li>推荐使用<code>()</code>包裹JSX</li></ol><h4 id="嵌入JS表达式"><a href="#嵌入JS表达式" class="headerlink" title="嵌入JS表达式"></a>嵌入JS表达式</h4><ul><li><p>语法：{JS表达式}</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">const name = &#x27;Jack&#x27;<br>const dv = (<br><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我叫: &#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>)<br></code></pre></td></tr></table></figure></li><li><p>注意点</p><ul><li>单大括号里可以直接使用js表达式</li><li>JSX自身也是JS表达式</li><li>不能在{}中出现语句(如：if&#x2F;for)</li></ul></li></ul><h4 id="条件渲染"><a href="#条件渲染" class="headerlink" title="条件渲染"></a>条件渲染</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html">const isLoading = false<br>const loadData = () =&gt; &#123;<br>  if (isLoading) &#123;<br>    return <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>  &#125;<br>  return <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>数据加载完成<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>&#125;<br><br>const root = ReactDOM.createRoot(document.getElementById(&#x27;root&#x27;));<br>root.render(<br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><br>    &#123;loadData()&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>);<br></code></pre></td></tr></table></figure><h4 id="列表渲染"><a href="#列表渲染" class="headerlink" title="列表渲染"></a>列表渲染</h4><ul><li>使用map()来渲染一组数据</li><li>列表应该添加key</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html">const songs = [<br>  &#123;id: 1, name: &#x27;a&#x27;&#125;,<br>  &#123;id: 2, name: &#x27;b&#x27;&#125;,<br>  &#123;id: 3, name: &#x27;c&#x27;&#125;,<br>]<br><br>const root = ReactDOM.createRoot(document.getElementById(&#x27;root&#x27;));<br>root.render(<br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><br>    &#123;songs.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span>&gt;</span>&#123;item.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)&#125;<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>);<br></code></pre></td></tr></table></figure><h4 id="样式处理"><a href="#样式处理" class="headerlink" title="样式处理"></a>样式处理</h4><ul><li><p>行内样式</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html">// 第一个&#123;&#125;表示嵌入表达式，第二个&#123;&#125;表示对象<br>const root = ReactDOM.createRoot(document.getElementById(&#x27;root&#x27;));<br>root.render(<br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span> = <span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">color:</span> &#x27;<span class="hljs-attr">red</span>&#x27;, <span class="hljs-attr">backgroundColor:</span> &#x27;<span class="hljs-attr">skyblue</span>&#x27; &#125;&#125;&gt;</span><br>    样式处理<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>);<br></code></pre></td></tr></table></figure></li><li><p>类名</p><p><strong>记得导入</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html">// App.js<br>import &#x27;./index.css&#x27;;<br><br>const root = ReactDOM.createRoot(document.getElementById(&#x27;root&#x27;));<br>root.render(<br>  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#x27;title&#x27;</span>&gt;</span><br>    样式处理<br>  <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>);<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">// index<span class="hljs-selector-class">.css</span><br><br><span class="hljs-selector-class">.title</span> &#123;<br>  <span class="hljs-attribute">text-align</span>: center;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h3><p><code>props</code>是父组件传给子组件的属性（只读，单向）</p><p>定义组件方式1：函数式</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComp</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>hello &#123;props.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义组件方式2：类组件式，需要继承React.Component，需要定义render方法</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>;<br><br><span class="hljs-comment">// 继承于 React.Component</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyComp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>   <span class="hljs-comment">// 类似构造函数</span><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(props); <br>  &#125;<br>  <br>   <span class="hljs-comment">// 返回展示的视图结构</span><br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// render 方法返回需要展示的视图结构——React元素</span><br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>hello &#123;this.props.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="类组件生命周期"><a href="#类组件生命周期" class="headerlink" title="类组件生命周期"></a>类组件生命周期</h3><p><img src="/img/qianduan/React%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png"></p><p>挂载阶段</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) <span class="hljs-comment">// class 的构造方法，在其中 super(props) 接收参数</span><br><br><span class="hljs-title function_">componentWillMount</span>() <span class="hljs-comment">// 挂载前</span><br><br><span class="hljs-title function_">render</span>() <span class="hljs-comment">// 返回React元素</span><br><br><span class="hljs-title function_">componentDidMount</span>() <span class="hljs-comment">// 挂载后</span><br></code></pre></td></tr></table></figure><p>更新阶段</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">componentWillReceiveProps</span>(nextProps) <span class="hljs-comment">// props 变化时调用，nextProps 是新参数</span><br><br><span class="hljs-title function_">shouldComponentUpdate</span>(nextProps, nextState) <span class="hljs-comment">// 是否继续执行更新过程，返回一个布尔值</span><br><br><span class="hljs-title function_">componentWillUpdate</span>(nextProps, nextState) <span class="hljs-comment">// 更新前</span><br><br><span class="hljs-title function_">render</span>()<br><br><span class="hljs-title function_">componentDidUpdate</span>(prevProps, prevState) <span class="hljs-comment">// 更新后</span><br></code></pre></td></tr></table></figure><p>卸载阶段</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"></span>) &#123; &#125; <span class="hljs-comment">// 组件被删除前调用，执行一些清理工作</span><br></code></pre></td></tr></table></figure><h3 id="state-amp-props"><a href="#state-amp-props" class="headerlink" title="state&amp;props"></a>state&amp;props</h3><p><strong>props</strong>：是父组件传给子组件的属性（只读，单向）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">HelloWorld</span> = (<span class="hljs-params">props</span>) =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Hello &#123;props.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">HelloWorld</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Someone :)&quot;</span>/&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>state：组件自己的数据</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyComp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(props);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = &#123;<br>      <span class="hljs-attr">time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),<br>    &#125;;<br>  &#125;<br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Its &#123;this.state.time&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h2><ol><li><p>创建项目</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npx create-react-app my-app<br></code></pre></td></tr></table></figure></li><li><p>精简项目</p><p>将public目录里除了<code>favicon.ico</code>和<code>index.html</code>的文件删掉</p><p>将src里除了<code>App.js</code>的文件删掉，创建<code>index.js</code></p></li><li></li></ol>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// App.js</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br><br>  <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;App&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello World<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;<br><br></code></pre></td></tr></table></figure>   <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// index.js</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-dom&quot;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./App&quot;</span><br><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>))<br></code></pre></td></tr></table></figure>   <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html">// index.html<br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;icon&quot;</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;%PUBLIC_URL%/favicon.ico&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;viewport&quot;</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;width=device-width, initial-scale=1&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>React App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span>You need to enable JavaScript to run this app.<span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;root&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p><img src="/img/qianduan/%E9%A1%B9%E7%9B%AE%E6%8E%A8%E8%8D%90%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>计算机网络</title>
    <link href="/2023/04/15/%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"/>
    <url>/2023/04/15/%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/</url>
    
    <content type="html"><![CDATA[<h2 id="计算机网络"><a href="#计算机网络" class="headerlink" title="计算机网络"></a>计算机网络</h2><h3 id="网络体系结构"><a href="#网络体系结构" class="headerlink" title="网络体系结构"></a>网络体系结构</h3><p><img src="/img/inter_img/%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png" alt="网络体系结构"></p><p>应用层：用户访问网络的接口</p><p>传输层：进程间通信</p><p>网络层：选择合适路由和交换节点，完成任意两台主机间通信</p><p>数据链路层：IP数据报封装成帧在相邻节点间传输</p><p>物理层：相邻节点比特流的透明传输</p><h3 id="各层协议"><a href="#各层协议" class="headerlink" title="各层协议"></a>各层协议</h3><p><img src="/img/inter_img/%E5%90%84%E5%B1%82%E5%8D%8F%E8%AE%AE.png" alt="网络体系结构"></p><h3 id="数据各层传输方式"><a href="#数据各层传输方式" class="headerlink" title="数据各层传输方式"></a>数据各层传输方式</h3><p>从上到下给数据包装，从下到上解包装</p><p><strong>传输层</strong>：TCP：报文，UDP：用户数据报</p><p><strong>网络层</strong>：IP数据报</p><p><strong>数据链路层</strong>：帧</p><p><strong>物理层</strong>：数据比特流</p><p><img src="/img/inter_img/%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B.png" alt="请求解析过程"></p><h3 id="DNS解析过程"><a href="#DNS解析过程" class="headerlink" title="DNS解析过程"></a>DNS解析过程</h3><p>域名和IP相互映射</p><p>输入域名 –&gt; 浏览器缓存找 –&gt; 本地Host缓存 –&gt; 本地DNS服务器 –&gt; </p><p>(根域名服务器（返回顶级域名服务器地址） –&gt; 顶级域名服务器(com，返回权限域名服务器地址) –&gt; 权限域名服务器(<a href="http://www.baidu,返回请求域名的ip/">www.baidu，返回请求域名的ip</a>))</p><p><img src="/img/inter_img/%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90.png" alt="请求解析过程"></p><h3 id="三次握手四次挥手"><a href="#三次握手四次挥手" class="headerlink" title="三次握手四次挥手"></a>三次握手四次挥手</h3><blockquote><p>TCP 建立连接、断开连接的过程</p></blockquote><p><strong>三次握手</strong>（建立连接）：</p><p>​<img src="/img/inter_img/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png"></p><ul><li><p>SYN（Synchronize Sequence Numbers）：同步序列号</p></li><li><p>ACK（Acknowledgement Number）：确认编号</p></li><li><p>三次握手是为了解决由于网络阻塞等原因一个请求建立报文没有传送到服务器，客户端又发送一个请求连接的报文给服务端，服务端收到了这次的报文；但之前滞留在网络中的报文又到达了服务端，服务端误以为是客户端发起了新的连接，造成客户端和服务端的状态不一致，服务端会一直等待客户端发送数据。（<strong>在不可靠的信道上建立可靠的数据连接</strong>）</p></li></ul><p>传输确认：</p><p>​<img src="/img/inter_img/%E4%BC%A0%E8%BE%93%E7%A1%AE%E8%AE%A4.png"></p><ul><li>服务端将发送缓存区的数据按序列号传送，客户端收到后回复一个ACK，ACK包含了一下个请求传输的序列号，如果没有收到可以要求服务端重传</li></ul><p><strong>四次挥手</strong>：</p><p>​<img src="/img/inter_img/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.png"></p><ul><li>第一次、第二次挥手：客户端发送FIN，客户端和服务端进入将要关闭状态，此时服务端还可以发送未发完的数据</li><li>第三次、第四次挥手：服务端发送完消息，发送FIN，客户端收到后回复ACK并等待一段时间（报文最长生存时间*2）后关闭（防止由于网络问题导致服务端没收到，从而服务端没有关闭连接），服务端收到ACK后关闭。</li><li>四次挥手是为了把数据传完</li></ul><h3 id="TCP、UDP比较"><a href="#TCP、UDP比较" class="headerlink" title="TCP、UDP比较"></a>TCP、UDP比较</h3><p>TCP：</p><ul><li><p>面向连接，点对点，全双工通信，面向字节流，拥塞控制</p></li><li><p>稳定可靠，适用于对网络通讯质量要求较高的场景，如传输文件、浏览网页</p></li><li><p>基于TCP的应用层协议有HTTP、FTP、SMTP、SSH等</p></li></ul><p>UDP：</p><ul><li><p>面向报文，可一对多，头部短(8Byte)</p></li><li><p>速度快，适用于对实时性要求高的场景，如语音通话、直播</p></li><li><p>基于UDP的应用层协议有DNS、TFTP、SNMP等</p></li></ul><h3 id="TCP头部字段"><a href="#TCP头部字段" class="headerlink" title="TCP头部字段"></a>TCP头部字段</h3><p><img src="/img/inter_img/TCP%E6%8A%A5%E5%A4%B4.png"></p><ul><li><strong>序号</strong>：假设A和B通讯，A发送给B的第一个报文中的序号为一个随机的ISN（初始序号值），后续发送的报文序号为ISN+携带数据的第一个字节在字节流中的偏移量</li><li><strong>确认号</strong>：在收到的报头的序号上+1</li><li><strong>头部长度</strong>：表示TCP头部有多少个32bit的字，TPC头部长度范围为20Byte ~ 15*4Byte &#x3D; 60Byte</li><li><strong>标志位</strong>：<ul><li>ACK：表示确认号是否有效，携带ACK的报文段为<strong>确认报文段</strong></li><li>SYN：表示请求建立连接，携带SYN的报文段为<strong>同步报文段</strong></li><li>FIN：表示通知对方本端要关闭连接，携带FIN的报文段为<strong>结束报文端</strong></li></ul></li><li><strong>窗口大小</strong>：告诉发送端本端的接收缓冲区还剩多少，用来TCP流量控制</li></ul><h3 id="粘包、半包"><a href="#粘包、半包" class="headerlink" title="粘包、半包"></a>粘包、半包</h3><p>粘包：多个包一起发送</p><p>半包：一个包拆成多个发送</p><p>解决方式：</p><ol><li>在数据尾部添加特殊字符进行分割</li><li>发送分为头部和内容，头部里声明了内容的大小</li></ol><h3 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h3><p>拥塞窗口：每次发送多少个数据包</p><p><strong>慢开始</strong>：开始时不知道当前网络状况，因此从1开始指数增加拥塞窗口的大小</p><p><strong>拥塞避免</strong>：当拥塞窗口到达阈值后线性增长，当出现超时事件时拥塞窗口变为1并降低阈值（此时的拥塞窗口大小&#x2F;2）</p><p><img src="/img/inter_img/%E6%8B%A5%E5%A1%9E%E9%81%BF%E5%85%8D.png"></p><p><strong>快重传</strong>：如果是因为丢包而不是网络阻塞造成没有收到数据包，接收方若在数据包超时时间内连续收到三个同一个包的确认收到消息，就认为是丢包了，会立即重新传这个包的下一个包，而不是等到超时时间</p><p><img src="/img/inter_img/%E5%BF%AB%E9%87%8D%E4%BC%A0.png"></p><p><strong>快恢复</strong>：快重传后把阈值降为拥塞窗大小的一半，把拥塞窗口降为阈值而不是1</p><h3 id="常见状态码"><a href="#常见状态码" class="headerlink" title="常见状态码"></a>常见状态码</h3><p>200：请求成功；</p><p>301：永久重定向；302：临时重定向；</p><p>404：无法找到此页面；405：请求的方法类型不支持；</p><p>500：服务器内部出错。</p><h3 id="URI和URL"><a href="#URI和URL" class="headerlink" title="URI和URL"></a>URI和URL</h3><ul><li>URI，全称是Uniform Resource Identifier，中文翻译是统一资源标志符，主要作用是唯一标识一个资源。</li><li>URL，全称是Uniform Resource Location，中文翻译是统一资源定位符，主要作用是提供资源的路径。</li></ul><h3 id="Cookie-x2F-Session"><a href="#Cookie-x2F-Session" class="headerlink" title="Cookie&#x2F;Session"></a>Cookie&#x2F;Session</h3><p><strong>cookie</strong>：</p><ol><li>服务端servlet创建cookie，保存少量数据，发送给浏览器。</li><li>浏览器获得服务器发送的cookie数据，将自动的保存到浏览器端。</li><li>下次访问时，浏览器将自动携带cookie数据（到请求头）发送给服务器。</li></ol><p>session：</p><ol><li>服务端判断浏览器端请求是否包含session标识，没有则创建session并返回sessionId（通过cookie）</li><li>浏览器端之后的请求都携带sessionId</li><li>session在超时时间过后销毁，而不是关闭浏览器</li></ol><h3 id="WebSocket-x2F-Socket"><a href="#WebSocket-x2F-Socket" class="headerlink" title="WebSocket&#x2F;Socket"></a>WebSocket&#x2F;Socket</h3><p>​Socket是一套标准，它完成了对TCP&#x2F;IP的高度封装，屏蔽网络细节，以方便开发者更好地进行网络编程。Socket其实就是等于<strong>IP地址 + 端口 + 协议</strong>。</p><p>​WebSocket是一个持久化的协议，它是伴随H5而出的协议，用来解决<strong>http不支持持久化连接</strong>的问题。</p><p>Socket一个是<strong>网编编程的标准接口</strong>，而WebSocket则是应用层通信协议。</p><h3 id="网络攻击"><a href="#网络攻击" class="headerlink" title="网络攻击"></a>网络攻击</h3><p><strong>CSRF</strong>：Cross-site request forgery，跨域请求伪造。挟制用户在当前已登录的Web应用程序上执行非本意的操作的攻击方法</p><p><strong>XSS</strong>：Cross-Site Scripting，跨域脚本攻击。往Web页面里插入恶意html代码</p><p><strong>盗链</strong>：获取其他网站的资源展示在自己的网站上。可以通过检查referer头部字段来检查请求来源，从而防盗链</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>网络</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>MySQL</title>
    <link href="/2023/04/12/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MySQL/"/>
    <url>/2023/04/12/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MySQL/</url>
    
    <content type="html"><![CDATA[<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><h4 id="SQL语言"><a href="#SQL语言" class="headerlink" title="SQL语言"></a>SQL语言</h4><p>DDL（Data Definition Language）：定义&#x2F;改变表</p><p>DML（Data Manipulation Language）：数据的增删改</p><p>DQL（Data Query Language）：数据的查询</p><p>DCL（Data Control Language）：设置&#x2F;更改用户权限</p><h4 id="事务的四大特性ACID"><a href="#事务的四大特性ACID" class="headerlink" title="事务的四大特性ACID"></a>事务的四大特性ACID</h4><p>原子性：Atomicity，事务是不可分割的最小操作单元</p><p>一致性：Consistency，事务完成时，必须使所有的事务都保持一致状态</p><p>隔离性：Isolation，事务不受外部影响</p><p>持久性：Durability，事务一旦提交或回滚，对数据库的改变是永久的</p><h4 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h4><p>读未提交：可以读到事务未提交的数据</p><p>读已提交：只能读到事务已提交的数据</p><p>可重复读（默认）：限制了读数据的时候不能更改数据，同一事务的多个实例在并发读取数据时，会看到同样的数据行</p><p>串行化：事务间串行执行</p><h3 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h3><blockquote><p>存储引擎就是存储数据、建立索引、更新&#x2F;查询数据等技术的实现方式</p><p>不同表可以有不同的存储引擎</p></blockquote><h4 id="MySQL体系结构"><a href="#MySQL体系结构" class="headerlink" title="MySQL体系结构"></a>MySQL体系结构</h4><p><img src="/img/sql_img/MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png"></p><ul><li>连接层：对客户端的连接服务，如连接处理、授权认证等</li><li><strong>服务层</strong>：大多数核心服务功能，如SQL接口、SQL分析和优化、过程、函数等</li><li><strong>引擎层</strong>：负责MySQL中数据的存储和提取，不同的存储引擎具有不同的功能（索引是由存储引擎实现）</li><li>存储层：将数据存储在文件系统之上</li></ul><h4 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h4><ol><li><p>查看数据库支持的存储引擎</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show engines<br></code></pre></td></tr></table></figure></li><li><p>创建表时指定存储引擎（默认InnoDB）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE TABLE my_myisam(<br>id INT,<br>NAME VARCHAR(10)<br>) ENGINE = MYISAM;<br></code></pre></td></tr></table></figure></li></ol><h4 id="存储引擎特点"><a href="#存储引擎特点" class="headerlink" title="存储引擎特点"></a>存储引擎特点</h4><p><strong>InnoDB</strong>：</p><ol><li><strong>支持事务</strong></li><li><strong>行级锁</strong>，提高并发访问度</li><li><strong>支持外键</strong></li><li>每一个innodb引擎数据表都对应着一个xxx.ibd文件</li></ol><p><img src="/img/sql_img/InnoDB%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt="InnoDB存储结构"></p><p><strong>MyISAM</strong>：</p><ol><li>早期默认存储引擎</li><li>不支持事务和外键</li><li>只支持表锁，不支持行锁</li><li>访问速度快</li></ol><p><strong>Memory</strong>：</p><ol><li>数据存在内存，访问速度快</li><li>支持hash索引</li></ol><h4 id="选择存储引擎"><a href="#选择存储引擎" class="headerlink" title="选择存储引擎"></a>选择存储引擎</h4><p><strong>InnoDB</strong>：对事务的完整性、并发性要求比较高时</p><p>MyISAM：以读操作和插入操作为主，很少更新和删除，对完整性、并发性要求不高时，如日志、评论 –&gt; (MongoDB)</p><p>MEMORY：缓存 –&gt;（Redis）</p><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><blockquote><p>索引是帮助MySQL<strong>高效获取</strong>数据的<strong>数据结构</strong>（<strong>有序</strong>），这种数据结构以某种方式引用（指向）数据。</p></blockquote><h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p>优点：</p><ul><li><p>提高数据检索效率，降低数据库的IO成本</p></li><li><p>通过索引列队数据进行排序，降低数据的排序成本</p></li></ul><p>缺点：</p><ul><li>索引需要占用空间</li><li>需要维护索引，降低了增删改的效率</li></ul><h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>存储引擎主要使用的数据结构有：</p><table><thead><tr><th>索引结构</th><th>描述</th></tr></thead><tbody><tr><td><strong>B+Tree索引</strong></td><td>最常见的索引类型</td></tr><tr><td>Hash索引</td><td>用哈希表实现，只能精确匹配</td></tr><tr><td>R-Tree（空间索引）</td><td>MyISAM引擎中的索引类型，用于地理空间查询</td></tr><tr><td>Full-text（全文索引）</td><td>通过倒排索引，快速匹配文档的方式</td></tr></tbody></table><p><strong>索引结构</strong>：</p><ul><li><p>二叉查找树：左小右大，顺序插入时会形成一棵单叉的树，查询性能大大降低</p></li><li><p>红黑树：大数据量的情况下，层级较深，检索速度慢</p></li><li><p><strong>B-Tree</strong>（多路平衡树）：一个节点下可以有多个子节点</p><ul><li><p>节点的度数：节点的子节点个数；树的度数：最大度数</p></li><li><p>一个N阶（度数为N）的B-Tree的节点最多可以有N-1个Key，N个指针</p><p><img src="/img/sql_img/B-Tree%E7%BB%93%E6%9E%84.png"></p></li><li><p>构建过程：</p><ul><li><p>插入一个元素，要插入的节点还放的下的时候按顺序放入节点</p></li><li><p>放不下时中间元素往上层移动，左右两边分裂成两个节点</p><p><img src="/img/sql_img/B-Tree%E5%88%86%E8%A3%821.png"></p></li><li><p>上层也放不下时，上层也分裂</p><p><img src="/img/sql_img/B-Tree%E5%88%86%E8%A3%822.png"></p></li></ul></li></ul></li><li><p><strong>B+Tree</strong>：和B-Tree类似，但非叶子节点起到索引的作用，数据都存在叶子节点，叶子结点形成一个<strong>单向链表</strong></p><p><img src="/img/sql_img/B+Tree%E7%BB%93%E6%9E%84.png"></p><ul><li>MySQL和在经典B+Tree上进行了优化，叶子节点形成一个<strong>双向循环链表</strong>，提高区间访问的性能</li></ul></li><li><p>Hash：采用一定的hash算法，将键值转换为新的hash值，存储到hash表中</p></li></ul><blockquote><p>InnoDB使用B+Tree的原因：相对二叉树层级更少；相对于B-Tree，非叶子节点不存放数据，能够放的key更多，层级也就更少；相对于Hash，能支持范围匹配和排序。</p></blockquote><h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>根据字段特性分类</p><table><thead><tr><th>分类</th><th>含义</th><th>特点</th><th>关键字</th></tr></thead><tbody><tr><td>主键索引</td><td>针对主键创建的索引</td><td>自动创建，只能有一个</td><td>PRIMARY</td></tr><tr><td>唯一索引</td><td>避免值重复</td><td>可有多个</td><td>UNIQUE</td></tr><tr><td>常规索引</td><td>快速定位特定数据</td><td>可有多个</td><td></td></tr><tr><td>全文索引</td><td>通过文本中的关键字查找</td><td>可有多个</td><td>FULLTEXT</td></tr></tbody></table><p> 在InnoDB中，根据索引的存储形式，可以分为</p><table><thead><tr><th>分类</th><th>含义</th><th>特点</th></tr></thead><tbody><tr><td>聚簇索引(Clustered Index)</td><td>将数据与索引放到了一块，叶子节点保存了行数据</td><td>有且只有一个</td></tr><tr><td>二级索引(Secondary Index)</td><td>将数据与索引分开存储，叶子节点关联的是对应的主键</td><td>可以存在多个</td></tr></tbody></table><blockquote><p>走二级索引需要通过查到的主键回表查询</p></blockquote><h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><ul><li><p>创建索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE [UNIQUE|FULLTEXT] INDEX index_name ON table_name(index_col_name, ...);<br></code></pre></td></tr></table></figure></li><li><p>查看索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW INDEX FROM table_name;<br></code></pre></td></tr></table></figure></li><li><p>删除索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP INDEX index_name ON table_name;<br></code></pre></td></tr></table></figure></li></ul><h4 id="SQL性能分析"><a href="#SQL性能分析" class="headerlink" title="SQL性能分析"></a>SQL性能分析</h4><p><strong>查看当前数据库执行频率</strong></p><blockquote><p>查询频率高的数据库需要优化</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW GLOBAL STATUS LIKE &#x27;com_______&#x27;;<br></code></pre></td></tr></table></figure><p><img src="/img/sql_img/%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE%E5%BA%93%E6%89%A7%E8%A1%8C%E9%A2%91%E7%8E%87.png"></p><p><strong>慢查询日志</strong></p><p>记录了所有指定执行时间超过指定参数的所有SQL语句的日志</p><ul><li><p>查看是否开启日志</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW VARIABLES LIKE &#x27;slow_query_log&#x27;;<br></code></pre></td></tr></table></figure></li><li><p>开启日志(windows下)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 修改MySQL目录下的my.ini<br>slow-query-log=1<br>long_query_time=10<br></code></pre></td></tr></table></figure></li><li><p>日志保存在Data目录下的<code>xxx-slow.log</code>下</p></li></ul><p><strong>profile</strong></p><p>查看每一条sql的耗时情况</p><ul><li><p>查看、开启profile</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT @@have_profiling;<br>SET have_profiling = 1;<br></code></pre></td></tr></table></figure></li><li><p>查看每一条SQL的耗时进本情况</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW PROFILES;<br></code></pre></td></tr></table></figure></li><li><p>查看指定query_id的SQL语句各个阶段的耗时情况</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW profile for query_id;<br></code></pre></td></tr></table></figure></li></ul><p><strong>explain</strong></p><ul><li>在select之前加上explain</li></ul><p></p><p><img src="/img/sql_img/explain.png"></p><p>字段含义：</p><ol><li>id：表示执行顺序，相同的从上到下，不同的值大的先执行</li><li>type:表示连接类型，性能上从高到低<ul><li>NULL </li><li>system </li><li>const：结果只有一条</li><li>eq_ref：唯一索引扫描</li><li>ref：非唯一索引扫描</li><li>range：索引范围扫描</li><li>index：全索引扫描</li><li>all：全表扫描</li></ul></li><li>possible_keys：字段表示可能用到的索引；</li><li>key：实际用到的索引</li><li>key_len：索引长度</li><li>rows：扫描的数据行数</li><li>filtered：返回结果的行数占读取行数的百分比，越大越好</li></ol><h4 id="使用规则"><a href="#使用规则" class="headerlink" title="使用规则"></a>使用规则</h4><ul><li><p><strong>最左前缀法则</strong>：联合索引从最左边开始匹配。最左边的列必须有才走索引，如果中间有列不存在，则后面的索引失效。创建联合索引时要考虑顺序</p></li><li><p><strong>范围查询</strong>：联合索引中，出现<code>&gt;</code>、<code>&lt;</code>范围查询时，之后的索引会失效，<code>&gt;=</code>、<code>&lt;=</code>不会失效</p></li><li><p><strong>索引失效情况</strong>：</p><ol><li>使用<code>&gt;</code>&#x2F;<code>&lt;</code>范围查询（<code>&gt;=</code>、<code>&lt;=</code>、<code>BETWEEN AND</code>仍可以使用到索引）</li><li>在索引列上进行运算操作</li><li>字符串不加引号，存在隐式类型转换</li><li>在头部进行模糊匹配</li><li>or连接的条件中有没有索引的列时，不管有多少索引，都必须全表扫描搜索这个没有索引的列</li><li>MySQL评估使用索引比全表扫描更慢，则不使用索引</li></ol></li><li><p><strong>SQL提示</strong>：</p><ol><li><p>use index：提示优化器<strong>建议</strong>使用哪个索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">explain select * from tb_user use index(idx_user_pro) where profession = &#x27;软件工程&#x27;;<br></code></pre></td></tr></table></figure></li><li><p>ignore index：提示优化器不使用哪个索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">explain select * from tb_user ignore index(idx_user_pro) where profession = &#x27;软件工程&#x27;;<br></code></pre></td></tr></table></figure></li><li><p>force index：提示优化器<strong>必须</strong>使用哪个索引</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">explain select * from tb_user force index(idx_user_pro) where profession = &#x27;软件工程&#x27;;<br></code></pre></td></tr></table></figure></li></ol></li><li><p><strong>覆盖索引</strong></p><p>查询使用了索引，并且需要返回的列在索引中已经能全部找到，就不需要再回表查询。</p><p>如给id和name建立了索引，那<code>select id,name</code>时就不需要回表查询</p><blockquote><p>尽量少使用select *，因为容易回表查询</p></blockquote></li><li><p><strong>前缀索引</strong></p><p>根据字符串的一部分前缀建立索引，适合大文本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE INDEX idx_xxx ON table_name(column(n));<br></code></pre></td></tr></table></figure><p>可以通过<code>count(distinct substring(column, m, n))/count(*)</code>来判断适不适合建立前缀索引，值越大越好。</p></li></ul><h4 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h4><ol><li>数据量大（&gt;100w）</li><li>针对常作为查询条件(Where)、排序(Order By)、分组(Group By)的字段</li><li>索引把区分度高的字段排在前面</li><li>较长的字符串字段建立联合索引</li><li>尽量建立联合索引</li><li>要控制索引的数量</li></ol><h3 id="SQL优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h3><h4 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h4><ol><li><p>批量插入，不要一条一条插</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">insert into tb_test valies(1, &#x27;Tome&#x27;), ...;<br></code></pre></td></tr></table></figure></li><li><p>手动提交事务，默认是执行一次insert提交一次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">start transaction;<br>insert ...<br>commit;<br></code></pre></td></tr></table></figure></li><li><p>主键顺序插入性能高于乱序</p></li><li><p>大批量插入数据时用load</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 客户端连接服务端时，加上参数 --local-infile<br>mysql --local-infile -uroot -p<br># 设置全局参数local_infile为1，开启从本地加载文件导入数据的开关<br>set global local_infile=1;<br># 执行load指令将准备好的数据导入，设置字段间分隔符为&#x27;,&#x27;，数据间分隔符为&#x27;\n&#x27;<br>load data local infile &#x27;文件路径.sql&#x27; into table `表名` fileds teminatedby &#x27;,&#x27; lines teminatedby by &#x27;\n&#x27;;<br></code></pre></td></tr></table></figure></li></ol><h4 id="主键"><a href="#主键" class="headerlink" title="主键"></a>主键</h4><ol><li>满足业务需求的情况下，尽量降低主键的长度</li><li>尽量不要使用UUID或其他随机的主键，会造成页分裂</li><li>业务操作时，避免对主键的修改</li></ol><h4 id="排序-x2F-分组"><a href="#排序-x2F-分组" class="headerlink" title="排序&#x2F;分组"></a>排序&#x2F;分组</h4><p>排序：</p><p>​Using filesort：通过索引或全表扫描查找出满足条件的数据行，在缓冲区里排序</p><p>​Using index：通过索引查找出的数据直接就是有序的，效率高</p><p>​创建联合索引后，如果都按升序或降序排序都是Using index，如果不一样就会Using filesort</p><p>​可以创建联合索引时指定排序方式来优化</p><p>分组：</p><p>​分组时可以通过索引来提高效率</p><p>​分组时索引的1使用也满足最左前缀法则</p><h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p>问题：</p><p>​<code>order by id limit 200000, 10</code>需要查出前200010条数据排序后返回后10条记录，其他数据丢弃，查询排序的代价非常大</p><p>解决方式：</p><p>​使用延迟关联的方式：例如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT <br>s.* <br>FROM <br>tb_sku s, (SLECT id FROM tb_sku ORDER BY id LIMIT 200000, 10) a <br>WHERE<br>s.id = a.id;<br></code></pre></td></tr></table></figure><p>​如果直接分页查询，那么查到id后都要回表查询，效率很低；而子查询里分页的话，因为二级索引里有id了，不需要回表查询，减少了回表查询的次数</p><h4 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h4><p>用法：</p><ol><li>*<em>count(</em>)**：返回数据行数   （性能最高，优化器做了优化，不会把值取出来）</li><li>count(主键)：返回非空的主键数</li><li>count(某个字段)：返回非空的字段数</li><li>count(1)：当做每行都是1，记录数据行数</li></ol><h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><p>InnoDB的行锁是针对的索引加的锁，不是针对记录加的锁，并且该索引不能失效，否则从行锁升级为表锁</p><p>所以更新条件有索引为行锁，没有索引为表锁</p><h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><blockquote><p>视图是张虚表，不保存查询结果，只保存了查询的SQL逻辑</p></blockquote><h4 id="语法-1"><a href="#语法-1" class="headerlink" title="语法"></a>语法</h4><ol><li><p>创建</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE [OR REPLACE] VIEW 视图名 AS SELECT 列 FROM 基表 [WHERE...];<br><br># 检查选项：对增删改进行约束<br># 后面加 WITH [CASCADED | LOCAL] CHECK OPTION<br># 如果是根据视图创建的视图<br># CASCADED会检查父视图的条件，不管父视图有没有加CHECK OPTION<br># LOCAL只会检查加了CHECK OPTION的父视图的条件<br></code></pre></td></tr></table></figure></li><li><p>查询</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># 查询创建视图的语句<br>SHOW CREATE VIEW 视图名;<br># 查询视图数据<br>SELECT * FROM 视图名 ...;<br></code></pre></td></tr></table></figure></li><li><p>修改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER VIEW 视图名 AS SELECT...;<br></code></pre></td></tr></table></figure></li><li><p>删除</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP VIEW 视图名;<br></code></pre></td></tr></table></figure></li><li><p>插入、更新数据</p><p>只有视图的列和基表的列相同时才能更新</p></li></ol><h3 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h3><blockquote><p>多条sql的集合</p></blockquote><h4 id="语法-2"><a href="#语法-2" class="headerlink" title="语法"></a>语法</h4><ul><li><p>创建</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE PROCEDURE 名称(参数)<br>BEGIN<br>-- SQL语句<br>END;<br></code></pre></td></tr></table></figure></li><li><p>调用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CALL 名称(参数);<br></code></pre></td></tr></table></figure></li><li><p>查看存储过程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SHOW CREATE PROCEDURE 名称;<br></code></pre></td></tr></table></figure></li><li><p>删除</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP PROCEDURE 名称;<br></code></pre></td></tr></table></figure></li><li><p>声明局部变量</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create procedure p1()<br>begin<br># 声明变量<br>declare stu_count int default 0;<br>    # 第一种赋值方式<br>set stu_count := 10;<br># 第二种赋值方式<br>select count(*) into stu_count from student;<br># 查看<br>select stu_count;<br>end;<br></code></pre></td></tr></table></figure></li><li><p>IF</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mysql">IF 条件1 THEN<br>...<br>ELSEIF 条件2 THEN<br>...<br>ELSE<br>...<br>END IF;<br></code></pre></td></tr></table></figure></li><li><p>参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 参数类型<br>-- IN 传入的参数（默认）<br>-- OUT 输出的参数<br>-- INOUT 可输入可输出的参数<br>create procedure p(in score int, out res varchar(10))<br>begin<br>if score &gt;= 85 then<br>set res := &#x27;优秀&#x27;;<br>elseif score &gt;= 60 then<br>set res := &#x27;及格&#x27;;<br>else<br>set res := &#x27;不及格&#x27;;<br>end if;<br>end;<br><br>-- 调用<br>call p(68, @res);<br>select @res;<br><br><br>-- inout<br>create procedure p2(inout score double)<br>begin<br>set score := score * 0.5;<br>end;<br><br>set @score = 78;<br>call p2(@score);<br>select @score;<br></code></pre></td></tr></table></figure></li><li><p>CASE</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CASE<br>WHEN 条件 THEN:<br>...<br>WHEN 条件 THEN:<br>...<br>ELSE<br>...<br>END CASE;<br></code></pre></td></tr></table></figure></li><li><p>WHILE：满足条件继续循环</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">create procedure p(in n int)<br>begin<br>declare total int default 0;<br>while n &gt; 0 do<br>set total := total + n;<br>set n := n - 1;<br>end while;<br>select total;<br>end;<br></code></pre></td></tr></table></figure></li><li><p>REPEAT：满足条件退出循环</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 满足条件后退出循环<br>create procedure p(in n int)<br>begin<br>declare total int default 0;<br>repeat<br>set total := total + n;<br>set n ;= n - 1;<br>until n &lt;= 0<br>end repeat;<br><br>select total;<br>end;<br></code></pre></td></tr></table></figure></li></ul><h3 id="存储函数"><a href="#存储函数" class="headerlink" title="存储函数"></a>存储函数</h3><blockquote><p>存储函数是有返回值的存储过程，参数只能是IN类型的</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE FUNCTION 名称(参数)<br>RETURNS 返回值类型 [characteristic...]<br>BEGIN<br>...<br>RETURN 返回值;<br>END;<br><br>characteristic说明：<br>DETERMINSTIC：相同的输入参数总是返回相同的结果<br>NO SQL：不包含SQL语句<br>READS SQL DATA：包含读取数据的语句，但不包含写入数据的语句<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 调用<br>函数名(参数);<br></code></pre></td></tr></table></figure><h3 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h3><blockquote><p>在增删改之前或之后，触发并执行触发器里的SQL，可用于记录日志、数据校验等</p><p>触发器只支持行级触发（即修改一行时触发一次），不支持语句级触发</p></blockquote><h4 id="语法-3"><a href="#语法-3" class="headerlink" title="语法"></a>语法</h4><blockquote><p>NEW表示更新之后的数据，OLD表示更新之前的数据</p><p>可以选择 BEFORE&#x2F;AFTER   INSERT&#x2F;UPDATE&#x2F;DELETE</p></blockquote><p>例子</p><ul><li><p>创建</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 通过触发器记录user表的变更到user_log表中<br>create table user_logs(<br>    id int(11) not null auto_increment,<br>    operation varchar(20) comment &#x27;操作类型&#x27;,<br>    operation_time datetime comment &#x27;操作时间&#x27;,<br>    operation_id int(11) comment &#x27;操作id&#x27;,<br>    operation_params varchar(500) comment &#x27;操作参数&#x27;,<br>    primary key(&#x27;id&#x27;)<br>);<br><br><br>CREATE TRIGGER tb_user_insert_trigger<br>AFTER INSERT ON tb_user for each row<br>BEGIN<br>insert into user_logs VALUES<br>(null, &#x27;insert&#x27;, now(), NEW.id, concat(&#x27;插入的数据内容为：id=&#x27;, NEW.id, &#x27;name=&#x27;, NEW.name));<br>END;<br></code></pre></td></tr></table></figure></li><li><p>查看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 查看当前数据库的触发器<br>show triggers;<br></code></pre></td></tr></table></figure></li><li><p>删除</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">DROP TRIGGER tb_user_insert_trigger;<br></code></pre></td></tr></table></figure></li></ul><h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><h4 id="分类-1"><a href="#分类-1" class="headerlink" title="分类"></a>分类</h4><p>按粒度分</p><ol><li>全局锁：锁定数据库中的所有表</li><li>表级锁：每次操作锁住整张表</li><li>行级锁：每次操作锁住对应的行数据</li></ol><h4 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h4><blockquote><p>对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML、DDL和事务提交语句都会被<strong>阻塞</strong></p></blockquote><p>使用场景：全库的逻辑备份，保证数据的一致性</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 添加全局锁<br>flush tables with read lock;<br>-- 数据备份，在cmd窗口执行<br>mysqldump -u用户名 -p密码 数据库名&gt;路径.sql<br>-- 解锁<br>unlock tables;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 可以在不加锁的情况下实现备份，通过快照实现<br>mysqldump --single-transaction -u用户名 -p密码 数据库名&gt;路径.sql<br></code></pre></td></tr></table></figure><h4 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h4><p>表级锁主要分为三类：</p><ol><li><strong>表锁</strong><ul><li>共享锁</li><li>写锁</li></ul></li><li><strong>元数据锁</strong>（meta data lock）</li><li><strong>意向锁</strong></li></ol><h5 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h5><p>语法</p><ul><li><p>加锁</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">lock tables 表名... read/write;<br></code></pre></td></tr></table></figure></li><li><p>释放锁</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">unlock tables;<br></code></pre></td></tr></table></figure></li></ul><h5 id="元数据锁"><a href="#元数据锁" class="headerlink" title="元数据锁"></a>元数据锁</h5><p>是给<strong>表结构</strong>自动加的锁，在增删改查时加MDL读锁，在修改表结构时加MDL写锁</p><h5 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h5><p>当要加表锁的时候，需要去查看是否加了行锁，一行行查效率太低</p><p>意向锁就是为了提高性能的</p><p>在加行锁的时候会加上意向锁，其他线程加表锁的时候就不用一行行判断了</p><p><strong>意向共享锁</strong>：和表锁共享锁兼容</p><p><strong>意向排他锁</strong>：和表锁共享锁和排他锁都不兼容</p><h4 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h4><p>每次操作锁住对应的行数据，粒度最小，并发度最高，是对索引加的锁</p><h5 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h5><p>增删改时自动加行级排他锁</p><p>SELECT 不加锁</p><p>SELECT … LOCK IN SHARE MODE 加共享锁</p><p>SELECT … FOR UPDATE 加排他锁</p><h5 id="记录锁-x2F-间隙锁-x2F-临键锁"><a href="#记录锁-x2F-间隙锁-x2F-临键锁" class="headerlink" title="记录锁&#x2F;间隙锁&#x2F;临键锁"></a>记录锁&#x2F;间隙锁&#x2F;临键锁</h5><p>记录锁：锁住当前记录</p><p><strong>间隙锁</strong>：把两个索引之间不存在的索引锁住，锁住后插入语句会被阻塞，<strong>防止幻读</strong></p><p>临键锁：记录锁+间隙锁，左开右闭</p><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ol><li><p>在 MySQL 的可重复读隔离级别下，针对当前读的语句会对<strong>索引</strong>加记录锁+间隙锁，这样可以避免其他事务执行增、删、改时导致幻读的问题</p></li><li><p>锁退化的情况</p></li></ol><ul><li>等值查询<ul><li>唯一索引：记录存在时退化成记录锁，不存在时退化成间隙锁</li><li>非唯一索引：对第一个不符合要求的记录退化成间隙锁</li></ul></li><li>范围查询<ul><li>唯一索引在满足一些条件的时候，索引的 next-key lock 退化为间隙锁或者记录锁。</li><li>非唯一索引范围查询，索引的 next-key lock 不会退化为间隙锁和记录锁。</li></ul></li></ul><ol start="3"><li>在执行 update、delete、select … for update 等具有加锁性质的语句，一定要检查语句是否走了索引，如果是全表扫描的话，会对每一个索引加 next-key 锁，相当于把整个表锁住了</li></ol><h3 id="InnoDB引擎"><a href="#InnoDB引擎" class="headerlink" title="InnoDB引擎"></a>InnoDB引擎</h3><h4 id="逻辑存储结构"><a href="#逻辑存储结构" class="headerlink" title="逻辑存储结构"></a>逻辑存储结构</h4><p><img src="/img/sql_img/%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png"></p><ul><li>表空间(ibd文件)：一个mysql实例(database)对应多个表空间，用于存储记录、索引等数据</li><li>段：数据段是B+数的叶子结点，索引段是B+数的非叶子节点</li><li>区：大小为1M</li><li>页：大小为16k，存储引擎管理的最小单位</li><li>行：数据是按行存放的</li></ul><h4 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h4><h5 id="内存架构"><a href="#内存架构" class="headerlink" title="内存架构"></a>内存架构</h5><p><img src="/img/sql_img/%E5%86%85%E5%AD%98%E6%9E%B6%E6%9E%84.png"></p><ul><li><p><strong>Buffer Pool</strong>（缓冲池）：缓存磁盘中经常操作的真实数据，按一定频率刷回磁盘，减少磁盘IO</p><ul><li><p>缓冲池以<strong>页</strong>为单位</p><p>free page：未使用的页</p><p>clean page：被使用的页，数据没有被修改过</p><p>dirty page：被使用的页，数据被修改过</p></li></ul></li><li><p><strong>Change Buffer</strong>（更改缓冲池）：针对非唯一二级索引，如果要更改的数据不在缓存池中，则会先将数据保存在change buffer中，等将来读取时数据被加载到缓冲池后，再进行合并，减少因为调整索引树造成的磁盘IO</p></li><li><p><strong>Log Buffer</strong>（日志缓冲区）：保存要写入磁盘的日志数据（redo log(重做日志)，undo log(撤销日志)）</p></li></ul><h5 id="磁盘结构"><a href="#磁盘结构" class="headerlink" title="磁盘结构"></a>磁盘结构</h5><p><img src="/img/sql_img/%E7%A3%81%E7%9B%98%E7%BB%93%E6%9E%84.png"></p><h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p><strong>原理</strong></p><p>持久性：通过redo log重做日志，在缓冲区刷回磁盘的时候发生错误进行数据恢复</p><p>原子性：通过undo log回滚日志，当事务失败时进行回滚（一起成功，一起失败）</p><h4 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h4><blockquote><p>Multi-Version Concurrency Control，多版本并发控制</p><p>实现读取数据不用加锁。可以让读取数据同时修改，修改数据时同时可读取</p></blockquote><h5 id="解决并发通常的方案"><a href="#解决并发通常的方案" class="headerlink" title="解决并发通常的方案"></a>解决并发通常的方案</h5><ol><li>使用共享锁和排他锁</li><li>通过对并发数据进行快照备份，从而达到无锁访问</li></ol><p>MVCC就是通过保存数据的多个快照版本，通过版本号来确认要展示的数据</p><h5 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h5><p><strong>当前读</strong>：读的是最新的数据（不可重复读）</p><p><strong>快照读</strong>：每次select都生成一个快照读，事务里读的是第一个select查到的数据（可重复读）</p><p><strong>隐藏字段</strong></p><table><thead><tr><th>隐藏字段</th><th>含义</th></tr></thead><tbody><tr><td>DB_TRX_ID</td><td>记录操作该数据事务的事务ID</td></tr><tr><td>DB_ROLL_PTR</td><td>相当于一个指针，指向回滚段的undo日志</td></tr><tr><td>DB_ROW_ID</td><td>隐藏主键，没有指定主键时生成</td></tr></tbody></table><p><strong>undo log</strong>（回滚日志）</p><p>用于<strong>记录数据被修改前的信息</strong>。在表记录修改之前，会先把数据拷贝到undo log里，并且记录这个版本的事务id，如果事务回滚，即可以通过undo log来还原数据。</p><p>通过版本链的形式记录数据的历史版本，用于<strong>回滚事务</strong>、<strong>快照读</strong>等</p><p><img src="/img/sql_img/%E7%89%88%E6%9C%AC%E9%93%BE.png"></p><p><strong>Read View</strong></p><p>事务执行SQL语句时，产生的读视图，主要是用来做可见性判断的，即判断当前事务可见哪个版本的数据</p><p>read view主要属性</p><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>m_ids</td><td>当前系统中那些活跃(<strong>开启且未提交</strong>)的读写事务ID</td></tr><tr><td>min_limit_id</td><td>m_ids中的最小值</td></tr><tr><td>max_limit_id</td><td>最大事务ID+1</td></tr><tr><td>creator_trx_id</td><td>创建时的事务ID</td></tr></tbody></table><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><ul><li><p><strong>读已提交</strong>级别下，事务中的每次select都会创建新的ReadView，会查找不在m_ids中的事务ID对应的历史数据</p></li><li><p><strong>可重复读</strong>级别下，事务中只会在第一次select时创建ReadView，通过判断读取到的行的 DB_TRX_ID 与 DB_ROLL_PTR 字段指向的 undo log 回溯到事务开启前或当前事务最后一次更新的数据版本</p><p><img src="/img/sql_img/%E5%BF%AB%E7%85%A7%E8%AF%BB.png"></p><p>在修改数据时会出现幻读</p></li></ul><h3 id="SQL语句执行流程"><a href="#SQL语句执行流程" class="headerlink" title="SQL语句执行流程"></a>SQL语句执行流程</h3><p><a href="https://xiaolincoding.com/mysql/base/how_select.html#mysql-%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84">执行一条 select 语句，期间发生了什么?</a></p><h4 id="查询语句"><a href="#查询语句" class="headerlink" title="查询语句"></a>查询语句</h4><p><img src="/img/sql_img/mysql%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B.png"></p><ul><li>连接器：建立连接，管理连接、校验用户身份；</li><li>查询缓存：查询语句如果命中查询缓存则直接返回，否则继续往下执行。MySQL 8.0 已删除该模块；</li><li>解析 SQL，通过解析器对 SQL 查询语句进行词法分析、语法分析，然后构建语法树，方便后续模块读取表名、字段、语句类型；</li><li>执行 SQL：执行 SQL 共有三个阶段：<ul><li>预处理阶段：检查表或字段是否存在；将 <code>select *</code> 中的 <code>*</code> 符号扩展为表上的所有列。</li><li>优化阶段：基于查询成本的考虑， 选择查询成本最小的执行计划；</li><li>执行阶段：根据执行计划执行 SQL 查询语句，从存储引擎读取记录，返回给客户端；</li></ul></li></ul><p><strong>执行器和存储引擎的交互</strong></p><ol><li><p>主键索引查询</p><p>执行器调用存储引擎的查询接口，并把查询条件交给存储引擎；</p><p>存储引擎通过B+树找到符合条件的记录，返回给执行器；</p><p>执行器判断记录是否符合条件并返回给客户端；</p><p>循环以上步骤直到没有再查询到数据</p></li><li><p>全表查询</p><p>执行器调用存储引擎的查询接口；</p><p>存储引擎把一条记录返回给执行器；</p><p>执行器判断记录是否符合条件并返回给客户端；</p><p>循环以上步骤直到没有再查询到数据</p></li><li><p>索引下推</p><p>在使用联合索引时，和全表查询不同的是，会把查询条件也交给存储引擎；</p><p>当联合索引部分失效时，失效的字段由存储引擎来判断是否符合条件；</p><p>这样就不用回表查询出记录后再由执行器来判断了</p><p><strong>索引下推能够减少二级索引的回表操作</strong></p></li></ol><h4 id="存储行"><a href="#存储行" class="headerlink" title="存储行"></a>存储行</h4><p><strong>存储位置</strong></p><p>数据库表文件存储位置<code>show variables like &#39;datadir&#39;</code></p><p>5.7及之前版本的文件</p><ul><li><code>.frm</code>文件：存储表结构</li><li><code>.idb</code>文件（表空间）：存储表数据</li></ul><p>之后的版本</p><ul><li><code>.idb</code>文件（表空间）：存储表结构和表数据</li></ul><p><strong>表空间结构</strong></p><p>行：一条记录</p><p><strong>页</strong>：16KB，每次读取磁盘里的记录都是以页为单位</p><ul><li>页中的记录通过指针形成双向链表</li><li>记录分成了一个个组</li><li>页中包含页目录，目录中有多个槽，执行各个分组的最后一个记录。通过二分来定位到分组</li></ul><p>区：1MB，由页构成</p><p>段：由多个区组成，分为索引段、数据段、回滚段等</p><p><strong>行格式</strong></p><p><img src="/img/sql_img/%E8%A1%8C%E6%A0%BC%E5%BC%8F.png"></p><ul><li>变长字段长度列表：记录每个变长字段(varchar、Text等)的长度</li><li>NULL值列表：记录可以为空的字段是否为NULL值</li><li>记录头信息：记录是否被删除、下一条数据的指针等信息</li><li>row_id：没有主键时的隐藏主键</li><li>trx_id：创建该条记录的事务id</li><li>roll_ptr：指向上一个版本的指针</li></ul><blockquote><p>因为指向下一条数据的指针是指到’记录头信息’和’row_id’中间的位置，所以为了方便查询，变长字段长度列表和NULL值列表的顺序和字段顺序相反。</p><p>一行记录的长度最大为65535B，而一页的大小为16KB，所以放不下的数据会放到溢出页中，原来的页中放指向溢出页的指针。</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue-admin-template</title>
    <link href="/2023/04/01/%E5%89%8D%E7%AB%AF/vue-element-admin/vue-admin-template/"/>
    <url>/2023/04/01/%E5%89%8D%E7%AB%AF/vue-element-admin/vue-admin-template/</url>
    
    <content type="html"><![CDATA[<h2 id="vue-admin-template简单使用"><a href="#vue-admin-template简单使用" class="headerlink" title="vue-admin-template简单使用"></a>vue-admin-template简单使用</h2><blockquote><p>vue-admin-template是基于vue-element-admin的一套后台管理系统基础模板（最少精简版），可作为模板进行二次开发。</p></blockquote><p> 包含了axios、vue、vue-router、vuex、element-ui等</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul><li><p>下载</p><p><a href="https://github.com/PanJiaChen/vue-admin-template">https://github.com/PanJiaChen/vue-admin-template</a></p></li><li><p>解压、安装依赖、启动</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">npm</span> install<br><span class="hljs-built_in">npm</span> run dev<br></code></pre></td></tr></table></figure></li><li><p>访问<code>http://localhost:9528/</code></p></li></ul><h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ada">router<span class="hljs-comment">-- 路由信息</span><br>api<span class="hljs-comment">-- 发送请求的方法</span><br>views<span class="hljs-comment">-- 具体页面</span><br>main.js<span class="hljs-comment">-- 项目入口</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>vue-element-admin</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring底层原理</title>
    <link href="/2023/03/19/spring/Spring%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/"/>
    <url>/2023/03/19/spring/Spring%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="Spring底层原理"><a href="#Spring底层原理" class="headerlink" title="Spring底层原理"></a>Spring底层原理</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="Bean的创建过程"><a href="#Bean的创建过程" class="headerlink" title="Bean的创建过程"></a>Bean的创建过程</h3><ol><li><p><strong>推断构造方法</strong></p><ol><li><p>选择使用的构造方法：</p><ul><li><p>如果只有无参的构造方法，就用无参的；</p></li><li><p>如果只有一个有参的构造方法，就用这个有参的；</p></li><li><p>如果有多个有参的构造方法，会使用构造上加了@Autowired的构造，没有则spring也不知道用哪个，会尝试找无参的，没有就报错。</p></li></ul></li><li><p>对入参进行依赖注入</p><p>会对有参的构造函数中的参数进行依赖注入，先通过类型去单例池中找，如果有多个则再通过参数名匹配，没有就报错。</p></li></ol></li><li><p><strong>依赖注入</strong></p><p>找加了响应注解（@Autowired、@Resource）的属性，先byType再byName</p></li><li><p><strong>初始化</strong></p><ul><li>初始化前：扫描对应注解（@PostConstruct），执行初始化前方法</li><li>初始化中：扫描对应接口（afterPropertiesSet），执行初始化方法</li><li>初始化后：<strong>AOP产生代理对象</strong><ul><li>cglib：代理对象继承原对象，原对象成为代理对象的一个属性。切面方法里通过joinPoint.getTarget()可以获取原对象，joinPoint.getThis()可以获取代理对象</li></ul></li></ul></li><li><p>放到Map（单例池）中</p></li><li><p>Bean对象</p></li></ol><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>和AOP类似，生成代理对象来增强功能</p><p><strong>开启事务</strong>：在数据库配置类上加@EnableTransactionManagement、@Configuration</p><ol><li>事务管理器新建一个数据库连接conn</li><li>conn.autocommit &#x3D; false          &#x2F;&#x2F; 关闭自动提交</li><li>使用@Configuration把dataSource注入bean，使每次拿到的都是同一个dataSource</li></ol><p><strong>使用事务</strong>：@Transactional</p><h4 id="star-事务失效原理"><a href="#star-事务失效原理" class="headerlink" title=":star:事务失效原理"></a>:star:事务失效原理</h4><p>必须是从获取到的代理对象来调用有事务的方法才会生效。</p><p>如果是从自己new的对象&#x2F;其他方法调用事务方法等方式则不会经过切面，从而事务失效</p><h3 id="star-循环依赖"><a href="#star-循环依赖" class="headerlink" title=":star:循环依赖"></a>:star:循环依赖</h3><h4 id="提前AOP"><a href="#提前AOP" class="headerlink" title="提前AOP"></a>提前AOP</h4><p>​成因：在创建一个bean时将其名字添加到一个set中，创建完后将其删除。如果此时另一个bean需要依赖注入的bean在单例池中找不到，而在这个set中，说明出现了循环依赖</p><p>​只有出现循环依赖时，<strong>将AOP的步骤提前到填充属性前</strong>，得到代理对象注入到<strong>二级缓存</strong>（earlySingletonObjects）中。此时的代理对象还不能放到单例池中，因为代理对象里的原对象还没创建出来，现在处于半成品状态</p><p>​后面再出现循环依赖，会先去二级缓存中找，没有再去提前AOP</p><p>​当当前对象创建完后，再从二级缓存中取出半成品对象继续初始化完再放进单例池中，半成品会被删掉</p><p>​而创建二级缓存中代理对象的方法，存在<strong>三级缓存</strong>（singletonFactories）中，在去二级缓存中找代理对象而没有找到时调用，调用完删掉。在之后正常流程的AOP时发现三级缓存里的被删除了的话，就不再AOP</p><h4 id="Lazy"><a href="#Lazy" class="headerlink" title="@Lazy"></a>@Lazy</h4><p>​成因：@Async会生成代理对象，但和AOP是不同的逻辑，是在后处理器中做的代理。所以在提前AOP时放入二级缓存的是原始对象，注入的也是原始对象。而之后从二级缓存中取出继续初始化后，放入一级缓存的却是代理对象</p><p>​成因：在构造函数时出现循环依赖，即创建不出原始对象，如<code>AService(Bservice b)、BService(AService a)</code></p><p>​解决：使用@Lazy会先用一个代理对象来占位，到之后用到时再注入对象，从而不会发生循环依赖</p><h4 id="三级缓存"><a href="#三级缓存" class="headerlink" title="三级缓存"></a>三级缓存</h4><p>三级缓存就是三个Map，最终是为了保证单例</p><ul><li>第一级缓存：singletonObjects （单例池）：存放创建好的bean</li><li>第二级缓存：earlySingletonObjects：存放提前创建的代理对象</li><li>第三级缓存：singletonFactories：存放创建代理对象的方法</li></ul><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h3 id="1-Bean的创建"><a href="#1-Bean的创建" class="headerlink" title="1.Bean的创建"></a>1.Bean的创建</h3><h4 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h4><p><strong>目标</strong>：通过debug来寻找在哪里创建了User对象，根据何时打印构造方法里的打印来寻找</p> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.10.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ol><li>通过配置文件方式将bean注入到容器中</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd &quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xw.domain.User&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;user&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.domain;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;创建了User&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>创建容器，通过debug发现实在创建容器时创建了user</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw;<br><br><span class="hljs-keyword">import</span> com.xw.domain.User;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;applicationContext.xml&quot;</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> (User) context.getBean(<span class="hljs-string">&quot;user&quot;</span>);<br>        System.out.println(user);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>继续往里看，debug发现执行到refresh()时创建了user</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathXmlApplicationContext</span><span class="hljs-params">(</span><br><span class="hljs-params">    String[] configLocations, <span class="hljs-type">boolean</span> refresh, <span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span><br>    <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>    <span class="hljs-built_in">super</span>(parent);<br>    setConfigLocations(configLocations);<br>    <span class="hljs-keyword">if</span> (refresh) &#123;<br>        refresh();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>点入refresh()，<strong>发现创建容器的步骤</strong>，其中执行到第11步<code>finishBeanFactoryInitialization(beanFactory);</code>时创建了user</li></ol><p><img src="/img/spring_img/%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E6%B5%81%E7%A8%8B.png"></p><ol start="5"><li>点入<code>finishBeanFactoryInitialization()</code>方法，发现调用了<code>beanFactory.preInstantiateSingletons();</code>后创建了user</li><li>继续往下点发现在方法里判断当前类是不是抽象、单例、懒惰，后调用了<code>getBean(beanName)</code>来创建或获取Bean</li><li><code>getBean()</code>调用<code>doGetBean()</code>，会先尝试从缓存中取，没有则先初始化依赖的Bean，然后调用<code>createBean()</code>来实例化和初始化Bean<ol><li><code>createBean()</code>中调用了<code>InstantiationAwareBeanPostProcessor()</code>后置处理器来实现AOP，然后调用<code>doCreateBean()</code>反射实例化和初始化Bean</li></ol></li></ol><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>​到这里发现是调用了beanFactory的doGetBean()方法<strong>创建了非懒加载的单例bean</strong>。beanFactory通过反射创建<strong>空参</strong>的单例对象，创建后将对象保存到了一个map集合中（singletonObjects）,key为bean的名字，value为user的单例对象。</p><h3 id="2-Bean的获取"><a href="#2-Bean的获取" class="headerlink" title="2.Bean的获取"></a>2.Bean的获取</h3><p>context.getBean()，获取beanFactory，通过beanFactory的getBean方法，根据名称获取创建时放进map里的bean</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Netty</title>
    <link href="/2023/02/26/%E7%BD%91%E7%BB%9C/Netty/"/>
    <url>/2023/02/26/%E7%BD%91%E7%BB%9C/Netty/</url>
    
    <content type="html"><![CDATA[<h1 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h1><p><strong>Netty</strong>是 一个<strong>异步事件驱动</strong>的网络应用程序框架，用于<strong>快速开发可维护的高性能协议服务器和客户端</strong>。</p><h2 id="NIO基础"><a href="#NIO基础" class="headerlink" title="NIO基础"></a>NIO基础</h2><p>NIO（<strong>non-blocking io</strong>）非阻塞IO</p><h3 id="三大组件"><a href="#三大组件" class="headerlink" title="三大组件"></a>三大组件</h3><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><p>读写数据的<strong>双向通道</strong></p><p>常见Channel有：</p><ul><li>FileChannel：传输文件</li><li>DatagramChannel：UDP</li><li>SocketChannel：TCP</li><li>ServerSocketChannel：TPC，专用于服务器</li></ul><h4 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h4><p>缓冲读写数据</p><p>常见Buffer有：</p><ul><li>ByteBuffer</li></ul><h4 id="Selector"><a href="#Selector" class="headerlink" title="Selector"></a>Selector</h4><p>在服务器和用户连接上的几种策略：</p><ol><li><strong>多线程</strong>：一个线程对应一个用户(socket)。缺点：内存占用高，上下文切换成本高，只适合连接少的场景</li><li><strong>线程池</strong>：一个线程池对应多个用户(socket)。缺点：阻塞模式下，线程仅能处理一个socket，仅适合短连接场景</li><li><strong>selector</strong>：一个selector和一个线程管理多个channel，当channel有任务要线程处理时，由selector通知线程去处理，线程是非阻塞的。适合连接多，流量低的场景。</li></ol><p>​<img src="/img/inter_img/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%89%88.png" alt="多线程版"></p><p>​<img src="/img/inter_img/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%89%88.png" alt="线程池版"></p><p>​<img src="/img/inter_img/selector%E7%89%88.png" alt="selector版"></p><h3 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h3><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><p>功能：在项目目录下创建一个data.txt文件，读取这个文件的内容</p><p>使用步骤：</p><ol><li>像buffer写入数据，如channel.read(buffer)</li><li>调用filp()切换至<strong>读模式</strong></li><li>从buffer中读取数据，如buffer.get()</li><li>调用clear()或compact()切换至<strong>写模式</strong></li><li>重复以上步骤</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.nio.ByteBuffer;<br><span class="hljs-keyword">import</span> java.nio.channels.FileChannel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">// 1. 准备输入输出流</span><br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">FileChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;data.txt&quot;</span>).getChannel())&#123;<br>        <span class="hljs-comment">// 2.准备缓冲区</span><br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">10</span>); <span class="hljs-comment">// 划分10个字节作为缓冲区</span><br>        <span class="hljs-comment">// 3.写入缓冲区</span><br>        <span class="hljs-keyword">while</span> (channel.read(buffer) != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-comment">// 4.从buffer中读出数据</span><br>            buffer.flip();  <span class="hljs-comment">// 切换到读模式</span><br>            <span class="hljs-keyword">while</span> (buffer.hasRemaining()) &#123;<br>                System.out.println((<span class="hljs-type">char</span>) buffer.get());<br>            &#125;<br>            buffer.clear(); <span class="hljs-comment">// 切换到写模式</span><br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h4><p>属性：</p><ol><li>capacity 容量</li><li>position 读写指针</li><li>limit 读写的尾部指针</li></ol><p>​<img src="/img/inter_img/byteBuffer%E7%BB%93%E6%9E%841.png" alt="初始时"></p><p>​<img src="/img/inter_img/byteBuffer%E7%BB%93%E6%9E%842.png" alt="写入内容，p指针后移"></p><p>​<img src="/img/inter_img/byteBuffer%E7%BB%93%E6%9E%843.png" alt="调用flip读内容，l指针移到p指针位置，重置p指针"></p><p>​<img src="/img/inter_img/byteBuffer%E7%BB%93%E6%9E%841.png" alt="调用clean，重置为初始状态，从头开始写"></p><p>​<img src="/img/inter_img/byteBuffer%E7%BB%93%E6%9E%844.png" alt="调用compact，会把未读的内容保留，在后面追加写"></p><h4 id="常见方法"><a href="#常见方法" class="headerlink" title="常见方法"></a>常见方法</h4><h5 id="分配空间"><a href="#分配空间" class="headerlink" title="分配空间"></a>分配空间</h5><p>分配一块固定的容量（字节）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 分配堆内存，效率较低</span><br>ByteBuffer.allocate(<span class="hljs-number">10</span>);<br><span class="hljs-comment">// 分配直接内存（系统内存），效率较高（零拷贝），不受GC影响，</span><br><span class="hljs-comment">// 但分配效率低，使用不当可能造成内存泄漏</span><br>ByteBuffer.allocateDirect(<span class="hljs-number">16</span>);<br></code></pre></td></tr></table></figure><h5 id="写入数据"><a href="#写入数据" class="headerlink" title="写入数据"></a>写入数据</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 从channel中读到buffer</span><br>channel.read(buffer);<br><span class="hljs-comment">// 直接向buffer中写</span><br>buffer.put();<br></code></pre></td></tr></table></figure><h5 id="读取数据"><a href="#读取数据" class="headerlink" title="读取数据"></a>读取数据</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 把buffer中的数据写到channel</span><br>channel.write(buffer);<br><span class="hljs-comment">// 直接从buffer中读</span><br>buffer.get();<br></code></pre></td></tr></table></figure><ul><li>rewind() 将position移到头部</li><li>get(int idx) 读取指定下标的数据，不会改变position指针</li></ul><h5 id="做标记"><a href="#做标记" class="headerlink" title="做标记"></a>做标记</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">10</span>);<br>buffer.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>&#125;);<br>buffer.flip();<br><br>System.out.println(buffer.get());   <span class="hljs-comment">// 97</span><br>buffer.mark();  <span class="hljs-comment">// 在下标为1的位置做个标记</span><br>System.out.println(buffer.get());   <span class="hljs-comment">// 98</span><br>System.out.println(buffer.get());   <span class="hljs-comment">// 99</span><br>buffer.reset(); <span class="hljs-comment">// 返回做标记的位置</span><br>System.out.println(buffer.get());   <span class="hljs-comment">// 98</span><br></code></pre></td></tr></table></figure><h5 id="String和ByteBuffer转换"><a href="#String和ByteBuffer转换" class="headerlink" title="String和ByteBuffer转换"></a>String和ByteBuffer转换</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 直接转为buffer</span><br><span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer1</span> <span class="hljs-operator">=</span> StandardCharsets.UTF_8.encode(<span class="hljs-string">&quot;hello&quot;</span>);<br><span class="hljs-comment">// 转为String</span><br>System.out.println(StandardCharsets.UTF_8.decode(buffer1).toString());<br></code></pre></td></tr></table></figure><h4 id="粘包、半包"><a href="#粘包、半包" class="headerlink" title="粘包、半包"></a>粘包、半包</h4><p><strong>粘包</strong>：</p><ol><li>传输换行的数据时，多行数据在一行传输</li><li>是在效率上考虑，多条一起发效率高</li></ol><p><strong>半包</strong>：</p><ol><li>一行数据被拆成多行显示</li><li>因为缓冲区大小导致数据被拆</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">// 模拟网络传输数据</span><br>    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">32</span>);<br>    source.put(<span class="hljs-string">&quot;Hello,world\nI&#x27;m zhangsan\nHo&quot;</span>.getBytes());<br>    split(source);<br>    source.put(<span class="hljs-string">&quot;w are you?\n&quot;</span>.getBytes());<br>    split(source);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">split</span><span class="hljs-params">(ByteBuffer source)</span> &#123;<br>    <span class="hljs-comment">// 将source中的内容按&#x27;\n&#x27;分割来读取</span><br>    source.flip();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; source.limit(); i++) &#123;<br>        <span class="hljs-keyword">if</span> (source.get(i) == <span class="hljs-string">&#x27;\n&#x27;</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> i - source.position() + <span class="hljs-number">1</span>;<br>            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(length);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; length; j++) &#123;<br>                target.put(source.get());<br>            &#125;<br>            target.flip();<br>            System.out.println(StandardCharsets.US_ASCII.decode(target));<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 改为写模式，保留未读取的数据</span><br>    source.compact();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="文件编程"><a href="#文件编程" class="headerlink" title="文件编程"></a>文件编程</h3><h4 id="FileChannel"><a href="#FileChannel" class="headerlink" title="FileChannel"></a>FileChannel</h4><blockquote><p>FileChannel只能工作在阻塞模式下，不能使用selector</p></blockquote><h5 id="获取方式"><a href="#获取方式" class="headerlink" title="获取方式"></a>获取方式</h5><ol><li>FileInputStream：获取的channel只能读</li><li>FileOutputStream：获取的channel只能写</li><li>RandomAccessFile：根据构造RandomAccessFile时的读写模式决定</li></ol><h5 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">readBytes</span> <span class="hljs-operator">=</span> channel.read(buffer);<br></code></pre></td></tr></table></figure><h5 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ...;<br>buffer.put(...);<br>buffer.flip();<span class="hljs-comment">// 切换读模式</span><br><br><span class="hljs-keyword">while</span> (buffer.hasRemaining()) &#123;<br>    channel.write(buffer);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">channel.close();<br></code></pre></td></tr></table></figure><h5 id="强制写入"><a href="#强制写入" class="headerlink" title="强制写入"></a>强制写入</h5><p>​为了减少io操作，写的数据不会立即写到磁盘中。可以调动force(true)立即写入磁盘</p><h5 id="传输数据到另一个文件"><a href="#传输数据到另一个文件" class="headerlink" title="传输数据到另一个文件"></a>传输数据到另一个文件</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> (<br>    <span class="hljs-type">FileChannel</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;data.txt&quot;</span>).getChannel();<br>    <span class="hljs-type">FileChannel</span> <span class="hljs-variable">to</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;to.txt&quot;</span>).getChannel();<br>) &#123;<br>    <span class="hljs-comment">// 把文件data.txt的内容写到to.txt中，每次最高传输2G数据</span><br>    <span class="hljs-comment">// 采用的是零拷贝，效率高</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> from.size();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> size; left &gt; <span class="hljs-number">0</span>;)<br>        left -= from.transferTo(size - left, left, to);<br>&#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>    e.printStackTrace();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Path-amp-Files"><a href="#Path-amp-Files" class="headerlink" title="Path &amp;  Files"></a>Path &amp;  Files</h4><ul><li><p>Path用于表示文件路径</p></li><li><p>Paths是工具类，用于获取Path实例</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Path</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> Paths.get(<span class="hljs-string">&quot;1.txt&quot;</span>);<br></code></pre></td></tr></table></figure><ul><li>Files是操作文件的工具类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 判断文件是否存在</span><br><span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Path.get(<span class="hljs-string">&quot;data.txt&quot;</span>);<br>System.out.println(Files.exists(path)); <br><br><span class="hljs-comment">// 创建一级目录，已存在则抛异常</span><br><span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Path.get(<span class="hljs-string">&quot;hello/d1&quot;</span>);<br>Files.createDirectory(path);<br><br><span class="hljs-comment">// 创建多级目录</span><br><span class="hljs-type">Path</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> Path.get(<span class="hljs-string">&quot;hello/d1/d2&quot;</span>);<br>Files.createDirectorys(path);<br><br><span class="hljs-comment">// 拷贝文件</span><br><span class="hljs-type">Path</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> Path.get(<span class="hljs-string">&quot;helloword/data.txt&quot;</span>);<br><span class="hljs-type">Path</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> Path.get(<span class="hljs-string">&quot;helloword/target.txt&quot;</span>);<br>Files.copy(source, target);<br><br><span class="hljs-comment">// 遍历目录</span><br>Files.walkFileTree(Paths.get(<span class="hljs-string">&quot;F:\\aaa&quot;</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleFileVisitor</span>&lt;Path&gt;()&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> FileVisitResult <span class="hljs-title function_">preVisitDirectory</span><span class="hljs-params">(Path dir, BasicFileAttributes attrs)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(dir);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.preVisitDirectory(dir, attrs);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> FileVisitResult <span class="hljs-title function_">visitFile</span><span class="hljs-params">(Path file, BasicFileAttributes attrs)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        System.out.println(file);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.visitFile(file, attrs);<br>    &#125;<br>&#125;);<br><br>。。。<br></code></pre></td></tr></table></figure><h3 id="star-网络编程"><a href="#star-网络编程" class="headerlink" title=":star:网络编程"></a>:star:网络编程</h3><h4 id="阻塞-amp-非阻塞"><a href="#阻塞-amp-非阻塞" class="headerlink" title="阻塞&amp;非阻塞"></a>阻塞&amp;非阻塞</h4><h5 id="单线程模式下"><a href="#单线程模式下" class="headerlink" title="单线程模式下"></a>单线程模式下</h5><p><strong>阻塞模式</strong></p><p>单线程不能很好的处理多个连接</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">    阻塞模式</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br><br>        <span class="hljs-comment">// 1.创建服务器</span><br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">ssc</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        <span class="hljs-comment">// 2.绑定监听端口</span><br>        ssc.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>((<span class="hljs-number">8080</span>)));<br>        <span class="hljs-comment">// 3.建立与客户端的连接</span><br>        List&lt;SocketChannel&gt; socketChannels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">16</span>);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> ssc.accept();    <span class="hljs-comment">// 会阻塞等待客户端连接</span><br>            socketChannels.add(sc);<br>            <span class="hljs-comment">// 4.接收数据</span><br>            <span class="hljs-keyword">for</span> (SocketChannel channel : socketChannels) &#123;<br>                channel.read(buffer);   <span class="hljs-comment">// 会阻塞等待客户端发消息</span><br>                buffer.flip();<br>                <span class="hljs-keyword">while</span> (buffer.hasRemaining()) &#123;<br>                    System.out.print((<span class="hljs-type">char</span>) buffer.get());<br>                &#125;<br>                System.out.println();<br>                buffer.clear();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> SocketChannel.open();<br>        sc.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8080</span>));<br>        sc.write(StandardCharsets.UTF_8.encode(<span class="hljs-string">&quot;asd&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>非阻塞模式</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 设置服务器端为非阻塞模式</span><br>ssc.configureBlocking(<span class="hljs-literal">false</span>);<br><span class="hljs-comment">// 影响的是accept，阻塞模式下会停下来等待客户端的连接</span><br><span class="hljs-comment">// 非阻塞模式下没有连接会返回null</span><br><span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> ssc.accept();<br><br><span class="hljs-comment">// 设置客户端连接为非阻塞</span><br>sc.configureBlocking(<span class="hljs-literal">false</span>);<br><span class="hljs-comment">// 影响的是read，不会停下来等客户端发送消息</span><br>channel.read(buffer);<br></code></pre></td></tr></table></figure><h5 id="Selector-1"><a href="#Selector-1" class="headerlink" title="Selector"></a>Selector</h5><p>多路复用：单线程配合Selector完成对多个Channel可读写事件的监控</p><h6 id="事件的种类"><a href="#事件的种类" class="headerlink" title="事件的种类"></a>事件的种类</h6><ol><li>accept：服务端在有连接请求时触发</li><li>connect：客户端连接建立后触发</li><li>read：客户端发送来消息、客户端正常&#x2F;异常关闭时触发，发送数据超过缓冲区会触发多次</li><li>write：可写事件</li></ol><h6 id="处理连接和读事件"><a href="#处理连接和读事件" class="headerlink" title="处理连接和读事件"></a>处理连接和读事件</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// selector管理channel</span><br>        <span class="hljs-type">Selector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> Selector.open();<br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">ssc</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        ssc.configureBlocking(<span class="hljs-literal">false</span>);<br><br>        <span class="hljs-comment">// 注册到selector上</span><br>        <span class="hljs-comment">// 通过SelectionKey可以知道是哪个channel发生了哪个事件</span><br>        <span class="hljs-comment">// 关注accept事件</span><br>        ssc.register(selector, SelectionKey.OP_ACCEPT, <span class="hljs-literal">null</span>);<br><br>        ssc.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>((<span class="hljs-number">8080</span>)));<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-comment">// 没有发生事件就阻塞</span><br>            selector.select();<br><br>            <span class="hljs-comment">// 处理事件，selector.selectedKeys()获取所有发生的事件</span><br>            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();<br>            <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> iterator.next();<br>                <span class="hljs-keyword">if</span> (key.isAcceptable()) &#123;<br>                    <span class="hljs-comment">// 处理连接事件</span><br>                    <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> (ServerSocketChannel) key.channel();<br>                    <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> channel.accept();<span class="hljs-comment">// 不处理(accept或cancel)key会重新加到keys中</span><br><br>                    <span class="hljs-comment">// 把客户端Channel注册到selector上</span><br>                    sc.configureBlocking(<span class="hljs-literal">false</span>);<br>                    sc.register(selector, SelectionKey.OP_READ, <span class="hljs-literal">null</span>);<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.isReadable()) &#123;<br>                    <span class="hljs-comment">// 处理读事件</span><br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> (SocketChannel) key.channel();<br>                        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">16</span>);<br>                        <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> channel.read(buffer);    <span class="hljs-comment">// 正常断开返回-1</span><br>                        <span class="hljs-keyword">if</span> (read == -<span class="hljs-number">1</span>)<br>                            key.cancel();<br>                        buffer.flip();<br>                        System.out.println(StandardCharsets.UTF_8.decode(buffer));<br>                    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                        System.err.println(<span class="hljs-string">&quot;客户端异常断开&quot;</span>);<br>                        key.cancel();   <span class="hljs-comment">// 没有消费掉key(read)，需要手动取消</span><br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// selector检测到事件后把key加到keys中不会主动删除</span><br>                <span class="hljs-comment">// 需要手动删除</span><br>                iterator.remove();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="处理写事件"><a href="#处理写事件" class="headerlink" title="处理写事件"></a>处理写事件</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">ssc</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        ssc.configureBlocking(<span class="hljs-literal">false</span>);<br><br>        <span class="hljs-type">Selector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> Selector.open();<br><br>        ssc.register(selector, SelectionKey.OP_ACCEPT, <span class="hljs-literal">null</span>);<br>        ssc.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-number">8080</span>));<br><br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            selector.select();<br><br>            Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();<br>            <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> iterator.next();<br>                iterator.remove();<br>                <span class="hljs-keyword">if</span> (key.isAcceptable()) &#123;<br>                    <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> ssc.accept();<br>                    sc.configureBlocking(<span class="hljs-literal">false</span>);<br>                    <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">scKey</span> <span class="hljs-operator">=</span> sc.register(selector, <span class="hljs-number">0</span>, <span class="hljs-literal">null</span>);<br><br>                    <span class="hljs-comment">// 发送数据</span><br>                    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30000000</span>; i++) &#123;<br>                        sb.append(<span class="hljs-string">&quot;a&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> Charset.defaultCharset().encode(sb.toString());<br>                    sc.write(buffer);<br><br>                    <span class="hljs-keyword">if</span> (buffer.hasRemaining()) &#123;<br>                        <span class="hljs-comment">// 关注写事件</span><br>                        scKey.interestOps(scKey.interestOps() + SelectionKey.OP_WRITE);<br>                        scKey.attach(buffer);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.isWritable()) &#123;<br>                    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span>(ByteBuffer) key.attachment();<br>                    <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> (SocketChannel) key.channel();<br><br>                    <span class="hljs-type">int</span> <span class="hljs-variable">write</span> <span class="hljs-operator">=</span> sc.write(buffer);<br>                    System.out.println(write);<br>                    <span class="hljs-comment">// 释放读完的buffer，不再关注写事件</span><br>                    <span class="hljs-keyword">if</span> (!buffer.hasRemaining()) &#123;<br>                        key.attach(<span class="hljs-literal">null</span>);<br>                        key.interestOps(key.interestOps() - SelectionKey.OP_WRITE);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> SocketChannel.open();<br>        sc.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8080</span>));<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">1026</span> * <span class="hljs-number">1024</span>);<br>            count += sc.read(buffer);<br>            System.out.println(count);<br>            buffer.clear();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="消息边界问题"><a href="#消息边界问题" class="headerlink" title="消息边界问题"></a>消息边界问题</h5><p>utf-8编码下汉字占三个字节，如果没有读全就会产生乱码</p><p><strong>处理方式</strong></p><ol><li>客户端和服务器端约定固定长度的消息格式。缺点：浪费空间</li><li>在消息中加分隔符，根据分隔符之间的消息长度分配buffer。缺点：慢</li><li>带头结点，头结点里有后续内容的长度信息，根据长度分配不同长度的buffer。<ul><li>TLV格式：Type Length Value</li><li>Http1.1是TLV格式</li><li>Http2.0是LTV格式</li></ul></li></ol><h5 id="多线程优化"><a href="#多线程优化" class="headerlink" title="多线程优化"></a>多线程优化</h5><p>好处：</p><ol><li>充分利用多核cpu资源</li><li>和耗时较长的任务并行执行</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiThreadServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 接收客户端连接的线程</span><br>        Thread.currentThread().setName(<span class="hljs-string">&quot;boss&quot;</span>);<br>        <span class="hljs-type">ServerSocketChannel</span> <span class="hljs-variable">ssc</span> <span class="hljs-operator">=</span> ServerSocketChannel.open();<br>        ssc.configureBlocking(<span class="hljs-literal">false</span>);<br>        <span class="hljs-type">Selector</span> <span class="hljs-variable">boss</span> <span class="hljs-operator">=</span> Selector.open();<br>        ssc.register(boss, SelectionKey.OP_ACCEPT, <span class="hljs-literal">null</span>);<br>        ssc.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-number">8080</span>));<br>        <span class="hljs-comment">// 创建worker线程池</span><br>        Worker[] workers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>[<span class="hljs-number">2</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; workers.length; i++) &#123;<br>            workers[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&quot;worker-&quot;</span> + i);<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            boss.select();<br>            Iterator&lt;SelectionKey&gt; iterator = boss.selectedKeys().iterator();<br>            <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> iterator.next();<br>                iterator.remove();<br>                <span class="hljs-keyword">if</span> (key.isAcceptable()) &#123;<br>                    <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> ssc.accept();<br>                    sc.configureBlocking(<span class="hljs-literal">false</span>);<br>                    workers[index].register(sc);<br>                    index = (index + <span class="hljs-number">1</span>) % workers.length;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>        <span class="hljs-comment">// 处理任务的线程</span><br>        <span class="hljs-keyword">private</span> Thread thread;<br>        <span class="hljs-keyword">private</span> Selector selector;<br>        <span class="hljs-keyword">private</span> String name;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">// 消息队列</span><br>        <span class="hljs-keyword">private</span> ConcurrentLinkedQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Worker</span><span class="hljs-params">(String name)</span> &#123;<br>            <span class="hljs-built_in">this</span>.name = name;<br>        &#125;<br><br>        <span class="hljs-comment">// 初始化线程和selector</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(SocketChannel sc)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            <span class="hljs-keyword">if</span> (!start) &#123;<br>                selector = Selector.open();<br>                thread = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>, name);<br>                thread.start();<br>                start = <span class="hljs-literal">true</span>;<br>            &#125;<br>            queue.offer(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    sc.register(selector, SelectionKey.OP_READ, <span class="hljs-literal">null</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (ClosedChannelException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;);<br>            <span class="hljs-comment">// selector在select()上阻塞着</span><br>            <span class="hljs-comment">// 需要唤醒selector</span><br>            selector.wakeup();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    selector.select();<br>                    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> queue.poll();<br>                    <span class="hljs-keyword">if</span> (task != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// 执行sc注册到selector</span><br>                        <span class="hljs-comment">// 必须要在selector执行select()之后注册</span><br>                        task.run();<br>                    &#125;<br>                    Iterator&lt;SelectionKey&gt; iterator = selector.selectedKeys().iterator();<br>                    <span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>                        <span class="hljs-type">SelectionKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> iterator.next();<br>                        iterator.remove();<br>                        <span class="hljs-keyword">if</span> (key.isReadable()) &#123;<br>                            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(<span class="hljs-number">16</span>);<br>                            <span class="hljs-type">SocketChannel</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> (SocketChannel) key.channel();<br>                            <span class="hljs-type">int</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> sc.read(buffer);<br>                            buffer.flip();<br>                            System.out.println(<span class="hljs-built_in">this</span>.name + <span class="hljs-string">&quot; : &quot;</span> + Charset.defaultCharset().decode(buffer));<br>                        &#125;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="NIO和BIO对比"><a href="#NIO和BIO对比" class="headerlink" title="NIO和BIO对比"></a>NIO和BIO对比</h5><h6 id="stream-和-channel"><a href="#stream-和-channel" class="headerlink" title="stream 和 channel"></a>stream 和 channel</h6><ul><li>不同：stream不会自动缓冲数据，channel会利用系统提供的发送缓冲区、接收缓冲区</li><li>stream仅支持阻塞API，channel同时支持阻塞、非阻塞API，网络channel可配合selector实现多路复用</li><li>相同：均为全双工（读写可同时进行）</li></ul><h4 id="零拷贝"><a href="#零拷贝" class="headerlink" title="零拷贝"></a>零拷贝</h4><blockquote><p>零拷贝指的是不需要把数据拷贝到jvm中</p></blockquote><p>不使用零拷贝数据中共复制了4次，切换用户态&#x2F;内核态3次</p><p>​<img src="/img/inter_img/%E9%9B%B6%E6%8B%B7%E8%B4%9D1.png"></p><p>使用DirectBuffer让用户缓冲区和内核缓冲区共用一块内存，减少一次拷贝</p><p>​<img src="/img/inter_img/%E9%9B%B6%E6%8B%B7%E8%B4%9D2.png"></p><p>直接从内核缓冲区向客户端的soket缓冲区发数据，减少一次内核切换</p><p>​<img src="/img/inter_img/%E9%9B%B6%E6%8B%B7%E8%B4%9D3.png"></p><p>零拷贝的有点有：</p><ul><li>更少的用户态与内核态的切换</li><li>不利用cpu计算（DMA），减少cpu缓存伪共享</li><li>零拷贝适合小文件传输</li></ul><h2 id="Netty-1"><a href="#Netty-1" class="headerlink" title="Netty"></a>Netty</h2><p><strong>Netty</strong>是 一个<strong>异步事件驱动</strong>的网络应用程序框架，用于<strong>快速开发可维护的高性能协议服务器和客户端</strong>。</p><h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><h4 id="为何要异步"><a href="#为何要异步" class="headerlink" title="为何要异步"></a>为何要异步</h4><ol><li>单线程没法异步提高效率，必须配合<strong>多线程</strong>、多核cpu才能发挥异步的优势</li><li>异步并没有缩短响应时间，反而有所增加，异步提高的是单位时间内的<strong>吞吐量</strong></li><li>合理进行<strong>任务拆分</strong>，也是利用异步的关键</li></ol><h4 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h4><ol><li><p>导包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.netty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>netty-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.59.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写服务器端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 启动器：组装netty组件</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>()<br>            <span class="hljs-comment">// 组里有负责可连接事件的loop，和负责处理可读事件的loop(selector, thread)</span><br>            .group(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>())<br><br>            <span class="hljs-comment">// 选择服务器端channel的实现</span><br>            .channel(NioServerSocketChannel.class)<br><br>            <span class="hljs-comment">// 决定了worker（child）能执行哪些操作</span><br>            .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;<br><br>                <span class="hljs-comment">// 给客户端channel添加handler</span><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioSocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    <span class="hljs-comment">// 解码handler  ByteBuf --&gt; 字符串</span><br>                    ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());<br>                    <span class="hljs-comment">// 自定义handler</span><br>                    ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span>() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            System.out.println(msg);<br>                        &#125;<br>                    &#125;);<br>                &#125;<br>            &#125;)<br>            .bind(<span class="hljs-number">8080</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-comment">// 客户端启动器</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>()<br>            .group(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>())<br>            .channel(NioSocketChannel.class)<br>            .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioSocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    <span class="hljs-comment">// 编码handler</span><br>                    ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());<br>                &#125;<br>            &#125;)<br>            <span class="hljs-comment">// 异步连接服务器</span><br>            .connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8080</span>))<br>            <span class="hljs-comment">// 阻塞方法，连接建立后往下执行</span><br>            .sync()<br>            <span class="hljs-comment">// 客户端和服务器端的channel</span><br>            .channel()<br>            <span class="hljs-comment">// 发送数据</span><br>            .writeAndFlush(<span class="hljs-string">&quot;Hello World&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h4><h5 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h5><p>​EventLoop本质是一个单线程执行器（selector + thread），处理channel上发生的事件</p><p>​EventLoopGroup是一组EventLoop，Channel会绑定其中一个EventLoop，后续这个Channel上的<strong>io</strong>事件都由此EventLoop来处理（保证io事件处理时的线程安全）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestEventLoop</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 创建事件循环组，可以指定线程数</span><br>        <span class="hljs-comment">// NioEventLoopGroup的实现可以执行io，普通，定时任务</span><br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">2</span>);<br>        <span class="hljs-comment">// 获取EventLoop对象</span><br>        System.out.println(group.next());<br>        <span class="hljs-comment">// 执行普通任务</span><br>        group.next().submit(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;task&quot;</span>);<br>        &#125;);<br>        <span class="hljs-comment">// 执行定时任务</span><br>        group.next().scheduleAtFixedRate(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;schedule：&quot;</span> + LocalTime.now());<br>        &#125;, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>​分工：</p><ul><li>group(EventLoopGroup, EventLoopGroup)：可以指定两个group来分工，前一个为监听accpet事件，后一个为处理读写事件</li><li>addLast(EventExecutorGroup, String, ChannelHandler)：指定EventLoopGroup执行这个处理器；指定处理器名；处理器</li></ul> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventLoopServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">DefaultEventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultEventLoopGroup</span>();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>()<br>            .group(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">2</span>))<br>            .channel(NioServerSocketChannel.class)<br>            .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioSocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    ch.pipeline().addLast(<span class="hljs-string">&quot;handler1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span>() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> (ByteBuf) msg;<br>                            System.out.println(buf.toString(Charset.defaultCharset()));<br>                            <span class="hljs-comment">// 传给下一个handler</span><br>                            ctx.fireChannelRead(msg);<br>                        &#125;<br>                    &#125;).addLast(group, <span class="hljs-string">&quot;handler2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span>() &#123;<br>                        <span class="hljs-comment">// 前后两个handler执行的线程不同时，由上一个线程发一个Runnable给下一个线程来执行</span><br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> (ByteBuf) msg;<br>                            System.out.println(buf.toString(Charset.defaultCharset()));<br>                        &#125;<br>                    &#125;);<br>                &#125;<br>            &#125;)<br>            .bind(<span class="hljs-number">8080</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Channel-1"><a href="#Channel-1" class="headerlink" title="Channel"></a>Channel</h5><p>读写数据的双向通道</p><p>主要方法：</p><ul><li>close()</li><li>closeFuture()：关闭channel后调用的方法</li><li>pipeline()：添加处理器</li><li>write()：写入数据到缓冲区</li><li>writeAndFlush()：写入数据并刷出</li></ul><p><strong>处理连接结果</strong></p><p>connect()是非阻塞方法，可以通过sync()当前线程阻塞等待连接建立，或者addListener()添加listener让其他线程等待连接。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventLoopClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, IOException &#123;<br>        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>()<br>            .group(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>())<br>            .channel(NioSocketChannel.class)<br>            .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioSocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());<br>                &#125;<br>            &#125;)<br>            .connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">&quot;localhost&quot;</span>, <span class="hljs-number">8080</span>));<br><br>        channelFuture.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelFutureListener</span>() &#123;<br>            <span class="hljs-comment">// 完成连接后会调用operationComplete</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                future.channel().writeAndFlush(<span class="hljs-string">&quot;www&quot;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>处理关闭</strong></p><p>调用channel.close()关闭channel后，可以用<code>ChannelFuture future = channel.closeFuture();</code>来进行善后处理</p><p>sync()同步处理，addListener()异步处理</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 前略</span><br><span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> channelFuture.channel();<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>    <span class="hljs-type">Scanner</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        System.out.print(<span class="hljs-string">&quot;: &quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> sc.nextLine();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;q&quot;</span>.equals(msg)) &#123;<br>            channel.close();<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        channel.writeAndFlush(msg);<br>    &#125;<br>&#125;, <span class="hljs-string">&quot;input&quot;</span>).start();<br><br><span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> channel.closeFuture();<br>future.sync();<br>System.out.println(<span class="hljs-string">&quot;善后工作&quot;</span>);<br></code></pre></td></tr></table></figure><h5 id="Future-amp-Promise"><a href="#Future-amp-Promise" class="headerlink" title="Future &amp; Promise"></a>Future &amp; Promise</h5><p>继承关系：jdk的Future &lt;– netty的Future &lt;– Promise</p><ul><li>jdk的Future只能同步等待任务结束</li><li>netty的Future可以同步或异步等待任务结束</li><li>Promise不仅有Future的功能，而且脱离了任务独立存在，只作为两个<strong>线程间传递结果的容器</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestJdkFuture</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>        Future&lt;Integer&gt; future = service.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Integer&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// 同步等待</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> future.get();<br>        System.out.println(i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestNettyFuture</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">NioEventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">2</span>);<br>        <span class="hljs-type">EventLoop</span> <span class="hljs-variable">eventLoop</span> <span class="hljs-operator">=</span> group.next();<br>        Future&lt;Integer&gt; future = eventLoop.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Integer&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">// 异步等待结果</span><br>        future.addListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericFutureListener</span>&lt;Future&lt;? <span class="hljs-built_in">super</span> Integer&gt;&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(Future&lt;? <span class="hljs-built_in">super</span> Integer&gt; future)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                System.out.println(Thread.currentThread() + <span class="hljs-string">&quot;:&quot;</span> + future.get());<br>            &#125;<br>        &#125;);<br>        System.out.println(Thread.currentThread());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestPromise</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException &#123;<br>        <span class="hljs-type">NioEventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">2</span>);<br>        DefaultPromise&lt;Integer&gt; promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultPromise</span>&lt;&gt;(group.next());<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            <span class="hljs-comment">// 往promise里装结果</span><br>            promise.setSuccess(<span class="hljs-number">1</span>);<br>        &#125;).start();<br><br>        System.out.println(promise.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Handler-amp-Pipeline"><a href="#Handler-amp-Pipeline" class="headerlink" title="Handler &amp; Pipeline"></a>Handler &amp; Pipeline</h5><p>Pipeline类似流水线，handler为流水线上的一道道工序</p><p>handler分为入站、出站两种</p><ul><li>入站处理器通常是<code>ChannelInBoundHandlerAdapter</code>的子类，读取客户端数据时触发，也可以向客户端写数据</li><li>出站处理器通常是<code>ChannelOutBoundHandlerAdapter</code>的子类，向客户端写回数据时触发，<em><strong>出站处理器的执行顺序适合入站处理器相反的</strong></em></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestPipeline</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>()<br>            .group(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>())<br>            .channel(NioServerSocketChannel.class)<br>            .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;NioSocketChannel&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(NioSocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ch.pipeline();<br>                    <span class="hljs-comment">// 加在 head -&gt; ... -&gt; h1 -&gt; tail</span><br>                    pipeline.addLast(<span class="hljs-string">&quot;h1&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span>()&#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            System.out.println(<span class="hljs-number">1</span>);<br>                            <span class="hljs-built_in">super</span>.channelRead(ctx, msg);<br>                        &#125;<br>                    &#125;);<br>                    <span class="hljs-comment">// 出站处理器在往channel中写数据时触发</span><br>                    <span class="hljs-comment">// 出站的处理顺序和入站时相反</span><br>                    pipeline.addLast(<span class="hljs-string">&quot;h2&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelOutboundHandlerAdapter</span>()&#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            System.out.println(<span class="hljs-number">2</span>);<br>                            <span class="hljs-built_in">super</span>.write(ctx, msg, promise);<br>                        &#125;<br>                    &#125;);<br>                &#125;<br>            &#125;)<br>            .bind(<span class="hljs-number">8080</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="ByteBuf"><a href="#ByteBuf" class="headerlink" title="ByteBuf"></a>ByteBuf</h5><p>是对字节数据的封装</p><h6 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h6><ul><li>池化</li><li>读写指针分离</li><li>可以自动扩容</li><li>支持链式调用</li><li>支持浅拷贝</li></ul><h6 id="自动扩容"><a href="#自动扩容" class="headerlink" title="自动扩容"></a>自动扩容</h6><p>写入后数据大小未超过512，则选择下一个16的整数倍扩容</p><p>写入后数据大小超过512，则选择下一个2^n扩容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestByteBuf</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.buffer();<br>        System.out.println(buf);    <span class="hljs-comment">// 起始256字节容量</span><br><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">300</span>; i++) &#123;<br>            sb.append(<span class="hljs-string">&quot;a&quot;</span>);<br>        &#125;<br>        buf.writeBytes(sb.toString().getBytes());<br>        System.out.println(buf);    <span class="hljs-comment">// 扩容后512字节容量</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="选择使用的内存"><a href="#选择使用的内存" class="headerlink" title="选择使用的内存"></a>选择使用的内存</h6><p>使用堆内存，写快读慢</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteBuf</span> <span class="hljs-variable">byteBuf</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.heapBuffer(<span class="hljs-number">10</span>);<br></code></pre></td></tr></table></figure><p>使用直接内存，写慢读快</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteBuf</span> <span class="hljs-variable">byteBuf</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.directBuffer(<span class="hljs-number">10</span>);<br></code></pre></td></tr></table></figure><h6 id="池化"><a href="#池化" class="headerlink" title="池化"></a>池化</h6><p>通过池来重用buf，4.1后默认开启</p><h6 id="回收"><a href="#回收" class="headerlink" title="回收"></a>回收</h6><p>根据实现方式不同，内存回收方式也不同</p><ul><li>UnpooledHeapByteBuf：使用的是JVM内存，只需GC内存回收即可</li><li>UnpooledDirectByteBuf：使用直接内存，需要特殊方法回收</li><li>PooledByteBuf：池化，不用时归还回池中，需要更复杂的规则来回收内存</li></ul><p>每个ByteBuf都实现ReferenceCounted接口，通过引用计数方式来判断是否需要回收</p><p>如果没释放Buf，在处理器链的尾&#x2F;头会被释放</p><h6 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h6><p>将一块ByteBuf切成逻辑上的两块，实际上没有发生数据的拷贝 </p><p>切片是不能扩容的</p><p>原buf释放内存会影响切片，可以通过retain()方法来计数加1从而不会释放内存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestByteBuf</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="hljs-number">10</span>);<br>        buf.writeBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>&#125;);<br><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> buf.slice(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>);<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> buf.slice(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>);<br>        System.out.println(f1);<br>        System.out.println(f2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h6><p>将多块ByteBuf合并成逻辑上的一块，实际上没有发生数据的拷贝 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestByteBuf</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf1</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="hljs-number">10</span>);<br>        buf1.writeBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>&#125;);<br><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf2</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.buffer(<span class="hljs-number">10</span>);<br>        buf2.writeBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;d&#x27;</span>&#125;);<br><br>        <span class="hljs-type">CompositeByteBuf</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.compositeBuffer();<br>        buffer.addComponent(<span class="hljs-literal">true</span>, buf1);<br>        buffer.addComponent(<span class="hljs-literal">true</span>, buf2);<br><br>        System.out.println(buffer);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h3><h4 id="粘包-半包"><a href="#粘包-半包" class="headerlink" title="粘包 半包"></a>粘包 半包</h4><p><strong>原因</strong>：用TCP协议传输数据，由于滑动窗口（缓冲区）传送的时候可能把一段数据分成了几份，导致接收方收到的数据不全（半包），或几条数据一起发过来（粘包）；ByteBuf大小也类似</p><p><strong>解决方式</strong>：</p><ol><li>定长解码器：<code>ch.pipline().addLast(new FixedLengthFrameDecode(长度))</code>规定每条消息的长度固定<ul><li>缺点：可能造成带宽的浪费</li></ul></li><li>分隔符：<code>ch.pipline().addLast(new LineBaseFrameDecoder(限定最大长度))</code>，以换行符为分隔符<ul><li>效率低</li></ul></li><li>LTC解码器：类似报头，如包含内容长度信息等</li></ol><h4 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h4><p>实例：处理http的入站信息和返回信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHttp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">NioEventLoopGroup</span> <span class="hljs-variable">boss</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br>        <span class="hljs-type">NioEventLoopGroup</span> <span class="hljs-variable">worker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>()<br>                .group(boss, worker)<br>                .channel(NioServerSocketChannel.class)<br>                .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;<br>                    <span class="hljs-meta">@Override</span><br>                    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                        <span class="hljs-comment">// http协议编码解码处理器</span><br>                        ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServerCodec</span>());<br>                        <span class="hljs-comment">// 指定处理HttpRequest的信息</span><br>                        ch.pipeline().addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;HttpRequest&gt;() &#123;<br>                            <span class="hljs-meta">@Override</span><br>                            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, HttpRequest msg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                                System.out.println(msg.uri());<br><br>                                <span class="hljs-type">DefaultFullHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFullHttpResponse</span>(msg.getProtocolVersion(), HttpResponseStatus.OK);<br>                                <span class="hljs-type">byte</span>[] bytes = <span class="hljs-string">&quot;&lt;h1&gt;Hello&lt;/h1&gt;&quot;</span>.getBytes();<br>                                response.headers().setInt(HttpHeaderNames.CONTENT_LENGTH, bytes.length);<br>                                response.content().writeBytes(bytes);<br>                                ctx.writeAndFlush(response);<br>                            &#125;<br>                        &#125;);<br>                    &#125;<br>                &#125;)<br>                .bind(<span class="hljs-number">8080</span>)<br>                .sync();<br>            channelFuture.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            boss.shutdownGracefully();<br>            worker.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="自定义协议"><a href="#自定义协议" class="headerlink" title="自定义协议"></a>自定义协议</h5><ol start="0"><li>要素</li></ol><p>​<img src="/img/inter_img/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8D%8F%E8%AE%AE%E8%A6%81%E7%B4%A0.png"></p><ol><li><p>消息类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据消息类型字节，获得对应的消息 class</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> messageType 消息类型字节</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 消息 class</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Message</span>&gt; getMessageClass(<span class="hljs-type">int</span> messageType) &#123;<br>        <span class="hljs-keyword">return</span> messageClasses.get(messageType);<br>    &#125;<br><br>    <span class="hljs-comment">// 请求序列号</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> sequenceId;<br><br>    <span class="hljs-comment">// 消息类型</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> messageType;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMessageType</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">// 指令类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LoginRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LoginResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ChatRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ChatResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupCreateRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupCreateResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupJoinRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupJoinResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupQuitRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupQuitResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupChatRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupChatResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">11</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupMembersRequestMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">12</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GroupMembersResponseMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">13</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PingMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">14</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PongMessage</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 请求类型 byte 值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">RPC_MESSAGE_TYPE_REQUEST</span> <span class="hljs-operator">=</span> <span class="hljs-number">101</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 响应类型 byte 值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>  <span class="hljs-variable">RPC_MESSAGE_TYPE_RESPONSE</span> <span class="hljs-operator">=</span> <span class="hljs-number">102</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Integer, Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Message</span>&gt;&gt; messageClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 抽象类的实现类</span><br>    <span class="hljs-keyword">static</span> &#123;<br>        messageClasses.put(LoginRequestMessage, LoginRequestMessage.class);<br>        messageClasses.put(LoginResponseMessage, LoginResponseMessage.class);<br>        messageClasses.put(ChatRequestMessage, ChatRequestMessage.class);<br>        messageClasses.put(ChatResponseMessage, ChatResponseMessage.class);<br>        messageClasses.put(GroupCreateRequestMessage, GroupCreateRequestMessage.class);<br>        messageClasses.put(GroupCreateResponseMessage, GroupCreateResponseMessage.class);<br>        messageClasses.put(GroupJoinRequestMessage, GroupJoinRequestMessage.class);<br>        messageClasses.put(GroupJoinResponseMessage, GroupJoinResponseMessage.class);<br>        messageClasses.put(GroupQuitRequestMessage, GroupQuitRequestMessage.class);<br>        messageClasses.put(GroupQuitResponseMessage, GroupQuitResponseMessage.class);<br>        messageClasses.put(GroupChatRequestMessage, GroupChatRequestMessage.class);<br>        messageClasses.put(GroupChatResponseMessage, GroupChatResponseMessage.class);<br>        messageClasses.put(GroupMembersRequestMessage, GroupMembersRequestMessage.class);<br>        messageClasses.put(GroupMembersResponseMessage, GroupMembersResponseMessage.class);<br>        messageClasses.put(RPC_MESSAGE_TYPE_REQUEST, RpcRequestMessage.class);<br>        messageClasses.put(RPC_MESSAGE_TYPE_RESPONSE, RpcResponseMessage.class);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编解码器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageCodec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ByteToMessageCodec</span>&lt;Message&gt; &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 编码成自定义的协议格式</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channelHandlerContext</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> out</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">(ChannelHandlerContext channelHandlerContext, Message msg, ByteBuf out)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 魔数 5字节</span><br>        out.writeBytes(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]&#123;<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>&#125;);<br>        <span class="hljs-comment">// 版本号  1字节</span><br>        out.writeByte(<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 序列化方式，指定 0 jdk，1 json  1字节</span><br>        out.writeByte(<span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// 指令类型  1字节</span><br>        out.writeByte(msg.getMessageType());<br>        <span class="hljs-comment">// 请求序号，提供异步能力  4字节</span><br>        out.writeInt(msg.getSequenceId());<br>        <span class="hljs-comment">// 获取正文</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bos);<br>        oos.writeObject(msg);<br>        <span class="hljs-type">byte</span>[] bytes = bos.toByteArray();<br>        <span class="hljs-comment">// 正文长度 4字节</span><br>        out.writeInt(bytes.length);<br>        <span class="hljs-comment">// 正文</span><br>        out.writeBytes(bytes);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(ChannelHandlerContext channelHandlerContext, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 读取魔数</span><br>        <span class="hljs-type">byte</span>[] magic = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">5</span>];<br>        in.readBytes(magic);<br>        <span class="hljs-comment">// 读取版本</span><br>        <span class="hljs-type">byte</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> in.readByte();<br>        <span class="hljs-comment">// 读取序列化方式</span><br>        <span class="hljs-type">byte</span> <span class="hljs-variable">serializerType</span> <span class="hljs-operator">=</span> in.readByte();<br>        <span class="hljs-comment">// 读取指令类型</span><br>        <span class="hljs-type">byte</span> <span class="hljs-variable">messageType</span> <span class="hljs-operator">=</span> in.readByte();<br>        <span class="hljs-comment">// 读取序列号</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">sequenceId</span> <span class="hljs-operator">=</span> in.readInt();<br>        <span class="hljs-comment">// 读取正文长度</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> in.readInt();<br>        <span class="hljs-comment">// 读取正文</span><br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[length];<br>        in.readBytes(bytes, <span class="hljs-number">0</span>, length);<br><br>        <span class="hljs-comment">// 反序列化成Message</span><br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes));<br>        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (Message) ois.readObject();<br><br>        System.out.println(Arrays.toString(magic));<br>        System.out.println(version);<br>        System.out.println(serializerType);<br>        System.out.println(messageType);<br>        System.out.println(sequenceId);<br>        System.out.println(length);<br>        System.out.println(message);<br><br>        <span class="hljs-comment">// 传给下一个handler</span><br>        out.add(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">EmbeddedChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedChannel</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldBasedFrameDecoder</span>(<span class="hljs-number">1024</span>, <span class="hljs-number">12</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-comment">// 解决粘包半包</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>());<br><br>        <span class="hljs-comment">// 模拟发送消息</span><br>        <span class="hljs-type">LoginRequestMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginRequestMessage</span>(<span class="hljs-string">&quot;zs&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>        channel.writeOutbound(message);<br><br>        <span class="hljs-comment">// 模拟接收</span><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> ByteBufAllocator.DEFAULT.buffer();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageCodec</span>().encode(<span class="hljs-literal">null</span>, message, buf);  <span class="hljs-comment">// 编码后写到buf</span><br>        channel.writeInbound(buf);  <span class="hljs-comment">// 入站</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">输出</span><br><span class="hljs-comment">[1, 1, 4, 5, 1]</span><br><span class="hljs-comment">1</span><br><span class="hljs-comment">0</span><br><span class="hljs-comment">0</span><br><span class="hljs-comment">0</span><br><span class="hljs-comment">193</span><br><span class="hljs-comment">LoginRequestMessage(super=Message(sequenceId=0, messageType=0), username=zs, password=123456)</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>网络</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>算法</title>
    <link href="/2023/02/23/%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/"/>
    <url>/2023/02/23/%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><h3 id="回溯"><a href="#回溯" class="headerlink" title="回溯"></a>回溯</h3><p>如果解决一个问题需要若干步骤，并且每一个步骤都面临若干选项，则可以尝试回溯</p><p>回溯模板</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(参数)</span> &#123;<br>    <span class="hljs-keyword">if</span> (终止条件) &#123;<br>        存放结果;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (选择元素) &#123;<br>        添加元素;<br>        dfs();<br>        撤销元素<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>回溯法常用排序来剪枝</p><h3 id="二进制枚举"><a href="#二进制枚举" class="headerlink" title="二进制枚举"></a>二进制枚举</h3><p>通过二进制数的0&#x2F;1 表示 选择&#x2F;变换 对应位置上的字符&#x2F;数字</p><p>例如求字符串的所有子集</p><p>若字符串长为3，则可以选择或不选择这个位置上的字符来组成子集，有2 ^ 3种构成方式</p><p>可以通过0~2^n的二进制来表示选或者不选</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">count</span><span class="hljs-params">(String s)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> s.length();<br>    <br>    List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; (<span class="hljs-number">1</span> &lt;&lt; n); ++i) &#123;<span class="hljs-comment">//1 &lt;&lt; n 等价于 2^n</span><br>        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; n; ++j) &#123;<br>            <span class="hljs-keyword">if</span> (((i &gt;&gt; j) &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) &#123;<span class="hljs-comment">// 判断该位上二进制数</span><br>                sb.append(s.charAt(j));<br>            &#125;<br>        &#125;<br>        list.add(sb.toString());<br>    &#125;<br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>二进制枚举适合n比较小的题，n大的话得通过dfs的剪枝来降低复杂度</strong></p><p><strong>例题</strong></p><p><a href="https://leetcode.cn/problems/letter-case-permutation/">784. 字母大小写全排列 - 力扣（LeetCode）</a></p><h3 id="并查集"><a href="#并查集" class="headerlink" title="并查集"></a>并查集</h3><p><a href="https://www.runoob.com/data-structures/union-find-basic.html">并查集基础 | 菜鸟教程 (runoob.com)</a></p><p>模板</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnionFind</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] parent;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UnionFind</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        parent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];<br>        <span class="hljs-built_in">this</span>.size = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 添加元素</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>        parent[x] = x;<br>        size++;<br>    &#125;<br><br>    <span class="hljs-comment">// 查找x对应的集合编号</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">find</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> &#123;<br>        <span class="hljs-keyword">if</span> (parent[x] != x)<br>            parent[x] = find(parent[x]);<br>        <span class="hljs-keyword">return</span> parent[x];<br>    &#125;<br><br>    <span class="hljs-comment">// 查看p，q是否属于同一个集合</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isConnected</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> &#123;<br>        <span class="hljs-keyword">return</span> find(x) == find(y);<br>    &#125;<br><br>    <span class="hljs-comment">// 合并两个元素</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> &#123;<br>        x = find(x);<br>        y = find(y);<br>        <span class="hljs-keyword">if</span> (x != y) &#123;<br>            parent[x] = parent[y];<br>            size--;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>例题</strong></p><p><a href="https://leetcode.cn/problems/minimum-score-of-a-path-between-two-cities/">6255. 两个城市间路径的最小分数 - 力扣（LeetCode）</a></p><h3 id="格雷码"><a href="#格雷码" class="headerlink" title="格雷码"></a>格雷码</h3><p><a href="https://leetcode.cn/problems/gray-code/">89. 格雷编码 - 力扣（LeetCode）</a></p><p>在格雷码中，任意两个相邻的代码只有一位二进制数不同，最大码与最小码之间也仅一位不同</p><p>转换方式：普通二进制记为Bn-1 Bn-2 … B0，格雷码记为Gn-1 Gn-2 … G0       </p><p>Gn-1 &#x3D; Bn-1;</p><p>Gi &#x3D; Bi+1 异或 Bi  (0 &lt;&#x3D; i &lt;&#x3D; n - 2)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">grayCode</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    List&lt;Integer&gt; res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; (<span class="hljs-type">int</span>)Math.pow(<span class="hljs-number">2</span>, n); ++i) &#123;<br>        res.add((i &gt;&gt; <span class="hljs-number">1</span>) ^ i);<br>    &#125;<br>    <span class="hljs-keyword">return</span> res;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="树遍历"><a href="#树遍历" class="headerlink" title="树遍历"></a>树遍历</h3><h4 id="递归写法"><a href="#递归写法" class="headerlink" title="递归写法"></a>递归写法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 中序</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">LDR</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    LDR(node.left);<br>    System.out.println(node.val);<br>    LDR(node.right);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 先序</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">DLR</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    System.out.println(node.val);<br>    DLR(node.left);<br>    DLR(node.right);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 后序</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">LRD</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    LRD(node.left);<br>    LRD(node.right);<br>    System.out.println(node.val);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="迭代写法"><a href="#迭代写法" class="headerlink" title="迭代写法"></a>迭代写法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 中序</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">LDR</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    Deque&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br>    <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span> || !stack.isEmpty()) &#123;<br>        <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(node);<br>            node = node.left;<br>        &#125;<br>        node = stack.poll();<br>        System.out.println(node.val);<br>        node = node.right;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 先序</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">DLR</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    Deque&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br>    <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span> || !stack.isEmpty()) &#123;<br>        <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span>) &#123;<br>            System.out.println(node.val);<br>            stack.push(node);<br>            node = node.left;<br>        &#125;<br>        node = stack.poll();<br>        node = node.right;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 后序</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">LRD</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    Deque&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br>    <span class="hljs-comment">// 记录上一个访问的节点</span><br>    <span class="hljs-type">TreeNode</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span> || !stack.isEmpty()) &#123;<br>        <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(node);<br>            node = node.left;<br>        &#125;<br>     node = stack.peek();<br>        <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span> &amp;&amp; node.right != prev) &#123;<br>            node = node.right;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            stack.poll();<br>            System.out.println(node.val);<br>            prev = node;<br>            node = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="前缀和"><a href="#前缀和" class="headerlink" title="前缀和"></a>前缀和</h3><p>设数组nums，前缀和数组s，则s[i + 1] &#x3D; s[i] + nums[i]，s[i]表示nums[i]<strong>前面</strong>元素之和</p><p>通过前缀和，我们可以把<strong>子数组的元素和转换成两个前缀和的差</strong></p><p>如nums &#x3D; [1, 2, -1, 2]，则子数组[2, -1, 2]的和为s[4] - s[1] &#x3D; 3</p><h3 id="前缀树"><a href="#前缀树" class="headerlink" title="前缀树"></a>前缀树</h3><p>模板</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Trie</span> &#123;<br>    TrieNode root;<br><br>    <span class="hljs-comment">/** Initialize your data structure here. */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Trie</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>.root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();<br>    &#125;<br><br>    <span class="hljs-comment">/** Inserts a word into the trie. */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(String word)</span> &#123;<br>        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> ch : word.toCharArray()) &#123;<br>            <span class="hljs-keyword">if</span> (node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>] == <span class="hljs-literal">null</span>) &#123;<br>                node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>();<br>            &#125;<br>            node = node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>];<br>        &#125;<br>        node.isWord = <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/** Returns if the word is in the trie. */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">search</span><span class="hljs-params">(String word)</span> &#123;<br>        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> ch : word.toCharArray()) &#123;<br>            <span class="hljs-keyword">if</span> (node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>] == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            node = node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>];<br>        &#125;<br>        <span class="hljs-keyword">return</span> node.isWord == <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/** Returns if there is any word in the trie that starts with the given prefix. */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">startsWith</span><span class="hljs-params">(String prefix)</span> &#123;<br>        <span class="hljs-type">TrieNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> root;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> ch : prefix.toCharArray()) &#123;<br>            <span class="hljs-keyword">if</span> (node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>] == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br>            node = node.children[ch - <span class="hljs-string">&#x27;a&#x27;</span>];<br>        &#125;<br>        <span class="hljs-keyword">return</span> node != <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrieNode</span> &#123;<br>        TrieNode[] children;<br>        <span class="hljs-type">boolean</span> isWord;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">TrieNode</span><span class="hljs-params">()</span> &#123;<br>            children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrieNode</span>[<span class="hljs-number">26</span>];<br>            isWord = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><h4 id="计数排序"><a href="#计数排序" class="headerlink" title="计数排序"></a>计数排序</h4><p>设数组长度为n，数组最大值和最小值差为k</p><p><strong>时间复杂度</strong>：O(n + k)</p><p><strong>空间复杂度</strong>：O(k)</p><p><strong>适用范围</strong>：k远小于n时，时间复杂度可视为O(n)，优于其他基于比较的排序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) &#123;<br>        min = Math.min(min, num);<br>        max = Math.max(max, num);<br>    &#125;<br>    <span class="hljs-type">int</span>[] counts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[max - min + <span class="hljs-number">1</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) &#123;<br>        counts[num - min]++;<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> min; num &lt;= max; ++num) &#123;<br>        <span class="hljs-keyword">while</span> (counts[num - min] &gt; <span class="hljs-number">0</span>) &#123;<br>            nums[idx] = num;<br>            counts[num - min]--;<br>            idx++;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> nums;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h4><p>时间复杂度：最好O(nlogn)，最差O(n ^ 2)</p><p>空间复杂度：O(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>    quicksort(nums, <span class="hljs-number">0</span>, nums.length - <span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> nums;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quicksort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>    <span class="hljs-keyword">if</span> (start &lt; end) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> partition(nums, start, end);<br>        quicksort(nums, start, pivot - <span class="hljs-number">1</span>);<br>        quicksort(nums, pivot + <span class="hljs-number">1</span>, end);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(end - start + <span class="hljs-number">1</span>) + start;<br>    swap(nums, random, end);<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">small</span> <span class="hljs-operator">=</span> start - <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">big</span> <span class="hljs-operator">=</span> start; big &lt; end; ++big) &#123;<br>        <span class="hljs-keyword">if</span> (nums[big] &lt; nums[end]) &#123;<br>            small++;<br>            swap(nums, small, big);<br>        &#125;<br>    &#125;<br>    small++;<br>    swap(nums, small, end);<br>    <span class="hljs-keyword">return</span> small;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h4><p>时间复杂度：O(nlogn)</p><p>空间复杂度：O(n)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归写法</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] sortArray(<span class="hljs-type">int</span>[] nums) &#123;<br>    <span class="hljs-type">int</span>[] dst = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[nums.length];<br>    dst = Arrays.copyOf(nums, nums.length);<br>    mergeSort(nums, dst, <span class="hljs-number">0</span>, nums.length);<br>    <span class="hljs-keyword">return</span> dst;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mergeSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] nums, <span class="hljs-type">int</span>[] dst, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>    <span class="hljs-keyword">if</span> (start + <span class="hljs-number">1</span> &gt;= end) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> start + ((end - start) &gt;&gt; <span class="hljs-number">1</span>);<br>    mergeSort(nums, dst, start, mid);<br>    mergeSort(nums, dst, mid, end);<br>    <br>    <span class="hljs-comment">// 合并两个部分</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start, j = mid, k = start;<br>    <span class="hljs-keyword">while</span> (i &lt; mid || j &lt; end) &#123;<br>        <span class="hljs-keyword">if</span> (j == end || (i &lt; mid &amp;&amp; nums[i] &lt; nums[j])) &#123;<br>            dst[k++] = nums[i++];<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            dst[k++] = nums[j++];<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="同余"><a href="#同余" class="headerlink" title="同余"></a>同余</h3><p>​<strong>定义</strong>：两个数x和y，如果<code>(x - y) mod m = 0</code>，则称x与y对模m同余，记作：<code>x = y (mod m)</code></p><p>也就是说两个数模一个数后得到相同的数，例如 <code>42 = 12 （mod 10）</code>、<code>-17 = 3 （mod 10）</code></p><p>​<strong>处理取模技巧</strong>：如果数x为负数，则 <code>x mod m = y mod m</code> 等同于<code>(x mod m + m) mod m = y mod m</code></p><p>例题：<a href="https://leetcode.cn/problems/smallest-missing-non-negative-integer-after-operations/">6321. 执行操作后的最大 MEX - 力扣（LeetCode）</a></p><h3 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h3><h4 id="数位DP"><a href="#数位DP" class="headerlink" title="数位DP"></a>数位DP</h4><p>数位 DP：用来解决一类特定问题，这种问题比较好辨认，一般具有这几个特征：</p><ol><li>要求统计满足一定条件的数的数量（即，最终目的为计数）；</li><li>这些条件经过转化后可以使用「数位」的思想去理解和判断；</li><li>输入会提供一个数字区间（有时也只提供上界）来作为统计的限制；</li><li>上界很大（比如 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="10^{18}">10 ^ 18)，暴力枚举验证会超时。</li></ol><p><strong>基本原理</strong>：</p><p>​考虑人类计数的方式，最朴素的计数就是从小到大开始依次加一。但我们发现对于位数比较多的数，这样的过程中有许多重复的部分。例如，从 7000 数到 7999、从 8000 数到 8999、和从 9000 数到 9999 的过程非常相似，它们都是后三位从 000 变到 999，不一样的地方只有千位这一位，所以我们可以把这些过程归并起来，将这些过程中产生的计数答案也都存在一个通用的数组里。</p><p>例题：<a href="https://leetcode.cn/problems/numbers-with-repeated-digits/">1012. 至少有 1 位重复的数字 - 力扣（LeetCode）</a></p><h4 id="背包问题"><a href="#背包问题" class="headerlink" title="背包问题"></a>背包问题</h4><p><strong>01背包</strong></p><p>背包容量从后往前推，每轮尝试将一个物品放入背包</p><p><a href="https://leetcode.cn/problems/YaVDxD/?favorite=e8X3pBZi">剑指 Offer II 102. 加减的目标值 - 力扣（LeetCode）</a></p><p><strong>多重背包</strong></p><p>背包容量从前往后推，尝试将每个物品放入每个背包容量</p><p><a href="https://leetcode.cn/problems/gaM7Ch/?favorite=e8X3pBZi">剑指 Offer II 103. 最少的硬币数目 - 力扣（LeetCode）</a></p><h3 id="找质数"><a href="#找质数" class="headerlink" title="找质数"></a>找质数</h3><blockquote><p>质数是指在大于1的自然数中，除了1和它本身以外不再有其他因数的自然数。</p></blockquote><h4 id="埃氏筛"><a href="#埃氏筛" class="headerlink" title="埃氏筛"></a>埃氏筛</h4><p><strong>定义</strong></p><p>​给出要筛<a href="https://baike.baidu.com/item/%E6%95%B0%E5%80%BC?fromModule=lemma_inlink">数值</a>的范围n，找出以内的<a href="https://baike.baidu.com/item/%E7%B4%A0%E6%95%B0?fromModule=lemma_inlink">素数</a>。先用2去筛，即把2留下，把2的倍数剔除掉；再用下一个<a href="https://baike.baidu.com/item/%E8%B4%A8%E6%95%B0?fromModule=lemma_inlink">质数</a>，也就是3筛，把3留下，把3的倍数剔除掉；接下去用下一个质数5筛，把5留下，把5的<a href="https://baike.baidu.com/item/%E5%80%8D%E6%95%B0?fromModule=lemma_inlink">倍数</a>剔除掉；不断重复下去……。</p><p><strong>模板</strong></p><p>预处理出质数列表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (Integer i : <span class="hljs-keyword">new</span> <span class="hljs-title class_">Main</span>().primeList()) &#123;<br>            System.out.println(i);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-type">int</span> <span class="hljs-variable">MAX</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) Math.pow(<span class="hljs-number">10</span>, <span class="hljs-number">4</span>) + <span class="hljs-number">1</span>;<br>    <br>    <span class="hljs-keyword">public</span> List&lt;Integer&gt; <span class="hljs-title function_">primeList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">boolean</span>[] isPrime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[MAX];<br>        Arrays.fill(isPrime, <span class="hljs-literal">true</span>);<br><br>        List&lt;Integer&gt; primes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; i &lt; MAX; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (isPrime[i]) &#123;<br>                primes.add(i);<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i * i; j &lt; MAX; j += i) &#123;<br>                    isPrime[j] = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> primes;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>例题</strong></p><p>​<a href="https://leetcode.cn/problems/prime-subtraction-operation/">6355. 质数减法运算 - 力扣（LeetCode）</a></p><h3 id="最大公因数-x2F-最小公倍数"><a href="#最大公因数-x2F-最小公倍数" class="headerlink" title="最大公因数&#x2F;最小公倍数"></a>最大公因数&#x2F;最小公倍数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javav">public int gcd(int a, int b) &#123;<br>return b == 0 ? a : gcd(b, a % b);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">lcm</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> &#123;<br><span class="hljs-keyword">return</span> (a * b) / gcd(a, b);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="字符串匹配KMP"><a href="#字符串匹配KMP" class="headerlink" title="字符串匹配KMP"></a>字符串匹配KMP</h3><p>如果暴力匹配，如果模式串和主串不匹配时，模式串需要从头开始匹配；</p><p>使用KMP的话，可以通过next数组来回退模式串来继续匹配，不用再从头开始</p><ul><li>next数组：记录了模式串与主串(文本串)不匹配的时候，模式串应该从哪里开始重新匹配</li></ul><blockquote><p>next 计算方式为最长公共前缀+1</p><p>这里的next是优化后的, </p><p>口算的方式为先计算普通的next数组，</p><p>然后遍历next，找对应指向的下标-1的位置的字符是否与当前的相等,</p><p>如果相等就将值改为它的值，否则不变</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> &#123;<br>    <span class="hljs-comment">// KMP算法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">strStr</span><span class="hljs-params">(String haystack, String needle)</span> &#123;<br>        <span class="hljs-type">char</span>[] hChs = haystack.toCharArray();<br>        <span class="hljs-type">char</span>[] nChs = needle.toCharArray();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> hChs.length, n = nChs.length;<br><br>        <span class="hljs-type">int</span>[] next = next(nChs);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; m; ++i) &#123;<br>            <span class="hljs-keyword">while</span>(j - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; hChs[i] != nChs[j])<br>                j = next[j - <span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span> (hChs[i] == nChs[j])<br>                j++;<br>            <span class="hljs-keyword">if</span> (j == n)<br>                <span class="hljs-keyword">return</span> i - n + <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] next(<span class="hljs-type">char</span>[] chs) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> chs.length;<br>        <span class="hljs-type">int</span>[] next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, i = <span class="hljs-number">1</span>; i &lt; n; ++i) &#123;<br>            <span class="hljs-keyword">while</span> (j - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span> &amp;&amp; chs[i] != chs[j])<br>                j = next[j - <span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">if</span> (chs[i] == chs[j])<br>                j++;<br>            next[i] = j;<br>        &#125;<br>        <span class="hljs-keyword">return</span> next;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="最短路径"><a href="#最短路径" class="headerlink" title="最短路径"></a>最短路径</h3><p><strong>Floyd算法</strong></p><p>Floyd算法的基本思想是通过逐个考虑每一个节点作为中间节点，更新所有节点之间的最短路径。</p><p>Floyd算法属于动态规划</p><p>时间复杂度O(n^3)，适合节点少的图</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 例子</span><br><br><span class="hljs-comment">// dist[i][j]表示点i到点j的最短距离</span><br><span class="hljs-type">int</span>[][] dist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n][n];<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) &#123;<br>    Arrays.fill(dist[i], Integer.MAX_VALUE &gt;&gt; <span class="hljs-number">1</span>);<br>    dist[i][i] = <span class="hljs-number">0</span>;<span class="hljs-comment">// 点到自身的距离为0</span><br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] edge : edges) &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> edge[<span class="hljs-number">0</span>], j = edge[<span class="hljs-number">1</span>], weight = edge[<span class="hljs-number">2</span>];<br>    dist[i][j] = weight;<br>    dist[j][i] = weight;<br>&#125;<br><br><span class="hljs-comment">// Floyd 算法, 通过点k来更新i到j间的最短距离</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; n; k++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; n; j++) &#123;<br>            dist[i][j] = Math.min(dist[i][j], dist[i][k] + dist[k][j]);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Dijkstra算法</strong></p><p>Dijkstra算法的基本思想是从起点开始，依次寻找距离起点最近的节点，并更新其相邻节点的距离和路径。在每一次迭代中，Dijkstra算法会选择当前距离起点最近的未标记节点，将其标记为已访问，并更新其相邻节点的距离和路径</p><p>Dijkstra算法属于贪心</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 例子</span><br><br><span class="hljs-comment">// dist[i][j]表示点i到点j的最短距离</span><br><span class="hljs-type">int</span>[][] dist = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n][n];<br><span class="hljs-type">int</span>[][] mp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n][n];<br><span class="hljs-type">boolean</span>[][] vis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[n][n];<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) &#123;<br>    Arrays.fill(dist[i], Integer.MAX_VALUE &gt;&gt; <span class="hljs-number">1</span>);<br>    Arrays.fill(mp[i], Integer.MAX_VALUE &gt;&gt; <span class="hljs-number">1</span>);<br>    dist[i][i] = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span>[] edge : edges) &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> edge[<span class="hljs-number">0</span>], j = edge[<span class="hljs-number">1</span>], weight = edge[<span class="hljs-number">2</span>];<br>    mp[i][j] = weight;<br>    mp[j][i] = weight;<br>&#125;<br><br><span class="hljs-comment">// Dijkstra算法</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; n; ++j) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; n; ++k) &#123;<br>            <span class="hljs-keyword">if</span> (!vis[i][k] &amp;&amp; (min == -<span class="hljs-number">1</span> || dist[i][k] &lt; dist[i][min])) &#123;<br>                min = k;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; k &lt; n; ++k) &#123;<br>            dist[i][k] = Math.min(dist[i][k], dist[i][min] + mp[min][k]);<br>        &#125;<br>        vis[i][min] = <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>算法</category>
      
    </categories>
    
    
    <tags>
      
      <tag>算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>面试题</title>
    <link href="/2023/02/21/%E5%85%B6%E4%BB%96/%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <url>/2023/02/21/%E5%85%B6%E4%BB%96/%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h1 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h1><h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><h4 id="二分"><a href="#二分" class="headerlink" title="二分"></a>二分</h4><p>问题1：128个元素最多二分几次找到目标</p><p>答：128 &#x3D; 2^7，最多7次</p><p>问题2：100000000000个元素最多二分几次找到目标</p><p>答：</p><p>​公式：<font color="red">logb(a) &#x3D; logc(a) &#x2F; logc(b)</font></p><p>​log2(100000000000) &#x3D; log10(100000000000) &#x2F; log10(2)，向上取整</p><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><h5 id="经典排序算法"><a href="#经典排序算法" class="headerlink" title="经典排序算法"></a>经典排序算法</h5><p><strong>冒泡排序</strong>：每次相邻两个元素比较，一趟选出一个最大&#x2F;最小的元素</p><p>示例代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 优化过的冒泡，记录最后一次交换索引作为下轮冒泡的比较次数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bubble</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> arr.length - <span class="hljs-number">1</span>;<span class="hljs-comment">// 记录每次循环比较的次数</span><br>    <span class="hljs-keyword">while</span> (n &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<span class="hljs-comment">// 记录最后一次交换的索引</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n; ++i) &#123;<br>            <span class="hljs-keyword">if</span> (arr[i] &gt; arr[i + <span class="hljs-number">1</span>]) &#123;<br>                swap(arr, i, i + <span class="hljs-number">1</span>);<br>                last = i;<br>            &#125;<br>        &#125;<br>        n = last;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>选择排序</strong>：每次选择一个最大&#x2F;最小元素，放到已排序区域的末尾</p><p>示例代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">selection</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length - <span class="hljs-number">1</span>; ++i) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> i;<span class="hljs-comment">// 最小元素下标</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> s + <span class="hljs-number">1</span>; j &lt; arr.length; ++j) &#123;<br>            <span class="hljs-keyword">if</span> (arr[s] &gt; arr[j])<br>                s = j;<br>        &#125;<br>        swap(arr, s, i);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>插入排序</strong>：遍历每个元素，插入到已排序区域中适合的位置</p><p>示例代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr)</span> &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; arr.length; ++i) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">tmp</span> <span class="hljs-operator">=</span> arr[i];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i - <span class="hljs-number">1</span>; j &gt;= <span class="hljs-number">0</span>; --j) &#123;<br>            <span class="hljs-keyword">if</span> (arr[j] &gt; tmp) &#123;<br>                arr[j + <span class="hljs-number">1</span>] = arr[j];<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        arr[j + <span class="hljs-number">1</span>] = tmp;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>希尔排序</strong>：开始选定一个间隙n，每轮排序间隔n的元素，之后减小n再排序，直到n&#x3D;1。这么做大的元素会更快的往右边靠，减少之后的移动次数。</p><p><strong>快速排序</strong>：每轮找一个基准点进行分区，比基准点小的放到基准点左边，大的放到基准点右边。直到分区内元素个数小于等于1。</p><ol><li><p>单边循环快排</p><ol><li><p>以最右边元素作为基准点</p></li><li><p>i，j指针指向左边界的元素</p></li><li><p>j往右移，当找到比基准点小的元素就和i交换，i++</p></li><li><p>当交换完后i和基准点交换，这样基准点左边的元素就比基准点小</p></li></ol><p>示例代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> staic <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>&#125;;<br>    quick(arr, <span class="hljs-number">0</span>, arr.length - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> &#123;<br>    <span class="hljs-keyword">if</span> (l &gt;= r)<br>        <span class="hljs-keyword">return</span>;<br> <span class="hljs-type">int</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> partition(arr, l, r);<br>    partition(arr, l, p - <span class="hljs-number">1</span>);<br>    partition(arr, p + <span class="hljs-number">1</span>, r);<br>&#125;<br><br><span class="hljs-comment">// 分区，返回中间下标</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> &#123;<br>    <span class="hljs-keyword">if</span> (l &gt;= r)<br>        <span class="hljs-keyword">return</span> l;<br><span class="hljs-type">int</span> <span class="hljs-variable">pv</span> <span class="hljs-operator">=</span> a[r];<span class="hljs-comment">// 基准点</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> l;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> l; j &lt; r; ++j) &#123;<br>        <span class="hljs-keyword">if</span> (arr[j] &lt; pv) &#123;<br>            swap(arr, i, j);<br>            ++i;<br>        &#125;<br>    &#125;<br>    swap(arr, r, i);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>双边循环快排(更快一点)</p><ol><li>以最左边元素作为基准点</li><li>i指向左边界，j指向右边界，两边互找</li><li>当i，j相遇时吧基准点和i交换</li></ol><p>示例代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> staic <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>&#125;;<br>    quick(arr, <span class="hljs-number">0</span>, arr.length - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">quickSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> &#123;<br>    <span class="hljs-keyword">if</span> (l &gt;= r)<br>        <span class="hljs-keyword">return</span>;<br> <span class="hljs-type">int</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> partition(arr, l, r);<br>    partition(arr, l, p - <span class="hljs-number">1</span>);<br>    partition(arr, p + <span class="hljs-number">1</span>, r);<br>&#125;<br><br><span class="hljs-comment">// 分区，返回中间下标</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pv</span> <span class="hljs-operator">=</span> arr[l];<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> l, j = r;<br>    <span class="hljs-keyword">while</span> (i &lt; j) &#123;<br>        <span class="hljs-comment">// 这两个while不能交换</span><br>        <span class="hljs-keyword">while</span> (i &lt; j &amp;&amp; arr[j] &gt; pv)<br>            --j;<br>        <span class="hljs-keyword">while</span> (i &lt; j &amp;&amp; arr[i] &lt;= pv)<br>            ++i;<br>        swap(arr, i, j);<br>    &#125;<br>    swap(arr, l, i);<br>    <span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/else_img/%E6%8E%92%E5%BA%8F.png"></p></li></ol><h4 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h4><p><img src="/img/else_img/%E9%9B%86%E5%90%88%E5%85%B3%E7%B3%BB%E5%9B%BE.png"></p><h5 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h5><h6 id="成员变量-x2F-构造函数"><a href="#成员变量-x2F-构造函数" class="headerlink" title="成员变量&#x2F;构造函数"></a>成员变量&#x2F;构造函数</h6><table><thead><tr><th>变量</th><th>说明</th></tr></thead><tbody><tr><td>Object[] elementData</td><td>存放元素</td></tr><tr><td>int size</td><td>大小</td></tr><tr><td>static final int DEFAULT_CAPACITY &#x3D; 10</td><td>初始容量</td></tr><tr><td>static final Object[] EMPTY_ELEMENTDATA &#x3D; {}</td><td></td></tr><tr><td>static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA &#x3D; {}</td><td></td></tr></tbody></table><table><thead><tr><th>构造函数</th><th>说明</th></tr></thead><tbody><tr><td>public ArrayList(int initialCapacity)</td><td>若参数合法则根据参数来初始化此容量的集合</td></tr><tr><td>public ArrayList()</td><td>elementData &#x3D; DEFAULTCAPACITY_EMPTY_ELEMENTDATA</td></tr><tr><td>public ArrayList(Collection&lt;? extends E&gt; c)</td><td>将c转换成数组，将数组的地址赋给elementData</td></tr></tbody></table><h6 id="扩容机制"><a href="#扩容机制" class="headerlink" title="扩容机制"></a>扩容机制</h6><p>​<strong>初始化</strong>：无参构造刚创建出来的时候容量为0，有参则按传入的值或集合的大小作为容量</p><p>​<strong>add方法</strong>：</p><ol><li>添加元素时会先判断添加元素后的容量是否超过当前容量</li><li>如果是无参构造，首次添加元素时会创建一个容量为<code>DEFAULT_CAPACITY=10</code>的数组，</li><li>之后每次添加元素容量不足时会按原数组容量的<strong>1.5倍</strong>（向下取整）创建新数组，把原数组的元素复制到新数组中，用新数组替换原数组。</li></ol><p>​<strong>addAll方法</strong>：没有元素时扩容为Math.max(10, 实际元素个数)，有元素时为Math.max(原容量1.5倍, 实际元素个数)。</p><h6 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h6><p>当在使用迭代器时有其它线程修改数组时有两种<strong>策略</strong>：</p><ol><li><strong>fail-fast</strong>：在使用迭代器的线程立即报错</li><li><strong>fail-safe</strong>：发现有人修改了则采取一些对策，例如牺牲一些一致性来让整个遍历完成</li></ol><p><strong>原理</strong></p><p>​fail-fast是在创建迭代器时记录数组被修改的次数，每次获取下一个元素时判断现在数组的修改次数是否和之前记录的保持一致，如果不一致则报错（类似乐观锁）。</p><blockquote><p>ArrayList使用的第一种策略，CopyOnWriteArrayList是第二种策略（对策是添加把原集合复制出来，在新集合上进行修改，修改好后指向新集合。创建迭代器时会指向当前集合，遍历的是旧集合不影响（读写分离））；</p></blockquote><h6 id="数组和List之间的转换"><a href="#数组和List之间的转换" class="headerlink" title="数组和List之间的转换"></a>数组和List之间的转换</h6><p>数组转List（浅拷贝）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">String[] strs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>&#125;;<br>List&lt;String&gt; list = Arrays.asList(strs);<br></code></pre></td></tr></table></figure><p>List转数组（深拷贝）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>list.add(<span class="hljs-string">&quot;a&quot;</span>); list.add(<span class="hljs-string">&quot;b&quot;</span>);<br>String[] strs = list.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[list.size()]);<br></code></pre></td></tr></table></figure><h5 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h5><h6 id="与ArrayList的比较"><a href="#与ArrayList的比较" class="headerlink" title="与ArrayList的比较"></a>与ArrayList的比较</h6><ul><li><p><strong>底层数据结构</strong></p><p>ArrayList基于动态数组，需要连续内存</p><p>LinkedList基于双向链表，无需连续内存</p></li><li><p><strong>效率</strong></p><p>ArrayList随机访问快，尾部插入和插入性能可以，其它部分都会移动元素，性能低</p><p>LinkedList随机访问慢，尾插入删除性能高，其他部分效率低</p></li><li><p><strong>占用空间</strong></p><p>ArrayList可以利用cpu缓存，局部性原理</p><p>LinkedList占用内存多</p></li><li><p><strong>线程安全</strong></p><p>ArrayList和LinkedList都不是线程安全的，可以通过</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Object&gt; list = Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());<br>List&lt;Object&gt; list = Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;());<br></code></pre></td></tr></table></figure><p>包装一下，变成线程安全的</p></li></ul><h5 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h5><h6 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h6><ul><li><p><strong>链表过长时的解决方法</strong></p><p><img src="/img/else_img/hashMap.png" alt="桶数组是用来存储数据元素，链表是用来解决冲突，红黑树是为了提高查询的效率"></p><ol><li><strong>数组扩容</strong>：<ol><li>put元素后检查，当元素总数大于阈值（阈值&#x3D;容量*负载因子）时会发生一次扩容</li><li>每次扩容都是之前容量的2倍</li><li>扩容之后会创建一个新的数组，把老数组中的元素迁移过去<ul><li>没有hash冲突的节点，直接<code>e.hash &amp; (newCap - 1)</code>计算索引下标</li><li>红黑树则走红黑树逻辑</li><li>如果是链表，则需要遍历链表，可能需要拆分链表，判断<code>e.hash &amp; oldCap == 0</code>是否成立，如果成立则仍在这个位置，否则移动到<code>原始位置+oldCap</code>上</li></ul></li></ol></li><li><strong>树化</strong>（jdk1.8）：若数组容量小于64时会先尝试扩容，当数组容量超过64且链表长度大于8（阈值）时会树化</li></ol></li><li><p><strong>底层数据结构，1.7和1.8有何不同?</strong></p><ul><li>1.7为数组+链表，1.8为数组+(链表 | 红黑树)</li><li>1.7为头插法，1.8为尾插法</li><li>1.7先扩容后插入，1.8先插入后扩容（减少频繁转换的概率）</li></ul></li><li><p><strong>为何要用红黑树，为何不一上来就树化，树化阈值为何是8，何时会树化，何时会退化成链表</strong></p><ol><li><p>大部分情况下链表长度是不会超过8的，只有在像Dos攻击时被注入大量key相同的元素时链表才会过长。红黑树用来防止链表过长时的性能下降。平衡二叉树是比红黑树更严格的平衡树，所以平衡二叉树插入和删除的效率 比红黑树要低，故用红黑树。</p></li><li><p>hash表查找和更新的时间复杂度为O(1)，红黑树为O(log2(n))，且红黑树的TreeNode比链表的Node占用内存大，所以尽量使用链表</p></li><li><p>选择8是为了让树化几率足够小；红黑树再转回链表的阈值是6，目的是防止节点数在8附近徘徊导致频繁发生转换</p></li><li><p>树化条件：链表长度&gt;&#x3D;阈值8 且 数组容量&gt;&#x3D;64</p></li><li><p>退化情况1：<strong>扩容时</strong>树被拆分，树元素个数&lt;&#x3D;6会退化成链表；</p><p>退化情况2：<strong>remove节点时</strong>，检查若root，root.left，root.right，root.left.left中有一个为null，则退化</p></li></ol></li><li><p><strong>索引是如何计算的？hashCode都有了为何还要hash()方法？数组容量为何是2^n？</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>    <span class="hljs-type">int</span> h;<br>    <span class="hljs-comment">// key的hashCode和key的hashCode右移16位做异或运算</span><br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>调用对象的hashCode()方法获得原始hash，再调用HashMap的hash()方法二次哈希，最后<code>tab[i = (n - 1) &amp; hash]</code>获取到对应的位置，n为table的长度</li><li>为了提高综合高位数据，让哈希分布更加均匀，减少冲突</li><li>计算索引时，如果是2的n次幂可以使用位与运算代替取模，提高效率；扩容时<code>hash &amp; oldCap == 0</code>的元素留在原处，否则<code>新位置=旧位置 + oldCap</code></li></ul></li><li><p><strong>介绍一下put方法流程，1.7和1.8的有何不同？</strong></p><p><img src="/img/else_img/hashMap%E7%9A%84put%E6%B5%81%E7%A8%8B.png"></p><ol><li>判断table是否为null，是的话执行resize()扩容（懒惰初始化）</li><li>计算索引（hashCode() –&gt; hash() –&gt; 和桶大小求模）</li><li>如果桶下标没人占用，则创建Node占位返回</li><li>如果有人占用了<ol><li>如果是TreeNode走红黑树逻辑</li><li>如果是普通Node走链表逻辑，插入新节点后，如果需要树化则走树化逻辑</li><li>遍历链表或红黑树时发现key已存在则覆盖原先的值</li></ol></li><li>返回前检查容量是否超过阈值，超过则扩容</li></ol><p>不同：</p><ol><li>1.7是头插法，1.8是尾插法</li><li>1.7是元素数量&gt;&#x3D;阈值且没有空位时才扩容，1.8是&gt;阈值时就扩容</li><li>1.8在扩容计算索引时有优化</li></ol></li><li><p><strong>介绍一下get方法流程</strong></p><ol><li>先判断table是否非空或大小为0，是的话直接返回null</li><li>判断第一个元素的key是否和要找的key相同，是则返回</li><li>否则判断节点的类型<ol><li>如果是树节点，则走红黑树的逻辑</li><li>否则遍历链表来找对应key的节点</li></ol></li></ol></li><li><p><strong>加载因子为何默认0.75？</strong></p><p>在空间占用和查询时间之间取得较好的平衡</p><p>大于0.75，节省空间，但链表长了影响性能</p><p>小于0.75，冲突减少，但扩容频繁空间占用更多</p></li><li><p><strong>多线程下会有什么问题？</strong></p><ol><li><strong>扩容死链</strong>（1.7）：1.7扩容是采用头插法，当两个线程同时进行扩容操作，若一个线程先扩容完，另一个线程再去扩容，会使得链表变成循环链表，造成死链</li><li><strong>数据错乱</strong>（1.7，1.8）：put逻辑是先判断是否为空，后插入数据。并发条件下可能出现两个线程都判断一个位置为空，后都往一个位置插入数据，造成数据丢失</li></ol></li><li><p><strong>key能否为null，作为key的对象有什么要求？</strong></p><ol><li>HashMap的key可以为null。但Map的其它实现则不然</li><li>作为key的对象，必须实现hashCode()（为了key在整个HashMap中有更好的分布性）和equals()（当key相同时判断是否为同一个对象），并且key的内容不可以修改</li></ol></li><li><p><strong>初始化时传入的容量不是2的倍数会怎样？</strong></p><p>会向上寻找离得最近的2的倍数</p></li></ul><h4 id="hashCode和equals"><a href="#hashCode和equals" class="headerlink" title="hashCode和equals"></a>hashCode和equals</h4><p><strong>为什么重写 equals 时必须 重写hashCode 方法？</strong></p><p>hashCode() 的作⽤是获取哈希码，也称为散列码，主要在哈希表这类集合映射的时候用到</p><ul><li><p>如果两个对象相等，则 hashcode ⼀定也是相同的</p></li><li><p>如果两个对象有相同的 hashcode 值，它们也不⼀定是相等的</p></li></ul><h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><h4 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h4><h5 id="5种实现方式"><a href="#5种实现方式" class="headerlink" title="5种实现方式"></a>5种实现方式</h5><h6 id="1-饿汉式"><a href="#1-饿汉式" class="headerlink" title="1.饿汉式"></a>1.饿汉式</h6><blockquote><p>要点：构造方法私有、静态成员变量、静态方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton1</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton1</span><span class="hljs-params">()</span> &#123;<br>        <br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton1</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton1</span>();<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton1 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>破坏单例的场景</strong>：1.反射获取私有构造方法，2.反序列化破坏单例，3，unsafe破坏单例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1.反射获取私有构造方法</span><br><span class="hljs-comment">// 预防方法：在构造方法里判断对象是否已创建</span><br>Class&lt;Singleton1&gt; clazz = Singleton1.class;<br><br>Constructor&lt;Singleton1&gt; constructor = clazz.getDeclaredConstructor();<span class="hljs-comment">// 获取构造方法</span><br>constructor.setAccessible(<span class="hljs-literal">true</span>);<span class="hljs-comment">// 设置私有构造方法也可以使用</span><br>constructor.newInstance();<span class="hljs-comment">// 反射创建实例</span><br><br><span class="hljs-comment">// 2.反序列化破坏单例</span><br><span class="hljs-comment">// 把对象写到输出流</span><br><span class="hljs-comment">// 用输入流读取这个对象，还原出来的对象为新的对象</span><br><span class="hljs-comment">// 预防方法：重写readResolve()方法</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">readResolve</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> INStANCE;<br>&#125;<br><br><span class="hljs-comment">// 3.unsafe破坏单例</span><br><span class="hljs-comment">// unsafe可以分配内存、释放内存。通过Singleton1的字节码对象可以创建一个新的</span><br></code></pre></td></tr></table></figure><h6 id="2-枚举类"><a href="#2-枚举类" class="headerlink" title="2.枚举类"></a>2.枚举类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Singleton2</span> &#123;<br>INSTANCE;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>反射和反序列化不会破坏单例</p></blockquote><h6 id="3-懒汉式"><a href="#3-懒汉式" class="headerlink" title="3.懒汉式"></a>3.懒汉式</h6><blockquote><p>需要考虑线程安全问题</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton3</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton3</span><span class="hljs-params">()</span> &#123;<br>        <br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton3</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> Singleton3 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123;<br>            INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton3</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="star-4-DCL懒汉式"><a href="#star-4-DCL懒汉式" class="headerlink" title=":star:4.DCL懒汉式"></a>:star:4.DCL懒汉式</h6><blockquote><p>double check lock，第三种的优化</p></blockquote><p>​<strong>volatile</strong>：解决共享变量的有序性和可见性。</p><p>​这里使用volatile主要解决<strong>有序性</strong>问题：new对象时主要步骤为分配内存、调用构造、给静态变量赋值。jvm可能会对创建对象步骤进行重排优化，导致先给景泰变量赋值再调用构造方法，别的线程会获得一个没有初始化完的对象。volatile修饰后则不会发送重排。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton4</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton4</span><span class="hljs-params">()</span> &#123;<br>        <br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton4</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton4 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">synchronized</span> (Singleton4.class) &#123;<br>                <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123;<br>            INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton3</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="5-内部类式"><a href="#5-内部类式" class="headerlink" title="5.内部类式"></a>5.内部类式</h6><blockquote><p>懒汉式的，推荐</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton5</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton5</span><span class="hljs-params">()</span> &#123;<br>        <br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Holder</span> &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-type">Singleton5</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton5</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> Singleton5 <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Holder.INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="jdk中用到单例的地方"><a href="#jdk中用到单例的地方" class="headerlink" title="jdk中用到单例的地方"></a>jdk中用到单例的地方</h5><ol><li><p>Runtime类：饿汉式。在System的exit()和gc()方法中有使用到</p></li><li><p>Console类：DCL式。控制台的抽象</p></li><li><p>Collections中用到一些空集合时，这个空的集合用到了单例，如EmptyNavigableSet，为内部类式</p></li></ol><h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><h4 id="线程有哪些状态"><a href="#线程有哪些状态" class="headerlink" title="线程有哪些状态"></a>线程有哪些状态</h4><ul><li><p>java线程分成六种状态</p><ol><li><strong>NEW-新建</strong>：线程刚刚创建出来，还没有跟操作系统底层的线程关联起来</li><li><strong>RUNNABLE-可运行</strong>：java线程调用start()后，跟操作系统的线程相关联，代码由操作系统交给CPU执行</li><li><strong>TERMINATED-终结</strong>：代码执行完毕</li><li><strong>BLOCKED-阻塞</strong>：线程没获取到锁时进入阻塞状态</li><li><strong>WAITING-等待</strong>：获取到锁了，但发现运行所需条件不满足，调用wait()进入等待状态，会释放锁；当条件满足时，由其他线程调用notify()唤醒线程</li><li><strong>TIMED_WAITING-有时限等待</strong>：是等待状态的有时限版。还有调用sleep()也是进入有时限等待状态</li></ol><p><img src="/img/else_img/java%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81.png"></p></li><li><p>操作系统层面分为五种状态</p><ol><li><strong>运行</strong>：分到CPU时间片</li><li><strong>就绪</strong>：可以分到CPU时间片</li><li><strong>阻塞</strong>：分不到CPU时间片</li></ol><blockquote><p>Java中的RUNNABLE涵盖就绪、运行、阻塞I&#x2F;O</p></blockquote><p><img src="/img/else_img/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81.png"></p></li></ul><h4 id="线程池的核心参数"><a href="#线程池的核心参数" class="headerlink" title="线程池的核心参数"></a>线程池的核心参数</h4><p>​<img src="/img/else_img/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E6%A0%B8%E5%BF%83%E5%8F%82%E6%95%B0.png"></p><p><strong>线程池</strong>：管理一组线程，执行提交给线程池的任务</p><p><strong>线程池主要参数</strong>：</p><ol><li>corePollSize 核心线程数<ul><li>最多保留的线程数</li></ul></li><li>maximumPoolSize 最大线程数<ul><li>核心线程 + 救急线程</li></ul></li><li>keepAliveTime 生存时间<ul><li>针对救急线程，阻塞队列满时创建救急线程</li></ul></li><li>unit 时间单位<ul><li>针对救急线程</li></ul></li><li>workQueue 阻塞队列<ul><li>没有空闲的核心线程时任务的暂存区</li></ul></li><li>threadFactory 线程工厂<ul><li>可以给线程起名</li></ul></li><li>handler 拒绝策略<ul><li>没有空闲线程且阻塞队列满的时候的策略，四种</li></ul></li></ol><p><strong>拒绝策略</strong></p><ol><li>AbortPolicy （默认）<ul><li>丢弃任务，抛出异常</li></ul></li><li>CallerRunsPolicy<ul><li>由提交任务的线程执行任务</li></ul></li><li>DiscardPolicy<ul><li>丢弃任务</li></ul></li><li>DiscardOldPolicy<ul><li>丢弃阻塞队列中放的最久的任务，把新的加入进去</li></ul></li></ol><p>​</p><h4 id="sleep-amp-wait"><a href="#sleep-amp-wait" class="headerlink" title="sleep &amp; wait"></a>sleep &amp; wait</h4><p><strong>共同点</strong>：</p><ul><li>wait()、wait(long)、sleep(long) 都是让线程放弃CPU的使用权，进入阻塞状态</li></ul><p><strong>不同点</strong>：</p><ul><li>方法归属不同<ol><li>sleep(long)是Thread的静态方法</li><li>wait()、wait(long)是Object的成员方法</li></ol></li><li>醒来时机不同<ol><li>sleep(long)和wait(long)在等够时间后被唤醒</li><li>wait()和wait(long)还可以被notify()&#x2F;notifyAll()唤醒</li><li>都可以通过interrupt()打断来唤醒（唤醒，抛出异常）</li></ol></li><li>锁特性不同<ol><li>调用wait()方法必须先获取到锁</li><li>wait()方法执行后会释放锁</li><li>而sleep()和synchronized代码块一起使用则不会释放锁</li></ol></li></ul><h4 id="Lock-amp-synchronized"><a href="#Lock-amp-synchronized" class="headerlink" title="Lock &amp; synchronized"></a>Lock &amp; synchronized</h4><p><strong>语法层面</strong>：</p><ul><li>synchronized是关键字（C++实现），Lock是接口</li><li>synchronized退出代码块时会自动释放锁，Lock要手动调用unLock()方法</li></ul><p><strong>功能层面</strong>：</p><ul><li><p>都是悲观锁，都具备互斥、同步、锁重入功能</p></li><li><p>Lock有更多的功能，如获取等待状态、公平锁、可打断、可超时、多条件变量</p><blockquote><p>公平锁：按照入阻塞队顺序获取锁</p><p>非公平锁：还未入队的线程可能先获取到锁（插队）</p><p>条件变量：多个等待队列，调用Condition.await()进入</p></blockquote></li><li><p>Lock有适合不同场景的实现，如ReentrantLock（可重入锁），ReentrantReadWriteLock（适合读多写少锁）</p></li></ul><p><strong>性能层面</strong>：</p><ul><li>在竞争少时synchronized做了很多优化，性能好</li><li>竞争多时Lock性能更好</li></ul><h4 id="volatile能否保证线程安全"><a href="#volatile能否保证线程安全" class="headerlink" title="volatile能否保证线程安全"></a>volatile能否保证线程安全</h4><p>线程安全要考虑三个方法：</p><ol><li>可见性：对共享变量的修改其他线程能看到最新结果</li><li>有序性：代码按编写顺序执行</li><li>原子性：多行代码以一个整体运行，期间不能有其他线程插队</li></ol><blockquote><p>可见性问题：线程<strong>频繁</strong>读取一个同一个值的变量时JIT编译器会对这段代码进行优化，把代码编译成机器码，这时修改内存中的变量对于这个线程来说是不可见的。</p><p>加volatile关键字JIT就不会对其优化</p></blockquote><blockquote><p>有序性：jvm会通过指令重排来进行优化。</p><p>加volatile会使用<strong>写屏障</strong>保证上面的代码不到当前变量的下面，使用<strong>读屏障</strong>保证下面的代码不到上面来</p></blockquote><p>volatile只能保证可见性和有序性</p><h4 id="乐观锁-amp-悲观锁"><a href="#乐观锁-amp-悲观锁" class="headerlink" title="乐观锁 &amp; 悲观锁"></a>乐观锁 &amp; 悲观锁</h4><ol><li><strong>悲观锁</strong>的代表是synchronized和Lock<ol><li>核心是只有占有了锁才能操作共享变量</li><li>线程从运行-&gt;阻塞-&gt;唤醒涉及上下文切换，频繁的话影响性能</li><li>获取锁时判断已被上锁，会尝试重试几次，减少阻塞的机会（自旋）</li></ol></li><li><strong>乐观锁</strong>的代表是AtomicInteger（原子整数），使用cas保证原子性<ol><li>核心是无需加锁，每次只有一个线程成功修改共享变量，其他线程不断重试直至成功（CAS的赋值操作是原子性的）</li><li>没有阻塞，不涉及上下文切换</li><li>需要多核cpu支持，且线程数不应超过cpu核数（超过了仍然会出现上下文切换）</li></ol></li></ol><h4 id="Hashtable-vs-ConcurrentHashMap"><a href="#Hashtable-vs-ConcurrentHashMap" class="headerlink" title="Hashtable vs ConcurrentHashMap"></a>Hashtable vs ConcurrentHashMap</h4><ol><li>都是线程安全的Map集合</li><li>Hashtable并发度低，整个Hashtable只有一把锁，同时只能一个线程操作它</li><li>1.8开始ConcurrentHashMap将每个数组的头结点作为锁，多个线程访问不同的头结点不会产生冲突</li></ol><p><strong>ConcurrentHashMap</strong>：</p><ol><li><p>结构：数组+链表|红黑树</p></li><li><p>到达容量的0.75就会扩容</p></li><li><p>属性：</p><ul><li>capacity：假定capacity为要放进来的元素的个数，通过capacity来计算数组的长度。（HashMap的capacity意思为初始数组长度）</li><li>factor：扩容的阈值，只在初始化时使用，之后都按0.75计算</li></ul></li><li><p>因为每个数组的头结点都分别有一把锁，故并发度高</p></li><li><p>扩容流程：</p><ul><li>从最后一个数组节点开始扩容；</li><li>链表迁移是通过复制<em><strong>新的</strong></em>链表元素到新数组中，防止迁移过程中链表的next指针发生变动造成的影响影响;</li><li>扩容完后给原数组节点的头结点置<code>forwardingNode</code>，表示已经扩容完毕。</li><li>必须等整个map扩容完才能执行put操作，如果来put的线程发现map正在扩容，可以来帮忙扩容。</li></ul></li></ol><h4 id="谈谈对ThreadLocal的理解"><a href="#谈谈对ThreadLocal的理解" class="headerlink" title="谈谈对ThreadLocal的理解"></a>谈谈对ThreadLocal的理解</h4><p><strong>作用</strong>：可以实现资源对象线程间的隔离，线程内的共享</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Utils</span>&#123;<br>    <span class="hljs-comment">// 线程间使用不同的资源，线程间隔离</span><br>    <span class="hljs-comment">// 线程内共享同一个资源</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Connection&gt; t1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>&lt;&gt;();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> t1.get();<br>        <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span>) &#123;<br>            conn = innerGetConnection();<span class="hljs-comment">// 创建新的连接对象</span><br>            t1.set(conn);<br>        &#125;<br>        <span class="hljs-keyword">return</span> conn;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">innerGetConnection</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> DriverManager.getConnection(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test?userSSL=false&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>原理</strong>：</p><ul><li>每个线程有一个ThreadLocalMap，用来存储资源</li><li>调用ThreadLocal的set()方法时，就是把ThreadLocal作为key，资源对象作为value存入到map中</li><li>调用ThreadLocal的get()方法时，就是去map中找以当前ThreadLocal为key的资源</li><li>调用ThreadLocal的remove()方法时， 就是去map中删除以当前ThreadLocal为key的资源</li><li>如果产生hash冲突解决方法是开放寻址法</li><li>垃圾回收：<ul><li>ThreadLocalMap的key是弱引用（如果对于对象的引用中有强引用，则不能被回收，如果都是弱引用，则可以被回收），用于解决当其它地方都没有使用这个资源时，这个资源的key可以被垃圾回收</li><li>在get()时发现key为null，value就会被释放；</li><li>在set()时发现key为null，会把周围的null key也顺手释放</li><li>在remove()时会释放value</li></ul></li></ul><h4 id="快速失败-fail-fast-和安全失败-fail-safe"><a href="#快速失败-fail-fast-和安全失败-fail-safe" class="headerlink" title="快速失败(fail-fast)和安全失败(fail-safe)"></a>快速失败(fail-fast)和安全失败(fail-safe)</h4><p><strong>快速失败</strong></p><ul><li>java.util包下的集合类都是快速失败的，如ArrayList</li><li>迭代器中使用modCount记录原集合被修改的次数，每遍历一个元素时，都会和原数组中的modCount值进行比较，不一致直接抛出<code>Concurrent Modification Exception</code>异常</li></ul><p><strong>安全失败</strong></p><ul><li>java.util.concurrent包下的容器都是安全失败，如CopyOnWriteArrayList</li><li>遍历时不是直接在集合内容上访问的，而是先 复制原有集合内容，在拷贝的集合上进行遍历</li><li>缺点：迭代器遍历的是开始遍历那一刻拿 到的集合拷贝，在遍历期间原集合发生的修改迭代器是不知道的</li></ul><blockquote><p>CopyOnWriteArrayList采用了一种<strong>读写分离</strong>的并发策略。CopyOnWriteArrayList容器 允许并发读，读操作是无锁的，性能较高。至于写操作，比如向容器中添加一个元 素，则首先将当前容器复制一份，然后在新副本上执行写操作，结束之后再将原容 器的引用指向新容器。</p></blockquote><h3 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h3><h4 id="JVM内存结构"><a href="#JVM内存结构" class="headerlink" title="JVM内存结构"></a>JVM内存结构</h4><ul><li>Java Source：源代码</li><li>Java Class：字节码</li><li>类加载子系统：把字节码文件加载到方法区，存放类的信息</li><li>Heap堆：分配对象的内存，存放对象的信息</li><li>JVM Stacks虚拟机栈：从虚拟机栈中给线程分配内存，存放方法内的局部变量、对象的引用</li><li>PC程序计数器：存放当前线程执行到了第几行代码</li><li>Interpreter解释器：逐行解释执行代码，效率低</li><li>JIT Compiler 即时编译器：字节码编译为机器码，效率高</li></ul><p>​<img src="/img/else_img/JVM%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84.png"></p><h5 id="方法区与永久代、元空间的关系"><a href="#方法区与永久代、元空间的关系" class="headerlink" title="方法区与永久代、元空间的关系"></a>方法区与永久代、元空间的关系</h5><ol><li>方法区是JVM规范中<strong>定义</strong>的一块内存区域，用来存储类元数据、方法字节码、即时编译器需要的信息等</li><li>永久代是Hotspot虚拟机对JVM规范的<strong>实现</strong>（1.8之前）</li><li>元空间是Hotspot虚拟机对JVM规范的<strong>实现</strong>（1.8之后）</li><li>永久代和元空间最大的区别是元空间使用本地内存作为信息的存储空间</li></ol><h5 id="元空间加载、释放类信息"><a href="#元空间加载、释放类信息" class="headerlink" title="元空间加载、释放类信息"></a>元空间加载、释放类信息</h5><p>加载：当第一次使用类的时候把字节码加载到元空间</p><p>释放：当类的实例、Class类不再被使用，且加载它的类加载器也不再使用（类加载器加载的所有类都不再被使用）的时候才会被释放</p><h5 id="内存参数"><a href="#内存参数" class="headerlink" title="内存参数"></a>内存参数</h5><p><strong>例题</strong>：<code>-Xmx10260m -Xms10240m -Xmn5120m -XX:SurvivorRatio=3</code>，其最小内存和Survivor区总大小分别是？</p><p>​<code>-Xmx</code>：虚拟机最大内存</p><p>​<code>-Xms</code>：虚拟机最小内存</p><p>​<code>-Xmn</code>：新生代内存大小</p><p>​<code>-Xss</code>：虚拟机栈中每个线程最大内存</p><p>​<code>-XX:SurvivorRatio</code>：新生代伊甸区和<code>from</code>或<code>to</code>区的比例</p><p>​所以这题最小内存为10G，Survivor区（from+to）大小为2G</p><h4 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h4><ol><li><p><strong>标记清除</strong></p><ol><li><p>标记：一定不会被垃圾回收的对象被作为根对象，沿着根对象的引用进行标记，被标记的对象不能被垃圾回收</p></li><li><p>清除：把没有被标记的对象进行内存释放</p></li><li><p>缺点：对象不是连续的，容易造成内存碎片，已经没有回收器在使用这个算法</p><p><img src="/img/else_img/%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4.png"></p></li></ol></li><li><p><strong>标记整理</strong></p><ol><li><p>整理：清除后移动对象往一端靠拢</p></li><li><p>缺点：移动对象造成效率低</p><p><img src="/img/else_img/%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86.png"></p></li></ol></li><li><p><strong>标记复制</strong></p><ol><li><p>复制：标记后把存活对象复制到一块内存中，清空原来的那片内存</p></li><li><p>缺点：占用的内存较多</p><p><img src="/img/else_img/%E6%A0%87%E8%AE%B0%E5%A4%8D%E5%88%B6.png"></p></li></ol></li></ol><p>新生代适合标记复制法，老年代适合标记整理</p><h5 id="GC和分代回收算法"><a href="#GC和分代回收算法" class="headerlink" title="GC和分代回收算法"></a>GC和分代回收算法</h5><ul><li>GC的目的在于自动释放无用内存，减少内存碎片，加快分配速度</li><li>GC要点<ol><li>回收区域是<strong>堆内存</strong>，虚拟机栈内存在方法调用结束会自动释放</li><li>使用<strong>可达性算法</strong>，<strong>三色标记法</strong>标记存活对象，释放未标记对象</li><li>GC大都在用<strong>分代回收思想</strong>，将回收区域分成新生代和老年代，应用不同的策略</li><li>格局GC规模可以分成<strong>MinorGC</strong>、<strong>MixedGC</strong>、<strong>FullGC</strong></li></ol></li><li>分代回收<ol><li>伊甸区eden：分配新对象</li><li>幸存区survivor：分成from和to，存放幸存对象</li><li>老年代old，存放扛过多次回收后晋升的对象（幸存区内存不足或大对象会导致提前晋升）</li></ol></li><li>GC规模<ol><li>MinorGC发生在新生代的垃圾回收，时间短</li><li>MixedGC为新生代+部分老年代的垃圾回收，G1收集器特有</li><li>FullGC为新生代+老年代，回收时间长</li></ol></li></ul><h5 id="三色标记与并发漏标"><a href="#三色标记与并发漏标" class="headerlink" title="三色标记与并发漏标"></a>三色标记与并发漏标</h5><ul><li><p>用三种颜色标记对象的标记状态</p><ol><li>黑色 - 已标记</li><li>灰色 - 标记中</li><li>白色 - 未标记</li></ol><p><img src="/img/else_img/%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0.png"></p></li><li><p>漏标问题</p><ol><li>垃圾回收线程在标记时用户线程并行执行，导致对象间的引用关系发生改变，从而影响标记的过程</li><li>解决方案：<ol><li>Incremental Update：记录引用关系被修改的对象（黑-&gt;灰），在最后stop the world时重新标记这些对象</li><li>Snapshot At The Beginning：记录新加入的对象和被删除引用关系的对象，在最后stop the world时重新标记这些对象</li></ol></li></ol></li></ul><h4 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h4><ul><li>（并行回收器）Parallel GC<ol><li>enden内存不足时发生MinorGC，标记复制STW</li><li>old内存不足时发生FullGC，标记整理STW</li><li>多线程进行垃圾回收，<strong>注重吞吐量</strong></li></ol></li><li>（并发标记整理）Concurrent Mark Sweep GC<ol><li>old<strong>并发标记</strong>，重新标记时需要STW，<strong>并发清除</strong></li><li>Failback Full GC 并发失败时触发Full GC</li><li>大部分时间和用户线程并发，<strong>注重响应时间</strong></li></ol></li><li>G1 GC<ol><li>兼顾响应时间和吞吐量</li><li>划分多个区域，每个区域都可以充当eden，survivor，old，humongous</li><li>过程：<ol><li>新生代回收：eden标记复制STW</li><li>并发标记：old<strong>并发标记</strong>，重新标记时需STW</li><li><strong>混合收集</strong>：eden + 优先收集回收价值高的old，复制时STW</li><li>Failback Full GC：兜底</li></ol></li></ol></li></ul><h4 id="内存溢出"><a href="#内存溢出" class="headerlink" title="内存溢出"></a>内存溢出</h4><p>除了程序计数器，其他都有可能产生溢出</p><h5 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h5><p>OutOfMemoryError：</p><ol><li>堆内存耗尽</li><li>方法区内存耗尽</li><li>虚拟机栈累积 - 每个线程最多占用1M内存，线程个数太多导致溢出</li></ol><p>StackOverflowError：</p><ol><li>虚拟机栈内部 - 方法调用过多导致线程的内存溢出</li></ol><h5 id="溢出情况"><a href="#溢出情况" class="headerlink" title="溢出情况"></a>溢出情况</h5><p>情况1：误用固定大小线程池</p><ul><li>使用<code>Executors.newFixedThreadPool()</code>创建的线程池的任务队列是无界队列（链表），可以放无数的任务，任务对象太多导致堆内存溢出</li><li>解决方式：不使用<code>newFixedThreadPool()</code>，而是自己<code>new ThreadPoolExecutor</code>使用有界队列</li></ul><p>情况2：误用带缓冲线程池</p><ul><li>使用<code>Executors.newCacheThreadPool()</code>创建的线程池只有救急线程，可以创建无数的线程导致虚拟机栈溢出</li><li>解决方式：自己<code>new ThreadPoolExecutor</code></li></ul><p>情况3：一次查询太多数据</p><ul><li>数据量太大把物理内存挤爆了</li><li>解决方式：给查询限制最大条数</li></ul><p>情况4：动态类太多</p><ul><li>不断加载新的Class到方法区，把方法区挤爆了</li><li>解决方式：降低类的声明周期，如不使用static等</li></ul><h4 id="类加载过程，双亲委派机制"><a href="#类加载过程，双亲委派机制" class="headerlink" title="类加载过程，双亲委派机制"></a>类加载过程，双亲委派机制</h4><p><strong>类加载方式</strong>：</p><ol><li>隐式装载：通过new等方式生成对象时，隐式调用类加载器加载对应的类到JVM中</li><li>显示装载：<code>Class.forName(className)</code>或<code>ClassLoad.loadClass(className)</code></li></ol><p><strong>类加载器种类</strong>：</p><ol><li>BootStrap Loader（引导类加载器），加载系统类</li><li>ExtClass Loader（扩展类加载器），加载扩展类</li><li>AppClass Loader（应用类加载器），加载应用类</li></ol><p><strong>类加载过程</strong>：</p><p><img src="/img/else_img/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png"></p><ol><li><strong>加载</strong><ol><li>通过类的全限定名来获取到class文件，将字节码文件载入方法区，并创建.class对象(堆内)</li><li>类的父类没有加载，先加载父类</li><li>加载是懒惰执行</li></ol></li><li><strong>链接</strong><ol><li>验证-验证类是否符合Class规范</li><li>准备-为static变量分配空间，设置默认值（零值）；将类的元信息加载进元空间</li><li>解析-将常量池的符号引用解析为直接引用</li><li>给final变量赋值，如果调用final变量不会触发初始化</li></ol></li><li><strong>初始化</strong><ol><li>从上往下给非final静态变量的赋值和执行静态代码块</li><li>初始化是懒惰执行</li></ol></li></ol><p><strong>类初始化方法</strong>：</p><ul><li>把静态变量、final修饰的引用类型和静态代码块合成一个static方法，在类的初始化时调用</li></ul><p><strong>解析过程</strong>：</p><ul><li>方法内还没有使用到类的时候，常量池里的类为符号引用</li><li>当使用到这个类时，这个类被加载到堆中，原先调用这个类的常量池中的符号引用也就被替换为真实的地址</li></ul><p><strong>双亲委派</strong></p><ul><li>指优先委派上级类加载器进行加载</li><li>当上级类加载器找不到要加载的类，下级类加载器才有资格执行加载</li><li>上级类加载器加载的类对下级可见</li><li>目的：让类加载有优先次序，保证核心类优先加载</li></ul><p>​<img src="/img/else_img/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.png"></p><h4 id="对象引用类型"><a href="#对象引用类型" class="headerlink" title="对象引用类型"></a>对象引用类型</h4><ol><li>强引用<ol><li>如<code>A a = new A()</code>就为强引用</li><li>通过GC Root的引用链能找到对象a就不会被回收</li></ol></li><li>软引用<ol><li>如<code>SoftReference a = new SoftReference(new A())</code>就为软引用</li><li>如果只有软引用一个对象，首次垃圾回收不会回收该对象，如果内存仍然不足，再次回收时才会释放对象</li><li>软引用自身需要配合引用队列来释放</li><li>例子：反射获得的数据是软引用</li></ol></li><li>弱引用<ol><li>如<code>WeakReference a = new WeakReference(new A())</code>就为弱引用</li><li>如果只有弱引用一个对象，只要垃圾回收就会回收该对象</li><li>弱引用自身需要配合引用队列来释放</li><li>例子：ThreadLocalMap中的Entry对象使用了弱引用</li></ol></li><li>虚引用<ol><li>如<code>PhantomReference a = new PhatomReference(new A())</code>就为虚引用</li><li>必须配合队列一起使用，当新引用引用的对象被回收时，会将虚引用对象入队，配合Reference Handler线程释放其关联的外部资源（非java的资源）</li></ol></li></ol><h4 id="finalize"><a href="#finalize" class="headerlink" title="finalize"></a>finalize</h4><ul><li><p>对象被垃圾回收时会调用的方法</p></li><li><p>由FinalizerThread调用finalize方法，而这个线程是守护线程，可能没来得及调用完方法就结束了</p></li><li><p>finalize有异常不会抛出异常</p></li><li><p>影响性能：垃圾回收时第一次不能释放内存，要等线程调用完finalize方法后下次垃圾回收才能释放</p></li></ul><h2 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h2><h3 id="refresh创建IOC容器"><a href="#refresh创建IOC容器" class="headerlink" title="refresh创建IOC容器"></a>refresh创建IOC容器</h3><p>Spring 容器启动时会创建IOC容器,在创建容器时,会调用 refresh()方法,整个容器就是通过该方法,完成所有的 bean 的创建以及初始化</p><h4 id="重要的类-x2F-对象"><a href="#重要的类-x2F-对象" class="headerlink" title="重要的类&#x2F;对象"></a>重要的类&#x2F;对象</h4><ul><li>ClassPathXmlApplicationContext：使用配置文件的容器</li><li>AnnotationConfigApplicationContext：使用配置类的容器</li><li>BeanDefinition：Bean的相关信息。如是否是单例的，Bean的类型，是否是懒加载，依赖哪些类，自动装配的模型</li><li>beanDefinitionMap：存放bean对应的BeanDefinition</li><li>beanDefinitionNames：存放所有bean的名字</li><li>BeanFactoryPostProcessor：BeanFactory的后置处理器</li><li>BeanPostProcessor：Bean的后置处理器，通过它可以实现AOP、Bean的创建</li></ul><h4 id="重要步骤"><a href="#重要步骤" class="headerlink" title="重要步骤"></a>重要步骤</h4><p><img src="/img/else_img/BeanFactory%E5%88%9D%E5%A7%8B%E5%8C%96.png" alt="BeanFactory初始化"></p><p><code>invokeBeanFactoryPostProcessors()</code>会执行所有<code>BeanFactoryPostProcessor</code></p><ul><li>Spring内置的BeanFactory后处理器：<code>ConfigurationClassPostProcessor</code>，会解析出所有交由Spring管理的Bean并解析成<code>BeanDefinition</code></li><li>自定义的BeanFactory后处理器：实现了<code>BeanFactoryPostProcessor</code>接口或<code>BeanDefinitionRegistryPostProcessor</code>接口。会先执行后者的实现类</li></ul><p><img src="/img/else_img/%E5%87%86%E5%A4%87%E4%B8%8A%E4%B8%8B%E6%96%87.png" alt="准备上下文"></p><p> <code>registerBeanPostProcessors()</code>会找到并实例化所有的<code>BeanPostProcessor</code>，并放到<code>beanPostProcessors</code>集合中</p><p><code>finishBeanFactoryInitialization()</code>完成了所有非懒加载的单例<code>Bean</code>的实例化和初始化，属性的填充以及解决了循环依赖等问题</p><h4 id="12个步骤"><a href="#12个步骤" class="headerlink" title="12个步骤"></a>12个步骤</h4><p><strong>概览</strong></p><ul><li>1：准备工作</li><li>2~6：创建准备BeanFactory的各项功能</li><li>7~12：准备ApplicationContext</li></ul><h5 id="1-prepareRefresh-开启容器，加载键值"><a href="#1-prepareRefresh-开启容器，加载键值" class="headerlink" title="1.prepareRefresh()-开启容器，加载键值"></a>1.prepareRefresh()-开启容器，加载键值</h5><ul><li><p>创建和准备了<strong>Environment</strong>对象</p></li><li><p>Environment对象的作用：加载了一些键值信息：</p><ul><li>jvm提供的键值</li><li>操作系统系统里的键值</li><li>配置文件里提供的键值信息</li></ul></li><li><p>Environment的作用之一是为后续@Value注入值的时候提供信息</p><p><img src="/img/else_img/environment.png"></p></li></ul><h5 id="2-obtainFreshBeanFactory-获取或创建Bean工厂"><a href="#2-obtainFreshBeanFactory-获取或创建Bean工厂" class="headerlink" title="2.obtainFreshBeanFactory()-获取或创建Bean工厂"></a>2.obtainFreshBeanFactory()-获取或创建Bean工厂</h5><ul><li><p>创建了<strong>BeanFactory</strong>对象</p></li><li><p>BeanDefinitionMap为BeanFactory的成员对象，存储了BeanDefinition</p><ul><li>BeanDefinition作为bean的设计蓝图，规定了bean的特征，如单例多例、依赖关系、初始化销毁方法等</li><li>BeanDefinition的来源可以通过xml获取、配置类获得、组件扫描或编程添加等</li></ul></li><li><p>BeanFactory的作用是负责bean的创建、依赖注入和初始化</p><p><img src="/img/else_img/beanFactory.png"></p></li></ul><h5 id="3-prepareBeanFactory-完善Bean工厂"><a href="#3-prepareBeanFactory-完善Bean工厂" class="headerlink" title="3.prepareBeanFactory()-完善Bean工厂"></a>3.prepareBeanFactory()-完善Bean工厂</h5><ul><li><p>创建用来解析SpEL的beanExpressionResolver</p></li><li><p>创建执行类型转换的propertyEditorRegistrars</p></li><li><p>创建特殊bean注入的resolvableDependencies</p></li><li><p>扩展bean的创建功能的beanPostProcessors</p><p><img src="/img/else_img/prepareBeanFactory.png"></p></li><li><p>StandardBeanExpressionResolver来解析SpEL</p></li><li><p>ResourceEditorRegister会注释类型转换器，并应用ApplicationContext提供的Environment来完成${}解析</p></li><li><p>特殊bean指beanFactory以及ApplicationContext，通过registerResolvableDependency来注册它们</p></li></ul><h5 id="4-postProcessBeanFactory-子类扩展Bean工厂"><a href="#4-postProcessBeanFactory-子类扩展Bean工厂" class="headerlink" title="4.postProcessBeanFactory()-子类扩展Bean工厂"></a>4.postProcessBeanFactory()-子类扩展Bean工厂</h5><ul><li>后处理可以理解为添加功能。</li><li>默认为空实现，留个子类扩展</li><li>一般Web环境的ApplicationContext都要利用它注册新的Scope，完善Web下的BeanFactory</li></ul><h5 id="5-invokeBeanFactoryPostProcessors-后处理器扩展Bean工厂"><a href="#5-invokeBeanFactoryPostProcessors-后处理器扩展Bean工厂" class="headerlink" title="5.invokeBeanFactoryPostProcessors()-后处理器扩展Bean工厂"></a>5.invokeBeanFactoryPostProcessors()-后处理器扩展Bean工厂</h5><ul><li>预先定义好的后处理，通过处理器的方式添加BeanFactory的功能</li><li>后置处理器可以扩展beanFactory的功能，用来补充和修改BeanDefinition</li><li>ConfigurationClassPostProcessor-解析@Configuration、@Bean、@Import等</li></ul><h5 id="6-registerBeanPostProcessors-注册Bean后处理器"><a href="#6-registerBeanPostProcessors-注册Bean后处理器" class="headerlink" title="6.registerBeanPostProcessors()-注册Bean后处理器"></a>6.registerBeanPostProcessors()-注册Bean后处理器</h5><ul><li>bean后后处理器充当bean的扩展点，可以工作在bean的实例化、依赖注入、初始化阶段</li><li>如有解析@Autowired、@Value、@Resource等注解的后处理器</li></ul><h5 id="7-initMessageSource-国际化"><a href="#7-initMessageSource-国际化" class="headerlink" title="7.initMessageSource()-国际化"></a>7.initMessageSource()-国际化</h5><ul><li><p>初始化messageSource，用来做国际化功能</p><p><img src="/img/else_img/messageSource.png"></p></li></ul><h5 id="8-initApplicationEventMulticaster-初始化事件多播器"><a href="#8-initApplicationEventMulticaster-初始化事件多播器" class="headerlink" title="8.initApplicationEventMulticaster()-初始化事件多播器"></a>8.initApplicationEventMulticaster()-初始化事件多播器</h5><ul><li>这个类会持有所有的事件监听器(<code>ApplicationListener</code>)，当有<code>ApplicationEvent</code>事件发布时，该事件监听器能根据事件类型，检索到对该事件感兴趣的<code>ApplicationListener</code></li></ul><p>​<img src="/img/else_img/multicaster.png"></p><h5 id="9-onRefresh-初始化子容器中的bean"><a href="#9-onRefresh-初始化子容器中的bean" class="headerlink" title="9.onRefresh()-初始化子容器中的bean"></a>9.onRefresh()-初始化子容器中的bean</h5><ul><li>执行其他的初始化操作，例如和<code>SpringMVC</code>整合时，需要初始化一些其他的<code>bean</code>，但是对于纯<code>Spring</code>工程来说，<code>onRefresh()</code>方法是一个空方法。</li></ul><h5 id="10-registerListeners-注册监听器"><a href="#10-registerListeners-注册监听器" class="headerlink" title="10.registerListeners()-注册监听器"></a>10.registerListeners()-注册监听器</h5><ul><li>接收事件</li></ul><h5 id="11-finishBeanFactoryInitialization-初始化所有剩下的单例-bean"><a href="#11-finishBeanFactoryInitialization-初始化所有剩下的单例-bean" class="headerlink" title="11.finishBeanFactoryInitialization()- 初始化所有剩下的单例 bean"></a>11.finishBeanFactoryInitialization()- 初始化所有剩下的单例 bean</h5><ul><li>conversionService也是一套转换机制，作为对PropertyEditor的补充</li><li>内嵌值解析器用来解析@Value中的${}，借用的是Environment的功能</li><li>单例池用来缓存所有单例对象</li><li>对象创建分为三个阶段：创建、依赖注入、初始化，每个阶段都有不同的bean处理器参与扩展</li></ul><p>​<img src="/img/else_img/finishBeanFactoryInitialozation.png"></p><h5 id="12-finishRefresh-准备声明周期管理器，发布ContextRefresh事件"><a href="#12-finishRefresh-准备声明周期管理器，发布ContextRefresh事件" class="headerlink" title="12.finishRefresh()-准备声明周期管理器，发布ContextRefresh事件"></a>12.finishRefresh()-准备声明周期管理器，发布ContextRefresh事件</h5><ul><li>lifecycleProcessor用来控制容器内需要生命周期管理的bean</li></ul><p><img src="/img/else_img/finishRefersh.png"></p><h3 id="Bean的作用域"><a href="#Bean的作用域" class="headerlink" title="Bean的作用域"></a>Bean的作用域</h3><ul><li>Singleton：默认，在IOC容器中只有一个实例</li><li>Prototype：可以有多个实例</li><li>Request：每次http请求都会创建一个Bean</li><li>Session：一个Session中对应一个Bean对应一个实例</li><li>Global-session：全局Session中，一个Bean对应一个实例</li></ul><h3 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h3><p><img src="/img/else_img/bean%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png"></p><h4 id="7个阶段"><a href="#7个阶段" class="headerlink" title="7个阶段"></a>7个阶段</h4><p>Bean为懒惰初始化，生命周期从doGetBean()方法开始</p><p><strong>概览</strong></p><ul><li>阶段1：处理名称，检查缓存</li><li>阶段2：检查父工厂</li><li>阶段3：检查DependsOn</li><li>阶段4：按Scope创建bean</li><li>阶段5：创建bean</li><li>阶段6：类型转换</li><li>阶段7：销毁bean</li></ul><h5 id="阶段1"><a href="#阶段1" class="headerlink" title="阶段1"></a>阶段1</h5><ul><li>先把别名解析为实际名称，再进行后续处理</li><li>若要FactoryBean本身，需要使用&amp;名称获取</li><li>检查缓存里是否有：<ul><li>一级缓存是singletonObjects，放单例成品对象</li><li>二级缓存是earlySingletonObjects，放单例工厂的产品，可称为提前单例对象</li><li>三级缓存是singletonFactories，放单例工厂</li></ul></li></ul><h5 id="阶段2"><a href="#阶段2" class="headerlink" title="阶段2"></a>阶段2</h5><ul><li>缓存中没有bean回去父容器中找</li><li>父容器中的bean和子容器中的bean名称可以重复</li></ul><h5 id="阶段3"><a href="#阶段3" class="headerlink" title="阶段3"></a>阶段3</h5><ul><li>如果A显式依赖于B，则B会被先创建</li><li>DependsOn用在非显式依赖的bean的创建顺序控制</li></ul><h5 id="阶段4"><a href="#阶段4" class="headerlink" title="阶段4"></a>阶段4</h5><ul><li>常见scope：<ul><li>singleton scope表示从单例池范围内获取bean<ul><li>容器创建时创建，容器销毁时销毁</li></ul></li><li>prototype scope表示从不缓存bean，每次创建新的<ul><li>用时创建，不用时手动销毁</li></ul></li><li>request scope表示从request对象范围内获取bean<ul><li>在request域中创建，request销毁时销毁</li></ul></li></ul></li></ul><h5 id="阶段5"><a href="#阶段5" class="headerlink" title="阶段5"></a>阶段5</h5><ul><li>创建阶段：<ul><li>AutowiredAnnotationBeanPostProcessor选择构造：优先使用带@Autowired的构造方法来创建bean，如果只有一个有参构造，则用这个有参构造创建bean</li><li>默认构造：保底使用无参构造来创建</li></ul></li><li>依赖注入阶段：<ul><li>后处理器扩展功能：按注解匹配要注入的bean</li><li>根据名字、类型去容器中找bean</li><li>xml精确指定bean</li></ul></li><li>初始化阶段：<ul><li>处理Aware接口，如BeanNameAware、BeanFactoryAware，BeanFactory会把相应的资源传递进来</li><li>调用初始化方法，初始化方法定义有@PostConstruct、实现InitalizingBean接口等</li><li>创建aop代理</li></ul></li><li>注册可销毁bean<ul><li>将有销毁方法的bean保存起来，销毁时调用方法</li></ul></li></ul><p>​<img src="/img/else_img/%E5%88%9B%E5%BB%BAbean.png"></p><h5 id="阶段6"><a href="#阶段6" class="headerlink" title="阶段6"></a>阶段6</h5><ul><li>如果getBean的requiredType参数与实际得到的对象类型不同，会尝试类型转换</li></ul><h5 id="阶段7"><a href="#阶段7" class="headerlink" title="阶段7"></a>阶段7</h5><ul><li>根据scpoe来销毁bean</li></ul><h3 id="事务的传播行为"><a href="#事务的传播行为" class="headerlink" title="事务的传播行为"></a>事务的传播行为</h3><table><thead><tr><th>级别</th><th>描述</th></tr></thead><tbody><tr><td>Required（默认）</td><td>支持当前事务，没有事务会创建一个</td></tr><tr><td>Supports</td><td>支持当前事务，没有事务则以非事务的方式执行</td></tr><tr><td>Mandatory</td><td>支持当前事务，没有事务会抛出异常</td></tr><tr><td>Requires_new</td><td>创建新事务并挂起当前事务</td></tr><tr><td>Not_supported</td><td>以非事务方式执行，会挂起当前事务</td></tr><tr><td>Never</td><td>以非事务方式执行，有事务会抛出异常</td></tr><tr><td>Nested</td><td>嵌套事务</td></tr></tbody></table><h3 id="事务失效场景"><a href="#事务失效场景" class="headerlink" title="事务失效场景"></a>事务失效场景</h3><h4 id="场景1：检查异常"><a href="#场景1：检查异常" class="headerlink" title="场景1：检查异常"></a>场景1：检查异常</h4><blockquote><p>需要<code>try..catch</code>或<code>throw</code>的异常都是检查异常</p><p>运行时异常是非检查异常</p></blockquote><p>抛出检查异常导致事务不能正常回滚</p><p>原因：spring默认只会回滚非检查异常</p><p>解决方式：在注解上加上<code>@Transactional(rollbackFor=Exception.class)</code>设置需要回滚的异常</p><h4 id="场景2：错误try-catch"><a href="#场景2：错误try-catch" class="headerlink" title="场景2：错误try catch"></a>场景2：错误try catch</h4><p>原因：事务是通过代理实现的，如果在被代理方法内catch了异常，外层调用者是不知道发生了异常的，从而事务失效</p><p>解决方式1：把异常抛出去</p><p>解决方式2：手动设置事务状态<code>TransactionStatus.setRollbackOnly()</code></p><h4 id="场景3：aop切面顺序不对"><a href="#场景3：aop切面顺序不对" class="headerlink" title="场景3：aop切面顺序不对"></a>场景3：aop切面顺序不对</h4><p>原因：在自定义切面里catch了异常，导致更上层的事务切面不知道发生了异常</p><p>解决方式1：同场景2</p><p>解决方式2：使自定义切面优先级比事务的高<code>@Order(Ordered.LOWEST.PRECEDENCE - 1)</code></p><h4 id="场景4：加在非公共方法上"><a href="#场景4：加在非公共方法上" class="headerlink" title="场景4：加在非公共方法上"></a>场景4：加在非公共方法上</h4><p>原因：Spring为方法创建代理、添加事务通知、前提条件都是方法是public的</p><h4 id="场景5：父子容器导致的事务失效"><a href="#场景5：父子容器导致的事务失效" class="headerlink" title="场景5：父子容器导致的事务失效"></a>场景5：父子容器导致的事务失效</h4><p>原因：子容器扫描范围过大，把未加事务配置的service扫描进来</p><p>解决方式1：容器各自扫各自的包</p><p>解决方式2：不用父子容器</p><h4 id="场景6：调用本类方法导致传播行为失效"><a href="#场景6：调用本类方法导致传播行为失效" class="headerlink" title="场景6：调用本类方法导致传播行为失效"></a>场景6：调用本类方法导致传播行为失效</h4><p>原因：本类方法调用没有经过代理增强</p><p>解决方式：依赖注入自身</p><h4 id="场景7：锁失效"><a href="#场景7：锁失效" class="headerlink" title="场景7：锁失效"></a>场景7：锁失效</h4><p>原因：@Transactional没有保证原子行为，在方法上加锁只能保证方法内的原子性，提交事务时锁失效</p><p>解决方式1：synchronized范围扩大至代理方法调用</p><p>解决方式2：sql语句<code>select ... for update</code>替换<code>select</code></p><h3 id="SpringMVC执行流程"><a href="#SpringMVC执行流程" class="headerlink" title="SpringMVC执行流程"></a>SpringMVC执行流程</h3><ol><li><p>初始化阶段</p><ul><li>第一次用到DispatcherServlet时，会创建其对象并执行init方法</li><li>容器初始化后，会将初始化好的重要组件赋值给DispatcherServlet的成员变量</li></ul><p><img src="/img/else_img/springMVC%E5%88%9D%E5%A7%8B%E5%8C%96.png"></p></li><li><p>匹配阶段</p><ul><li>用户请求到达DispatcherServlet，由其遍历所有的HandlerMapping，找到与路径匹配的处理器</li><li>将HandlerMethod连同匹配到的拦截器，生成调用链对象返回</li><li>遍历HandlerAdapter，找到能处理HandlerMethod的适配器，开始调用</li></ul><p><img src="/img/else_img/springMVC%E5%8C%B9%E9%85%8D%E9%98%B6%E6%AE%B5.png"></p></li><li><p>执行阶段</p><ul><li>执行拦截器的preHandle</li><li>调用HandlerMethod,返回ModelAndView</li><li>执行拦截器的postHandle</li><li>解析ModelAndView</li><li>执行拦截器的afterCompletion</li></ul><p><img src="/img/else_img/SpringMVC%E6%89%A7%E8%A1%8C%E9%98%B6%E6%AE%B5.png"></p></li></ol><h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><h4 id="Spring常见注解"><a href="#Spring常见注解" class="headerlink" title="Spring常见注解"></a>Spring常见注解</h4><p><img src="/img/else_img/Spring%E5%B8%B8%E8%A7%81%E6%B3%A8%E8%A7%A3.png"></p><h4 id="SpringMVC常见注解"><a href="#SpringMVC常见注解" class="headerlink" title="SpringMVC常见注解"></a>SpringMVC常见注解</h4><p><img src="/img/else_img/SpringMVC%E5%B8%B8%E8%A7%81%E6%B3%A8%E8%A7%A3.png"></p><h4 id="SpringBoot常见注解"><a href="#SpringBoot常见注解" class="headerlink" title="SpringBoot常见注解"></a>SpringBoot常见注解</h4><p><img src="/img/else_img/SpringBoot%E5%B8%B8%E8%A7%81%E6%B3%A8%E8%A7%A3.png"></p><h3 id="SpringBoot自动配置"><a href="#SpringBoot自动配置" class="headerlink" title="SpringBoot自动配置"></a>SpringBoot自动配置</h3><p>@SpringBootApplication主要由三个注解构成</p><ul><li>@SpringBootConfiguration<ul><li>@Configuration可以多个，@SpringBootConfiguration只能一个，用于表示当前类为SpringBoot配置类</li></ul></li><li>@EnableAutoConfiguration<ul><li>@AutoConfigurationPackage：记录标注了这个注解的包名</li><li>@Import(AutoConfigurationImportSelector.class)：导入自动配置相关的bean，加载META-INF&#x2F;spring.factories中的配置类</li></ul></li><li>@ComponentScan<ul><li>属性excludeFilters用于排除一些类不注册为bean</li></ul></li></ul><h3 id="循环依赖"><a href="#循环依赖" class="headerlink" title="循环依赖"></a>循环依赖</h3><p><img src="/img/else_img/bean%E7%9A%84%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96.png"></p><h4 id="切面"><a href="#切面" class="headerlink" title="切面"></a>切面</h4><p>通过代理对象来关联ProxyFactory实现切面，SpringBoot通过自动代理后处理器来识别相关注解</p><p><strong>术语</strong></p><ul><li><p>Advisor：最基础的切面，把一个Advice和一个Pointcut组合起来</p></li><li><p>Advice：增强</p></li><li><p>Pointcut：切点</p></li><li><p>Aspect：切面</p></li></ul><blockquote><ol><li><p>最基本的切面是Advisor，一个Aspect切面对应一到多个Advisor</p></li><li><p>最基本的Advice是MethodInterceptor，其他Advice最终都会适配为MethodInterceptor</p></li><li><p>创建代理的方式有：实现了用户自定义接口，采用jdk动态代理；没有实现用户自定义接口，采用cglib代理；设置了setProxyTargetClass(True)，统一采用cglib代理</p></li><li><p>切面、切点、通知等都不会被代理</p></li><li><p>自动代理后处理器调用时机：创建阶段、<strong>依赖注入阶段</strong>、<strong>初始化阶段</strong></p></li></ol></blockquote><p><strong>注解</strong></p><ul><li>@Aspect：表示为切面类</li><li>@Around、@Before、@After等：通知方法，可以加切点表达式</li></ul><h4 id="三级缓存"><a href="#三级缓存" class="headerlink" title="三级缓存"></a>三级缓存</h4><p><img src="/img/else_img/bean%E7%9A%84%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png"></p><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><ul><li>一级缓存作用：限制bean在beanFactory中只存一份</li></ul><p>​<strong>只有一级缓存不能解决循环依赖问题</strong></p><p>​<img src="/img/else_img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%961.png"></p><ul><li><p>二级缓存作用（Spring中的三级缓存）：存还未装载成员变量的空对象，解决循环依赖，在初始化完后把二级缓存中的空对象清除掉</p><p><img src="/img/else_img/bean%E7%9A%84%E7%AC%AC%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98.png"></p><p><strong>二级缓存不能解决循环依赖中有代理的情况</strong></p><p><img src="/img/else_img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%962.png"></p></li><li><p>三级缓存作用（Spring中的二级缓存）：解决循环依赖中代理创建过晚的问题，通过工厂判断是否需要代理，需要则提前创建代理对象，否则返回本身空对象</p><p><img src="/img/else_img/bean%E7%9A%84%E7%AC%AC%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png"></p><p><strong>三级缓存不能解决构造函数中有循环依赖</strong>：构造不出来，无法放到缓存中</p><p><img src="/img/else_img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%963.png"></p><p>解决方式1：加@Lazy注解，会先创建代理对象注入，待用到时再注入</p><p><img src="/img/else_img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%964.png"></p><p>解决方式2：通过<code>ObjectFactory&lt;B&gt; b</code> 来先注入工厂，使用时在创建bean</p><p><img src="/img/else_img/%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%965.png"></p></li></ul><h3 id="单例Bean是线程安全的吗"><a href="#单例Bean是线程安全的吗" class="headerlink" title="单例Bean是线程安全的吗"></a>单例Bean是线程安全的吗</h3><p>不是线程安全的。@Scope注解默认是sington单例的。如果spring的bean中注入的都是无状态的对象，是没有线程安全问题的，如果在bean中定义了可以修改的成员变量，是要考虑线程安全问题的，可以使用多例或加锁来解决问题</p><h3 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h3><blockquote><p>面向切面编程，用于将那些与业务无关，但对多个对象产生影响的公共行为或逻辑，抽出并封装成一个可重用的模块</p></blockquote><p>常见AOP使用场景</p><ul><li><p>记录操作日志</p></li><li><p>缓存处理</p></li><li><p>事务</p><blockquote><p>编程式事务：使用TransactionTemplate，对代码有侵入性</p><p>声明式事务：使用@Transactional注解，通过AOP功能，对方法进行拦截</p></blockquote></li></ul><h3 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h3><p>@SpringBootApplication中包含的@EnableAutoConfiguration中用@Import导入了配置选择器</p><p>内部读取了该项目和引用的Jar包的classpath路径下<code>META-INF/spring.factories</code>文件中的所配置的类的全类名，根据这些配置类中定义的Bean所指定的条件来决定是否注入到Spring容器中</p><h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="基础-1"><a href="#基础-1" class="headerlink" title="基础"></a>基础</h3><p>redis默认端口号：6379</p><p>redis默认有16个库</p><p>redis五种基本数据类型：</p><ol><li>string(字符串)</li><li>hash(哈希) </li><li>list(列表)</li><li>set(集合)</li><li>sortedSet(有序集合)</li></ol><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>缓存（穿透、击穿、雪崩、双写一致、持久化、数据过期、淘汰策略）、</p><p>分布式锁（setnx、redisson）</p><p>计数器（浏览量、点赞数）</p><p>排行榜</p><h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p><strong>定义</strong>：查询一个不存在的数据时，mysql查询不到数据也不会直接写入缓存，就会导致每次请求都查询数据库</p><p><strong>解决方式</strong>：</p><ol><li><p>缓存空数据（消耗内存，可能发送不一致的问题）</p></li><li><p>布隆过滤器拦截不存在的数据（内存占用小，存在误判的风险，实现复杂）</p><blockquote><p>布隆过滤器：通过位图检索一个元素是否在一个集合中，hash冲突可能造成误判</p></blockquote></li></ol><h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><p><strong>定义</strong>：某个key过期的时候，恰好有大量的并发请求在同一时间发过来，所有的请求都打到了数据库上，如果重建缓存时间太长，数据库就有可能崩溃</p><p><strong>解决方式</strong>：</p><ol><li><p>互斥锁（强一致，性能差）</p><blockquote><p>第一个没查到缓存的线程获取锁去重建缓存，其他线程等待</p></blockquote></li><li><p>逻辑过期（弱一致，高可用）</p><blockquote><p>添加逻辑过期字段，第一个发现过期的线程获取互斥锁，新开一个线程去重建缓存，其他线程返回旧数据</p></blockquote></li></ol><h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><p><strong>定义</strong>：同一时段大量key同时过期或Redis服务宕机，导致大量请求打到数据库</p><p><strong>解决方式</strong>：</p><ol><li>给key设置不同的TTL</li><li>搭建集群</li><li>添加降级限流规则</li><li>添加多级缓存</li></ol><h3 id="双写一致性"><a href="#双写一致性" class="headerlink" title="双写一致性"></a>双写一致性</h3><p><strong>定义</strong>：指的是mysql的数据和redis的数据保持一致</p><p>读操作：缓存命中，直接返回；未命中查询数据库，设置超时时间写入缓存</p><p>写操作：</p><ol><li><strong>延迟双删</strong>（弱一致，先更新数据库再删除缓存，延迟一段时间后再删一次）</li><li><strong>加锁后写数据</strong>（强一致）</li><li>通过消息队列，数据库更新后通知redis（弱一致）</li></ol><blockquote><p><strong>不延时双删</strong></p><p>先删缓存再更新数据库：删除缓存后又有线程重建了缓存，造成数据不一致</p><p>先更新数据库再删缓存：此时key过期，另一个线程查到旧数据，待删除缓存后又重建缓存，造成数据不一致</p></blockquote><h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p><strong>RDB</strong>：Redis Database Backup file，Redis数据备份文件，把所有数据都备份到磁盘</p><p><strong>执行原理</strong>：</p><p>主进程使用页表映射内存中的地址，子进程备份数据时拷贝一份页表来进行备份；</p><p>主进程写操作时，先拷贝一份要修改数据到另一块内存，修改完数据后修改页表指向的内存地址（copy-on-write），保证备份时的数据一致性</p><p><strong>AOF</strong>：Append Only File，追加文件，记录每一个写操作。需要去配置文件里打开此功能</p><p><strong>比较</strong>：</p><ul><li>完整性比RDB高，文件大小会比RDB大，可以通过bgrewriteaof来重写AOF以减少大小</li><li>rdb和aop都不能保证恢复所有数据，如果在写rdb和aop文件时出现故障，或由于压缩rdb、重写aop都有可能导致数据丢失</li></ul><h3 id="过期策略"><a href="#过期策略" class="headerlink" title="过期策略"></a>过期策略</h3><p><strong>惰性删除</strong>：使用时发现key过期了才删除，占内存</p><p><strong>定期删除</strong>：每隔一段时间检查一批key，把过期的删除</p><p>Redis的过期删除策略是两者结合</p><h3 id="淘汰策略"><a href="#淘汰策略" class="headerlink" title="淘汰策略"></a>淘汰策略</h3><p>内存占用太多时删掉一些数据</p><ul><li><p>noeviction：内存满时不淘汰数据，而是不允许写入数据（默认）</p></li><li><p>volatile-ttl：淘汰TTL小的数据</p></li><li><p>allkeys-random：对所有数据随机淘汰</p></li><li><p>volatile-random：对设置了过期时间的数据随机淘汰</p></li><li><p><strong>allkeys-lru</strong>：（Least Recently Used，最近最少使用：最近最少使用的key）</p></li><li><p>volatile-lru</p></li><li><p><strong>allkeys-lfu</strong>：（Least Frequently Used，最少频率使用：一定时间内使用频率最少的key）</p></li><li><p>volatile-lfu</p></li></ul><h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><h4 id="Redisson实现分布式锁"><a href="#Redisson实现分布式锁" class="headerlink" title="Redisson实现分布式锁"></a>Redisson实现分布式锁</h4><p>加锁、设置过期时间都是通过<strong>Lua</strong>脚本实现的</p><p><strong>看门狗机制</strong>（Watch Dog）：每隔一定时间（releaseTime&#x2F;3）做一次续期</p><p><strong>重试机制</strong>：在一定次数内通过while循环尝试加锁，增加分布式锁的性能</p><p><strong>可重入</strong>：根据线程id判断是否是同一线程</p><p><img src="/img/else_img/redisson%E9%94%81%E9%87%8D%E5%85%A5.png"></p><p><strong>主从一致性</strong>：</p><ul><li>如果一个线程在主节点加锁后，主节点还没有和从节点同步数据就宕机了，此时另一个线程也来加锁，就会导致同一把锁被两个线程持有。</li><li>redisson解决方式1：RedLock（红锁）：在多个redis实例上创建锁（n &#x2F; 2 + 1），性能差</li></ul><h3 id="集群"><a href="#集群" class="headerlink" title="集群"></a>集群</h3><p><strong>主从复制</strong>：搭建主从节点，实现读写分离，提高并发能力</p><p><img src="/img/else_img/redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6.png" alt="主节点写操作，从节点读操作"></p><p><strong>主从同步</strong></p><p><img src="/img/else_img/redis%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5.png" alt="全量同步"></p><p><img src="/img/else_img/redis%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5.png" alt="增量同步"></p><ul><li>通过replid判断主从节点数据的版本号，如果从节点没有replid表示第一次同步数据，主节点需要发送RDB文件（全量同步）</li><li>如果不是第一次同步数据，则通过offset偏移量判断需要从repl_backlog中发送多少数据来更新从节点数据（增量同步）</li></ul><p><strong>哨兵模式</strong>：监控、故障恢复、通知</p><p>监控：心跳检测，监控主从节点是否能正常工作</p><p>故障恢复：主节点挂了选择offset大的从节点提升为主节点</p><p>通知：当集群发生故障转移时，通知Redis客户端</p><p>脑裂问题：主节点没有挂，而是由于网络延迟导致哨兵节点检测不到，从而又选了个主节点，原先的主节点强制变为从节点，而主节点里这段时间的写数据就丢失了。<strong>解决方式</strong>：设置主节点要有一定数量的从节点时才能接收写数据、设置主从同步延迟时间的上限</p><p><strong>分片集群</strong></p><p>解决海量数据存储和高并发写的问题</p><p>特点：</p><ul><li>集群中有多个master、每个master保存不同的数据</li><li>每个master都可以有多个slave节点</li><li>master之间通过ping检测彼此健康状态</li></ul><p>数据读写：</p><ul><li>Redis集群有16384个<strong>哈希槽</strong>，每个key通过哈希运算后决定放到哪个槽中。</li><li>每个节点负责一部分hash槽</li></ul><h3 id="Redis为什么快"><a href="#Redis为什么快" class="headerlink" title="Redis为什么快"></a>Redis为什么快</h3><ul><li>Redis是基于内存的</li><li>采用单线程，避免不必要的上下文切换</li><li>使用I&#x2F;O多路复用模型，非阻塞IO（实现高效的网络请求）</li></ul><p><strong>I&#x2F;O多路复用模型</strong></p><ul><li><p>Redis客户端建立连接：</p><p>Redis监听一个TCP端口来接受客户端的连接，客户端 socket 会被设置为非阻塞模式，然后创建事件来接受客户端的数据</p></li><li><p>用户空间和内核空间：</p><p>用户空间只能执行受限的命令，内核空间可以执行特权命令，调用一切系统资源</p></li><li><p>阻塞IO、非阻塞IO和多路复用IO</p><p>阻塞IO：用户请求数据，内核在准备数据和拷贝数据到用户空间这段时间，其他用户进程阻塞等待</p><p>非阻塞IO：内核准备数据时客户端不断请求直到数据准备完成，拷贝到用户空间时阻塞等待</p><p><strong>阻塞&#x2F;非阻塞IO的问题是Redis单线程同时只能服务一个客户端，其他客户端只能等待</strong></p><p><strong>多路复用IO</strong>：其实是使用一个线程来检查多个 Socket 的就绪状态，当Socket有读写事件时才会去执行，不会一直阻塞在一个Socket上</p><p><img src="/img/else_img/redis%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8.png"></p></li></ul><h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="如何定位慢查询"><a href="#如何定位慢查询" class="headerlink" title="如何定位慢查询"></a>如何定位慢查询</h3><p>方案一：开源工具</p><ul><li>调试工具：Arthas</li><li>运维工具：Prometheus、Skywalking</li></ul><p>方案二：MySQL慢日志</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql"># my.cnf开启慢日志（在调试阶段才会开启，因为会损耗性能）<br>slow_query_log = 1<br># 设置执行时间(s)多久视为慢查询<br>long_query_time = 2<br><br># 在localhost-slow.log中记录了慢查询<br></code></pre></td></tr></table></figure><h3 id="慢查询优化"><a href="#慢查询优化" class="headerlink" title="慢查询优化"></a>慢查询优化</h3><p>在查询语句前加<code>EXPLAIN</code>获取执行的信息</p><p>possible_key：可能使用的索引</p><p>key：实际使用的索引</p><p>key_len：索引占用的大小（可以判断索引是否失效）</p><p>Extra：额外的优化建议</p><table><thead><tr><th>Extra</th><th>解释</th></tr></thead><tbody><tr><td>Using where; Using Index</td><td>使用了索引且不需要回表</td></tr><tr><td>Using index condition</td><td>使用了索引，但需要回表</td></tr></tbody></table><p>type：sql的查询的类型，当为index或all时速度慢</p><table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>system</td><td>查询系统中的表</td></tr><tr><td>const</td><td>根据主键查询</td></tr><tr><td>eq_ref</td><td>主键索引查询或唯一索引查询，只查询一条数据</td></tr><tr><td>ref</td><td>索引查询</td></tr><tr><td>range</td><td>范围查询</td></tr><tr><td>index</td><td>索引树扫描</td></tr><tr><td>all</td><td>全表扫描</td></tr></tbody></table><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><blockquote><p>高效获取数据的<strong>数据结构</strong>，提高数据库的检索效率，降低数据库的IO成本</p></blockquote><p><strong>数据结构对比</strong></p><p>二叉搜索数：最坏可能退化成链表</p><p>红黑树：数据量大时层数太大</p><p>B树：多叉路平衡查找树，非叶子节点存储数据，层级比B+树大</p><p>(mysql的)B+树：类似B树，只在叶子节点存数据(非叶子节点能存更多索引，层级更小)，叶子节点形成一个循环链表(范围查询)</p><p><strong>B+树优势</strong>：磁盘读写代价更低，查询效率稳定，便于扫库和范围查询</p><p><strong>聚簇索引和非聚簇索引</strong></p><p>也叫聚集索引和二级索引</p><table><thead><tr><th>分类</th><th>含义</th></tr></thead><tbody><tr><td>聚簇索引（必须有且只有一个）</td><td>数据和索引保存在一块，索引结构的叶子节点保存了<strong>行数据</strong></td></tr><tr><td>非聚簇索引（可以有多个）</td><td>数据和索引分开存储，叶子节点关联的是对应的<strong>主键</strong></td></tr></tbody></table><p><strong>回表查询</strong>：走二级索引找到主键后走聚集索引</p><p><strong>覆盖索引</strong>：查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- 如果非聚簇索引中包含了col1和col2，那就不需要回表查询<br>SELECT col1, col2 FROM mytable WHERE col1 = 123;<br></code></pre></td></tr></table></figure><p>使用覆盖索引可以减少磁盘 I&#x2F;O 操作和 CPU 开销，提高查询性能</p><p><strong>超大分页</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">-- MySQL需要对整个查询结果集进行排序，当数据规模过大时，排序时间会明显增加<br>select * from tb_sku limit 900000, 10;<br><br>-- 使用覆盖索引+子查询来优化<br>select *<br>from tb_sku t,<br>(select id from tb_sku order by id limit 900000, 10) a<br>where t.id = a.id;<br></code></pre></td></tr></table></figure><p><strong>创建索引原则</strong>：</p><ol><li>对数据量大(&gt; 10w)且查询频繁的表建立索引</li><li>对查询条件(where)、排序(order by)、分组(group by)操作的字段建立索引</li><li>选择区分度高的列作为索引</li><li>对字符串类型的字段，字段的长度较长，可以建前缀索引</li><li>使用联合索引来进行覆盖索引</li><li>索引数量适中</li><li>不能存NULL值时使用NOT NULL来约束</li></ol><h3 id="索引失效"><a href="#索引失效" class="headerlink" title="索引失效"></a>索引失效</h3><ol><li>违法最左前缀法则（跳过前面、中间的列），</li><li>范围查询，</li><li>运算操作，</li><li>字符串不加引号（发生了类型转换）</li><li>头部使用模糊查询</li></ol><h3 id="sql优化"><a href="#sql优化" class="headerlink" title="sql优化"></a>sql优化</h3><p><strong>表设计优化</strong>：</p><ol><li>选择合适的数值类型（tinyint、int、bigint）</li><li>选择合适的字符串类型（char、varchar）</li></ol><p><strong>SQL语句优化</strong>：</p><ol><li>select语句避免使用select *（可能造成回表查询）</li><li>避免索引失效</li><li>尽量使用union all代替union（union会过滤重复数据，效率相对较低）</li><li>尽量用inner join 代替left join&#x2F;right join，尽量小表驱动大表，减少数据库连接。inner join会优化把小表放到外边，大表放到里边</li><li>主从复制，读写分离</li></ol><h3 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h3><p><strong>原子性</strong>(Atomicity)：不可分割</p><p><strong>一致性</strong>(Consistency)：所有的数据都保持一致的状态</p><p><strong>隔离性</strong>(Isolation)：事务不受外部并发影响</p><p><strong>持久性</strong>(Durability)：事务提交或回滚，对数据库的影响是永久的</p><h3 id="并发事务问题"><a href="#并发事务问题" class="headerlink" title="并发事务问题"></a>并发事务问题</h3><p>脏读：一个事务读到另一个事务还没有提交的数据</p><p>不可重复读：事务先后两次读取同一条记录，但读到的数据不同</p><p>幻读：事务按照条件查询数据时没有对应数据，但插入时发现数据已经存在了</p><h3 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h3><blockquote><p>解决事务并发问题</p></blockquote><p>读未提交</p><p>读已提交：解决脏读</p><p>可重复读：InnoDB默认隔离级别，解决不可重复读</p><p>串行化：性能低</p><h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><p><strong>bin log</strong>：二进制日志文件，记录每一条DDL和DML，用于备份恢复和主从复制</p><p><strong>redo log</strong>：重做日志，记录缓冲池里数据的变化。当刷新脏页到磁盘时发生了错误，就使用redo log进行数据恢复，保证持久性</p><p><strong>undo log</strong>：回滚日志，记录被修改前的信息或反向操作。提供回滚和MVCC，保证一致性和持久性</p><h3 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h3><blockquote><p>多版本并发控制，维护一个数据的多个版本，使得读写操作没有冲突</p></blockquote><p><strong>隐藏字段</strong>：</p><ul><li>DB_TRX_ID：当前的事务ID</li><li>DB_ROLL_PTR：指向这条记录的上一个版本</li></ul><p><strong>undo log版本链</strong>：记录的多个版本串成链表，链表头为最新的记录</p><p><strong>readView</strong>：</p><table><thead><tr><th>字段</th><th>含义</th></tr></thead><tbody><tr><td>m_ids</td><td>当前还没提交的事务ID的集合</td></tr><tr><td>min_trx_id</td><td>m_ids里面最小的事务ID</td></tr><tr><td>max_trx_id</td><td>m_ids里面最大的事务ID+1</td></tr><tr><td>creator_trx_id</td><td>ReadView创建时的事务ID</td></tr></tbody></table><p>读已提交下每次读都会创建一个readView（当前读）</p><p>可重复读下在事务的第一次读时创建readView，后续都用这个（快照读）</p><h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>binLog日志记录主库的DML（数据操作语言）和DDL（数据定义语言）语句，从库去拉主库的binLog到自己的Relay Log中，再通过Relay Log同步数据</p><h3 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h3><p>单表数据量达1000w或20G</p><p>可以通过业务或字段或数据来分库分表</p><h3 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h3><p>导出备份sql文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysqldump -u [username] -p [database_name] &gt; [backup_file].sql<br></code></pre></td></tr></table></figure><p> 恢复数据</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql -u [username] -p [database_name] &lt; [backup_file].sql<br></code></pre></td></tr></table></figure><h2 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h2><h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h3><p><img src="/img/else_img/MyBatis%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.png"></p><ol><li>加载配置文件（运行环境，映射文件）</li><li>构建SqlSessionFactory</li><li>通过SqlSessionFactory创建SqlSession对象（提供增删改查API）</li><li>Executor核心作用是处理SQL请求、事务管理、维护缓存以及批处理等</li><li>把映射文件里的信息封装到Exector的MappedStatement中</li><li>把请求参数转化为mysql可以识别的数据类型</li><li>把返回值转化为java对象</li></ol><h3 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h3><blockquote><p>在执行 SQL 查询时，只加载需要立即返回到 Java 对象中的数据，而将其余数据的加载推迟到访问时</p><p>MyBatis 中的延迟加载主要是针对一对多和多对多的关联关系中的关联对象进行的</p></blockquote><p>通过<code>fetchType = true</code>开启延迟加载</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&lt;!-- 延迟加载一对多关联关系 --&gt;<br>&lt;resultMap id=&quot;userMap&quot; type=&quot;User&quot;&gt;<br>  &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;<br>  &lt;result column=&quot;userName&quot; property=&quot;userName&quot;/&gt;<br>  &lt;result column=&quot;password&quot; property=&quot;password&quot;/&gt;<br>  &lt;collection property=&quot;posts&quot; ofType=&quot;Post&quot; column=&quot;id&quot;<br>              select=&quot;selectPostsByUserId&quot; fetchType=&quot;lazy&quot;/&gt;<br>&lt;/resultMap&gt;<br><br>&lt;select id=&quot;selectUserById&quot; resultMap=&quot;userMap&quot;&gt;<br>  SELECT * FROM user WHERE id = #&#123;id&#125;<br>&lt;/select&gt;<br><br>&lt;select id=&quot;selectPostsByUserId&quot; resultType=&quot;Post&quot;&gt;<br>  SELECT * FROM post WHERE userId = #&#123;id&#125;<br>&lt;/select&gt;<br></code></pre></td></tr></table></figure><p>开启全局延迟加载</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">default-lazy-loading-enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><p><strong>一级缓存</strong>：作用域为Session，当Session被flush()或者close()时缓存就会清空</p><p><strong>二级缓存</strong>：作用域为整个MySQL实例，任何客户端都可以使用</p><ul><li><p>二级缓存需要缓存的数据要实现Serializable接口</p></li><li><p>只有Session提交或关闭后，一级缓存中的数据才会转移到二级缓存中</p></li><li><p>当进行了增删改操作后，一、二级缓存都会清空</p></li><li><p>一级缓存默认开启，二级缓存要手动开启：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在mapper上加上@CacheNamespace</span><br><span class="hljs-comment">// 在方法上加上 @Options(useCache = true)</span><br><span class="hljs-meta">@CacheNamespace</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> &#123;<br>    <span class="hljs-meta">@Select(value = &quot;select * from user where id = #&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@Options(useCache = true)</span><br>    User <span class="hljs-title function_">selectUserById</span><span class="hljs-params">(Integer id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">// 如果是在xml中定义的sql语句，需要加上<span class="hljs-tag">&lt;<span class="hljs-name">cache</span>/&gt;</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><h3 id="5大组件"><a href="#5大组件" class="headerlink" title="5大组件"></a>5大组件</h3><p>注册中心（Eureka、Nacos、zookeeper等）</p><p>远程调用（Feign等）</p><p>负载均衡（Ribbon等）</p><p>服务熔断（Hystrix、Sentinel等）</p><p>网关（Getway、Zuul等）</p><h3 id="注册中心"><a href="#注册中心" class="headerlink" title="注册中心"></a>注册中心</h3><p><strong>主要作用</strong>：服务注册和发现、服务健康监控</p><p>服务注册：服务提供者需要把自己的信息注册到注册中心中，如服务名称、ip和端口等</p><p>服务发现：消费者拉取服务列表信息，如果服务提供者有集群，则会利用负载均衡算法，选择一个发起调用</p><p>服务监控：服务提供者每隔一段时间向注册中心发送心跳，报告健康状态，如果长时间没有收到心跳，这从服务列表里剔除</p><h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>Ribbon负载均衡策略：</p><ul><li><strong>RoundRobinRule</strong>：简单轮询</li><li><strong>WeightedResponseTimeRule</strong>：按照权重来选择服务器，响应时间越长，权重越小</li><li><strong>RandomRule</strong>：随机选择</li><li>BestAvailableRule：选择当前并发度低的服务器</li><li>RetryRule：重试机制的选择逻辑</li><li>AvailabilityFilteringRule：先过滤非健康的，再选择连接数较小的实例</li><li><strong>ZoneAvoidanceRule</strong>：按区域就近选择服务器</li></ul><p>自定义负载均衡策略：</p><ul><li>实现IRule接口（全局生效）</li><li>通过配置文件给单独的服务选择负载均衡策略（局部）</li></ul><h3 id="服务雪崩"><a href="#服务雪崩" class="headerlink" title="服务雪崩"></a>服务雪崩</h3><p><strong>服务雪崩</strong>：一个服务失败，导致整条链路的服务都失败的情况</p><p>解决方式：</p><ul><li><p>服务降级</p><p>在远程调用@FeignClient()中设置fallback</p></li><li><p>服务熔断</p><p>Hystrix熔断机制：如果10s内请求的失败率超过50%触发熔断机制，所有请求都会失败。熔断时间结束后尝试放行请求，如果成功则关闭断路器</p></li><li><p>限流</p></li></ul><h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>用于问题定位和性能分析</p><p>常见服务监控工具</p><ul><li>Spring Boot admin</li><li>prometheus + Grafana</li><li>zipkin</li><li><strong>skywalking</strong></li></ul><h3 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h3><p>为何要限流：</p><ul><li>并发大</li><li>防止恶意刷接口</li></ul><p>实现方式：</p><ul><li><p><strong>Nginx</strong>：漏桶算法(突发流量)、控制并发连接数</p><p><img src="/img/else_img/nginx%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95.png"></p></li><li><p><strong>网关</strong>：过滤器RequestRateLimiter（令牌桶）</p></li><li><p>自定义拦截器</p></li></ul><h3 id="分布式系统理论"><a href="#分布式系统理论" class="headerlink" title="分布式系统理论"></a>分布式系统理论</h3><p><strong>CAP定理</strong>：</p><ol><li><p>Consistency：一致性，用户访问分布式系统中的任意节点，得到的数据必须一致</p></li><li><p>Availability：可用性，访问节点必须得到响应</p></li><li><p>Partition tolerance：分区容错性，出现分区时也要对外提供服务</p><blockquote><p>分区：由于网络故障等原因造成部分节点与其他节点失去联系</p></blockquote></li></ol><p>同时只能满足两个，如果要可用性则只能牺牲一致性，反之亦然</p><p><strong>BASE理论</strong>：</p><ol><li>Basically Available：基本可用，保证核心可用</li><li>Soft State：软状态，允许出现临时的数据不一致</li><li>Eventually Consistent：最终一致性，在软状态结束后，最终达到数据一致</li></ol><h3 id="接口幂等性"><a href="#接口幂等性" class="headerlink" title="接口幂等性"></a>接口幂等性</h3><p><strong>幂等</strong>：多次调用方法或者接口不会改变业务状态，可以保证重复调用的结果和单次调用的结果一致</p><p>如：点击提交订单，点击多次也只能有一次是成功的</p><table><thead><tr><th>请求方式</th><th>说明</th></tr></thead><tbody><tr><td>GET</td><td>查询操作，天然幂等</td></tr><tr><td>POST</td><td>新增操作，不是幂等的</td></tr><tr><td>PUT</td><td>更新操作，如果是设置值，是幂等的；如果是在一个值上进行增量操作，不是幂等的</td></tr><tr><td>DELETE</td><td>删除操作，是幂等的</td></tr></tbody></table><p><strong>保证幂等的方式</strong>：</p><p><strong>token+redis</strong>：</p><p><img src="/img/else_img/%E6%8E%A5%E5%8F%A3%E5%B9%82%E7%AD%891.png"></p><p>如点击购买，生成token存放到redis并返回给前端；之后提交订单则前端带着token来验证，验证成功则生成订单并删除redis中的token，之后的请求就不会重复生成订单</p><p><strong>分布式锁</strong>：</p><p>如第一次提交订单则加锁来生成订单，之后的请求就会由于抢不到锁而不重复生成订单</p><h2 id="消息中间件"><a href="#消息中间件" class="headerlink" title="消息中间件"></a>消息中间件</h2><h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><h4 id="消息不丢失"><a href="#消息不丢失" class="headerlink" title="消息不丢失"></a>消息不丢失</h4><p>消息可能在发送到交换机、队列和消费者宕机时丢失</p><p>RabbitMQ提供publisher confirm（生产者确认）机制来避免消息丢失。消息发送到MQ后，会返回一个结果给生产者。</p><p><img src="/img/else_img/RabbitMQ%E7%94%9F%E4%BA%A7%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6.png"></p><p><strong>消息丢失后处理方式</strong>：</p><ul><li>立即重发</li><li>记录日志</li><li>保存发送失败的数据，定时一起重发</li></ul><p><strong>消息持久化</strong>：MQ默认是内存存储消息，开启持久化可以保证消息不丢失</p><ol><li><p>交换机持久化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">simpleExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 交换机名称、是否持久化、没有queue绑定时是否自动删除</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(<span class="hljs-string">&quot;simple.direct&quot;</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>队列持久化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">simpleQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> QueueBuilder.durable(<span class="hljs-string">&quot;simple.queue&quot;</span>).build();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消息持久化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> MessageBuilder<br>    .withBody(message.getBytes())<br>    .setDelieryMode(MessageDelieryMode.PERSISTENT)<span class="hljs-comment">// 持久化</span><br>    .build();<br></code></pre></td></tr></table></figure></li></ol><p><strong>消费者确认</strong>：消费者收到消息返回ack，MQ收到ack后才会删除消息。如果多次获取消息失败，则将消息投递到异常交换机来处理</p><h4 id="死信交换机-x2F-延迟队列"><a href="#死信交换机-x2F-延迟队列" class="headerlink" title="死信交换机&#x2F;延迟队列"></a>死信交换机&#x2F;延迟队列</h4><p><strong>延迟队列</strong>：进入队列的消息会被延迟消费的队列，延迟队列&#x3D;死信交换机+TTL（生存时间）</p><p>使用场景：超时订单取消、限时优惠、定时发布等</p><p><strong>死信</strong>：过期消息、消费失败的消息、消息队列满了时最早的消息</p><p><strong>死信交换机</strong>：接收死信的交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">ttlQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> QueueBuilder.durable(<span class="hljs-string">&quot;simple.queue&quot;</span>)<br>        .ttl(<span class="hljs-number">10000</span>)<br>        .deadLetterExchange(<span class="hljs-string">&quot;dl.direct&quot;</span>)<span class="hljs-comment">// 指定死信交换机</span><br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="消息堆积"><a href="#消息堆积" class="headerlink" title="消息堆积"></a>消息堆积</h4><p>生产者生产消息的速度大于消费者消费消息的速度时，就会导致堆积</p><p>解决方式：</p><ul><li>增加消费者</li><li>消费者开启线程池加快消息处理速度</li><li>扩大队列容积</li><li><strong>惰性队列</strong>：消息接收后存到磁盘中，时效性低</li></ul><h4 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h4><p><strong>普通集群</strong></p><ul><li>集群中的节点共享交换机、队列信息，不包含队列中的消息</li><li>当访问集群某节点时，如果队列不在该节点，会从数据所在节点传递到当前节点并返回</li><li>队列所在节点宕机，队列中的消息就会丢失</li></ul><p><strong>镜像集群</strong></p><ul><li>主从模式，镜像节点做备份，主节点完成操作，主节点宕机由镜像节点替代</li></ul><p><strong>仲裁队列</strong></p><ul><li>主从模式，主从同步基于Raft协议，解决镜像节点主从同步时主节点宕机的问题</li></ul><h2 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h2><h3 id="基础-2"><a href="#基础-2" class="headerlink" title="基础"></a>基础</h3><h4 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h4><p>进程：当一个程序被运行，从磁盘加载代码到内存，此时就开启了一个进程</p><p>线程：一个进程可以分为多个线程</p><p><strong>比较</strong>：</p><ol><li>进程是正在运行的实例，进程包含线程，每个线程执行不同的任务</li><li>不同的进程使用不同的内存空间，一个进程的线程共享内存空间</li><li>线程上下文切换代价更低</li></ol><h4 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行</h4><p>并发：一个cpu同时处理多个线程</p><p>并行：多个线程同时执行</p><h4 id="star-创建线程的方式"><a href="#star-创建线程的方式" class="headerlink" title=":star:创建线程的方式"></a>:star:创建线程的方式</h4><ul><li>继承<strong>Thread</strong>类，重写run()，start()开启</li><li>实现<strong>Runnable</strong>接口，重写run()，用Thread()包装，start()开启</li><li>实现<strong>Callable</strong>接口，重写call()，用FutureTask()包装，再用Thread()包装，start()开启，get()获取返回值</li><li><strong>线程池</strong>创建线程，将任务submit提交给线程池</li></ul><p>Runnable和Callable的区别：</p><ul><li>Runnable接口的run方法没有返回值，Callable接口call方法有返回值</li><li>Callable接口的call方法允许抛出异常，Runnable的run只能catch</li></ul><h4 id="start-和run-的区别"><a href="#start-和run-的区别" class="headerlink" title="start()和run()的区别"></a>start()和run()的区别</h4><p>start()：启动线程，start方法只能调用一次</p><p>run()：要被线程执行的代码</p><h4 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span>&#123;<br>    <span class="hljs-comment">// 新建</span><br>    NEW,<br>    <br>    <span class="hljs-comment">// 就绪</span><br>    RUNNABLE,<br>    <br>    <span class="hljs-comment">// 阻塞</span><br>    BLOCKED,<br>    <br>    <span class="hljs-comment">// 等待</span><br>    WAITING,<br>    <br>    <span class="hljs-comment">// 有限时等待</span><br>    TIMED_WAITING,<br>    <br>    <span class="hljs-comment">// 终止</span><br>    TERMINATED;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>Thread.join()：等待线程执行完</p><p>Object.wait()：放弃锁，在这个锁上等待</p><p>Object.notify()：随机唤醒锁上等待的线程</p><p>Object.notifyAll()：唤醒当前锁上的所有线程</p><p>Thread.sleep()：抱着锁睡眠</p><p>Thread.interrupt()：打断线程，被打断的线程如果在阻塞会抛异常；被打断线程没有阻塞，则自己通过interrupt变量判断是否要终止线程</p><h3 id="并发安全"><a href="#并发安全" class="headerlink" title="并发安全"></a>并发安全</h3><h4 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h4><p><strong>synchronized</strong></p><blockquote><p>互斥的对象锁，重量级锁，性能较低，一旦锁发生竞争都会升级为重量级锁</p></blockquote><p><strong>原理</strong></p><p>synchronized(lock)中的lock会与Monitor关联（对象的MarkWord指向Monitor）</p><p>Monitor监视器：</p><ul><li>WaitSet：在锁上wait的线程</li><li>EntryList：等待锁的线程队列</li><li>Owner：当前锁的持有者</li></ul><p><strong>轻量级锁</strong>：通过CAS来获取锁；锁对象的MarkWord指向锁记录地址，原来MarkWord的内容放在持有锁线程中</p><p><strong>偏向锁</strong>：只是在MarkWord中记录一下持有锁线程的id，锁重入时不需要cas</p><h4 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h4><blockquote><p>JMM（Java Memory Model），定义了<strong>共享内存</strong>和<strong>多线程程序</strong>读写操作的行为规范</p></blockquote><p><img src="/img/else_img/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png"></p><h4 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h4><blockquote><p>Compare And Swap，体现乐观锁的思想，在无锁状态下保证线程操作数据的原子性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 伪代码</span><br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-type">int</span> 旧值A = 共享变量V;<br>    <span class="hljs-type">int</span> 新值B = 旧值A + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> (compareAndSwap(旧值A, 新值B)) &#123;<span class="hljs-comment">// 比较V的值是否和旧值A相同</span><br>        <span class="hljs-comment">// 成功，退出循环</span><br>    &#125;<br>&#125;<br><span class="hljs-comment">// cas失败则会重试一定次数(自旋)</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>没有加锁，线程不会阻塞，效率较高</li><li>若竞争激烈，重试频繁，效率会受影响</li></ul><p><strong>底层</strong>：</p><p>​依赖于Unsafe类来直接调用操作系统的CAS指令</p><p><strong>使用场景</strong>：</p><ul><li>ReentrantLock、AtomicXXX类等</li></ul><h4 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h4><blockquote><p>关键字，被修饰的变量可以保证<strong>可见性</strong>和防止<strong>指令重排序</strong></p></blockquote><p><strong>共享变量不可见的情况</strong>：由于一个变量需要读很多次，而每次都读到的同一个值，JIT编译器就会做优化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">stop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">while</span>(!stop) &#123;<span class="hljs-comment">// 这里!stop就可能被优化成true</span><br>    i++;<br>&#125;<br><br><span class="hljs-comment">// 通过 volatile boolean stop 可以不被优化</span><br></code></pre></td></tr></table></figure><p><strong>指令重排序的情况</strong>：编译器优化代码顺序</p><p>volatile通过向上的写屏障和向下的读屏障来防止指令重排</p><h4 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h4><blockquote><p>Abstract Queue Synchronized，抽象队列同步器</p></blockquote><p><strong>原理</strong>：通过state变量表示锁是否被占用(0 无锁，1 有锁)，线程通过CAS操作来进行修改，没抢到锁的去FIFO队列等待</p><p><strong>AQS常见的实现类</strong></p><ul><li>ReentrantLock 可重入锁</li><li>Semaphore 信号量</li><li>CountDownLatch 倒计时锁</li></ul><h3 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h3><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
      <category>面试题</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java虚拟机</title>
    <link href="/2023/02/18/java/Java%E8%99%9A%E6%8B%9F%E6%9C%BA/"/>
    <url>/2023/02/18/java/Java%E8%99%9A%E6%8B%9F%E6%9C%BA/</url>
    
    <content type="html"><![CDATA[<h1 id="Java虚拟机"><a href="#Java虚拟机" class="headerlink" title="Java虚拟机"></a>Java虚拟机</h1><p>学习自:<a href="https://shuyi.tech/">陈树义的博客 (shuyi.tech)</a></p><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="什么是虚拟机"><a href="#什么是虚拟机" class="headerlink" title="什么是虚拟机"></a>什么是虚拟机</h3><p>​<strong>Java跨平台</strong>：Java 语言并不直接将代码编译成与系统有关的机器码，而是编译成一种特定的语言规范，这种语言规范我们称之为<strong>字节码</strong>。Java 虚拟机会解析字节码文件的内容，并将其翻译为各操作系统能理解的机器码。<strong>实际上 Java 虚拟机运行的是字节码文件</strong></p><p><img src="/img/jvm_img/java%E8%B7%A8%E5%B9%B3%E5%8F%B0.png" alt="一次编译 到处运行"></p><p>​ Java 虚拟机就是一个字节码翻译器，它将字节码文件翻译成各个系统对应的机器码，确保字节码文件能在各个系统正确运行</p><h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><p>​编译器分类：前端编译器、JIT 编译器（Just In Time Compiler，即时编译器）和AOT编译器（Ahead of Time Compiler，静态提前编译器）</p><h4 id="前端编译器"><a href="#前端编译器" class="headerlink" title="前端编译器"></a>前端编译器</h4><p>​ JDK 的安装目录里有一个 javac 工具，就是它将 Java 代码翻译成字节码，这个工具我们叫做编译器。相对于后面要讲的其他编译器，其因为处于编译的前期，因此又被成为<strong>前端编译器</strong></p><p><strong>作用</strong></p><p>​源代码 –&gt; 字节码</p><p><strong>过程</strong></p><ol><li>词法分析、语法分析：javac编译器”读懂”源代码，生成语法树</li><li>填充符号表：编译阶段无法知道代码中引用到的其他类的地址，先用一个符号填充，到类加载阶段再替换为真实地址</li><li>分析注解</li><li>生成字节码</li></ol><h4 id="JIT-编译器"><a href="#JIT-编译器" class="headerlink" title="JIT 编译器"></a>JIT 编译器</h4><p>​生成字节码后，可以选择使用java解释器运行，或者使用JIT编译器先将字节码编译成机器码再运行。前者启动速度快但运行速度慢，而后者启动速度慢但运行速度快。为了运行速度以及效率，我们通常采用<strong>两者相结合</strong>的方式进行 Java 代码的编译执行</p><p><strong>作用</strong></p><p>​字节码 –&gt; 机器码</p><p><strong>类型</strong>：</p><p>​HotSpot 虚拟机内置有两种JIT编译器：Client Compiler 和Server Compiler，简称为C1编译模式、C2编译模式。</p><p>​不同：C1编译模式编译速度快、优化保守；C2编译模式编译较慢、优化相对较好。</p><p><strong>参数</strong>：</p><p>​默认是混合起来用的(Mixed Mode)，编译时可使用参数<code>-client</code>或<code>-server</code>指定只使用其中一种</p><p>​<code>-Xint</code>：只解释运行，不编译。</p><p>​<code>-Xcomp</code>：优先编译</p><h4 id="AOT编译器"><a href="#AOT编译器" class="headerlink" title="AOT编译器"></a>AOT编译器</h4><p>​AOT 编译器则能将源代码直接编译为本地机器码，速度快于前端编译器，慢于即时编译器。存在的目的在于Java 虚拟机加载已经预编译成二进制库，可以直接执行。不必等待及时编译器的预热，减少 Java 应用给人带来“第一次运行慢” 的不良体验。</p><p><strong>作用</strong></p><p>​源代码 –&gt; 机器码</p><h3 id="字节码文件结构"><a href="#字节码文件结构" class="headerlink" title="字节码文件结构"></a>字节码文件结构</h3><p>​《Java 虚拟机规范》规定了 Java 虚拟机结构、Class 类文件结构、字节码指令等内容。</p><p>字节码文件结构是一组以 8 位为最小基础的十六进制数据流。</p><p>字节码由两种基本数据类型组成：</p><ul><li>无符号数：u1、u2、u4、u8 六七分别代表 1 个字节、2 个字节、4 个字节、8 个字节的无符号数</li><li>表：由多个无符号数或其他表组成的数据结构，以<code>_info</code>结尾。字节码文件本质就是一张表</li></ul><p><img src="/img/jvm_img/%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%84%E6%88%90.png"></p><h4 id="魔数"><a href="#魔数" class="headerlink" title="魔数"></a>魔数</h4><p>​Class 文件的第 1 - 4 个字节代表了该文件的魔数（Magic Number），其值固定是：0xCAFEBABE。作用是确定这个文件是否为一个能被虚拟机接受的 Class 文件</p><h4 id="文件版本"><a href="#文件版本" class="headerlink" title="文件版本"></a>文件版本</h4><p>​Class 文件的第 5 - 6 个字节代表了 Class 文件的次版本号（Minor Version），即编译该 Class 文件的 JDK 次版本号。</p><p>​Class 文件的第 7 - 8 个字节代表了 Class 文件的主版本号（Major Version），即编译该 Class 文件的 JDK 主版本号。</p><p>​JDK1.8的十六进制版本号为0000 0034</p><h4 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h4><p>​占两个字节的constant_pool_count表示常量池中的常量个数</p><p>​<code>cp_info</code>表示整个常量池，里面的结构为<code>常量类型(u2) + 常量的数据结构(不定长) </code>的组合，常量的数据结构共有14 种 类型</p><p>​<img src="/img/jvm_img/%E5%B8%B8%E9%87%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"></p><h4 id="访问标志"><a href="#访问标志" class="headerlink" title="访问标志"></a>访问标志</h4><p>​access_flags用于识别一些类或者接口层次的访问信息</p><p>​<img src="/img/jvm_img/%E5%AD%97%E8%8A%82%E7%A0%81%E8%AE%BF%E9%97%AE%E6%A0%87%E5%BF%97.png"></p><p>​访问标志可能是由多个标志名称组成的，如0021是由0x0001 | 0x0020得来的</p><h4 id="类索引、父类索引、接口索引"><a href="#类索引、父类索引、接口索引" class="headerlink" title="类索引、父类索引、接口索引"></a>类索引、父类索引、接口索引</h4><p>​<strong>类索引</strong>：用于确定这个类的全限定名，大小为u2，指向常量池中的常量</p><p>​<strong>父类索引</strong>：引用于确定这个类的父类的全限定名，大小为u2，指向常量池中的常量</p><p>​<strong>接口索引</strong>：用来描述哪个类实现了哪些接口，u2 记录接口数量，后面interfaces记录所有的接口信息</p><h4 id="字段表"><a href="#字段表" class="headerlink" title="字段表"></a>字段表</h4><p>​用于描述接口或者类中声明的变量，字段表的每个字段用一个名为 field_info 的表来表示</p><p>​<img src="/img/jvm_img/%E5%AD%97%E6%AE%B5%E4%BF%A1%E6%81%AF%E8%A1%A8.png"></p><h4 id="方法表"><a href="#方法表" class="headerlink" title="方法表"></a>方法表</h4><p>​用于描述类中的方法信息</p><p>​<img src="/img/jvm_img/%E6%96%B9%E6%B3%95%E4%BF%A1%E6%81%AF%E8%A1%A8.png"></p><h4 id="属性表"><a href="#属性表" class="headerlink" title="属性表"></a>属性表</h4><p>​描述<strong>类</strong>的属性信息</p><h4 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h4><p>​可以通过<code>javap -verbose 文件名.class</code>反编译将字节码文件全部分析出来</p><p>​<img src="/img/jvm_img/%E5%8F%8D%E7%BC%96%E8%AF%91.png"></p><p>​<img src="/img/jvm_img/%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6%E6%95%B4%E4%BD%93%E7%A4%BA%E6%84%8F%E5%9B%BE.png"></p><h3 id="虚拟机内存结构"><a href="#虚拟机内存结构" class="headerlink" title="虚拟机内存结构"></a>虚拟机内存结构</h3><p>​字节码文件会加载进虚拟机内存中，进行一系列初始化后运行得出结果。</p><p>​Java 虚拟机的内存结构可以分为公有和私有两部分。公有指的是所有线程都共享的部分，指的是 <strong>Java 堆</strong>、<strong>方法区</strong>、<strong>常量池</strong>。私有指的是每个线程的私有数据，包括：<strong>PC寄存器</strong>、<strong>Java 虚拟机栈</strong>、<strong>本地方法栈</strong>。</p><h4 id="公有部分"><a href="#公有部分" class="headerlink" title="公有部分"></a>公有部分</h4><p>​<strong>java堆</strong>：专门用于 Java 实例对象的内存分配，几乎所有实例对象都在会这里进行内存的分配，有些小对象可能在栈上分配内存</p><p>根据对象存活时间，堆可以分为新生代、老年代、永久代（方法区）</p><p><img src="/img/jvm_img/%E5%A0%86%E7%BB%93%E6%9E%84.png"></p><ol><li><p><strong>新生代</strong>：</p><ul><li>Eden （伊甸）区：Java新对象的出生地（如果新创建的对象占用内存很大，则直接分配到老年代）。当Eden区内存不够的时候就会触发MinorGC，对新生代区进行一次垃圾回收。</li><li>ServivorTo、ServivorFrom：每次MinorGC都会清理serviorFrom和Eden区的对象，然后将幸存对象<strong>复制到</strong>ServiorTo中（达到老年代指标的对象存到老年代），随后清空Eden和ServicorFrom中的对象，最后交换serviorTo和ServiorFrom。（<strong>复制算法</strong>）</li></ul><p>三个区域的比例Eden：from ：to &#x3D; 8:1:1 ，通过<code>-XX:MaxTenuringThreshold = </code>设置GC多少次晋升到老年代，默认15。</p></li><li><p><strong>老年代</strong>：</p><p>​当老年代的空间不足时会触发MajorGC，首先扫描一次所有老年代，标记出存活的对象，然后回收没有标记的对象（<strong>标记清除法</strong>）</p></li><li><p><strong>方法区</strong>：</p><p>​指内存的永久保存区域，主要存放Class和Meta（元数据）的信息，在Java8中，永久代已经被移除，被一个称为“元数据区”（元空间）的区域所取代。元空间与永久代之间最大的区别在于：<strong>元空间并不在虚拟机中，而是使用本地内存</strong></p></li></ol><h4 id="私有部分"><a href="#私有部分" class="headerlink" title="私有部分"></a>私有部分</h4><ol><li><strong>PC 寄存器</strong>：保存线程当前正在执行的方法，任意时刻，一条 Java 虚拟机线程只会执行一个方法的代码，其地址被存在 PC 寄存器中。</li><li><strong>Java 虚拟机栈</strong>：用来存储栈帧，栈帧存储了方法的局部变量表、操作数栈、动态连接和方法返回地址等信息</li><li><strong>本地方法栈</strong>：用于管理本地方法（非java代码的接口）的调用</li></ol><h3 id="类加载"><a href="#类加载" class="headerlink" title="类加载"></a>类加载</h3><p>指虚拟机将字节码读取进内存，从而进行解析、运行等整个过程</p><p>类加载过程分为：<strong>加载、验证、准备、解析、初始化、使用、卸载</strong></p><p>加载：</p><p>​把代码数据加载到内存中</p><p>验证：</p><p>​校验Class字节码文件格式是否符合JVM规范，加载完字节码后在内存中创建对应的Class对象，之后检查是否有语法错误</p><p><strong>准备</strong>：</p><p>​给类分配内存，只会先给static修饰的变量分配内存并赋予对应类型的0值(0, “”, false,null)，而修饰了final的话则直接赋予用户希望的值</p><p>解析：</p><p>​将引用在常量池中的符号引用替换成直接其在内存中的直接引用</p><p><strong>初始化</strong>：</p><p>​JVM 会根据<strong>语句执行顺序</strong>对类对象进行初始化</p><p>​类初始化：给静态变量赋值，执行静态代码块，有父类会先类初始化父类，main函数所在类会被类初始化</p><p>​对象初始化：会先类初始化。给成员变量赋值，执行普通代码块，执行构造函数</p><p>​整体上就是惰性初始化，只有用到时才进行初始化</p><p>使用：</p><p>​JVM 开始从入口方法开始执行用户的程序代码</p><p>卸载：</p><p>​执行完程序，销毁Class对象，最后JVM也退出内存</p><h3 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h3><blockquote><p>如果一个对象不再被引用，则会被当做垃圾而回收。</p></blockquote><h4 id="如何知道对象是否被引用"><a href="#如何知道对象是否被引用" class="headerlink" title="如何知道对象是否被引用"></a>如何知道对象是否被引用</h4><ol><li><p>计数方法（已淘汰）：对象被引用时就+1，不再引用就-1。存在的问题：**循环引用(**A引用B，B引用A，但没有被其它对象引用，两者引用都不为0，无法被回收)</p></li><li><p>可达性算法<strong>GC Root Tracing</strong>：从 GC Root 出发，所有可达的对象都是存活的对象，不可达的为垃圾。</p><p>GC Root 就是一组活跃引用的集合，通常GC Root包括：</p><ul><li>所有当前被加载的 Java 类</li><li>Java 类的引用类型静态变量</li><li>Java类的运行时常量池里的引用类型常量</li><li>VM的一些静态数据结构里指向GC堆里的对象的引用</li><li>等等</li></ul></li></ol><h4 id="如何进行垃圾回收"><a href="#如何进行垃圾回收" class="headerlink" title="如何进行垃圾回收"></a>如何进行垃圾回收</h4><ol><li><strong>标记清除法</strong>：标记所有由 GC Root 触发的可达对象，清除所有未被标记的对象。缺点：会有产生内存碎片的问题。</li><li><strong>复制算法</strong>：将原有的内存空间分为两块，每次只使用一块，垃圾回收时将存活的对象复制到另一块，清除当前块内所有对象。缺点：内存没有被完全使用。</li><li><strong>标记压缩算法</strong>：上面两种方法的结合。标记存活对象，复制到内存的一边，清空剩余区域。</li></ol><p>实际是每种方法结合着用。新生代存活对象较少，适合复制算法；老年代存活对象多，适合标记清除法或标记压缩算法，减少对象的移动。</p><h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><p><strong>Minor GC&#x2F;Young GC</strong>：从年轻代空间回收内存</p><p><strong>Major GC&#x2F;Old GC</strong>：从老年代空间回收内存</p><p><strong>Full GC</strong>：清理年轻代、老年代和永久代，当发现年轻代空间太小或永久代空间不足时会触发</p><p><strong>Stop-The-World</strong>：在进行垃圾回收时因为标记或清理的需要，必须让所有执行任务的线程停止执行任务，从而让垃圾回收线程回收垃圾的时间间隔</p><h3 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h3><h4 id="串行回收器（Serial）"><a href="#串行回收器（Serial）" class="headerlink" title="串行回收器（Serial）"></a><strong>串行回收器（Serial）</strong></h4><p>指使用单线程进行垃圾回收的回收器</p><p><strong>分类</strong></p><ol><li><strong>新生代串行回收器</strong>：采用复制算法，垃圾回收时其他线程需要暂停（<strong>Stop-The-World</strong>）</li><li><strong>老年代串行回收器</strong>：采用标记压缩算法，也会Stop-The-World，可以与多种新生代回收器配合使用</li></ol><p><strong>参数</strong></p><ul><li><p><code>-XX:UseSerialGC</code>：新生代、老年代都使用串行回收器。</p></li><li><p><code>-XX:UseParNewGC</code>：新生代使用 ParNew 回收器（多线程），老年代使用串行回收器。</p></li><li><p><code>-XX:UseParallelGC</code>：新生代使用 ParallelGC 回收器（多线程），老年代使用串行回收器。</p></li></ul><h4 id="并行回收器（Parallel）"><a href="#并行回收器（Parallel）" class="headerlink" title="并行回收器（Parallel）"></a>并行回收器（Parallel）</h4><p>指使用多线程进行垃圾回收，可以有效缩短垃圾回收所使用的时间</p><p><strong>分类</strong></p><ol><li><p><strong>新生代ParNew 回收器</strong>：只是简单地将串行回收器多线程化</p><p><strong>启动参数</strong></p><ul><li><code>-XX:+UseParNewGC</code>：新生代使用 ParNew 回收器，老年代使用串行回收器。</li><li><code>-XX:UseConcMarkSweepGC</code>：新生代使用 ParNew 回收器，老年代使用 CMS。</li><li><code>-XX:ParallelGCThreads</code>：指定 ParNew 回收器的工作线程数量。</li></ul></li><li><p><strong>新生代 Parallel GC 回收器</strong>：相比于ParNew更加<strong>注重系统的吞吐量</strong></p><p><strong>设置参数</strong></p><ul><li><code>-XX:+UseAdaptiveSizePolicy</code>：自动调节新生代的大小、Eden 和 Survivor 的比例、晋升老年代的对象年龄等参数</li><li><code>-XX:MaxGCPauseMillis</code>：设置最大垃圾收集停顿时间</li><li><code>-XX:GCTimeRatio</code>：设置吞吐量大小</li></ul><p><strong>启动参数</strong></p><ul><li><code>-XX:+UseParallelGC</code>：新生代使用 Parallel 回收器，老年代使用串行回收器。</li><li><code>-XX:+UseParallelOldGC</code>：新生代使用 ParallelGC 回收器，老年代使用 ParallelOldGC 回收器。</li></ul></li><li><p><strong>老年代 ParallelOldGC 回收器</strong>：注重吞吐量的老年代的回收器</p><p><strong>启动参数</strong></p><ul><li><code>-XX:UseParallelOldGC</code>：新生代使用 ParallelGC 回收器，老年代使用 ParallelOldGC 回收器。</li></ul></li></ol><blockquote><p>jdk1.8 默认垃圾收集器Parallel Scavenge（新生代）+Parallel Old（老年代）</p></blockquote><h4 id="CMS-回收器"><a href="#CMS-回收器" class="headerlink" title="CMS 回收器"></a>CMS 回收器</h4><p>Concurrent Mark Sweep（并发标记扫描），CMS 回收器主要<strong>关注系统停顿时间</strong></p><p><strong>工作流程</strong>：</p><p>​<strong>初始标记</strong>：标记所有的根对象，包括根对象直接引用的对象，以及被年轻代中所有存活的对象所引用的老年代对象，会Stop-The-World，时间短</p><p>​<strong>并发标记</strong>：标记所有可达的对象，时间长，和用户线程并行。<strong>此阶段由于与用户线程并发执行，对象的状态可能会发生变化</strong>，JVM会将改变的区域标记为“脏”区（卡片标记）</p><p>​<strong>并发预清理</strong>：标记老年代存活的对象，目的是为了让重新标记阶段的STW尽可能短，和用户线程并行。</p><p>​<code>-XX:-CMSPrecleaningEnabled</code>：关闭并发预处理</p><p>​<strong>最终标记&#x2F;重新标记</strong>：重新扫描堆中的对象，之前的扫描都是并发的，可能跟不上修改速度。目标是完成老年代中所有存活对象的标记，会触发Stop The World</p><p>​<strong>并发清除和并发重置</strong>：用户线程被重新激活，不需要STW，目标是删除不可达的对象，并为下次GC做准备</p><h4 id="G1回收器"><a href="#G1回收器" class="headerlink" title="G1回收器"></a>G1回收器</h4><p>​G1（<strong>Garbage First</strong>，垃圾优先）</p><p>​ JDK 1.7 中使用的全新垃圾回收器，JDK9之后的默认垃圾收集器，是一款面向服务端应用的垃圾收集器</p><p>​<img src="/img/jvm_img/G1%E5%9B%9E%E6%94%B6%E5%99%A8.png"></p><p>​在 G1 回收器中，把堆内存分割为很多不相关的区域(region物理上不连续),把堆分为2048个区域。用不同的region可以来表示Eden、幸存者0区、幸存者1区、老年代等，G1回收器优先回收价值最大的Region</p><p><strong>分区Region</strong></p><ul><li>每个Region块大小根据堆空间的实际大小而定，整体被控制在1MB到32MB之间，且为2的N次幂。可通过<code>-XX :G1HeapRegionSize</code>设定大小</li><li><strong>Humongous</strong>内存区域主要用于存储大对象，如果超过1.5个region, 就放到H</li></ul><p><strong>工作流程</strong>：</p><ul><li>新生代 GC（Young GC）：启动多线程执行年轻代回收，会STW</li><li>老年代并发标记周期（Concurrent Marking）：所有将要被回收的区域会被 G1 记录在一个称之为 Collection Set 的集合中</li><li>混合收集（Mixed GC）：首先针对 Collection Set 中的内存进行回收，在混合回收的时候，也会执行多次新生代 GC 和 混合 GC</li><li>如果需要，可能进行 FullGC</li></ul><h3 id="JVM参数"><a href="#JVM参数" class="headerlink" title="JVM参数"></a>JVM参数</h3><h4 id="堆栈空间配置"><a href="#堆栈空间配置" class="headerlink" title="堆栈空间配置"></a>堆栈空间配置</h4><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-Xms</td><td align="center">初始堆大小</td></tr><tr><td align="center">-Xmx</td><td align="center">最大堆空间</td></tr><tr><td align="center">-Xmn</td><td align="center">设置新生代大小</td></tr><tr><td align="center">-XX:SurvivorRatio</td><td align="center">设置新生代eden空间和from&#x2F;to空间的比例关系</td></tr><tr><td align="center">-XX:PermSize</td><td align="center">方法区（永久代）初始大小（JDK1.7）</td></tr><tr><td align="center">-XX:MaxPermSize</td><td align="center">方法（永久代）区最大大小（JDK1.7）</td></tr><tr><td align="center">-XX:MetaspaceSize</td><td align="center">元空间GC阈值（JDK1.8）</td></tr><tr><td align="center">-XX:MaxMetaspaceSize</td><td align="center">最大元空间大小（JDK1.8）</td></tr><tr><td align="center">-Xss</td><td align="center">栈大小</td></tr><tr><td align="center">-XX:MaxDirectMemorySize</td><td align="center">直接内存大小，默认为最大堆空间</td></tr><tr><td align="center">-XX:+PrintGCDetails</td><td align="center">查看内存区域的分配信息</td></tr></tbody></table><p><strong>实例</strong></p><p><strong>堆配置</strong></p><p><code>java -Xms20m -Xmx30m</code>：设置 JVM 的初始堆大小为 20M，最大堆空间为 30M</p><p><code>java -Xms20m -Xmn10M</code>：设置 JVM 堆初始大小为20M，其中年轻代的大小为 10M</p><p><code>java -Xms20m -Xmn10M -XX:SurvivorRatio=2 -XX:+PrintGCDetails</code>：设置 JVM 堆初始大小为20M；年轻代的大小为 10M，其中比例为eden &#x2F; from &#x3D; eden &#x2F; to &#x3D; 2，即5M：2.5M：2.5M；打印内存区域的分配信息</p><p><code>java -XX:PermSize10m -XX:MaxPermSize50m -XX:+PrintGCDetails</code>：（jdk1.7）设置永久代初始大小为10M，最大50M</p><p><code>java -XX:MetaspaceSize=10m -XX:MaxMetaspaceSize=50m -XX:+PrintGCDetails</code>：设置元空间发生 GC 的初始阈值为10M，元空间最大大小为50M，默认为机器内存大小</p><p><strong>栈配置</strong></p><p><code>java -Xss2m</code>：设置栈空间最大为2M</p><p><code>java -XX:MaxDirectMemorySize=50m</code>:设置直接内存大小为50M</p><h4 id="查看参数"><a href="#查看参数" class="headerlink" title="查看参数"></a>查看参数</h4><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-XX:+PrintVMOptions</td><td align="center">程序运行时，打印虚拟机接受到的命令行显式参数。</td></tr><tr><td align="center">XX:+PrintCommandLineFlags</td><td align="center">打印传递给虚拟机的显式和隐式参数。</td></tr><tr><td align="center">-XX:+PrintFlagsFinal</td><td align="center">打印所有的系统参数的值</td></tr></tbody></table><p><strong>实例</strong></p><p><code>java  -XX:+UseSerialGC -XX:+PrintVMOptions</code>：打印显示参数（自己设定的参数）</p><p><code>java  -XX:+UseSerialGC -XX:+PrintCommandLineFlags</code>: 打印显式和隐式参数（默认参数）</p><p><code>java  -XX:+UseSerialGC -XX:+PrintFlagsFinal 文件名  &gt; jvm_flag_final.txt</code>：打印所有系统参数并重定向到</p><p>jvm_flag_final.txt文件中</p><h4 id="追踪类信息参数"><a href="#追踪类信息参数" class="headerlink" title="追踪类信息参数"></a>追踪类信息参数</h4><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-verbose:class</td><td align="center">跟踪类的加载和卸载</td></tr><tr><td align="center">-XX:+TraceClassLoading</td><td align="center">跟踪类的加载</td></tr><tr><td align="center">-XX:+TraceClassUnloading</td><td align="center">跟踪类的卸载</td></tr><tr><td align="center">-XX:+PrintClassHistogram</td><td align="center">显示类信息柱状图</td></tr></tbody></table><h4 id="GC日志参数"><a href="#GC日志参数" class="headerlink" title="GC日志参数"></a>GC日志参数</h4><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center"><strong>-XX:PrintGC</strong></td><td align="center">打印GC日志</td></tr><tr><td align="center"><strong>-XX:+PrintGCDetails</strong></td><td align="center">打印详细的GC日志。还会在退出前打印堆的详细信息。</td></tr><tr><td align="center">-XX:+PrintHeapAtGC</td><td align="center">每次GC前后打印堆信息。</td></tr><tr><td align="center">-XX:+PrintGCTimeStamps</td><td align="center">打印GC发生的时间。</td></tr><tr><td align="center">-XX:+PrintGCApplicationConcurrentTime</td><td align="center">打印应用程序的执行时间</td></tr><tr><td align="center">-XX:+PrintGCApplicationStoppedTime</td><td align="center">打印应用由于GC而产生的停顿时间</td></tr><tr><td align="center">-XX:+PrintReferenceGC</td><td align="center">跟踪软引用、弱引用、虚引用和Finallize队列。</td></tr><tr><td align="center">-XLoggc</td><td align="center">将GC日志以文件形式输出。</td></tr></tbody></table><p><strong>实例</strong></p><p><code>java -XX:+UseSerialGC -Xms20M -Xmx20M -Xmn10M -XX:SurvivorRatio=8 -XX:+PrintGC Demo</code>：打印简单日志</p><ul><li>-XX:+UseSerialGC 表示强制使用Serial+SerialOld收集器组合</li><li>-Xms20m 表示堆空间初始大小为 20 M。</li><li>-Xmx20m 表示堆空间最大大小为 20 M。</li><li>-Xmn10m 表示新生代大小为 10M。</li><li>-XX:SurvivorRatio&#x3D;8 表示Eden:Survivor&#x3D;8:1</li><li>-XX:PrintGC 打印GC日志</li></ul><p>​<img src="/img/jvm_img/GC%E5%8F%82%E6%95%B01.png" alt="回收前-&gt;回收后(可用)"></p><h3 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h3><h4 id="jps指令"><a href="#jps指令" class="headerlink" title="jps指令"></a>jps指令</h4><p>jps（Java Virtual Machine Process Status Tool）：列出所有的 Java 进程</p><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-q</td><td align="center">指定jps只输出进程ID</td></tr><tr><td align="center">-m</td><td align="center">输出传递给Java进程的参数</td></tr><tr><td align="center">-l</td><td align="center">输出主函数的完整路径</td></tr><tr><td align="center">-v</td><td align="center">显示传递给Java虚拟机的参数</td></tr></tbody></table><h4 id="jstat指令"><a href="#jstat指令" class="headerlink" title="jstat指令"></a>jstat指令</h4><p>jstate（Java Virtual Machine Statistics Monitoring Tool）：观察 Java 堆信息的详细情况</p><table><thead><tr><th align="center">参数</th><th align="center">含义</th></tr></thead><tbody><tr><td align="center">-class</td><td align="center">监视类装载、卸载数量、总空间以及类装载所耗费的时间</td></tr><tr><td align="center">-gc</td><td align="center">监视Java堆状况，包括Eden区、两个Survivor区、老年代、永久代等的容量、已用空间、GC时间合计等信息</td></tr><tr><td align="center">-gccapacity</td><td align="center">监视内容与-gc基本相同，但输出主要关注Java堆各个区域使用到的最大、最小空间</td></tr><tr><td align="center">-gcutil</td><td align="center">监视内容与-gc基本相同，但输出主要关注已使用空间占总空间的百分比</td></tr><tr><td align="center">-gccause</td><td align="center">与-gcutil功能一样，但是会额外输出导致上一次GC产生的原因</td></tr><tr><td align="center">-gcnew</td><td align="center">监视新生代GC状况</td></tr><tr><td align="center">-gcnewcapacity</td><td align="center">监视内容与-gcnew基本相同，输出主要关注使用到的最大、最小空间</td></tr><tr><td align="center">-gcold</td><td align="center">监视老年代GC状况</td></tr><tr><td align="center">-gcoldcapacity</td><td align="center">监视内容与-gcold基本相同，输出主要关注使用到的最大、最小空间</td></tr><tr><td align="center">-gcpermcapacity</td><td align="center">输出永久代使用到的最大、最小空间</td></tr><tr><td align="center">-compiler</td><td align="center">输出JIT编译器编译过的方法、耗时信息</td></tr><tr><td align="center">-printcompilation</td><td align="center">输出已经被JIT编译的方法</td></tr></tbody></table><p><strong>实例</strong></p><p><code>jstat -gcutil 2366 </code>：查看java进程2366的堆使用情况</p><h4 id="jinfo指令"><a href="#jinfo指令" class="headerlink" title="jinfo指令"></a>jinfo指令</h4><p>查看正在运行的 Java 应用程序的扩展参数</p><h4 id="jmap-命令"><a href="#jmap-命令" class="headerlink" title="jmap 命令"></a>jmap 命令</h4><p>可以生成 Java 程序的 Dump 文件（当程序产生异常时，用来记录当时的程序状态信息），也可以查看堆内对象实例的统计信息、查看 ClassLoader 的信息以及 finalizer 队列</p><h4 id="jhat-命令"><a href="#jhat-命令" class="headerlink" title="jhat 命令"></a>jhat 命令</h4><p>用于分析 Java 应用的对快照内存，可以用来分析jmap生成dump文件</p><h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><h3 id="1-概念"><a href="#1-概念" class="headerlink" title="1.概念"></a>1.概念</h3><p><strong>jvm分配内存给对象</strong></p><ul><li><strong>指针碰撞</strong>：</li></ul><p>​给对象分配内存都在一边，分配内存就把指针移动对象大小的距离</p><ul><li><strong>空间列表</strong>：</li></ul><p>​类似空间分区表</p><p><strong>内存</strong></p><ul><li><p><strong>内存溢出</strong>（OOM）</p><p>申请的内存超过了可用内存</p></li><li><p><strong>内存泄漏</strong></p><p>内存没有被正确释放</p></li></ul><h3 id="2-对象创建过程"><a href="#2-对象创建过程" class="headerlink" title="2.对象创建过程"></a>2.对象创建过程</h3><p><img src="/img/else_img/%E5%AF%B9%E8%B1%A1%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B.png"></p><h3 id="3-对象内存布局"><a href="#3-对象内存布局" class="headerlink" title="3.对象内存布局"></a>3.对象内存布局</h3><ol><li><p>对象头：</p><ol><li><strong>Mark Word</strong>：哈希码、分代年龄、锁状态标志、线程持有的锁等</li><li>类型指针：指向当前对象是哪个类</li></ol></li><li><p>实例数据：存放字段的信息</p></li><li><p>填充对齐</p></li></ol><h3 id="4-判断对象是否存活"><a href="#4-判断对象是否存活" class="headerlink" title="4.判断对象是否存活"></a>4.判断对象是否存活</h3><ol><li><p>引用计数</p><p>对象中添加引用计数器，记录当前引用的次数。缺陷：循环引用</p></li><li><p><strong>可达性分析</strong></p><p>从GCRoots出发，搜索可以到达的对象并标记，没有标记的对象就是可回收的</p><blockquote><p>主要的GCRoots：</p><p>1.虚拟机栈中引用的对象</p><p>2.类静态属性引用的对象</p><p>3.常量引用的对象</p><p>4.本地方法栈中JNI引用的对象</p></blockquote></li></ol><h3 id="5-引用种类"><a href="#5-引用种类" class="headerlink" title="5.引用种类"></a>5.引用种类</h3><ol><li><p>强引用：一定不会被回收</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br></code></pre></td></tr></table></figure></li><li><p>软引用：内存不足时回收</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-type">ReferenceQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>();<br><span class="hljs-type">SoftReference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>(obj, queue);<br></code></pre></td></tr></table></figure></li><li><p>弱引用：垃圾回收时就会被回收</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-type">ReferenceQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>();<br><span class="hljs-type">WeakReference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>(obj, queue);<br></code></pre></td></tr></table></figure></li><li><p>虚引用：为了能在这个对象 被收集器回收时收到一个系统通知</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-type">ReferenceQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>();<br><span class="hljs-type">PhantomReference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomReference</span>(obj, queue);<br></code></pre></td></tr></table></figure></li></ol><h3 id="6-垃圾回收算法"><a href="#6-垃圾回收算法" class="headerlink" title="6.垃圾回收算法"></a>6.垃圾回收算法</h3><ol><li>标记清除</li><li>标记复制：新生代</li><li>标记整理：老年代</li></ol><h3 id="7-垃圾回收触发时机"><a href="#7-垃圾回收触发时机" class="headerlink" title="7.垃圾回收触发时机"></a>7.垃圾回收触发时机</h3><ol><li>Minor GC（Young GC）：Eden区空间不足时</li><li>Full GC：<ol><li>Minor GC 前判断从年轻代升入老年代的对象可能放不下时</li><li>Minor GC 后发现放不下时</li><li>老年代空间不足时</li><li>晋升&#x2F;提前晋升的对象在老年代中放不下时</li><li>System.gc()</li></ol></li></ol><h3 id="8-晋升老年代时机"><a href="#8-晋升老年代时机" class="headerlink" title="8.晋升老年代时机"></a>8.晋升老年代时机</h3><ol><li>新生代中对象到达一定年龄</li><li>大对象直接晋升</li><li>动态判断对象是否需要晋升</li><li>把MinorGC后仍然放不下的对象放入老年代</li></ol><h3 id="9-主要垃圾收集器种类"><a href="#9-主要垃圾收集器种类" class="headerlink" title="9.主要垃圾收集器种类"></a>9.主要垃圾收集器种类</h3><ol><li>Serial收集器（串行收集器）：一个线程垃圾回收，所有用户线程需要停下，新生代标记复制，老年代标记整理</li><li>ParNew：多个Serial收集器，新生代并发，老年代还是单线程</li><li>Parallel Scavenge（并行收集器）：注重吞吐量（运行用户代码的时长），老年代也并发</li><li>CMS（Concurrent Mark Sweep）收集器（并发收集器）：老年代收集器，以最短停顿时间为目标，<strong>并发收集、低停顿</strong></li><li>G1（Garbage First）收集器（并发收集器）：弱化分代，而是分区收集（伊甸区、辛存区、老年区、大对象区），<strong>解决内存碎片问题</strong></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>RabbitMQ</title>
    <link href="/2023/02/15/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/"/>
    <url>/2023/02/15/%E4%B8%AD%E9%97%B4%E4%BB%B6/RabbitMQ/</url>
    
    <content type="html"><![CDATA[<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><blockquote><p>RabbitMQ是一个被广泛使用的开源消息队列。它是轻量级且易于部署的，它能支持多种消息协议。RabbitMQ可以部署在分布式和联合配置中，以满足高规模、高可用性的需求。</p></blockquote><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><ol><li><p>首先需要安装Erlang环境</p><ul><li><p>Erlang版本和RabbitMQ版本对照：<a href="https://www.rabbitmq.com/which-erlang.html">RabbitMQ Erlang Version Requirements — RabbitMQ</a></p></li><li><p>下载：<a href="https://www.erlang.org/downloads">Downloads - Erlang&#x2F;OTP</a> 选择安装路径后一路next</p></li></ul></li><li><p>安装RabbitMQ</p><ul><li><p>下载：<a href="https://www.rabbitmq.com/download.html">Downloading and Installing RabbitMQ — RabbitMQ</a> 选择安装路径后一路next</p></li><li><p>下载完进入sbin目录，cmd窗口输入</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_management<br></code></pre></td></tr></table></figure><p>下载插件</p></li><li><p>点击sbin目录下的rabbitmq-service.bat启动</p></li><li><p>访问：<a href="http://localhost:15672/">http://localhost:15672</a> 打开控制面板，默认账户：guest，默认密码：guest</p></li></ul></li></ol><h4 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h4><p>见微服务&#x2F;消息队列</p><h3 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h3><p>详细见微服务&#x2F;消息队列</p><h3 id="SpringBoot整合RabbitMQ"><a href="#SpringBoot整合RabbitMQ" class="headerlink" title="SpringBoot整合RabbitMQ"></a>SpringBoot整合RabbitMQ</h3><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>功能：下订单时发送一条消息到延时队列中，若超时未付款则转发消息到真正取消订单的消息队列中</p><ol start="0"><li><p>在RabbitMQ的控制面板创建用户，账号密码为mall，创建虚拟目录&#x2F;mall，给mall用户&#x2F;mall的所有权限</p></li><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--AMQP--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br><span class="hljs-attr">rabbitmq:</span><br>        <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span> <span class="hljs-comment"># rabbitmq的连接地址</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span> <span class="hljs-comment"># rabbitmq的连接端口号</span><br>        <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/mall</span> <span class="hljs-comment"># rabbitmq的虚拟host</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">mall</span> <span class="hljs-comment"># rabbitmq的用户名</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-string">mall</span> <span class="hljs-comment"># rabbitmq的密码</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置类，用于创建交换机和队列</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.dto;<br><br><span class="hljs-meta">@Getter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">QueueEnum</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消息通知队列</span><br><span class="hljs-comment">     */</span><br>    QUEUE_ORDER_CANCEL(<span class="hljs-string">&quot;mall.order.direct&quot;</span>, <span class="hljs-string">&quot;mall.order.cancel&quot;</span>, <span class="hljs-string">&quot;mall.order.cancel&quot;</span>),<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 消息通知ttl队列</span><br><span class="hljs-comment">     */</span><br>    QUEUE_TTL_ORDER_CANCEL(<span class="hljs-string">&quot;mall.order.direct.ttl&quot;</span>, <span class="hljs-string">&quot;mall.order.cancel.ttl&quot;</span>, <span class="hljs-string">&quot;mall.order.cancel.ttl&quot;</span>);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String exchange;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 队列名称</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 路由键</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String routeKey;<br><br>    QueueEnum(String exchange, String name, String routeKey) &#123;<br>        <span class="hljs-built_in">this</span>.exchange = exchange;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.routeKey = routeKey;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.config;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 定义交换机和消息队列</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMqConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  订单消息实际消费队列所绑定的交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">orderDirect</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (DirectExchange) ExchangeBuilder<br>            .directExchange(QueueEnum.QUEUE_ORDER_CANCEL.getExchange()) <span class="hljs-comment">// 定向交换机，设定名称</span><br>            .durable(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 是否持久化</span><br>            .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单延迟队列队列所绑定的交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">orderTTLDirect</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (DirectExchange) ExchangeBuilder<br>            .directExchange(QueueEnum.QUEUE_TTL_ORDER_CANCEL.getExchange()) <span class="hljs-comment">// 定向交换机，设定名称</span><br>            .durable(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 是否持久化</span><br>            .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单实际消费队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">orderQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(QueueEnum.QUEUE_ORDER_CANCEL.getName());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 订单延迟队列（死信队列）</span><br><span class="hljs-comment">     * 当订单超时后被转发到订单队列</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">orderTTLQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> QueueBuilder<br>            .durable(QueueEnum.QUEUE_TTL_ORDER_CANCEL.getName())<br>            .withArgument(<span class="hljs-string">&quot;x-dead-letter-exchange&quot;</span>, QueueEnum.QUEUE_ORDER_CANCEL.getExchange())<span class="hljs-comment">//到期后转发的交换机</span><br>            .withArgument(<span class="hljs-string">&quot;x-dead-letter-routing-key&quot;</span>, QueueEnum.QUEUE_ORDER_CANCEL.getRouteKey())<span class="hljs-comment">//到期后转发的路由键</span><br>            .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将订单队列绑定到交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">orderBinding</span><span class="hljs-params">(DirectExchange orderDirect, Queue orderQueue)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder<br>            .bind(orderQueue)<br>            .to(orderDirect)<br>            .with(QueueEnum.QUEUE_ORDER_CANCEL.getRouteKey());<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将订单延迟队列绑定到交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    Binding <span class="hljs-title function_">orderTtlBinding</span><span class="hljs-params">(DirectExchange orderTTLDirect,Queue orderTTLQueue)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder<br>            .bind(orderTTLQueue)<br>            .to(orderTTLDirect)<br>            .with(QueueEnum.QUEUE_TTL_ORDER_CANCEL.getRouteKey());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>编写消息的生产者和消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 取消订单消息生产者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CancelOrderSender</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AmqpTemplate amqpTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(Long orderId, <span class="hljs-keyword">final</span> Long delayTime)</span> &#123;<br>        <span class="hljs-comment">// 消息处理器，设置超时时间</span><br>        <span class="hljs-type">MessagePostProcessor</span> <span class="hljs-variable">messagePostProcessor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagePostProcessor</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException &#123;<br>                message.getMessageProperties().setExpiration(String.valueOf(delayTime));<br>                <span class="hljs-keyword">return</span> message;<br>            &#125;<br>        &#125;;<br>        <span class="hljs-comment">// 发送消息</span><br>        amqpTemplate.convertAndSend(QueueEnum.QUEUE_TTL_ORDER_CANCEL.getExchange(), <span class="hljs-comment">// 发送到的交换机</span><br>                QueueEnum.QUEUE_TTL_ORDER_CANCEL.getRouteKey(), <span class="hljs-comment">// 路由Key</span><br>                orderId,    <span class="hljs-comment">// 消息</span><br>                messagePostProcessor    <span class="hljs-comment">// 消息处理器</span><br>        );<br>        log.info(<span class="hljs-string">&quot;订单id:&#123;&#125;&quot;</span>, orderId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 取消订单消息消费者</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CancelOrderReceiver</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OmsPortalOrderService omsPortalOrderService;<br><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;mall.order.cancel&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(Long orderId)</span> &#123;<br>        omsPortalOrderService.cancelOrder(orderId);<br>        log.info(<span class="hljs-string">&quot;处理取消订单消息的id:&#123;&#125;&quot;</span>, orderId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>service层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OmsPortalOrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OmsPortalOrderService</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> CancelOrderSender cancelOrderSender;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">generateOrder</span><span class="hljs-params">(OrderParam orderParam)</span> &#123;<br>        <span class="hljs-comment">// 下单操作，生成订单和订单id</span><br>        log.info(<span class="hljs-string">&quot;下单操作....&quot;</span>);<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-number">10L</span>;<br>        <span class="hljs-comment">// 下完单后发送一个延迟消息，若期间没有付款则取消订单</span><br>        sendDelayMessageCancelOrder(orderId);<br>        <span class="hljs-keyword">return</span> CommonResult.success(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;下单成功&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(Long orderId)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;取消订单，id:&#123;&#125;&quot;</span>, orderId);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendDelayMessageCancelOrder</span><span class="hljs-params">(Long orderId)</span> &#123;<br>        <span class="hljs-comment">// 30秒</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">delayTimes</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span> * <span class="hljs-number">1000L</span>;<br>        cancelOrderSender.sendMessage(orderId, delayTimes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>controller层</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(tags = &quot;订单管理&quot;)</span><br><span class="hljs-meta">@RestController(&quot;/order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OmsPortalOrderController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OmsPortalOrderService omsPortalOrderService;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;根据购物车信息生成订单&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/generateOrder&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">generateOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderParam orderParam)</span> &#123;<br>        <span class="hljs-keyword">return</span> omsPortalOrderService.generateOrder(orderParam);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>中间件</category>
      
      <category>RabbitMQ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MongoDB</title>
    <link href="/2023/02/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/Mongodb/"/>
    <url>/2023/02/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/Mongodb/</url>
    
    <content type="html"><![CDATA[<h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><blockquote><p>MongoDB 是由C++语言编写的，是一个基于分布式文件存储的开源数据库系统。</p><p>在高负载的情况下，添加更多的节点，可以保证服务器性能。</p><p>MongoDB 旨在为WEB应用提供可扩展的高性能数据存储解决方案。</p><p>MongoDB 将数据存储为一个文档，数据结构由键值(key&#x3D;&gt;value)对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p><p>Mongo是一种NoSql数据库，：</p><p>1.对数据库高并发读写。</p><p>2、对海量数据的高效率存储和访问。</p><p>3、对数据库的高可扩展性和高可用性</p></blockquote><p> <a href="https://spring.io/projects/spring-data-mongodb#learn">官方文档</a></p><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p><strong>适用场景</strong></p><p>1、网站数据：Mongo非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。</p><p>2、缓存：由于性能很高，Mongo也适合作为信息基础设施的缓存层。在系统重启之后，由M ongo搭建的持久化缓存层可以避免下层的数据源过载。</p><p>3、大尺寸，低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵， 在此之前，很多时候程序员往往会选择传统的文件进行存储。</p><p>4、高伸缩性的场景：Mongo非常适合由数十或数百台服务器组成的数据库。Mongo的路线图中已经包含对Map Reduce弓摩的内置支持。</p><p>5、用于对象及 JSON数据的存储：Mongo的BSON数据格式非常适合文档化格式的存储 及查询。</p><p><strong>不适用场合</strong></p><p>1、高度事务性的系统：例如银行或会计系统。传统的关系型数据库目前还是更适用于需要大量原子性复杂事务的应用程序。</p><p>2、传统的商业智能应用：针对特定问题的BI数据库会对产生高度优化的查询方式。对于此类应用，数据仓库可能是更合适的选择。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><ol><li><p>下载mongodb</p><ul><li><a href="https://www.mongodb.com/try/download/community">官网下载</a> 选择msi</li><li>进入引导界面，选择Custom自定义安装路径</li><li>之后会默认让安装compass可视化工具，可以不下载之后下第三方的</li><li>一路next</li></ul></li><li><p>安装为服务</p><ul><li>通过msi下载的mongdb会自动生成data和log目录</li></ul><p><img src="/img/mongodb_img/%E7%9B%AE%E5%BD%951.png"></p><ul><li><p>还会在bin目录下自动生成mongod.cfg配置文件，里面写了data和log目录的位置</p><p><img src="/img/mongodb_img/%E7%9B%AE%E5%BD%952.png"></p></li><li><p>进入bin目录，执行以下代码，将mongodb注册为服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">报错可能是没有用管理员权限，或者mongod.cfg要输入全路径名</span><br>mongod --config mongod.cfg --install --serviceName &quot;MongoDB&quot; --journal<br></code></pre></td></tr></table></figure></li><li><p>服务相关命令（管理员身份运行）</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dos">启动服务：<span class="hljs-built_in">net</span> <span class="hljs-built_in">start</span> MongoDB<br>关闭服务：<span class="hljs-built_in">net</span> stop MongoDB<br>移除服务（bin目录下）：mongod.exe --remove<br></code></pre></td></tr></table></figure></li></ul></li><li><p>下载可视化工具</p><p><a href="https://studio3t.com/download-studio3t-free">Download Studio 3T for MongoDB | Windows, macOS &amp; Linux</a></p><ul><li>下载完解压，再安装</li><li>测试连接localhost:27017</li></ul></li></ol><h4 id="通过docker安装"><a href="#通过docker安装" class="headerlink" title="通过docker安装"></a>通过docker安装</h4><ul><li><p>拉取镜像</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">docker</span> pull mongo:latest<br></code></pre></td></tr></table></figure></li><li><p>创建和启动容器</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run -d --restart=always -p <span class="hljs-number">27017</span>:<span class="hljs-number">27017</span> --name mymongo -v <span class="hljs-regexp">/data/</span>db:<span class="hljs-regexp">/data/</span>db -d mongo<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 进入容器</span><br>docker exec -it mymongo <span class="hljs-regexp">/bin/</span>bash<br><span class="hljs-comment"># 使用mongoDB客户端进行操作</span><br>mongo<br><span class="hljs-comment"># 查询所有数据库</span><br>show dbs<br></code></pre></td></tr></table></figure></li></ul><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><table><thead><tr><th>SQL术语&#x2F;概念</th><th>MongoDB术语&#x2F;概念</th><th>解释&#x2F;说明</th></tr></thead><tbody><tr><td>database</td><td>database</td><td>数据库</td></tr><tr><td>table</td><td><strong>collection</strong></td><td>数据库表&#x2F;集合</td></tr><tr><td>row</td><td><strong>document</strong></td><td>数据记录行&#x2F;文档</td></tr><tr><td>column</td><td>field</td><td>数据字段&#x2F;域</td></tr><tr><td>index</td><td>index</td><td>索引</td></tr><tr><td>table joins</td><td></td><td>表连接,MongoDB不支持</td></tr><tr><td>primary key</td><td>primary key</td><td>主键,MongoDB自动将_id字段设置为主键</td></tr></tbody></table><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">在mongoDB客户端下进行操作</span><br><br>1、 Help查看命令提示 <br>db.help();<br><br>2、 切换/创建数据库<br>use test<br>如果数据库不存在，则创建数据库，否则切换到指定数据库<br><br>3、 查询所有数据库 <br>show dbs;<br><br>4、 删除当前使用数据库 <br>db.dropDatabase();<br><br>5、 查看当前使用的数据库 <br>db.getName();<br><br>6、 显示当前db状态 <br>db.stats();<br><br>7、 当前db版本 <br>db.version();<br><br>8、 查看当前db的链接机器地址 <br>db.getMongo();<br></code></pre></td></tr></table></figure><p><strong>集合</strong></p><blockquote><p>对应关系型数据库中的表</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">1、 创建一个集合（table)<br>db.createCollection(&quot;collName&quot;);<br>2、 得到指定名称的集合（table )<br>db.getCollection(&quot;user&quot;);<br></code></pre></td></tr></table></figure><p><strong>记录</strong></p><blockquote><p>对应关系型数据库中的字段</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">插入数据</span> <br><span class="hljs-meta prompt_"># </span><span class="language-bash">db.集合名.方法</span><br>db.User.insertOne(&#123;name:&#x27;zhangsan&#x27;,age:21,sex:true&#125;)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查询数据</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查询所有</span><br>db.User.find()<br><span class="hljs-meta prompt_"># </span><span class="language-bash">条件查询</span><br>db.User.find(&#123;name:&#x27;zs&#x27;&#125;)<br>db.User.find(&#123;_id: ObjectId(&#x27;658bcb39e98bb66dcf831af9&#x27;)&#125;) # 根据_id查要加个ObjectId()<br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定字段，后面的&#123;&#125;中0表示该列返回空，1表示返回该列的值，不写的列不会返回</span><br>db.User.find(&#123;age: 21&#125;, &#123;_id: 0, name: 1,age: 1&#125;);<br><span class="hljs-meta prompt_"># </span><span class="language-bash">排序，1表示正序，-1表示逆序</span><br>db.User.find().sort(&#123;age:1&#125;)<br><span class="hljs-meta prompt_"># </span><span class="language-bash">分页查询</span><br>db.User.find().skip(0).limit(3)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新数据</span>    <br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新单条数据</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">第一个参数为条件，第二个参数为操作</span><br>db.testCollection.updateOne(&#123;_id: ObjectId(&quot;658bcb39e98bb66dcf831af9&quot;)&#125;, &#123;$set: &#123;age: 26&#125;&#125;)<br>db.testCollection.updateOne(<br>   &#123; name: &quot;Alice&quot; &#125;,  // 更新条件<br>   &#123; $inc: &#123; age: 1 &#125; &#125;  // 对age字段进行增量更新<br>)<br>db.testCollection.updateOne(<br>   &#123; name: &quot;Bob&quot; &#125;,  // 更新条件<br>   &#123; $push: &#123; hobbies: &quot;hiking&quot; &#125; &#125;  // 向hobbies数组字段中添加&quot;hiking&quot;元素<br>)<br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新所有符合条件的数据</span><br>db.testCollection.updateMany(&#123;sex: true&#125;, &#123;$set: &#123;sex: false&#125;&#125;)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除数据</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除单条</span><br>db.testCollection.deleteOne(&#123; name: &quot;Alice&quot; &#125;)<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除所有符合条件的</span><br>db.testCollection.deleteMany(&#123; age: &#123; $lt: 30 &#125; &#125;)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">索引</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建索引</span><br>db.testCollection.createIndex(&#123;age: 1&#125;, &#123;name: &#x27;age_idx&#x27;&#125;)<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看所有索引</span><br>db.testCollection.getIndexes()<br><span class="hljs-meta prompt_"># </span><span class="language-bash">删除索引</span><br>db.testCollection.dropIndex(&quot;age_idx&quot;)<br><br></code></pre></td></tr></table></figure><h3 id="SpringBoot-整合MongoDB"><a href="#SpringBoot-整合MongoDB" class="headerlink" title="SpringBoot 整合MongoDB"></a>SpringBoot 整合MongoDB</h3><blockquote><p>spring-data-mongodb提供了MongoTemplate与MongoRepository两种方式访问mongodb，MongoRepository操作简单，MongoTemplate操作灵活，可以灵活适用这两种方式操作mongodb，MongoRepository的缺点是不够灵活，MongoTemplate正好可以弥补不足。</p></blockquote><h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Document</td><td>标示映射到Mongodb文档上的领域对象</td></tr><tr><td>@Id</td><td>将相应字段设置为主键</td></tr><tr><td>@Indexed</td><td>标示某个字段为Mongodb的索引字段，提高该字段的检索速度</td></tr><tr><td>@Query</td><td>可以用Mongodb的JSON查询语句进行查询</td></tr></tbody></table><h4 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h4><h5 id="MongoTemplate"><a href="#MongoTemplate" class="headerlink" title="MongoTemplate"></a>MongoTemplate</h5><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">data:</span><br><span class="hljs-comment"># 连接地址 端口号 连接的数据库</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://127.0.0.1:27017/mall-port</span><br></code></pre></td></tr></table></figure></li><li><p>添加实体类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document(&quot;User&quot;)</span>   <span class="hljs-comment">//对应MongoDb中的表名</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> String id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> String createDate;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试使用</p><p>插入、查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoMongoDBApplicationTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MongoTemplate mongoTemplate;<br><br>    <span class="hljs-comment">// insert 插入数据</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setAge(<span class="hljs-number">20</span>);<br>        user.setName(<span class="hljs-string">&quot;test&quot;</span>);<br>        user.setEmail(<span class="hljs-string">&quot;111@qq.com&quot;</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mongoTemplate.insert(user);<br>        System.out.println(user1);<br>    &#125;<br><br>    <span class="hljs-comment">// findAll 查询所有数据</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        List&lt;User&gt; all = mongoTemplate.findAll(User.class);<br>        System.out.println(all);<br>    &#125;<br><br>    <span class="hljs-comment">// findById 通过id查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findById</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mongoTemplate.findById(<span class="hljs-string">&quot;634c047f1bda8149e63ff1ee&quot;</span>, User.class);<br>        System.out.println(user);<br>    &#125;<br><br>    <span class="hljs-comment">// 条件查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findUserList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 构建条件</span><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria<br>                .where(<span class="hljs-string">&quot;name&quot;</span>).is(<span class="hljs-string">&quot;test&quot;</span>)<br>                .and(<span class="hljs-string">&quot;age&quot;</span>).is(<span class="hljs-number">20</span>));<br>        List&lt;User&gt; userList = mongoTemplate.find(query, User.class);<br>        System.out.println(userList);<br>    &#125;<br><br>    <span class="hljs-comment">// 模糊条件查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findLikeUserList</span><span class="hljs-params">()</span> &#123;<br><br>        <span class="hljs-comment">// 构建正则</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;est&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s%s%s&quot;</span>, <span class="hljs-string">&quot;.*&quot;</span>, name, <span class="hljs-string">&quot;*$&quot;</span>);<br>        <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> Pattern.compile(regex, Pattern.CASE_INSENSITIVE);<br>        <span class="hljs-comment">// 构建条件</span><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria<br>                .where(<span class="hljs-string">&quot;name&quot;</span>).regex(pattern));<br>        List&lt;User&gt; userList = mongoTemplate.find(query, User.class);<br>        System.out.println(userList);<br>    &#125;<br><br>    <span class="hljs-comment">// 分页查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findPageUserList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>        <span class="hljs-comment">// 构建正则</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;est&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">regex</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;%s%s%s&quot;</span>, <span class="hljs-string">&quot;.*&quot;</span>, name, <span class="hljs-string">&quot;*$&quot;</span>);<br>        <span class="hljs-type">Pattern</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> Pattern.compile(regex, Pattern.CASE_INSENSITIVE);<br>        <span class="hljs-comment">// 构建条件</span><br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria<br>                .where(<span class="hljs-string">&quot;name&quot;</span>).regex(pattern));<br><br>        <span class="hljs-comment">// 分页构建</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> mongoTemplate.count(query, User.class);    <span class="hljs-comment">//记录数</span><br>        <span class="hljs-comment">// skip(当前页的开始下标).limit(查询页数)</span><br>        List&lt;User&gt; userList = mongoTemplate.find(query.skip((current - <span class="hljs-number">1</span>) * size).limit(size), User.class);<br>        System.out.println(<span class="hljs-string">&quot;总记录数:&quot;</span> + count);<br>        System.out.println(userList);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>修改、删除</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 修改</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mongoTemplate.findById(<span class="hljs-string">&quot;634c047f1bda8149e63ff1ee&quot;</span>, User.class);<br>    user.setName(<span class="hljs-string">&quot;asdasdasd&quot;</span>);<br><br>    <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;_id&quot;</span>).is(user.getId()));<br>    <span class="hljs-type">Update</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Update</span>();<br>    update.set(<span class="hljs-string">&quot;name&quot;</span>, user.getName());<br>    update.set(<span class="hljs-string">&quot;age&quot;</span>, user.getAge());<br>    update.set(<span class="hljs-string">&quot;email&quot;</span>, user.getEmail());<br><br>    <span class="hljs-comment">// 通过查询条件查询出数据，更新的属性</span><br>    <span class="hljs-type">UpdateResult</span> <span class="hljs-variable">upsert</span> <span class="hljs-operator">=</span> mongoTemplate.upsert(query, update, User.class);<br>    <span class="hljs-comment">// 改变的条数</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">modifiedCount</span> <span class="hljs-operator">=</span> upsert.getModifiedCount();<br>    System.out.println(modifiedCount);<br>&#125;<br><br><span class="hljs-comment">// 删除</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Query</span>(Criteria.where(<span class="hljs-string">&quot;_id&quot;</span>).is(<span class="hljs-string">&quot;634c047f1bda8149e63ff1ee&quot;</span>));<br><br>    <span class="hljs-type">DeleteResult</span> <span class="hljs-variable">remove</span> <span class="hljs-operator">=</span> mongoTemplate.remove(query, User.class);<br>    <span class="hljs-type">long</span> <span class="hljs-variable">deletedCount</span> <span class="hljs-operator">=</span> remove.getDeletedCount();<br>    System.out.println(deletedCount);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h5 id="MongoRepository"><a href="#MongoRepository" class="headerlink" title="MongoRepository"></a>MongoRepository</h5><ul><li><p>添加Repository类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MongoRepository</span>&lt;User, String&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>CRUD</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoMongoDBApplicationTest1</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserRepository userRepository;<br><br>    <span class="hljs-comment">// save 插入数据</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setAge(<span class="hljs-number">20</span>);<br>        user.setName(<span class="hljs-string">&quot;张三&quot;</span>);<br>        user.setEmail(<span class="hljs-string">&quot;3332200@qq.com&quot;</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> userRepository.save(user);<br>    &#125;<br><br>    <span class="hljs-comment">// findAll 查询所有数据</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        List&lt;User&gt; all = userRepository.findAll();<br>        System.out.println(all);<br>    &#125;<br><br>    <span class="hljs-comment">// findById 通过id查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findById</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(<span class="hljs-string">&quot;634c06471bda8149e63ff1ef&quot;</span>).get();<br>        System.out.println(user);<br>    &#125;<br><br>    <span class="hljs-comment">// 条件查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findUserList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 构造查询条件</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setAge(<span class="hljs-number">20</span>);<br>        Example&lt;User&gt; userExample = Example.of(user);<br><br>        List&lt;User&gt; users = userRepository.findAll(userExample);<br>        System.out.println(users);<br>    &#125;<br><br>    <span class="hljs-comment">// 模糊条件查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findLikeUserList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//创建匹配器，即如何使用查询条件</span><br>        <span class="hljs-type">ExampleMatcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> ExampleMatcher.matching() <span class="hljs-comment">//构建对象</span><br>                .withStringMatcher(ExampleMatcher.StringMatcher.CONTAINING) <span class="hljs-comment">//改变默认字符串匹配方式：模糊查询</span><br>                .withIgnoreCase(<span class="hljs-literal">true</span>); <span class="hljs-comment">//改变默认大小写忽略方式：忽略大小写</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        user.setName(<span class="hljs-string">&quot;三&quot;</span>);<br>        Example&lt;User&gt; userExample = Example.of(user, matcher);<br>        List&lt;User&gt; userList = userRepository.findAll(userExample);<br>        System.out.println(userList);<br>    &#125;<br><br>    <span class="hljs-comment">// 分页查询</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findPageUserList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Pageable</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);<br><br>        Page&lt;User&gt; pages = userRepository.findAll(page);<br>        System.out.println(pages);<br>    &#125;<br><br>    <span class="hljs-comment">// 修改</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRepository.findById(<span class="hljs-string">&quot;635fc9b4d74a3c02b054754a&quot;</span>).get();<br>        user.setName(<span class="hljs-string">&quot;王五&quot;</span>);<br>        userRepository.save(user);  <span class="hljs-comment">// 有相同id时为修改</span><br>    &#125;<br><br>    <span class="hljs-comment">// 删除</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">()</span> &#123;<br>        userRepository.deleteById(<span class="hljs-string">&quot;635fc9b4d74a3c02b054754a&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><p>springBoot 版本2.7.8</p><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Spring Data MongoDB--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br><span class="hljs-attr">data:</span><br>    <span class="hljs-attr">mongodb:</span><br>      <span class="hljs-comment"># 连接地址 端口号 连接的数据库</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">mongodb://127.0.0.1:27017/mall-port</span><br></code></pre></td></tr></table></figure></li><li><p>编写映射到mongodb的文档对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户商品浏览历史记录</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Document</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemberReadHistory</span> &#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-meta">@Indexed</span><br>    <span class="hljs-keyword">private</span> Long memberId;<br><br>    <span class="hljs-keyword">private</span> String memberNickname;<br><br>    <span class="hljs-keyword">private</span> String memberIcon;<br><br>    <span class="hljs-meta">@Indexed</span><br>    <span class="hljs-keyword">private</span> Long productId;<br><br>    <span class="hljs-keyword">private</span> String productName;<br><br>    <span class="hljs-keyword">private</span> String productPic;<br><br>    <span class="hljs-keyword">private</span> String productSubTitle;<br><br>    <span class="hljs-keyword">private</span> String productPrice;<br><br>    <span class="hljs-keyword">private</span> Date createTime;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写操作类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MemberReadHistoryRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MongoRepository</span>&lt;MemberReadHistory, String&gt; &#123;<br>    List&lt;MemberReadHistory&gt; findBy<span class="hljs-title function_">MemberIdOrderByCreateTimeDesc</span><span class="hljs-params">(Long memberId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写Service接口、实现接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemberReadHistoryServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MemberReadHistoryService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> MemberReadHistoryRepository memberReadHistoryRepository;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">create</span><span class="hljs-params">(MemberReadHistory memberReadHistory)</span> &#123;<br>        memberReadHistory.setId(<span class="hljs-literal">null</span>);<br>        memberReadHistory.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        memberReadHistoryRepository.save(memberReadHistory);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(List&lt;String&gt; ids)</span> &#123;<br>        List&lt;MemberReadHistory&gt; deleteList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span>(String id : ids)&#123;<br>            <span class="hljs-type">MemberReadHistory</span> <span class="hljs-variable">memberReadHistory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemberReadHistory</span>();<br>            memberReadHistory.setId(id);<br>            deleteList.add(memberReadHistory);<br>        &#125;<br>        memberReadHistoryRepository.deleteAll(deleteList);<br>        <span class="hljs-keyword">return</span> ids.size();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;MemberReadHistory&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Long memberId)</span> &#123;<br>        <span class="hljs-keyword">return</span> memberReadHistoryRepository.findByMemberIdOrderByCreateTimeDesc(memberId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写Controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Api(tags = &quot;会员商品浏览记录管理&quot;)</span><br><span class="hljs-meta">@RestController(&quot;/member/readHistory&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemberReadHistoryController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> MemberReadHistoryService memberReadHistoryService;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;创建浏览记录&quot;)</span><br>    <span class="hljs-meta">@PostMapping(&quot;/create&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> MemberReadHistory memberReadHistory)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> memberReadHistoryService.create(memberReadHistory);<br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> CommonResult.success(count);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> CommonResult.failed();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;删除浏览记录&quot;)</span><br>    <span class="hljs-meta">@PostMapping(value = &quot;/delete&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;ids&quot;)</span> List&lt;String&gt; ids)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> memberReadHistoryService.delete(ids);<br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> CommonResult.success(count);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> CommonResult.failed();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@ApiOperation(&quot;展示浏览记录&quot;)</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> CommonResult&lt;List&lt;MemberReadHistory&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Long memberId)</span> &#123;<br>        List&lt;MemberReadHistory&gt; memberReadHistoryList = memberReadHistoryService.list(memberId);<br>        <span class="hljs-keyword">return</span> CommonResult.success(memberReadHistoryList);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>测试</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>中间件</category>
      
      <category>MongoDB</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Elasticsearch</title>
    <link href="/2023/02/09/%E4%B8%AD%E9%97%B4%E4%BB%B6/Elasticsearch/"/>
    <url>/2023/02/09/%E4%B8%AD%E9%97%B4%E4%BB%B6/Elasticsearch/</url>
    
    <content type="html"><![CDATA[<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><p>Elasticsearch 是一个分布式、可扩展、实时的搜索与数据分析引擎</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="windows安装"><a href="#windows安装" class="headerlink" title="windows安装"></a>windows安装</h4><ol><li><p>官网下载Elasticsearch</p><p><a href="https://www.elastic.co/cn/downloads/past-releases/#elasticsearch">Past Releases of Elastic Stack Software | Elastic</a></p></li><li><p>官网下载kibana(es客户端，版本要和es一致)</p><p><a href="https://www.elastic.co/cn/downloads/past-releases/#kibana">Past Releases of Elastic Stack Software | Elastic</a></p></li><li><p>安装中文分词插件，在es的bin目录下执行以下命令（版本要和es一致）：elasticsearch-plugin install <a href="https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip">https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.2.2/elasticsearch-analysis-ik-6.2.2.zip</a></p></li><li><p>到es和kibana的bin目录下，点击运行elasticsearch.bat和kibana.bat</p></li><li><p>访问<code>localhost:5601</code>打开kibana界面，点击<code>dev tools</code>来输入es的命令</p></li></ol><h4 id="Linux安装"><a href="#Linux安装" class="headerlink" title="Linux安装"></a>Linux安装</h4><p>见微服务笔记的分布式搜索(1)</p><h3 id="Spring-Data-Elasticsearch"><a href="#Spring-Data-Elasticsearch" class="headerlink" title="Spring Data Elasticsearch"></a>Spring Data Elasticsearch</h3><p>是Spring提供的一种以Spring Data风格来操作数据存储的方式，它可以避免编写大量的样板代码</p><p><a href="https://spring.io/projects/spring-data-elasticsearch#learn">官方文档</a></p><p><strong>实例</strong></p><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--注意这里elasticsearch.version版本一定!!!要和elasticsearch的版本一致--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">elasticsearch.version</span>&gt;</span>7.17.3<span class="hljs-tag">&lt;/<span class="hljs-name">elasticsearch.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--Spring Data Elasticsearch--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># yml配置elasticsearch客户端地址（可配置项有限）</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">elasticsearch:</span><br>    <span class="hljs-attr">uris:</span> <span class="hljs-string">http://127.0.0.1:9200</span> <span class="hljs-comment"># elasticsearch 连接地址</span><br>    <span class="hljs-comment">#username: elastic # 用户名</span><br>    <span class="hljs-comment">#password: 123456 # 密码</span><br>    <span class="hljs-attr">connection-timeout:</span> <span class="hljs-string">10s</span> <span class="hljs-comment"># 连接超时时间（默认1s）</span><br>    <span class="hljs-attr">socket-timeout:</span> <span class="hljs-string">30s</span> <span class="hljs-comment"># 数据读取超时时间（默认30s）</span><br></code></pre></td></tr></table></figure></li><li><p>编写保存到es中的实体</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Document(indexName = &quot;user&quot;)</span><span class="hljs-comment">// 索引名</span><br><span class="hljs-meta">@Setting(shards = 3, replicas = 0)</span><span class="hljs-comment">// 刷新时间和分片数</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-meta">@Field(type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = &quot;ik_max_word&quot;)</span><br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(Integer id, String name, Integer age, String address)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>        <span class="hljs-built_in">this</span>.address = address;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写操作类(类似mysql的mapper)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;User, Integer&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> UserRepository repository;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-number">18</span>, <span class="hljs-string">&quot;上海市闵行区&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">save</span> <span class="hljs-operator">=</span> repository.save(user);<br><br>    Optional&lt;User&gt; optionalUser = repository.findById(<span class="hljs-number">1</span>);<br>    System.out.println(optionalUser.get());<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><table><thead><tr><th>注解</th><th>作用</th></tr></thead><tbody><tr><td>@Document</td><td>标示映射到Elasticsearch文档上的领域对象</td></tr><tr><td>@Id</td><td>表示是文档的id，文档可以认为是mysql中表行的概念</td></tr><tr><td>@Field</td><td>设置字段类型、是否倒排索引等信息</td></tr><tr><td>@Query</td><td>可以直接写DSL语句</td></tr><tr><td>@Setting</td><td>分片数、刷新时间等参数不再在<code>@Docement</code>中声明，而是在@Setting中声明</td></tr></tbody></table><p><strong>@Field</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Field &#123;<br>  <span class="hljs-comment">//文档中字段的类型</span><br>FieldType <span class="hljs-title function_">type</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> FieldType.Auto;<br>  <span class="hljs-comment">//是否建立倒排索引</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">index</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">true</span>;<br>  <span class="hljs-comment">//是否进行存储</span><br><span class="hljs-type">boolean</span> <span class="hljs-title function_">store</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br>  <span class="hljs-comment">//分词器名次</span><br>String <span class="hljs-title function_">analyzer</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">//为文档自动指定元数据类型</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FieldType</span> &#123;<br>Text,<span class="hljs-comment">//会进行分词并建了索引的字符类型</span><br>Integer,<br>Long,<br>Date,<br>Float,<br>Double,<br>Boolean,<br>Object,<br>Auto,<span class="hljs-comment">//自动判断字段类型</span><br>Nested,<span class="hljs-comment">//嵌套对象类型</span><br>Ip,<br>Attachment,<br>Keyword<span class="hljs-comment">//不会进行分词建立索引的类型</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>@Query</strong></p><p>可以直接写DSL语句</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Query(&quot;&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?0&quot;&#125;&#125;&#125;&#125;&quot;)</span><br>Page&lt;EsProduct&gt; <span class="hljs-title function_">findByName</span><span class="hljs-params">(String name,Pageable pageable)</span>;<br></code></pre></td></tr></table></figure><h4 id="方法生成机制"><a href="#方法生成机制" class="headerlink" title="方法生成机制"></a>方法生成机制</h4><p>对于操作类接口方法的命名，根据规则可以自动实现</p><table><thead><tr><th align="left">关键词</th><th align="left">示例</th><th align="left">对应es搜索查询字符串</th></tr></thead><tbody><tr><td align="left"><code>And</code></td><td align="left"><code>findByNameAndPrice</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125; &#125;, &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;price&quot; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Or</code></td><td align="left"><code>findByNameOrPrice</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;should&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125; &#125;, &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;price&quot; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Is</code></td><td align="left"><code>findByName</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Not</code></td><td align="left"><code>findByNameNot</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must_not&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Between</code></td><td align="left"><code>findByPriceBetween</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?, &quot;to&quot; : ?, &quot;include_lower&quot; : true, &quot;include_upper&quot; : true &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>LessThan</code></td><td align="left"><code>findByPriceLessThan</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null, &quot;to&quot; : ?, &quot;include_lower&quot; : true, &quot;include_upper&quot; : false &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>LessThanEqual</code></td><td align="left"><code>findByPriceLessThanEqual</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null, &quot;to&quot; : ?, &quot;include_lower&quot; : true, &quot;include_upper&quot; : true &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>GreaterThan</code></td><td align="left"><code>findByPriceGreaterThan</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?, &quot;to&quot; : null, &quot;include_lower&quot; : false, &quot;include_upper&quot; : true &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>GreaterThanEqual</code></td><td align="left"><code>findByPriceGreaterThan</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?, &quot;to&quot; : null, &quot;include_lower&quot; : true, &quot;include_upper&quot; : true &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Before</code></td><td align="left"><code>findByPriceBefore</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null, &quot;to&quot; : ?, &quot;include_lower&quot; : true, &quot;include_upper&quot; : true &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>After</code></td><td align="left"><code>findByPriceAfter</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?, &quot;to&quot; : null, &quot;include_lower&quot; : true, &quot;include_upper&quot; : true &#125; &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Like</code></td><td align="left"><code>findByNameLike</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?*&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125;, &quot;analyze_wildcard&quot;: true &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>StartingWith</code></td><td align="left"><code>findByNameStartingWith</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;?*&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125;, &quot;analyze_wildcard&quot;: true &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>EndingWith</code></td><td align="left"><code>findByNameEndingWith</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;*?&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125;, &quot;analyze_wildcard&quot;: true &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>Contains/Containing</code></td><td align="left"><code>findByNameContaining</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;*?*&quot;, &quot;fields&quot; : [ &quot;name&quot; ] &#125;, &quot;analyze_wildcard&quot;: true &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>In</code>（当注释为 FieldType.关键字时）</td><td align="left"><code>findByNameIn(Collection&lt;String&gt;names)</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;bool&quot; : &#123;&quot;must&quot; : [ &#123;&quot;terms&quot; : &#123;&quot;name&quot; : [&quot;?&quot;,&quot;?&quot;]&#125;&#125; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>In</code></td><td align="left"><code>findByNameIn(Collection&lt;String&gt;names)</code></td><td align="left"><code>&#123; &quot;query&quot;: &#123;&quot;bool&quot;: &#123;&quot;must&quot;: [&#123;&quot;query_string&quot;:&#123;&quot;query&quot;: &quot;\&quot;?\&quot; \&quot;?\&quot;&quot;, &quot;fields&quot;: [&quot;name&quot;]&#125;&#125;]&#125;&#125;&#125;</code></td></tr><tr><td align="left"><code>NotIn</code>（当注释为 FieldType.关键字时）</td><td align="left"><code>findByNameNotIn(Collection&lt;String&gt;names)</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : [ &#123;&quot;terms&quot; : &#123;&quot;name&quot; : [&quot;?&quot;,&quot;?&quot;]&#125;&#125; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>NotIn</code></td><td align="left"><code>findByNameNotIn(Collection&lt;String&gt;names)</code></td><td align="left"><code>&#123;&quot;query&quot;: &#123;&quot;bool&quot;: &#123;&quot;must&quot;: [&#123;&quot;query_string&quot;: &#123;&quot;query&quot;: &quot;NOT(\&quot;?\&quot; \&quot;?\&quot;)&quot;, &quot;fields&quot;: [&quot;name&quot;]&#125;&#125;]&#125;&#125;&#125;</code></td></tr><tr><td align="left"><code>True</code></td><td align="left"><code>findByAvailableTrue</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;true&quot;, &quot;fields&quot; : [ &quot;available&quot; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>False</code></td><td align="left"><code>findByAvailableFalse</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;false&quot;, &quot;fields&quot; : [ &quot;available&quot; ] &#125; &#125; ] &#125; &#125;&#125;</code></td></tr><tr><td align="left"><code>OrderBy</code></td><td align="left"><code>findByAvailableTrueOrderByNameDesc</code></td><td align="left"><code>&#123; &quot;query&quot; : &#123; &quot;bool&quot; : &#123; &quot;must&quot; : [ &#123; &quot;query_string&quot; : &#123; &quot;query&quot; : &quot;true&quot;, &quot;fields&quot; : [ &quot;available&quot; ] &#125; &#125; ] &#125; &#125;, &quot;sort&quot;:[&#123;&quot;name&quot;:&#123;&quot;order&quot;:&quot;desc&quot;&#125;&#125;] &#125;</code></td></tr><tr><td align="left"><code>Exists</code></td><td align="left"><code>findByNameExists</code></td><td align="left"><code>&#123;&quot;query&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;name&quot;&#125;&#125;]&#125;&#125;&#125;</code></td></tr><tr><td align="left"><code>IsNull</code></td><td align="left"><code>findByNameIsNull</code></td><td align="left"><code>&#123;&quot;query&quot;:&#123;&quot;bool&quot;:&#123;&quot;must_not&quot;:[&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;name&quot;&#125;&#125;]&#125;&#125;&#125;</code></td></tr><tr><td align="left"><code>IsNotNull</code></td><td align="left"><code>findByNameIsNotNull</code></td><td align="left"><code>&#123;&quot;query&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;name&quot;&#125;&#125;]&#125;&#125;&#125;</code></td></tr><tr><td align="left"><code>IsEmpty</code></td><td align="left"><code>findByNameIsEmpty</code></td><td align="left"><code>&#123;&quot;query&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;exists&quot;:&#123;&quot;field&quot;:&quot;name&quot;&#125;&#125;],&quot;must_not&quot;:[&#123;&quot;wildcard&quot;:&#123;&quot;name&quot;:&#123;&quot;wildcard&quot;:&quot;*&quot;&#125;&#125;&#125;]&#125;&#125;]&#125;&#125;&#125;</code></td></tr><tr><td align="left"><code>IsNotEmpty</code></td><td align="left"><code>findByNameIsNotEmpty</code></td><td align="left"><code>&#123;&quot;query&quot;:&#123;&quot;bool&quot;:&#123;&quot;must&quot;:[&#123;&quot;wildcard&quot;:&#123;&quot;name&quot;:&#123;&quot;wildcard&quot;:&quot;*&quot;&#125;&#125;&#125;]&#125;&#125;&#125;</code></td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>中间件</category>
      
      <category>Elasticsearch</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringTask</title>
    <link href="/2023/02/08/spring/SpringTask/"/>
    <url>/2023/02/08/spring/SpringTask/</url>
    
    <content type="html"><![CDATA[<h2 id="SpringTask"><a href="#SpringTask" class="headerlink" title="SpringTask"></a>SpringTask</h2><p>SpringTask是Spring自主研发的轻量级<strong>定时任务工具</strong></p><h3 id="Cron表达式"><a href="#Cron表达式" class="headerlink" title="Cron表达式"></a>Cron表达式</h3><p><strong>格式</strong>：秒 分 时 日 月 星期</p><table><thead><tr><th>时间元素</th><th>可出现的字符</th><th>有效数值范围</th></tr></thead><tbody><tr><td>Seconds</td><td>, - * &#x2F;</td><td>0-59</td></tr><tr><td>Minutes</td><td>, - * &#x2F;</td><td>0-59</td></tr><tr><td>Hours</td><td>, - * &#x2F;</td><td>0-23</td></tr><tr><td>DayofMonth</td><td>, - * &#x2F; ? L W</td><td>0-31</td></tr><tr><td>Month</td><td>, - * &#x2F;</td><td>1-12</td></tr><tr><td>DayofWeek</td><td>, - * &#x2F; ? L #</td><td>1-7或SUN-SAT</td></tr></tbody></table><p><strong>说明</strong>：</p><table><thead><tr><th>字符</th><th>作用</th><th>举例</th></tr></thead><tbody><tr><td>,</td><td>列出枚举值</td><td>在Minutes域使用5,10，表示在5分和10分各触发一次</td></tr><tr><td>-</td><td>表示触发范围</td><td>在Minutes域使用5-10，表示从5分到10分钟每分钟触发一次</td></tr><tr><td>*</td><td>匹配任意值</td><td>在Minutes域使用*, 表示每分钟都会触发一次</td></tr><tr><td>&#x2F;</td><td>起始时间开始触发，每隔固定时间触发一次</td><td>在Minutes域使用5&#x2F;10,表示5分时触发一次，每10分钟再触发一次</td></tr><tr><td>?</td><td>在DayofMonth和DayofWeek中，用于匹配任意值</td><td>在DayofMonth域使用?,表示每天都触发一次</td></tr><tr><td>#</td><td>在DayofMonth中，确定第几个星期几</td><td>1#3表示第三个星期日</td></tr><tr><td>L</td><td>表示最后</td><td>在DayofWeek中使用5L,表示在最后一个星期四触发</td></tr><tr><td>W</td><td>表示有效工作日(周一到周五)</td><td>在DayofMonth使用5W，如果5日是星期六，则将在最近的工作日4日触发一次</td></tr></tbody></table><p><strong>示例</strong>：</p><ol><li><p>每两秒执行一次</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown">0/2 <span class="hljs-emphasis">* *</span> <span class="hljs-emphasis">* *</span> <span class="hljs-emphasis">*</span><br></code></pre></td></tr></table></figure></li><li><p>每个二、四、六星期的下午两点执行一次</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">*</span> <span class="hljs-emphasis">* 14 *</span> <span class="hljs-emphasis">* 2,4,6</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li><p>SpringTask已经存在于Spring框架中，无需添加新的依赖</p></li><li><p><code>@EnableScheduling</code>开启定时任务功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableScheduling</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringTaskConfig</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>使用示例</p><p>每十分钟执行一次</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.component;<br><br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Scheduled;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTimeOutCancelTask</span> &#123;<br><br>    <span class="hljs-meta">@Scheduled(cron = &quot;0 0/10 * * * *&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelTimeOutOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 定时任务</span><br>        log.info(<span class="hljs-string">&quot;task&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jwt</title>
    <link href="/2023/02/06/%E5%85%B6%E4%BB%96/Jwt/"/>
    <url>/2023/02/06/%E5%85%B6%E4%BB%96/Jwt/</url>
    
    <content type="html"><![CDATA[<h2 id="Jwt"><a href="#Jwt" class="headerlink" title="Jwt"></a>Jwt</h2><blockquote><p>JWT是JSON WEB TOKEN的缩写，它是基于 RFC 7519 标准定义的一种可以安全传输的的JSON对象，由于使用了<strong>数字签名</strong>，所以是可信任和安全的。</p></blockquote><h3 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h3><p>header.payload.signature</p><blockquote><p>header中存放签名的生成算法</p><p>payload存放附加信息</p><p>signature为通过header和payload生成的签名</p></blockquote><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>用户登录后，系统生成token返回给用户。</p><p>之后每次调用接口都要在请求中添加Authorization请求头，值为之前的token。</p><p>后台系统通过token来对用户<strong>认证和授权</strong>。</p><p><font color="red">jwt不能防止冒充其他用户</font></p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 用到SpringSecurity来传用户信息 --&gt;</span><br><span class="hljs-comment">&lt;!--SpringSecurity依赖配置--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 自定义jwt key</span><br><span class="hljs-attr">jwt:</span><br>  <span class="hljs-attr">tokenHeader:</span> <span class="hljs-string">Authorization</span> <span class="hljs-comment">#JWT存储的请求头</span><br>  <span class="hljs-attr">secret:</span> <span class="hljs-string">mySecret</span> <span class="hljs-comment">#JWT加解密使用的密钥</span><br>  <span class="hljs-attr">expiration:</span> <span class="hljs-number">604800</span> <span class="hljs-comment">#JWT的超期限时间(60*60*24)</span><br>  <span class="hljs-attr">tokenHead:</span> <span class="hljs-string">Bearer</span>  <span class="hljs-comment">#JWT负载中拿到开头</span><br></code></pre></td></tr></table></figure></li><li><p>编写工具类（结合Spring Security）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.utils;<br><br><span class="hljs-keyword">import</span> io.jsonwebtoken.*;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * token工具类</span><br><span class="hljs-comment"> * 获取token、校验token、刷新token过期时间</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenUtil</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLAIM_KEY_USERNAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sub&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CLAIM_KEY_CREATED</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;created&quot;</span>;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.secret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String secret;  <span class="hljs-comment">// 加密秘钥</span><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.expiration&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Long expiration;    <span class="hljs-comment">// token保留时间</span><br><br>    <span class="hljs-comment">// 获取token中的用户名</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUserNameFormToken</span><span class="hljs-params">(String token)</span> &#123;<br>        String username;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> getClaimsFormToken(token);<br>            username = claims.getSubject();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> username;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证token是否有效</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateToken</span><span class="hljs-params">(String token, UserDetails userDetails)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> getUserNameFormToken(token);<br>        <span class="hljs-keyword">return</span> userDetails.getUsername().equals(username) &amp;&amp; isTokenExpired(token);<br>    &#125;<br><br>    <span class="hljs-comment">// 生成Token</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(UserDetails userDetails)</span> &#123;<br>        HashMap&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        claims.put(CLAIM_KEY_USERNAME, userDetails.getUsername());<br>        claims.put(CLAIM_KEY_CREATED, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">return</span> generateTokenFromClaims(claims);<br>    &#125;<br><br>    <span class="hljs-comment">// 刷新token</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">refreshToken</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> getClaimsFormToken(token);<br>        claims.put(CLAIM_KEY_CREATED, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-keyword">return</span> generateTokenFromClaims(claims);<br>    &#125;<br><br>    <span class="hljs-comment">// 验证token是否实效</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTokenExpired</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">expireDate</span> <span class="hljs-operator">=</span> getExpireDateFormToken(token);<br>        <span class="hljs-keyword">return</span> expireDate.before(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    &#125;<br><br>    <span class="hljs-comment">// 获取Token过期时间</span><br>    <span class="hljs-keyword">private</span> Date <span class="hljs-title function_">getExpireDateFormToken</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> getClaimsFormToken(token);<br>        <span class="hljs-keyword">return</span> claims.getExpiration();<br>    &#125;<br><br>    <span class="hljs-comment">// 根据负载信息生成Token</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateTokenFromClaims</span><span class="hljs-params">(Map&lt;String, Object&gt; claims)</span> &#123;<br>        <span class="hljs-keyword">return</span> Jwts.builder()<br>                .setClaims(claims)  <span class="hljs-comment">// 设置token中负载信息</span><br>                .setExpiration(generateExpirationDate())    <span class="hljs-comment">// 设置超时时间</span><br>                .signWith(SignatureAlgorithm.ES512, secret) <span class="hljs-comment">// 设置加密方式</span><br>                .compact();<br>    &#125;<br><br>    <span class="hljs-comment">// 生成Token过期时间</span><br>    <span class="hljs-keyword">private</span> Date <span class="hljs-title function_">generateExpirationDate</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + expiration * <span class="hljs-number">1000</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 获取token中的JWT负载</span><br>    <span class="hljs-keyword">private</span> Claims <span class="hljs-title function_">getClaimsFormToken</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            claims = Jwts.parser()<br>                    .setSigningKey(secret)<br>                    .parseClaimsJws(token)<br>                    .getBody();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.info(<span class="hljs-string">&quot;JWT验证失败:&#123;&#125;&quot;</span>, token);<br>        &#125;<br>        <span class="hljs-keyword">return</span> claims;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>编写工具类（不是用其他框架）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.place.utils;<br><br><span class="hljs-keyword">import</span> io.jsonwebtoken.*;<br><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.crypto.SecretKey;<br><span class="hljs-keyword">import</span> javax.crypto.spec.SecretKeySpec;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.Date;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.UUID;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * token工具类</span><br><span class="hljs-comment"> * 获取token、校验token、刷新token过期时间</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtTokenUtil</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.secret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String SECRET;      <span class="hljs-comment">// 加密秘钥</span><br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.expiration&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Long EXPIRATION;    <span class="hljs-comment">// token保留时间(s)</span><br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.refresh_time&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Integer REFRESH_TIME;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getToken</span><span class="hljs-params">(Long id)</span> &#123;<br>        HashMap&lt;String, Object&gt; claimMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        claimMaps.put(<span class="hljs-string">&quot;id&quot;</span>, id);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">return</span> Jwts.builder()<br>                .setId(UUID.randomUUID().toString())<br>                .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(currentTime))     <span class="hljs-comment">// 签发时间</span><br>                .setSubject(<span class="hljs-string">&quot;system&quot;</span>)                   <span class="hljs-comment">// 说明</span><br>                .setAudience(<span class="hljs-string">&quot;app&quot;</span>)                     <span class="hljs-comment">// 接收用户</span><br>                .compressWith(CompressionCodecs.GZIP)   <span class="hljs-comment">// 数据压缩方式</span><br>                .signWith(SignatureAlgorithm.HS512, generalKey())   <span class="hljs-comment">// 数据压缩方式</span><br>                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(currentTime + EXPIRATION * <span class="hljs-number">1000</span>))     <span class="hljs-comment">// 过期时间戳</span><br>                .addClaims(claimMaps)                   <span class="hljs-comment">// 载荷信息</span><br>                .compact();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成加密key</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SecretKey <span class="hljs-title function_">generalKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">byte</span>[] encodedKey = Base64.getEncoder().encode(SECRET.getBytes());<br>        <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecretKeySpec</span>(encodedKey, <span class="hljs-number">0</span>, encodedKey.length, <span class="hljs-string">&quot;AES&quot;</span>);<br>        <span class="hljs-keyword">return</span> key;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取payload body信息</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title function_">getClaimsBody</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> getJws(token).getBody();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取headers body信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> JwsHeader <span class="hljs-title function_">getHeaderBody</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">return</span> getJws(token).getHeader();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断token是否过期</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> claims</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> -1 有效，0 有效，1：过期，2 过期</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">verifyToken</span><span class="hljs-params">(Claims claims)</span> &#123;<br>        <span class="hljs-keyword">if</span> (claims == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            claims.getExpiration()<br>                    .before(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>            <span class="hljs-keyword">if</span> ((claims.getExpiration().getTime() - System.currentTimeMillis()) &gt; REFRESH_TIME * <span class="hljs-number">1000</span>) &#123;<br>                <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ExpiredJwtException ex) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取载荷信息</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Jws&lt;Claims&gt; <span class="hljs-title function_">getJws</span><span class="hljs-params">(String token)</span> &#123;<br>        <span class="hljs-keyword">return</span> Jwts.parser()<br>                .setSigningKey(generalKey())<br>                .parseClaimsJws(token);<br>    &#125;<br><br><br>    <span class="hljs-comment">// 测试</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        System.out.println(JwtTokenUtil.getToken(<span class="hljs-number">1102L</span>));<br>        Jws&lt;Claims&gt; jws = JwtTokenUtil.getJws(<span class="hljs-string">&quot;eyJhbGciOiJIUzUxMiIsInppcCI6IkdaSVAifQ.H4sIAAAAAAAAAB2LUQrEIAwF75JvBROjYm-jVcGFBUELW0rv3nT_3jDzLvisDhtwKxzCbrRr6DQ3izqVitpzzL5FyqYgKOhpwYY-UkDHziuYR5b3POeqX_HpKIJpDNn1N_6ttWTobbs4REP3Az_PtEl1AAAA.Mrst1ZCLW7ItSxLl26TiYbpN-7XPNn1HUuP0ZyGqNZgLitUlt3Vqfnu9MGI1blugwdI6wBriAmydZITaYuRRmA&quot;</span>);<br>        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> jws.getBody();<br>        System.out.println(claims.get(<span class="hljs-string">&quot;id&quot;</span>));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MP代码生成器</title>
    <link href="/2023/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8/"/>
    <url>/2023/02/03/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E4%BB%A3%E7%A0%81%E7%94%9F%E6%88%90%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="MP代码生成器"><a href="#MP代码生成器" class="headerlink" title="MP代码生成器"></a>MP代码生成器</h2><p><a href="https://baomidou.com/pages/779a6e/#%E5%AE%89%E8%A3%85">官网文档</a></p><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><ol><li><p>导入坐标</p><blockquote><p>注意mybatis-plus-generator的版本必须为3.5.1</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--MybatisPlus、MybatisPlus生成器--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>freemarker<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.30<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">server:<br>  port: <span class="hljs-number">8080</span><br>spring:<br>  datasource:<br>    url: jdbc:mysql:<span class="hljs-comment">//localhost:3306/mall?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai</span><br>    username: root<br>    password: <span class="hljs-number">123456</span><br><br>mybatis:<br>  mapper-locations:<br>    - classpath:mapper<span class="hljs-comment">/*.xml</span><br><span class="hljs-comment">    - classpath*:com/**/</span>mapper<span class="hljs-comment">/*.xml</span><br></code></pre></td></tr></table></figure></li><li><p>编写代码，执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.mallLearning.generator;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用于生产MBG的代码</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Generator</span> &#123;<br>    <span class="hljs-comment">// 基础信息配置</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;jdbc:mysql://localhost:3306/mall?useUnicode=true&amp;characterEncoding=utf-8&amp;serverTimezone=Asia/Shanghai&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USERNAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;root&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PARENT_PACKAGE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.xw.mallLearning.generator&quot;</span>;  <span class="hljs-comment">// 包名</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PROJECT_ROOT_PATH</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PROJECT_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mall-learning&quot;</span>;     <span class="hljs-comment">// 当前项目名称</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MODULE_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;mbg&quot;</span>;      <span class="hljs-comment">// 模块名称, 代码会生成在generator/MODULE_NAME下</span><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 执行此处</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        simpleGenerator();<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simpleGenerator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 添加需要自动生成代码的表名, 为空则生成所有表对应代码</span><br>        List&lt;String&gt; tables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        tables.add(<span class="hljs-string">&quot;pms_brand&quot;</span>);<br><br>        <span class="hljs-comment">// 包路径</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">packagePath</span> <span class="hljs-operator">=</span> PROJECT_ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + PROJECT_NAME + <span class="hljs-string">&quot;/src/main/java&quot;</span>;<br>        <span class="hljs-comment">// XML文件的路径</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">mapperXmlPath</span> <span class="hljs-operator">=</span> PROJECT_ROOT_PATH + <span class="hljs-string">&quot;/&quot;</span> + PROJECT_NAME + <span class="hljs-string">&quot;/src/main/resources/mapper&quot;</span>;<br><br>        <span class="hljs-comment">// 开始执行代码生成</span><br>        FastAutoGenerator.create(URL, USERNAME, PASSWORD)<br>            <span class="hljs-comment">// 1. 全局配置</span><br>            .globalConfig(builder -&gt; builder<br>                          <span class="hljs-comment">// 作者名称</span><br>                          .author(<span class="hljs-string">&quot;xw&quot;</span>)<br>                          <span class="hljs-comment">// 开启覆盖已生成的文件。注释掉则关闭覆盖。</span><br>                          .fileOverride()<br>                          <span class="hljs-comment">// 禁止打开输出目录。注释掉则生成完毕后，自动打开生成的文件目录。</span><br>                          .disableOpenDir()<br>                          <span class="hljs-comment">// 指定输出目录。如果指定，Windows生成至D盘根目录下，Linux or MAC 生成至 /tmp 目录下。</span><br>                          .outputDir(packagePath)<br>                          <span class="hljs-comment">// 开启swagger2.注释掉则默认关闭。</span><br>                          <span class="hljs-comment">// .enableSwagger()</span><br>                          <span class="hljs-comment">// 指定时间策略。</span><br>                          .dateType(DateType.TIME_PACK)<br>                          <span class="hljs-comment">// 注释时间策略。</span><br>                          .commentDate(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>)<br>                         )<br><br>            <span class="hljs-comment">// 2. 包配置</span><br>            .packageConfig(builder -&gt; builder<br>                           <span class="hljs-comment">// 设置父表名</span><br>                           .parent(PARENT_PACKAGE_NAME)<br>                           .moduleName(MODULE_NAME)<br>                           .entity(<span class="hljs-string">&quot;entity&quot;</span>)<br>                           .service(<span class="hljs-string">&quot;service&quot;</span>)<br>                           .serviceImpl(<span class="hljs-string">&quot;service.impl&quot;</span>)<br>                           .controller(<span class="hljs-string">&quot;controller&quot;</span>)<br>                           .mapper(<span class="hljs-string">&quot;mapper&quot;</span>)<br>                           .xml(<span class="hljs-string">&quot;mapper&quot;</span>)<br>                           <span class="hljs-comment">// mapper.xml 文件的路径。单模块下，其他文件路径默认即可。</span><br>                           .pathInfo(Collections.singletonMap(OutputFile.mapperXml, mapperXmlPath))<br>                          )<br><br>            <span class="hljs-comment">// 3. 策略配置</span><br>            .strategyConfig(builder -&gt; builder.addInclude(tables)<br>                            <span class="hljs-comment">// 阶段1：Entity实体类策略配置</span><br>                            .entityBuilder()<br>                            <span class="hljs-comment">// 开启生成实体时生成字段注解。</span><br>                            <span class="hljs-comment">// 会在实体类的属性前，添加[@TableField(&quot;nickname&quot;)]</span><br>                            .enableTableFieldAnnotation()<br>                            <span class="hljs-comment">// 逻辑删除字段名(数据库)。</span><br>                            <span class="hljs-comment">//.logicDeleteColumnName(&quot;is_delete&quot;)</span><br>                            <span class="hljs-comment">// 逻辑删除属性名(实体)。</span><br>                            <span class="hljs-comment">// 会在实体类的该字段属性前加注解[@TableLogic]</span><br>                            <span class="hljs-comment">//.logicDeletePropertyName(&quot;isDelete&quot;)</span><br>                            <span class="hljs-comment">// 会在实体类的该字段上追加注解[@TableField(value = &quot;create_time&quot;, fill = FieldFill.INSERT)]</span><br>                            .addTableFills(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Column</span>(<span class="hljs-string">&quot;create_time&quot;</span>, FieldFill.INSERT))<br>                            <span class="hljs-comment">// 会在实体类的该字段上追加注解[@TableField(value = &quot;update_time&quot;, fill = FieldFill.INSERT_UPDATE)]</span><br>                            .addTableFills(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Column</span>(<span class="hljs-string">&quot;update_time&quot;</span>, FieldFill.INSERT_UPDATE))<br>                            <span class="hljs-comment">// 阶段2：Mapper策略配置</span><br>                            .mapperBuilder()<br>                            <span class="hljs-comment">// 开启 @Mapper 注解。</span><br>                            <span class="hljs-comment">// 会在mapper接口上添加注解[@Mapper]</span><br>                            .enableMapperAnnotation()<br>                            <span class="hljs-comment">// 启用 BaseResultMap 生成。</span><br>                            <span class="hljs-comment">// 会在mapper.xml文件生成[通用查询映射结果]配置。</span><br>                            .enableBaseResultMap()<br>                            <span class="hljs-comment">// 启用 BaseColumnList。</span><br>                            <span class="hljs-comment">// 会在mapper.xml文件生成[通用查询结果列 ]配置</span><br>                            .enableBaseColumnList()<br>                            <span class="hljs-comment">// 阶段4：Controller策略配置</span><br>                            .controllerBuilder()<br>                            <span class="hljs-comment">// 会在控制类中加[@RestController]注解。</span><br>                            .enableRestStyle()<br>                            <span class="hljs-comment">// 开启驼峰转连字符</span><br>                            .enableHyphenStyle()<br>                            .build()<br>                           )<br><br>            <span class="hljs-comment">// 4. 模板引擎配置，默认 Velocity 可选模板引擎 Beetl 或 Freemarker</span><br>            <span class="hljs-comment">//.templateEngine(new BeetlTemplateEngine())</span><br>            .templateEngine(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FreemarkerTemplateEngine</span>())<br><br>            <span class="hljs-comment">// 5. 执行</span><br>            .execute();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
      <category>mybatis-plus</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python web</title>
    <link href="/2022/12/02/python/python%20web/"/>
    <url>/2022/12/02/python/python%20web/</url>
    
    <content type="html"><![CDATA[<h1 id="python-web"><a href="#python-web" class="headerlink" title="python web"></a>python web</h1><h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><blockquote><p>Django 是一个由 <strong>Python</strong> 编写的一个开放源代码的 <strong>Web 应用框架</strong>。</p></blockquote><h3 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>pip</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">pip <span class="hljs-keyword">install</span> django<br></code></pre></td></tr></table></figure><p>pycharm</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">软件包搜D<span class="hljs-function"><span class="hljs-title">jango</span> --&gt;</span> 安装软件包<br></code></pre></td></tr></table></figure><p>安装完后会在Lib目录下下载django源码，在Scripts下生成django-admin.exe用于生成django项目</p><h4 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h4><p>cmd</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-comment"># 进到要创建项目的目录</span><br>django-<span class="hljs-literal">admin</span> startproject 项目名称<br></code></pre></td></tr></table></figure><p>pycharm</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">文件</span> <span class="hljs-literal">--</span>&gt; <span class="hljs-comment">新建项目</span> <span class="hljs-literal">--</span>&gt; <span class="hljs-comment">Django</span> <span class="hljs-literal">--</span>&gt; <span class="hljs-comment">输入项目名创建项目</span><br></code></pre></td></tr></table></figure><h4 id="项目目录说明"><a href="#项目目录说明" class="headerlink" title="项目目录说明"></a>项目目录说明</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">|<span class="hljs-string">-- 项目同名文件夹</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- __init__.py# 空的，标记这个软件包为python软件包</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- asgi.py# 接收网络请求（异步）</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- settings.py# 项目的配置文件</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- urls.py# 访问路径和函数间的映射关系</span><br><span class="hljs-string"></span>|<span class="hljs-string">   `-- wsgi.py# 接收网络请求（同步）</span><br><span class="hljs-string">`-- manage.py# 项目管理，启动项目，创建app，数据管理</span><br></code></pre></td></tr></table></figure><h4 id="App"><a href="#App" class="headerlink" title="App"></a>App</h4><blockquote><p>类似java中maven项目的模块</p></blockquote><p>创建app</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><span class="hljs-comment"># 在项目目录下</span><br>python manage.py startapp <span class="hljs-variable">&lt;app名&gt;</span><br></code></pre></td></tr></table></figure><p>注册app</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">在settings.<span class="hljs-keyword">py</span>文件的INSTALLED_APPS中添加app的apps.<span class="hljs-keyword">py</span>中的启动类<br></code></pre></td></tr></table></figure><p>app目录结构</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">|<span class="hljs-string">-- app名</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- __init__.py</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- admin.py# django默认提供了admin后台管理</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- apps.py# app启动类</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- models.py           # **对数据库操作**</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- tests.py            # 单元测试</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">-- views.py# **放与请求路径对应的函数**</span><br><span class="hljs-string">`-- manage.py</span><br></code></pre></td></tr></table></figure><h3 id="第一个项目"><a href="#第一个项目" class="headerlink" title="第一个项目"></a>第一个项目</h3><ol><li>创建app</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> manage.<span class="hljs-keyword">py</span> startapp HelloWorld<br></code></pre></td></tr></table></figure><ol start="2"><li>settings.py的INSTALLED_APPS中注册app</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python">INSTALLED_APPS = [<br>    <span class="hljs-string">&#x27;django.contrib.admin&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.auth&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.contenttypes&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.sessions&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.messages&#x27;</span>,<br>    <span class="hljs-string">&#x27;django.contrib.staticfiles&#x27;</span>,<br>    <span class="hljs-string">&#x27;HelloWorld.apps.HelloworldConfig&#x27;</span>,     <span class="hljs-comment"># 注册app</span><br>]<br></code></pre></td></tr></table></figure><ol start="3"><li>urls.py中加入映射</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">urlpatterns = [<br>    path(<span class="hljs-string">&#x27;admin/&#x27;</span>, admin.site.urls),<br>    <span class="hljs-comment"># 访问路径和函数的映射</span><br>    path(<span class="hljs-string">&#x27;index/&#x27;</span>, views.index),<br>]<br></code></pre></td></tr></table></figure><ol start="4"><li>在views.py中编写对应函数</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>(<span class="hljs-params">request</span>):<br>    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">&quot;Hello World&quot;</span>)<br></code></pre></td></tr></table></figure><ol start="5"><li>启动</li></ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">python</span> manage.<span class="hljs-keyword">py</span> runserver<br>或<br>pycharm 中绿色三角<br></code></pre></td></tr></table></figure><ol start="6"><li>页面访问<code>localhost:8000/index</code></li></ol><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><blockquote><p>在app下建立templates目录来放置网页文件</p><p>static目录放静态文件</p></blockquote><p>在函数中使用<code>return render(request, &quot;文件名&quot;)</code>来返回网页</p><p>搜索网页文件顺序</p><ol><li><p>优先项目根目录的templates中找</p><blockquote><p>要在配置文件的TEMPLATES中标识<code>&#39;DIRS&#39;: [os.path.join(BASE_DIR, &#39;templates&#39;)]</code></p></blockquote></li><li><p>根据app注册顺序，在每个app的templates中找</p></li></ol><h2 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h2><h3 id="小案例"><a href="#小案例" class="headerlink" title="小案例"></a>小案例</h3><p><strong>后端</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, render_template, request<br><span class="hljs-keyword">import</span> pymysql<br><br>app = Flask(__name__)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/add/user&quot;</span>, methods=[<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_user</span>():<br>    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;add_user.html&quot;</span>)<br><br>    <span class="hljs-comment"># 保存到mysql</span><br>    conn = get_conn()<br>    insert(conn, request)<br>    conn.close()<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;添加成功&quot;</span><br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/show/user&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_user</span>():<br>    conn = get_conn()<br>    all_info = get_all(conn)<br>    conn.close()<br>    <span class="hljs-built_in">print</span>(all_info)<br><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;show_user.html&quot;</span>, data_list=all_info)<br><br><span class="hljs-comment"># 获取游标</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_conn</span>():<br>    conn = pymysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>                           port=<span class="hljs-number">3306</span>,<br>                           user=<span class="hljs-string">&#x27;root&#x27;</span>,<br>                           password=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>                           charset=<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>                           db=<span class="hljs-string">&#x27;pyconn&#x27;</span>)<br><br>    <span class="hljs-keyword">return</span> conn<br><br><br><span class="hljs-comment"># 插入数据</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">conn, request</span>):<br>    info = &#123;<br>        <span class="hljs-string">&quot;user&quot;</span>: request.form.get(<span class="hljs-string">&quot;user&quot;</span>),<br>        <span class="hljs-string">&quot;pwd&quot;</span>: request.form.get(<span class="hljs-string">&quot;pwd&quot;</span>),<br>        <span class="hljs-string">&quot;mobile&quot;</span>: request.form.get(<span class="hljs-string">&quot;mobile&quot;</span>),<br>    &#125;<br>    cursor = conn.cursor()<br>    sql = <span class="hljs-string">&quot;insert into admin(username, password, mobile) values (%s, %s, %s)&quot;</span><br>    cursor.execute(sql, [info[<span class="hljs-string">&quot;user&quot;</span>], info[<span class="hljs-string">&quot;pwd&quot;</span>], info[<span class="hljs-string">&quot;mobile&quot;</span>]])<br>    conn.commit()<br><br><br><span class="hljs-comment"># 获取所有数据</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_all</span>(<span class="hljs-params">conn</span>):<br>    cursor = conn.cursor(pymysql.cursors.DictCursor)<br>    sql = <span class="hljs-string">&quot;select * from admin&quot;</span><br>    cursor.execute(sql)<br>    <span class="hljs-keyword">return</span> cursor.fetchall()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run()<br></code></pre></td></tr></table></figure><p><strong>前端</strong></p><p>添加用户</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>添加用户<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">action</span>=<span class="hljs-string">&quot;/add/user&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;用户名&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pwd&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;密码&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mobile&quot;</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;手机号&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;submit&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;提交&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>展示用户</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户列表<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">thead</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>ID<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>密码<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">th</span>&gt;</span>手机号<span class="hljs-tag">&lt;/<span class="hljs-name">th</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">thead</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tbody</span>&gt;</span><br>        &#123;% for item in data_list %&#125;<br>            <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; item.id &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; item.username &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; item.PASSWORD &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>&#123;&#123; item.mobile &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span><br>        &#123;% endfor %&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">tbody</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>python连接MySQL</title>
    <link href="/2022/12/01/python/python%E8%BF%9E%E6%8E%A5MySQL/"/>
    <url>/2022/12/01/python/python%E8%BF%9E%E6%8E%A5MySQL/</url>
    
    <content type="html"><![CDATA[<h2 id="python连接MySQL"><a href="#python连接MySQL" class="headerlink" title="python连接MySQL"></a>python连接MySQL</h2><h3 id="pymysql"><a href="#pymysql" class="headerlink" title="pymysql"></a>pymysql</h3><blockquote><p>通过pymysql进行数据库操作</p></blockquote><h4 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pymysql<br><br><span class="hljs-comment"># 1.创建连接</span><br>conn = pymysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>                       port=<span class="hljs-number">3306</span>,<br>                       user=<span class="hljs-string">&#x27;root&#x27;</span>,<br>                       password=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>                       charset=<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>                       db=<span class="hljs-string">&#x27;pyconn&#x27;</span>)<br><br><span class="hljs-comment"># 2.创建游标（cursor）</span><br>cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)<br><br><span class="hljs-comment"># 3.执行sql</span><br>sql = <span class="hljs-string">&quot;&quot;&quot;CREATE TABLE admin(</span><br><span class="hljs-string">id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,</span><br><span class="hljs-string">username VARCHAR(16) NOT NULL,</span><br><span class="hljs-string">PASSWORD VARCHAR(64) NOT NULL,</span><br><span class="hljs-string">mobile CHAR(11) NOT NULL</span><br><span class="hljs-string">) DEFAULT CHARSET=utf8;&quot;&quot;&quot;</span><br><br>cursor.execute(sql)<br><br><span class="hljs-comment"># 4.断开连接</span><br>conn.close()<br></code></pre></td></tr></table></figure><h4 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h4><blockquote><p>要使用connit提交到数据库</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 1.创建连接</span><br>conn = pymysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>                       port=<span class="hljs-number">3306</span>,<br>                       user=<span class="hljs-string">&#x27;root&#x27;</span>,<br>                       password=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>                       charset=<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>                       db=<span class="hljs-string">&#x27;pyconn&#x27;</span>)<br><span class="hljs-comment"># 2.创建游标（cursor）</span><br>cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)<br><br><span class="hljs-comment"># 3.用游标execute执行sql语句</span><br>cursor.execute(<span class="hljs-string">&quot;insert into admin(username, password, mobile) values (&#x27;zs&#x27;,&#x27;123456&#x27;,&#x27;12312345678&#x27;)&quot;</span>)<br>conn.commit()<br><br><span class="hljs-comment"># 4.断开连接</span><br>conn.close()<br></code></pre></td></tr></table></figure><p>注意：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 不要用拼接字符串来注入变量，而是使用pymysql的占位符</span><br>sql = <span class="hljs-string">&quot;insert into admin(username, password, mobile) values (%s,%s,%s)&quot;</span><br>cursor.execute(sql, [<span class="hljs-string">&#x27;ls&#x27;</span>, <span class="hljs-string">&#x27;123456&#x27;</span>, <span class="hljs-string">&#x27;45612345678&#x27;</span>])<br></code></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pthon"># 可以给占位符起名<br>sql = &quot;insert into admin(username, password, mobile) values (%(n1)s,%(n2)s,%(n3)s)&quot;<br>cursor.execute(sql, &#123;&#x27;n1&#x27;: &#x27;ww&#x27;, &#x27;n2&#x27;: &#x27;123456&#x27;, &#x27;n3&#x27;: &#x27;12345678123&#x27;&#125;)<br></code></pre></td></tr></table></figure><h4 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h4><blockquote><p>fetchone()：查询一条</p><p>fetchall(): 返回所有结果的集合</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pymysql<br><br><span class="hljs-comment"># 1.创建连接</span><br>conn = pymysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>                       port=<span class="hljs-number">3306</span>,<br>                       user=<span class="hljs-string">&#x27;root&#x27;</span>,<br>                       password=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>                       charset=<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>                       db=<span class="hljs-string">&#x27;pyconn&#x27;</span>)<br><span class="hljs-comment"># 2.创建游标（cursor）</span><br>cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)<br><br><span class="hljs-comment"># 3.执行sql</span><br>sql = <span class="hljs-string">&#x27;select * from admin&#x27;</span><br>cursor.execute(sql)<br><br><span class="hljs-comment"># 3.1fetchone</span><br>data = cursor.fetchone()<br><br><span class="hljs-comment"># 3.2fetchall</span><br>data_list = cursor.fetchall()<br><span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> data_list:<br>    <span class="hljs-built_in">print</span>(row)<br><br><span class="hljs-comment"># 4.断开连接</span><br>conn.close()<br></code></pre></td></tr></table></figure><h4 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs pyhton">import pymysql<br><br># 1.创建连接<br>conn = pymysql.connect(host=&quot;127.0.0.1&quot;,<br>                       port=3306,<br>                       user=&#x27;root&#x27;,<br>                       password=&#x27;123456&#x27;,<br>                       charset=&#x27;utf8&#x27;,<br>                       db=&#x27;pyconn&#x27;)<br># 2.创建游标（cursor）<br>cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)<br><br># 3.执行sql<br>sql = &#x27;update admin set password = %s where id = %s&#x27;<br>cursor.execute(sql, [&#x27;987654&#x27;, &#x27;1&#x27;])<br>conn.commit()<br><br># 4.断开连接<br>conn.close()<br></code></pre></td></tr></table></figure><h4 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pymysql<br><br><span class="hljs-comment"># 1.创建连接</span><br>conn = pymysql.connect(host=<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<br>                       port=<span class="hljs-number">3306</span>,<br>                       user=<span class="hljs-string">&#x27;root&#x27;</span>,<br>                       password=<span class="hljs-string">&#x27;123456&#x27;</span>,<br>                       charset=<span class="hljs-string">&#x27;utf8&#x27;</span>,<br>                       db=<span class="hljs-string">&#x27;pyconn&#x27;</span>)<br><span class="hljs-comment"># 2.创建游标（cursor）</span><br>cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)<br><br><span class="hljs-comment"># 3.执行sql</span><br>sql = <span class="hljs-string">&#x27;delete from admin where id=%s&#x27;</span><br>cursor.execute(sql, [<span class="hljs-number">1</span>, ])<br>conn.commit()<br><br><span class="hljs-comment"># 4.断开连接</span><br>conn.close()<br></code></pre></td></tr></table></figure><h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pythoon">try: <br>    sql = &#x27;delete from admin where id=%s&#x27;<br>    cursor.execute(sql, [1, ])<br>    conn.commit()<br>except:<br>    conn.rollback()# 回滚事务<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>python</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>json转换</title>
    <link href="/2022/11/29/%E5%85%B6%E4%BB%96/json%E8%BD%AC%E6%8D%A2/"/>
    <url>/2022/11/29/%E5%85%B6%E4%BB%96/json%E8%BD%AC%E6%8D%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="json转换"><a href="#json转换" class="headerlink" title="json转换"></a>json转换</h2><h3 id="jackson"><a href="#jackson" class="headerlink" title="jackson"></a>jackson</h3><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.13.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="使用：JSON转Java"><a href="#使用：JSON转Java" class="headerlink" title="使用：JSON转Java"></a>使用：JSON转Java</h4><blockquote><p>操作基于<strong>ObjectMapper</strong>对象的**readValue()**来完成</p><p>转换规则：将JSON对象的字段映射到Java对象中的属性。 Jackson删除了getter和setter方法名称的“ get”和“ set”部分，并将其余名称的第一个字符转换为小写。</p><p><strong>需要实现get、set方法</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">brand</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">doors</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">/** Getter and Setter */</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON-–-gt-Java对象"><a href="#JSON-–-gt-Java对象" class="headerlink" title="JSON –&gt; Java对象"></a>JSON –&gt; Java对象</h5><blockquote><p>readValue()重载方法可以传入：</p><p>字符串（String）、字符输入流（Reader）、字节输入流（InputStream）、</p><p>文件（File）、URL、二进制（byte[]）等</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">carJson</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;&#123; \&quot;brand\&quot; : \&quot;Mercedes\&quot;, \&quot;doors\&quot; : 5 &#125;&quot;</span>;<br><br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> objectMapper.readValue(carJson, Car.class);<br><br>        System.out.println(car);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON数组字符串-–-gt-Java对象数组"><a href="#JSON数组字符串-–-gt-Java对象数组" class="headerlink" title="JSON数组字符串 –&gt; Java对象数组"></a>JSON数组字符串 –&gt; Java对象数组</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonArray</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[&#123;\&quot;brand\&quot;:\&quot;ford\&quot;&#125;, &#123;\&quot;brand\&quot;:\&quot;Fiat\&quot;&#125;]&quot;</span>;<br><br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        Car[] cars = objectMapper.readValue(jsonArray, Car[].class);<br><br>        <span class="hljs-keyword">for</span> (Car car : cars) &#123;<br>            System.out.println(car);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON数组字符串-–-gt-List"><a href="#JSON数组字符串-–-gt-List" class="headerlink" title="JSON数组字符串 –&gt; List"></a>JSON数组字符串 –&gt; List</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;Car&gt; cars = objectMapper.readValue(jsonArray, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;Car&gt;&gt;() &#123;&#125;);<br></code></pre></td></tr></table></figure><h5 id="JSON-–-gt-Map"><a href="#JSON-–-gt-Map" class="headerlink" title="JSON –&gt; Map"></a>JSON –&gt; Map</h5><blockquote><p> JSON对象中的每个字段都将成为Java Map中的键</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\&quot;brand\&quot;:\&quot;ford\&quot;, \&quot;doors\&quot;:5&#125;&quot;</span>;<br><br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-keyword">try</span> &#123;<br>        Map&lt;String, Object&gt; cars = objectMapper.readValue(jsonObject, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, Object&gt;&gt;() &#123;&#125;);<br><br>        System.out.println(cars.keySet());<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="忽略不匹配的字段"><a href="#忽略不匹配的字段" class="headerlink" title="忽略不匹配的字段"></a>忽略不匹配的字段</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><h5 id="不允许基本类型为null"><a href="#不允许基本类型为null" class="headerlink" title="不允许基本类型为null"></a>不允许基本类型为null</h5><blockquote><p>默认会赋空值，设置了这个则会报错</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">objectMapper.configure(DeserializationFeature.FAIL_ON_NULL_FOR_PRIMITIVES, <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><h4 id="使用：Java转JSON"><a href="#使用：Java转JSON" class="headerlink" title="使用：Java转JSON"></a>使用：Java转JSON</h4><blockquote><p>操作基于<strong>ObjectMapper</strong>对象的**writeValue()&#x2F;writeValueAsString()&#x2F;writeValueAsBytes()**来完成</p></blockquote><h5 id="Java对象-–-gt-JSON"><a href="#Java对象-–-gt-JSON" class="headerlink" title="Java对象 –&gt; JSON"></a>Java对象 –&gt; JSON</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>();<br>    car.setBrand(<span class="hljs-string">&quot;BMW&quot;</span>);<br>    car.setDoors(<span class="hljs-number">4</span>);<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span>  <span class="hljs-operator">=</span> objectMapper.writeValueAsString(car);<br>        System.out.println(json);<br>    &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="将Date类型转为String"><a href="#将Date类型转为String" class="headerlink" title="将Date类型转为String"></a>将Date类型转为String</h5><blockquote><p>默认是转为毫秒</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>    <span class="hljs-comment">// 设置日期转换器</span><br>    <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">simpleDateFormat</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd&quot;</span>);<br>    objectMapper.setDateFormat(simpleDateFormat);<br><br>    <span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>();<br>    car.setBrand(<span class="hljs-string">&quot;BMW&quot;</span>);<br>    car.setDoors(<span class="hljs-number">4</span>);<br>    car.setData(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span>  <span class="hljs-operator">=</span> objectMapper.writeValueAsString(car);<br>        System.out.println(json);<br>    &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h4><table><thead><tr><th>注解</th><th><strong>用法</strong></th></tr></thead><tbody><tr><td>@JsonProperty</td><td>用于属性，把属性的名称序列化时转换为另外一个名称。示例：<br/>@JsonProperty(“birth_ date”)<br/>private Date birthDate;</td></tr><tr><td>@JsonFormat</td><td>用于属性或者方法，把属性的格式序列化时转换成指定的格式。示例：<br/>  @JsonFormat(timezone &#x3D;”GMT+8”, pattern &#x3D; “yyyy-MM-dd HH:mm”) <br/>  public Date getBirthDate()</td></tr><tr><td>@JsonPropertyOrder</td><td>用于类， 指定属性在序列化时 json 中的顺序 ， 示例：<br/>@JsonPropertyOrder({ “birth_Date”, “name” })<br/>public class Person</td></tr><tr><td>@JsonCreator</td><td>用于构造方法，和 @JsonProperty 配合使用，适用有参数的构造方法。<br/> 示例：@JsonCreator<br/>public Person(@JsonProperty(“name”)String name) {…}</td></tr><tr><td>@JsonAnySetter</td><td>用于属性或者方法，设置未反序列化的属性名和值作为键值存储到 map 中<br/>@JsonAnySetter<br/>public void set(String key, Object value) {<br/>map.put(key, value);<br/>}</td></tr><tr><td>@JsonAnyGetter</td><td>用于方法 ，获取所有未序列化的属性<br/>public Map&lt;String, Object&gt; any() { return map; }</td></tr></tbody></table><h3 id="Gson"><a href="#Gson" class="headerlink" title="Gson"></a>Gson</h3><h4 id="依赖-1"><a href="#依赖-1" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.code.gson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="创建Gson"><a href="#创建Gson" class="headerlink" title="创建Gson"></a>创建Gson</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 直接创建</span><br><span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();<br><br><span class="hljs-comment">// 通过工厂类创建</span><br><span class="hljs-type">GsonBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GsonBuilder</span>();<br><span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> builder.create();<br></code></pre></td></tr></table></figure><h4 id="使用：JSON转Java-1"><a href="#使用：JSON转Java-1" class="headerlink" title="使用：JSON转Java"></a>使用：JSON转Java</h4><blockquote><p>操作基于<strong>Gson</strong>对象来的**fromJson()**完成</p><p><strong>需要实现get、set方法</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String firstName;<br>    <span class="hljs-keyword">private</span> String lastName;<br>    <span class="hljs-keyword">private</span> String email;<br><br><span class="hljs-comment">// Getter and Setter</span><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON-–-gt-Java对象-1"><a href="#JSON-–-gt-Java对象-1" class="headerlink" title="JSON –&gt; Java对象"></a>JSON –&gt; Java对象</h5><blockquote><p>类似jackson的readValue()方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;&#x27;id&#x27;:1001, &#x27;firstName&#x27;:&#x27;Lokesh&#x27;, &#x27;lastName&#x27;:&#x27;Gupta&#x27;, &#x27;email&#x27;:&#x27;howtodoinjava@gmail.com&#x27;&#125;&quot;</span>;<br>    <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();<br><br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">empObject</span> <span class="hljs-operator">=</span> gson.fromJson(jsonString, Employee.class);<br>    System.out.println(empObject);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON数组字符串-–-gt-Java对象数组-1"><a href="#JSON数组字符串-–-gt-Java对象数组-1" class="headerlink" title="JSON数组字符串 –&gt; Java对象数组"></a>JSON数组字符串 –&gt; Java对象数组</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[&#123;&#x27;id&#x27;:1001, &#x27;firstName&#x27;:&#x27;Lokesh&#x27;, &#x27;lastName&#x27;:&#x27;Gupta&#x27;, &#x27;email&#x27;:&#x27;howtodoinjava@gmail.com&#x27;&#125;,&quot;</span> +<br>        <span class="hljs-string">&quot;&#123;&#x27;id&#x27;:1001, &#x27;firstName&#x27;:&#x27;Lokesh&#x27;, &#x27;lastName&#x27;:&#x27;Gupta&#x27;, &#x27;email&#x27;:&#x27;howtodoinjava@gmail.com&#x27;&#125;]&quot;</span>;<br>    <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();<br><br>    Employee[] employees = gson.fromJson(json, Employee[].class);<br>    <span class="hljs-keyword">for</span> (Employee employee : employees) &#123;<br>        System.out.println(employee);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON数组字符串-–-gt-List-1"><a href="#JSON数组字符串-–-gt-List-1" class="headerlink" title="JSON数组字符串 –&gt; List"></a>JSON数组字符串 –&gt; List</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;[&#123;&#x27;id&#x27;:1001, &#x27;firstName&#x27;:&#x27;Lokesh&#x27;, &#x27;lastName&#x27;:&#x27;Gupta&#x27;, &#x27;email&#x27;:&#x27;howtodoinjava@gmail.com&#x27;&#125;,&quot;</span> +<br>        <span class="hljs-string">&quot;&#123;&#x27;id&#x27;:1001, &#x27;firstName&#x27;:&#x27;Lokesh&#x27;, &#x27;lastName&#x27;:&#x27;Gupta&#x27;, &#x27;email&#x27;:&#x27;howtodoinjava@gmail.com&#x27;&#125;]&quot;</span>;<br>    <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();<br><br>    ArrayList&lt;Employee&gt; employees = gson.fromJson(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeToken</span>&lt;ArrayList&lt;Employee&gt;&gt;() &#123;<br>    &#125;.getType());<br><br>    <span class="hljs-keyword">for</span> (Employee employee : employees) &#123;<br>        System.out.println(employee);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="JSON数组字符串-–-gt-Set"><a href="#JSON数组字符串-–-gt-Set" class="headerlink" title="JSON数组字符串 –&gt; Set"></a>JSON数组字符串 –&gt; Set</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Set&lt;Employee&gt; employees = gson.fromJson(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeToken</span>&lt;HashSet&lt;Employee&gt;&gt;() &#123;<br>       &#125;.getType());<br></code></pre></td></tr></table></figure><h4 id="使用：Java转Json"><a href="#使用：Java转Json" class="headerlink" title="使用：Java转Json"></a>使用：Java转Json</h4><blockquote><p>操作基于<strong>Gson</strong>对象的**toJson()**来完成</p><p>重载支持set</p></blockquote><h5 id="Java对象-–-gt-JSON-1"><a href="#Java对象-–-gt-JSON-1" class="headerlink" title="Java对象 –&gt; JSON"></a>Java对象 –&gt; JSON</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">emp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-number">1001</span>, <span class="hljs-string">&quot;Lokesh&quot;</span>, <span class="hljs-string">&quot;Gupta&quot;</span>, <span class="hljs-string">&quot;howtodoinjava@gmail.com&quot;</span>);<br>    <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>();<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonString</span> <span class="hljs-operator">=</span> gson.toJson(emp);<br>    System.out.println(jsonString);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="格式化输出"><a href="#格式化输出" class="headerlink" title="格式化输出"></a>格式化输出</h5><blockquote><p>通过工厂类创建Gson，设置setPrettyPrinting</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Employee</span> <span class="hljs-variable">employeeObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Lokesh&quot;</span>, <span class="hljs-string">&quot;Gupta&quot;</span>, <span class="hljs-string">&quot;howtogoinjava@gmail.com&quot;</span>);<br>    <span class="hljs-type">Gson</span> <span class="hljs-variable">gson</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GsonBuilder</span>()<br>        .setPrettyPrinting()<br>        .create();<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> gson.toJson(employeeObj);<br>    System.out.println(json);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span> 打印<br>&#123;<br>  <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;firstName&quot;</span>: <span class="hljs-string">&quot;Lokesh&quot;</span>,<br>  <span class="hljs-string">&quot;lastName&quot;</span>: <span class="hljs-string">&quot;Gupta&quot;</span>,<br>  <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;howtogoinjava@gmail.com&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="注解-1"><a href="#注解-1" class="headerlink" title="注解"></a>注解</h4><table><thead><tr><th>注解</th><th>用法</th></tr></thead><tbody><tr><td>@SerializedName</td><td>自定义字段的名字</td></tr><tr><td>@Expose</td><td>只要有一个字段使用了Expose注解，所有需要参与序列化和反序列化的字段都要有这个注解<br/>@Expose(deserialize &#x3D; false)声明不参与反序列化<br/>@Expose(serialize &#x3D; false)声明该字段不参与序列化</td></tr></tbody></table><h3 id="fastJson"><a href="#fastJson" class="headerlink" title="fastJson"></a>fastJson</h3><h4 id="依赖-2"><a href="#依赖-2" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-comment">//使用@Bean注入fastJsonHttpMessageConvert</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> HttpMessageConverter <span class="hljs-title function_">fastJsonHttpMessageConverters</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//1.需要定义一个Convert转换消息的对象</span><br>        <span class="hljs-type">FastJsonHttpMessageConverter</span> <span class="hljs-variable">fastConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastJsonHttpMessageConverter</span>();<br>        <span class="hljs-type">FastJsonConfig</span> <span class="hljs-variable">fastJsonConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastJsonConfig</span>();<br>        fastJsonConfig.setSerializerFeatures(SerializerFeature.PrettyFormat);<br>        fastJsonConfig.setDateFormat(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br><br>        SerializeConfig.globalInstance.put(Long.class, ToStringSerializer.instance);<br><br>        fastJsonConfig.setSerializeConfig(SerializeConfig.globalInstance);<br>        fastConverter.setFastJsonConfig(fastJsonConfig);<br>        HttpMessageConverter&lt;?&gt; converter = fastConverter;<br>        <span class="hljs-keyword">return</span> converter;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configureMessageConverters</span><span class="hljs-params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;<br>        converters.add(fastJsonHttpMessageConverters());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shiro</title>
    <link href="/2022/11/26/%E5%85%B6%E4%BB%96/Shiro/"/>
    <url>/2022/11/26/%E5%85%B6%E4%BB%96/Shiro/</url>
    
    <content type="html"><![CDATA[<h1 id="Shiro"><a href="#Shiro" class="headerlink" title="Shiro"></a>Shiro</h1><p>参考<a href="https://zhuanlan.zhihu.com/p/54176956">Shiro安全框架【快速入门】就这一篇！ - 知乎 (zhihu.com)</a></p><h3 id="做什么的"><a href="#做什么的" class="headerlink" title="做什么的"></a>做什么的</h3><blockquote><p>开源安全框架，处理身份验证、授权、加密和会话管理</p><ul><li>认证：识别用户身份（登录）</li><li>授权：给用户某些操作的权限（赋予角色）</li><li>加密：对数据源使用加密算法</li><li>会话管理：特定于用户的会话管理</li></ul></blockquote><h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><blockquote><p>分为Subject,SecurityManager和 Realm三层</p></blockquote><p><img src="/img/quick_img/Shior%E6%9E%B6%E6%9E%84.png"></p><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><ul><li><strong>Subject</strong></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">可以是一个通过浏览器请求的用户，也可能是一个运行的程序<br><br>Subject在shiro中是一个接口，外部程序通过subject进行认证授，而subject是通过SecurityManager安全管理器进行认证授权<br></code></pre></td></tr></table></figure><ul><li><strong>SecurityManager</strong></li></ul><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">shiro的核心</span><br><span class="hljs-keyword"></span>对所有的<span class="hljs-keyword">subject进行安全管理，可以完成subject的认证、授权等</span><br><span class="hljs-keyword"></span>通过Authenticator认证器进行认证<br>通过Authorizer授权器进行授权<br>通过SessionManager进行会话管理<br></code></pre></td></tr></table></figure><ul><li><strong>Realm</strong></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">数据库读取+认证功能+授权功能实现<br>相当于datasource数据源，securityManager进行安全认证需要通过Realm获取用户权限数据<br></code></pre></td></tr></table></figure><ul><li>CacheManager</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">将用户权限数据存储在缓存以提高性能<br></code></pre></td></tr></table></figure><ul><li>Cryptography</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">密码管理<br></code></pre></td></tr></table></figure><h3 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h3><h4 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h4><h5 id="从ini文件读取"><a href="#从ini文件读取" class="headerlink" title="从ini文件读取"></a>从ini文件读取</h5><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-logging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在resource目录下编写ini文件</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#声明用户账号</span><br><span class="hljs-section">[users]</span><br><span class="hljs-attr">jay</span>=<span class="hljs-number">123</span><br></code></pre></td></tr></table></figure></li><li><p>编写测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloShiro</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shiroLogin</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 导入权限ini文件构建权限工厂</span><br>        <span class="hljs-type">IniSecurityManagerFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IniSecurityManagerFactory</span>(<span class="hljs-string">&quot;classpath:shiro.ini&quot;</span>);<br>        <span class="hljs-comment">// 用工厂构建Manager</span><br>        <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> factory.getInstance();<br>        <span class="hljs-comment">// 使Manager生效</span><br>        SecurityUtils.setSecurityManager(securityManager);<br><br>        <span class="hljs-comment">// 获取Subject</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();<br>        <span class="hljs-comment">// 创建Token</span><br>        <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(<span class="hljs-string">&quot;jay&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);<br>        <span class="hljs-comment">// subject通过token登录</span><br>        subject.login(token);<br>        System.out.println(<span class="hljs-string">&quot;是否登录成功：&quot;</span> + subject.isAuthenticated());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="从Realm中读取"><a href="#从Realm中读取" class="headerlink" title="从Realm中读取"></a>从Realm中读取</h5><ol><li><p>编写service，模拟从数据库读取用户密码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findPasswordByLoginName</span><span class="hljs-params">(String loginName)</span> &#123;<br>        <span class="hljs-comment">// 模拟从数据库中获取密码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;123&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>自定义Realm</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefinitionRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizingRealm</span> &#123;<br>    <span class="hljs-type">SecurityService</span> <span class="hljs-variable">securityService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityServiceImpl</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 授权</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> principalCollection</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 认证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> authenticationToken</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-comment">// 获取用户唯一标识</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> (String) authenticationToken.getPrincipal();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> securityService.findPasswordByLoginName(loginName);<br>        <span class="hljs-keyword">if</span> (password == <span class="hljs-literal">null</span> || <span class="hljs-string">&quot;&quot;</span>.equals(password))<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnknownAccountException</span>(<span class="hljs-string">&quot;账户不存在&quot;</span>);<br><span class="hljs-comment">// 传递账号和密码</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthenticationInfo</span>(loginName, password, <span class="hljs-built_in">this</span>.getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在ini文件中设置realm</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[main]</span><br><span class="hljs-attr">definitionRealm</span>=com.xw.realm.DefinitionRealm<br><span class="hljs-attr">securityManager.realms</span>=<span class="hljs-variable">$definitionRealm</span><br></code></pre></td></tr></table></figure></li><li><p>编写测试类</p><p>和上面的一样</p></li><li><p>认证过程</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xl">S<span class="hljs-function"><span class="hljs-title">ubject</span> -&gt;</span> S<span class="hljs-function"><span class="hljs-title">ecurityManager</span> -&gt;</span> A<span class="hljs-function"><span class="hljs-title">uthenticator</span> -&gt;</span> R<span class="hljs-function"><span class="hljs-title">ealm</span> -&gt;</span> 自定义Realm将数据库中查到的账号密码返回<br>最后在Realm中比较Subject传过来的Token和数据库中的是否一致<br></code></pre></td></tr></table></figure></li></ol><h4 id="编码解码"><a href="#编码解码" class="headerlink" title="编码解码"></a>编码解码</h4><p><strong>通过shiro的Hex和Base64来进行编码解码</strong></p><ol><li><p>编写工具类（把两种方式整合到一个工具类上）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EncodesUtils</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照16进制编码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encodeHex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>        <span class="hljs-keyword">return</span> Hex.encodeToString(bytes);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照16进制解码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decodeHex(String s) &#123;<br>        <span class="hljs-keyword">return</span> Hex.decode(s);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照16进制编码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bytes</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">encodeBase64</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>        <span class="hljs-keyword">return</span> Base64.encodeToString(bytes);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 按照16进制解码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] decodeBase64(String s) &#123;<br>        <span class="hljs-keyword">return</span> Base64.decode(s);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">pwd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>    <span class="hljs-comment">// 测试16进制编码解码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">encode</span> <span class="hljs-operator">=</span> EncodesUtils.encodeHex(pwd.getBytes());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">decode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(EncodesUtils.decodeHex(encode));<br>    System.out.println(decode.equals(pwd) ? <span class="hljs-string">&quot;相等&quot;</span> : <span class="hljs-string">&quot;不相等&quot;</span>);<br>    <span class="hljs-comment">// 测试base64编码解码</span><br>    encode = EncodesUtils.encodeBase64(pwd.getBytes());<br>    decode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(EncodesUtils.decodeBase64(encode));<br>    System.out.println(decode.equals(pwd) ? <span class="hljs-string">&quot;相等&quot;</span> : <span class="hljs-string">&quot;不相等&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p><strong>散列算法</strong></p><p>通过SimpleHash(算法名称，原密码，盐值，加密次数)来进行加密</p><ol><li><p>编写工具类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DigestUtil</span> &#123;<br><br>    <span class="hljs-comment">// 算法名称</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SHA1</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;SHA-1&quot;</span>;<br><br>    <span class="hljs-comment">// 加密次数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">ITERATIONS</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过sha1加密</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> s</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> salt</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">sha1</span><span class="hljs-params">(String s, String salt)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleHash</span>(SHA1, s, salt, ITERATIONS).toString();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 返回加密后的密码和盐值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> passwordPlain</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, String&gt; <span class="hljs-title function_">entryptPassword</span><span class="hljs-params">(String passwordPlain)</span> &#123;<br>        HashMap&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> generateSalt();<br>        map.put(<span class="hljs-string">&quot;salt&quot;</span>, salt);<br>        map.put(<span class="hljs-string">&quot;password&quot;</span>, sha1(passwordPlain, salt));<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成随机盐值</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateSalt</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">SecureRandomNumberGenerator</span> <span class="hljs-variable">randomNumberGenerator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandomNumberGenerator</span>();<br>        <span class="hljs-keyword">return</span> randomNumberGenerator.nextBytes().toHex();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">pwd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>    Map&lt;String, String&gt; map = DigestUtil.entryptPassword(pwd);<br>    System.out.println(map.toString());<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="Realm中指定匹配器"><a href="#Realm中指定匹配器" class="headerlink" title="Realm中指定匹配器"></a>Realm中指定匹配器</h4><blockquote><p>自定义匹配器的盐值，加密次数</p></blockquote><ol><li><p>service层返回加密后的密码和盐值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SecurityService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">findPasswordByLoginName</span><span class="hljs-params">(String loginName)</span> &#123;<br>        <span class="hljs-comment">// 模拟从数据库中获取密码</span><br>        <span class="hljs-keyword">return</span> DigestUtil.entryptPassword(<span class="hljs-string">&quot;123&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>自定义Realm重写构造函数，设置匹配器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefinitionRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizingRealm</span> &#123;<br>    <span class="hljs-type">SecurityService</span> <span class="hljs-variable">securityService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityServiceImpl</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DefinitionRealm</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建匹配器，指定匹配方式</span><br>        <span class="hljs-type">HashedCredentialsMatcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedCredentialsMatcher</span>(DigestUtil.SHA1);<br>        <span class="hljs-comment">// 指定迭代次数</span><br>        matcher.setHashIterations(DigestUtil.ITERATIONS);<br>        <span class="hljs-comment">// 使匹配器生效</span><br>        setCredentialsMatcher(matcher);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 授权</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> principalCollection</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 认证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> authenticationToken</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-comment">// 获取用户唯一标识</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> (String) authenticationToken.getPrincipal();<br>        Map&lt;String, String&gt; map = securityService.findPasswordByLoginName(loginName);<br>        <span class="hljs-keyword">if</span> (map.isEmpty())<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnknownAccountException</span>(<span class="hljs-string">&quot;账户不存在&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;password&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> map.get(<span class="hljs-string">&quot;salt&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthenticationInfo</span>(loginName, password, ByteSource.Util.bytes(salt), <span class="hljs-built_in">this</span>.getName());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p></li></ol><h4 id="身份授权"><a href="#身份授权" class="headerlink" title="身份授权"></a>身份授权</h4><ol><li><p>service层返回查询到的角色、权限信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">findRoleByLoginName</span><span class="hljs-params">(String loginName)</span> &#123;<br>    <span class="hljs-comment">// 模拟从数据库中获取角色</span><br>    List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    list.add(<span class="hljs-string">&quot;admin&quot;</span>);<br>    list.add(<span class="hljs-string">&quot;dev&quot;</span>);<br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">findPermissionByLoginName</span><span class="hljs-params">(String loginName)</span> &#123;<br>    <span class="hljs-comment">// 模拟从数据库中获取权限</span><br>    List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    list.add(<span class="hljs-string">&quot;order:add&quot;</span>);<br>    list.add(<span class="hljs-string">&quot;order:list&quot;</span>);<br>    list.add(<span class="hljs-string">&quot;order:del&quot;</span>);<br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Realm中构建校验信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefinitionRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizingRealm</span> &#123;<br>    <span class="hljs-type">SecurityService</span> <span class="hljs-variable">securityService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityServiceImpl</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 授权</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> principalCollection</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> &#123;<br>        <span class="hljs-comment">// 获取用户唯一标识</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">loginName</span> <span class="hljs-operator">=</span> (String) principalCollection.getPrimaryPrincipal();<br>        <span class="hljs-comment">// 从数据库中获取用户角色和权限</span><br>        List&lt;String&gt; roles = securityService.findRoleByLoginName(loginName);<br>        List&lt;String&gt; permissions = securityService.findPermissionByLoginName(loginName);<br>        <span class="hljs-comment">// 构建校验信息</span><br>        <span class="hljs-type">SimpleAuthorizationInfo</span> <span class="hljs-variable">authenticationInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthorizationInfo</span>();<br>        authenticationInfo.addRoles(roles);<br>        authenticationInfo.addStringPermissions(permissions);<br><br>        <span class="hljs-keyword">return</span> authenticationInfo;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPermissionRealm</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> shiroLogin();<br><br>    <span class="hljs-comment">// 验证角色</span><br>    System.out.println(<span class="hljs-string">&quot;是否有admin角色：&quot;</span> + subject.hasRole(<span class="hljs-string">&quot;admin&quot;</span>));<span class="hljs-comment">// true</span><br>    System.out.println(<span class="hljs-string">&quot;是否有coder角色：&quot;</span> + subject.hasRole(<span class="hljs-string">&quot;coder&quot;</span>));<span class="hljs-comment">// false</span><br><br>    <span class="hljs-comment">// 验证权限</span><br>    System.out.println(<span class="hljs-string">&quot;是否有添加订单权限：&quot;</span> + subject.isPermitted(<span class="hljs-string">&quot;order:add&quot;</span>));<span class="hljs-comment">// true</span><br>    System.out.println(<span class="hljs-string">&quot;是否有修改订单权限：&quot;</span> + subject.isPermitted(<span class="hljs-string">&quot;order:update&quot;</span>));<span class="hljs-comment">// false</span><br><br>&#125;<br><br><span class="hljs-keyword">public</span> Subject <span class="hljs-title function_">shiroLogin</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 导入权限ini文件构建权限工厂</span><br>    <span class="hljs-type">IniSecurityManagerFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IniSecurityManagerFactory</span>(<span class="hljs-string">&quot;classpath:shiro.ini&quot;</span>);<br>    <span class="hljs-comment">// 用工厂构建Manager</span><br>    <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> factory.getInstance();<br>    <span class="hljs-comment">// 使Manager生效</span><br>    SecurityUtils.setSecurityManager(securityManager);<br><br>    <span class="hljs-comment">// 获取subject</span><br>    <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();<br>    <span class="hljs-comment">// 创建Token</span><br>    <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(<span class="hljs-string">&quot;jay&quot;</span>, <span class="hljs-string">&quot;123&quot;</span>);<br>    <span class="hljs-comment">// subject通过token登录</span><br>    subject.login(token);<br>    System.out.println(<span class="hljs-string">&quot;是否登录成功：&quot;</span> + subject.isAuthenticated());<br><br>    <span class="hljs-keyword">return</span> subject;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="使用案例"><a href="#使用案例" class="headerlink" title="使用案例"></a>使用案例</h3><h4 id="Shiro认证过程"><a href="#Shiro认证过程" class="headerlink" title="Shiro认证过程"></a>Shiro认证过程</h4><blockquote><p>验证用户身份</p></blockquote><p><img src="/img/quick_img/Shior%E8%AE%A4%E8%AF%81%E8%BF%87%E7%A8%8B.png"></p><p>测试类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationTest</span> &#123;<br><br>    <span class="hljs-type">SimpleAccountRealm</span> <span class="hljs-variable">simpleAccountRealm</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAccountRealm</span>();<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 往Realm域中添加用户信息</span><br>        simpleAccountRealm.addAccount(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAuthentication</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 1.构建SecurityManager环境</span><br>        <span class="hljs-type">DefaultSecurityManager</span> <span class="hljs-variable">defaultSecurityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityManager</span>();<br>        defaultSecurityManager.setRealm(simpleAccountRealm);<br><br>        SecurityUtils.setSecurityManager(defaultSecurityManager);   <span class="hljs-comment">// 设置SecurityManager环境</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();   <span class="hljs-comment">// 获取当前主体</span><br><br>        <span class="hljs-comment">// 2.主体提交认证请求</span><br>        <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>        subject.login(token);   <span class="hljs-comment">// 登录</span><br><br>        System.out.println(<span class="hljs-string">&quot;isAuthenticated:&quot;</span> + subject.isAuthenticated());<br><br>        subject.logout();<br><br>        System.out.println(<span class="hljs-string">&quot;isAuthenticated:&quot;</span> + subject.isAuthenticated());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Shiro授权过程"><a href="#Shiro授权过程" class="headerlink" title="Shiro授权过程"></a>Shiro授权过程</h4><blockquote><p>赋予&#x2F;验证用户角色</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationTest2</span> &#123;<br><br>    <span class="hljs-type">SimpleAccountRealm</span> <span class="hljs-variable">simpleAccountRealm</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAccountRealm</span>();<br><br>    <span class="hljs-meta">@Before</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 往Realm域中添加用户信息</span><br>        <span class="hljs-comment">// 使其具备admin和user两个角色</span><br>        simpleAccountRealm.addAccount(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>, <span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAuthentication</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 1.构建SecurityManager环境</span><br>        <span class="hljs-type">DefaultSecurityManager</span> <span class="hljs-variable">defaultSecurityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityManager</span>();<br>        defaultSecurityManager.setRealm(simpleAccountRealm);<br><br>        SecurityUtils.setSecurityManager(defaultSecurityManager);   <span class="hljs-comment">// 设置SecurityManager环境</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();   <span class="hljs-comment">// 获取当前主体</span><br><br>        <span class="hljs-comment">// 2.主体提交认证请求</span><br>        <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>        subject.login(token);   <span class="hljs-comment">// 登录</span><br><br>        System.out.println(<span class="hljs-string">&quot;isAuthenticated:&quot;</span> + subject.isAuthenticated());<br><br>        <span class="hljs-comment">// 验证用户是否有相应的角色，没有则报错</span><br>        subject.checkRoles(<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>);<br><br>        <span class="hljs-comment">// subject.checkRoles(&quot;admin&quot;, &quot;user&quot;, &quot;xxx&quot;); // UnauthorizedException</span><br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="自定义Realm"><a href="#自定义Realm" class="headerlink" title="自定义Realm"></a>自定义Realm</h4><blockquote><p>realm类似MVC的repository层</p></blockquote><p>自定义Realm</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizingRealm</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模拟数据库数据</span><br><span class="hljs-comment">     */</span><br>    Map&lt;String, String&gt; userMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(<span class="hljs-number">16</span>);<br><br>    &#123;<br>        userMap.put(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-built_in">super</span>.setName(<span class="hljs-string">&quot;myRealm&quot;</span>); <span class="hljs-comment">// 设置自定义Realm的名称</span><br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 授权</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> principalCollection</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userName</span> <span class="hljs-operator">=</span> (String) principalCollection.getPrimaryPrincipal();<br><br>        <span class="hljs-comment">// 从数据库中获取角色和权限数据</span><br>        Set&lt;String&gt; roles = getRolesByUserName(userName);<br>        Set&lt;String&gt; permissions = getPermissionsByUserName(userName);<br><br>        <span class="hljs-comment">// 添加到授权信息中并返回</span><br>        <span class="hljs-type">SimpleAuthorizationInfo</span> <span class="hljs-variable">simpleAuthorizationInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthorizationInfo</span>();<br>        simpleAuthorizationInfo.setStringPermissions(permissions);<br>        simpleAuthorizationInfo.setRoles(roles);<br><br>        <span class="hljs-keyword">return</span> simpleAuthorizationInfo;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 认证</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> authenticationToken</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> AuthenticationException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> (String) authenticationToken.getPrincipal();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> getPasswordByUserName(username);<br>        <span class="hljs-keyword">if</span> (password == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-type">SimpleAuthenticationInfo</span> <span class="hljs-variable">simpleAuthenticationInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthenticationInfo</span>(<span class="hljs-string">&quot;user&quot;</span>, password, <span class="hljs-string">&quot;myRealm&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> simpleAuthenticationInfo;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据用户名获取权限信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">getPermissionsByUserName</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-comment">// 模拟查询数据库并返回</span><br>        HashSet&lt;String&gt; permission = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        permission.add(<span class="hljs-string">&quot;user:delete&quot;</span>);<br>        permission.add(<span class="hljs-string">&quot;user:add&quot;</span>);<br>        <span class="hljs-keyword">return</span> permission;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取角色数据</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; <span class="hljs-title function_">getRolesByUserName</span><span class="hljs-params">(String userName)</span> &#123;<br>        <span class="hljs-comment">// 模拟查询数据库并返回</span><br>        Set&lt;String&gt; roles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>        roles.add(<span class="hljs-string">&quot;admin&quot;</span>);<br>        roles.add(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-keyword">return</span> roles;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取用户密码</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userName</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getPasswordByUserName</span><span class="hljs-params">(String userName)</span> &#123;<br>        <span class="hljs-comment">// 模拟获取用户密码/凭证</span><br>        <span class="hljs-keyword">return</span> userMap.get(userName);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationTest3</span> &#123;<br><br>    <span class="hljs-type">MyRealm</span> <span class="hljs-variable">myRealm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRealm</span>();<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAuthentication</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 1.构建SecurityManager环境</span><br>        <span class="hljs-type">DefaultSecurityManager</span> <span class="hljs-variable">defaultSecurityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSecurityManager</span>();<br>        defaultSecurityManager.setRealm(myRealm);<br><br>        SecurityUtils.setSecurityManager(defaultSecurityManager);<br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();   <span class="hljs-comment">// 获取当前主体</span><br><br>        <span class="hljs-comment">// 2.主体提交认证请求</span><br>        <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(<span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>        subject.login(token);   <span class="hljs-comment">// 登录</span><br><br>        subject.checkRoles(<span class="hljs-string">&quot;admin&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>);<br><br>        subject.checkPermission(<span class="hljs-string">&quot;user:add&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="Shiro加密"><a href="#Shiro加密" class="headerlink" title="Shiro加密"></a>Shiro加密</h4><blockquote><p>使用MD5加密可以使数据库中的密码不是明文保存，数据库泄露的损失会减小</p><p>但可以通过用一些简单常用的密码来撞库，从而反推原密码</p></blockquote><p>解决方式：</p><p><strong>加盐：</strong>在原始密码上加上随机数，再进行MD5加密。需要把随机数也存到数据库中，以便之后进行验证</p><p><strong>多次加密</strong>：多次加密MD5，从而让攻击者不知道加密的次数</p><p>Shiro实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationTest4</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAuthentication</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br><br>        <span class="hljs-comment">// 盐值（随机数）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandomNumberGenerator</span>().nextBytes().toString();<br>        <span class="hljs-comment">// 加密次数</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">times</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>        <span class="hljs-comment">// 加密方式</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">alogrithmName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;md5&quot;</span>;<br><br>        <span class="hljs-type">SimpleHash</span> <span class="hljs-variable">encodePassword</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleHash</span>(alogrithmName, password, salt, times);<br>        System.out.println(<span class="hljs-string">&quot;原密码：&quot;</span> + password);<br>        System.out.println(<span class="hljs-string">&quot;加密后：&quot;</span> + encodePassword);<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure><p><a href="https://github.com/Xwww12/Shiro-">小dmeo</a></p><h3 id="SpringBoot集成Shiro"><a href="#SpringBoot集成Shiro" class="headerlink" title="SpringBoot集成Shiro"></a>SpringBoot集成Shiro</h3><p><a href="https://blog.csdn.net/Yearingforthefuture/article/details/117384035">SpringBoot之整合Shiro springboot+shiro</a></p><h4 id="整合Shiro"><a href="#整合Shiro" class="headerlink" title="整合Shiro"></a>整合Shiro</h4><h5 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--shiro--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="编写自定义Realm"><a href="#编写自定义Realm" class="headerlink" title="编写自定义Realm"></a>编写自定义Realm</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.shiro.realm;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerRealm</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AuthorizingRealm</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="编写Shiro配置类"><a href="#编写Shiro配置类" class="headerlink" title="编写Shiro配置类"></a>编写Shiro配置类</h5><p>主要配置过滤器、SecurityManager、Realm</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.config;<br><br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShiroConfig</span> &#123;<br><br>    <span class="hljs-comment">// 过滤器</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ShiroFilterFactoryBean <span class="hljs-title function_">getShiroFilterFactoryBean</span><span class="hljs-params">(DefaultWebSecurityManager securityManager)</span> &#123;<br>        <span class="hljs-type">ShiroFilterFactoryBean</span> <span class="hljs-variable">shiroFilterFactoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShiroFilterFactoryBean</span>();<br>        <span class="hljs-comment">// 给ShiroFilter配置安全管理器</span><br>        shiroFilterFactoryBean.setSecurityManager(securityManager);<br>        <span class="hljs-comment">//配置系统受限资源</span><br>        <span class="hljs-comment">//配置系统公共资源</span><br>        Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>        map.put(<span class="hljs-string">&quot;/index.jsp&quot;</span>,<span class="hljs-string">&quot;authc&quot;</span>);<span class="hljs-comment">//表示这个资源需要认证和授权</span><br>        <span class="hljs-comment">// 设置认证界面路径</span><br>        shiroFilterFactoryBean.setLoginUrl(<span class="hljs-string">&quot;/login.jsp&quot;</span>);<br>        shiroFilterFactoryBean.setFilterChainDefinitionMap(map);<br><br>        <span class="hljs-keyword">return</span> shiroFilterFactoryBean;<br>    &#125;<br><br>    <span class="hljs-comment">// SecurityManager</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DefaultWebSecurityManager <span class="hljs-title function_">getDefaultWebSecurityManager</span><span class="hljs-params">(Realm realm)</span> &#123;<br>        <span class="hljs-type">DefaultWebSecurityManager</span> <span class="hljs-variable">securityManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultWebSecurityManager</span>();<br>        securityManager.setRealm(realm);<br>        <span class="hljs-keyword">return</span> securityManager;<br>    &#125;<br><br>    <span class="hljs-comment">// 自定义Realm</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Realm <span class="hljs-title function_">getRealm</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CustomerRealm</span> <span class="hljs-variable">customerRealm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerRealm</span>();<br>        <span class="hljs-keyword">return</span> customerRealm;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="登录登出"><a href="#登录登出" class="headerlink" title="登录登出"></a>登录登出</h4><h5 id="编写Controller"><a href="#编写Controller" class="headerlink" title="编写Controller"></a>编写Controller</h5><p>登录登出方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.controller;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@RequestMapping(&quot;/logout&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">logout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 获取主体</span><br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();<br>        <span class="hljs-comment">// 退出</span><br>        subject.logout();<br><br>        <span class="hljs-comment">// 重定向到登录界面</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login.jsp&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/login&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password)</span> &#123;<br>        <span class="hljs-type">Subject</span> <span class="hljs-variable">subject</span> <span class="hljs-operator">=</span> SecurityUtils.getSubject();<br>        <span class="hljs-type">UsernamePasswordToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UsernamePasswordToken</span>(username, password);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 登录</span><br>            subject.login(token);<br>            System.out.println(<span class="hljs-string">&quot;登录成功&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index.jsp&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownAccountException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;用户错误&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IncorrectCredentialsException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;密码错误&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login.jsp&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="编写自定义Realm的认证方法"><a href="#编写自定义Realm的认证方法" class="headerlink" title="编写自定义Realm的认证方法"></a>编写自定义Realm的认证方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 认证</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> (String) authenticationToken.getPrincipal();<br>    <span class="hljs-comment">// 模拟从数据库中获取账号密码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zhangsan&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;123456&quot;</span>;<br>    <span class="hljs-keyword">if</span> (account.equals(username)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthenticationInfo</span>(username, password, <span class="hljs-built_in">this</span>.getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="修改配置类"><a href="#修改配置类" class="headerlink" title="修改配置类"></a>修改配置类</h5><p>将login方法设为公共资源，其他的为受限资源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, String&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();<br>map.put(<span class="hljs-string">&quot;/user/login&quot;</span>,<span class="hljs-string">&quot;anon&quot;</span>);<span class="hljs-comment">//表示这个为公共资源 一定是在受限资源上面</span><br>map.put(<span class="hljs-string">&quot;/**&quot;</span>,<span class="hljs-string">&quot;authc&quot;</span>);<span class="hljs-comment">//表示这个受限资源需要认证和授权</span><br></code></pre></td></tr></table></figure><h4 id="MD5、Salt认证"><a href="#MD5、Salt认证" class="headerlink" title="MD5、Salt认证"></a>MD5、Salt认证</h4><h5 id="编写生成盐值工具类"><a href="#编写生成盐值工具类" class="headerlink" title="编写生成盐值工具类"></a>编写生成盐值工具类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.utils;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaltUtil</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getSalt</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureRandomNumberGenerator</span>().nextBytes().toString();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="编写获取对象工具类"><a href="#编写获取对象工具类" class="headerlink" title="编写获取对象工具类"></a>编写获取对象工具类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.utils;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextUtil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext context;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-built_in">this</span>.context = applicationContext;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String beanName)</span> &#123;<br>        <span class="hljs-keyword">return</span> context.getBean(beanName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="编写Service注册方法"><a href="#编写Service注册方法" class="headerlink" title="编写Service注册方法"></a>编写Service注册方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.service.impl;<br><br><span class="hljs-meta">@Service(&quot;userService&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserMapper userMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-comment">// 添加盐值</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">salt</span> <span class="hljs-operator">=</span> SaltUtil.getSalt();<br>        user.setSalt(salt);<br>        <span class="hljs-comment">// 明文密码进行md5 + salt + hash散列</span><br>        <span class="hljs-type">Md5Hash</span> <span class="hljs-variable">MD5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Md5Hash</span>(user.getPassword(), salt, <span class="hljs-number">1024</span>);<br>        user.setPassword(MD5.toHex());<br>        userMapper.save(user);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span> &#123;<br>        <span class="hljs-keyword">return</span> userMapper.findByUsername(username);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="自定义Realm中改为从Service中获取数据"><a href="#自定义Realm中改为从Service中获取数据" class="headerlink" title="自定义Realm中改为从Service中获取数据"></a>自定义Realm中改为从Service中获取数据</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 认证</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> AuthenticationInfo <span class="hljs-title function_">doGetAuthenticationInfo</span><span class="hljs-params">(AuthenticationToken authenticationToken)</span> <span class="hljs-keyword">throws</span> AuthenticationException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> (String) authenticationToken.getPrincipal();<br>    <span class="hljs-comment">// 获取userService对象</span><br>    <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) ApplicationContextUtil.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findByUsername(username);<br>    <span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(user)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthenticationInfo</span>(user.getUsername(), user.getPassword(), ByteSource.Util.bytes(user.getSalt()), <span class="hljs-built_in">this</span>.getName());<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="修改配置类-1"><a href="#修改配置类-1" class="headerlink" title="修改配置类"></a>修改配置类</h5><p>修改公共资源和添加匹配器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">map.put(<span class="hljs-string">&quot;/user/login&quot;</span>,<span class="hljs-string">&quot;anon&quot;</span>);<span class="hljs-comment">//表示这个为公共资源 一定是在受限资源上面</span><br>map.put(<span class="hljs-string">&quot;/user/register&quot;</span>,<span class="hljs-string">&quot;anon&quot;</span>);<span class="hljs-comment">//表示这个为公共资源 一定是在受限资源上面</span><br>map.put(<span class="hljs-string">&quot;/register.jsp&quot;</span>,<span class="hljs-string">&quot;anon&quot;</span>);<span class="hljs-comment">//表示这个为公共资源 一定是在受限资源上面</span><br>map.put(<span class="hljs-string">&quot;/**&quot;</span>,<span class="hljs-string">&quot;authc&quot;</span>);<span class="hljs-comment">//表示这个受限资源需要认证和授权</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 自定义Realm</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Realm <span class="hljs-title function_">getRealm</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 匹配器</span><br>    <span class="hljs-type">HashedCredentialsMatcher</span> <span class="hljs-variable">credentialsMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedCredentialsMatcher</span>();<br>    credentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;md5&quot;</span>);<br>    credentialsMatcher.setHashIterations(<span class="hljs-number">1024</span>);<br>    <span class="hljs-comment">// 添加匹配器</span><br>    <span class="hljs-type">CustomerRealm</span> <span class="hljs-variable">customerRealm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerRealm</span>();<br>    customerRealm.setCredentialsMatcher(credentialsMatcher);<br>    <span class="hljs-keyword">return</span> customerRealm;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><h5 id="授予角色和权限"><a href="#授予角色和权限" class="headerlink" title="授予角色和权限"></a>授予角色和权限</h5><p>User &lt;–&gt; Role &lt;–&gt; Perm</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 授权</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> AuthorizationInfo <span class="hljs-title function_">doGetAuthorizationInfo</span><span class="hljs-params">(PrincipalCollection principalCollection)</span> &#123;<br>    <span class="hljs-comment">// 获取用户唯一标识</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">principal</span> <span class="hljs-operator">=</span> (String) principalCollection.getPrimaryPrincipal();<br>    <span class="hljs-comment">// 获取UserService</span><br>    <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) ApplicationContextUtil.getBean(<span class="hljs-string">&quot;userService&quot;</span>);<br><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findRoleByUsername(principal);<br>    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(user.getRoles())) &#123;<br>        <span class="hljs-type">SimpleAuthorizationInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleAuthorizationInfo</span>();<br>        user.getRoles().forEach(role -&gt; &#123;<br>            <span class="hljs-comment">// 将用户角色放到info中并返回</span><br>            info.addRole(role.getName());<br>            <span class="hljs-comment">// 根据角色id获取角色对应的权限信息</span><br>            List&lt;Perms&gt; perms = userService.findPermsByRoleId2(role.getId());<br>            <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(perms) &amp;&amp; perms.get(<span class="hljs-number">0</span>) != <span class="hljs-literal">null</span>) &#123;<br>                perms.forEach(perm -&gt; info.addStringPermission(perm.getName()));<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">return</span> info;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="判断是否有角色和权限"><a href="#判断是否有角色和权限" class="headerlink" title="判断是否有角色和权限"></a>判断是否有角色和权限</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.controller;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;order&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-comment">// 基于方法</span><br><span class="hljs-comment">//    @RequestMapping(&quot;save&quot;)</span><br><span class="hljs-comment">//    public String save() &#123;</span><br><span class="hljs-comment">//        //基于角色</span><br><span class="hljs-comment">//        //获取主体对象</span><br><span class="hljs-comment">//        Subject subject = SecurityUtils.getSubject();</span><br><span class="hljs-comment">//        //代码方式</span><br><span class="hljs-comment">//        if (subject.hasRole(&quot;admin&quot;)) &#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;保存订单!&quot;);</span><br><span class="hljs-comment">//        &#125;else&#123;</span><br><span class="hljs-comment">//            System.out.println(&quot;无权访问!&quot;);</span><br><span class="hljs-comment">//        &#125;</span><br><span class="hljs-comment">//        System.out.println(&quot;进入save方法============&quot;);</span><br><span class="hljs-comment">//        return &quot;redircet:/index.jsp&quot;;</span><br><span class="hljs-comment">//    &#125;</span><br><br>    <span class="hljs-comment">// 基于注解</span><br>    <span class="hljs-meta">@RequiresRoles(value=&#123;&quot;admin&quot;,&quot;user&quot;&#125;)</span><span class="hljs-comment">//用来判断角色  同时具有 admin user</span><br>    <span class="hljs-meta">@RequiresPermissions(&quot;user:update:01&quot;)</span> <span class="hljs-comment">//用来判断权限字符串</span><br>    <span class="hljs-meta">@RequestMapping(&quot;save&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">save</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;进入方法&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index.jsp&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="启用缓存"><a href="#启用缓存" class="headerlink" title="启用缓存"></a>启用缓存</h4><p>将用户的角色和权限保存在缓存中，不用每次都去数据库查</p><h5 id="EhCache"><a href="#EhCache" class="headerlink" title="EhCache"></a>EhCache</h5><blockquote><p>EhCache是shiro的默认缓存</p></blockquote><p><strong>导入依赖</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>设置缓存管理器</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> Realm <span class="hljs-title function_">getRealm</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 匹配器</span><br>    <span class="hljs-type">HashedCredentialsMatcher</span> <span class="hljs-variable">credentialsMatcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashedCredentialsMatcher</span>();<br>    credentialsMatcher.setHashAlgorithmName(<span class="hljs-string">&quot;md5&quot;</span>);<br>    credentialsMatcher.setHashIterations(<span class="hljs-number">1024</span>);<br>    <span class="hljs-comment">// 添加匹配器</span><br>    <span class="hljs-type">CustomerRealm</span> <span class="hljs-variable">customerRealm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomerRealm</span>();<br>    customerRealm.setCredentialsMatcher(credentialsMatcher);<br><br>    <span class="hljs-comment">// 开启缓存管理器</span><br>    customerRealm.setCacheManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EhCacheManager</span>());<br>    customerRealm.setCachingEnabled(<span class="hljs-literal">true</span>);<span class="hljs-comment">//开启缓存</span><br>    customerRealm.setAuthenticationCachingEnabled(<span class="hljs-literal">true</span>);<span class="hljs-comment">//开启认证缓存</span><br>    customerRealm.setAuthenticationCacheName(<span class="hljs-string">&quot;authentication&quot;</span>);<br>    customerRealm.setAuthorizationCachingEnabled(<span class="hljs-literal">true</span>);<span class="hljs-comment">//开启授权缓存</span><br>    customerRealm.setAuthorizationCacheName(<span class="hljs-string">&quot;authorization&quot;</span>);<br>    <span class="hljs-keyword">return</span> customerRealm;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h5><p><strong>导入依赖</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br>    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><p><strong>配置Redis</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br><span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>    <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p><strong>编写Redis缓存管理器</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.config.redis;<br><br><span class="hljs-keyword">import</span> com.xw.utils.ApplicationContextUtil;<br><span class="hljs-keyword">import</span> org.apache.shiro.cache.Cache;<br><span class="hljs-keyword">import</span> org.apache.shiro.cache.CacheException;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<br><span class="hljs-keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;<br><br><span class="hljs-keyword">import</span> java.util.Collection;<br><span class="hljs-keyword">import</span> java.util.Set;<br><br><span class="hljs-comment">//自定义redis缓存的实现</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCache</span>&lt;k,v&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cache</span>&lt;k,v&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> String cacheName;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisCache</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisCache</span><span class="hljs-params">(String cacheName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.cacheName = cacheName;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> v <span class="hljs-title function_">get</span><span class="hljs-params">(k k)</span> <span class="hljs-keyword">throws</span> CacheException &#123;<br>        <span class="hljs-keyword">return</span> (v) getRedisTemplate().opsForHash().get(<span class="hljs-built_in">this</span>.cacheName, k.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> v <span class="hljs-title function_">put</span><span class="hljs-params">(k k, v v)</span> <span class="hljs-keyword">throws</span> CacheException &#123;<br>        System.out.println(<span class="hljs-string">&quot;put key: &quot;</span>+k);<br>        System.out.println(<span class="hljs-string">&quot;put value:&quot;</span>+v);<br>        getRedisTemplate().opsForHash().put(<span class="hljs-built_in">this</span>.cacheName,k.toString(), v);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> v <span class="hljs-title function_">remove</span><span class="hljs-params">(k k)</span> <span class="hljs-keyword">throws</span> CacheException &#123;<br>        System.out.println(<span class="hljs-string">&quot;=============remove=============&quot;</span>);<br>        <span class="hljs-keyword">return</span> (v) getRedisTemplate().opsForHash().delete(<span class="hljs-built_in">this</span>.cacheName,k.toString());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> CacheException &#123;<br>        System.out.println(<span class="hljs-string">&quot;=============clear==============&quot;</span>);<br>        getRedisTemplate().delete(<span class="hljs-built_in">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().size(<span class="hljs-built_in">this</span>.cacheName).intValue();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Set&lt;k&gt; <span class="hljs-title function_">keys</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().keys(<span class="hljs-built_in">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Collection&lt;v&gt; <span class="hljs-title function_">values</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getRedisTemplate().opsForHash().values(<span class="hljs-built_in">this</span>.cacheName);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> RedisTemplate <span class="hljs-title function_">getRedisTemplate</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">RedisTemplate</span> <span class="hljs-variable">redisTemplate</span> <span class="hljs-operator">=</span> (RedisTemplate) ApplicationContextUtil.getBean(<span class="hljs-string">&quot;redisTemplate&quot;</span>);<br>        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.config.redis;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCacheManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CacheManager</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> &lt;K, V&gt; Cache&lt;K, V&gt; <span class="hljs-title function_">getCache</span><span class="hljs-params">(String cacheName)</span> <span class="hljs-keyword">throws</span> CacheException &#123;<br>        System.out.println(cacheName);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCache</span>&lt;K, V&gt;(cacheName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>开启缓存管理器的地方改成RedisCacheManager</strong></p><p><strong>simpleByteSource实现没有实现序列化，如果使用到了盐值，需要自定义盐值</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.shiro.salt;<br><br><span class="hljs-comment">//自定义salt实现 实现序列化接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyByteSource</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ByteSource</span>, Serializable &#123;<br>    <span class="hljs-keyword">private</span>  <span class="hljs-type">byte</span>[] bytes;<br>    <span class="hljs-keyword">private</span> String cachedHex;<br>    <span class="hljs-keyword">private</span> String cachedBase64;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyByteSource</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> &#123;<br>        <span class="hljs-built_in">this</span>.bytes = bytes;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyByteSource</span><span class="hljs-params">(<span class="hljs-type">char</span>[] chars)</span> &#123;<br>        <span class="hljs-built_in">this</span>.bytes = CodecSupport.toBytes(chars);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyByteSource</span><span class="hljs-params">(String string)</span> &#123;<br>        <span class="hljs-built_in">this</span>.bytes = CodecSupport.toBytes(string);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyByteSource</span><span class="hljs-params">(ByteSource source)</span> &#123;<br>        <span class="hljs-built_in">this</span>.bytes = source.getBytes();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyByteSource</span><span class="hljs-params">(File file)</span> &#123;<br>        <span class="hljs-built_in">this</span>.bytes = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyByteSource</span>.BytesHelper()).getBytes(file);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyByteSource</span><span class="hljs-params">(InputStream stream)</span> &#123;<br>        <span class="hljs-built_in">this</span>.bytes = (<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyByteSource</span>.BytesHelper()).getBytes(stream);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCompatible</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">return</span> o <span class="hljs-keyword">instanceof</span> <span class="hljs-type">byte</span>[] || o <span class="hljs-keyword">instanceof</span> <span class="hljs-type">char</span>[] || o <span class="hljs-keyword">instanceof</span> String || o <span class="hljs-keyword">instanceof</span> ByteSource || o <span class="hljs-keyword">instanceof</span> File || o <span class="hljs-keyword">instanceof</span> InputStream;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getBytes() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.bytes;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.bytes == <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.bytes.length == <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toHex</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cachedHex == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.cachedHex = Hex.encodeToString(<span class="hljs-built_in">this</span>.getBytes());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.cachedHex;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toBase64</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.cachedBase64 == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-built_in">this</span>.cachedBase64 = Base64.encodeToString(<span class="hljs-built_in">this</span>.getBytes());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.cachedBase64;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.toBase64();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.bytes != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-built_in">this</span>.bytes.length != <span class="hljs-number">0</span> ? Arrays.hashCode(<span class="hljs-built_in">this</span>.bytes) : <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (o <span class="hljs-keyword">instanceof</span> ByteSource) &#123;<br>            <span class="hljs-type">ByteSource</span> <span class="hljs-variable">bs</span> <span class="hljs-operator">=</span> (ByteSource)o;<br>            <span class="hljs-keyword">return</span> Arrays.equals(<span class="hljs-built_in">this</span>.getBytes(), bs.getBytes());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BytesHelper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CodecSupport</span> &#123;<br>        <span class="hljs-keyword">private</span> <span class="hljs-title function_">BytesHelper</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getBytes(File file) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.toBytes(file);<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getBytes(InputStream stream) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.toBytes(stream);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>把自定义Realm中认证地方的simpleByteSource改成自定义的MyByteSource</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>java并发编程（模式）</title>
    <link href="/2022/11/24/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E6%A8%A1%E5%BC%8F%EF%BC%89/"/>
    <url>/2022/11/24/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%EF%BC%88%E6%A8%A1%E5%BC%8F%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h2 id="java并发编程（模式）"><a href="#java并发编程（模式）" class="headerlink" title="java并发编程（模式）"></a>java并发编程（模式）</h2><h3 id="保护性暂停"><a href="#保护性暂停" class="headerlink" title="保护性暂停"></a>保护性暂停</h3><blockquote><p> 用一个线程等待另一个线程的执行结果</p><p> 保护性暂停是<strong>同步的</strong></p></blockquote><p><img src="/img/bingfa_img/GuardedSuspension.png"></p><p>案例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.text4&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">GuardedObject</span> <span class="hljs-variable">guardedObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuardedObject</span>();<br>        <span class="hljs-comment">// 线程1等待线程2的结果</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;等待结果&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> (String)guardedObject.get();<br>            log.debug(<span class="hljs-string">&quot;结果&quot;</span> + str);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">3000</span>);<br>                log.debug(<span class="hljs-string">&quot;产生结果&quot;</span>);<br>                guardedObject.complete(<span class="hljs-string">&quot;aaaaa&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GuardedObject</span>&#123;<br><br>    <span class="hljs-keyword">private</span> Object response;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 这里用while是为了解决虚假唤醒问题</span><br>                <span class="hljs-keyword">while</span> (response == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-built_in">this</span>.wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br><br>    <span class="hljs-comment">// 带超时时间</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>            <span class="hljs-type">long</span> <span class="hljs-variable">passedTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> (response == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> timeout - passedTime;<br>                    <span class="hljs-keyword">if</span> (waitTime &lt;= <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-built_in">this</span>.wait(waitTime);<br>                    passedTime = System.currentTimeMillis() - begin;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(Object response)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-built_in">this</span>.response = response;<br>            <span class="hljs-built_in">this</span>.notifyAll();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>保护性暂停例子</strong></p><blockquote><p>邮递员送信，居民收信</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.text4&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>            <span class="hljs-type">People</span> <span class="hljs-variable">people</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">People</span>();<br>            people.start();<br>        &#125;<br>        Thread.sleep(<span class="hljs-number">500</span>);<br>        <span class="hljs-keyword">for</span> (Integer id : Mailboxes.getIds()) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Postman</span>(id, <span class="hljs-string">&quot;内容&quot;</span> + id).start();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.People&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 收信</span><br>        <span class="hljs-type">GuardedObject</span> <span class="hljs-variable">guardedObject</span> <span class="hljs-operator">=</span> Mailboxes.createGuardedObject();<br>        log.debug(<span class="hljs-string">&quot;开始收信：&#123;&#125;&quot;</span>, guardedObject.getId());<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">mail</span> <span class="hljs-operator">=</span> guardedObject.get(<span class="hljs-number">5000</span>);<br>        log.debug(<span class="hljs-string">&quot;&#123;&#125;收到信：&#123;&#125;&quot;</span>, guardedObject.getId(), mail);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.Postman&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Postman</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> String mail;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 送信</span><br>        <span class="hljs-type">GuardedObject</span> <span class="hljs-variable">go</span> <span class="hljs-operator">=</span> Mailboxes.getGuardedObject(<span class="hljs-built_in">this</span>.id);<br>        go.complete(mail);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Postman</span><span class="hljs-params">(<span class="hljs-type">int</span> id, String mail)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.mail = mail;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Mailboxes</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Map&lt;Integer, GuardedObject&gt; boxes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hashtable</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">generateId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id++;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> GuardedObject <span class="hljs-title function_">createGuardedObject</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">GuardedObject</span> <span class="hljs-variable">go</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GuardedObject</span>(generateId());<br>        boxes.put(go.getId(), go);<br>        <span class="hljs-keyword">return</span> go;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Set&lt;Integer&gt; <span class="hljs-title function_">getIds</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> boxes.keySet();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> GuardedObject <span class="hljs-title function_">getGuardedObject</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-keyword">return</span> boxes.remove(id);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GuardedObject</span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br><br>    <span class="hljs-keyword">private</span> Object response;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GuardedObject</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">GuardedObject</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 这里用while是为了解决虚假唤醒问题</span><br>                <span class="hljs-keyword">while</span> (response == <span class="hljs-literal">null</span>)<br>                    <span class="hljs-built_in">this</span>.wait();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br><br>    <span class="hljs-comment">// 带超时时间</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>            <span class="hljs-type">long</span> <span class="hljs-variable">passedTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">while</span> (response == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">long</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> timeout - passedTime;<br>                    <span class="hljs-keyword">if</span> (waitTime &lt;= <span class="hljs-number">0</span>) &#123;<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                    <span class="hljs-built_in">this</span>.wait(waitTime);<br>                    passedTime = System.currentTimeMillis() - begin;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(Object response)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-built_in">this</span>.response = response;<br>            <span class="hljs-built_in">this</span>.notifyAll();<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="生产者-x2F-消费者"><a href="#生产者-x2F-消费者" class="headerlink" title="生产者&#x2F;消费者"></a>生产者&#x2F;消费者</h3><blockquote><p>通过消息队列实现</p><p>是<strong>异步的</strong></p></blockquote><p>案例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 消息队列</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageQueue</span> &#123;<br>    <span class="hljs-keyword">private</span> LinkedList&lt;Message&gt; list;<br>    <span class="hljs-comment">// 容量</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capcity;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MessageQueue</span><span class="hljs-params">(<span class="hljs-type">int</span> capcity)</span> &#123;<br>        list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>        <span class="hljs-built_in">this</span>.capcity = capcity;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取消息</span><br>    <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">take</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-comment">// 检查队列是否为空</span><br>            <span class="hljs-keyword">while</span> (list.isEmpty()) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;队列为空&quot;</span>);<br>                    <span class="hljs-built_in">this</span>.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 返回并删除队列第一个元素</span><br>            <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> list.removeFirst();<br>            <span class="hljs-built_in">this</span>.notifyAll();   <span class="hljs-comment">// 通知生产者</span><br>            log.debug(<span class="hljs-string">&quot;已消费&quot;</span> + msg);<br>            <span class="hljs-keyword">return</span> msg;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 放入消息</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Message msg)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">while</span> (list.size() == capcity) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;队列已满&quot;</span>);<br>                    <span class="hljs-built_in">this</span>.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            list.addLast(msg);<br>            log.debug(<span class="hljs-string">&quot;已生产&quot;</span> + msg);<br>            <span class="hljs-built_in">this</span>.notifyAll();   <span class="hljs-comment">// 通知消费者</span><br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">// 消息</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> Object value;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Message</span><span class="hljs-params">(<span class="hljs-type">int</span> id, Object value)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>        <span class="hljs-built_in">this</span>.value = value;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="顺序控制"><a href="#顺序控制" class="headerlink" title="顺序控制"></a>顺序控制</h3><blockquote><p>必须按照顺序执行代码</p><p>同步的</p></blockquote><p>案例</p><blockquote><p>顺序交替打印</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test8</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">AwaitSignal</span> <span class="hljs-variable">as</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AwaitSignal</span>(<span class="hljs-number">5</span>);<br>        <span class="hljs-type">Condition</span> <span class="hljs-variable">aWaitSet</span> <span class="hljs-operator">=</span> as.newCondition();<br>        <span class="hljs-type">Condition</span> <span class="hljs-variable">bWaitSet</span> <span class="hljs-operator">=</span> as.newCondition();<br>        <span class="hljs-type">Condition</span> <span class="hljs-variable">cWaitSet</span> <span class="hljs-operator">=</span> as.newCondition();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            as.print(<span class="hljs-string">&quot;a&quot;</span>, aWaitSet, bWaitSet);<br>        &#125;).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            as.print(<span class="hljs-string">&quot;b&quot;</span>, bWaitSet, cWaitSet);<br>        &#125;).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            as.print(<span class="hljs-string">&quot;c&quot;</span>, cWaitSet, aWaitSet);<br>        &#125;).start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        as.start(aWaitSet);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.AwaitSignal&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AwaitSignal</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReentrantLock</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> loopNum;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AwaitSignal</span><span class="hljs-params">(<span class="hljs-type">int</span> loopNum)</span> &#123;<br>        <span class="hljs-built_in">this</span>.loopNum = loopNum;<br>    &#125;<br><br>    <span class="hljs-comment">// 由主线程将第一个线程唤醒</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(Condition first)</span> &#123;<br>        <span class="hljs-built_in">this</span>.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;start&quot;</span>);<br>            first.signal();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-built_in">this</span>.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">print</span><span class="hljs-params">(String str, Condition current, Condition next)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; loopNum; i++) &#123;<br>            <span class="hljs-built_in">this</span>.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                current.await();    <span class="hljs-comment">// 先都到阻塞队列</span><br>                log.debug(str);<br>                next.signal();  <span class="hljs-comment">// 叫醒下一个线程</span><br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-built_in">this</span>.unlock();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="犹豫模式"><a href="#犹豫模式" class="headerlink" title="犹豫模式"></a>犹豫模式</h3><blockquote><p>在一个线程发现另一个线程或本线程已经做了某一件相同的事，那么本线程就无需再做 了，直接结束返回</p></blockquote><p>实例1（只启动一个监控线程）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitorService</span> &#123;<br>    <span class="hljs-comment">// 用来表示是否已经有线程已经在执行启动了</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> starting;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;尝试启动监控线程...&quot;</span>);<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">if</span> (starting) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            starting = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 真正启动监控线程...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>实例2（单例模式）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (INSTANCE != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> INSTANCE;<br>        &#125;<br>        INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="享元模式"><a href="#享元模式" class="headerlink" title="享元模式"></a>享元模式</h3><p>java中，包装类Boolean，Byte，Short，Integer，Long，Character等使用到了享元模式。调用valueOf方法时，如果值在其缓存的数组内，则直接从缓存中读取</p><p>Long的valueOf方法实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title function_">valueOf</span><span class="hljs-params">(<span class="hljs-type">long</span> l)</span> &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;<br>    <span class="hljs-keyword">if</span> (l &gt;= -<span class="hljs-number">128</span> &amp;&amp; l &lt;= <span class="hljs-number">127</span>) &#123; <span class="hljs-comment">// will cache</span><br>        <span class="hljs-keyword">return</span> LongCache.cache[(<span class="hljs-type">int</span>)l + offset];<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Long</span>(l);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>各个包装类的缓存范围</p><ul><li>Byte, Short, Long 缓存的范围都是 -128~127</li><li>Character 缓存的范围是 0~127 </li><li>Integer的默认范围是 -128~127 <ul><li>最小值不能变 </li><li>但最大值可以通过调整虚拟机参数 <code>  -Djava.lang.Integer.IntegerCache.high</code> 来改变</li></ul></li><li>Boolean 缓存了 TRUE 和 FALSE</li></ul></blockquote><p><strong>线程池小demo</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test20</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Pool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pool</span>(<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> pool.borrow();<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">1000</span>));<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                pool.free(conn);<br>            &#125;).start();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.Pool&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Pool</span> &#123;<br>    <span class="hljs-comment">// 连接池大小</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> poolSize;<br><br>    <span class="hljs-comment">// 连接对象的数组</span><br>    <span class="hljs-keyword">private</span> Connection[] connections;<br><br>    <span class="hljs-comment">// 连接状态的数组 0 表示空闲，1 表示繁忙</span><br>    <span class="hljs-keyword">private</span> AtomicIntegerArray states;<br><br>    <span class="hljs-comment">// 构造方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Pool</span><span class="hljs-params">(<span class="hljs-type">int</span> poolSize)</span> &#123;<br>        <span class="hljs-built_in">this</span>.poolSize = poolSize;<br>        <span class="hljs-built_in">this</span>.connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connection</span>[poolSize];<br>        <span class="hljs-built_in">this</span>.states = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicIntegerArray</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[poolSize]);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; poolSize; i++) &#123;<br>            connections[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockConnection</span>(<span class="hljs-string">&quot;连接&quot;</span> + i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取连接</span><br>    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">borrow</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; poolSize; i++) &#123;<br>                <span class="hljs-keyword">if</span> (states.get(i) == <span class="hljs-number">0</span>) &#123;<br>                    states.compareAndSet(i, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>                    log.debug(<span class="hljs-string">&quot;获取连接&#123;&#125;&quot;</span>, connections[i].toString());<br>                    <span class="hljs-keyword">return</span> connections[i];<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 没有空闲连接，线程进入等待状态，防止cpu空转</span><br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;等待获取连接&quot;</span>);<br>                    <span class="hljs-built_in">this</span>.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 归还连接</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">free</span><span class="hljs-params">(Connection connection)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; poolSize; i++) &#123;<br>            <span class="hljs-keyword">if</span> (connections[i] == connection) &#123;<br>                states.set(i, <span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>                    log.debug(<span class="hljs-string">&quot;归还连接&#123;&#125;&quot;</span>, connections[i].toString());<br>                    <span class="hljs-built_in">this</span>.notifyAll();<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="分工模式"><a href="#分工模式" class="headerlink" title="分工模式"></a>分工模式</h3><p>让有限的工作线程（Worker Thread）来轮流异步处理无限多的任务，它的典型实现 就是线程池，也体现了经典设计模式中的享元模式。</p><p><strong>饥饿问题</strong></p><p>如果一个线程池的线程什么都做，有可能会产生饥饿。</p><p>如一个线程调用线程池中的其他线程来完成任务，如果所有线程都处于调用其他线程的状态，而没有执行任务的线程，就会发生饥饿</p><p><strong>解决饥饿方式</strong></p><p>不同的任务类型，采用不同的线程池</p><p><strong>创建多少线程池合适</strong></p><p>线程不是越多越好，太多线程会占用大量内存，线程的上下文切换也会消耗资源</p><p>任务分为运算密集型和I&#x2F;O密集型，当运算密集型任务多的时候，应线程数较少；而I&#x2F;O密集型任务多时，应多创建线程</p><p>经验公式：<code>线程数 = 核数 * 期望 CPU 利用率 * 总时间(CPU计算时间+等待时间) / CPU 计算时间</code></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>git工作流</title>
    <link href="/2022/11/24/git/git%E5%B7%A5%E4%BD%9C%E6%B5%81/"/>
    <url>/2022/11/24/git/git%E5%B7%A5%E4%BD%9C%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h2 id="git工作流"><a href="#git工作流" class="headerlink" title="git工作流"></a>git工作流</h2><h3 id="通常"><a href="#通常" class="headerlink" title="通常"></a>通常</h3><ol><li><p>先将远程仓库的项目拉到本地</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs git">git clone &lt;仓库地址&gt;<br></code></pre></td></tr></table></figure></li><li><p>在本地<strong>新建一个自己的分支</strong></p><blockquote><p>建议在自己的branch上修改代码，而不是直接在主分支上修改</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs git">git checkout -b &lt;分支名&gt;<br>// -b 新建并且切换到新分支<br></code></pre></td></tr></table></figure></li><li><p>在自己分支上<strong>修改代码</strong></p></li><li><p>在写完代码，还没有保存到git本地仓库时，可以通过<code>git diff</code>查看修改后的代码和修改前的代码的不同</p><blockquote><p>建议先看一下修改了哪些内容再继续</p></blockquote></li><li><p>将修改的代码<strong>保存到暂存区</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs git">git status// 查看还没有保存到暂存区的文件<br>git add &lt;文件名/*&gt;// 将文件添加到暂存区，*表示所有<br></code></pre></td></tr></table></figure></li><li><p>将暂存区的代码<strong>提交到git本地仓库中</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs git">git commit -m &quot;&lt;备注信息&gt;&quot;<br></code></pre></td></tr></table></figure></li><li><p>将自己<strong>本地的分支提交到远程仓库</strong>，远程仓库会多出一个新分支</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs git">git push origin &lt;提交的远程仓库的分支名&gt;<br></code></pre></td></tr></table></figure></li></ol><hr><h3 id="当远程仓库的主分支代码有改动时"><a href="#当远程仓库的主分支代码有改动时" class="headerlink" title="当远程仓库的主分支代码有改动时"></a>当远程仓库的主分支代码有改动时</h3><blockquote><p>如果在合并自己的分支和远程仓库主分支时，远程仓库主分支的代码在之前clone下来的基础上有改动，需要同步远程仓库的代码到本地的分支里，看看会不会冲突</p></blockquote><ol start="8"><li><p>先将本地git的分支切换回主分支，再<strong>将远程仓库的代码拉到本地</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs git">git checkout main<br>git pull origin main<br></code></pre></td></tr></table></figure></li><li><p>切换到分支上，将分支上的代码和最新的代码<strong>尝试进行合并</strong></p><blockquote><p>可能会出现冲突，需要手动选择要保存的代码</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs git">git rebase main// 意思是在最新的main的基础上，将我的修改添加到main中<br></code></pre></td></tr></table></figure></li><li><p>解决完冲突后，将本地的分支推到远程仓库的分支上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs git">git push -f origin &lt;分支名&gt;<br>// -f force强行<br></code></pre></td></tr></table></figure></li></ol><hr><h3 id="远程仓库上将分支和主分支合并"><a href="#远程仓库上将分支和主分支合并" class="headerlink" title="远程仓库上将分支和主分支合并"></a>远程仓库上将分支和主分支合并</h3><ol start="11"><li><p>远程仓库主人通过pull request的squash and merge 将所有的commit合并成一个commit ，再合并到主分支上</p><p><img src="/img/git_img/pullRequest.png"></p></li><li><p>合并完，通常会删除本地分支和远程分支，再把最新的主分支拉到本地主分支</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs git">git branch -D &lt;分支名&gt;// 删除本地分支<br>git pull origin main// 把最新的主分支拉到本地主分支<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs git">删除远程分支：点击view all branchs，点击垃圾桶标识就可删除了<br></code></pre></td></tr></table></figure><p><img src="/img/git_img/viewBranchs.png"></p></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java并发编程</title>
    <link href="/2022/11/15/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"/>
    <url>/2022/11/15/java/java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="java并发编程"><a href="#java并发编程" class="headerlink" title="java并发编程"></a>java并发编程</h2><h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="1-进程和线程"><a href="#1-进程和线程" class="headerlink" title="1.进程和线程"></a>1.进程和线程</h3><p><strong>进程</strong>可以视为程序的一个实例，程序可以启动一个或多个实例进程，进程就是用来加载指令、管理内存、管理 IO 的。</p><p><strong>线程</strong>是属于进程的，一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给 CPU 执行</p><p><strong>比较</strong></p><ul><li>进程：资源分配的最小单位，线程：调度的最小单位</li><li>进程基本相互独立，线程存在于进程内，是进程的一个子集</li><li>进程间通信较为复杂（统一计算机间、不同计算机间），线程通信相对简单</li><li>线程上下文切换成本比进程低</li></ul><h3 id="2-并发和并行"><a href="#2-并发和并行" class="headerlink" title="2.并发和并行"></a>2.并发和并行</h3><p><strong>举例</strong></p><p>并发：单个CPU同一时间执行多条指令(交替)</p><p>并行：多个CPU同一时间同时执行指令</p><p>并行和并发是同时存在的</p><h3 id="3-同步和异步"><a href="#3-同步和异步" class="headerlink" title="3.同步和异步"></a>3.同步和异步</h3><p>同步：等待运行完返回结果才继续执行之后的代码</p><p>异步：不等，继续执行之后的代码</p><h3 id="4-Java线程基础"><a href="#4-Java线程基础" class="headerlink" title="4.Java线程基础"></a>4.Java线程基础</h3><h4 id="创建线程方式"><a href="#创建线程方式" class="headerlink" title="创建线程方式"></a>创建线程方式</h4><p><strong>(1)</strong> 直接new Thread()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">// 创建线程对象</span><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>() &#123;<br>        <span class="hljs-comment">// run 方法内实现要执行的任务</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;running&quot;</span>);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">// 给线程起名</span><br>    t.setName(<span class="hljs-string">&quot;t1&quot;</span>);<br>    <span class="hljs-comment">// 启动线程</span><br>    t.start();<br><br>    <span class="hljs-comment">// 主线程执行的任务</span><br>    log.debug(<span class="hljs-string">&quot;running&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 控制台</span><br><span class="hljs-comment">// 21:19:20 [main] c.Test - running</span><br><span class="hljs-comment">// 21:19:20 [t1] c.Test - running</span><br></code></pre></td></tr></table></figure><p>**(2)**Runnable 配合Thread</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>()&#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;running&quot;</span>);<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">&quot;t2&quot;</span>);<br>    t.start();<br><br>    log.debug(<span class="hljs-string">&quot;running&quot;</span>);<br>&#125;<br><span class="hljs-comment">// 控制台</span><br><span class="hljs-comment">// 21:30:56 [main] c.Test - running</span><br><span class="hljs-comment">// 21:30:56 [t2] c.Test - running</span><br></code></pre></td></tr></table></figure><ul><li>用 Runnable 更容易与线程池等高级 API 配合 </li><li>用 Runnable 让任务类脱离了 Thread 继承体系，更灵活</li></ul><p>**(3)**FutureTask配合Thread</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 实现Callable接口</span><br>    FutureTask&lt;Integer&gt; task = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureTask</span>&lt;Integer&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callable</span>&lt;Integer&gt;() &#123;<br>        <span class="hljs-comment">// Runnable的run没有返回值，而Callable的call可以有返回值</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            log.debug(<span class="hljs-string">&quot;running&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;<br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task, <span class="hljs-string">&quot;t3&quot;</span>);<br>    t3.start();<br><br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, task.get());<br>&#125;<br><span class="hljs-comment">// 控制台</span><br><span class="hljs-comment">// 21:47:12 [t3] c.Test - running</span><br><span class="hljs-comment">// 21:47:13 [main] c.Test - 100 </span><br></code></pre></td></tr></table></figure><p>FutureTask 能够接收 Callable 类型的参数，用来处理<strong>有返回结果</strong>的情况</p><h3 id="5-ThraedLocal"><a href="#5-ThraedLocal" class="headerlink" title="5.ThraedLocal"></a>5.ThraedLocal</h3><p>线程本地变量。如果你创建了一个ThreadLocal变量，那么访问 这个变量的每个线程都会有这个<strong>变量的一个本地拷贝</strong>，多个线程操作这个变量的时 候，实际是操作自己本地内存里面的变量，从而起到<strong>线程隔离</strong>的作用，避免了线程安全问题</p><p><strong>使用</strong></p><p>创建：new</p><p>存储：set</p><p>获取：get</p><p><strong>使用场景</strong></p><p>存储用户token、数据库连接池存储Connection（保证当前线程用的是同一个连接对象）</p><p><strong>原理</strong></p><p>每个线程都有个ThreadLocalMap来存储ThreadLocal（的弱引用）和value之间的映射关系</p><p>ThreadLocal本身不存值，只是作为key来往map中存值</p><p>哈希冲突时用开放定址法来解决哈希冲突</p><p>当清理完过期的Entry后元素数量超过75%会进行扩容</p><blockquote><p>弱引用：只有弱引用的对象被垃圾回收器扫到后会被回收</p><p>这里只会回收ThreadLocal，而value回收不到，有内存泄漏的风险</p><p>解决方式：不用了remove()掉</p></blockquote><h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><h3 id="5-查看进程方式"><a href="#5-查看进程方式" class="headerlink" title="5.查看进程方式"></a>5.查看进程方式</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a><strong>windows</strong></h4><ul><li>任务管理器</li><li><code>tasklist</code> 查看所有进程， 可以<code>tasklist | findstr &lt;关键字&gt;</code>来筛选进程</li><li><code>taskkill</code>杀死进程， 参数：<code>/F /PID &lt;pid&gt;</code> 强制杀死指定pid的进程</li></ul><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a><strong>linux</strong></h4><ul><li><code>ps -ef</code> 查看所有进程</li><li><code>ps -fT -p &lt;PID&gt;</code>查看进程号为PID的所有线程</li><li><code>kill</code>杀死进程</li><li><code>top</code> 动态显示进程，按H切换是否显示进程</li><li><code>top -H -p &lt;PID&gt;</code> 查看进程号为PID的所有线程</li></ul><h4 id="java（jdk自带的"><a href="#java（jdk自带的" class="headerlink" title="java（jdk自带的)"></a><strong>java（jdk自带的)</strong></h4><ul><li><p><code>jps</code>(java process status) 查看所有java进程</p></li><li><p><code>jstack &lt;PID&gt;</code> 查看某一时刻该进程的所有线程状态</p></li><li><p><code>jconsole</code> 来查看某个 Java 进程中线程的运行情况（图形界面）</p><p><img src="/img/bingfa_img/jconsole%E7%95%8C%E9%9D%A2.png"></p></li></ul><h3 id="6-线程运行"><a href="#6-线程运行" class="headerlink" title="6.线程运行"></a>6.线程运行</h3><h4 id="栈和栈帧"><a href="#栈和栈帧" class="headerlink" title="栈和栈帧"></a><strong>栈和栈帧</strong></h4><ul><li>JVM中由堆、<strong>栈</strong>和方法区组成。每个线程启动后，虚拟机就会为其分配一块<strong>栈内存</strong></li><li>线程栈是相互独立的，每个线程栈由多个<strong>栈帧</strong>（Frame）组成，对应每次方法调用时占用的内存（局部变量表、返回地址等）</li><li>每个线程只能有一个<strong>活动栈帧</strong>，对应当前正在执行的那个方法</li></ul><h4 id="上下文切换"><a href="#上下文切换" class="headerlink" title="上下文切换"></a><strong>上下文切换</strong></h4><p>导致CPU切换线程的原因</p><ul><li>线程的cpu时间片用完</li><li>垃圾回收时会停止所有线程，转而运行垃圾回收的线程</li><li>来了优先级更高的线程</li><li>当前线程自己休眠了等</li></ul><p>切换时需要保存当前线程的状态（局部变量、操作数栈、返回地址等）</p><p><strong>频繁切换会影响性能</strong></p><h4 id="线程常见方法"><a href="#线程常见方法" class="headerlink" title="线程常见方法"></a>线程常见方法</h4><p><img src="/img/else_img/%E7%BA%BF%E7%A8%8B%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95.png"></p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>public void start()</td><td>启动一个新线程，Java虚拟机调用此线程的 run 方法</td></tr><tr><td>public void run()</td><td>线程启动后调用该方法</td></tr><tr><td>public void setName(String name)</td><td>给当前线程取名字</td></tr><tr><td>public void getName()</td><td>获取当前线程的名字 线程存在默认名称：子线程是 Thread-索引，主线程是 main</td></tr><tr><td>public static Thread currentThread()</td><td>获取当前线程对象，代码在哪个线程中执行</td></tr><tr><td>public static void sleep(long time)</td><td>让当前线程休眠多少毫秒再继续执行 <strong>Thread.sleep(0)</strong> : 让操作系统立刻重新进行一次 CPU 竞争</td></tr><tr><td>public static native void yield()</td><td>提示线程调度器让出当前线程对 CPU 的使用</td></tr><tr><td>public final int getPriority()</td><td>返回此线程的优先级</td></tr><tr><td>public final void setPriority(int priority)</td><td>更改此线程的优先级，常用 1 5 10</td></tr><tr><td>public void interrupt()</td><td>中断这个线程，异常处理机制</td></tr><tr><td>public static boolean interrupted()</td><td>判断当前线程是否被打断，清除打断标记</td></tr><tr><td>public boolean isInterrupted()</td><td>判断当前线程是否被打断，不清除打断标记</td></tr><tr><td>public final void join()</td><td>等待这个线程结束</td></tr><tr><td>public final void join(long millis)</td><td>等待这个线程死亡 millis 毫秒，0 意味着永远等待</td></tr><tr><td>public final native boolean isAlive()</td><td>线程是否存活（还没有运行完毕）</td></tr><tr><td>public final void setDaemon(boolean on)</td><td>将此线程标记为守护线程或用户线程</td></tr></tbody></table><h5 id="run-start"><a href="#run-start" class="headerlink" title="run start"></a><strong>run start</strong></h5><ul><li>直接调用run方法相当于在当前线程中进行了普通的方法调用，</li><li>使用start方法则为启动新的线程，通过新的线程执行run中的代码</li></ul><h5 id="sleep-yield"><a href="#sleep-yield" class="headerlink" title="sleep yield"></a><strong>sleep yield</strong></h5><p>sleep</p><blockquote><p> 调用 sleep 会让当前线程<strong>从 Running 进入 Timed Waiting 状态</strong>（阻塞）</p><p>当睡眠时间结束后状态为Runnable</p><p>可以使用TimeUnit的sleep来使线程睡眠（可以更好的看出时间单位）</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-string">&quot;t1&quot;</span>) &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;;<br><br>    t1.start();<br>    <span class="hljs-comment">// t1状态为RUNNABLE</span><br>    log.debug(<span class="hljs-string">&quot;t1 state: &#123;&#125;&quot;</span>, t1.getState());<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-comment">// t1线程调用sleep方法，状态从RUNNING -&gt; Waiting</span><br>    log.debug(<span class="hljs-string">&quot;t1 state: &#123;&#125;&quot;</span>, t1.getState());<br>&#125;<br></code></pre></td></tr></table></figure><p>yields</p><blockquote><p>会让当前线程<strong>从 Running 进入 Runnable</strong> 就绪状态</p></blockquote><p><strong>线程优先级</strong></p><blockquote><p>通过<strong>setPriority</strong>设置线程优先级，但只是给调度器的参考</p><p>最终如何分配时间片还是由调度器决定</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task1</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            System.out.println(<span class="hljs-string">&quot;----&gt;1 &quot;</span> + count++);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-type">Runnable</span> <span class="hljs-variable">task2</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (;;) &#123;<br>            <span class="hljs-comment">// Thread.yield();</span><br>            System.out.println(<span class="hljs-string">&quot;       ----&gt;2 &quot;</span> + count++);<br>        &#125;<br>    &#125;;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task1, <span class="hljs-string">&quot;t1&quot;</span>);<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(task2, <span class="hljs-string">&quot;t2&quot;</span>);<br>    t1.setPriority(Thread.MIN_PRIORITY);<br>    t2.setPriority(Thread.MAX_PRIORITY);<br>    t1.start();<br>    t2.start();<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="join"><a href="#join" class="headerlink" title="join"></a><strong>join</strong></h5><blockquote><p>join()等待这个线程结束</p><p>join(long n) 最多等待n秒</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;开始&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        r = <span class="hljs-number">10</span>;<br>        log.debug(<span class="hljs-string">&quot;结束&quot;</span>);<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>    t1.start();<br>    t1.join();  <span class="hljs-comment">// 等待t1结束后继续执行后面的代码</span><br>    <span class="hljs-comment">// t1.join(1000); r: 0</span><br>    log.debug(<span class="hljs-string">&quot;r: &#123;&#125;&quot;</span>, r);  <span class="hljs-comment">// r: 10</span><br>    log.debug(<span class="hljs-string">&quot;结束&quot;</span>);<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt"></a><strong>interrupt</strong></h5><blockquote><p>打断正在运行的线程</p><ul><li><p>打断只是通知要被打断的线程，将isInterrupted置为true</p><p>是否结束线程由被打断线程自己判断（两阶段终止模式）</p></li><li><p>stop方法强制终止线程（不推荐）</p></li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 打断睡眠中的线程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;sleep..&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">50000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            log.debug(<span class="hljs-string">&quot;被打断&quot;</span>);<br>            e.printStackTrace();<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    t1.start();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    log.debug(<span class="hljs-string">&quot;interrupt&quot;</span>);<br>    t1.interrupt();<br>    <span class="hljs-comment">// 打断正常运行的线程，打断标记为true，</span><br>    <span class="hljs-comment">// 打断正在睡眠的线程，打断标记为false</span><br>    log.debug(<span class="hljs-string">&quot;打断标记：&#123;&#125;&quot;</span>, t1.isInterrupted());<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 打断正常线程</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">if</span> (Thread.currentThread().isInterrupted()) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    t1.start();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    log.debug(<span class="hljs-string">&quot;interrupt&quot;</span>);<br>    t1.interrupt();<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="wait-notify"><a href="#wait-notify" class="headerlink" title="wait notify"></a>wait notify</h5><blockquote><p><strong>wait</strong> 让当前线程进入<strong>WaitSet</strong>，变为<strong>WAITING</strong>状态</p><p>当Owner线程调用<strong>notify</strong>时会唤醒wait的线程中的一个，并让其进入阻塞队列来竞争锁</p><p><strong>notifyAll</strong>会唤醒wait的所有线程</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;t1被唤醒&quot;</span>);<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    lock.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;t2被唤醒&quot;</span>);<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>        t1.start();<br>        t2.start();<br><br>        Thread.sleep(<span class="hljs-number">2000</span>);<br>        <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>            lock.notify();  <span class="hljs-comment">// 唤醒一个等待的线程</span><br>            <span class="hljs-comment">// lock.notifyAll();  // 唤醒所有等待的线程</span><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><ul><li>sleep和wait区别：wait会让出锁，sleep是抱着锁睡觉</li><li>如果有多个wait的线程，可能唤醒的不是想要唤醒的线程（虚假唤醒）</li></ul><p>park unpark</p><blockquote><p>LockSupport.park() 暂停当前线程</p><p>LockSupport.unpark(线程对象) 恢复当前线程</p></blockquote><blockquote><p>和wait notify区别：</p><ol><li>wait notify需要获得锁对象，park unpark 不需要</li><li>park unpark是以线程为单位来阻塞和唤醒线程，比wait notify精确</li><li>park unpark 可以先 unpark，而 wait &amp; notify 不能先 notify</li></ol></blockquote><blockquote><p>park unpark 原理：</p><p>每个线程都有自己的一个 Parker 对象，由三部分组成 _counter ， _cond 和 _mutex </p><p>调用park() 就是检查_counter是否为0，为0则进入wait状态；为1则置为0，下次再park时则进入wait状态</p><p>调用park()就是置_counter为1</p><ul><li><p>当线程处于wait状态时，调用unpark，_counter置为1，可以唤醒线程，线程继续执行需要消耗一个_counter</p></li><li><p>当线程处于运行状态时，调用unpark，_counter置为1，线程继续运行</p></li></ul></blockquote> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;start...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>            log.debug(<span class="hljs-string">&quot;park&quot;</span>);<br>            LockSupport.park(); <span class="hljs-comment">// WAIT</span><br>            log.debug(<span class="hljs-string">&quot;resume...&quot;</span>);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        t1.start();<br><br>        Thread.sleep(<span class="hljs-number">2000</span>);<br>        log.debug(<span class="hljs-string">&quot;unpark...&quot;</span>);<br>        LockSupport.unpark(t1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="主线程和守护线程"><a href="#主线程和守护线程" class="headerlink" title="主线程和守护线程"></a>主线程和守护线程</h4><ul><li>默认情况Java进程需要等所有线程都运行结束，进程才会结束</li><li>而不需要等待守护线程，技术守护线程没有执行完，也会强制结束</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">if</span> (Thread.currentThread().isInterrupted())<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        log.debug(<span class="hljs-string">&quot;t1结束&quot;</span>);<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    t1.setDaemon(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 设置进程为守护进程</span><br>    t1.start();<br><br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    log.debug(<span class="hljs-string">&quot;main结束&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h4><p><img src="/img/bingfa_img/6%E7%A7%8D%E7%BA%BF%E7%A8%8B%E7%8A%B6%E6%80%81.png"></p><ol><li>调用**start()**，NEW –&gt; RUNNABLE</li><li>获取到对象锁obj后<ul><li>调用**obj.wait()**，RUNNABLE –&gt; WAITING</li><li>其他线程调用**obj.notify()&#x2F;notifyAll()&#x2F;interrupt()**，线程从WAITTING中被唤醒到BLOCKED<ul><li>竞争锁成功，WATTING –&gt; RUNNABLE</li><li>竞争锁失败，WAITTING –&gt; BLOCKED</li></ul></li></ul></li><li>当前线程调用**t.join()**（当前线程在t线程的管程上等待），从RUNNABLE –&gt; WAITTING<ul><li>t线程运行结束或调用当前线程的interrupt()，当前线程从WAITTING –&gt; RUNNABLE</li></ul></li><li>调用<strong>LockSupport.park()</strong>,RUNNABLE –&gt; WAITTING<ul><li>调用**LockSupport.unpark(目标线程)**，目标线程WAITTING –&gt; RUNNABLE</li></ul></li><li>获取到对象锁obj后<ul><li>调用**obj.wait(long n)**，RUNNABLE –&gt; TIME_WAITING</li><li>等待时间超过n毫秒，或其他线程调用<strong>obj.notify()&#x2F;notifyAll()&#x2F;interrupt()</strong><ul><li>竞争锁成功，TIME_WAITING–&gt; RUNNABLE</li><li>竞争锁失败，TIME_WAITING–&gt; BLOCKED</li></ul></li></ul></li><li>当前线程调用**t.join(long n)**（当前线程在t线程的管程上等待），从RUNNABLE –&gt; TIME_WAITING<ul><li>等待时间超过n毫秒，或t线程运行结束或调用当前线程的interrupt()，当前线程从TIME_WAITING–&gt; RUNNABLE</li></ul></li><li>当前线程调用 <strong>Thread.sleep(long n)</strong> ，当前线程从 RUNNABLE –&gt; TIMED_WAITING<ul><li>等待时间超过n毫秒，当前线程从TIME_WAITING–&gt; RUNNABLE</li></ul></li><li>调用<strong>LockSupport.parkNanos(long nanos)</strong>,RUNNABLE –&gt; TIME_WAITING<ul><li>等待时间超过nanos纳秒，或调用**LockSupport.unpark(目标线程)**，目标线程TIME_WAITING–&gt; RUNNABLE</li></ul></li><li>竞争锁成功，BLOCKED –&gt; RUNNABLE；失败仍然BLOCKED</li><li>代码运行完毕，RUNNABLE –&gt; TERMINATED</li></ol><h2 id="共享"><a href="#共享" class="headerlink" title="共享"></a>共享</h2><h3 id="共享带来的问题"><a href="#共享带来的问题" class="headerlink" title="共享带来的问题"></a>共享带来的问题</h3><p>例如java中对静态变量的自增、自减不是原子操作，在字节码上被分为了四步</p><p>获取变量值、准备常数、相加、写回</p><p>当要<strong>写</strong>回的时候若时间片用完，则可能造成数据的错误</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            counter++;<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            counter--;<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>    t1.start();<br>    t2.start();<br>    t1.join();<br>    t2.join();<br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, counter);<span class="hljs-comment">//counter因为共享问题而可能不为0</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h4><p>一段代码块内如果存在对共享资源的多线程读写操作，称这段代码块为<strong>临界区</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> <br><span class="hljs-comment">// 临界区</span><br>&#123; <br> counter++;<br>&#125;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrement</span><span class="hljs-params">()</span> <br><span class="hljs-comment">// 临界区</span><br>&#123; <br> counter--;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="竞态条件"><a href="#竞态条件" class="headerlink" title="竞态条件"></a>竞态条件</h4><p>多个线程在临界区内执行，由于代码的执行序列不同而导致结果无法预测，称之为发生了<strong>竞态条件</strong></p><p> 即基于一种可能的实效的观察结果来做出判断或执行某个计算（先检查后执行）</p><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>阻塞式解决方案：synchronized、Lock</p><p>非阻塞式解决方案：原子变量</p><h4 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h4><p>即<strong>对象锁</strong>，采用<strong>互斥</strong>的方式，让同一时刻只有一个线程持有锁，其他对象则为<strong>阻塞状态</strong>，</p><p>这样就能保证拥有锁 的线程可以安全的执行临界区内的代码，不用担心线程上下文切换</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                counter++;<br>            &#125;<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                counter--;<br>            &#125;<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>    t1.start();<br>    t2.start();<br>    t1.join();<br>    t2.join();<br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, counter);<span class="hljs-comment">//counter值为0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>synchronized用对象锁保证了临界区内的<strong>原子性</strong></p><p><strong>面向对象改进</strong></p><p>把要保护的共享变量封装到一个类中，类的操作是原子性的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Room</span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            counter++;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrement</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            counter--;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCounter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>            <span class="hljs-keyword">return</span> counter;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Room</span> <span class="hljs-variable">room</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Room</span>();<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            room.increment();<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5000</span>; i++) &#123;<br>            room.decrement();<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br><br>    t1.start();<br>    t2.start();<br>    t1.join();<br>    t2.join();<br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, room.getCounter());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>方法上使用synchronized</strong></p><p>在成员方法上使用synchronized相当于锁住了<strong>this</strong>（实例化后的对象）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        counter++;<br>    &#125;<br>&#125;<br><span class="hljs-comment">// 等价于</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> &#123;<br>    counter++;<br>&#125;<br></code></pre></td></tr></table></figure><p>在静态方法上使用synchronized相当于锁住了<strong>类对象</strong>（内存中独一份）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>     &#125;<br>&#125;<br><span class="hljs-comment">// 等价于</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span>&#123;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>         <span class="hljs-keyword">synchronized</span>(Test.class) &#123;<br><br>         &#125;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h4><blockquote><p>在后面</p></blockquote><h3 id="变量的线程安全"><a href="#变量的线程安全" class="headerlink" title="变量的线程安全"></a>变量的线程安全</h3><p>成员变量和静态变量</p><ul><li>没有共享，线程安全</li><li>有被共享，只读，线程安全</li><li>有被共享，读写，线程不安全</li></ul><p>局部变量</p><ul><li>局部变量引用的是<strong>常量</strong>，是线程安全</li><li>但局部变量引用的是<strong>对象</strong>，若逃离方法的作用范围，则线程不安全，可以使用private或final关键字使局部变量线程安全</li></ul><h3 id="常见线程安全的类"><a href="#常见线程安全的类" class="headerlink" title="常见线程安全的类"></a>常见线程安全的类</h3><p>多个线程调用它们同一个实例的某个方法时，是线程安全的</p><ul><li>String</li><li>Integer</li><li>StringBuffer</li><li>Random</li><li>Vector</li><li>Hashtable</li><li>java.util.concurrent包吓得类</li></ul><h3 id="线程安全例子"><a href="#线程安全例子" class="headerlink" title="线程安全例子"></a>线程安全例子</h3><p>转账</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Account</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-number">1000</span>);<br>        <span class="hljs-type">Account</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-number">1000</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>                a.transfer(b, randomAmount());<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>                b.transfer(a, randomAmount());<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br>        t1.start();<br>        t2.start();<br>        t1.join();<br>        t2.join();<br>        <span class="hljs-comment">// 查看转账2000次后的总金额</span><br>        log.debug(<span class="hljs-string">&quot;total:&#123;&#125;&quot;</span>, (a.getMoney() + b.getMoney()));<br>    &#125;<br><br>    <span class="hljs-comment">// Random 为线程安全</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>    <span class="hljs-comment">// 随机 1~100</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">randomAmount</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> random.nextInt(<span class="hljs-number">100</span>) + <span class="hljs-number">1</span>;<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> money;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(<span class="hljs-type">int</span> money)</span> &#123;<br>        <span class="hljs-built_in">this</span>.money = money;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMoney</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> money;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMoney</span><span class="hljs-params">(<span class="hljs-type">int</span> money)</span> &#123;<br>        <span class="hljs-built_in">this</span>.money = money;<br>    &#125;<br><br>    <span class="hljs-comment">// 这个方法存在线程安全问题</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span>  <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.money &gt; amount) &#123;<br>            <span class="hljs-built_in">this</span>.setMoney(<span class="hljs-built_in">this</span>.getMoney() - amount);<br>            target.setMoney(target.getMoney() + amount);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>不能通过锁this来解决，因为有两个不同的实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> &#123;<br>    <span class="hljs-comment">// 通过锁类对象来实现线程安全</span><br>    <span class="hljs-keyword">synchronized</span> (Account.class) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.money &gt; amount) &#123;<br>            <span class="hljs-built_in">this</span>.setMoney(<span class="hljs-built_in">this</span>.getMoney() - amount);<br>            target.setMoney(target.getMoney() + amount);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><h4 id="java对象头"><a href="#java对象头" class="headerlink" title="java对象头"></a>java对象头</h4><p>对象在内存中可以分为三部分：<strong>对象头、实例数据、对齐填充</strong></p><ul><li><p>对象头：如hash码,对象所属的年代，对象锁，锁状态标志，偏向锁（线程）ID，偏向时间等,32位机器里Java对象头一般占有2个机器码</p></li><li><p>实例数据：存放类的属性数据信息，包括父类的属性对象</p></li><li><p>对齐填充：使字节对齐，非必须</p></li></ul><p><img src="/img/bingfa_img/java%E5%A4%B4%E5%AF%B9%E8%B1%A11.png"></p><p><img src="/img/bingfa_img/java%E5%A4%B4%E5%AF%B9%E8%B1%A12.png"></p><h4 id="锁升级"><a href="#锁升级" class="headerlink" title="锁升级"></a>锁升级</h4><blockquote><p> 无锁 –&gt; 偏向锁 –&gt; 轻量级锁 –&gt; 重量级锁</p></blockquote><p>升级过程：</p><ol><li><p>线程不多。竞争少时，<strong>偏向锁</strong></p></li><li><p>获取锁时发现Mark Word中不是当前线程ID，CAS自旋获取锁</p><ul><li><p>获取成功，改为当前线程ID，执行代码</p></li><li><p>获取失败，锁升级为<strong>轻量级锁</strong></p></li></ul></li><li><p>一个线程获取了轻量级锁，另一个线程尝试获取锁并自旋后仍失败，锁升级为<strong>重量级锁</strong></p></li></ol><h4 id="Monitor（重量级锁）原理"><a href="#Monitor（重量级锁）原理" class="headerlink" title="Monitor（重量级锁）原理"></a>Monitor（重量级锁）原理</h4><blockquote><p>锁的类型有：无锁、偏向锁、轻量级锁、重量级锁</p></blockquote><p>如果使用synchronized给对象上锁（<strong>重量级</strong>）后，该对象头的<strong>Mark word</strong>中就被设置指向<strong>Monitor对象</strong>的指针。（原来Mark Word中的信息被放到了Monitor对象中）</p><p><img src="/img/bingfa_img/Monitor%E5%8E%9F%E7%90%86.png"></p><ul><li>Monitor只能有一个Owner</li><li>在对象被上锁后，其他线程执行synchronized(obj)就会进入阻塞队列</li><li>当Owner执行完代码块的内容后，会唤醒在阻塞队列中的线程，竞争线程时非公平的，由调度器决定</li><li>synchronized 必须是进入同一个对象的 monitor 才有上述的效果</li><li>不加 synchronized 的对象不会关联监视器，不遵从以上规则</li></ul><h4 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h4><blockquote><p>轻量级锁只是告诉其他线程有线程在用这个资源。</p><p>如果线程在加轻量级锁的过程中发现已经被上了轻量级锁，则会从轻量级锁转化为重量级锁</p></blockquote><p>使用场景：如果一个对象虽然有多线程要加锁，但加锁的时间是错开的（也就是没有竞争），那么可以 使用轻量级锁来优化</p><p>加轻量级锁对使用者是透明的，语法和加重量级锁一样</p><p>内部实现过程：</p><ul><li><p>创建锁记录（Lock Record）对象，每个线程都的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的 Mark Word</p><p><img src="/img/bingfa_img/%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%811.png"></p></li><li><p>让锁记录中 Object reference 指向锁对象，并尝试用 cas <strong>替换 Object 的 Mark Word，将 Mark Word 的值存 入锁记录</strong></p><p><img src="/img/bingfa_img/%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%812.png"></p></li><li><p>如果 cas 替换成功，对象头中存储了 锁记录地址和状态 00 ，表示由该线程给对象加锁，这时图示如下</p><p><img src="/img/bingfa_img/%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%813.png"></p></li><li><p>如果 cas 失败，有两种情况</p><ul><li>如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程 </li><li>如果是自己执行了 synchronized <strong>锁重入</strong>，那么再添加一条 Lock Record 作为重入的计数</li></ul><p><img src="/img/bingfa_img/%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%814.png"></p></li><li><p>当退出 synchronized 代码块（解锁时）如果有取值为 null 的锁记录，表示有重入，这时重置锁记录，表示重 入计数减一</p><p><img src="/img/bingfa_img/%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%815.png"></p></li><li><p>当退出 synchronized 代码块（解锁时）锁记录的值不为 null，这时使用 cas 将 Mark Word 的值恢复给对象头</p><ul><li>成功，则解锁成功 </li><li>失败，说明轻量级锁进行了锁膨胀或已经升级为重量级锁，进入重量级锁解锁流程</li></ul></li></ul><h5 id="锁膨胀"><a href="#锁膨胀" class="headerlink" title="锁膨胀"></a>锁膨胀</h5><blockquote><p>如果在尝试加轻量级锁的过程中，CAS 操作无法成功，这时一种情况就是有其它线程为此对象加上了轻量级锁（有竞争），这时需要进行锁膨胀，将轻量级锁变为重量级锁。</p></blockquote><p>锁对象的Mark word会指向Monitor对象  </p><p>原本给其上锁的线程需要找到Monitor对象来释放锁</p><h5 id="自旋优化"><a href="#自旋优化" class="headerlink" title="自旋优化"></a>自旋优化</h5><p>相当于对象已经被上锁，后来的线程先不进入阻塞队列（进入阻塞队列是重型操作，耗时），而是重试几次对对象的上锁（自旋），如果这时锁被释放，则上锁成功（自旋成功）。否则则自旋失败，进入阻塞队列</p><p>注意：</p><ul><li>自旋会占用CPU时间，多核CPU自旋才能发挥优势</li><li>自旋是自适应的（成功的次数多则多自旋几次，反之则减少次数）</li></ul><h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h4><blockquote><p>偏向属于某个线程</p><p>当线程数目不多的时候，由于反复获取锁会使得我们的运行效率下降，于是出现了偏向级锁</p></blockquote><p>轻量级锁的问题在于，在没有线程竞争时，每次重入都需要添加锁记录。</p><p>偏向锁则在第一次CAS时将<strong>线程 ID</strong> 设置到对象的 Mark Word 头，<strong>之后发现这个线程 ID是自己的就表示没有竞争，不用重新 CAS</strong>。以后只要不发生竞争，这个对象就归该线程所有</p><ul><li>偏向锁默认开启，且默认有开启延迟，禁用延迟：<code>-XX:BiasedLockingStartupDelay=0</code></li><li>禁用偏向锁<code>-XX:-UseBiasedLocking </code></li></ul><p>可以用jol查看对象头</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--查看java头对象--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Dog</span> <span class="hljs-variable">dog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br>        log.debug(ClassLayout.parseInstance(dog).toPrintable());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/bingfa_img/jol.png"></p><p>注意;</p><ul><li>处于偏向锁的对象解锁后，线程 id 仍存储于对象头中</li><li>正常状态对象一开始是没有 hashCode 的，第一次调用才生成；如果<strong>调用 hashCode 会导致偏向锁被撤销</strong></li></ul><h5 id="批量重偏向"><a href="#批量重偏向" class="headerlink" title="批量重偏向"></a>批量重偏向</h5><p>重偏向是以类为单位</p><p>如果对象被多个线程访问，但没有竞争，偏向线程T1的对象仍有可能重新偏向到线程T2，重偏向会重置对象 的 Thread ID</p><p>当这个class类型的实例对象撤销达到<strong>20</strong>次后，会执行批量重偏向，所有这个类的实例都会指向新的线程</p><h5 id="批量撤销"><a href="#批量撤销" class="headerlink" title="批量撤销"></a>批量撤销</h5><p>当撤销偏向锁阈值<strong>超过</strong> <strong>40</strong> 次后，jvm认为在明显多线程竞争剧烈的场景下使用偏向锁是不合适的，整个类的<strong>所有对象</strong>都会变为不可偏向的</p><h4 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h4><p>锁消除是发生在编译器级别的<strong>一种锁优化方式</strong></p><p>如果局部对象只在方法的作用域中有效（没有发生逃逸），不同线程调用时使用的都是不同的对象，使用锁就只会白白浪费资源</p><p>这时编译器将其优化，将锁消除</p><ul><li>关闭锁消除<code>java -XX:-EliminateLocks -jar benchmarks.jar</code></li></ul><h3 id="多把锁"><a href="#多把锁" class="headerlink" title="多把锁"></a>多把锁</h3><p>案例</p><blockquote><p>将锁细分，增加并发度</p><p>如果一个线程需要同时获取多把锁，容易发生死锁</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Test6&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br><br>        <span class="hljs-type">BigRoom</span> <span class="hljs-variable">bigRoom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigRoom</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            bigRoom.study();<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            bigRoom.sleep();<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br><br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.BigRoom&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BigRoom</span> &#123;<br><br>    <span class="hljs-comment">// 多把锁</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">studyRoom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">sleepRoom</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (sleepRoom) &#123;<br>            log.debug(<span class="hljs-string">&quot;sleeping...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">study</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (studyRoom) &#123;<br>            log.debug(<span class="hljs-string">&quot;study...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="活跃性"><a href="#活跃性" class="headerlink" title="活跃性"></a>活跃性</h3><h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><blockquote><p>两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种<strong>阻塞</strong></p><p>代表性问题：哲学家进餐</p></blockquote><p><strong>死锁产生的条件</strong></p><ol><li><strong>互斥</strong>：一个资源一次只能给一个线程使用</li><li><strong>不可剥夺</strong>：资源只能由资源持有者释放</li><li><strong>请求和保持</strong>：进程申请它所需的一部分资源，并继续占用以获取的资源</li><li><strong>循环等待</strong>：多个线程都有一些资源，但所需的另一部分资源被其他线程占了，形成一个等待的环</li></ol><p> <strong>避免死锁</strong></p><p>至少破坏死锁产生的其中一个条件</p><h4 id="定位死锁"><a href="#定位死锁" class="headerlink" title="定位死锁"></a>定位死锁</h4><p><strong>方法1：</strong></p><ul><li><p>先使用jps查看进程</p></li><li><p>再使用jstack &lt;进程号&gt; 查看具体线程</p></li><li><p>如果有死锁，打印信息中会有<code>Found one Java-level deadlock:</code></p></li></ul><p><strong>方法2：</strong></p><ul><li>打开<code>jdk/bin</code>目录下的<code>jconsole.exe</code>工具</li><li>连接上进程</li><li>查看线程，点击检测死锁，就会把有死锁的线程展示出来</li></ul><h4 id="活锁"><a href="#活锁" class="headerlink" title="活锁"></a>活锁</h4><blockquote><p>活锁出现在两个线程互相改变对方的结束条件，最后谁也无法结束</p><p>和死锁的区别：出现死锁，线程都被阻塞住了；出现活锁：线程仍在运行，但始终结束不了</p></blockquote><p>实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test8</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// 期望减到 0 退出循环</span><br>            <span class="hljs-keyword">while</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">200</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                count--;<br>                log.debug(<span class="hljs-string">&quot;count: &#123;&#125;&quot;</span>, count);<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// 期望超过 20 退出循环</span><br>            <span class="hljs-keyword">while</span> (count &lt; <span class="hljs-number">20</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">200</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                count++;<br>                log.debug(<span class="hljs-string">&quot;count: &#123;&#125;&quot;</span>, count);<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="饥饿"><a href="#饥饿" class="headerlink" title="饥饿"></a>饥饿</h4><blockquote><p>由于优先级太低，始终得不到CPU调度执行，也无法结束</p></blockquote><h4 id="ReentrantLock-1"><a href="#ReentrantLock-1" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h4><blockquote><p>可重入锁</p><p>可重入：同一个线程首次获得线程后还没有释放，第二次申请锁不会被挡住</p><p>不可重入：第二次申请锁会把自己也挡在外面</p></blockquote><p>相较于synchronized，具备如下特点：</p><ul><li>可中断</li><li>可设置超时时间</li><li>可设置为公平锁</li><li>支持多个条件变量（多个阻塞队列，不同条件而阻塞的进不同的阻塞队列）</li></ul><p><strong>可打断</strong></p><blockquote><p>使用方法**lockInterruptibly()**方法加可打断的锁</p><p>lock()方法加的是不可打断的锁</p></blockquote><p>实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 如果没有竞争那么此方法就会获得lock锁</span><br>                <span class="hljs-comment">// 否则就会进入阻塞队列</span><br>                lock.lockInterruptibly();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>                log.debug(<span class="hljs-string">&quot;被打断了&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;获取到锁&quot;</span>);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>        lock.lock();<br>        t1.start();<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        t1.interrupt(); <span class="hljs-comment">// 打断</span><br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>可设置超时时间</strong></p><blockquote><p>带超时时间的申请锁，解决死锁问题</p><p><strong>tryLock()、tryLock(long timeout, TimeUnit unit)</strong></p><p>只尝试获取一次锁，在timeout时间内都会尝试获取锁</p></blockquote><p>案例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;启动。。。&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (!lock.tryLock(<span class="hljs-number">2</span>, TimeUnit.SECONDS)) &#123;<br>                log.debug(<span class="hljs-string">&quot;获取锁失败&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;获取到锁&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br><br>    log.debug(<span class="hljs-string">&quot;获取到锁&quot;</span>);<br>    lock.lock();<br><br>    t1.start();<br>    <span class="hljs-keyword">try</span> &#123;<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>        lock.unlock();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>可设置为公平锁</strong></p><blockquote><p>不公平锁：获取锁的顺序和来的顺序无关</p><p>公平锁：先来先得</p><p>公平锁一般没有必要，会降低并发度</p></blockquote><p>公平锁默认关闭。开启公平锁</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>(<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p><strong>支持多个条件变量</strong></p><blockquote><p>多个不同的阻塞队列</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建阻塞队列</span><br><span class="hljs-type">Condition</span> <span class="hljs-variable">condition</span> <span class="hljs-operator">=</span> lock.newCondition();<br><span class="hljs-comment">// 进入阻塞队列等待</span><br>condition.await();<br><span class="hljs-comment">// 唤醒这个阻塞队列中等待的线程</span><br>condition.signal();<br><span class="hljs-comment">// 唤醒这个阻塞队列中所有的线程</span><br>condition.signalAll();<br></code></pre></td></tr></table></figure><h2 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h2><blockquote><p>Java Memary Model（java内存模型）</p><p>定义了主存、工作内存抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。</p></blockquote><p>JMM体现在以下几个方面：</p><ul><li>原子性：指令不会受到线程上下文切换的影响</li><li>可见性：指令不会受 cpu 缓存的影响（对共享变量的修改对其他线程立即可见）</li><li>有序性：指令不会受 cpu 指令并行优化的影响（指令顺序执行）</li></ul><p> 可以通过<code>synchronized</code>保证代码块的原子性，<code>volatile</code>保证可见性和有序性</p><h3 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h3><blockquote><p>如果线程频繁从主存中获取某个值，就会形成缓存，减少对主存的访问，提高效率</p><p>但会出现内存中的值更新了，使得<strong>缓存中的值和内存中的不一致</strong></p><p>从而出现可见性问题</p></blockquote><p>示例</p><blockquote><p>t线程无法退出循环</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test9</span> &#123;<br>    <br>    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// 因为 t 线程要频繁从主内存中读取 run 的值，JIT 编译器会将 run 的值缓存至自己工作内存中的高速缓存中，</span><br>            <span class="hljs-comment">// 减少对主存中 run 的访问，提高效率</span><br>            <span class="hljs-keyword">while</span> (run) &#123;<br>            &#125;<br>        &#125;);<br>        t.start();<br><br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        log.debug(<span class="hljs-string">&quot;stop t&quot;</span>);<br>        run = <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>解决方式：</p><ol><li><p>volatile关键字：表示变量是易变的，每次都从内存中读取（轻量）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure></li><li><p>给代码块加锁（重量）</p><blockquote><p> synchronized规定，线程在加锁时， 先<strong>清空工作内存</strong>→在主内存中拷贝最新变量的副本到工作内存 →执行完代码→将更改后的共享变量的值刷新到主内存中→释放互斥锁。</p></blockquote></li></ol><h3 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h3><blockquote><p>指令重排：JVM 会在不影响正确性的前提下，可以调整语句的执行顺序（流水线），在多线程下有可能会影响正确性</p></blockquote><p>通过volatile关键字，可以进制指令重排</p><p><strong>volatile原理：</strong></p><blockquote><p>读屏障：保证在该屏障之后，对共享变量的读取，加载的是主存中最新数据</p><p>写屏障：保证在该屏障之前的，对共享变量的改动，都同步到主存当中</p></blockquote><ul><li><p>对 volatile 变量的写指令后会加入写屏障，之前的代码都会执行完再执行当前指令，不会被重排序到当前指令之后 （保证本线程内的有序性）</p></li><li><p>对 volatile 变量的读指令前会加入读屏障（保证可见性）</p></li></ul><h3 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h3><blockquote><p> 通过同步代码块synchronized来保证原子性</p></blockquote><p>synchronized用法：</p><ol><li>加在实例方法上：给当前实例对象加锁</li><li>加在静态方法上：给当前class类加锁</li><li>加在代码块上：给指定的对象或类加锁</li></ol><p>原理：</p><ul><li><p>ObjectMonitor有两个队列： WaitSet、 EntryList，用来保存ObjectWaiter 对象列 表。 </p></li><li><p>_owner，获取 Monitor 对象的线程进入 _owner 区时， _count + 1。如果线程调用 了 wait() 方法，此时会释放 Monitor 对象， _owner 恢复为空， _count - 1。同时 该等待线程进入 _WaitSet 中，等待被唤醒。</p></li><li><p>monitorenter，在判断拥有同步标识 ACC_SYNCHRONIZED 抢先进入此方法的线 程会优先拥有 Monitor 的 owner ，此时计数器 +1。 </p></li><li><p>monitorexit，当执行完退出后，计数器 -1，归 0 后被其他进入的线程获得。</p></li></ul><p><img src="/img/else_img/synchronized%E5%8E%9F%E7%90%86.png"></p><h3 id="dcl问题"><a href="#dcl问题" class="headerlink" title="dcl问题"></a>dcl问题</h3><blockquote><p>double-checked locking 单例模式</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123; &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span>(INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t2</span><br>            <span class="hljs-comment">// 首次访问会同步，而之后的使用没有 synchronized</span><br>            <span class="hljs-keyword">synchronized</span>(Singleton.class) &#123;<br>                <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t1</span><br>                    INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>创建对象的过程不是原子操作</strong>，</p><p>在单线程下没有问题，但多线程下可能会出现问题，</p><p>在创建对象的时候发生了重排序，JVM先将对象分配给了变量，再调用构造方法；其他线程判断<code>INSTANCE != null</code>从而使用了没有初始化完成的对象</p><p><strong>解决方式：</strong>给INSTANCE添加volatile关键字，使之不会被重排序</p><p><strong>单例模式</strong></p><p>饿汉&#x2F;懒汉实现单例模式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 加final表示不能被继承，防止子类重写获取单例的方法不当导致new出多个对象</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123; &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-comment">// 静态成员对象实在类加载的时候创建的，不会有线程安全问题（懒汉式）</span><br>    <span class="hljs-comment">// private static final Singleton INSTANCE = new Singleton();</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span>(INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t2</span><br>            <span class="hljs-comment">// 首次访问会同步，而之后的使用没有 synchronized</span><br>            <span class="hljs-keyword">synchronized</span>(Singleton.class) &#123;<br>                <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// t1</span><br>                    INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br><br>    <span class="hljs-comment">// 如果实现了序列化接口</span><br>    <span class="hljs-comment">// 反序列化也会常见新对象，使用这个方法，这个方法的返回值就会被当成反序列化的结果</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">readResovle</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> INSTANCE;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>枚举实现单例</p><blockquote><p>INSTANCE相当于静态成员对象，属于懒汉式</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    INSTANCE<br>&#125;<br></code></pre></td></tr></table></figure><p>静态内部类实现单例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123; &#125;<br>    <br>    <span class="hljs-comment">// 静态内部类是懒汉式加载的</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyHolder</span> &#123;<br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LazyHolder.INSTANCE;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="乐观锁（无锁）"><a href="#乐观锁（无锁）" class="headerlink" title="乐观锁（无锁）"></a>乐观锁（无锁）</h2><p><strong>原子变量</strong></p><blockquote><p>如AtomicInteger（原子整数）</p></blockquote><p>案例，取款</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountSafe</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Account1</span> &#123;<br>    <span class="hljs-keyword">private</span> AtomicInteger balance;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AccountSafe</span><span class="hljs-params">(<span class="hljs-type">int</span> balance)</span> &#123;<br>        <span class="hljs-built_in">this</span>.balance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(balance);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Integer <span class="hljs-title function_">getBalance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> balance.get();<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(Integer amount)</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> balance.get();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> prev - amount;<br>            <span class="hljs-comment">// compareAndSet简称CAS</span><br>            <span class="hljs-comment">// 会不断尝试，如果prev和当前值不一样，则返回false</span><br>            <span class="hljs-comment">// 只有当prev和当前值一样时才会修改</span><br>            <span class="hljs-keyword">if</span> (balance.compareAndSet(prev, next)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>CAS和volatile关系</strong></p><blockquote><p>获取共享变量时，为了保证该变量的可见性，需要使用 volatile 修饰。 </p><p>它可以用来修饰成员变量和静态成员变量，他可以避免线程从自己的工作缓存中查找变量的值，必须到主存中获取 它的值，线程操作 volatile 变量都是直接操作主存。即一个线程对 volatile 变量的修改，对另一个线程可见。</p></blockquote><p>CAS 必须借助 volatile 才能读取到共享变量的最新值来实现【比较并交换】的效果</p><h3 id="效率"><a href="#效率" class="headerlink" title="效率"></a>效率</h3><p>无锁效率高于有锁</p><blockquote><ul><li><p>synchronized 会让线程在没有获得锁的时候，发生上下文切换，进入阻塞</p></li><li><p>上下文切换的代价比较高，在有多个核心的情况下，无锁没有切换的开销</p></li><li><p>无锁情况下，线程仍然在运行，需要额外 CPU 的支持，如果没有额外 CPU 的支持，没有分到时间片，还是会上下文切换</p></li></ul></blockquote><h3 id="CAS特点"><a href="#CAS特点" class="headerlink" title="CAS特点"></a>CAS特点</h3><ul><li><strong>适用于线程数少、多核 CPU 的场景下</strong></li><li>基于乐观锁，不怕别的线程来改</li><li>体现的是无锁并发、无阻塞并发</li><li>如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li></ul><h3 id="线程安全工具类"><a href="#线程安全工具类" class="headerlink" title="线程安全工具类"></a>线程安全工具类</h3><h4 id="原子整数"><a href="#原子整数" class="headerlink" title="原子整数"></a>原子整数</h4><blockquote><p>JUC并发包提供的：AtomicBoolean、 AtomicInteger、 AtomicLong</p></blockquote><p><strong>原子整数的api都是基于CAS(compareAndSet)完成的</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);<br><br>    System.out.println(i.incrementAndGet());    <span class="hljs-comment">// ++i</span><br>    System.out.println(i.getAndIncrement());    <span class="hljs-comment">// i++</span><br><br>    System.out.println(i.getAndAdd(<span class="hljs-number">5</span>));<br>    System.out.println(i.addAndGet(<span class="hljs-number">5</span>));<br>    <br>    <span class="hljs-comment">// 接收一个接口类型，这里用lambda表达式</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        updateAndGet内部实现</span><br><span class="hljs-comment">         int prev, next;</span><br><span class="hljs-comment">         do &#123;</span><br><span class="hljs-comment">            prev = get();</span><br><span class="hljs-comment">            next = updateFunction.applyAsInt(prev);</span><br><span class="hljs-comment">         &#125; while (!compareAndSet(prev, next));</span><br><span class="hljs-comment">         return next;</span><br><span class="hljs-comment">    **/</span><br>    i.updateAndGet(value -&gt; value * <span class="hljs-number">10</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="原子引用"><a href="#原子引用" class="headerlink" title="原子引用"></a>原子引用</h4><blockquote><p>JUC提供的：AtomicReference、 AtomicMarkableReference  、 AtomicStampedReference</p></blockquote><p>案例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DecimalAccountCas</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Account1</span> &#123;<br><br>    <span class="hljs-comment">// 原子引用</span><br>    <span class="hljs-keyword">private</span> AtomicReference&lt;BigDecimal&gt; balance;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DecimalAccountCas</span><span class="hljs-params">(BigDecimal balance)</span> &#123;<br>        <span class="hljs-built_in">this</span>.balance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(balance);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getBalance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bigDecimal</span> <span class="hljs-operator">=</span> balance.get();<br>        <span class="hljs-keyword">return</span> bigDecimal.intValue();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">withdraw</span><span class="hljs-params">(Integer amount)</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> balance.get();<br>            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> prev.subtract(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(amount));<br>            <span class="hljs-keyword">if</span> (balance.compareAndSet(prev, next)) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h4><p>ABA 问题的过程是当有两个线程 T1 和 T2 从内存中获取到值A，线程 T2 通过某些操作把内存值修改为B，然后又经过某些操作将值修改为回值A，T2退出。线程 T1 进行操作的时候 ，使用预期值同内存中的值比较，此时均为A，修改成功退出。但是此时的A以及不是原先的A了</p><p><strong>案例</strong></p><blockquote><p>使用AtomicReference</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> AtomicReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;(<span class="hljs-string">&quot;A&quot;</span>);<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-comment">// 获取值</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> ref.get();<br><br>    <span class="hljs-comment">// 其他线程修改ref</span><br>    other();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br><br>    <span class="hljs-comment">// 主线程修改ref</span><br>    System.out.println(ref.compareAndSet(prev, <span class="hljs-string">&quot;C&quot;</span>));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">other</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        System.out.println(ref.compareAndSet(ref.get(), <span class="hljs-string">&quot;B&quot;</span>));<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>    Thread.sleep(<span class="hljs-number">500</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        System.out.println(ref.compareAndSet(ref.get(), <span class="hljs-string">&quot;A&quot;</span>));<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>解决方式1</strong></p><p>使用<strong>AtomicStampedReference</strong>，类似MySQl的悲观锁，通过版本号来判断有没有被改过</p><p><strong>案例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> AtomicStampedReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> ref.getReference();<br>    <span class="hljs-comment">// 版本号</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> ref.getStamp();<br>    System.out.println(<span class="hljs-string">&quot;当前版本号&quot;</span> + stamp);<br><br>    other();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br><br>    System.out.println(<span class="hljs-string">&quot;过了一段时间后的版本号&quot;</span> + ref.getStamp());<br><br>    System.out.println(ref.compareAndSet(prev, <span class="hljs-string">&quot;C&quot;</span>, stamp, stamp + <span class="hljs-number">1</span>));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">other</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> ref.getStamp();<br>        System.out.println(ref.compareAndSet(ref.getReference(), <span class="hljs-string">&quot;B&quot;</span>, stamp, stamp + <span class="hljs-number">1</span>));<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>    Thread.sleep(<span class="hljs-number">500</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> ref.getStamp();<br>        System.out.println(ref.compareAndSet(ref.getReference(), <span class="hljs-string">&quot;A&quot;</span>, stamp, stamp + <span class="hljs-number">1</span>));<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-comment">// 控制台</span><br>当前版本号<span class="hljs-number">0</span><br><span class="hljs-literal">true</span><br><span class="hljs-literal">true</span><br>过了一段时间后的版本号<span class="hljs-number">2</span><br><span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p><strong>解决方式2</strong></p><p>当只关心是否被修改过，而不关心被修改了几次时，使用<strong>AtomicMarkableReference</strong></p><p><strong>案例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> AtomicMarkableReference&lt;String&gt; ref = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicMarkableReference</span>&lt;&gt;(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-literal">false</span>);<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> ref.getReference();<br>    <span class="hljs-comment">// 是否被更改过</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">marked</span> <span class="hljs-operator">=</span> ref.isMarked();<br>    System.out.println(<span class="hljs-string">&quot;是否被更改过&quot;</span> + marked);<br><br>    other();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br><br>    <span class="hljs-comment">// 是否被更改过</span><br>    System.out.println(<span class="hljs-string">&quot;是否被更改过&quot;</span> + ref.isMarked());<br><br>    System.out.println(ref.compareAndSet(prev, <span class="hljs-string">&quot;C&quot;</span>, marked,!marked));<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">other</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        System.out.println(ref.compareAndSet(ref.getReference(), <span class="hljs-string">&quot;B&quot;</span>, ref.isMarked(), !ref.isMarked()));<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="原子数组"><a href="#原子数组" class="headerlink" title="原子数组"></a>原子数组</h4><blockquote><p>JUC提供的：AtomicIntegerArray、AtomicLongArray、AtomicReferenceArray</p></blockquote><p><strong>案例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    demo(<br>        () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">10</span>],<br>        (array) -&gt; array.length,<br>        (array, index) -&gt; array[index]++,<br>        (array) -&gt; System.out.println(Arrays.toString(array))<br>    );<br><br>    <span class="hljs-comment">// 原子数组</span><br>    demo(<br>        () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicIntegerArray</span>(<span class="hljs-number">10</span>),<br>        (array) -&gt; array.length(),<br>        (array, index) -&gt; array.getAndIncrement(index),<br>        (array) -&gt; System.out.println(array)<br>    );<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     参数1，提供数组、可以是线程不安全数组或线程安全数组</span><br><span class="hljs-comment">     参数2，获取数组长度的方法</span><br><span class="hljs-comment">     参数3，自增方法，回传 array, index</span><br><span class="hljs-comment">     参数4，打印数组的方法</span><br><span class="hljs-comment">     */</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo</span><span class="hljs-params">(</span><br><span class="hljs-params">    Supplier&lt;T&gt; arraySupplier,</span><br><span class="hljs-params">    Function&lt;T, Integer&gt; lengthFun,</span><br><span class="hljs-params">    BiConsumer&lt;T, Integer&gt; putConsumer,</span><br><span class="hljs-params">    Consumer&lt;T&gt; printConsumer )</span> &#123;<br><br>    List&lt;Thread&gt; ts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-type">T</span> <span class="hljs-variable">array</span> <span class="hljs-operator">=</span> arraySupplier.get();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> lengthFun.apply(array);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>        <span class="hljs-comment">// 每个线程对数组作 10000 次操作</span><br>        ts.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000</span>; j++) &#123;<br>                putConsumer.accept(array, j%length);<br>            &#125;<br>        &#125;));<br>    &#125;<br>    ts.forEach(t -&gt; t.start()); <span class="hljs-comment">// 启动所有线程</span><br>    ts.forEach(t -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            t.join();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;); <span class="hljs-comment">// 等所有线程结束</span><br>    printConsumer.accept(array);<br>&#125;<br></code></pre></td></tr></table></figure> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">//</span> <span class="hljs-string">控制台</span><br>[<span class="hljs-number">8670</span>, <span class="hljs-number">8543</span>, <span class="hljs-number">8522</span>, <span class="hljs-number">8501</span>, <span class="hljs-number">8475</span>, <span class="hljs-number">8479</span>, <span class="hljs-number">8500</span>, <span class="hljs-number">8436</span>, <span class="hljs-number">8621</span>, <span class="hljs-number">8760</span>]<br>[<span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>]<br></code></pre></td></tr></table></figure><h4 id="字段更新器"><a href="#字段更新器" class="headerlink" title="字段更新器"></a>字段更新器</h4><blockquote><p>保证引用类型内部属性赋值的原子性</p><p>JUC提供的：AtomicReferenceFieldUpdater &#x2F;&#x2F; 域 字段 、AtomicIntegerFieldUpdater、AtomicLongFieldUpdater</p></blockquote><p><strong>案例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test15</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br><br>        <span class="hljs-type">AtomicReferenceFieldUpdater</span> <span class="hljs-variable">updater</span> <span class="hljs-operator">=</span> AtomicReferenceFieldUpdater.newUpdater(Student.class, String.class, <span class="hljs-string">&quot;name&quot;</span>);<br><br>        updater.compareAndSet(student, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;张三&quot;</span>);<br>        System.out.println(student);<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> &#123;<br>    <span class="hljs-keyword">volatile</span> String name;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Student&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;name=&#x27;&quot;</span> + name + <span class="hljs-string">&#x27;\&#x27;&#x27;</span> +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="原子累加器"><a href="#原子累加器" class="headerlink" title="原子累加器"></a>原子累加器</h4><blockquote><p>JUC提供的：DoubleAccumulator、DoubleAdder、LongAccumulator、LongAdder</p><p>原子累加器的速度比原子整数要快</p><p>在有竞争时，设置多个累加单元，Therad-0 累加 Cell[0]，而 Thread-1 累加 Cell[1]… 最后将结果汇总。这样它们在累加时操作的不同的 Cell 变量，因此减少了 CAS 重试失败，从而提高性 能。</p></blockquote><p>案例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        demo(<br>                () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>),<br>                (addr) -&gt; addr.getAndIncrement()<br>        );<br>        demo(<br>                () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>(),<br>                (addr) -&gt; addr.increment()<br>        );<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo</span><span class="hljs-params">(Supplier&lt;T&gt; adderSupplier, Consumer&lt;T&gt; action)</span> &#123;<br>    <span class="hljs-type">T</span> <span class="hljs-variable">adder</span> <span class="hljs-operator">=</span> adderSupplier.get();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();<br>    List&lt;Thread&gt; ts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-comment">// 4 个线程，每人累加 50 万</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>        ts.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">500000</span>; j++) &#123;<br>                action.accept(adder);<br>            &#125;<br>        &#125;));<br>    &#125;<br>    ts.forEach(t -&gt; t.start());<br>    ts.forEach(t -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            t.join();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;);<br>    <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.nanoTime();<br>    System.out.println(adder + <span class="hljs-string">&quot; cost:&quot;</span> + (end - start) / <span class="hljs-number">1000_000</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h3><blockquote><p>Unsafe 对象提供了非常底层的，<strong>操作内存、线程的方法</strong>，Unsafe 对象不能直接调用，只能通过反射获得</p></blockquote><h4 id="获取unsafe"><a href="#获取unsafe" class="headerlink" title="获取unsafe"></a>获取unsafe</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>    <span class="hljs-comment">// 通过反射获取成员对象</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>    theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">// 因为theUnsafe是静态的，不从属于哪个类，所以传null</span><br>    <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br><br>    System.out.println(unsafe);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="unsafe的cas操作"><a href="#unsafe的cas操作" class="headerlink" title="unsafe的cas操作"></a>unsafe的cas操作</h4><blockquote><p>有compareAndSwapInt、compareAndSwapLong、compareAndSwapObject</p></blockquote><p><strong>案例：通过unsafe修改域</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test17</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;<br>        <span class="hljs-comment">// 通过反射获取成员对象</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">// 因为theUnsafe是静态的，不从属于哪个类，所以传null</span><br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 获取域的偏移地址</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">idOffset</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Teacher.class.getDeclaredField(<span class="hljs-string">&quot;id&quot;</span>));<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nameOffset</span> <span class="hljs-operator">=</span> unsafe.objectFieldOffset(Teacher.class.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>));<br><br>        <span class="hljs-type">Teacher</span> <span class="hljs-variable">teacher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Teacher</span>();<br>        unsafe.compareAndSwapInt(teacher, idOffset, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>        unsafe.compareAndSwapObject(teacher, nameOffset, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;zs&quot;</span>);<br>        System.out.println(teacher);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Teacher</span> &#123;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">volatile</span> String name;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="伪共享"><a href="#伪共享" class="headerlink" title="伪共享"></a>伪共享</h4><p>CPU会将内存中的数据读到缓存中来提高效率，</p><p>缓存以缓存行为单元，</p><p>如果某个CPU改变了数据，其他 CPU 核心对应的整个缓存行必须失效</p><p><code>@sun.misc.Contended </code>原理是在使用此注解的对象或字段的前后各增加 128 字节大小的 padding，从而让 CPU 将对象预读至缓存时<strong>占用不同的缓存行</strong>，这样，不会造成对方缓存行的失效</p><h2 id="不可变"><a href="#不可变" class="headerlink" title="不可变"></a>不可变</h2><p>如果一个对象在不能够修改其内部状态（属性），那么它就是线程安全的</p><p>不可变类就是不能修改其内部状态的类，如日期转换类<code>SimpleDateFormat</code>是可变的，而<code>DateTimeFormatter</code>是不可变类，<code>String</code>也是不可变类</p><h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><p> final 修饰保证了该属性是只读的，不能修改</p><p>保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性</p><blockquote><p>设置final变量原理：给final赋值的时候，通过写屏障，保证在其它线程读到 它的值时不会出现为 0 的情况</p><p>获取final变量原理：会被复制一份到其他类的方法栈&#x2F;常量池中，没有共享的问题，性能更高</p></blockquote><h3 id="无状态"><a href="#无状态" class="headerlink" title="无状态"></a>无状态</h3><p>没有成员变量称为无状态，没有线程安全问题</p><h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="自定义线程池"><a href="#自定义线程池" class="headerlink" title="自定义线程池"></a>自定义线程池</h3><p>带任务队列，线程阻塞队列，超时时间</p><p>策略模式：当任务队列满了该怎么做</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Test21&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test21</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ThreadPool</span> <span class="hljs-variable">threadPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPool</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, TimeUnit.MILLISECONDS, <span class="hljs-number">1</span>, (queue, task) -&gt; &#123;<br>            <span class="hljs-comment">// 自定义拒绝策略</span><br>            <span class="hljs-comment">// 当队列满了可以有的选择</span><br>            <span class="hljs-comment">// 1 死等</span><br>            <span class="hljs-comment">// queue.put(task);</span><br>            <span class="hljs-comment">// 2 带超时时间等待</span><br>            <span class="hljs-comment">// queue.put(task, 1500, TimeUnit.MILLISECONDS);</span><br>            <span class="hljs-comment">// 3 让调用者放弃任务执行</span><br>            <span class="hljs-comment">// 啥都不做</span><br>            <span class="hljs-comment">// 4 让调用者抛出异常</span><br>            <span class="hljs-comment">// throw new RuntimeException(&quot;任务执行失败&quot; + task);</span><br>            <span class="hljs-comment">// 5 让调用者自己执行任务</span><br>             task.run();<br>        &#125;);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i;<br>            threadPool.execute(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, j);<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.ThreadPool&quot;)</span><br><span class="hljs-comment">// 线程池</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span> &#123;<br>    <span class="hljs-comment">// 任务队列</span><br>    BlockingQueue&lt;Runnable&gt; taskQueue;<br><br>    <span class="hljs-comment">// 线程集合</span><br>    HashSet&lt;Worker&gt; workers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 核心线程数</span><br>    <span class="hljs-type">int</span> coreSize;<br><br>    <span class="hljs-comment">// 获取任务超时时间</span><br>    <span class="hljs-type">long</span> timeout;<br><br>    <span class="hljs-comment">// 超时时间单位</span><br>    TimeUnit unit;<br><br>    <span class="hljs-comment">// 拒绝策略</span><br>    <span class="hljs-keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> coreSize, <span class="hljs-type">long</span> timeout, TimeUnit unit, <span class="hljs-type">int</span> queueCapacity, RejectPolicy&lt;Runnable&gt; rejectPolicy)</span> &#123;<br>        <span class="hljs-built_in">this</span>.coreSize = coreSize;<br>        <span class="hljs-built_in">this</span>.timeout = timeout;<br>        <span class="hljs-built_in">this</span>.unit = unit;<br>        <span class="hljs-built_in">this</span>.taskQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlockingQueue</span>&lt;&gt;(queueCapacity);<br>        <span class="hljs-built_in">this</span>.rejectPolicy = rejectPolicy;<br>    &#125;<br><br>    <span class="hljs-comment">// 执行任务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(Runnable task)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (workers) &#123;<br>            <span class="hljs-keyword">if</span> (workers.size() &lt; coreSize) &#123;<br>                <span class="hljs-comment">// 线程数小于核心线程数，创建新的线程</span><br>                <span class="hljs-type">Worker</span> <span class="hljs-variable">worker</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(task);<br>                workers.add(worker);<br>                log.debug(<span class="hljs-string">&quot;新增worker&#123;&#125;&quot;</span>, worker);<br>                worker.start();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 将任务放到队列中</span><br>                <span class="hljs-comment">// taskQueue.put(task);</span><br><br>                <span class="hljs-comment">// 将任务放到队列中，带拒绝策略</span><br>                taskQueue.tryPut(rejectPolicy, task);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span>&#123;<br>        <span class="hljs-keyword">private</span> Runnable task;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Worker</span><span class="hljs-params">(Runnable task)</span> &#123;<br>            <span class="hljs-built_in">this</span>.task = task;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// 查询任务队列中是否有任务</span><br>            <span class="hljs-keyword">while</span> (task != <span class="hljs-literal">null</span> || (task = taskQueue.take(timeout, unit)) != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.debug(<span class="hljs-string">&quot;正在执行..&#123;&#125;&quot;</span>, task);<br>                    task.run();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    task = <span class="hljs-literal">null</span>;<br>                &#125;<br>            &#125;<br>            <span class="hljs-comment">// 太久没用的worker会被删掉</span><br>            <span class="hljs-keyword">synchronized</span> (workers) &#123;<br>                log.debug(<span class="hljs-string">&quot;移除worker：&#123;&#125;&quot;</span>, workers);<br>                workers.remove(<span class="hljs-built_in">this</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 拒绝策略</span><br><span class="hljs-comment">// 函数式接口</span><br><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RejectPolicy</span> &lt;T&gt;&#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">reject</span><span class="hljs-params">(BlockingQueue&lt;T&gt; queue, T task)</span>;<br>&#125;<br><br><br><span class="hljs-comment">// 自定义阻塞队列</span><br><span class="hljs-meta">@Slf4j(topic = &quot;c.BlockingQueue&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BlockingQueue</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">// 存放任务</span><br>    Deque&lt;T&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 容量</span><br>    <span class="hljs-type">int</span> capacity;<br><br>    <span class="hljs-comment">// 锁</span><br>    <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();<br><br>    <span class="hljs-comment">// 阻塞队列: 队满</span><br>    <span class="hljs-type">Condition</span> <span class="hljs-variable">fullWaitSet</span> <span class="hljs-operator">=</span> lock.newCondition();<br><br>    <span class="hljs-comment">// 阻塞队列: 队空</span><br>    <span class="hljs-type">Condition</span> <span class="hljs-variable">emptyWaitSet</span> <span class="hljs-operator">=</span> lock.newCondition();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BlockingQueue</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> &#123;<br>        <span class="hljs-built_in">this</span>.capacity = capacity;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取任务</span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">take</span><span class="hljs-params">()</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 若队列为空则进入阻塞队列，否则获取队列第一个任务，并通知队满阻塞队列</span><br>            <span class="hljs-keyword">while</span> (queue.isEmpty()) &#123;<br>                emptyWaitSet.await();<br>            &#125;<br>            <span class="hljs-type">T</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> queue.removeFirst();<br>            fullWaitSet.signal();<br>            <span class="hljs-keyword">return</span> t;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取任务，带超时时间</span><br>    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">take</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 若队列为空则进入阻塞队列，否则获取队列第一个任务，并通知队满阻塞队列</span><br>            <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> unit.toNanos(timeout);<br>            <span class="hljs-keyword">while</span> (queue.isEmpty()) &#123;<br>                <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-comment">// 超出超时时间而没有等到，返回null</span><br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>                nanos = emptyWaitSet.awaitNanos(nanos);<br>            &#125;<br>            <span class="hljs-type">T</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> queue.removeFirst();<br>            fullWaitSet.signal();<br>            <span class="hljs-keyword">return</span> t;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 添加任务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(T task)</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 若队列为满则进入阻塞队列，否则将任务添加进队尾，并通知队空阻塞队列</span><br>            <span class="hljs-keyword">while</span> (queue.size() &gt;= capacity) &#123;<br>                log.debug(<span class="hljs-string">&quot;等待加入队列&#123;&#125;&quot;</span>, task);<br>                fullWaitSet.await();<br>            &#125;<br>            queue.offer(task);<br>            log.debug(<span class="hljs-string">&quot;加入队列&#123;&#125;&quot;</span>, task);<br>            emptyWaitSet.signal();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 添加任务，带超时时间</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">put</span><span class="hljs-params">(T task, <span class="hljs-type">long</span> timeout, TimeUnit unit)</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 若队列为满则进入阻塞队列，否则将任务添加进队尾，并通知队空阻塞队列</span><br>            <span class="hljs-type">long</span> <span class="hljs-variable">nanos</span> <span class="hljs-operator">=</span> unit.toNanos(timeout);<br>            <span class="hljs-keyword">while</span> (queue.size() &gt;= capacity) &#123;<br>                <span class="hljs-comment">// 超出超时时间而没有添加成功</span><br>                <span class="hljs-keyword">if</span> (nanos &lt;= <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>                nanos = fullWaitSet.awaitNanos(nanos);<br>            &#125;<br>            queue.offer(task);<br>            emptyWaitSet.signal();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 当前队列大小</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> queue.size();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">// 添加任务，可以选择不同的拒绝策略</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryPut</span><span class="hljs-params">(RejectPolicy&lt;T&gt; rejectPolicy, T task)</span> &#123;<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (queue.size() &gt;= capacity) &#123;<br>                <span class="hljs-comment">// 队列满了，执行拒绝策略</span><br>                rejectPolicy.reject(<span class="hljs-built_in">this</span>, task);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 队列没满</span><br>                queue.offer(task);<br>                log.debug(<span class="hljs-string">&quot;加入队列&#123;&#125;&quot;</span>, task);<br>                emptyWaitSet.signal();<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ThreadPoolExcutor"><a href="#ThreadPoolExcutor" class="headerlink" title="ThreadPoolExcutor"></a>ThreadPoolExcutor</h3><p><img src="/img/bingfa_img/ThreadPoolExecurtor.png"></p><h4 id="线程池状态"><a href="#线程池状态" class="headerlink" title="线程池状态"></a>线程池状态</h4><p>ThreadPoolExecutor 使用 int 的高 3 位来表示线程池状态，低 29 位表示线程数量</p><table><thead><tr><th>状态名</th><th>高3位</th><th>接收新任务</th><th>处理阻塞队列任务</th><th>说明</th></tr></thead><tbody><tr><td>RUNNING</td><td>111</td><td>Y</td><td>Y</td><td></td></tr><tr><td>SHUTDOWN</td><td>000</td><td>N</td><td>Y</td><td>不会接收新任务，但会处理阻塞队列剩余 任务</td></tr><tr><td>STOP</td><td>001</td><td>N</td><td>N</td><td>会中断正在执行的任务，并抛弃阻塞队列 任务</td></tr><tr><td>TIDYING</td><td>010</td><td>-</td><td>-</td><td>任务全执行完毕，活动线程为 0 即将进入 终结</td></tr><tr><td>TERMINATED</td><td>011</td><td>-</td><td>-</td><td>终结状态</td></tr></tbody></table><p>将状态信息和线程数量保存在同一个整数中是为了可以用1一次cas操作进行赋值</p><h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,</span><br><span class="hljs-params">                              <span class="hljs-type">int</span> maximumPoolSize,</span><br><span class="hljs-params">                              <span class="hljs-type">long</span> keepAliveTime,</span><br><span class="hljs-params">                              TimeUnit unit,</span><br><span class="hljs-params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span><br><span class="hljs-params">                              ThreadFactory threadFactory,</span><br><span class="hljs-params">                              RejectedExecutionHandler handler)</span><br></code></pre></td></tr></table></figure><ul><li><p>corePoolSize 核心线程数目 (最多保留的线程数) </p><ul><li>maximumPoolSize 最大线程数目</li></ul></li><li><p>keepAliveTime 生存时间 - <strong>针对救急线程</strong> </p></li><li><p>unit 时间单位 - <strong>针对救急线程</strong> </p></li><li><p>workQueue 阻塞队列 </p></li><li><p>threadFactory 线程工厂 - 可以为线程创建时起个好名字 </p></li><li><p>handler 拒绝策略</p></li></ul><blockquote><p>当线程池中的任务数超过了队列大小时，会创建救急线程来执行任务。当救急线程数量达到最大创建的数量时，仍然有新任务，此时则会执行拒绝策略</p><p>救急线程有生存时间，而核心线程没有</p></blockquote><h4 id="拒绝策略"><a href="#拒绝策略" class="headerlink" title="拒绝策略"></a>拒绝策略</h4><p><img src="/img/bingfa_img/%E6%8B%92%E7%BB%9D%E7%AD%96%E7%95%A5.png"></p><ul><li>AbortPolicy 让调用者抛出 RejectedExecutionException 异常，这是默认策略</li><li>CallerRunsPolicy 让调用者运行任务</li><li>DiscardPolicy 放弃本次任务</li><li>DiscardOldestPolicy 放弃队列中最早的任务，本任务取而代</li></ul><h4 id="线程工厂"><a href="#线程工厂" class="headerlink" title="线程工厂"></a>线程工厂</h4><p><strong>newFixedThreadPool 固定大小线程池</strong></p><p>核心线程数等于最大线程数，因此没有救急线程</p><p>阻塞队列是无界的，可以放任意数量的任务</p><blockquote><p>适用于任务量已知，相对耗时的任务</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Test22&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test22</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactory</span>() &#123;<br>            <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r, <span class="hljs-string">&quot;myPool_t&quot;</span> + t.getAndIncrement());<br>            &#125;<br>        &#125;);<br><br>        pool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;1&quot;</span>);<br>        &#125;);<br><br>        pool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;2&quot;</span>);<br>        &#125;);<br><br>        pool.execute(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;3&quot;</span>);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>newCachedThreadPool 缓冲线程</strong></p><p>核心线程数为0，最大线程数为Integer.MAX_VALUE，因此全部线程都为救急线程（生存周期60s）</p><p>只有当有线程来线程池取任务时，才能放任务到线程池中</p><blockquote><p> 适合任务数比较密集，但每个任务执行时间较短的情况</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    SynchronousQueue&lt;Integer&gt; integers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;();<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;putting &#123;&#125; &quot;</span>, <span class="hljs-number">1</span>);<br>            integers.put(<span class="hljs-number">1</span>);<br>            log.debug(<span class="hljs-string">&quot;&#123;&#125; putted...&quot;</span>, <span class="hljs-number">1</span>);<br>            log.debug(<span class="hljs-string">&quot;putting...&#123;&#125; &quot;</span>, <span class="hljs-number">2</span>);<br>            integers.put(<span class="hljs-number">2</span>);<br>            log.debug(<span class="hljs-string">&quot;&#123;&#125; putted...&quot;</span>, <span class="hljs-number">2</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;taking &#123;&#125;&quot;</span>, <span class="hljs-number">1</span>);<br>            integers.take();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br>    Thread.sleep(<span class="hljs-number">1000</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;taking &#123;&#125;&quot;</span>, <span class="hljs-number">2</span>);<br>            integers.take();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;,<span class="hljs-string">&quot;t3&quot;</span>).start();<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>newSingleThreadExecutor 单例线程池</strong></p><p>线程数固定为 1，任务数多于 1 时，会放入无界队列排队</p><p>与自己创建一个线程执行任务的区别：</p><ul><li>自己创建一个单线程串行执行任务，如果任务执行失败而终止那么没有任何补救措施，而线程池还会新建一 个线程，保证池的正常工作</li><li>e 应用的是装饰器模式，只对外暴露了 ExecutorService 接口，因 此不能调用 ThreadPoolExecutor 中特有的方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br>    pool.execute(() -&gt; &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>    &#125;);<br>    pool.execute(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;仍然继续执行&quot;</span>);<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>newScheduledThreadPool 定时任务线程池</strong></p><p>可以延时执行任务和定时执行任务(隔一段时间执行一次)，通过设置线程数，使得若一个任务执行时间长&#x2F;执行出错，不会影响其他的定时任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 定时任务</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);<br><br>    pool.schedule(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;task1&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br><br>    pool.schedule(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;task2&quot;</span>);<br>    &#125;, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 延时任务</span><br><span class="hljs-comment">// 如果只设置了一个线程，当任务执行时间长时，会延后下一个任务</span><br><span class="hljs-comment">// scheduleAtFixedRate是从开始时间来技师</span><br><span class="hljs-comment">// scheduleWithFixedDelay从任务结束时间开始算时间</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);<br><br>    log.debug(<span class="hljs-string">&quot;start...&quot;</span>);<br>    pool.scheduleAtFixedRate(() -&gt;&#123;<br>        log.debug(<span class="hljs-string">&quot;running...&quot;</span>);<br>    &#125;, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, TimeUnit.SECONDS);<br>&#125;<br></code></pre></td></tr></table></figure><p>应用：每周五18点执行定时任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-comment">// 获取当前时间</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    System.out.println(now);<br><br>    <span class="hljs-comment">// 获取本周五18:0:0的时间，如果当前时间超过周五了，则获取下周的</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> now.withHour(<span class="hljs-number">18</span>).withMinute(<span class="hljs-number">0</span>).withSecond(<span class="hljs-number">0</span>).withNano(<span class="hljs-number">0</span>).with(DayOfWeek.FRIDAY);<br>    <span class="hljs-keyword">if</span> (now.compareTo(time) &gt; <span class="hljs-number">0</span>) &#123;<br>        time = time.plusWeeks(<span class="hljs-number">1</span>);<br>    &#125;<br>    System.out.println(time);<br><br>    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// 开始时间</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">initialDelay</span> <span class="hljs-operator">=</span> Duration.between(now, time).toMillis();<br>    <span class="hljs-comment">// 间隔时间</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">period</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">7</span>;<br>    pool.scheduleAtFixedRate(() -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;running&quot;</span>);<br>    &#125;, initialDelay, period, TimeUnit.MILLISECONDS);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="执行任务方法"><a href="#执行任务方法" class="headerlink" title="执行任务方法"></a>执行任务方法</h4><p><strong>void  execute(Runnable command)</strong></p><p>执行任务</p><p><strong>&lt;T&gt;Future&lt;T&gt; submit((Callable&lt;T&gt; task)</strong></p><p>提交任务 task，用<strong>返回值</strong> Future 获得任务执行结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br><br>    <span class="hljs-comment">// 有返回结果</span><br>    Future&lt;String&gt; future = pool.submit(() -&gt; &#123;<br>        System.out.println(<span class="hljs-string">&quot;running..&quot;</span>);<br>        Thread.sleep(<span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ok&quot;</span>;<br>    &#125;);<br><br>    System.out.println(future.get());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>invokeAll</strong></p><p>提交所有任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>    List&lt;Future&lt;String&gt;&gt; futures = pool.invokeAll(Arrays.asList(<br>        () -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>        &#125;,<br>        () -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">500</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2&quot;</span>;<br>        &#125;,<br>        () -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;3&quot;</span>;<br>        &#125;<br>    ));<br>    futures.forEach(f -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(f.get());<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;);<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>invokeAny</strong></p><p>将最先执行完成的任务的返回值返回，其他任务取消</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pool.invokeAny(Arrays.asList(<br>        () -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;end&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;1&quot;</span>;<br>        &#125;,<br>        () -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">500</span>);<br>            log.debug(<span class="hljs-string">&quot;end&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;2&quot;</span>;<br>        &#125;,<br>        () -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>            log.debug(<span class="hljs-string">&quot;end&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;3&quot;</span>;<br>        &#125;<br>    ));<br>    log.debug(result);<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="关闭线程池方法"><a href="#关闭线程池方法" class="headerlink" title="关闭线程池方法"></a>关闭线程池方法</h4><p><strong>shutdown</strong></p><p>将线程池状态改为SHUTDOWN，不再接收新任务，执行完已提交的任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>    Future&lt;Integer&gt; result1 = pool.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 1 running&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;);<br><br>    Future&lt;Integer&gt; result2 = pool.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 2 running&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;);<br><br>    Future&lt;Integer&gt; result3 = pool.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 3 running&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;);<br><br>    log.debug(<span class="hljs-string">&quot;关闭线程池&quot;</span>);<br>    pool.shutdown();<br><br>&#125;<br></code></pre></td></tr></table></figure> <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台</span><br><span class="hljs-number">15</span>:<span class="hljs-number">17</span>:<span class="hljs-number">25</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.Test22</span> - 关闭线程池<br><span class="hljs-number">15</span>:<span class="hljs-number">17</span>:<span class="hljs-number">26</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test22</span> - task <span class="hljs-number">2</span> running<br><span class="hljs-number">15</span>:<span class="hljs-number">17</span>:<span class="hljs-number">26</span> <span class="hljs-selector-attr">[pool-1-thread-1]</span> c<span class="hljs-selector-class">.Test22</span> - task <span class="hljs-number">1</span> running<br><span class="hljs-number">15</span>:<span class="hljs-number">17</span>:<span class="hljs-number">27</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test22</span> - task <span class="hljs-number">3</span> running<br></code></pre></td></tr></table></figure><p><strong>shutdownNow</strong></p><p>将线程池状态改为STOP，不再接收新任务，用interrupt打断正在执行的线程，将已提交的任务全部返回</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>    Future&lt;Integer&gt; result1 = pool.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 1 running&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;);<br><br>    Future&lt;Integer&gt; result2 = pool.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 2 running&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;);<br><br>    Future&lt;Integer&gt; result3 = pool.submit(() -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            log.debug(<span class="hljs-string">&quot;task 3 running&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;);<br><br>    log.debug(<span class="hljs-string">&quot;立即关闭线程池&quot;</span>);<br>    List&lt;Runnable&gt; runnables = pool.shutdownNow();<br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, runnables);<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台</span><br><span class="hljs-number">15</span>:<span class="hljs-number">24</span>:<span class="hljs-number">57</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.Test22</span> - 关闭线程池<br><span class="hljs-number">15</span>:<span class="hljs-number">24</span>:<span class="hljs-number">57</span> <span class="hljs-selector-attr">[main]</span> c<span class="hljs-selector-class">.Test22</span> - <span class="hljs-selector-attr">[java.util.concurrent.FutureTask@35851384]</span><br>java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.InterruptedException</span>: sleep interrupted<br></code></pre></td></tr></table></figure><h4 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h4><ol><li><p>try..catch捕获异常</p></li><li><p>使用future</p><p>没有异常的时候返回return的结果，有异常则返回异常信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException &#123;<br>    <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);<br><br>    Future&lt;Boolean&gt; f = pool.submit(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;task1&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;);<br>    log.debug(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, f.get());<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="tomcat线程池"><a href="#tomcat线程池" class="headerlink" title="tomcat线程池"></a>tomcat线程池</h4><p><img src="/img/bingfa_img/tomcat%E7%BA%BF%E7%A8%8B%E6%B1%A0.png"></p><p>tomcat中用到的线程池</p><ul><li>LimitLatch 用来限流，可以控制最大连接个数，类似 J.U.C 中的 Semaphore</li><li>Acceptor 只负责【接收新的 socket 连接】</li><li>Poller 只负责监听 socket channel 是否有【可读的 I&#x2F;O 事件】</li><li>一旦可读，封装一个任务对象（socketProcessor），提交给 Executor 线程池处理</li><li>Executor 线程池中的工作线程最终负责【处理请求】</li></ul><h3 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h3><p>Fork&#x2F;Join 是 JDK 1.7 加入的新的线程池实现，它体现的是一种<strong>分治思想</strong>，适用于能够进行任务拆分的 cpu 密集型 运算</p><blockquote><p>就是用多线程来计算各部分的值，最后合并</p></blockquote><p><strong>案例</strong></p><p>计算1~n的和</p><p>拆分的不好，一个线程等待另一个线程的结果，总体上像串行执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test23</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(<span class="hljs-number">4</span>);<br>        System.out.println(pool.invoke(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask</span>(<span class="hljs-number">5</span>)));<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.MyTask&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecursiveTask</span>&lt;Integer&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> n;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTask</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>        <span class="hljs-built_in">this</span>.n = n;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">compute</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 退出条件</span><br>        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) &#123;<br>            log.debug(<span class="hljs-string">&quot;join() &#123;&#125;&quot;</span>, n);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 拆分</span><br>        <span class="hljs-type">MyTask</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask</span>(n - <span class="hljs-number">1</span>);<br>        t1.fork();  <span class="hljs-comment">// 让一个线程执行任务</span><br>        log.debug(<span class="hljs-string">&quot;fork() &#123;&#125; + &#123;&#125;&quot;</span>, n, t1);<br><br>        <span class="hljs-comment">// 合并结果</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> n + t1.join();  <span class="hljs-comment">// 获取结果</span><br>        log.debug(<span class="hljs-string">&quot;join() &#123;&#125; + &#123;&#125; = &#123;&#125;&quot;</span>, n, t1, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&quot;</span> + n + <span class="hljs-string">&quot;&#125;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>改进</strong></p><p>拆分成两部分计算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test23</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(<span class="hljs-number">4</span>);<br>        System.out.println(pool.invoke(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask2</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)));<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Slf4j(topic = &quot;c.MyTask&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTask2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecursiveTask</span>&lt;Integer&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> begin;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> end;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyTask2</span><span class="hljs-params">(<span class="hljs-type">int</span> begin, <span class="hljs-type">int</span> end)</span> &#123;<br>        <span class="hljs-built_in">this</span>.begin = begin;<br>        <span class="hljs-built_in">this</span>.end = end;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">compute</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 只有一个数时</span><br>        <span class="hljs-keyword">if</span> (begin == end) &#123;<br>            <span class="hljs-keyword">return</span> begin;<br>        &#125;<br>        <span class="hljs-comment">// 只有两个数时</span><br>        <span class="hljs-keyword">if</span> (end - begin == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">return</span> end - begin;<br>        &#125;<br><br>        <span class="hljs-comment">// 拆分成前后两部分</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> begin + (end - begin) / <span class="hljs-number">2</span>;<br>        <span class="hljs-type">MyTask2</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask2</span>(begin, mid);<br>        t1.fork();<br>        <span class="hljs-type">MyTask2</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyTask2</span>(mid + <span class="hljs-number">1</span>, end);<br>        t2.fork();<br><br>        <span class="hljs-keyword">return</span> t1.join() + t2.join();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="star-JUC工具包"><a href="#star-JUC工具包" class="headerlink" title=":star:JUC工具包"></a>:star:JUC工具包</h3><h4 id="AQS原理"><a href="#AQS原理" class="headerlink" title="AQS原理"></a>AQS原理</h4><p>全称AbstractQueuedSynchronizer，是阻塞式锁和相关的同步器工具的框架</p><p>有以下特点：</p><ul><li>用 state 属性来表示资源的状态（独占、共享）</li><li>提供了基于 FIFO 的等待队列</li><li>支持多个条件变量(不同条件的等待队列)</li></ul><p><strong>自定义一个锁</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.Test24&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test24</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MyLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyLock</span>();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;locking...&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;unlocking...&quot;</span>);<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            lock.lock();<br>            <span class="hljs-keyword">try</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;locking...&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                log.debug(<span class="hljs-string">&quot;unlocking...&quot;</span>);<br>                lock.unlock();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123;<br><br>    <span class="hljs-comment">// 尝试上锁</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>        <span class="hljs-keyword">if</span> (acquires == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>                <span class="hljs-comment">// 设置当前锁的持有者</span><br>                setExclusiveOwnerThread(Thread.currentThread());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> &#123;<br>        <span class="hljs-keyword">if</span> (acquires == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            &#125;<br>            <span class="hljs-comment">// 设置当前没人持有</span><br>            setExclusiveOwnerThread(<span class="hljs-literal">null</span>);<br>            setState(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 不可重入</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-type">MySync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySync</span>();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>        sync.acquire(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 可打断锁</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        sync.acquireInterruptibly(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-keyword">return</span> sync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(time));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        sync.release(<span class="hljs-number">1</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.newCondition();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ReentrantLock原理"><a href="#ReentrantLock原理" class="headerlink" title="ReentrantLock原理"></a>ReentrantLock原理</h4><p><img src="/img/bingfa_img/%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81%E5%8E%9F%E7%90%861.png"></p><p><strong>非公平锁原理</strong></p><ol><li>ReentrantLock默认是非公平锁</li></ol><p><img src="/img/bingfa_img/%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%8E%9F%E7%90%861.png"></p><ol start="2"><li>调用了非公平锁的上锁方法lock()</li></ol><p><img src="/img/bingfa_img/%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%8E%9F%E7%90%862.png"></p><ol start="3"><li><p>lock方法</p><blockquote><p>如果成功上锁，则把锁的状态改为1，锁的拥有者改为当前线程</p><p>如果上锁失败，进入acquire()方法，会再尝试上锁几次，都失败后进入等待队列(双向链表)，线程设置为等待状态</p></blockquote></li></ol><p><img src="/img/bingfa_img/%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%8E%9F%E7%90%863.png"></p><ol start="4"><li>释放锁，调用了unlock()方法，将唤醒等待队列上最近的线程，和没有在等待队列中的线程竞争锁(非公平)</li></ol><p><strong>可重入原理</strong></p><p>如果第一次上锁，则把计数用的c置为1，以后拥有锁的线程每次来上锁c都会加1</p><p>释放锁时，c减1，如果此时c不等于0，则不会释放锁，直到等于0时才会执行释放锁的操作</p><p><strong>打断原理</strong></p><ul><li>不可打断：线程在等待的时候被打断了，会将打断标记置为true，然后继续去等待锁，而不是立刻被打断。只有当获取到锁后，才会判断是否有被打断，如果有则会执行打断操作</li><li>可打断：和不可打断不一样的地方是，如果在等待的时候被打断了，则会抛出异常，不继续到等待队列中等待</li></ul><p><strong>公平锁原理</strong></p><p>不公平锁是判断锁没有拥有者时直接去申请锁，公平锁是先判断在等待队列中，有没有前驱，如果没有前驱，代表没有比当前线程更早申请锁的线程，这时才去申请锁。</p><p><strong>条件变量原理</strong></p><p>每个条件变量其实就对应着一个等待队列，其实现类是 ConditionObject</p><ul><li>进入条件阻塞队列：调用await()将会把当前线程加入到条件变量的阻塞队列，然后fullyRelease()释放自己持有的锁，调用park()把自己阻塞住</li><li>唤醒：调用signal()获取阻塞队列的第一个线程并尝试唤醒，如果成功则把它加入到等待锁的队列尾，如果失败(如等待超时，被打断而不继续等锁)则获取条件阻塞队列的下一个线程</li></ul><h4 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h4><h5 id="ReentrantReadWriteLock"><a href="#ReentrantReadWriteLock" class="headerlink" title="ReentrantReadWriteLock"></a>ReentrantReadWriteLock</h5><ul><li>读-读是并发</li><li>读-写、写-写是互斥的</li></ul><p><strong>案例</strong></p><p>定义一个存放数据的容器，有读写功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.DataContainer&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataContainer</span> &#123;<br>    <span class="hljs-keyword">private</span> Object data;<br><br>    <span class="hljs-comment">// 读写锁</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ReentrantReadWriteLock</span> <span class="hljs-variable">rw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantReadWriteLock</span>();<br><br>    <span class="hljs-keyword">private</span> ReentrantReadWriteLock.<span class="hljs-type">ReadLock</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> rw.readLock();<br><br>    <span class="hljs-keyword">private</span> ReentrantReadWriteLock.<span class="hljs-type">WriteLock</span> <span class="hljs-variable">w</span> <span class="hljs-operator">=</span> rw.writeLock();<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">read</span><span class="hljs-params">()</span> &#123;<br>        log.debug(<span class="hljs-string">&quot;获取读锁&quot;</span>);<br>        r.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;读操作&quot;</span>);<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">return</span> data;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;释放读锁&quot;</span>);<br>            r.unlock();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">()</span> &#123;<br>        log.debug(<span class="hljs-string">&quot;获取写锁&quot;</span>);<br>        w.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;写操作&quot;</span>);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;释放写锁&quot;</span>);<br>            w.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试读-写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">DataContainer</span> <span class="hljs-variable">dataContainer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataContainer</span>();<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.read();<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>    Thread.sleep(<span class="hljs-number">100</span>);<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.write();<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台，可以看出是互斥的</span><br><span class="hljs-number">15</span>:<span class="hljs-number">20</span>:<span class="hljs-number">29</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainer</span> - 获取读锁<br><span class="hljs-number">15</span>:<span class="hljs-number">20</span>:<span class="hljs-number">29</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainer</span> - 读操作<br><span class="hljs-number">15</span>:<span class="hljs-number">20</span>:<span class="hljs-number">29</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainer</span> - 获取写锁<br><span class="hljs-number">15</span>:<span class="hljs-number">20</span>:<span class="hljs-number">30</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainer</span> - 释放读锁<br><span class="hljs-number">15</span>:<span class="hljs-number">20</span>:<span class="hljs-number">30</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainer</span> - 写操作<br><span class="hljs-number">15</span>:<span class="hljs-number">20</span>:<span class="hljs-number">30</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainer</span> - 释放写锁<br></code></pre></td></tr></table></figure><p>测试读-读</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">DataContainer</span> <span class="hljs-variable">dataContainer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataContainer</span>();<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.read();<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.read();<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台，可以看出是并发的</span><br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainer</span> - 获取读锁<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainer</span> - 获取读锁<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainer</span> - 读操作<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">15</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainer</span> - 读操作<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">16</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainer</span> - 释放读锁<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">16</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainer</span> - 释放读锁<br></code></pre></td></tr></table></figure><p><strong>注意事项：</strong></p><ul><li>读锁不支持条件变量</li><li>有写锁的时候可以直接获取读锁；而有读锁的时候不能直接获取写锁，需要先释放读锁</li></ul><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p> <strong>读写锁用的是同一个 Sycn 同步器</strong>，因此等待队列、state 等也是同一个</p><p> 写锁状态占了 state 的低 16 位，而读锁 使用的是 state 的高 16 位</p><p><strong>上写锁</strong></p><p>线程调用writeLock().lock()方法，首先判断锁的状态：</p><ul><li><p>如果没有被上锁（读&#x2F;写），则可以上锁；</p></li><li><p>如果锁的状态为被上锁，则判断是否是自己上的锁：</p><ul><li><p>如果是，则表示锁重入，状态位加1；</p></li><li><p>如果不是，则加锁失败，进入等待队列（节点状态为独占，表示要加的是写锁）</p></li></ul></li></ul><p><strong>上读锁</strong></p><p>线程调用readLock().lock()方法，首先判断锁的状态：</p><ul><li><p>如果没有被上锁（写），则可以上锁；</p></li><li><p>如果锁的状态为被上锁，则判断：</p><ul><li>如果被上的是写锁，判断是否是自己上的写锁<ul><li>如果不是，则进入等待队列（节点状态为共享，代表要加的是读锁）</li><li>如果是，则锁降级</li></ul></li><li>如果被上的是读锁，则上锁的个数加1</li></ul></li></ul><p><strong>解写锁</strong></p><p>状态位减1，判断状态位是否为0，是0的话就解锁，将锁的拥有者置为null，并通知等待队列的下一个节点</p><ul><li>如果下一个节点状态为共享，则通知后面一串的共享节点</li><li>如果下一个节点状态为独占，则不继续通知</li></ul><p><strong>解读锁</strong></p><p>上锁数减1，判断上锁数是否等于0，如果为0，则解读锁，通知等待队列的下一个节点</p><h4 id="StampedLock"><a href="#StampedLock" class="headerlink" title="StampedLock"></a>StampedLock</h4><p>乐观的读写锁，基于”戳”来判断是否被修改过，如果被修改过，则升级成读锁</p><p>适用于读多，写少的场景</p><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>创建一个使用乐观锁的数据容器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j(topic = &quot;c.DataContainerStamped&quot;)</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataContainerStamped</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> data;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">StampedLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StampedLock</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DataContainerStamped</span><span class="hljs-params">(<span class="hljs-type">int</span> data)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data = data;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-type">int</span> readTime)</span> &#123;<br>        <span class="hljs-comment">// 获取戳，尝试加乐观锁</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> lock.tryOptimisticRead();<br>        log.debug(<span class="hljs-string">&quot;optimistic read locking...&#123;&#125;&quot;</span>, stamp);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(readTime);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-comment">// 校验戳通过</span><br>        <span class="hljs-keyword">if</span> (lock.validate(stamp)) &#123;<br>            log.debug(<span class="hljs-string">&quot;read finish...&#123;&#125;&quot;</span>, stamp);<br>            <span class="hljs-keyword">return</span> data;<br>        &#125;<br><br>        <span class="hljs-comment">// 校验戳未通过, 升级为读锁</span><br>        log.debug(<span class="hljs-string">&quot;updating to read lock...&#123;&#125;&quot;</span>, stamp);<br>        <span class="hljs-keyword">try</span> &#123;<br>            stamp = lock.readLock();<br>            log.debug(<span class="hljs-string">&quot;read lock &#123;&#125;&quot;</span>, stamp);<br>            Thread.sleep(readTime);<br>            log.debug(<span class="hljs-string">&quot;read finish...&#123;&#125;&quot;</span>, stamp);<br>            <span class="hljs-keyword">return</span> data;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;read unlock &#123;&#125;&quot;</span>, stamp);<br>            lock.unlock(stamp);<br>        &#125;<br>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">int</span> newData)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> lock.writeLock();<br>        log.debug(<span class="hljs-string">&quot;write lock &#123;&#125;&quot;</span>, stamp);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">2000</span>);<br>            <span class="hljs-built_in">this</span>.data = newData;<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            log.debug(<span class="hljs-string">&quot;write unlock &#123;&#125;&quot;</span>, stamp);<br>            lock.unlock(stamp);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试：读-读</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">DataContainerStamped</span> <span class="hljs-variable">dataContainer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataContainerStamped</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.read(<span class="hljs-number">1000</span>);<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>    Thread.sleep(<span class="hljs-number">500</span>);<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.read(<span class="hljs-number">0</span>);<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台，可以看出读读不互斥</span><br><span class="hljs-number">10</span>:<span class="hljs-number">15</span>:<span class="hljs-number">20</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - optimistic read locking...<span class="hljs-number">256</span><br><span class="hljs-number">10</span>:<span class="hljs-number">15</span>:<span class="hljs-number">21</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - optimistic read locking...<span class="hljs-number">256</span><br><span class="hljs-number">10</span>:<span class="hljs-number">15</span>:<span class="hljs-number">21</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - read finish...<span class="hljs-number">256</span><br><span class="hljs-number">10</span>:<span class="hljs-number">15</span>:<span class="hljs-number">21</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - read finish...<span class="hljs-number">256</span><br></code></pre></td></tr></table></figure><p>测试：读-写</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">DataContainerStamped</span> <span class="hljs-variable">dataContainer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataContainerStamped</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.read(<span class="hljs-number">1000</span>);<br>    &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>    Thread.sleep(<span class="hljs-number">500</span>);<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        dataContainer.write(<span class="hljs-number">2</span>);<br>    &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台 可以看出验证戳失败，被升级成读锁</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">54</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - optimistic read locking...<span class="hljs-number">256</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">55</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - write lock <span class="hljs-number">384</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">55</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - updating to read lock...<span class="hljs-number">256</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">57</span> <span class="hljs-selector-attr">[t2]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - write unlock <span class="hljs-number">384</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">57</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - read lock <span class="hljs-number">513</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">58</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - read finish...<span class="hljs-number">513</span><br><span class="hljs-number">10</span>:<span class="hljs-number">18</span>:<span class="hljs-number">58</span> <span class="hljs-selector-attr">[t1]</span> c<span class="hljs-selector-class">.DataContainerStamped</span> - read unlock <span class="hljs-number">513</span><br></code></pre></td></tr></table></figure><h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><ul><li>StampedLock 不支持条件变量 </li><li>StampedLock 不支持可重入</li></ul><h4 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h4><p>信号量，用来限制同时访问共享资源的线程数量（不是限制资源数量）</p><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td>acquire()</td><td>获取一个信号量</td></tr></tbody></table><h5 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h5><p>最多同时有3个线程在运行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">Semaphore</span> <span class="hljs-variable">semaphore</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Semaphore</span>(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 获取信号量</span><br>                semaphore.acquire();<br>                log.debug(<span class="hljs-string">&quot;running...&quot;</span>);<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                log.debug(<span class="hljs-string">&quot;end...&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// 释放信号量</span><br>                semaphore.release();<br>            &#125;<br>        &#125;).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h5><p>可以用在限制线程池连接数上</p><h5 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h5><p><strong>初始化</strong></p><p>将传入的信号量数赋值给同步器（NonfairSync）的state</p><p><strong>获取信号量</strong></p><p>调用acqire()方法，将会用cas尝试将State减1，如果还有剩余的信号量则获取成功，否则进入等待队列</p><p><strong>释放信号量</strong></p><p>调用release()方法，尝试将State加1并唤醒等待队列的下一个节点</p><h4 id="CountdownLatch"><a href="#CountdownLatch" class="headerlink" title="CountdownLatch"></a>CountdownLatch</h4><p>用来进行线程同步协作，等待所有线程完成</p><p>完成的线程将计数值减1，当计数值减为0时，等待的线程才能运行</p><p>CountdownLatch是一次性的，latch不能增加</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>await()</td><td>等待latch降为0</td></tr><tr><td>await(long, timeout, TimeUnit unit)</td><td>有超时时间的等待</td></tr><tr><td>getCount()</td><td>获取latch的值</td></tr><tr><td>countDown()</td><td>latch - 1</td></tr></tbody></table><h5 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        log.debug(<span class="hljs-string">&quot;end&quot;</span>);<br>        latch.countDown();<br>    &#125;).start();<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        log.debug(<span class="hljs-string">&quot;end&quot;</span>);<br>        latch.countDown();<br>    &#125;).start();<br><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        log.debug(<span class="hljs-string">&quot;begin&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        log.debug(<span class="hljs-string">&quot;end&quot;</span>);<br>        latch.countDown();<br>    &#125;).start();<br><br>    latch.await();<br>    log.debug(<span class="hljs-string">&quot;main begin&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs llvm">// 控制台<br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">51</span> [Thread<span class="hljs-number">-0</span>] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - <span class="hljs-keyword">begin</span><br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">51</span> [Thread<span class="hljs-number">-2</span>] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - <span class="hljs-keyword">begin</span><br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">51</span> [Thread<span class="hljs-number">-1</span>] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - <span class="hljs-keyword">begin</span><br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">52</span> [Thread<span class="hljs-number">-0</span>] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - <span class="hljs-keyword">end</span><br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">52</span> [Thread<span class="hljs-number">-2</span>] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - <span class="hljs-keyword">end</span><br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">52</span> [Thread<span class="hljs-number">-1</span>] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - <span class="hljs-keyword">end</span><br><span class="hljs-number">16</span>:<span class="hljs-number">20</span>:<span class="hljs-number">52</span> [main] <span class="hljs-keyword">c</span>.Test<span class="hljs-number">28</span> - main <span class="hljs-keyword">begin</span><br></code></pre></td></tr></table></figure><p>与join相比，CountdownLatch可以配合线程池使用</p><h5 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h5><p>模拟加载进度条</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">10</span>);<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>    <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br><br>    <span class="hljs-comment">// 存放加载进度</span><br>    String[] all = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">10</span>];<br>    <span class="hljs-comment">// 模拟加载进度条</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> i;<br>        pool.submit(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">100</span>; j++) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(random.nextInt(<span class="hljs-number">100</span>));<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                all[k] = j + <span class="hljs-string">&quot;%&quot;</span>;<br>                <span class="hljs-comment">// \r表示回车，从当前行开始输入，会覆盖之前的内容</span><br>                System.out.print(<span class="hljs-string">&quot;\r&quot;</span> + Arrays.toString(all));<br>            &#125;<br>            latch.countDown();<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        latch.await();<br>        System.out.println(<span class="hljs-string">&quot;\n加载完成&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br><br>    <span class="hljs-comment">// 关闭线程池</span><br>    pool.shutdown();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">// 控制台</span><br>[<span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>, <span class="hljs-number">100</span><span class="hljs-meta">%</span>]<br>加载完成<br></code></pre></td></tr></table></figure><h4 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h4><p>循环栅栏，与CountdownLatch相似，不同在于CountdownLatch减完就没了，而cyclicBarrier可以重用</p><table><thead><tr><th>方法</th><th>作用</th></tr></thead><tbody><tr><td>await()</td><td>当前线程等待，count - 1，只有count为0时所有等待的线程才继续运行</td></tr></tbody></table><h5 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h5><p>当await的线程数到达2时，才会继续运行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">2</span>);<br>    <span class="hljs-type">CyclicBarrier</span> <span class="hljs-variable">barrier</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CyclicBarrier</span>(<span class="hljs-number">2</span>, () -&gt; &#123;<br>        <span class="hljs-comment">// 所有线程执行完后打印</span><br>        log.debug(<span class="hljs-string">&quot;task1 task2 finish&quot;</span>);<br>    &#125;);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) &#123;<br>        pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;task1 begin...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">1000</span>);<br>                barrier.await();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br><br>        pool.submit(() -&gt; &#123;<br>            log.debug(<span class="hljs-string">&quot;task1 begin...&quot;</span>);<br>            <span class="hljs-keyword">try</span> &#123;<br>                Thread.sleep(<span class="hljs-number">2000</span>);<br>                barrier.await();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    pool.shutdown();<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// 控制台</span><br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">14</span> <span class="hljs-selector-attr">[pool-1-thread-1]</span> c<span class="hljs-selector-class">.Test29</span> - task1 begin...<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">14</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test29</span> - task1 begin...<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">16</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test29</span> - task1 task2 finish<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">16</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test29</span> - task1 begin...<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">16</span> <span class="hljs-selector-attr">[pool-1-thread-1]</span> c<span class="hljs-selector-class">.Test29</span> - task1 begin...<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">18</span> <span class="hljs-selector-attr">[pool-1-thread-1]</span> c<span class="hljs-selector-class">.Test29</span> - task1 task2 finish<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">18</span> <span class="hljs-selector-attr">[pool-1-thread-1]</span> c<span class="hljs-selector-class">.Test29</span> - task1 begin...<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">18</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test29</span> - task1 begin...<br><span class="hljs-number">15</span>:<span class="hljs-number">26</span>:<span class="hljs-number">20</span> <span class="hljs-selector-attr">[pool-1-thread-2]</span> c<span class="hljs-selector-class">.Test29</span> - task1 task2 finish<br></code></pre></td></tr></table></figure><h4 id="线程安全集合类"><a href="#线程安全集合类" class="headerlink" title="线程安全集合类"></a>线程安全集合类</h4><h5 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h5><p>保证了每个方法的原子性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ALPHA</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;abcedfghijklmnopqrstuvwxyz&quot;</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    demo(<br>        () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, LongAdder&gt;(),<br>        (map, words) -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (String word : words) &#123;<br>                <span class="hljs-comment">// 如果map中没有这个key，则生成一个value, 然后把key value放入map中</span><br>                <span class="hljs-comment">// 保证了这些操作的原子性</span><br>                <span class="hljs-type">LongAdder</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> map.computeIfAbsent(word, (key) -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>());<br>                <span class="hljs-comment">// 累加</span><br>                value.increment();<br>            &#125;<br>        &#125;<br>    );<br><br>&#125;<br><br><span class="hljs-comment">// 生成文件</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> ALPHA.length();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">200</span>;<br>    <span class="hljs-comment">// 将威哥字母都加200个到集合list中</span><br>    List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(length * count);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++) &#123;<br>        <span class="hljs-type">char</span> <span class="hljs-variable">ch</span> <span class="hljs-operator">=</span> ALPHA.charAt(i);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; count; j++) &#123;<br>            list.add(String.valueOf(ch));<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 打乱数组list</span><br>    Collections.shuffle(list);<br><br>    <span class="hljs-comment">// 每200个字母放到一个文件中，每个字母占一行</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">26</span>; i++) &#123;<br>        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;tmp/&quot;</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">&quot;.txt&quot;</span>)))) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">collect</span> <span class="hljs-operator">=</span> list.subList(i * count, (i + <span class="hljs-number">1</span>) * count).stream()<br>                .collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>            out.print(collect);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 从文件中获取字母，统计字母出现次数</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;V&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">demo</span><span class="hljs-params">(Supplier&lt;Map&lt;String, V&gt;&gt; supplier,</span><br><span class="hljs-params">                             BiConsumer&lt;Map&lt;String, V&gt;, List&lt;String&gt;&gt; consumer)</span> &#123;<br>    Map&lt;String, V&gt; counterMap = supplier.get();<br>    List&lt;Thread&gt; ts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">26</span>; i++) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> i;<br>        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>            <span class="hljs-comment">// 读取文件，执行计数</span><br>            List&lt;String&gt; words = readFromFile(idx);<br>            consumer.accept(counterMap, words);<br>        &#125;);<br>        ts.add(thread);<br>    &#125;<br>    ts.forEach(t -&gt; t.start());<br>    ts.forEach(t -&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            t.join();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;);<br>    System.out.println(counterMap);<br>&#125;<br><br><span class="hljs-comment">// 读取文件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;String&gt; <span class="hljs-title function_">readFromFile</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span> &#123;<br>    ArrayList&lt;String&gt; words = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;tmp/&quot;</span><br>                                                                                          + i + <span class="hljs-string">&quot;.txt&quot;</span>)))) &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">word</span> <span class="hljs-operator">=</span> in.readLine();<br>            <span class="hljs-keyword">if</span> (word == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>            words.add(word);<br>        &#125;<br>        <span class="hljs-keyword">return</span> words;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nix">// 控制台<br>&#123;<span class="hljs-attr">a=200,</span> <span class="hljs-attr">b=200,</span> <span class="hljs-attr">c=200,</span> <span class="hljs-attr">d=200,</span> <span class="hljs-attr">e=200,</span> <span class="hljs-attr">f=200,</span> <span class="hljs-attr">g=200,</span> <span class="hljs-attr">h=200,</span> <span class="hljs-attr">i=200,</span> <span class="hljs-attr">j=200,</span> <span class="hljs-attr">k=200,</span> <span class="hljs-attr">l=200,</span> <span class="hljs-attr">m=200,</span> <span class="hljs-attr">n=200,</span> <span class="hljs-attr">o=200,</span> <span class="hljs-attr">p=200,</span> <span class="hljs-attr">q=200,</span> <span class="hljs-attr">r=200,</span> <span class="hljs-attr">s=200,</span> <span class="hljs-attr">t=200,</span> <span class="hljs-attr">u=200,</span> <span class="hljs-attr">v=200,</span> <span class="hljs-attr">w=200,</span> <span class="hljs-attr">x=200,</span> <span class="hljs-attr">y=200,</span> <span class="hljs-attr">z=200&#125;</span><br></code></pre></td></tr></table></figure><h6 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h6><p><strong>死链</strong></p><p>哈希表中的链表出现了死循环，出现在<strong>jdk7</strong></p><p>当哈希表中的元素数量达到容量的3&#x2F;4时，会扩容哈希表</p><p>jdk7是采用头插法建立链表，多线程时，当一个线程扩容完，另一个线程也去扩容</p><p>会导致链表中产生循环链表，从而直接卡死</p><blockquote><p>JDK 8 虽然将扩容算法做了调整，不再将元素加入链表头（而是保持与扩容前一样的顺序），但仍不意味着能 够在多线程环境下能够安全扩容，还会出现其它问题（如扩容丢数据）</p></blockquote><p><strong>构造函数</strong></p><p>参数：初始容量、负载因子、并发度</p><blockquote><ul><li>初始容量要 &gt;&#x3D; 并发度，如果初始容量设置的小于并发度，则会被改成&#x3D;并发度</li><li>容量得是2^n，因此传过来的容量不一定就是map的实际容量</li><li>实现了<strong>懒惰初始化</strong>(jdk8)，在构造方法中<strong>仅仅计算了 table 的大小</strong>，以后在第一次使用时才会真正创建</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcurrentHashMap</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity,</span><br><span class="hljs-params">                         <span class="hljs-type">float</span> loadFactor, <span class="hljs-type">int</span> concurrencyLevel)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!(loadFactor &gt; <span class="hljs-number">0.0f</span>) || initialCapacity &lt; <span class="hljs-number">0</span> || concurrencyLevel &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>();<br>    <span class="hljs-keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="hljs-comment">// Use at least as many bins</span><br>        initialCapacity = concurrencyLevel;   <span class="hljs-comment">// as estimated threads</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>)(<span class="hljs-number">1.0</span> + (<span class="hljs-type">long</span>)initialCapacity / loadFactor);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> (size &gt;= (<span class="hljs-type">long</span>)MAXIMUM_CAPACITY) ?<br>        MAXIMUM_CAPACITY : tableSizeFor((<span class="hljs-type">int</span>)size);<br>    <span class="hljs-built_in">this</span>.sizeCtl = cap;<span class="hljs-comment">// 只计算了容量，还没有初始化map</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>get函数</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br>    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="hljs-type">int</span> n, eh; K ek;<br>    <span class="hljs-comment">// spread 方法能确保返回结果是正数</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> spread(key.hashCode());<br>    <span class="hljs-keyword">if</span> ((tab = table) != <span class="hljs-literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="hljs-number">0</span> &amp;&amp;<br>        (e = tabAt(tab, (n - <span class="hljs-number">1</span>) &amp; h)) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 如果头结点已经是要查找的 key</span><br>        <span class="hljs-keyword">if</span> ((eh = e.hash) == h) &#123;<br>            <span class="hljs-keyword">if</span> ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek)))<br>                <span class="hljs-keyword">return</span> e.val;<br>        &#125;<br>        <span class="hljs-comment">// hash 为负数表示该 bin 在扩容中或是 treebin, 这时调用 find 方法来查找</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (eh &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-keyword">return</span> (p = e.find(h, key)) != <span class="hljs-literal">null</span> ? p.val : <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 头结点不是要找的节点，则正常遍历链表/红黑树, 用 equals 比较</span><br>        <span class="hljs-keyword">while</span> ((e = e.next) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (e.hash == h &amp;&amp;<br>                ((ek = e.key) == key || (ek != <span class="hljs-literal">null</span> &amp;&amp; key.equals(ek))))<br>                <span class="hljs-keyword">return</span> e.val;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>put函数</strong></p><p>key如果已存在，默认覆盖旧值</p><p>通过cas来创建节点、添加到头结点，不使用synchronized来提高效率</p><p>如果发现头结点值为-1，则说明哈希表正在扩容，则会先去帮忙扩容</p><p>在要插入值的时候，会锁住当前的链表&#x2F;红黑树</p><p><strong>initTable函数</strong></p><p>真正创建hash表</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;<br>    Node&lt;K,V&gt;[] tab; <span class="hljs-type">int</span> sc;<br>    <span class="hljs-keyword">while</span> ((tab = table) == <span class="hljs-literal">null</span> || tab.length == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> ((sc = sizeCtl) &lt; <span class="hljs-number">0</span>)<br>            Thread.yield();<br>        <span class="hljs-comment">// 尝试将 sizeCtl 设置为 -1（表示初始化 table）</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (U.compareAndSwapInt(<span class="hljs-built_in">this</span>, SIZECTL, sc, -<span class="hljs-number">1</span>)) &#123;<br>            <span class="hljs-comment">// 获得锁, 创建 table, 这时其它线程会在 while() 循环中 yield 直至 table 创建</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-literal">null</span> || tab.length == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> (sc &gt; <span class="hljs-number">0</span>) ? sc : DEFAULT_CAPACITY;<br>                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;?,?&gt;[n];<br>                    table = tab = nt;<br>                    sc = n - (n &gt;&gt;&gt; <span class="hljs-number">2</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                sizeCtl = sc;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> tab;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>size计算流程</strong></p><p>size 计算实际发生在 put，remove 改变集合元素的操作之中 </p><ul><li>没有竞争发生，向 baseCount 累加计数</li><li>有竞争发生，新建 counterCells，向其中的一个 cell 累加计数 <ul><li>counterCells 初始有两个 </li><li>cell 如果计数竞争比较激烈，会创建新的 cell 来累加计数</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> sumCount();<br>    <span class="hljs-keyword">return</span> ((n &lt; <span class="hljs-number">0L</span>) ? <span class="hljs-number">0</span> :<br>            (n &gt; (<span class="hljs-type">long</span>)Integer.MAX_VALUE) ? Integer.MAX_VALUE :<br>            (<span class="hljs-type">int</span>)n);<br>&#125;<br><br><span class="hljs-comment">// 合并累加单元到baseCount</span><br><span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sumCount</span><span class="hljs-params">()</span> &#123;<br>    CounterCell[] as = counterCells; CounterCell a;<br>    <span class="hljs-comment">// 将 baseCount 计数与所有 cell 计数累加</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> baseCount;<br>    <span class="hljs-keyword">if</span> (as != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; as.length; ++i) &#123;<br>            <span class="hljs-keyword">if</span> ((a = as[i]) != <span class="hljs-literal">null</span>)<br>                sum += a.value;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>java</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>OSS</title>
    <link href="/2022/11/13/%E5%85%B6%E4%BB%96/OSS/"/>
    <url>/2022/11/13/%E5%85%B6%E4%BB%96/OSS/</url>
    
    <content type="html"><![CDATA[<h2 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h2><blockquote><p>对象存储（Object Storage Service，简称 OSS）是海量、安全、低成本、高可靠的<strong>云存储服务</strong>，具有与平台无关RESTful API，能从互联网任何位置访问。OSS提供标准、低频、归档等类型选择，全面优化存储成本。</p></blockquote><h3 id="阿里云OSS"><a href="#阿里云OSS" class="headerlink" title="阿里云OSS"></a>阿里云OSS</h3><p><a href="https://www.aliyun.com/product/oss?spm=5176.21213303.J_6704733920.7.19c253c9R6hA1l&scm=20140722.S_product@@%E4%BA%91%E4%BA%A7%E5%93%81@@102633._.ID_product@@%E4%BA%91%E4%BA%A7%E5%93%81@@102633-RL_%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8OSS-LOC_main-OR_ser-V_2-P0_0">对象存储OSS-阿里云</a></p><p>创建bucket</p><p>根据官网文档导入依赖、使用功能</p><h3 id="七牛云OSS"><a href="#七牛云OSS" class="headerlink" title="七牛云OSS"></a>七牛云OSS</h3><p><a href="https://portal.qiniu.com/home">七牛云 - 产品主页 (qiniu.com)</a></p><p><a href="https://developer.qiniu.com/kodo/1239/java#install-by-maven">Java SDK_SDK 下载_对象存储 - 七牛开发者中心 (qiniu.com)</a></p><p>大致步骤：</p><ol><li>找样例代码</li><li>修改<code>accessKey</code>、<code>secretKey</code>和<code>bucket</code>为自己的</li><li>修改要上传的文件所在的本地路径</li><li>测试</li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hutool</title>
    <link href="/2022/11/12/%E5%85%B6%E4%BB%96/Hutool/"/>
    <url>/2022/11/12/%E5%85%B6%E4%BB%96/Hutool/</url>
    
    <content type="html"><![CDATA[<h2 id="Hutool"><a href="#Hutool" class="headerlink" title="Hutool"></a>Hutool</h2><blockquote><p>Hutool是一个小而全的Java工具类库，通过静态方法封装，降低相关API的学习成本，提高工作效率，使Java拥有函数式语言般的优雅</p></blockquote><p><a href="https://www.hutool.cn/docs/#/">官网</a></p><h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>通过阿里云发送短信</title>
    <link href="/2022/11/12/%E5%85%B6%E4%BB%96/%E9%80%9A%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1/"/>
    <url>/2022/11/12/%E5%85%B6%E4%BB%96/%E9%80%9A%E8%BF%87%E9%98%BF%E9%87%8C%E4%BA%91%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="通过阿里云发送短信"><a href="#通过阿里云发送短信" class="headerlink" title="通过阿里云发送短信"></a>通过阿里云发送短信</h2><blockquote><p>这里通过测试API来发送</p></blockquote><p><a href="https://www.aliyun.com/">阿里云网址</a></p><h3 id="查看官网"><a href="#查看官网" class="headerlink" title="查看官网"></a>查看官网</h3><ul><li><p>搜索短信服务</p><p><img src="/img/else_img/aliyunMSM1.png"></p></li><li><p>绑定测试手机号，点击调用API</p><p><img src="/img/else_img/aliyunMSM2.png"></p></li><li><p>可以看到有发送短信的示例代码</p><p><img src="/img/else_img/aliyunMSM3.png"></p></li><li><p>创建用于发送短信的AccessKey</p><p><img src="/img/else_img/aliyunMSM4.png"></p><p><img src="/img/else_img/aliyunMSM5.png"></p></li><li><p>创建完用户后给其分配发送SMS的权限</p><p><img src="/img/else_img/aliyunMSM6.png"></p></li><li><p>给用户创建AccessKey（创建完记得保存）</p><p><img src="/img/else_img/aliyunMSM7.png"></p></li></ul><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><ul><li>根据示例代码，首先导入依赖</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 阿里云短信服务 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aliyun-java-sdk-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aliyun-java-sdk-dysmsapi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><p>这里通过将AccessKey 和密钥放到配置文件中，再通过@Value注解来读取</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 地域节点</span><br><span class="hljs-attr">aliyun.sms.regionId</span>=<span class="hljs-string">default</span><br><span class="hljs-comment"># 访问ID</span><br><span class="hljs-attr">aliyun.sms.accessKeyId</span>=<span class="hljs-string"></span><br><span class="hljs-comment"># 访问密钥</span><br><span class="hljs-attr">aliyun.sms.secret</span>=<span class="hljs-string"></span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-comment">// InitializingBean接口为bean提供了属性初始化后的处理方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstantPropertiesUtils</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;aliyun.sms.regionId&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String regionId;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;aliyun.sms.accessKeyId&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String accessKeyId;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;aliyun.sms.secret&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String secret;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String REGION_Id;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String ACCESS_KEY_ID;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String SECRET;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        REGION_Id = regionId;<br>        ACCESS_KEY_ID = accessKeyId;<br>        SECRET = secret;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建发送短信的service</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MsmServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MsmService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String code)</span> &#123;<br><br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(phone))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 基础配置</span><br>        <span class="hljs-type">DefaultProfile</span> <span class="hljs-variable">profile</span> <span class="hljs-operator">=</span> DefaultProfile.getProfile(<br>                ConstantPropertiesUtils.REGION_Id,  <span class="hljs-comment">// 地域节点</span><br>                ConstantPropertiesUtils.ACCESS_KEY_ID,  <span class="hljs-comment">// 访问ID</span><br>                ConstantPropertiesUtils.SECRET);    <span class="hljs-comment">//访问密钥</span><br><br>        <span class="hljs-type">IAcsClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAcsClient</span>(profile);<br><br>        <span class="hljs-type">SendSmsRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendSmsRequest</span>();<br>        request.setSignName(<span class="hljs-string">&quot;阿里云短信测试&quot;</span>); <span class="hljs-comment">// 短信签名</span><br>        request.setTemplateCode(<span class="hljs-string">&quot;SMS_154950909&quot;</span>);   <span class="hljs-comment">// 短信模板</span><br>        request.setPhoneNumbers(phone); <span class="hljs-comment">// 发送的手机号</span><br>        request.setTemplateParam(<span class="hljs-string">&quot;&#123;\&quot;code\&quot;:\&quot;&quot;</span> + code + <span class="hljs-string">&quot;\&quot;&#125;&quot;</span>);    <span class="hljs-comment">// 发送的验证码</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 发送短信</span><br>            <span class="hljs-type">SendSmsResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.getAcsResponse(request);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;OK&quot;</span>.equals(response.getCode());<br>        &#125; <span class="hljs-keyword">catch</span> (ServerException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (ClientException e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;ErrCode:&quot;</span> + e.getErrCode());<br>            System.out.println(<span class="hljs-string">&quot;ErrMsg:&quot;</span> + e.getErrMsg());<br>            System.out.println(<span class="hljs-string">&quot;RequestId:&quot;</span> + e.getRequestId());<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nuxt</title>
    <link href="/2022/11/07/%E5%89%8D%E7%AB%AF/nuxt/nuxt/"/>
    <url>/2022/11/07/%E5%89%8D%E7%AB%AF/nuxt/nuxt/</url>
    
    <content type="html"><![CDATA[<h2 id="Nuxt"><a href="#Nuxt" class="headerlink" title="Nuxt"></a>Nuxt</h2><blockquote><p>服务端渲染：服务端渲染又称SSR (Server Side Render)是在服务端完成页面的内容，而不是在客户端通过AJAX获取数据。</p><p>Nuxt：Nuxt.js 是一个基于 Vue.js 的轻量级应用框架,可用来创建服务端渲染 (SSR) 应用,也可充当静态站点引擎生成静态站点应用,具有优雅的代码结构分层和热加载等特性。</p></blockquote><p><a href="https://www.nuxtjs.org.cn/">官网</a></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Nuxt</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Nuxt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>easyExcel</title>
    <link href="/2022/10/14/%E5%85%B6%E4%BB%96/easyExcel/"/>
    <url>/2022/10/14/%E5%85%B6%E4%BB%96/easyExcel/</url>
    
    <content type="html"><![CDATA[<h2 id="easyExcel"><a href="#easyExcel" class="headerlink" title="easyExcel"></a>easyExcel</h2><blockquote><p>EasyExcel是一个基于Java的、快速、简洁、解决大文件内存溢出的Excel处理工具。<br>他能让你在不用考虑性能、内存的等因素的情况下，快速完成Excel的读、写等功能。</p></blockquote><p><a href="https://easyexcel.opensource.alibaba.com/docs/current/">关于Easyexcel | Easy Excel (alibaba.com)</a></p><h3 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h3><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easyexcel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在实体类的属性上添加注解，设置Excel表表头信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserData</span> &#123;<br><br>    <span class="hljs-meta">@ExcelProperty(&quot;用户编号&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> uid;<br><br>    <span class="hljs-meta">@ExcelProperty(&quot;用户名称&quot;)</span><br>    <span class="hljs-keyword">private</span> String username;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>写入内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">testWrite</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 文件路径</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\excel\\01.xlsx&quot;</span>;<br><br>        <span class="hljs-comment">// 要写入的内容</span><br>        ArrayList&lt;UserData&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;<br>            list.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserData</span>(i, <span class="hljs-string">&quot;name&quot;</span> + i));<br>        &#125;<br><br>        <span class="hljs-comment">// 写入excel表</span><br>        EasyExcel.write(fileName, UserData.class)<br>                .sheet(<span class="hljs-string">&quot;用户信息&quot;</span>)  <span class="hljs-comment">// excel表表名</span><br>                .doWrite(list);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/else_img/easyExcel1.png"></p></li></ul><h3 id="读出"><a href="#读出" class="headerlink" title="读出"></a>读出</h3><ul><li><p>实体类上要添加相对应的列号</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ExcelProperty(value = &quot;用户编号&quot;, index = 0)</span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> uid;<br><br><span class="hljs-meta">@ExcelProperty(value = &quot;用户名称&quot;, index = 1)</span><br><span class="hljs-keyword">private</span> String username;<br></code></pre></td></tr></table></figure></li><li><p>编写监听方法，当读取excel时会执行此监听方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnalysisEventListener</span>&lt;UserData&gt; &#123;<br><br>    <span class="hljs-comment">// 一行行读取excel内容，从第二行开始读取</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(UserData userData, AnalysisContext analysisContext)</span> &#123;<br>        System.out.println(userData);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterAllAnalysed</span><span class="hljs-params">(AnalysisContext analysisContext)</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-comment">// 读取表头信息</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeHeadMap</span><span class="hljs-params">(Map&lt;Integer, String&gt; headMap, AnalysisContext context)</span> &#123;<br>        System.out.println(headMap);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>读出内容</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestRead</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;F:\\excel\\01.xlsx&quot;</span>;<br><br>        EasyExcel.read(fileName,<br>                UserData.class,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelListener</span>()).sheet().doRead();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/else_img/easyExcel2.png"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>vue-element-admin简单使用</title>
    <link href="/2022/10/13/%E5%89%8D%E7%AB%AF/vue-element-admin/vue-element-admin%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <url>/2022/10/13/%E5%89%8D%E7%AB%AF/vue-element-admin/vue-element-admin%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="vue-element-admin简单使用"><a href="#vue-element-admin简单使用" class="headerlink" title="vue-element-admin简单使用"></a>vue-element-admin简单使用</h2><blockquote><p><a href="https://link.zhihu.com/?target=https://panjiachen.gitee.io/vue-element-admin-site/zh/">vue-element-admin</a> 是一个后台前端解决方案，它基于 <a href="https://link.zhihu.com/?target=https://github.com/vuejs/vue">vue</a> 和 <a href="https://link.zhihu.com/?target=https://github.com/ElemeFE/element">element-ui</a>实现。它使用了最新的前端技术栈，内置了 i18 国际化解决方案，动态路由，权限验证，提炼了典型的业务模型，提供了丰富的功能组件，它可以帮助你快速搭建企业级中后台产品原型。</p></blockquote><h3 id="控制面板添加路由"><a href="#控制面板添加路由" class="headerlink" title="控制面板添加路由"></a>控制面板添加路由</h3><ul><li><p>在<code>router/index.js</code>文件中添加路由，就会显示到面板上</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 自己添加的路由</span><br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/hospSet&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">Layout</span>,<br>    <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/hospSet/list&#x27;</span>,<br>    <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;医院设置管理&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;example&#x27;</span>&#125;,<br>    <span class="hljs-attr">children</span>: [<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/list&#x27;</span>,<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;医院设置列表&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/i18n-demo/index&#x27;</span>),<br>        <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;医院设置列表&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;table&#x27;</span> &#125;<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/add&#x27;</span>,<br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;医院设置列表添加&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/i18n-demo/index&#x27;</span>),<br>        <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;医院设置列表添加&#x27;</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">&#x27;tree&#x27;</span> &#125;<br>      &#125;<br>    ]<br>  &#125;,<br></code></pre></td></tr></table></figure></li><li><p>将组件文件地址换成自己的</p></li><li><p>配置个自己的axios来发送请求</p></li><li><p>在<code>api</code>文件夹下创建发送请求的js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/utils/myAxios&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getHospSetList</span>(<span class="hljs-params">current, limit, searchObj</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">axios</span>(&#123;<br>    <span class="hljs-attr">url</span>: <span class="hljs-string">`/admin/hosp/hospitalSet/findPage/<span class="hljs-subst">$&#123;current&#125;</span>/<span class="hljs-subst">$&#123;limit&#125;</span>`</span>,<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;post&#x27;</span>,<br>    <span class="hljs-attr">data</span>: searchObj<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>vue-element-admin</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>安装vue-element-admin</title>
    <link href="/2022/10/12/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E5%AE%89%E8%A3%85vue-element-admin/"/>
    <url>/2022/10/12/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E5%AE%89%E8%A3%85vue-element-admin/</url>
    
    <content type="html"><![CDATA[<h2 id="安装vue-element-admin"><a href="#安装vue-element-admin" class="headerlink" title="安装vue-element-admin"></a>安装vue-element-admin</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/panjiachen/</span>vue-element-admin.git client-action<br><br>cd client-action<br><br>git branch -a<br><br>git checkout -b i18n remotes<span class="hljs-regexp">/origin/i</span>18n<br><br>git config --global url.<span class="hljs-string">&quot;https://&quot;</span>.insteadOf git:<span class="hljs-regexp">//</span><br><br>npm install<br><br>npm run dev<br></code></pre></td></tr></table></figure><ul><li>需要切换分支到 i18n，否则不支持国际化（中文）功能</li><li>npm install 要多试几次，因为中间会连接 gitbub 下载一些依赖，网络不稳定会导致失败</li><li>npm run dev 运行后回自动打开浏览器，使用的端口是 9527</li><li>安装失败可以试试<a href="https://blog.csdn.net/qq_43271844/article/details/125865607">npm install 安装tui-editor报错解决_Thorold’s Deer的博客-CSDN博客_tui-editor vue</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>搭建环境</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WebPack打包工具</title>
    <link href="/2022/10/12/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/WebPack%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7/"/>
    <url>/2022/10/12/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/WebPack%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7/</url>
    
    <content type="html"><![CDATA[<h2 id="WebPack打包工具"><a href="#WebPack打包工具" class="headerlink" title="WebPack打包工具"></a>WebPack打包工具</h2><blockquote><p>Webpack 是一个前端资源加载&#x2F;打包工具。它将根据模块的依赖关系进行静态分析，然后将这些模块按照指定的规则生成对应的静态资源。</p><p>Webpack 可以将多种静态资源 js、css、less 转换成一个静态文件，减少了页面的请求。 </p></blockquote><ul><li><p>全局安装</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">npm install -g webpack webpack-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure></li><li><p>创建配置文件<code>webpack.config.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span> <span class="hljs-comment">//Node.js内置模块</span><br><span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">resolve</span>()<br><br><span class="hljs-comment">// 打包的是js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>    <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;./src/main.js&#x27;</span>, <span class="hljs-comment">//配置入口文件</span><br>    <span class="hljs-attr">output</span>: &#123;<br>        <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;./dist&#x27;</span>), <span class="hljs-comment">//输出路径，__dirname：当前文件所在路径</span><br>        <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;bundle.js&#x27;</span><span class="hljs-comment">//输出文件</span><br>    &#125;   <br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建dist文件夹，用于放置打包后的文件</p></li><li><p>执行打包命令</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">webpack <span class="hljs-attribute">--mode</span>=development<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>搭建环境</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>搭建前端项目</title>
    <link href="/2022/10/12/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E6%90%AD%E5%BB%BA%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/"/>
    <url>/2022/10/12/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E6%90%AD%E5%BB%BA%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="搭建前端项目"><a href="#搭建前端项目" class="headerlink" title="搭建前端项目"></a>搭建前端项目</h2><blockquote><p>npm包管理工具</p></blockquote><ul><li><p>查看npm版本</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">npm</span> -v<br></code></pre></td></tr></table></figure></li><li><p>在项目文件夹下，项目初始化</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">npm</span> init<br><br><span class="hljs-comment"># 之后按照提示输入相关信息</span><br><span class="hljs-comment"># 或者加个-y参数，直接只生成一个package.json文件</span><br></code></pre></td></tr></table></figure></li><li><p>修改npm镜像</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">npm config set registry https:<span class="hljs-comment">//registry.npm.taobao.org</span><br></code></pre></td></tr></table></figure></li><li><p>查看npm配置信息</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">npm config list<br></code></pre></td></tr></table></figure></li><li><p>下载依赖(全局&#x2F;当前项目)</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">npm install</span> <span class="hljs-title">[</span><span class="hljs-literal">--</span><span class="hljs-comment">global/</span><span class="hljs-literal">--</span><span class="hljs-comment">save</span><span class="hljs-literal">-</span><span class="hljs-comment">dev</span><span class="hljs-title">]</span> <span class="hljs-comment">依赖名</span><br></code></pre></td></tr></table></figure></li><li><p>在package.json文件中添加<code>&quot;type&quot;: &quot;module&quot;</code>就可使用<code>import</code>来导入其他模块</p></li></ul><blockquote><p>npm管理的项目在备份和传输的时候一般不携带node_modules文件夹</p><p>安装会自动在项目目录下添加 package-lock.json文件，这个文件帮助锁定安装包的版本</p><p>npm install     #根据package.json中的配置下载依赖，初始化项目</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>搭建环境</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>自定义异常处理器</title>
    <link href="/2022/10/11/spring/springboot/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8/"/>
    <url>/2022/10/11/spring/springboot/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="自定义异常处理器"><a href="#自定义异常处理器" class="headerlink" title="自定义异常处理器"></a>自定义异常处理器</h2><p><strong>案例</strong></p><ul><li><p>自定义异常类</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">package</span> com.xw.yygh.common.exception;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义全局异常类</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> qy</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ApiModel(value = <span class="hljs-string">&quot;自定义全局异常类&quot;</span>)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YyghException</span> <span class="hljs-title">extends</span> <span class="hljs-title">RuntimeException</span> &#123;<br><br>    <span class="hljs-meta">@ApiModelProperty(value = <span class="hljs-string">&quot;异常状态码&quot;</span>)</span><br>    <span class="hljs-keyword">private</span> Integer code;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过状态码和错误消息创建异常对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> message</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> code</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> YyghException(String message, Integer code) &#123;<br>        <span class="hljs-keyword">super</span>(message);<br>        <span class="hljs-keyword">this</span>.code = code;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 接收枚举类型对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resultCodeEnum</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> YyghException(ResultCodeEnum resultCodeEnum) &#123;<br>        <span class="hljs-keyword">super</span>(resultCodeEnum.getMessage());<br>        <span class="hljs-keyword">this</span>.code = resultCodeEnum.getCode();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String toString() &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;YyghException&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;code=&quot;</span> + code +<br>                <span class="hljs-string">&quot;, message=&quot;</span> + <span class="hljs-keyword">this</span>.getMessage() +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>添加全局异常处理类</p><p>采用AOP实现</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jaba">package com.xw.yygh.common.exception;<br><br>@ControllerAdvice<br>@ResponseBody<br>public class GlobalExceptionHandler &#123;<br><br>    // 处理自定义异常<br>    @ExceptionHandler(YyghException.class)<br>    public Result error(YyghException e) &#123;<br>        e.printStackTrace();<br>        return Result.fail();<br>    &#125;<br><br>    // 处理Exception异常<br>    @ExceptionHandler(Exception.class)<br>    public Result error(Exception e) &#123;<br>        e.printStackTrace();<br>        return Result.fail();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
      <category>springBoot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot输出日志到文件</title>
    <link href="/2022/10/11/spring/springboot/SpringBoot%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97%E5%88%B0%E6%96%87%E4%BB%B6/"/>
    <url>/2022/10/11/spring/springboot/SpringBoot%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97%E5%88%B0%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="SpringBoot输出日志到文件"><a href="#SpringBoot输出日志到文件" class="headerlink" title="SpringBoot输出日志到文件"></a>SpringBoot输出日志到文件</h2><p>日志记录器（Logger）的行为等级，越往下日志越详细：</p><ul><li>OFF</li><li>FATA</li><li>ERROR</li><li>WARN</li><li>INFO</li><li>DEBUG</li><li>ALL</li></ul><p>通过配置文件设置<code>logging.level.root=</code>来设置日志级别</p><p>要想输出日志文件，需要在resource目录下编写logback-spring.xml文件</p><p>之后就会输出到文件中</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>  <span class="hljs-attr">scan</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">scanPeriod</span>=<span class="hljs-string">&quot;10 seconds&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 日志级别从低到高分为TRACE &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL，如果设置为WARN，则低于WARN的信息都不会输出 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- scan:当此属性设置为true时，配置文件如果发生改变，将会被重新加载，默认值为true --&gt;</span><br>    <span class="hljs-comment">&lt;!-- scanPeriod:设置监测配置文件是否有修改的时间间隔，如果没有给出时间单位，默认单位是毫秒。当scan为true时，此属性生效。默认的时间间隔为1分钟。 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- de<span class="hljs-doctag">bug:</span>当此属性设置为true时，将打印出logback内部日志信息，实时查看logback运行状态。默认值为false。 --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">contextName</span>&gt;</span>logback<span class="hljs-tag">&lt;/<span class="hljs-name">contextName</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- name的值是变量的名称，value的值时变量定义的值。通过定义的值会被插入到logger上下文中。定义变量后，可以使“$&#123;&#125;”来使用变量。 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;log.path&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;F:/yygh_log&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 彩色日志 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- 配置格式变量：CONSOLE_LOG_PATTERN 彩色日志格式 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- magenta:洋红 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- boldMagenta:粗红--&gt;</span><br>    <span class="hljs-comment">&lt;!-- cyan:青色 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- white:白色 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- magenta:洋红 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;CONSOLE_LOG_PATTERN&quot;</span></span><br><span class="hljs-tag">              <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;%yellow(%date&#123;yyyy-MM-dd HH:mm:ss&#125;) |%highlight(%-5level) |%blue(%thread) |%blue(%file:%line) |%green(%logger) |%cyan(%msg%n)&quot;</span>/&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!--输出到控制台--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;CONSOLE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--此日志appender是为开发使用，只配置最底级别，控制台输出的日志级别是大于或等于此级别的日志信息--&gt;</span><br>        <span class="hljs-comment">&lt;!-- 例如：如果此处配置了INFO级别，则后面其他位置即使配置了DEBUG级别的日志，也不会被输出 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>INFO<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Pattern</span>&gt;</span>$&#123;CONSOLE_LOG_PATTERN&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">Pattern</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 设置字符集 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!--输出到文件--&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 时间滚动输出 level为 INFO 日志 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;INFO_FILE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/log_info.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--日志文件输出格式--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 每天日志归档路径以及格式 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/info/log-info-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>100MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--日志文件保留天数--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 此日志文件只记录info级别的 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>INFO<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 时间滚动输出 level为 WARN 日志 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WARN_FILE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/log_warn.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--日志文件输出格式--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span> <span class="hljs-comment">&lt;!-- 此处设置字符集 --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/warn/log-warn-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>100MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--日志文件保留天数--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 此日志文件只记录warn级别的 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>warn<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!-- 时间滚动输出 level为 ERROR 日志 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;ERROR_FILE&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 正在记录的日志文件的路径及文件名 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>$&#123;log.path&#125;/log_error.log<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--日志文件输出格式--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">charset</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">charset</span>&gt;</span> <span class="hljs-comment">&lt;!-- 此处设置字符集 --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 日志记录器的滚动策略，按日期，按大小记录 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/error/log-error-%d&#123;yyyy-MM-dd&#125;.%i.log<span class="hljs-tag">&lt;/<span class="hljs-name">fileNamePattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>100MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--日志文件保留天数--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">maxHistory</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maxHistory</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 此日志文件只记录ERROR级别的 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">level</span>&gt;</span>ERROR<span class="hljs-tag">&lt;/<span class="hljs-name">level</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMatch</span>&gt;</span>ACCEPT<span class="hljs-tag">&lt;/<span class="hljs-name">onMatch</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">onMismatch</span>&gt;</span>DENY<span class="hljs-tag">&lt;/<span class="hljs-name">onMismatch</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        &lt;logger&gt;用来设置某一个包或者具体的某一个类的日志打印级别、以及指定&lt;appender&gt;。</span><br><span class="hljs-comment">        &lt;logger&gt;仅有一个name属性，</span><br><span class="hljs-comment">        一个可选的level和一个可选的addtivity属性。</span><br><span class="hljs-comment">        name:用来指定受此logger约束的某一个包或者具体的某一个类。</span><br><span class="hljs-comment">        level:用来设置打印级别，大小写无关：TRACE, DEBUG, INFO, WARN, ERROR, ALL 和 OFF，</span><br><span class="hljs-comment">              如果未设置此属性，那么当前logger将会继承上级的级别。</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">        使用mybatis的时候，sql语句是debug下才会打印，而这里我们只配置了info，所以想要查看sql语句的话，有以下两种操作：</span><br><span class="hljs-comment">        第一种把&lt;root level=&quot;INFO&quot;&gt;改成&lt;root level=&quot;DEBUG&quot;&gt;这样就会打印sql，不过这样日志那边会出现很多其他消息</span><br><span class="hljs-comment">        第二种就是单独给mapper下目录配置DEBUG模式，代码如下，这样配置sql语句会打印，其他还是正常DEBUG级别：</span><br><span class="hljs-comment">     --&gt;</span><br>    <span class="hljs-comment">&lt;!--开发环境:打印控制台--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">springProfile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dev&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--可以输出项目中的debug日志，包括mybatis的sql日志--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">logger</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.guli&quot;</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span> /&gt;</span><br><br>        <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">            root节点是必选节点，用来指定最基础的日志输出级别，只有一个level属性</span><br><span class="hljs-comment">            level:用来设置打印级别，大小写无关：TRACE, DEBUG, INFO, WARN, ERROR, ALL 和 OFF，默认是DEBUG</span><br><span class="hljs-comment">            可以包含零个或多个appender元素。</span><br><span class="hljs-comment">        --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;CONSOLE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;INFO_FILE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;WARN_FILE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;ERROR_FILE&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">springProfile</span>&gt;</span><br><br><br>    <span class="hljs-comment">&lt;!--生产环境:输出到文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">springProfile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pro&quot;</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;INFO&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;CONSOLE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;DEBUG_FILE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;INFO_FILE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;ERROR_FILE&quot;</span> /&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;WARN_FILE&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">springProfile</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
      <category>springBoot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MP逻辑删除</title>
    <link href="/2022/10/11/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4/"/>
    <url>/2022/10/11/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E9%80%BB%E8%BE%91%E5%88%A0%E9%99%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="MP逻辑删除"><a href="#MP逻辑删除" class="headerlink" title="MP逻辑删除"></a>MP逻辑删除</h2><blockquote><p>删除数据只是逻辑上删除，数据库中还能查到</p></blockquote><p>使用场景：</p><ul><li><p>可以进行数据恢复</p></li><li><p>有关联数据，不便删除</p></li><li><p>表中添加<code>deleted</code>字段，类型为boolean默认值为false</p></li><li><p>修改实体类，添加<code>deleted</code>字段</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableLogic</span><br><span class="hljs-keyword">private</span> Integer deleted;<br></code></pre></td></tr></table></figure></li><li><p>配置(下面是默认配置，可配可不配)</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 逻辑删除</span><br><span class="hljs-attr">mybatis-plus.global-config.db-config.logic-delete-value</span>=<span class="hljs-string">1</span><br><span class="hljs-attr">mybatis-plus.global-config.db-config.logic-not-delete-value</span>=<span class="hljs-string">0</span><br></code></pre></td></tr></table></figure></li><li><p>测试</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
      <category>mybatis-plus</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MP分页插件</title>
    <link href="/2022/10/11/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6/"/>
    <url>/2022/10/11/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E5%88%86%E9%A1%B5%E6%8F%92%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="MP分页插件"><a href="#MP分页插件" class="headerlink" title="MP分页插件"></a>MP分页插件</h2><ul><li><p>在mp配置类中添加分页插件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MpConfig</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 分页插件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">paginationInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>测试selectPage</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSelectPage</span><span class="hljs-params">()</span> &#123;<br>    Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);<br>    Page&lt;User&gt; userPage = mapper.selectPage(page, <span class="hljs-literal">null</span>);<br>    <span class="hljs-comment">//返回对象得到分页所有数据</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">pages</span> <span class="hljs-operator">=</span> userPage.getPages(); <span class="hljs-comment">//总页数</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> userPage.getCurrent(); <span class="hljs-comment">//当前页</span><br>    List&lt;User&gt; records = userPage.getRecords(); <span class="hljs-comment">//查询数据集合</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> userPage.getTotal(); <span class="hljs-comment">//总记录数</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">hasNext</span> <span class="hljs-operator">=</span> userPage.hasNext();  <span class="hljs-comment">//下一页</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">hasPrevious</span> <span class="hljs-operator">=</span> userPage.hasPrevious(); <span class="hljs-comment">//上一页</span><br><br>    System.out.println(pages);<br>    System.out.println(current);<br>    System.out.println(records);<br>    System.out.println(total);<br>    System.out.println(hasNext);<br>    System.out.println(hasPrevious);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
      <category>mybatis-plus</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MP乐观锁</title>
    <link href="/2022/10/11/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E4%B9%90%E8%A7%82%E9%94%81/"/>
    <url>/2022/10/11/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E4%B9%90%E8%A7%82%E9%94%81/</url>
    
    <content type="html"><![CDATA[<h2 id="MP乐观锁"><a href="#MP乐观锁" class="headerlink" title="MP乐观锁"></a>MP乐观锁</h2><ul><li><p>在mp配置类中添加乐观锁插件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MpConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 乐观锁插件</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> OptimisticLockerInterceptor <span class="hljs-title function_">optimisticLockerInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInterceptor</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>给类上添加<code>version</code>属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Version</span><br><span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span><br><span class="hljs-keyword">private</span> Integer version;<br></code></pre></td></tr></table></figure></li><li><p>插入时自动填充</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">&quot;createTime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),metaObject);<br>        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">&quot;updateTime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),metaObject);<br>        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">&quot;version&quot;</span>,<span class="hljs-number">1</span>,metaObject);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>        <span class="hljs-built_in">this</span>.setFieldValByName(<span class="hljs-string">&quot;updateTime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),metaObject);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>每次要修改时先查询出要修改的数据，修改后再放回数据库，version值会自动加一</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
      <category>mybatis-plus</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>10.Vuex</title>
    <link href="/2022/10/09/%E5%89%8D%E7%AB%AF/vue/10.Vuex/"/>
    <url>/2022/10/09/%E5%89%8D%E7%AB%AF/vue/10.Vuex/</url>
    
    <content type="html"><![CDATA[<h2 id="10-Vuex"><a href="#10-Vuex" class="headerlink" title="10.Vuex"></a>10.Vuex</h2><blockquote><p>vuex 可以在多个组件之间<strong>共享数据</strong>，并且共享的数据是【响应式】的，即数据的变更能及时渲染到模板</p></blockquote><h3 id="入门案例"><a href="#入门案例" class="headerlink" title="入门案例"></a>入门案例</h3><blockquote><p>通过vuex实现多个view间共享数据</p></blockquote><p>在src&#x2F;store目录下修改index.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vuex&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>(&#123;<br>  <span class="hljs-comment">// 共享数据</span><br>  <span class="hljs-attr">state</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-attr">getters</span>: &#123;<br>  &#125;,<br>  <span class="hljs-attr">mutations</span>: &#123;<br><br>    <span class="hljs-comment">// 修改数据</span><br>    <span class="hljs-title function_">updateName</span>(<span class="hljs-params">state, newName</span>) &#123;<br>      state.<span class="hljs-property">name</span> = newName<br>    &#125;<br><br>  &#125;,<br>  <span class="hljs-attr">actions</span>: &#123;<br>  &#125;,<br>  <span class="hljs-attr">modules</span>: &#123;<br>  &#125;<br>&#125;)<br><br></code></pre></td></tr></table></figure><p>P1View.vue添加数据</p><blockquote><p>通过this.$store.commit调用方法</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;p&quot;&gt;<br>        &lt;el-input placeholder=&quot;请修改用户姓名&quot; <br>            size=&quot;mini&quot; v-model=&quot;name&quot;&gt;&lt;/el-input&gt;<br>        &lt;el-button type=&quot;primary&quot; size=&quot;mini&quot; @click=&quot;update()&quot;&gt;修改&lt;/el-button&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br>&lt;script&gt;<br>const options = &#123;<br>    data() &#123;<br>        return &#123;<br>            name: &#x27;&#x27;<br>        &#125;<br>    &#125;,<br><br>    methods: &#123;<br>        update() &#123;<br>            // sessionStorage.setItem(&#x27;name&#x27;, this.name)<br>            // 修改共享数据<br>            this.$store.commit(&#x27;updateName&#x27;, this.name);<br>        &#125;<br>    &#125;<br>&#125;<br>export default options;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>ContainerView.vue获取数据</p><blockquote><p>通过$store.state.name插入数据</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;container&quot;&gt;<br>        &lt;el-container&gt;<br>            &lt;el-header&gt;<br>                &lt;div class=&quot;t&quot;&gt;欢迎您：&#123;&#123;name&#125;&#125;&lt;/div&gt;<br>            &lt;/el-header&gt;<br>            &lt;el-container&gt;<br>                &lt;el-aside width=&quot;200px&quot;&gt;<br>                &lt;/el-aside&gt;<br>                &lt;el-main&gt;<br>                    &lt;router-view&gt;&lt;/router-view&gt;<br>                &lt;/el-main&gt;<br>            &lt;/el-container&gt;<br>        &lt;/el-container&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br>&lt;script&gt;<br>const options = &#123;<br>    computed: &#123;<br>        name() &#123;<br>            return this.$store.state.name<br>        &#125;<br>    &#125;<br>&#125;<br>export default options;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="方法获取共享属性和修改方法"><a href="#方法获取共享属性和修改方法" class="headerlink" title="方法获取共享属性和修改方法"></a>方法获取共享属性和修改方法</h3><blockquote><p>调用vuex中的方法都是先导入mapXxx（Vuex.Store中的属性名）</p><p>再传入要调用&#x2F;使用的方法名&#x2F;共享属性名</p></blockquote><blockquote><p>mapState方法，生成共享属性对应的计算属性，<code>...</code>解构到computed中</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;container&quot;&gt;<br>        &lt;el-container&gt;<br>            &lt;el-header&gt;<br>                &lt;div class=&quot;t&quot;&gt;欢迎您：&#123;&#123;name&#125;&#125;&#123;&#123;age&#125;&#125;&lt;/div&gt;<br>            &lt;/el-header&gt;<br>            &lt;el-container&gt;<br>                &lt;el-aside width=&quot;200px&quot;&gt;<br>                &lt;/el-aside&gt;<br>                &lt;el-main&gt;<br>                    &lt;router-view&gt;&lt;/router-view&gt;<br>                &lt;/el-main&gt;<br>            &lt;/el-container&gt;<br>        &lt;/el-container&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br>&lt;script&gt;<br>import &#123;mapState&#125; from &#x27;vuex&#x27;<br><br>const options = &#123;<br>    computed: &#123;<br>        // 通过mapState方法，生成共享属性对应的计算属性<br>        ...mapState([&#x27;name&#x27;, &#x27;age&#x27;])<br>    &#125;<br>&#125;<br>export default options;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><blockquote><p>通过mapMutations方法，获取修改方法，<code>...</code>解构到methods中</p><p>参数在绑定click时传入</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;p&quot;&gt;<br>        &lt;el-input placeholder=&quot;请修改用户姓名&quot; <br>            size=&quot;mini&quot; v-model=&quot;name&quot;&gt;&lt;/el-input&gt;<br>            &lt;el-input placeholder=&quot;请修改用户年龄&quot; <br>            size=&quot;mini&quot; v-model=&quot;age&quot;&gt;&lt;/el-input&gt;<br>        &lt;el-button type=&quot;primary&quot; size=&quot;mini&quot; @click=&quot;updateName(name);updateAge(age)&quot;&gt;修改&lt;/el-button&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br>&lt;script&gt;<br>import &#123;mapMutations&#125; from &#x27;vuex&#x27;<br><br>const options = &#123;<br>    data() &#123;<br>        return &#123;<br>            name: &#x27;&#x27;,<br>            age: &#x27;&#x27;<br>        &#125;<br>    &#125;,<br><br>    methods: &#123;<br>        // 通过mapMutations方法，获取修改方法<br>        ...mapMutations([&#x27;updateName&#x27;, &#x27;updateAge&#x27;])<br>    &#125;<br>&#125;<br>export default options;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="使调试工具不延迟展示"><a href="#使调试工具不延迟展示" class="headerlink" title="使调试工具不延迟展示"></a>使调试工具不延迟展示</h3><blockquote><p>如果在mutations中包含异步操作，可能会导致开发工具显示不准确</p><p>将异步操作放到actions中</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-attr">mutations</span>: &#123;<br><br>   <span class="hljs-comment">// 修改数据</span><br>   <span class="hljs-title function_">updateName</span>(<span class="hljs-params">state, newName</span>) &#123;<br>     state.<span class="hljs-property">name</span> = newName<br>   &#125;,<br><br>   <span class="hljs-title function_">updateAge</span>(<span class="hljs-params">state, newAge</span>) &#123;<br>     state.<span class="hljs-property">age</span> = newAge<br>   &#125;,<br><br>   <span class="hljs-comment">// 从服务器获取用户名年龄</span><br>   <span class="hljs-comment">// 如果在mutations中包含异步操作，可能会导致开发工具显示不准确</span><br>   <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateServerName</span>(<span class="hljs-params">state, user</span>) &#123;<br>     <span class="hljs-keyword">const</span> &#123;name, age&#125; = user<br>     state.<span class="hljs-property">name</span> = name<br>     state.<span class="hljs-property">age</span> = age<br>   &#125;<br><br> &#125;,<br> <span class="hljs-attr">actions</span>: &#123;<br>   <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateServerName</span>(<span class="hljs-params">context</span>) &#123;<br>     <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/user&#x27;</span>)<br>     <span class="hljs-comment">// 通过context调用mutations中的方法</span><br>     context.<span class="hljs-title function_">commit</span>(<span class="hljs-string">&#x27;updateServerName&#x27;</span>, resp.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>)<br>   &#125;<br> &#125;,<br></code></pre></td></tr></table></figure><p>在调用时通过调用actions中的方法间接调用mutations中的方法</p><blockquote><p>通过mapActions调用actions中的方法</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>import &#123;mapActions&#125; from &#x27;vuex&#x27;<br>const options = &#123;<br>    methods: &#123;<br>        ...mapActions([&#x27;updateServerName&#x27;])<br>    &#125;<br>&#125;<br>export default options;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>7.导航菜单</title>
    <link href="/2022/10/08/%E5%89%8D%E7%AB%AF/elementUI/7.%E5%AF%BC%E8%88%AA%E8%8F%9C%E5%8D%95/"/>
    <url>/2022/10/08/%E5%89%8D%E7%AB%AF/elementUI/7.%E5%AF%BC%E8%88%AA%E8%8F%9C%E5%8D%95/</url>
    
    <content type="html"><![CDATA[<h2 id="7-导航菜单"><a href="#7-导航菜单" class="headerlink" title="7.导航菜单"></a>7.导航菜单</h2><p><strong>案例</strong></p><blockquote><p>el-menu 里的router属性：是否使用 vue-router 的模式，启用该模式会在激活导航时以 index 作为 path 进行路由跳转</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;container&quot;&gt;<br>        &lt;el-container&gt;<br><br>        &lt;!-- 顶部 --&gt;<br>        &lt;el-header&gt;<br>            <br>            &lt;el-button icon=&quot;el-icon-search&quot; circle size=&quot;mini&quot; @click=&quot;jump(&#x27;/c/p1&#x27;)&quot;&gt;&lt;/el-button&gt;<br>            &lt;el-button type=&quot;primary&quot; icon=&quot;el-icon-edit&quot; circle size=&quot;mini&quot; @click=&quot;jump(&#x27;/c/p2&#x27;)&quot;&gt;&lt;/el-button&gt;<br>            &lt;el-button type=&quot;success&quot; icon=&quot;el-icon-check&quot; circle size=&quot;mini&quot; @click=&quot;jump(&#x27;/c/p3&#x27;)&quot;&gt;&lt;/el-button&gt;<br><br>        &lt;/el-header&gt;<br><br>        &lt;el-container&gt;<br><br>            &lt;!-- 侧边栏 --&gt;<br>            &lt;el-aside width=&quot;200px&quot;&gt;<br><br>                &lt;!-- 导航栏 --&gt;<br>                &lt;el-menu<br>                    router<br>                    background-color=&quot;#545c64&quot;<br>                    text-color=&quot;#fff&quot;<br>                    active-text-color=&quot;#ffd04b&quot;&gt;<br>                    <br>                    &lt;!-- 选项 --&gt;<br>                    &lt;el-menu-item index=&quot;/c/p1&quot;&gt;<br>                        &lt;!-- 用span将元素组合在一起，不然可能会错位 --&gt;<br>                        &lt;span slot=&quot;title&quot;&gt;<br>                            &lt;i class=&quot;el-icon-setting&quot;&gt;&lt;/i&gt;<br>                            菜单1<br>                        &lt;/span&gt;<br>                    &lt;/el-menu-item&gt;<br>                        &lt;el-submenu&gt;<br>                            <br>                            &lt;span slot=&quot;title&quot;&gt;<br>                                &lt;i class=&quot;el-icon-star-off&quot;&gt;&lt;/i&gt;<br>                                菜单2<br>                            &lt;/span&gt;<br>                        &lt;el-menu-item&gt;子项1&lt;/el-menu-item&gt;<br>                        &lt;el-menu-item&gt;子项2&lt;/el-menu-item&gt;<br>                        &lt;el-menu-item&gt;子项3&lt;/el-menu-item&gt;<br>                    &lt;/el-submenu&gt;<br>                    <br>                    &lt;el-menu-item index=&quot;/c/p3&quot;&gt;<br>                        &lt;span slot=&quot;title&quot;&gt;<br>                            &lt;i class=&quot;el-icon-phone&quot;&gt;&lt;/i&gt;<br>                            菜单3<br>                        &lt;/span&gt;<br>                    &lt;/el-menu-item&gt;<br><br>                &lt;/el-menu&gt;<br><br>            &lt;/el-aside&gt;<br><br>            &lt;!-- 主分区 --&gt;<br>            &lt;el-main&gt;<br>                &lt;router-view&gt;&lt;/router-view&gt;<br>            &lt;/el-main&gt;<br><br>        &lt;/el-container&gt;<br>        &lt;/el-container&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E5%AF%BC%E8%88%AA%E8%8F%9C%E5%8D%95.png"></p><p><strong>案例</strong></p><blockquote><p>动态添加菜单</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;container&quot;&gt;<br>        &lt;el-container&gt;<br>            &lt;el-header&gt;&lt;/el-header&gt;<br>            &lt;el-container&gt;<br>                &lt;el-aside width=&quot;200px&quot;&gt;<br>                    &lt;!-- 动态菜单 --&gt;<br>                    &lt;el-menu router<br>                        default-active=&quot;2&quot;<br>                        class=&quot;el-menu-vertical-demo&quot;<br>                        @open=&quot;handleOpen&quot;<br>                        @close=&quot;handleClose&quot;<br>                        background-color=&quot;#545c64&quot;<br>                        text-color=&quot;#fff&quot;<br>                        active-text-color=&quot;#ffd04b&quot;<br>                        unique-opened&gt;<br>                        &lt;template v-for=&quot;m1 of top&quot;&gt;<br>                            &lt;el-submenu v-if=&quot;m1.children&quot; :key=&quot;m1.id&quot; :index=&quot;m1.path&quot;&gt;<br>                                &lt;span slot=&quot;title&quot;&gt;<br>                                    &lt;i :class=&quot;m1.icon&quot;&gt;&lt;/i&gt;<br>                                    &#123;&#123;m1.name&#125;&#125;<br>                                &lt;/span&gt;<br>                                &lt;el-menu-item v-for=&quot;m2 of m1.children&quot; :key=&quot;m2.id&quot; :index=&quot;m2.path&quot;&gt;<br>                                    &lt;span slot=&quot;title&quot;&gt;<br>                                        &lt;i :class=&quot;m2.icon&quot;&gt;&lt;/i&gt;<br>                                        &#123;&#123;m2.name&#125;&#125;<br>                                    &lt;/span&gt;<br>                                &lt;/el-menu-item&gt;<br>                            &lt;/el-submenu&gt;<br>                            &lt;el-menu-item v-else :key=&quot;m1.id&quot; :index=&quot;m1.path&quot;&gt;<br>                                &lt;span slot=&quot;title&quot;&gt;<br>                                    &lt;i :class=&quot;m1.icon&quot;&gt;&lt;/i&gt;<br>                                    &#123;&#123;m1.name&#125;&#125;<br>                                &lt;/span&gt;<br>                            &lt;/el-menu-item&gt;<br>                        &lt;/template&gt;<br>                    &lt;/el-menu&gt;<br><br>                &lt;/el-aside&gt;<br>                &lt;el-main&gt;&lt;/el-main&gt;<br>            &lt;/el-container&gt;<br>            &lt;/el-container&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br><br><br><br><br><br>&lt;script&gt;<br>const options = &#123;<br>    data() &#123;<br>        return &#123;    <br>            top: []<br>        &#125;<br>    &#125;, <br><br>    mounted() &#123;<br>        // 页面加载时，获取sessionStorage中的信息<br>        const serverRouters = sessionStorage.getItem(&#x27;serverRoutes&#x27;);<br>        const array = JSON.parse(serverRouters)<br><br>        // 解析数据<br>        const map = new Map()<br>        for (const obj of array) &#123;<br>            map.set(obj.id, obj)<br>        &#125;<br>        // 将子菜单放到父菜单下<br>        const top = []; // 根菜单<br>        for (const obj of array) &#123;<br>            const parent = map.get(obj.pid)<br>            if (parent) &#123;<br>                parent.children ??= []<br>                parent.children.push(obj)<br>            &#125; else &#123;<br>                top.push(obj);<br>            &#125;<br>        &#125;<br>        this.top = top<br>    &#125;<br><br><br>&#125;<br>export default options;<br>&lt;/script&gt;<br><br><br><br><br><br><br>&lt;style scoped&gt;<br>.container &#123;<br>    height: 500px;<br>    background-color: cornsilk;<br>    background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%3E%3Ctext x=&#x27;15&#x27; y=&#x27;10&#x27; font-size=&#x27;14&#x27; font-family=&#x27;system-ui, sans-serif&#x27; text-anchor=&#x27;middle&#x27; dominant-baseline=&#x27;middle&#x27;%3E主页%3C/text%3E%3C/svg%3E&quot;);<br>    padding: 20px;<br>    box-sizing: border-box;<br>&#125;<br><br>.el-container &#123;<br>    height: 100%;<br>&#125;<br><br>.el-header &#123;<br>    background-color: aquamarine;<br>&#125;<br><br>.el-aside &#123;<br>    background-color: gold;<br>&#125;<br><br>.el-main &#123;<br>    background-color: dodgerblue;<br>&#125;<br><br>a &#123;<br>    text-decoration: none;<br>    display: block;<br>    margin: 10px 10px 0 10px;<br>    padding: 3px;<br>    font-size: 13px;<br>&#125;<br><br>.router-link-active &#123;<br>    color: #fff;<br>    background-color: darkslateblue;<br>&#125;<br><br>.el-button &#123;<br>    margin-top: 15px;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E5%8A%A8%E6%80%81%E8%8F%9C%E5%8D%95.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.布局容器</title>
    <link href="/2022/10/08/%E5%89%8D%E7%AB%AF/elementUI/6.%E5%B8%83%E5%B1%80%E5%AE%B9%E5%99%A8/"/>
    <url>/2022/10/08/%E5%89%8D%E7%AB%AF/elementUI/6.%E5%B8%83%E5%B1%80%E5%AE%B9%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="6-布局容器"><a href="#6-布局容器" class="headerlink" title="6.布局容器"></a>6.布局容器</h2><p><a href="https://element.eleme.cn/#/zh-CN/component/container#container-bu-ju-rong-qi">布局容器</a></p><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;el-container&gt;<br>  &lt;el-header&gt;Header&lt;/el-header&gt;<br>  &lt;el-container&gt;<br>    &lt;el-aside width=&quot;200px&quot;&gt;Aside&lt;/el-aside&gt;<br>    &lt;el-main&gt;Main&lt;/el-main&gt;<br>  &lt;/el-container&gt;<br>&lt;/el-container&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>9.路由</title>
    <link href="/2022/10/07/%E5%89%8D%E7%AB%AF/vue/9.%E8%B7%AF%E7%94%B1/"/>
    <url>/2022/10/07/%E5%89%8D%E7%AB%AF/vue/9.%E8%B7%AF%E7%94%B1/</url>
    
    <content type="html"><![CDATA[<h2 id="9-路由"><a href="#9-路由" class="headerlink" title="9.路由"></a>9.路由</h2><blockquote><p>vue 属于<strong>单页面应用</strong>，所谓的路由，就是根据浏览器路径不同，用不同的<strong>视图组件</strong>替换这个页面内容展示</p></blockquote><p>默认路由的配置是router目录下的index.js文件</p><p>可以根据这个文件来写路由</p><h3 id="静态导入"><a href="#静态导入" class="headerlink" title="静态导入"></a>静态导入</h3><ul><li>自定义路由文件</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-comment">// 绝对路径导入，@表示src</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">ContainerView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/example13/ContainerView.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">LoginView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/example13/LoginView.vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">NotFoundView</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/views/example13/NotFoundView.vue&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)<br><br><span class="hljs-keyword">const</span> routes = [<br>  <span class="hljs-comment">// 建立路径和组件之间的对应关系</span><br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">ContainerView</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/login&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">LoginView</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/404&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">NotFoundView</span><br>  &#125;<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>(&#123;<br>  routes<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router<br></code></pre></td></tr></table></figure><ul><li>在入口main.js中导入编写的路由文件</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./router/example13&#x27;</span> <span class="hljs-comment">// 导入自定义的路由</span><br></code></pre></td></tr></table></figure><ul><li><p>修改主视图</p><blockquote><p> <code>&lt;router-view&gt;</code> 起到占位作用，改变路径后，这个路径对应的视图组件就会占据 <code>&lt;router-view&gt;</code> 的位置，替换掉它之前的内容</p></blockquote></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;router-view&gt;&lt;/router-view&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br><br>&lt;/script&gt;<br><br></code></pre></td></tr></table></figure><h3 id="动态导入"><a href="#动态导入" class="headerlink" title="动态导入"></a>动态导入</h3><blockquote><ul><li>静态导入是将所有组件的 js 代码打包到一起，如果组件非常多，打包后的 js 文件会很大，影响页面加载速度</li><li>动态导入是将组件的 js 代码放入独立的文件，用到时才加载</li></ul></blockquote><p><strong>案例</strong></p><p>将上面的静态导入改为动态导入</p><p>通过lambda表达式<code>() =&gt; import(&#39;文件路径&#39;)</code>来动态导入</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-comment">// 绝对路径导入，@表示src</span><br><span class="hljs-comment">// import ContainerView from &#x27;@/views/example13/ContainerView.vue&#x27;</span><br><span class="hljs-comment">// import LoginView from &#x27;@/views/example13/LoginView.vue&#x27;</span><br><span class="hljs-comment">// import NotFoundView from &#x27;@/views/example13/NotFoundView.vue&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)<br><br><span class="hljs-keyword">const</span> routes = [<br>  <span class="hljs-comment">// 建立路径和组件之间的对应关系</span><br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/ContainerView.vue&#x27;</span>)<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/login&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/LoginView.vue&#x27;</span>)<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/404&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/NotFoundView.vue&#x27;</span>)<br>  &#125;<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>(&#123;<br>  routes<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router<br><br></code></pre></td></tr></table></figure><h3 id="嵌套导入"><a href="#嵌套导入" class="headerlink" title="嵌套导入"></a>嵌套导入</h3><blockquote><p>也叫子路由，组件内再要切换内容，就需要用到嵌套路由</p><p>通过children属性来定义嵌套路由</p></blockquote><p><strong>案例</strong></p><blockquote><p>定义嵌套路由和重定向</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue-router&#x27;</span><br><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)<br><br><span class="hljs-keyword">const</span> routes = [<br>  <span class="hljs-comment">// 建立路径和组件之间的对应关系</span><br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/ContainerView.vue&#x27;</span>),<br>    <span class="hljs-comment">// 重定向，相当于选择了默认的嵌套路由</span><br>    <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/c/p1&#x27;</span>,<br><span class="hljs-comment">// 嵌套路由</span><br>    <span class="hljs-attr">children</span>: [<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;c/p1&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/container/P1View.vue&#x27;</span>)<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;c/p2&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/container/P2View.vue&#x27;</span>)<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;c/p3&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/container/P3View.vue&#x27;</span>)<br>      &#125;,<br>      <br>    ]<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/login&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/LoginView.vue&#x27;</span>)<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;/404&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">&#x27;@/views/example13/NotFoundView.vue&#x27;</span>)<br>  &#125;,<br>  &#123;<br><span class="hljs-comment">// 从定向用法，访问不存在的路径跳转到指定的组件上去</span><br>    <span class="hljs-attr">path</span>:<span class="hljs-string">&#x27;*&#x27;</span>,<br>    <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;/404&#x27;</span><br>  &#125;<br>]<br><br><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>(&#123;<br>  routes<br>&#125;)<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router<br></code></pre></td></tr></table></figure><h3 id="路由跳转"><a href="#路由跳转" class="headerlink" title="路由跳转"></a>路由跳转</h3><p>跳转方式：</p><ul><li>标签式：通过to属性实现跳转</li><li>编程式：自定义方法，通过this.$router.push(url)方式实现跳转</li></ul><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;container&quot;&gt;<br>        &lt;el-container&gt;<br>        &lt;el-header&gt;<br>            &lt;!-- 编程式 --&gt;<br>            &lt;el-button icon=&quot;el-icon-search&quot; circle size=&quot;mini&quot; @click=&quot;jump(&#x27;/c/p1&#x27;)&quot;&gt;&lt;/el-button&gt;<br>            &lt;el-button type=&quot;primary&quot; icon=&quot;el-icon-edit&quot; circle size=&quot;mini&quot; @click=&quot;jump(&#x27;/c/p2&#x27;)&quot;&gt;&lt;/el-button&gt;<br>            &lt;el-button type=&quot;success&quot; icon=&quot;el-icon-check&quot; circle size=&quot;mini&quot; @click=&quot;jump(&#x27;/c/p3&#x27;)&quot;&gt;&lt;/el-button&gt;<br>        &lt;/el-header&gt;<br>        &lt;el-container&gt;<br>            &lt;el-aside width=&quot;200px&quot;&gt;<br>                &lt;!-- 标签式 --&gt;<br>                &lt;router-link to=&quot;/c/p1&quot;&gt;p1&lt;/router-link&gt;<br>                &lt;router-link to=&quot;/c/p2&quot;&gt;p2&lt;/router-link&gt;<br>                &lt;router-link to=&quot;/c/p3&quot;&gt;p3&lt;/router-link&gt;<br>            &lt;/el-aside&gt;<br>            &lt;el-main&gt;<br>                &lt;router-view&gt;&lt;/router-view&gt;<br>            &lt;/el-main&gt;<br>        &lt;/el-container&gt;<br>        &lt;/el-container&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br>&lt;script&gt;<br>    const options = &#123;<br>        methods: &#123;<br>            jump(url) &#123;<br>                // 根据路径进行跳转<br>                this.$router.push(url);<br>            &#125;<br>        &#125;<br>    &#125;<br>    export default options;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h3><blockquote><p>从后端动态的获取路由信息添加到路由中</p></blockquote><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div class=&quot;login&quot;&gt;<br>        &lt;el-input v-model=&quot;username&quot; placeholder=&quot;请输入用户名&quot; size=&quot;mini&quot;&gt;&lt;/el-input&gt;<br>        &lt;el-button type=&quot;primary&quot; size=&quot;mini&quot; @click=&quot;login()&quot;&gt;登录&lt;/el-button&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br>&lt;script&gt;<br>    import axios from &#x27;../../utils/myaxios.js&#x27;<br>    import &#123;resetRouter&#125; from &#x27;@/router/example14&#x27;<br><br>    const options = &#123;<br>        data() &#123;<br>            return &#123;<br>                username: &#x27;admin&#x27;<br>            &#125;<br>        &#125;,<br>        methods: &#123;<br>            // 将登录用户可以访问的路径添加到路由中<br>            async login() &#123;<br>                resetRouter();<br>                const resp = await axios.get(`/api/menu/$&#123;this.username&#125;`)<br>                for (const &#123;id, path, component&#125; of resp.data.data) &#123;<br>                    if (component !== null) &#123;<br>                        // 在父路由中添加路由<br>                        this.$router.addRoute(&#x27;c&#x27;, &#123;<br>                            path: path,<br>                            name: id,<br>                            component: () =&gt; import(`@/views/example14/container/$&#123;component&#125;`)<br>                        &#125;)<br>                    &#125;<br>                &#125;<br>                <br>                // 打印路由<br>                console.log(this.$router.getRoutes())<br>            &#125;<br>        &#125;<br><br>    &#125;<br><br>    export default options;<br>&lt;/script&gt;<br><br><br><br><br><br>&lt;style scoped&gt;<br>.login &#123;<br>    height: 100%;<br>    background-color: darkseagreen;<br>    /* background-image: url(&quot;data:image/svg+xml,%3Csvg xmlns=&#x27;http://www.w3.org/2000/svg&#x27;%3E%3Ctext x=&#x27;15&#x27; y=&#x27;10&#x27; font-size=&#x27;14&#x27; font-family=&#x27;system-ui, sans-serif&#x27; text-anchor=&#x27;middle&#x27; dominant-baseline=&#x27;middle&#x27;%3E登录%3C/text%3E%3C/svg%3E&quot;); */<br>&#125;<br><br>.el-input--mini &#123;<br>    width: 193px;<br>    margin: 10px 10px 0 10px;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure><p><strong>保存路由信息</strong></p><p>每次刷新页面，路由信息都会丢失</p><p>将路由数据存到localStorage或sessionStorage可以在每次刷新时来恢复路由</p><p>router文件中</p><blockquote><p>抽出两个方法：重置路由和添加路由</p><p>还有每次运行时查询缓存</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 查询sessionStorage中是否有缓存的路由信息</span><br><span class="hljs-keyword">const</span> serverRoutes = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;serverRoutes&#x27;</span>)<br><span class="hljs-keyword">if</span> (serverRoutes) &#123;<br>  <span class="hljs-keyword">const</span> array = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(serverRoutes)<br>  <span class="hljs-title function_">addServerRoutes</span>(array)<br>&#125;<br><br><br><span class="hljs-comment">// 重置路由，新建一个路由，把空的matcher赋值给现在的路由</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">resetRouter</span>(<span class="hljs-params"></span>) &#123; <br>  router.<span class="hljs-property">matcher</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>(&#123;routes&#125;).<span class="hljs-property">matcher</span><br>&#125;<br><br><span class="hljs-comment">// 添加路由信息</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addServerRoutes</span>(<span class="hljs-params">array</span>) &#123;<br>  <span class="hljs-title function_">resetRouter</span>();<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> &#123;id, path, component&#125; <span class="hljs-keyword">of</span> array) &#123;<br>      <span class="hljs-keyword">if</span> (component !== <span class="hljs-literal">null</span>) &#123;<br>          <span class="hljs-comment">// 在父路由中添加路由</span><br>          router.<span class="hljs-title function_">addRoute</span>(<span class="hljs-string">&#x27;c&#x27;</span>, &#123;<br>              <span class="hljs-attr">path</span>: path,<br>              <span class="hljs-attr">name</span>: id,<br>              <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">import</span>(<span class="hljs-string">`@/views/example14/container/<span class="hljs-subst">$&#123;component&#125;</span>`</span>)<br>          &#125;)<br>      &#125;<br>  &#125;<br>                <br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>5.级联选择器</title>
    <link href="/2022/10/07/%E5%89%8D%E7%AB%AF/elementUI/5.%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8/"/>
    <url>/2022/10/07/%E5%89%8D%E7%AB%AF/elementUI/5.%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="5-级联选择器"><a href="#5-级联选择器" class="headerlink" title="5.级联选择器"></a>5.级联选择器</h2><p><a href="https://element.eleme.cn/#/zh-CN/component/cascader#cascader-ji-lian-xuan-ze-qi">级联选择器</a></p><p><strong>案例1</strong></p><ul><li>将静态数据写到级联选择器</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;el-cascader :options=&quot;ops&quot;&gt;&lt;/el-cascader&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>  // import axios from &#x27;../utils/myaxios&#x27;<br>  const options = &#123;<br>    data() &#123;<br>      return &#123;<br>        // 通过children来添加子选项,可嵌套多层<br>        ops: [<br>          &#123;value: 100, label: &#x27;主页&#x27;, children: [<br>            &#123;value: 101, label: &#x27;菜单1&#x27;, children:[<br>              &#123;value: 102, label: &#x27;菜单11&#x27;&#125;,<br>              &#123;value: 102, label: &#x27;菜单12&#x27;&#125;,<br>            ]&#125;,<br>            &#123;value: 102, label: &#x27;菜单2&#x27;&#125;,<br>            &#123;value: 103, label: &#x27;菜单3&#x27;&#125;,<br>          ]&#125;<br>        ]<br>      &#125;<br>    &#125;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br><br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A8.png"></p><p><strong>案例2</strong></p><ul><li>将后端数据写到级联选择器</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;el-cascader :options=&quot;ops&quot; clearable&gt;&lt;/el-cascader&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>import axios from &#x27;../utils/myaxios&#x27;<br>  const options = &#123;<br>    data() &#123;<br>      return &#123;<br>        ops: []<br>      &#125;<br>    &#125;,<br><br>    // 组件加载完后将数据填入<br>    async mounted() &#123;<br>      const resp = await axios.get(&#x27;/api/menu&#x27;)<br><br>      // 前端处理发来的数据<br>      const map = new Map()<br>      for (const &#123;id, name, pid&#125; of resp.data.data) &#123;<br>        // 将数据存到map中<br>        map.set(id, &#123;value: id, label: name, pid: pid&#125;)<br>      &#125;<br>      const root = []<br>      for (const obj of map.values()) &#123;<br>        const parent = map.get(obj.pid) // 获取父标签<br>        if (parent !== undefined) &#123;<br>          parent.children ??= []<br>          parent.children.push(obj) // 添加到父标签里<br>        &#125; else &#123;<br>          root.push(obj)  //没有父标签，该标签为根标签<br>        &#125;<br>      &#125;<br>      this.ops = root<br>    &#125;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br><br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E7%BA%A7%E8%81%94%E9%80%89%E6%8B%A9%E5%99%A82.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>4.搜索</title>
    <link href="/2022/10/07/%E5%89%8D%E7%AB%AF/elementUI/4.%E6%90%9C%E7%B4%A2/"/>
    <url>/2022/10/07/%E5%89%8D%E7%AB%AF/elementUI/4.%E6%90%9C%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="4-搜索"><a href="#4-搜索" class="headerlink" title="4.搜索"></a>4.搜索</h2><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;!-- 搜索框 --&gt;<br>    &lt;el-input placeholder=&quot;请输入姓名&quot; size=&quot;mini&quot; v-model=&quot;queryDto.name&quot;&gt;&lt;/el-input&gt;<br>    &lt;!-- 下拉框 --&gt;<br>    &lt;el-select placeholder=&quot;请选择性别&quot; size=&quot;mini&quot; v-model=&quot;queryDto.sex&quot; clearable&gt;<br>      &lt;el-option value=&quot;男&quot;&gt;&lt;/el-option&gt;<br>      &lt;el-option value=&quot;女&quot;&gt;&lt;/el-option&gt;<br>    &lt;/el-select&gt;<br>    &lt;el-select placeholder=&quot;请选择年龄&quot; size=&quot;mini&quot; v-model=&quot;queryDto.age&quot; clearable&gt;<br>      &lt;el-option value=&quot;0,20&quot; label=&quot;0-20&quot;&gt;&lt;/el-option&gt;<br>      &lt;el-option value=&quot;21,30&quot; label=&quot;21-30&quot;&gt;&lt;/el-option&gt;<br>      &lt;el-option value=&quot;31,40&quot; label=&quot;31-40&quot;&gt;&lt;/el-option&gt;<br>      &lt;el-option value=&quot;41,120&quot; label=&quot;41-120&quot;&gt;&lt;/el-option&gt;<br>    &lt;/el-select&gt;<br><br>    &lt;el-button type=&quot;primary&quot; size=&quot;mini&quot; @click=&quot;search&quot;&gt;搜索&lt;/el-button&gt;<br><br>    &lt;el-table :data=&quot;students&quot;&gt;<br>      &lt;!-- id是students的属性 --&gt;<br>      &lt;el-table-column lable=&quot;编号&quot; prop=&quot;id&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;姓名&quot; prop=&quot;name&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;性别&quot; prop=&quot;sex&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;年龄&quot; prop=&quot;age&quot;&gt;&lt;/el-table-column&gt;<br>    &lt;/el-table&gt;<br><br>    &lt;!-- 总记录数，每页大小，当前页, 组件布局 --&gt;<br>    &lt;!-- 改变当前页时触发，改变页大小时触发 --&gt;<br>    &lt;el-pagination <br>        :total=&quot;total&quot;     <br>        :page-size=&quot;queryDto.size&quot;<br>        :page-sizes=&quot;[5, 10]&quot;<br>        :current-page=&quot;queryDto.page&quot;<br>        layout=&quot;prev, pager, next, jumper, sizes, -&gt;, total&quot;<br>        @current-change=&quot;currentChange&quot;<br>        @size-change=&quot;sizeChange&quot;<br>    &gt;&lt;/el-pagination&gt;<br><br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>  import axios from &#x27;../utils/myaxios&#x27;<br>  const options = &#123;<br>    data() &#123;<br>      return &#123;<br>        students: [],<br>        total: 0,<br>        // 查询条件<br>        queryDto: &#123;<br>          page: 1,<br>          size: 5,<br>          name: &#x27;&#x27;,<br>          sex: &#x27;&#x27;,<br>          age: &#x27;&#x27;<br>        &#125;<br>      &#125;<br>    &#125;,<br><br>    // 钩子函数, 数据挂载后, 视图的数据被Vue的替换<br>    mounted() &#123;<br>      // 发送请求，返回学生数据<br>      this.query();<br>    &#125;,<br><br>    methods: &#123;<br>      // 会返回页号<br>      currentChange(page) &#123;<br>        this.queryDto.page = page<br>        this.query();<br>      &#125;,<br><br>      // 返回页面大小<br>      sizeChange(size) &#123;<br>        this.queryDto.size = size<br>        this.query();<br>      &#125;,<br><br>      search() &#123;<br>        this.query()<br>      &#125;,<br><br>      // 通过此方法发送请求<br>      async query() &#123;<br>        const resp = await axios.get(&#x27;/api/students/q&#x27;, &#123;<br>          params: this.queryDto<br>        &#125;)<br>        //console.log(resp)<br>        this.students = resp.data.data.list<br>        this.total = resp.data.data.total<br>      &#125;<br>    &#125;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br><br>&lt;style scoped&gt;<br>  .el-input--mini,<br>  .el-search--mini &#123;<br>    width: 193px;<br>    margin: 10px 10px 0 0;<br>  &#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E6%90%9C%E7%B4%A2.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3.分页组件</title>
    <link href="/2022/10/06/%E5%89%8D%E7%AB%AF/elementUI/3.%E5%88%86%E9%A1%B5%E7%BB%84%E4%BB%B6/"/>
    <url>/2022/10/06/%E5%89%8D%E7%AB%AF/elementUI/3.%E5%88%86%E9%A1%B5%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="3-分页条组件"><a href="#3-分页条组件" class="headerlink" title="3.分页条组件"></a>3.分页条组件</h2><p><a href="https://element.eleme.cn/#/zh-CN/component/pagination#pagination-fen-ye">分页条组件</a></p><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;el-table :data=&quot;students&quot;&gt;<br>      &lt;!-- id是students的属性 --&gt;<br>      &lt;el-table-column lable=&quot;编号&quot; prop=&quot;id&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;姓名&quot; prop=&quot;name&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;性别&quot; prop=&quot;sex&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;年龄&quot; prop=&quot;age&quot;&gt;&lt;/el-table-column&gt;<br>    &lt;/el-table&gt;<br><br>    &lt;!-- 总记录数，每页大小，当前页, 组件布局 --&gt;<br>    &lt;!-- 改变当前页时触发，改变页大小时触发 --&gt;<br>    &lt;el-pagination <br>        :total=&quot;total&quot;     <br>        :page-size=&quot;queryDto.size&quot;<br>        :page-sizes=&quot;[5, 10]&quot;<br>        :current-page=&quot;queryDto.page&quot;<br>        layout=&quot;prev, pager, next, jumper, sizes, -&gt;, total&quot;<br>        @current-change=&quot;currentChange&quot;<br>        @size-change=&quot;sizeChange&quot;<br>    &gt;&lt;/el-pagination&gt;<br><br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>  import axios from &#x27;../utils/myaxios&#x27;<br>  const options = &#123;<br>    data() &#123;<br>      return &#123;<br>        students: [],<br>        total: 0,<br>        // 查询条件<br>        queryDto: &#123;<br>          page: 1,<br>          size: 10,<br>        &#125;<br>      &#125;<br>    &#125;,<br><br>    // 钩子函数, 数据挂载后, 视图的数据被Vue的替换<br>    mounted() &#123;<br>      // 发送请求，返回学生数据<br>      this.query();<br>    &#125;,<br><br>    methods: &#123;<br>      // 会返回页号<br>      currentChange(page) &#123;<br>        this.queryDto.page = page<br>        this.query();<br>      &#125;,<br><br>      // 返回页面大小<br>      sizeChange(size) &#123;<br>        this.queryDto.size = size<br>        this.query();<br>      &#125;,<br><br>      // 通过此方法发送请求<br>      async query() &#123;<br>        const resp = await axios.get(&#x27;/api/students/q&#x27;, &#123;<br>          params: this.queryDto<br>        &#125;)<br>        //console.log(resp)<br>        this.students = resp.data.data.list<br>        this.total = resp.data.data.total<br>      &#125;<br>    &#125;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E5%88%86%E9%A1%B5%E6%9D%A1%E7%BB%84%E4%BB%B6.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2.表格组件</title>
    <link href="/2022/10/06/%E5%89%8D%E7%AB%AF/elementUI/2.%E8%A1%A8%E6%A0%BC%E7%BB%84%E4%BB%B6/"/>
    <url>/2022/10/06/%E5%89%8D%E7%AB%AF/elementUI/2.%E8%A1%A8%E6%A0%BC%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="2-表格组件"><a href="#2-表格组件" class="headerlink" title="2.表格组件"></a>2.表格组件</h2><p><a href="https://element.eleme.cn/#/zh-CN/component/table#table-biao-ge">表格组件</a></p><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;el-table :data=&quot;students&quot;&gt;<br>      &lt;!-- id、name等是students的属性 --&gt;<br>      &lt;el-table-column lable=&quot;编号&quot; prop=&quot;id&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;姓名&quot; prop=&quot;name&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;性别&quot; prop=&quot;sex&quot;&gt;&lt;/el-table-column&gt;<br>      &lt;el-table-column lable=&quot;年龄&quot; prop=&quot;age&quot;&gt;&lt;/el-table-column&gt;<br>    &lt;/el-table&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>  import axios from &#x27;../utils/myaxios&#x27;<br>  const options = &#123;<br>    data() &#123;<br>      return &#123;<br>        students: []<br>      &#125;<br>    &#125;,<br>    // 钩子函数, 数据挂载后, 视图的数据被Vue的替换<br>    async mounted() &#123;<br>      // 发送请求，返回学生数据<br>      const resp = await axios.get(&#x27;/api/students&#x27;)<br>      this.students = resp.data.data<br>    &#125;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><img src="/img/qianduan_img/el%E8%A1%A8%E6%A0%BC%E7%BB%84%E4%BB%B6.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1.elementUI安装</title>
    <link href="/2022/10/06/%E5%89%8D%E7%AB%AF/elementUI/1.elementUI%E5%AE%89%E8%A3%85/"/>
    <url>/2022/10/06/%E5%89%8D%E7%AB%AF/elementUI/1.elementUI%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="1-elementUI安装"><a href="#1-elementUI安装" class="headerlink" title="1.elementUI安装"></a>1.elementUI安装</h2><blockquote><p>Element，一套为开发者、设计师和产品经理准备的基于 Vue 2.0 的桌面端组件库</p></blockquote><p><strong>安装</strong></p><blockquote><p>在项目文件夹下</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">npm install element-ui -S<br></code></pre></td></tr></table></figure><p><strong>引入组件</strong></p><blockquote><p>在main.js文件下</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 导入elementui组件</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Element</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;element-ui&#x27;</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;element-ui/lib/theme-chalk/index.css&#x27;</span><br><br><span class="hljs-comment">// 全局导入</span><br><span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Element</span>)<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;el-button&gt;按钮&lt;/el-button&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>  const options = &#123;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>ElementUI</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>8.重用组件</title>
    <link href="/2022/10/06/%E5%89%8D%E7%AB%AF/vue/8.%E9%87%8D%E7%94%A8%E7%BB%84%E4%BB%B6/"/>
    <url>/2022/10/06/%E5%89%8D%E7%AB%AF/vue/8.%E9%87%8D%E7%94%A8%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="8-重用组件"><a href="#8-重用组件" class="headerlink" title="8.重用组件"></a>8.重用组件</h2><p><strong>案例</strong></p><p>子组件</p><blockquote><p>编写了一些css样式</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br><br>    &lt;div class=&quot;button&quot; :class=&quot;[type, size]&quot;&gt;<br>        &lt;!-- 插槽，会将父标签的本文填充到里面 --&gt;<br>        &lt;slot&gt;&lt;/slot&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>    const options = &#123;<br>        // 父组件使用时可以添加的属性<br>        props: [&quot;type&quot;, &quot;size&quot;]<br>    &#125;<br>    export default options;<br>&lt;/script&gt;<br><br>&lt;!-- 使用scoped可以让CSS样式只对局部元素生效 --&gt;<br>&lt;style scoped&gt;<br>.button &#123;<br>    display: inline-block;<br>    text-align: center;<br>    border-radius: 30px;<br>    margin: 5px;<br>    font: bold 12px/25px Arial, sans-serif;<br>    padding: 0 2px;<br>    text-shadow: 1px 1px 1px rgba(255, 255, 255, .22);<br>    box-shadow: 1px 1px 1px rgba(0, 0, 0, .29), inset 1px 1px 1px rgba(255, 255, 255, .44);<br>    transition: all 0.15s ease;<br>&#125;<br><br>.button:hover &#123;<br>    box-shadow: 1px 1px 1px rgba(0, 0, 0, .29), inset 1px 1px 2px rgba(0, 0, 0, .5);<br>&#125;<br><br>.button:active &#123;<br>    box-shadow: inset 1px 1px 2px rgba(0, 0, 0, .8);<br>&#125;<br><br>.primary &#123;<br>    background-color: #1d6ef9;<br>    color: #b5e3f1;<br>&#125;<br><br>.danger &#123;<br>    background-color: rgb(196, 50, 50);<br>    color: white;<br>&#125;<br><br>.success &#123;<br>    background-color: #a5cd4e;<br>    ;<br>    color: #3e5706;<br>&#125;<br><br>.small &#123;<br>    width: 40px;<br>    height: 20px;<br>    font-size: 10px;<br>    line-height: 20px;<br>&#125;<br><br>.middle &#123;<br>    width: 50px;<br>    height: 25px;<br>    font-size: 14px;<br>    line-height: 25px;<br>&#125;<br><br>.large &#123;<br>    width: 60px;<br>    height: 30px;<br>    font-size: 18px;<br>    line-height: 30px;<br>&#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure><p>父组件</p><blockquote><p>调用子组件</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>  &lt;div&gt;<br>    &lt;h1&gt;父组件&lt;/h1&gt;<br>    &lt;!-- 使用子组件 --&gt;<br>    &lt;my-button type=&quot;primary&quot; size=&quot;small&quot;&gt;1&lt;/my-button&gt;<br>    &lt;my-button type=&quot;danger&quot; size=&quot;middle&quot;&gt;2&lt;/my-button&gt;<br>    &lt;my-button type=&quot;success&quot; size=&quot;large&quot;&gt;3&lt;/my-button&gt;<br>  &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>  // 导入子组件<br>  import myButton from &#x27;../components/MyButton.vue&#x27;<br>  const options = &#123;<br>    // 添加要使用的子组件<br>    components: &#123;<br>      myButton<br>    &#125;<br>  &#125;<br>  export default options<br>&lt;/script&gt;<br><br>&lt;style&gt;<br>  div &#123;<br>    background-color: gainsboro;<br>    widows: 100px;<br>    height: 400px;<br>  &#125;<br>  h1 &#123;<br>    font-family: 华文行楷;<br>  &#125;<br>&lt;/style&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>axios API</title>
    <link href="/2022/10/05/%E5%89%8D%E7%AB%AF/api/axios-API/"/>
    <url>/2022/10/05/%E5%89%8D%E7%AB%AF/api/axios-API/</url>
    
    <content type="html"><![CDATA[<h2 id="axios-API"><a href="#axios-API" class="headerlink" title="axios API"></a>axios API</h2><blockquote><p>axios 的底层是用了 XMLHttpRequest（xhr）方式发送请求和接收响应，</p><p>xhr 相对于之前讲过的 fetch api 来说，功能更强大，</p><p>但由于是比较老的 api，不支持 Promise，axios 对 xhr 进行了封装，使之支持 Promise，并提供了对请求、响应的统一拦截功能</p></blockquote><h3 id="通过npm安装"><a href="#通过npm安装" class="headerlink" title="通过npm安装"></a>通过npm安装</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>在项目的文件夹下<br>npm install axios -S<br></code></pre></td></tr></table></figure><p>安装完后会在项目的node-modules文件夹下创建axios文件夹，和在package.json文件中导入axios依赖</p><h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><p><strong>案例</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div&gt;<br>        &lt;input type=&quot;button&quot; value=&quot;获取远程数据&quot; @click=&quot;sendReq()&quot;&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>    // 使用前先导入<br>    import axios from &#x27;axios&#x27;<br>    // axios<br>    const option = &#123;<br>        methods: &#123;<br>            async sendReq() &#123;<br>                // 通过axios发送同步get请求<br>                const resp = await axios.get(&quot;/api/students&quot;)<br>                console.log(resp)<br>            &#125;<br>        &#125;<br>    &#125;<br>    export default option<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h3><table><thead><tr><th>请求</th><th>备注</th></tr></thead><tbody><tr><td><strong>axios.get(url[, config])</strong></td><td></td></tr><tr><td>axios.delete(url[, config])</td><td></td></tr><tr><td>axios.head(url[, config])</td><td></td></tr><tr><td>axios.options(url[, config])</td><td></td></tr><tr><td><strong>axios.post(url[, data[, config]])</strong></td><td></td></tr><tr><td>axios.put(url[, data[, config]])</td><td></td></tr><tr><td>axios.patch(url[, data[, config]])</td><td></td></tr></tbody></table><p><strong>案例</strong></p><p>后端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> xw.controller;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AxiosController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/api/a1&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;get request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a2&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a3&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a3</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader(&quot;Authorization&quot;)</span> String authorization)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;authorization 头 &quot;</span> + authorization);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a4&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a4</span><span class="hljs-params">(String name, Integer age)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;name: &quot;</span> + name + <span class="hljs-string">&quot; age:&quot;</span> + age);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a5&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a5</span><span class="hljs-params">(A5 a5)</span> &#123;<br>        System.out.println(a5);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a5json&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a5json</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> A5 a5)</span> &#123;<br>        System.out.println(a5);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a6set&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a6set</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;========== a6 set ==========&quot;</span>);<br>        System.out.println(session.getId());<br>        session.setAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;张三&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a6get&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a6get</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;========== a6 get ==========&quot;</span>);<br>        System.out.println(session.getId());<br>        System.out.println(<span class="hljs-string">&quot;name: &quot;</span> + session.getAttribute(<span class="hljs-string">&quot;name&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>前端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;template&gt;<br>    &lt;div&gt;<br>        &lt;input type=&quot;button&quot; value=&quot;获取远程数据&quot; @click=&quot;sendReq()&quot;&gt;<br>    &lt;/div&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>    // 使用前先导入<br>    import axios from &#x27;axios&#x27;<br>    // axios<br>    const option = &#123;<br>        methods: &#123;<br>            async sendReq() &#123;<br>                // 1.通过axios发送同步get请求<br>                // const resp = await axios.get(&quot;/api/a1&quot;)<br><br>                // 2.通过axios发送同步post请求<br>                // const resp = await axios.post(&quot;/api/a2&quot;)<br><br>                // 3.axios请求中添加请求头（url，请求体数据，选项对象）<br>                // const resp = await axios.post(&quot;/api/a3&quot;, &#123;&#125;, &#123;<br>                //     headers: &#123;<br>                //         Authorization: &#x27;abc&#x27;<br>                //     &#125;<br>                // &#125;)<br><br>                // 4.1axios请求中携带参数（字符串拼接）<br>                // const name = encodeURIComponent(&#x27;!@#%$&#x27;) //编码后发送<br>                // const age = 20<br>                // const resp = await axios.post(`/api/a4?name=$&#123;name&#125;&amp;age=$&#123;age&#125;`)<br><br>                // // 4.axios请求中携带参数（选项对象）<br>                // const resp = await axios.post(&#x27;/api/a4&#x27;, &#123;&#125;, &#123;<br>                //     params: &#123;<br>                //         name: &#x27;!@#%$&#x27;,  //会自动编码<br>                //         age: 20<br>                //     &#125;<br>                // &#125;)<br><br>                // 4.2axios请求中携带参数（请求体json）<br>                // 请求体中的是json格式，后端是通过参数名接收，故不能直接写在参数里<br>                // const params = new URLSearchParams()    // 通过URLSearchParams封装参数<br>                // params.append(&quot;name&quot;, &quot;张三&quot;)<br>                // params.append(&quot;age&quot;, 20)<br>                // const resp = await axios.post(&#x27;/api/a4&#x27;, params)<br><br>                // 4.3axios请求中携带参数（请求体multipart）<br>                // const params = new FormData()    // 通过FormData封装参数<br>                // params.append(&quot;name&quot;, &quot;张三&quot;)<br>                // params.append(&quot;age&quot;, 21)<br>                // const resp = await axios.post(&#x27;/api/a5&#x27;, params)<br><br>                // 4.4axios请求中携带参数（请求体json, 后端用对象接收）<br>                // 自动通过JSON.stringify转换为json<br>                const resp = await axios.post(&#x27;/api/a5json&#x27;, &#123;<br>                    name: &#x27;李四&#x27;,<br>                    age: 21<br>                &#125;)<br><br>                console.log(resp)<br>            &#125;<br>        &#125;<br>    &#125;<br>    export default option<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="axios配置"><a href="#axios配置" class="headerlink" title="axios配置"></a>axios配置</h3><p>常见config配置</p><table><thead><tr><th>名称</th><th>含义</th></tr></thead><tbody><tr><td>baseURL</td><td>将自动加在 url 前面</td></tr><tr><td>headers</td><td>请求头，类型为简单对象</td></tr><tr><td>params</td><td>跟在 URL 后的请求参数，类型为简单对象或 URLSearchParams</td></tr><tr><td>data</td><td>请求体，类型有简单对象、FormData、URLSearchParams、File 等</td></tr><tr><td>withCredentials</td><td>跨域时是否携带 Cookie 等凭证，默认为 false</td></tr><tr><td>responseType</td><td>响应类型，默认为 json</td></tr></tbody></table><p><strong>案例</strong></p><p>后端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-comment">//开启跨域和允许携带凭证</span><br><span class="hljs-meta">@CrossOrigin(value = &quot;http://localhost:7070&quot;, allowCredentials = &quot;true&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AxiosController</span> &#123;<br>    <span class="hljs-meta">@PostMapping(&quot;/api/a6set&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a6set</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;========== a6 set ==========&quot;</span>);<br>        System.out.println(session.getId());<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            模拟登录，将用户名存入session</span><br><span class="hljs-comment">        */</span><br>        session.setAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;张三&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/api/a6get&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">a6get</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;========== a6 get ==========&quot;</span>);<br>        System.out.println(session.getId());<br>        System.out.println(<span class="hljs-string">&quot;name: &quot;</span> + session.getAttribute(<span class="hljs-string">&quot;name&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;post request&quot;</span>;<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure><p> 前端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>    // 使用前先导入<br>    import axios from &#x27;axios&#x27;<br>    // axios<br>    const option = &#123;<br>        methods: &#123;<br>            async sendReq() &#123;                <br>                // axios配置<br>                const _axios = axios.create(&#123;<br>                    // 会被添加在每个请求url前<br>                    baseURL: &#x27;http://localhost:8080&#x27;,<br>                    // 跨域时是否携带 Cookie 等凭证，默认为 false<br>                    withCredentials: true<br>                &#125;)<br>                await _axios.post(&#x27;/api/a6set&#x27;, &#123;&#125;)<br>                await _axios.post(&#x27;/api/a6get&#x27;, &#123;&#125;)<br>            &#125;<br>        &#125;<br>    &#125;<br>    export default option<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="响应格式"><a href="#响应格式" class="headerlink" title="响应格式"></a>响应格式</h3><table><thead><tr><th>名称</th><th>含义</th></tr></thead><tbody><tr><td>data</td><td>响应体数据 :star:</td></tr><tr><td>status</td><td>状态码 :star:</td></tr><tr><td>headers</td><td>响应头</td></tr></tbody></table><ul><li>200 表示响应成功</li><li>400 请求数据不正确 age&#x3D;abc</li><li>401 身份验证没通过</li><li>403 没有权限</li><li>404 资源不存在</li><li>405 不支持请求方式 post</li><li>500 服务器内部错误</li></ul><h3 id="axios拦截器"><a href="#axios拦截器" class="headerlink" title="axios拦截器"></a>axios拦截器</h3><p><strong>请求拦截</strong></p><p>案例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vue">const _axios = axios.create(&#123;<br>    // 会被添加在每个请求url前<br>    baseURL: &#x27;http://localhost:8080&#x27;,<br>    // 跨域时是否携带 Cookie 等凭证，默认为 false<br>    withCredentials: true<br>&#125;)<br>// 请求拦截器<br>_axios.interceptors.request.use(<br>// 请求正常时<br>    function (config) &#123;<br>// 给每个请求都添加头Authorization<br>        config.headers = &#123;<br>        Authorization: &#x27;aaa.bbb.ccc&#x27;<br>    &#125;<br>    return config<br>    &#125;,<br>// 请求错误时<br>    function (error) &#123;<br>        return Promise.reject(error);<br>    &#125;<br>)<br>_axios.get(&quot;/api/students&quot;)<br></code></pre></td></tr></table></figure><p><strong>响应拦截器</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs vue">// 响应拦截器<br>_axios.interceptors.response.use(<br>    // 响应码在200之内<br>    function (response) &#123;<br>        console.log(&#x27;响应正常&#x27;)<br>        return response<br>&#125;,<br>    // 响应码大于200时<br>    function (error) &#123;<br>        if (error.response.status === 400) &#123;<br>        console.log(&#x27;请求参数错误&#x27;)<br>        &#125; else if (error.response.status === 500) &#123;<br>        console.log(&#x27;服务器错误&#x27;)<br>        &#125; else if (error.response.status === 404) &#123;<br>        console.log(&#x27;资源未找到&#x27;)<br>        &#125; else &#123;<br>        console.log(&#x27;未知错误&#x27;)<br>        &#125;<br>        return Promise.reject(error)<br>&#125;<br>)<br>_axios.get(&quot;/api/students&quot;)<br></code></pre></td></tr></table></figure><p>可以将配置好的axios抽出来成为一个工具类</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs vue">// axios工具类<br>import axios from &#x27;axios&#x27;<br><br>// 配置<br>const _axios = axios.create(&#123;<br>    baseURL: &#x27;http://localhost:8080&#x27;,<br>    withCredentials: true<br>&#125;)<br><br>// 请求拦截器<br>_axios.interceptors.request.use(<br>    function (config) &#123;<br>        config.headers = &#123;<br>            Authorization: &#x27;aaa.bbb.ccc&#x27;<br>        &#125;<br>        return config<br>    &#125;,<br>    function (error) &#123;<br>        return Promise.reject(error);<br>    &#125;<br>)<br><br>// 响应拦截器<br>_axios.interceptors.response.use(<br>    // 响应码在200之内<br>    function (response) &#123;<br>        console.log(&#x27;响应正常&#x27;)<br>        return response<br>    &#125;,<br>    // 响应码大于200时<br>    function (error) &#123;<br>        if (error.response.status === 400) &#123;<br>            console.log(&#x27;请求参数错误&#x27;)<br>        &#125; else if (error.response.status === 500) &#123;<br>            console.log(&#x27;服务器错误&#x27;)<br>        &#125; else if (error.response.status === 404) &#123;<br>            console.log(&#x27;资源未找到&#x27;)<br>        &#125; else &#123;<br>            console.log(&#x27;未知错误&#x27;)<br>        &#125;<br>        return Promise.reject(error)<br>    &#125;<br>)<br><br>export default _axios<br></code></pre></td></tr></table></figure><p>用的时候导入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script&gt;<br>    // 导入自己配置好的axios<br>    import _axios from &#x27;../utils/myaxios&#x27;<br>    const option = &#123;<br>        methods: &#123;<br>            async sendReq() &#123;<br>                const resp = await _axios.get(&#x27;/api/students&#x27;)<br>                console.log(resp)<br>            &#125;<br>        &#125;<br>    &#125;<br>    export default option<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>API</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Fetch API</title>
    <link href="/2022/10/04/%E5%89%8D%E7%AB%AF/api/FetchAPI/"/>
    <url>/2022/10/04/%E5%89%8D%E7%AB%AF/api/FetchAPI/</url>
    
    <content type="html"><![CDATA[<h2 id="Fetch-API"><a href="#Fetch-API" class="headerlink" title="Fetch API"></a>Fetch API</h2><blockquote><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API">Fetch API</a> 提供了一个 JavaScript 接口，用于访问和操纵 HTTP 管道的一些具体部分，例如请求和响应。它还提供了一个全局 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/fetch"><code>fetch()</code></a> 方法，该方法提供了一种简单，合理的方式来跨网络异步获取资源。</p></blockquote><h3 id="fetch"><a href="#fetch" class="headerlink" title="fetch()"></a>fetch()</h3><blockquote><p>用于发起获取资源的请求。它返回一个 promise，这个 promise 会在请求响应后被 resolve，并传回 Response 对象。</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">fetch</span>(url[, init])<span class="hljs-comment">//init：对请求的设置</span><br></code></pre></td></tr></table></figure><h3 id="同步方式接收响应"><a href="#同步方式接收响应" class="headerlink" title="同步方式接收响应"></a>同步方式接收响应</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> 结果 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span><span class="hljs-comment">//会阻塞之后的代码，直到接收到响应结果</span><br></code></pre></td></tr></table></figure><ul><li>await 关键字必须在一个标记了 async 的 function 内来使用</li></ul><p><strong>案例</strong></p><blockquote><p>前面的部分</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>学生列表<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;thead&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row bold&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>编号<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>姓名<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>性别<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>年龄<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;tbody&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;tp&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>xx<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>xx<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>xx<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col&quot;</span>&gt;</span>xx<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p>同步接收数据，并写到html表单里</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">findStudents</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-comment">// 向students.json发送request请求</span><br>        <span class="hljs-keyword">const</span> resp = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;students.json&#x27;</span>)<br>        <span class="hljs-comment">// 获取响应体，按json方式解析</span><br>        <span class="hljs-keyword">const</span> array = <span class="hljs-keyword">await</span> resp.<span class="hljs-title function_">json</span>();<span class="hljs-comment">//.json返回的还是一个Promise</span><br><br>        <span class="hljs-comment">// 获取模板</span><br>        <span class="hljs-keyword">const</span> tp = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;tp&quot;</span>);<br>        <span class="hljs-keyword">const</span> row = tp.<span class="hljs-property">content</span>;<br><br>        <span class="hljs-comment">// 将数据填入模板，并复制到要显示的文本中</span><br>        <span class="hljs-keyword">const</span> [c1, c2, c3, c4] = row.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;.col&quot;</span>);<br>        <span class="hljs-keyword">const</span> tbody = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.tbody&#x27;</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> &#123;id, name, sex, age&#125; <span class="hljs-keyword">of</span> array) &#123;<br>            c1.<span class="hljs-property">textContent</span> = id;<br>            c2.<span class="hljs-property">textContent</span> = name;<br>            c3.<span class="hljs-property">textContent</span> = sex;<br>            c4.<span class="hljs-property">textContent</span> = age;<br><br>            <span class="hljs-keyword">const</span> newRow = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">importNode</span>(row, <span class="hljs-literal">true</span>);<br>            tbody.<span class="hljs-title function_">appendChild</span>(newRow);<br>        &#125;<br>    &#125;<br>    <span class="hljs-title function_">findStudents</span>();<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="异步方式接收响应"><a href="#异步方式接收响应" class="headerlink" title="异步方式接收响应"></a>异步方式接收响应</h3><blockquote><p>通过.then来异步接收响应</p></blockquote> <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;students.json&#x27;</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">resp</span> =&gt;</span> resp.<span class="hljs-title function_">json</span>())<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">array</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// 获取模板</span><br>    <span class="hljs-keyword">const</span> tp = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;tp&quot;</span>);<br>    <span class="hljs-keyword">const</span> row = tp.<span class="hljs-property">content</span>;<br><br>    <span class="hljs-comment">// 将数据填入模板，并复制到要显示的文本中</span><br>    <span class="hljs-keyword">const</span> [c1, c2, c3, c4] = row.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&quot;.col&quot;</span>);<br>    <span class="hljs-keyword">const</span> tbody = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;.tbody&#x27;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> &#123;id, name, sex, age&#125; <span class="hljs-keyword">of</span> array) &#123;<br>        c1.<span class="hljs-property">textContent</span> = id;<br>        c2.<span class="hljs-property">textContent</span> = name;<br>        c3.<span class="hljs-property">textContent</span> = sex;<br>        c4.<span class="hljs-property">textContent</span> = age;<br><br>        <span class="hljs-keyword">const</span> newRow = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">importNode</span>(row, <span class="hljs-literal">true</span>);<br>        tbody.<span class="hljs-title function_">appendChild</span>(newRow);<br>    &#125;<br>&#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e)) <span class="hljs-comment">//捕获异常</span><br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h3><blockquote><p>同源检查是浏览器的行为，而且只针对 fetch、xhr（XMLHTTPRequest） 请求</p><p>只要协议、主机、端口之一不同，就不同源</p></blockquote><ul><li>fetch 请求跨域，会携带一个 Origin 头，代表【发请求的资源源自何处】，目标通过它就能辨别是否发生跨域</li><li>目标资源通过返回 Access-Control-Allow-Origin 头，告诉浏览器【允许哪些源使用此响应】</li></ul><p><strong>通过添加响应头解决</strong></p><ul><li><p>java后端添加注解CrossOrigin来添加 Access-Control-Allow-Origin响应头</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/api/students&quot;)</span><br><span class="hljs-meta">@CrossOrigin(&quot;http://localhost:7070&quot;)</span><br><span class="hljs-keyword">public</span> R <span class="hljs-title function_">all</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> R.ok(studentService.findAll());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>也可以通过配置类配置全局跨域</p><blockquote><p>实现WebMvcConfigurer的addCorsMappings方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCorsMappings</span><span class="hljs-params">(CorsRegistry registry)</span> &#123;<br>        registry.addMapping(<span class="hljs-string">&quot;/**&quot;</span>)<br>            <span class="hljs-comment">// 设置允许跨域请求的域名</span><br>            .allowedOriginPatterns(<span class="hljs-string">&quot;http://localhost:8080&quot;</span>)<br>            <span class="hljs-comment">// 是否允许携带cookie</span><br>            .allowCredentials(<span class="hljs-literal">true</span>)<br>            <span class="hljs-comment">// 设置允许的请求方式</span><br>            .allowedMethods(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-string">&quot;DELETE&quot;</span>, <span class="hljs-string">&quot;PUT&quot;</span>)<br>            <span class="hljs-comment">// 设置允许的header属性</span><br>            .allowedHeaders(<span class="hljs-string">&quot;*&quot;</span>)<br>            <span class="hljs-comment">// 跨域允许的时间</span><br>            .maxAge(<span class="hljs-number">3600</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>通过代理解决</strong></p><blockquote><p>浏览器要访问跨域的资源时，将请求发到前端的代理中，让代理去获得资源再返回</p></blockquote><ul><li><p>安装</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">npm install <span class="hljs-keyword">http</span>-proxy-middleware <span class="hljs-comment">--save-dev</span><br></code></pre></td></tr></table></figure></li><li><p>在启动代码中导入</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">import</span> &#123;createProxyMiddleware&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;http-proxy-middleware&#x27;</span><br><br><span class="hljs-comment">//创建代理中间件，请求url为&#x27;/api&#x27;的都会被代理</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/api&#x27;</span>, <span class="hljs-title function_">createProxyMiddleware</span>(&#123; <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://localhost:8080&#x27;</span>, <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span> &#125;));<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>API</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>搭建前端服务器</title>
    <link href="/2022/10/03/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E6%90%AD%E5%BB%BA%E5%89%8D%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <url>/2022/10/03/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E6%90%AD%E5%BB%BA%E5%89%8D%E7%AB%AF%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="搭建前端服务器"><a href="#搭建前端服务器" class="headerlink" title="搭建前端服务器"></a>搭建前端服务器</h2><p><strong>案例</strong></p><ul><li><p>新建项目文件夹</p></li><li><p>执行命令</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">npm install <span class="hljs-built_in">express</span> --<span class="hljs-built_in">save</span>-dev<br></code></pre></td></tr></table></figure></li><li><p>修改<code>package.json</code>文件</p><blockquote><p>添加”type”: “module”就可以使用import来导入模块</p><p>其中 devDependencies 是 npm install –save-dev 添加的</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;module&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;devDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;express&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^4.18.1&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>编写<code>main.js</code>文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">import express from &#x27;express&#x27;<br>const app = express()<br><br>app.use(express.static(&#x27;./&#x27;))<br>app.listen(<span class="hljs-number">7070</span>)<br></code></pre></td></tr></table></figure><p>代码解释：</p><ul><li><p>const app &#x3D; express()：创建一个新的应用程序</p></li><li><p>app.listen(7070)：设置监听的端口</p></li><li><p>app.use(express.static(‘.&#x2F;‘))：设置静态文件目录</p></li></ul></li><li><p>控制台(VSCode快捷键: ctrl+shift+反引号)执行命名</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">node</span> <span class="hljs-title">main</span>.js<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>搭建环境</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>安装nvm</title>
    <link href="/2022/10/03/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E5%AE%89%E8%A3%85nvm/"/>
    <url>/2022/10/03/%E5%89%8D%E7%AB%AF/%E5%89%8D%E7%AB%AF%E7%8E%AF%E5%A2%83/%E5%AE%89%E8%A3%85nvm/</url>
    
    <content type="html"><![CDATA[<h2 id="安装nvm"><a href="#安装nvm" class="headerlink" title="安装nvm"></a>安装nvm</h2><blockquote><p>nvm 即 (node version manager)，好处是方便切换 node.js 版本</p></blockquote><p><a href="https://github.com/coreybutler/nvm-windows/releases">github下载</a> , 下载<code>nvm-setup.zip</code></p><p>安装注意事项</p><ul><li>提示选择 nvm 和 nodejs 目录时，一定要避免目录中出现空格</li><li>选用【以管理员身份运行】cmd 程序来执行 nvm 命令</li></ul><h3 id="安装nvm-1"><a href="#安装nvm-1" class="headerlink" title="安装nvm"></a>安装nvm</h3><ul><li><p>首次运行前设置好国内镜像地址</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">nvm node_mirror http:<span class="hljs-regexp">//</span>npm.taobao.org<span class="hljs-regexp">/mirrors/</span>node/<br>nvm npm_mirror https:<span class="hljs-regexp">//</span>npm.taobao.org<span class="hljs-regexp">/mirrors/</span>npm/<br></code></pre></td></tr></table></figure></li><li><p>查看nodejs可用版本</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">nvm list available<br></code></pre></td></tr></table></figure></li><li><p>建议下载LTS(长期支持版)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nvm</span> install <span class="hljs-number">16</span>.<span class="hljs-number">16</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">nvm</span> install <span class="hljs-number">14</span>.<span class="hljs-number">20</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li><li><p>切换nodejs版本</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">nvm</span> use <span class="hljs-number">16</span>.<span class="hljs-number">16</span>.<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="检查npm"><a href="#检查npm" class="headerlink" title="检查npm"></a>检查npm</h3><blockquote><p>npm（node package manager） 是 js 的包管理器，就类似于 java 界的 maven，要确保它使用的是国内镜像</p></blockquote><ul><li><p>检查镜像</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">npm <span class="hljs-built_in">get</span> registry<br></code></pre></td></tr></table></figure></li><li><p>设置国内镜像</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">npm config set registry https:<span class="hljs-comment">//registry.npm.taobao.org/</span><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>搭建环境</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>多级缓存</title>
    <link href="/2022/09/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/"/>
    <url>/2022/09/29/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<h2 id="多级缓存"><a href="#多级缓存" class="headerlink" title="多级缓存"></a>多级缓存</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p><img src="/img/weifuwu_img/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98.png"></p><p>tomcat查询的速度比较慢，尽量通过缓存来减少tomcat的查询</p><p><strong>多级缓存</strong>就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能</p><p>多级缓存的关键有两个：</p><ul><li><p>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询</p></li><li><p>另一个就是在Tomcat中实现JVM进程缓存</p></li></ul><h3 id="JVM进程缓存"><a href="#JVM进程缓存" class="headerlink" title="JVM进程缓存"></a>JVM进程缓存</h3><h4 id="Caffeine"><a href="#Caffeine" class="headerlink" title="Caffeine"></a>Caffeine</h4><blockquote><p><strong>Caffeine</strong>是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前Spring内部的缓存使用的就是Caffeine</p><p><a href="https://github.com/ben-manes/caffeine">github地址</a></p></blockquote><h4 id="使用Caffeine"><a href="#使用Caffeine" class="headerlink" title="使用Caffeine"></a>使用Caffeine</h4><ul><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>基本使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//创建缓存对象</span><br>    Cache&lt;String, String&gt; cache = Caffeine.newBuilder().build();<br><br>    <span class="hljs-comment">//添加数据到缓存</span><br>    cache.put(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zs&quot;</span>);<br>    System.out.println(cache.getIfPresent(<span class="hljs-string">&quot;name&quot;</span>));<br><br>    <span class="hljs-comment">//类似getOrDefault，可以在查不到缓存的时候查数据库来返回值</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">&quot;defaultName&quot;</span>, key -&gt; &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ls&quot;</span>;<br>    &#125;);<br>    System.out.println(name);<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> &#123;<br>    Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>        <span class="hljs-comment">//添加清除缓存策略</span><br>        .maximumSize(<span class="hljs-number">1</span>)     <span class="hljs-comment">//基于容量，超过1个缓存就会清除旧的</span><br>        .expireAfterWrite(Duration.ofSeconds(<span class="hljs-number">10</span>))   <span class="hljs-comment">//基于时间, 10s后清除</span><br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>实例</p><p>注入到容器实现自动装配</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, Item&gt; <span class="hljs-title function_">itemCache</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10000</span>)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, ItemStock&gt; <span class="hljs-title function_">itemStockCache</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10000</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过Cache实现JVM进程缓存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemController</span> &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br>    <br>    <span class="hljs-comment">//商品缓存</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; itemCache;<br>    <span class="hljs-comment">//库存缓存</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, ItemStock&gt; itemStockCache;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Item <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br>        <span class="hljs-comment">//先查缓存，没有再查数据库</span><br>        <span class="hljs-keyword">return</span> itemCache.get(id, key -&gt; &#123;<br>           <span class="hljs-keyword">return</span>  itemService.query()<br>                   .ne(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id)<br>                   .one();<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/stock/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ItemStock <span class="hljs-title function_">findStockById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br>        <span class="hljs-keyword">return</span> itemStockCache.get(id, key -&gt; &#123;<br>            <span class="hljs-keyword">return</span> stockService.getById(id);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="Lua语法入门"><a href="#Lua语法入门" class="headerlink" title="Lua语法入门"></a>Lua语法入门</h3><blockquote><p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了<strong>嵌入应用程序</strong>中，从而为应用程序提供灵活的扩展和定制功能。<a href="https://www.lua.org/">官网</a></p><p>Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。</p><p>Nginx本身也是C语言开发，因此也允许基于Lua做拓展。</p></blockquote><h4 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h4><ul><li><p>创建hello.lua文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">touch</span> hello.lua<br><span class="hljs-comment"># 编辑</span><br>vim hello.lua<br></code></pre></td></tr></table></figure></li><li><p>文件内</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;hello lua&quot;</span>)<br></code></pre></td></tr></table></figure></li><li><p>运行hello.lua</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">lua hello.lua<br></code></pre></td></tr></table></figure><p><img src="/img/weifuwu_img/luaHelloWorld.png"></p></li></ul><h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p><strong>变量类型</strong></p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>nil</td><td>表示一个无效值或false</td></tr><tr><td>boolean</td><td>true&#x2F;false</td></tr><tr><td>number</td><td>双精度浮点数</td></tr><tr><td>string</td><td>字符串</td></tr><tr><td>function</td><td>函数</td></tr><tr><td>table</td><td>可以作为数组或map来使用</td></tr></tbody></table><blockquote><p>通过函数type()可以查看变量类型</p></blockquote><p><img src="/img/weifuwu_img/luaType.png"></p><p><strong>声明变量</strong></p><blockquote><p>Lua声明变量的时候无需指定数据类型</p></blockquote><ul><li><p>local 关键字声明局部变量，没有则是全局变量</p><p><img src="/img/weifuwu_img/lua%E5%8F%98%E9%87%8F1.png"></p></li><li><p>string、number、boolean</p><p><img src="/img/weifuwu_img/lua%E5%8F%98%E9%87%8F2.png"></p></li><li><p>table</p><p><img src="/img/weifuwu_img/lua%E5%8F%98%E9%87%8F3.png"></p></li><li><p>访问table</p><blockquote><p>下标从1开始</p></blockquote><p><img src="/img/weifuwu_img/lua%E5%8F%98%E9%87%8F4.png"></p><p><img src="/img/weifuwu_img/lua%E5%8F%98%E9%87%8F5.png"></p></li></ul><h4 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h4><blockquote><p>循环数组用ipairs，循环map用pairs</p></blockquote><p><img src="/img/weifuwu_img/lua%E5%BE%AA%E7%8E%AF1.png"></p><p><img src="/img/weifuwu_img/lua%E5%BE%AA%E7%8E%AF2.png"></p><h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><p><img src="/img/weifuwu_img/lua%E5%87%BD%E6%95%B01.png"></p><p><img src="/img/weifuwu_img/lua%E5%87%BD%E6%95%B02.png"></p><h4 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h4><p>语法</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>(布尔表达式)<br><span class="hljs-keyword">then</span><br>   <span class="hljs-comment">--[ 布尔表达式为 true 时执行该语句块 --]</span><br><span class="hljs-keyword">else</span><br>   <span class="hljs-comment">--[ 布尔表达式为 false 时执行该语句块 --]</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><blockquote><p>&amp;&amp; || !     对应    and or not</p></blockquote><p><img src="/img/weifuwu_img/lua%E6%9D%A1%E4%BB%B61.png"></p><p><img src="/img/weifuwu_img/lua%E6%9D%A1%E4%BB%B62.png"></p><h3 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a>OpenResty</h3><blockquote><p>基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。<a href="https://openresty.org/cn/">官网</a></p></blockquote><p>特点：</p><ul><li>具备Nginx的完整功能</li><li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li><li>允许使用Lua<strong>自定义业务逻辑</strong>、<strong>自定义库</strong></li></ul><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><ul><li><p>安装OpenResty依赖开发库</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install -y pcre-devel openssl-devel gcc --skip-broken<br></code></pre></td></tr></table></figure></li><li><p>安装OpenResty仓库，便于未来安装或更新我们的软件包</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo<br></code></pre></td></tr></table></figure></li><li><p>安装OpenResty</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum install -y openresty<br></code></pre></td></tr></table></figure></li><li><p>安装opm工具</p><blockquote><p>opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y openresty-opm<br></code></pre></td></tr></table></figure></li><li><p>默认情况下，OpenResty安装的目录是：&#x2F;usr&#x2F;local&#x2F;openresty</p><p>OpenResty就是在Nginx基础上集成了一些Lua模块</p></li></ul><h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#打开配置文件</span><br>vi /etc/profile<br><br><span class="hljs-comment"># 添加环境变量</span><br><span class="hljs-built_in">export</span> NGINX_HOME=/usr/local/openresty/nginx<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$&#123;NGINX_HOME&#125;</span>/sbin:<span class="hljs-variable">$PATH</span><br><br><span class="hljs-comment"># 让配置文件生效</span><br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure><h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><p>运行方式与nginx基本一致</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 启动nginx</span><br>nginx<br><span class="hljs-comment"># 重新加载配置</span><br>nginx -s reload<br><span class="hljs-comment"># 停止</span><br>nginx -s stop<br></code></pre></td></tr></table></figure><blockquote><p> <code>/usr/local/openresty/nginx/conf/nginx.conf</code>为nginx默认的配置文件，里面注释比较多，可以将nginx.conf中的注释部分删除，保留有效部分。</p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#user  nobody;</span><br><span class="hljs-attribute">worker_processes</span>  <span class="hljs-number">1</span>;<br><span class="hljs-attribute">error_log</span>  logs/<span class="hljs-literal">error</span>.log;<br><br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span>  <span class="hljs-number">1024</span>;<br>&#125;<br><br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">include</span>       mime.types;<br>    <span class="hljs-attribute">default_type</span>  application/octet-stream;<br>    <span class="hljs-attribute">sendfile</span>        <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">65</span>;<br><br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">8081</span>;<br>        <span class="hljs-attribute">server_name</span>  localhost;<br>        <span class="hljs-section">location</span> / &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>            <span class="hljs-attribute">index</span>  index.html index.htm;<br>        &#125;<br>        <span class="hljs-attribute">error_page</span>   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.html;<br>        <span class="hljs-section">location</span> = /50x.html &#123;<br>            <span class="hljs-attribute">root</span>   html;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="通过OpenResty响应请求"><a href="#通过OpenResty响应请求" class="headerlink" title="通过OpenResty响应请求"></a>通过OpenResty响应请求</h4><p><strong>案例</strong></p><ul><li><p>做反向代理的nginx的配置文件</p><blockquote><p>将请求发送到OpenResty端口</p></blockquote><p><img src="/img/weifuwu_img/OpenResty%E6%A1%88%E4%BE%8B1.png"></p></li><li><p>OpenResty配置文件</p><blockquote><p>在http下面添加Lua依赖库</p><p>改完配置文件nginx -s reload 重新加载一下配置文件</p></blockquote><p><img src="/img/weifuwu_img/OpenResty%E6%A1%88%E4%BE%8B2.png"></p></li><li><p>在OpenResty的<code>/usr/local/openresty/nginx</code>下创建<code>lua/item.lua</code>文件</p><p><img src="/img/weifuwu_img/OpenResty%E6%A1%88%E4%BE%8B3.png"></p></li><li><p>在<code>lua/item.lua</code>文件里面编写响应的逻辑</p><blockquote><p>这里通过ngx.say()返回假数据</p></blockquote><p><img src="/img/weifuwu_img/OpenResty%E6%A1%88%E4%BE%8B4.png"></p></li><li><p>页面再次请求，返回lua文件里的响应</p><blockquote><p>没有反应的把nginx进程杀掉再试试</p></blockquote></li></ul><h4 id="获取请求参数"><a href="#获取请求参数" class="headerlink" title="获取请求参数"></a>获取请求参数</h4><p><img src="/img/weifuwu_img/Lua%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B0.png"></p><p><strong>案例</strong></p><ul><li><p>openResty配置文件</p><p><img src="/img/weifuwu_img/Lua%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B02.png"></p></li><li><p>item.lua文件</p><p><img src="/img/weifuwu_img/Lua%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%8F%82%E6%95%B03.png"></p></li></ul><h3 id="OpenResty查询Tomcat"><a href="#OpenResty查询Tomcat" class="headerlink" title="OpenResty查询Tomcat"></a>OpenResty查询Tomcat</h3><p><strong>OpenResty发送http请求方式</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> resp = ngx.location.capture(<span class="hljs-string">&quot;/path&quot;</span>,&#123;<br>    method = ngx.HTTP_GET,   <span class="hljs-comment">-- 请求方式</span><br>    args = &#123;a=<span class="hljs-number">1</span>,b=<span class="hljs-number">2</span>&#125;,  <span class="hljs-comment">-- get方式传参数</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>返回的响应内容包括：</p><ul><li>resp.status：响应状态码</li><li>resp.header：响应头，是一个table</li><li>resp.body：响应体，就是响应数据</li></ul><p>注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。</p><p><strong>通过nginx反向代理发送请求到tomcat</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#将/path请求代理到tomcat的ip和端口</span><br><span class="hljs-section">location</span> /path &#123;<br>     <span class="hljs-comment"># 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态</span><br>     <span class="hljs-attribute">proxy_pass</span> http://192.168.229.1:8081; <br> &#125;<br></code></pre></td></tr></table></figure><h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><ul><li><p>在<code>/usr/local/openresty/lualib</code>目录下编写common.lua工具类</p><blockquote><p>将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出</p><p>使用的时候，可以利用<code>require(&#39;common&#39;)</code>来导入该函数库，这里的common是函数库的文件名</p></blockquote><p><img src="/img/weifuwu_img/OpenResty%E6%9F%A5%E8%AF%A2tomcat1.png"></p></li><li><p>在<code>/usr/local/openresty/nginx/conf/nginx.conf</code>配置文件中添加location</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /item &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://192.168.229.1:8081;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>修改item.lua文件</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入自定义的common.lua 工具模块</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-comment">-- 导入json解析模块</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><br><br><span class="hljs-comment">-- 获取id</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>];<br><br><span class="hljs-comment">-- 从common中获取read_http函数</span><br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-comment">-- 发送请求获取商品和库存</span><br><span class="hljs-keyword">local</span> itemJson = read_http(<span class="hljs-string">&#x27;/item/&#x27;</span> .. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">local</span> itemStockJson = read_http(<span class="hljs-string">&#x27;/item/stock/&#x27;</span> .. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- 解析json，将两个查询结果合成一个</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJson)<br><span class="hljs-keyword">local</span> stock = cjson.decode(itemStockJson)<br>item.stock = stock.stock <br>item.sold = stock.sold<br><br><span class="hljs-comment">-- 将查询结果重新序列化为json并返回</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure></li><li><p>nginx重新加载配置文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">nginx -s reload<br></code></pre></td></tr></table></figure></li></ul><h4 id="基于查询id的负载均衡"><a href="#基于查询id的负载均衡" class="headerlink" title="基于查询id的负载均衡"></a>基于查询id的负载均衡</h4><blockquote><p>相同的id都会代理到同一台tomcat服务器，不会出现一条数据缓存在多台服务器上的冗余</p></blockquote><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> tomcat-cluster &#123;<br>    <span class="hljs-attribute">hash</span> <span class="hljs-variable">$request_uri</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.229.1:8081</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.229.1:8082</span>;<br>&#125;<br><br><span class="hljs-section">location</span> /item &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://tomcat-cluster;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 重新加载配置文件</span><br>nginx -s reload<br></code></pre></td></tr></table></figure><h3 id="OpenResty查询Redis"><a href="#OpenResty查询Redis" class="headerlink" title="OpenResty查询Redis"></a>OpenResty查询Redis</h3><h4 id="Redis预热"><a href="#Redis预热" class="headerlink" title="Redis预热"></a>Redis预热</h4><blockquote><p>Redis刚启动时没有缓存，将热点数据提前查询并保存到Redis中称为预热</p></blockquote><ul><li><p>docker 安装redis</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">docker <span class="hljs-built_in">run</span> --name redis -p 6379:6379 -d redis redis-server --appendonly <span class="hljs-literal">yes</span><br></code></pre></td></tr></table></figure></li><li><p>引入redis依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置redis地址</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><br></code></pre></td></tr></table></figure></li><li><p>编写初始化类</p><blockquote><p><strong>InitializingBean</strong>接口：为bean提供了属性初始化后的处理方法，它只有一个afterPropertiesSet方法，凡是继承该接口的类，在bean的属性初始化后都会执行该方法。</p><p><strong>ObjectMapper</strong>：spring默认的json处理工具</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.item.config;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ItemService itemService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ItemStockService itemStockService;<br><br>    <span class="hljs-comment">//json解析</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在对象被Spring创建并且成员变量全部注入后执行</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//获取要放入redis中的数据</span><br>        List&lt;Item&gt; itemList = itemService.list();<br><br>        <span class="hljs-keyword">for</span> (Item item : itemList) &#123;<br>            <span class="hljs-comment">//转为json并存入redis</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(item);<br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span> + item.getId(), json);<br>        &#125;<br><br>        <span class="hljs-comment">// 3.查询商品库存信息</span><br>        List&lt;ItemStock&gt; stockList = itemStockService.list();<br>        <span class="hljs-comment">// 4.放入缓存</span><br>        <span class="hljs-keyword">for</span> (ItemStock stock : stockList) &#123;<br>            <span class="hljs-comment">// 2.1.item序列化为JSON</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(stock);<br>            <span class="hljs-comment">// 2.2.存入redis</span><br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:stock:id:&quot;</span> + stock.getId(), json);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>重启服务就能看到redis中被添加了数据</p></li></ul><h4 id="查询Redis缓存"><a href="#查询Redis缓存" class="headerlink" title="查询Redis缓存"></a>查询Redis缓存</h4><ul><li><p>在<code>/usr/local/openresty/lualib/common.lua</code>中封装查询redis的函数</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入依赖库</span><br><span class="hljs-comment">-- resty目录下的redis依赖库</span><br><span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;resty.redis&#x27;</span>)<br><br><br><br><span class="hljs-comment">-- 发送http请求到tomcat</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_http</span> <span class="hljs-params">(path, params)</span></span><br><span class="hljs-comment">-- 发送请求 </span><br><span class="hljs-keyword">local</span> resp = ngx.location.capture(<span class="hljs-built_in">path</span>, &#123;<br>method = ngx.HTTP_GET,<br>args = params,<br>&#125;)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br><span class="hljs-comment">-- 记录错误信息</span><br>ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;http请求查询失败, path: &quot;</span>, <span class="hljs-built_in">path</span> , <span class="hljs-string">&quot;, args: &quot;</span>, args)<br>ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">404</span>)<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 解析出响应体并返回</span><br><span class="hljs-keyword">return</span> resp.body<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 初始化redis</span><br><span class="hljs-keyword">local</span> red = redis:new()<br>red:set_timeouts(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>)<span class="hljs-comment">-- 连接超时，请求超时，响应超时</span><br><span class="hljs-comment">-- 释放redis连接</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">close_redis</span> <span class="hljs-params">(red)</span></span> <br><span class="hljs-keyword">local</span> pool_max_idle_time = <span class="hljs-number">10000</span><span class="hljs-comment">-- 连接的空闲时间,ms</span><br><span class="hljs-keyword">local</span> pool_size = <span class="hljs-number">100</span><br><span class="hljs-keyword">local</span> ok, err = red:set_keepalive(pool_max_idle_time, pool_size)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span><br>ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;释放redis连接失败&quot;</span>, err)<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 查询redis</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_redis</span><span class="hljs-params">(ip, port, key)</span></span><br><span class="hljs-comment">-- 获取一个连接</span><br><span class="hljs-keyword">local</span> ok, err = red:connect(ip, port)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span> <br>ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;连接Redis失败&quot;</span>, err)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 查询redis</span><br><span class="hljs-keyword">local</span> resp, err = red:get(key)<br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;查询Redis失败&quot;</span>, err, <span class="hljs-string">&quot;key = &quot;</span>, key)<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 查询的数据为空时</span><br><span class="hljs-keyword">if</span> resp == ngx.null <span class="hljs-keyword">then</span><br>resp = <span class="hljs-literal">nil</span><br>ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;查询Redis数据为空&quot;</span>, err, <span class="hljs-string">&quot;key = &quot;</span>, key)<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 释放连接</span><br>close_redis(red)<br>    <span class="hljs-comment">-- 这里resp是json数据，不用resp.body</span><br><span class="hljs-keyword">return</span> resp<br><span class="hljs-keyword">end</span><br><br><br><br><span class="hljs-comment">-- 将方法导出</span><br><span class="hljs-keyword">local</span> _M = &#123;<br>read_http = read_http,<br>read_redis = read_redis<br>&#125;<br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure></li><li><p>修改<code>/usr/local/openresty/lua/item.lua</code>文件，改为先查redis再查tomcat</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入自定义的common.lua 工具模块</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-comment">-- 从common中获取函数</span><br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-keyword">local</span> read_redis = common.read_redis<br><span class="hljs-comment">-- 导入json解析模块</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><br><br><span class="hljs-comment">-- 封装查询方法</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, path, params)</span></span><br>    <span class="hljs-comment">-- 查询redis缓存</span><br>    <span class="hljs-keyword">local</span> data = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>, key)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data <span class="hljs-keyword">then</span> <br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;redis查询失败,尝试查询http, key:&quot;</span>, key)<br>        data = read_http(<span class="hljs-built_in">path</span>, params)<br>    <span class="hljs-keyword">end</span><br><br>    <span class="hljs-keyword">return</span> data<br><span class="hljs-keyword">end</span><br><br><br><br><span class="hljs-comment">-- 获取id</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>];<br><br><span class="hljs-comment">-- 发送请求获取商品和库存</span><br><span class="hljs-keyword">local</span> itemJson = read_data(<span class="hljs-string">&#x27;item:id:&#x27;</span> .. id, <span class="hljs-string">&#x27;/item/&#x27;</span> .. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-keyword">local</span> itemStockJson = read_data(<span class="hljs-string">&#x27;item:stock:id:&#x27;</span> .. id, <span class="hljs-string">&#x27;/item/stock/&#x27;</span> .. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- 解析json，将两个查询结果合成一个</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJson)<br><span class="hljs-keyword">local</span> stock = cjson.decode(itemStockJson)<br>item.stock = stock.stock <br>item.sold = stock.sold<br><br><span class="hljs-comment">-- 将查询结果重新序列化为json并返回</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure></li><li><p>修改控制层逻辑，当查到JVM缓存的时候给Redis也存一份数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Item <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br>    <span class="hljs-comment">//先查缓存，没有再查数据库</span><br>    <span class="hljs-type">Item</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> itemCache.get(id, key -&gt; &#123;<br>        <span class="hljs-keyword">return</span> itemService.query()<br>            .ne(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id)<br>            .one();<br>    &#125;);<br>    <span class="hljs-comment">//查到JVM缓存了，说明redis中没有数据，存入redis一份数据</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span> + id, mapper.writeValueAsString(data));<br>    &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br><br><span class="hljs-meta">@GetMapping(&quot;/stock/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> ItemStock <span class="hljs-title function_">findStockById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br>    <span class="hljs-type">ItemStock</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> itemStockCache.get(id, key -&gt; &#123;<br>        <span class="hljs-keyword">return</span> stockService.getById(id);<br>    &#125;);<br>    <span class="hljs-comment">//查到JVM缓存了，说明redis中没有数据，存入redis一份数据</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:stock:id:&quot;</span> + id, mapper.writeValueAsString(data));<br>    &#125; <span class="hljs-keyword">catch</span> (JsonProcessingException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="OpenResty查询本地缓存"><a href="#OpenResty查询本地缓存" class="headerlink" title="OpenResty查询本地缓存"></a>OpenResty查询本地缓存</h3><blockquote><p>OpenResty为Nginx提供了<strong>shard dict</strong>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。</p></blockquote><ul><li><p>在nginx.conf的html下中开启本地缓存</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启共享字典(本地缓存)名称叫做：item_cache，大小150m</span><br><span class="hljs-attribute">lua_shared_dict</span> item_cache <span class="hljs-number">150m</span>; <br></code></pre></td></tr></table></figure></li><li><p>修改<code>/usr/local/openresty/lua/item.lua</code>文件，添加本地缓存逻辑</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 导入共享词典，本地缓存</span><br><span class="hljs-keyword">local</span> item_cache = ngx.shared.item_cache<br><br><br><span class="hljs-comment">-- 封装查询方法</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, path, params)</span></span><br>    <span class="hljs-comment">-- 先查本地缓存</span><br>    <span class="hljs-keyword">local</span> data = item_cache:get(key)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;本地缓存查询失败, 尝试查询Redis, key: &quot;</span>, key)<br>        <span class="hljs-comment">-- 查询redis缓存</span><br>        data = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>, key)<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data <span class="hljs-keyword">then</span> <br>            ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;redis查询失败,尝试查询http, key:&quot;</span>, key)<br>            <span class="hljs-comment">-- 查询tomcat缓存</span><br>            data = read_http(<span class="hljs-built_in">path</span>, params)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- 添加本地缓存, 键，值，过期时间</span><br>    item_cache:set(key, data, <span class="hljs-number">1000</span>)<br><br>    <span class="hljs-keyword">return</span> data<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="缓存同步"><a href="#缓存同步" class="headerlink" title="缓存同步"></a>缓存同步</h3><p>缓存数据同步的常见方式有三种：</p><p><strong>设置有效期</strong>：给缓存设置有效期，到期后自动删除。再次查询时更新</p><ul><li>优势：简单、方便</li><li>缺点：时效性差，缓存过期之前可能不一致</li><li>场景：更新频率较低，时效性要求低的业务</li></ul><p><strong>同步双写</strong>：在修改数据库的同时，直接修改缓存</p><ul><li>优势：时效性强，缓存与数据库强一致</li><li>缺点：有代码侵入，耦合度高；</li><li>场景：对一致性、时效性要求较高的缓存数据</li></ul><p><strong>异步通知：</strong>修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据</p><ul><li>优势：低耦合，可以同时通知多个缓存服务</li><li>缺点：时效性一般，可能存在中间不一致状态</li><li>场景：时效性要求一般，有多个服务需要同步</li></ul><h4 id="Canal"><a href="#Canal" class="headerlink" title="Canal"></a>Canal</h4><blockquote><p>canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费。GitHub的地址：<a href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p><p>Canal是基于<strong>mysql的主从同步</strong>来实现的</p><p>Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。</p></blockquote><h4 id="Canal安装"><a href="#Canal安装" class="headerlink" title="Canal安装"></a>Canal安装</h4><ul><li><p>1.先打开mysql主从</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 打开mysql容器挂载的日志文件/tmp/mysql/conf</span><br>vi /tmp/mysql/conf/my.cnf<br><br><span class="hljs-comment"># 添加内容(二进制日志记录的位置，记录的数据库)</span><br>log-bin=/var/lib/mysql/mysql-bin<br>binlog-do-db=heima<br></code></pre></td></tr></table></figure></li><li><p>1.1添加用于数据同步的用户</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> canal@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;canal&#x27;</span>;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">REPLICATION</span> SLAVE, <span class="hljs-keyword">REPLICATION</span> CLIENT,SUPER <span class="hljs-keyword">ON</span> *.* <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;canal&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;canal&#x27;</span>;<br>FLUSH <span class="hljs-keyword">PRIVILEGES</span>;<br></code></pre></td></tr></table></figure></li><li><p>1.2重启mysql容器</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker restart mysql<br><br><span class="hljs-comment">#查看是否成功开启</span><br>show master status;<br></code></pre></td></tr></table></figure></li><li><p>2.创建网络让mysql和canal能够通信</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 创建网络(名字加heima)</span><br>docker network create heima<br><span class="hljs-comment"># 将mysql容器添加到网络中</span><br>docker network connect heima mysql<br></code></pre></td></tr></table></figure></li><li><p>3.<a href="https://blog.csdn.net/qq_29116427/article/details/106498040">安装canal</a></p></li><li><p>4.创建Canal容器</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -p 11111:11111 --name canal \<br>-e canal.destinations=heima \<br>-e canal.instance.master.address=mysql:3306  \<br>-e canal.instance.dbUsername=canal  \<br>-e canal.instance.dbPassword=canal  \<br>-e canal.instance.connectionCharset=UTF-8 \<br>-e canal.instance.tsdb.enable=<span class="hljs-literal">true</span> \<br>-e canal.instance.gtidon=<span class="hljs-literal">false</span>  \<br>-e canal.instance.filter.regex=heima\\..* \<br>--network heima \<br>-d canal/canal-server:v1.1.5<br></code></pre></td></tr></table></figure><ul><li><code>-p 11111:11111</code>：这是canal的默认监听端口</li><li><code>-e canal.instance.master.address=mysql:3306</code>：数据库地址和端口，如果不知道mysql容器地址，可以通过<code>docker inspect 容器id</code>来查看</li><li><code>-e canal.instance.dbUsername=canal</code>：数据库用户名</li><li><code>-e canal.instance.dbPassword=canal</code> ：数据库密码</li><li><code>-e canal.instance.filter.regex=</code>：要监听的表名称</li></ul></li></ul><h4 id="使用Canal"><a href="#使用Canal" class="headerlink" title="使用Canal"></a>使用Canal</h4><blockquote><p>当Canal监听到binlog变化时，会通知Canal的客户端</p></blockquote><p>使用GitHub上的第三方开源的<a href="https://github.com/NormanGyllenhaal/canal-client">canal-starter</a>客户端来使用Canal</p><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>top.javatool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>canal-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.1-RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">canal:</span><br>  <span class="hljs-attr">destination:</span> <span class="hljs-string">heima</span>  <span class="hljs-comment">#canal集群名称</span><br>  <span class="hljs-attr">server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:11111</span> <span class="hljs-comment">#canal对应ip端口</span><br></code></pre></td></tr></table></figure></li><li><p>通过@Id、@Column、等注解完成Item与数据库表字段的映射</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.item.pojo;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@TableName(&quot;tb_item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> &#123;<br>    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<span class="hljs-comment">//商品id</span><br>    <span class="hljs-keyword">private</span> String name;<span class="hljs-comment">//商品名称</span><br>    <span class="hljs-keyword">private</span> String title;<span class="hljs-comment">//商品标题</span><br>    <span class="hljs-keyword">private</span> Long price;<span class="hljs-comment">//价格（分）</span><br>    <span class="hljs-keyword">private</span> String image;<span class="hljs-comment">//商品图片</span><br>    <span class="hljs-keyword">private</span> String category;<span class="hljs-comment">//分类名称</span><br>    <span class="hljs-keyword">private</span> String brand;<span class="hljs-comment">//品牌名称</span><br>    <span class="hljs-keyword">private</span> String spec;<span class="hljs-comment">//规格</span><br>    <span class="hljs-keyword">private</span> Integer status;<span class="hljs-comment">//商品状态 1-正常，2-下架</span><br>    <span class="hljs-keyword">private</span> Date createTime;<span class="hljs-comment">//创建时间</span><br>    <span class="hljs-keyword">private</span> Date updateTime;<span class="hljs-comment">//更新时间</span><br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-meta">@Transient</span><br>    <span class="hljs-keyword">private</span> Integer stock;<br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-meta">@Transient</span><br>    <span class="hljs-keyword">private</span> Integer sold;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 监听mysql变化，更新redis缓存和JVM缓存</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@CanalTable(&quot;tb_item&quot;)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntryHandler</span>&lt;Item&gt; &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisHandler redisHandler;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; cache;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Item item)</span> &#123;<br>        cache.put(item.getId(), item);<br><br>        redisHandler.saveItem(item);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Item before, Item after)</span> &#123;<br>        cache.put(after.getId(), after);<br><br>        redisHandler.saveItem(after);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Item item)</span> &#123;<br>        cache.invalidate(item.getId());<br>        redisHandler.deleteItemById(item.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>UML图</title>
    <link href="/2022/09/29/%E8%BD%AF%E8%80%83/UML%E5%9B%BE/"/>
    <url>/2022/09/29/%E8%BD%AF%E8%80%83/UML%E5%9B%BE/</url>
    
    <content type="html"><![CDATA[<h2 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h2><ul><li><p>类图</p><blockquote><p>展现了一组对象、接口、协作和它们之间的关系</p></blockquote></li><li><p>对象图</p><blockquote><p>展示某一时刻一组对象间的关系</p></blockquote></li><li><p>用例图</p><blockquote><p>展现了一组用例、参与者以及它们之间的关系</p><p>包含、扩展、泛化关系</p></blockquote><p><img src="/img/post_img/%E7%94%A8%E4%BE%8B%E5%9B%BE.png"></p></li><li><p>部署图</p><blockquote><p>描述了系统运行时进行处理的结点以及在结点上活动的构件的配置。强调了<strong>物理设备</strong>以及之间的连接关系。</p></blockquote><p><img src="/img/post_img/%E9%83%A8%E7%BD%B2%E5%9B%BE.png"></p></li><li><p>组件图</p><blockquote><p>构件图是用来表示系统中构件与构件之间，类或接口与构件之间的关系图。其中，构件图之间的关系表现为依赖关系，定义的类或接口与类之间的关系表现为依赖关系或实现关系</p></blockquote><p><img src="/img/post_img/%E7%BB%84%E4%BB%B6%E5%9B%BE.png"></p></li><li><p>状态图</p><blockquote><p>由状态、变迁、事件和活动组成的状态机，用来描述类的对象所有可能的状态以及时间发生时状态的转移条件。</p></blockquote><p><img src="/img/post_img/%E7%8A%B6%E6%80%81%E5%9B%BE.png"></p></li><li><p>活动图</p><blockquote><p>状态图的一种特殊情况，这些状态大都处于活动状态。本质是一种流程图，它描述了活动到活动的控制流。</p></blockquote><p><img src="/img/post_img/%E6%B4%BB%E5%8A%A8%E5%9B%BE.png"></p></li><li><p>时序图</p><p><img src="/img/post_img/%E6%97%B6%E5%BA%8F%E5%9B%BE.png"></p></li><li><p>协作图</p><p><img src="/img/post_img/%E5%8D%8F%E4%BD%9C%E5%9B%BE.png"></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>软考</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式缓存</title>
    <link href="/2022/09/25/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/"/>
    <url>/2022/09/25/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98/</url>
    
    <content type="html"><![CDATA[<h2 id="分布式缓存"><a href="#分布式缓存" class="headerlink" title="分布式缓存"></a>分布式缓存</h2><blockquote><p>redis版本6.2.4</p></blockquote><h3 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h3><blockquote><p>RDB (Redis Database Backup file) Redis数据备份文件</p><p>AOF (Append Only File) 追加文件 </p></blockquote><p>RDB持久化在四种情况下会执行：</p><ul><li>执行save命令：同步保存，会导致其他命令被阻塞</li><li>执行bgsave命令：background save 异步保存，不会影响主进程</li><li>Redis停机时：自动执行save命令</li><li>触发RDB条件时</li></ul><p> AOF原理</p><ul><li>Redis处理的每一个写命令都会记录在AOF文件，可以看做是命令日志文件，记录的是步骤</li></ul><h4 id="设置RDB触发条件"><a href="#设置RDB触发条件" class="headerlink" title="设置RDB触发条件"></a>设置RDB触发条件</h4><ul><li><p>修改redis目录下的redis.conf文件</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save &quot;&quot; 则表示禁用RDB</span><br><span class="hljs-attribute">save</span> <span class="hljs-number">900</span> <span class="hljs-number">1</span>  <br><span class="hljs-attribute">save</span> <span class="hljs-number">300</span> <span class="hljs-number">10</span>  <br><span class="hljs-attribute">save</span> <span class="hljs-number">60</span> <span class="hljs-number">10000</span> <br><br><span class="hljs-comment"># 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱</span><br><span class="hljs-attribute">rdbcompression</span> yes<br><br><span class="hljs-comment"># RDB文件名称</span><br><span class="hljs-attribute">dbfilename</span> dump.rdb  <br><br><span class="hljs-comment"># 文件保存的路径目录</span><br><span class="hljs-attribute">dir</span> ./ <br></code></pre></td></tr></table></figure></li></ul><h4 id="设置AOF"><a href="#设置AOF" class="headerlink" title="设置AOF"></a>设置AOF</h4><ul><li><p>开启AOF</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs livescript"><span class="hljs-comment">#修改配置文件</span><br>appendonly <span class="hljs-literal">no</span>--&gt;   appendonly <span class="hljs-literal">yes</span><br><br><span class="hljs-comment">#AOF文件名</span><br>appendfilename <span class="hljs-string">&quot;appendonly.aof&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>设置记录频率</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># always: 每执行一次写命令，立即记录到AOF文件</span><br><span class="hljs-comment"># every sync: 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案</span><br><span class="hljs-comment"># no: 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span><br><br><span class="hljs-comment"># appendfsync always</span><br><span class="hljs-attribute">appendfsync</span> everysec<br><span class="hljs-comment"># appendfsync no</span><br></code></pre></td></tr></table></figure></li></ul><blockquote><p>因为是记录命令，AOF文件会比RDB文件大的多，故需要重写AOF文件来压缩体积</p></blockquote><ul><li><p>设置重写触发条件</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># AOF文件比上次文件 增长超过多少百分比则触发重写</span><br><span class="hljs-attribute">auto</span>-aof-rewrite-percentage <span class="hljs-number">100</span><br><span class="hljs-comment"># AOF文件体积最小多大以上才触发重写 </span><br><span class="hljs-attribute">auto</span>-aof-rewrite-min-size <span class="hljs-number">64</span>mb <br></code></pre></td></tr></table></figure></li></ul><h4 id="RDB和AOF比较"><a href="#RDB和AOF比较" class="headerlink" title="RDB和AOF比较"></a>RDB和AOF比较</h4><p><img src="/img/weifuwu_img/RDB%E5%92%8CAOF%E6%AF%94%E8%BE%83.png" alt="RDB和AOF比较"></p><h3 id="Redis主从节点"><a href="#Redis主从节点" class="headerlink" title="Redis主从节点"></a>Redis主从节点</h3><h4 id="配置主从节点"><a href="#配置主从节点" class="headerlink" title="配置主从节点"></a>配置主从节点</h4><ul><li><p>准备实例和配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 复制三份redis.conf配置文件到不同的文件夹下</span><br><span class="hljs-built_in">cp</span> redis-4.0.0/redis.conf 7001<br><span class="hljs-built_in">cp</span> redis-4.0.0/redis.conf 7002<br><span class="hljs-built_in">cp</span> redis-4.0.0/redis.conf 7003<br></code></pre></td></tr></table></figure><p><img src="/img/weifuwu_img/redis%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png" alt="复制配置文件"></p></li><li><p>修改端口和工作目录</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sed -i -e <span class="hljs-string">&#x27;s/6379/7001/g&#x27;</span> -e <span class="hljs-string">&#x27;s/dir .\//dir \/home\/cyx\/redis\/7001\//g&#x27;</span> 7001/redis.conf<br>sed -i -e <span class="hljs-string">&#x27;s/6379/7002/g&#x27;</span> -e <span class="hljs-string">&#x27;s/dir .\//dir \/home\/cyx\/redis\/7002\//g&#x27;</span> 7002/redis.conf<br>sed -i -e <span class="hljs-string">&#x27;s/6379/7003/g&#x27;</span> -e <span class="hljs-string">&#x27;s/dir .\//dir \/home\/cyx\/redis\/7003\//g&#x27;</span> 7003/redis.conf<br></code></pre></td></tr></table></figure></li><li><p>修改每个实例的声明IP</p><blockquote><p>虚拟机本身有多个IP，为了避免将来混乱，我们需要在redis.conf文件中指定每一个实例的绑定ip信息，</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">sed -i <span class="hljs-string">&#x27;1a slave-announce-ip 192.168.229.128&#x27;</span> 7001/redis.conf<br>sed -i <span class="hljs-string">&#x27;1a slave-announce-ip 192.168.229.128&#x27;</span> 7002/redis.conf<br>sed -i <span class="hljs-string">&#x27;1a slave-announce-ip 192.168.229.128&#x27;</span> 7003/redis.conf<br></code></pre></td></tr></table></figure></li><li><p>启动服务端</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 分别启动三个服务端</span><br>[root@root src]<span class="hljs-comment"># ./redis-server ../../7001/redis.conf</span><br><br>[root@root src]<span class="hljs-comment"># ./redis-server ../../7002/redis.conf</span><br><br>[root@root src]<span class="hljs-comment"># ./redis-server ../../7003/redis.conf</span><br></code></pre></td></tr></table></figure></li><li><p>客户端连接</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># -p选择端口</span><br>redis-cli -p 7001<br></code></pre></td></tr></table></figure></li><li><p>配置主从节点</p><blockquote><p>有临时和永久两种模式：</p><ul><li><p>修改配置文件（永久生效）</p><ul><li>在redis.conf中添加一行配置：<code>slaveof &lt;masterip&gt; &lt;masterport&gt;</code></li></ul></li><li><p>使用redis-cli客户端连接到redis服务，执行slaveof命令（重启后失效）</p></li></ul></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 连接 7002</span><br>redis-cli -p 7002<br><span class="hljs-comment"># 执行slaveof</span><br>slaveof 192.168.229.128 7001<br><br><span class="hljs-comment"># 连接 7003</span><br>redis-cli -p 7003<br><span class="hljs-comment"># 执行slaveof</span><br>slaveof 192.168.229.128 7001<br></code></pre></td></tr></table></figure></li><li><p>测试</p><blockquote><p>通过7001端口的主节点写入数据，在从节点也能读得到</p></blockquote></li></ul><h4 id="主从同步流程"><a href="#主从同步流程" class="headerlink" title="主从同步流程"></a>主从同步流程</h4><p><img src="/img/weifuwu_img/%E4%B8%BB%E4%BB%8E%E5%90%8C%E6%AD%A5%E6%B5%81%E7%A8%8B.png" alt="主从同步流程.png"></p><p>概念</p><blockquote><ul><li><strong>Replication Id</strong>：简称replid，是数据集的标记，id一致则说明是同一数据集。每一个master都有唯一的replid，slave则会继承master节点的replid</li><li><strong>offset</strong>：偏移量，随着记录在repl_baklog中的数据增多而逐渐增大。slave完成同步时也会记录当前同步的offset。如果slave的offset小于master的offset，说明slave数据落后于master，需要更新。</li></ul><p>因此slave做数据同步，必须向master声明自己的replication id 和offset，master才可以判断到底需要同步哪些数据。</p></blockquote><p>完整流程描述：</p><ul><li>slave节点请求增量同步</li><li>master节点判断replid，发现不一致，拒绝增量同步</li><li>master将完整内存数据生成RDB，发送RDB到slave</li><li>slave清空本地数据，加载master的RDB</li><li>master将RDB期间的命令记录在repl_baklog，并持续将log中的命令发送给slave</li><li>slave执行接收到的命令，保持与master之间的同步</li></ul><h3 id="Redis哨兵"><a href="#Redis哨兵" class="headerlink" title="Redis哨兵"></a>Redis哨兵</h3><blockquote><p>Redis提供了哨兵（Sentinel）机制来实现主从集群的自动故障恢复。</p></blockquote><h4 id="哨兵作用"><a href="#哨兵作用" class="headerlink" title="哨兵作用"></a>哨兵作用</h4><p><img src="/img/weifuwu_img/Redis%E5%93%A8%E5%85%B5.png" alt="Redis哨兵"></p><p>哨兵的作用如下：</p><ul><li><strong>监控</strong>：Sentinel 会不断检查您的master和slave是否按预期工作</li><li><strong>自动故障恢复</strong>：如果master故障，Sentinel会将一个slave提升为master。当故障实例恢复后也以新的master为主</li><li><strong>通知</strong>：Sentinel充当Redis客户端的服务发现来源，当集群发生故障转移时，会将最新信息推送给Redis的客户端</li></ul><p>Sentinel如何判断一个redis实例是否健康</p><ul><li>每隔1秒发送一次ping命令，如果超过一定时间没有相向则认为是主观下线</li><li>如果大多数sentinel都认为实例主观下线，则判定服务下线</li></ul><p>故障转移步骤有哪些？</p><ul><li>首先选定一个slave作为新的master，执行slaveof no one</li><li>然后让所有节点都执行slaveof 新master</li><li>修改故障节点配置，添加slaveof 新master</li></ul><h4 id="配置哨兵节点"><a href="#配置哨兵节点" class="headerlink" title="配置哨兵节点"></a>配置哨兵节点</h4><ul><li><p>准备实例和配置</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># 创建三个文件夹，存放sentinel的配置文件</span><br></code></pre></td></tr></table></figure><p><img src="/img/weifuwu_img/Redis%E5%93%A8%E5%85%B5%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png"></p></li><li><p>每个目录下创建一个sentinel.conf文件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">port 27001<br>sentinel announce-ip 192.168.229.128<br>sentinel monitor mymaster 192.168.229.128 7001 2<br>sentinel down-after-milliseconds mymaster 5000<br>sentinel failover-timeout mymaster 60000<br><span class="hljs-built_in">dir</span> <span class="hljs-string">&quot;/home/cyx/redis/sentinel1&quot;</span><br></code></pre></td></tr></table></figure><p>解读：</p><ul><li><code>port 27001</code>：是当前sentinel实例的端口</li><li><code>sentinel monitor mymaster 192.168.150.101 7001 2</code>：指定主节点信息<ul><li><code>mymaster</code>：主节点名称，自定义，任意写</li><li><code>192.168.150.101 7001</code>：主节点的ip和端口</li><li><code>2</code>：选举master时的quorum值</li></ul></li></ul></li><li><p>修改每个配置文件的端口<code>port XXX</code></p></li><li><p>启动</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 第1个</span><br>.<span class="hljs-regexp">/redis-sentinel ../</span>..<span class="hljs-regexp">/sentinel1/</span>sentinel.conf<br><span class="hljs-comment"># 第2个</span><br>.<span class="hljs-regexp">/redis-sentinel ../</span>..<span class="hljs-regexp">/sentinel2/</span>sentinel.conf<br><span class="hljs-comment"># 第3个</span><br>.<span class="hljs-regexp">/redis-sentinel ../</span>..<span class="hljs-regexp">/sentinel3/</span>sentinel.conf<br></code></pre></td></tr></table></figure></li><li><p>出现无法故障转移的时候，试试把从节点的slaveof 改成 slaveof 127.0.0.1 主节点端口</p></li></ul><h4 id="RedisTemplate"><a href="#RedisTemplate" class="headerlink" title="RedisTemplate"></a>RedisTemplate</h4><p><strong>导入坐标</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>配置Redis地址</strong></p><p>然后在配置文件application.yml中指定redis的sentinel相关信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  redis:<br>    sentinel:<br>      master: mymaster<br>      nodes:<br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27001</span><br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27002</span><br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27003</span><br></code></pre></td></tr></table></figure><p><strong>配置读写分离</strong></p><p>在项目的启动类中，添加一个新的bean：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="hljs-title function_">clientConfigurationBuilderCustomizer</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);<br>&#125;<br></code></pre></td></tr></table></figure><p>这个bean中配置的就是读写策略，包括四种：</p><ul><li>MASTER：从主节点读取</li><li>MASTER_PREFERRED：优先从master节点读取，master不可用才读取replica</li><li>REPLICA：从slave（replica）节点读取</li><li>REPLICA _PREFERRED：优先从slave（replica）节点读取，所有的slave都不可用才读取master</li></ul><h3 id="Redis分片集群"><a href="#Redis分片集群" class="headerlink" title="Redis分片集群"></a>Redis分片集群</h3><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>分片集群特点</p><ul><li><p>集群中有多个master，每个master保存不同数据</p></li><li><p>每个master都可以有多个slave节点</p></li><li><p>master之间通过ping监测彼此健康状态</p></li><li><p>客户端请求可以访问集群任意节点，最终都会被转发到正确节点</p></li></ul><p>散列插槽</p><p>0~16383共16384个插槽会被分配到master节点上，</p><p>数据key不是与节点绑定，而是与插槽绑定，redis会根据key的有效部分计算插槽值</p><ul><li>key中包含”{}”，且“{}”中至少包含1个字符，“{}”中的部分是有效部分，可以通过{}来将同一类数据存储到同一个Redis实例中</li><li>key中不包含“{}”，整个key都是有效部分</li></ul><h4 id="配置分片集群实例"><a href="#配置分片集群实例" class="headerlink" title="配置分片集群实例"></a>配置分片集群实例</h4><h5 id="准备实例和配置"><a href="#准备实例和配置" class="headerlink" title="准备实例和配置"></a>准备实例和配置</h5><ul><li><p>准备实例和配置</p><table><thead><tr><th align="center">IP</th><th align="center">PORT</th><th align="center">角色</th></tr></thead><tbody><tr><td align="center">192.168.229.128</td><td align="center">7001</td><td align="center">master</td></tr><tr><td align="center">192.168.229.128</td><td align="center">7002</td><td align="center">master</td></tr><tr><td align="center">192.168.229.128</td><td align="center">7003</td><td align="center">master</td></tr><tr><td align="center">192.168.229.128</td><td align="center">8001</td><td align="center">slave</td></tr><tr><td align="center">192.168.229.128</td><td align="center">8002</td><td align="center">slave</td></tr><tr><td align="center">192.168.229.128</td><td align="center">8003</td><td align="center">slave</td></tr></tbody></table></li><li><p>创建配置文件redis.conf</p><p><img src="/img/weifuwu_img/redis%E5%88%86%E7%89%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6.png"></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs sh">port 6379<br><span class="hljs-comment"># 开启集群功能</span><br>cluster-enabled <span class="hljs-built_in">yes</span><br><span class="hljs-comment"># 集群的配置文件名称，不需要我们创建，由redis自己维护</span><br>cluster-config-file /home/cyx/redis/6379/nodes.conf<br><span class="hljs-comment"># 节点心跳失败的超时时间</span><br>cluster-node-timeout 5000<br><span class="hljs-comment"># 持久化文件存放目录</span><br><span class="hljs-built_in">dir</span> /home/cyx/redis/6379<br><span class="hljs-comment"># 绑定地址</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br><span class="hljs-comment"># 让redis后台运行</span><br>daemonize <span class="hljs-built_in">yes</span><br><span class="hljs-comment"># 注册的实例ip</span><br>replica-announce-ip 192.168.229.128<br><span class="hljs-comment"># 保护模式</span><br>protected-mode no<br><span class="hljs-comment"># 数据库数量</span><br>databases 1<br><span class="hljs-comment"># 日志</span><br>logfile /home/cyx/redis/6379/run.log<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 执行拷贝</span><br><span class="hljs-attribute">echo</span> <span class="hljs-number">7001</span> <span class="hljs-number">7002</span> <span class="hljs-number">7003</span> <span class="hljs-number">8001</span> <span class="hljs-number">8002</span> <span class="hljs-number">8003</span> | xargs -t -n <span class="hljs-number">1</span> cp redis.conf<br></code></pre></td></tr></table></figure></li><li><p>修改配置文件,将其中的6379修改为与所在目录一致</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 同时修改配置文件</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t sed -i <span class="hljs-string">&#x27;s/6379/&#123;&#125;/g&#x27;</span> &#123;&#125;/redis.conf<br></code></pre></td></tr></table></figure></li><li><p>启动&#x2F;关闭</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#同时启动所有redis</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t redis-server &#123;&#125;/redis.conf<br><br><span class="hljs-comment">#查看redis进程</span><br>ps -ef | grep redis<br><br><span class="hljs-comment">#关闭所有redis进程</span><br><span class="hljs-built_in">printf</span> <span class="hljs-string">&#x27;%s\n&#x27;</span> 7001 7002 7003 8001 8002 8003 | xargs -I&#123;&#125; -t redis-cli -p &#123;&#125; shutdown<br></code></pre></td></tr></table></figure></li></ul><h5 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h5><ul><li><p>集群管理以及集成到了redis-cli中</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli --cluster create --cluster-replicas 1 192.168.229.128:7001 192.168.229.128:7002 192.168.229.128:7003 192.168.229.128:8001 192.168.229.128:8002 192.168.229.128:8003<br></code></pre></td></tr></table></figure><p>命令说明：</p><ul><li><code>redis-cli --cluster</code>或者<code>./redis-trib.rb</code>：代表集群操作命令</li><li><code>create</code>：代表是创建集群</li><li><code>--replicas 1</code>或者<code>--cluster-replicas 1</code> ：指定集群中每个master的副本个数为1，此时<code>节点总数 ÷ (replicas + 1)</code> 得到的就是master的数量。因此节点列表中的前n个就是master，其它节点都是slave节点，随机分配到不同master</li></ul></li><li><p>查看集群状态</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli -p 7001 cluster nodes<br></code></pre></td></tr></table></figure></li></ul><h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5><ul><li><p>添加数据</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 打开客户端，-c代表集群操作</span><br>redis-cli -c -p 7001<br><span class="hljs-comment"># 之后就可以CRUD了，redis根据key算出的hash值存到对应插槽中</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="操作集群"><a href="#操作集群" class="headerlink" title="操作集群"></a>操作集群</h5><ul><li><p>查看帮助文档</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli --cluster <span class="hljs-built_in">help</span><br></code></pre></td></tr></table></figure></li></ul><p><img src="/img/weifuwu_img/Redis%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C.png"></p><ul><li><p>添加节点到集群(add-node)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 添加的节点是没有插槽的</span><br>redis-cli --cluster add-node 要添加的节点ip:端口 一个maser节点的ip:端口<br></code></pre></td></tr></table></figure></li><li><p>转移插槽(reshard)</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli --cluster reshard 要分配插槽的Redis实例的ip:端口<br><span class="hljs-comment"># 之后会让输入要分配的插槽数量、从哪个节点移动插槽、跟着提示来就行</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><h5 id="自动故障转移"><a href="#自动故障转移" class="headerlink" title="自动故障转移"></a>自动故障转移</h5><blockquote><p>出现宕机的节点时，自动提升一个slave为新的master</p><p>宕机的节点重新上线时，会变成slave节点</p></blockquote><h5 id="手动故障转移"><a href="#手动故障转移" class="headerlink" title="手动故障转移"></a>手动故障转移</h5><blockquote><p>进入节点的客户端，执行cluster failover命令，这个节点就会称为master节点</p></blockquote><h4 id="RedisTemplate访问集群"><a href="#RedisTemplate访问集群" class="headerlink" title="RedisTemplate访问集群"></a>RedisTemplate访问集群</h4><p> 和哨兵模式差不多</p><ul><li>引入redis的starter依赖</li><li>配置分片集群地址 (就这步有差异)</li><li>配置读写分离</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">cluster:</span><br>      <span class="hljs-attr">nodes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:7001</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:7002</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:7003</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:8001</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:8002</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><span class="hljs-string">:8003</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式事务</title>
    <link href="/2022/09/20/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"/>
    <url>/2022/09/20/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><h3 id="概念、理论"><a href="#概念、理论" class="headerlink" title="概念、理论"></a>概念、理论</h3><h4 id="本地事务的四大特性"><a href="#本地事务的四大特性" class="headerlink" title="本地事务的四大特性"></a><strong>本地事务</strong>的四大特性</h4><ul><li>原子性（Atomicity）</li><li>一致性（Consistency）</li><li>隔离性（Isolation）</li><li>持久性（Durability）</li></ul><p><img src="/img/weifuwu_img/%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E7%89%B9%E6%80%A7.png" alt="本地事务特性"></p><h4 id="分布式事务-1"><a href="#分布式事务-1" class="headerlink" title="分布式事务"></a><strong>分布式事务</strong></h4><blockquote><p>指不是在单个服务或单个数据库架构下，产生的事务</p></blockquote><h4 id="CAP理论"><a href="#CAP理论" class="headerlink" title="CAP理论"></a><strong>CAP理论</strong></h4><blockquote><p>在P一定会出现的情况下，A和C之间只能实现一个</p></blockquote><ul><li><p>Consistency（一致性）</p><blockquote><p>用户访问分布式系统中的任意节点，得到的数据必须一致。</p></blockquote></li><li><p>Availability（可用性）</p><blockquote><p>用户访问集群中的任意健康节点，必须能得到响应</p></blockquote></li><li><p>Partition tolerance （分区容错性）</p><blockquote><p>为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区</p><p>在集群出现分区时，整个系统也要持续对外提供服务</p></blockquote></li></ul><h4 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h4><blockquote><p>是对CAP的一种解决思路</p></blockquote><ul><li><strong>Basically Available</strong> <strong>（基本可用）</strong>：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。</li><li><strong>Soft State（软状态）：</strong>在一定时间内，允许出现中间状态，比如临时的不一致状态。</li><li><strong>Eventually Consistent（最终一致性）</strong>：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。</li></ul><h4 id="事务协调者"><a href="#事务协调者" class="headerlink" title="事务协调者"></a>事务协调者</h4><p><img src="/img/weifuwu_img/%E4%BA%8B%E5%8A%A1%E5%8D%8F%E8%B0%83%E8%80%85.png" alt="事务协调者"></p><h3 id="Seate"><a href="#Seate" class="headerlink" title="Seate"></a>Seate</h3><blockquote><p>Seata 是一款开源的分布式事务解决方案</p></blockquote><p><a href="http://seata.io/">官网</a></p><p><img src="/img/weifuwu_img/Seata%E6%9E%B6%E6%9E%84.png" alt="Seata架构"></p><ul><li><p><strong>TC (Transaction Coordinator) -</strong> <strong>事务协调者：</strong>维护全局和分支事务的状态，协调全局事务提交或回滚。</p></li><li><p><strong>TM (Transaction Manager) -</strong> <strong>事务管理器：</strong>定义全局事务的范围、开始全局事务、提交或回滚全局事务。</p></li><li><p><strong>RM (Resource Manager) -</strong> <strong>资源管理器：</strong>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p></li></ul><h4 id="部署TC"><a href="#部署TC" class="headerlink" title="部署TC"></a>部署TC</h4><blockquote><p>**TC (Transaction Coordinator) -**事务协调者</p></blockquote><ol><li><p>下载seata-server包并解压<a href="http://seata.io/zh-cn/blog/download.html">http</a><a href="http://seata.io/zh-cn/blog/download.html">:&#x2F;&#x2F;seata.io&#x2F;zh-cn&#x2F;blog&#x2F;download</a><a href="http://seata.io/zh-cn/blog/download.html">.</a><a href="http://seata.io/zh-cn/blog/download.html">html</a> </p></li><li><p>修改registry.conf配置文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs conf">registry &#123;<br>  # tc服务的注册中心类file 、nacos 、eureka、redis、zk、consul、etcd3、sofa<br>  type = &quot;nacos&quot;<br><br>  nacos &#123;<br># seata tc 服务注册到 nacos的服务名称，可以自定义<br>    application = &quot;seata-tc-server&quot;<br>    serverAddr = &quot;127.0.0.1:8848&quot;<br>    group = &quot;DEFAULT_GROUP&quot;<br>    namespace = &quot;&quot;<br># 集群名<br>    cluster = &quot;default&quot;<br>    username = &quot;nacos&quot;<br>    password = &quot;nacos&quot;<br>  &#125;<br>  <br>&#125;<br><br>config &#123;<br>  # 读取tc服务端的配置文件的方式，这里是从nacos配置中心读取，这样如果tc是集群，可以共享配置<br>  # file、nacos 、apollo、zk、consul、etcd3<br>  type = &quot;nacos&quot;<br><br>  nacos &#123;<br>    serverAddr = &quot;127.0.0.1:8848&quot;<br>    namespace = &quot;&quot;<br>    group = &quot;SEATA_GROUP&quot;<br>    username = &quot;nacos&quot;<br>    password = &quot;nacos&quot;<br>    dataId = &quot;seataServer.properties&quot;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>nacos添加配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 数据存储方式，db代表数据库</span><br><span class="hljs-attr">store.mode</span>=<span class="hljs-string">db</span><br><span class="hljs-attr">store.db.datasource</span>=<span class="hljs-string">druid</span><br><span class="hljs-attr">store.db.dbType</span>=<span class="hljs-string">mysql</span><br><span class="hljs-attr">store.db.driverClassName</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">store.db.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true&amp;serverTimezone=UTC</span><br><span class="hljs-attr">store.db.user</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">store.db.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-attr">store.db.minConn</span>=<span class="hljs-string">5</span><br><span class="hljs-attr">store.db.maxConn</span>=<span class="hljs-string">30</span><br><span class="hljs-attr">store.db.globalTable</span>=<span class="hljs-string">global_table</span><br><span class="hljs-attr">store.db.branchTable</span>=<span class="hljs-string">branch_table</span><br><span class="hljs-attr">store.db.queryLimit</span>=<span class="hljs-string">100</span><br><span class="hljs-attr">store.db.lockTable</span>=<span class="hljs-string">lock_table</span><br><span class="hljs-attr">store.db.maxWait</span>=<span class="hljs-string">5000</span><br><span class="hljs-comment"># 事务、日志等配置</span><br><span class="hljs-attr">server.recovery.committingRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.recovery.asynCommittingRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.recovery.rollbackingRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.recovery.timeoutRetryPeriod</span>=<span class="hljs-string">1000</span><br><span class="hljs-attr">server.maxCommitRetryTimeout</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">server.maxRollbackRetryTimeout</span>=<span class="hljs-string">-1</span><br><span class="hljs-attr">server.rollbackRetryTimeoutUnlockEnable</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">server.undo.logSaveDays</span>=<span class="hljs-string">7</span><br><span class="hljs-attr">server.undo.logDeletePeriod</span>=<span class="hljs-string">86400000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 客户端与服务端传输方式</span><br><span class="hljs-attr">transport.serialization</span>=<span class="hljs-string">seata</span><br><span class="hljs-attr">transport.compressor</span>=<span class="hljs-string">none</span><br><span class="hljs-comment"># 关闭metrics功能，提高性能</span><br><span class="hljs-attr">metrics.enabled</span>=<span class="hljs-string">false</span><br><span class="hljs-attr">metrics.registryType</span>=<span class="hljs-string">compact</span><br><span class="hljs-attr">metrics.exporterList</span>=<span class="hljs-string">prometheus</span><br><span class="hljs-attr">metrics.exporterPrometheusPort</span>=<span class="hljs-string">9898</span><br></code></pre></td></tr></table></figure></li><li><p>创建数据库seata，tc服务在管理分布式事务时，需要记录事务相关数据到数据库中，需要提前创建好这些表</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs sql"><br><span class="hljs-keyword">SET</span> NAMES utf8mb4;<br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- 分支事务表</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `branch_table`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `branch_table`  (<br>  `branch_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `xid` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `transaction_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `resource_group_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `resource_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `branch_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">8</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `status` TINYINT(<span class="hljs-number">4</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `client_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `application_data` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">2000</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `gmt_create` DATETIME(<span class="hljs-number">6</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `gmt_modified` DATETIME(<span class="hljs-number">6</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`branch_id`) <span class="hljs-keyword">USING</span> BTREE,<br>  INDEX `idx_xid`(`xid`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> INNODB <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_general_ci ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-comment">-- 全局事务表</span><br><span class="hljs-comment">-- ----------------------------</span><br><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `global_table`;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `global_table`  (<br>  `xid` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `transaction_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `status` TINYINT(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `application_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `transaction_service_group` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `transaction_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `timeout` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `begin_time` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `application_data` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">2000</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `gmt_create` DATETIME <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `gmt_modified` DATETIME <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`xid`) <span class="hljs-keyword">USING</span> BTREE,<br>  INDEX `idx_gmt_modified_status`(`gmt_modified`, `status`) <span class="hljs-keyword">USING</span> BTREE,<br>  INDEX `idx_transaction_id`(`transaction_id`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> INNODB <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_general_ci ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br><br><span class="hljs-keyword">SET</span> FOREIGN_KEY_CHECKS <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure></li><li><p>seata的bin目录下执行seata-server.bat来启动TC</p></li></ol><h4 id="微服务集成Seata"><a href="#微服务集成Seata" class="headerlink" title="微服务集成Seata"></a>微服务集成Seata</h4><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--seata--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--版本较低，1.3.0，因此排除--&gt;</span> <br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--seata starter 采用1.4.2版本--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;seata.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置tc地址</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">registry:</span> <span class="hljs-comment"># TC服务注册中心的配置，微服务根据这些信息去注册中心获取tc服务地址</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span> <span class="hljs-comment"># 注册中心类型 nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># nacos地址</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># namespace，默认为空</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span> <span class="hljs-comment"># 分组，默认是DEFAULT_GROUP</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-tc-server</span> <span class="hljs-comment"># seata服务名称</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">seata-demo</span> <span class="hljs-comment"># 事务组名称</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">vgroup-mapping:</span> <span class="hljs-comment"># 事务组与cluster的映射关系</span><br>      <span class="hljs-attr">seata-demo:</span> <span class="hljs-string">default</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="Seata的分布式事务解决方案"><a href="#Seata的分布式事务解决方案" class="headerlink" title="Seata的分布式事务解决方案"></a>Seata的分布式事务解决方案</h4><p>Seata提供了四种不同的分布式事务解决方案：</p><ul><li><p>XA模式：<strong>强一致性</strong>分阶段事务模式，牺牲了一定的可用性，无业务侵入</p><blockquote><p>事务协调者通知每个事物参与者执行本地事务，只有事务都成功了才提交</p><p>优点：实现简单，并且没有代码侵入</p><p>缺点：性能较差</p></blockquote></li><li><p>TCC模式：最终一致的分阶段事务模式，有业务侵入</p><blockquote><ul><li>Try：资源的检测和<strong>预留</strong>； </li><li>Confirm：完成资源操作业务；要求 Try 成功 Confirm 一定要能成功。</li><li>Cancel：预留资源释放，可以理解为try的反向操作。</li></ul><p>优点：无需生成快照，无需使用全局锁，性能最强</p><p>缺点：<strong>有代码侵入</strong>，需要人为编写try、Confirm和Cancel接口，存在软状态</p></blockquote></li><li><p>AT模式：<strong>最终一致</strong>的分阶段事务模式，无业务侵入，也是Seata的默认模式</p><blockquote><p>完成事务直接提交，通过记录undo-log（数据快照）实现事务回滚，解决XA性能差的问题</p><p>优点：性能好，并且没有代码侵入</p><p>缺点：AT在一阶段和二阶段之间为软状态</p></blockquote></li><li><p>SAGA模式：长事务模式，有业务侵入</p></li></ul><h5 id="实现XA模式"><a href="#实现XA模式" class="headerlink" title="实现XA模式"></a><strong>实现XA模式</strong></h5><ul><li><p>配置开启XA模式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">XA</span><br></code></pre></td></tr></table></figure></li><li><p>给发起全局事务的入口方法添加@GlobalTransactional注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//实例</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@GlobalTransactional</span><br><span class="hljs-keyword">public</span> Long <span class="hljs-title function_">create</span><span class="hljs-params">(Order order)</span> &#123;<br>    <span class="hljs-comment">// 创建订单</span><br>    orderMapper.insert(order);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 扣用户余额</span><br>        accountClient.deduct(order.getUserId(), order.getMoney());<br>        <span class="hljs-comment">// 扣库存</span><br>        storageClient.deduct(order.getCommodityCode(), order.getCount());<br><br>    &#125; <span class="hljs-keyword">catch</span> (FeignException e) &#123;<br>        log.error(<span class="hljs-string">&quot;下单失败，原因:&#123;&#125;&quot;</span>, e.contentUTF8(), e);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e.contentUTF8(), e);<br>    &#125;<br>    <span class="hljs-keyword">return</span> order.getId();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>重启服务。 只有所有事务都成功，TC才会通知微服务提交事务</p><h4 id=""><a href="#" class="headerlink" title=""></a></h4></li></ul><h5 id="实现AT模式"><a href="#实现AT模式" class="headerlink" title="实现AT模式"></a>实现AT模式</h5><ul><li><p>创建两张数据库表，记录全局锁，其中lock_table导入到TC服务关联的数据库，undo_log表导入到微服务关联的数据库</p></li><li><p>配置开启AT模式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">data-source-proxy-mode:</span> <span class="hljs-string">AT</span><br></code></pre></td></tr></table></figure></li><li><p>给发起全局事务的入口方法添加@GlobalTransactional注解</p></li><li><p>重启服务</p></li></ul><h5 id="实现TCC模式"><a href="#实现TCC模式" class="headerlink" title="实现TCC模式"></a>实现TCC模式</h5><p>概念：</p><ul><li>空回滚：在未执行try操作时先执行了cancel操作</li><li>业务悬挂：对于已经空回滚的业务，之前被阻塞的try操作恢复，继续执行try，就永远不可能confirm或cancel ，事务一直处于中间状态</li></ul><p>实例：</p><ul><li><p>创建表,用于存储回滚时需要恢复的数据</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sql">REATE <span class="hljs-keyword">TABLE</span> `account_freeze_tbl`  (<br>  `xid` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `user_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8 <span class="hljs-keyword">COLLATE</span> utf8_general_ci <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `freeze_money` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) UNSIGNED <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,<br>  `state` <span class="hljs-type">INT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;事务状态，0:try，1:confirm，2:cancel&#x27;</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`xid`) <span class="hljs-keyword">USING</span> BTREE<br>) ENGINE <span class="hljs-operator">=</span> INNODB <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8_general_ci ROW_FORMAT <span class="hljs-operator">=</span> COMPACT;<br></code></pre></td></tr></table></figure><ul><li>xid：是全局事务id</li><li>freeze_money：用来记录用户冻结金额</li><li>state：用来记录事务状态</li></ul></li><li><p>声明TCC接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.account.service;<br><br><span class="hljs-comment">//声明为TCC事务</span><br><span class="hljs-meta">@LocalTCC</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountTCCService</span> &#123;<br><br>    <span class="hljs-comment">//Try</span><br>    <span class="hljs-meta">@TwoPhaseBusinessAction(name = &quot;deduct&quot;, commitMethod = &quot;confirm&quot;, rollbackMethod = &quot;cancel&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">(<span class="hljs-meta">@BusinessActionContextParameter(paramName = &quot;userId&quot;)</span> String userId,</span><br><span class="hljs-params">                <span class="hljs-meta">@BusinessActionContextParameter(paramName = &quot;money&quot;)</span> <span class="hljs-type">int</span> money)</span>;<br><br>    <span class="hljs-comment">//Confirm</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext ctx)</span>;<br><br>    <span class="hljs-comment">//Cancel</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext ctx)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>实现TCC接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.account.service.impl;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountTccServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountTCCService</span> &#123;<br><br>    <span class="hljs-comment">//记录事务状态</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AccountFreezeMapper accountFreezeMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> AccountMapper accountMapper;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">(String userId, <span class="hljs-type">int</span> money)</span> &#123;<br>        <span class="hljs-comment">//获取事务id</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> RootContext.getXID();<br>        <span class="hljs-comment">//是否业务悬挂</span><br>        <span class="hljs-keyword">if</span> (accountFreezeMapper.selectById(xid) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//证明业务已经执行过一次</span><br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//执行业务操作</span><br>        accountMapper.deduct(userId, money);<br>        <span class="hljs-comment">//记录事务状态</span><br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">freeze</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountFreeze</span>();<br>        freeze.setXid(xid);<br>        freeze.setUserId(userId);<br>        freeze.setFreezeMoney(money);<br>        freeze.setState(AccountFreeze.State.TRY);   <span class="hljs-comment">//设置事务状态为Try</span><br>        <span class="hljs-comment">//提交事务状态</span><br>        accountFreezeMapper.insert(freeze);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext ctx)</span> &#123;<br>        <span class="hljs-comment">//都成功后提交事务</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> ctx.getXid();<br>        <span class="hljs-comment">//删除冻结记录</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> accountFreezeMapper.deleteById(xid);<br><br>        <span class="hljs-keyword">return</span> count == <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext ctx)</span> &#123;<br>        <span class="hljs-comment">//失败回滚事务</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xid</span> <span class="hljs-operator">=</span> ctx.getXid();<br>        <span class="hljs-comment">//判断是否空回滚</span><br>        <span class="hljs-keyword">if</span>(accountFreezeMapper.selectById(xid) == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">freeze</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountFreeze</span>();<br>            freeze.setXid(xid);<br>            freeze.setFreezeMoney(<span class="hljs-number">0</span>);<br>            freeze.setUserId(ctx.getActionContext(<span class="hljs-string">&quot;userId&quot;</span>).toString());<br>            freeze.setState(AccountFreeze.State.CANCEL);<br>            accountFreezeMapper.insert(freeze);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-type">AccountFreeze</span> <span class="hljs-variable">freeze</span> <span class="hljs-operator">=</span> accountFreezeMapper.selectById(xid);<br>        accountMapper.refund(freeze.getUserId(), freeze.getFreezeMoney()); <span class="hljs-comment">//自定义的方法，用于恢复之前的数据</span><br>        <span class="hljs-comment">//将事务状态改为CANCEL，并清空冻结金额</span><br>        freeze.setFreezeMoney(<span class="hljs-number">0</span>);<br>        freeze.setState(AccountFreeze.State.CANCEL);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> accountFreezeMapper.updateById(freeze);<br><br>        <span class="hljs-keyword">return</span> count == <span class="hljs-number">1</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式搜索(2)</title>
    <link href="/2022/09/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2(2)/"/>
    <url>/2022/09/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2(2)/</url>
    
    <content type="html"><![CDATA[<h2 id="分布式搜索-2"><a href="#分布式搜索-2" class="headerlink" title="分布式搜索(2)"></a>分布式搜索(2)</h2><h3 id="数据聚合"><a href="#数据聚合" class="headerlink" title="数据聚合"></a>数据聚合</h3><blockquote><p>对数据进行分类</p><p>参加聚合的字段必须是keyword、日期、数值、布尔类型</p></blockquote><h4 id="聚合种类"><a href="#聚合种类" class="headerlink" title="聚合种类"></a>聚合种类</h4><p>常见聚合：</p><ul><li><strong>桶（Bucket）</strong>聚合：用来对文档做分组<ul><li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li><li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li></ul></li><li><strong>度量（Metric）</strong>聚合：用以计算一些值，比如：最大值、最小值、平均值等<ul><li>Avg：求平均值</li><li>Max：求最大值</li><li>Min：求最小值</li><li>Stats：同时求max、min、avg、sum等</li></ul></li><li><strong>管道（pipeline）</strong>聚合：其它聚合的结果为基础做聚合</li></ul><h4 id="DSL聚合语法"><a href="#DSL聚合语法" class="headerlink" title="DSL聚合语法"></a>DSL聚合语法</h4><p><strong>桶聚合(Bucket)</strong></p><ul><li><p>TermAggregation实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 设置size为0，结果中不包含文档，只包含聚合结果</span><br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 定义聚合</span><br>    <span class="hljs-attr">&quot;brandAgg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">//给聚合起个名字</span><br>      <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 聚合的类型，按照品牌值聚合，所以选择term</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 参与聚合的字段</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span> <span class="hljs-comment">// 希望获取的聚合结果数量</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>排序</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;brandAgg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asc&quot;</span># 按照数量升序排序<br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>          <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>指定聚合范围，默认对所有文档聚合</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json"># bucket<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span># 只对查询到的结果进行聚合<br>    <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;lte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;brandAgg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asc&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>          <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><p><strong>度量（Metric）</strong></p><blockquote><p>对聚合后的桶里的文档进行运算</p></blockquote><ul><li><p>Stats实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;brandAgg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <br>      <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span> <br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 是brands聚合的子聚合，也就是分组后对每组分别计算</span><br>        <span class="hljs-attr">&quot;score_stats&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 聚合名称</span><br>          <span class="hljs-attr">&quot;stats&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 聚合类型，这里stats可以计算min、max、avg等</span><br>            <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;score&quot;</span> <span class="hljs-comment">// 聚合的字段，这里是对score进行运算</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="RestAPI聚合语法"><a href="#RestAPI聚合语法" class="headerlink" title="RestAPI聚合语法"></a>RestAPI聚合语法</h4><ul><li><p>实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBucket</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//1.创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//2.组织DSL参数</span><br>    <span class="hljs-comment">//2.1 query</span><br>    searchRequest.source().query(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).lte(<span class="hljs-number">200</span>));<br>    <span class="hljs-comment">//2.2 size</span><br>    searchRequest.source().size(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">//2.3 aggs</span><br>    searchRequest.source().aggregation(AggregationBuilders<br>                                       .terms(<span class="hljs-string">&quot;brandAgg&quot;</span>)  <span class="hljs-comment">//聚合类型和聚合名</span><br>                                       .field(<span class="hljs-string">&quot;brand&quot;</span>)           <span class="hljs-comment">//聚合的字段</span><br>                                       .order(BucketOrder.count(<span class="hljs-literal">true</span>)) <span class="hljs-comment">//排序</span><br>                                       .size(<span class="hljs-number">10</span>));     <span class="hljs-comment">//希望获取的聚合结果数量</span><br><br>    <span class="hljs-comment">//3.发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">//解析结果</span><br>    <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> response.getAggregations(); <span class="hljs-comment">//获得聚合集</span><br>    <span class="hljs-type">Terms</span> <span class="hljs-variable">brandAgg</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;brandAgg&quot;</span>);  <span class="hljs-comment">//获取指定的聚合</span><br>    List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&gt; buckets = brandAgg.getBuckets();   <span class="hljs-comment">//获取桶</span><br>    <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">keyAsString</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>        System.out.println(keyAsString);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h3><h4 id="安装拼音分词器插件"><a href="#安装拼音分词器插件" class="headerlink" title="安装拼音分词器插件"></a>安装拼音分词器插件</h4><ul><li><p>下载<a href="https://github.com/medcl/elasticsearch-analysis-pinyin/releases/tag/v8.4.1">Release v8.4.1 · medcl&#x2F;elasticsearch-analysis-pinyin (github.com)</a></p></li><li><p>查看插件挂载的数据卷</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">docker <span class="hljs-keyword">volume</span><span class="language-bash"> inspect es-plugins</span><br></code></pre></td></tr></table></figure></li><li><p>将下载的插件解压到目录下</p></li><li><p>重启</p></li><li><p>测试</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /_analyze<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;拼音分词器&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pinyin&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="自定义拼音分词器"><a href="#自定义拼音分词器" class="headerlink" title="自定义拼音分词器"></a>自定义拼音分词器</h4><p>elasticsearch中分词器（analyzer）的组成包含三部分：</p><ul><li>character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符</li><li>tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart</li><li>tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</li></ul><ul><li><p>实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /test<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;analysis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 自定义分词器</span><br>        <span class="hljs-attr">&quot;my_analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>  <span class="hljs-comment">// 分词器名称</span><br>          <span class="hljs-attr">&quot;tokenizer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_max_word&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;py&quot;</span><span class="hljs-comment">//过滤器名</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 自定义tokenizer filter</span><br>        <span class="hljs-attr">&quot;py&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-comment">// 过滤器名称</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;pinyin&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 过滤器类型，这里是pinyin</span><br>  <span class="hljs-attr">&quot;keep_full_pinyin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;keep_joined_full_pinyin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;keep_original&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;limit_first_letter_length&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">16</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;remove_duplicated_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;none_chinese_pinyin_tokenize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_analyzer&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-comment">//创建时使用的分词器</span><br>        <span class="hljs-attr">&quot;search_analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><span class="hljs-comment">//查询时使用的分词器，防止搜汉字时搜到同音字</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="自动补全查询"><a href="#自动补全查询" class="headerlink" title="自动补全查询"></a>自动补全查询</h4><blockquote><p>参与补全查询的字段必须是<strong>completion</strong>类型。</p><p>字段的内容一般是用来补全的多个词条形成的数组。</p></blockquote><ul><li><p>实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 创建索引库</span><br>PUT test<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;completion&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 示例数据</span><br>POST test/_doc<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;Sony&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;WH-1000XM3&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>POST test/_doc<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;SK-II&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;PITERA&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br>POST test/_doc<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;Nintendo&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;switch&quot;</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// 自动补全查询</span><br>GET /test/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;title_suggest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;s&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 关键字</span><br>      <span class="hljs-attr">&quot;completion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;title&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 补全查询的字段</span><br>        <span class="hljs-attr">&quot;skip_duplicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 跳过重复的</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span> <span class="hljs-comment">// 获取前10条结果</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><p>RestAPI补全语法</p><ul><li><p>实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSuggest</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    searchRequest.source().suggest(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SuggestBuilder</span>()<br>                                   .addSuggestion(<span class="hljs-string">&quot;suggestions&quot;</span>, SuggestBuilders<br>                                                  .completionSuggestion(<span class="hljs-string">&quot;suggestion&quot;</span>)<br>                                                  .prefix(<span class="hljs-string">&quot;h&quot;</span>)<br>                                                  .skipDuplicates(<span class="hljs-literal">true</span>)<br>                                                  .size(<span class="hljs-number">10</span>))<br>                                  );<br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(searchRequest, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">//解析结果</span><br>    <span class="hljs-type">Suggest</span> <span class="hljs-variable">suggest</span> <span class="hljs-operator">=</span> response.getSuggest();<br>    <span class="hljs-type">CompletionSuggestion</span> <span class="hljs-variable">suggestion</span> <span class="hljs-operator">=</span> suggest.getSuggestion(<span class="hljs-string">&quot;suggestions&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (CompletionSuggestion.Entry.Option option : suggestion.getOptions()) &#123;<br>        System.out.println(option.getText().string());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="数据同步"><a href="#数据同步" class="headerlink" title="数据同步"></a>数据同步</h3><p>方式一：同步调用</p><ul><li>优点：实现简单，粗暴</li><li>缺点：直接调接口，业务耦合度高</li></ul><p>方式二：异步通知</p><ul><li>优点：低耦合，实现难度一般</li><li>缺点：依赖mq的可靠性</li></ul><p>方式三：监听binlog</p><ul><li>优点：完全解除服务间耦合</li><li>缺点：开启binlog(类似主从复制)增加数据库负担、实现复杂度高</li></ul><h4 id="通过mq来实现数据同步"><a href="#通过mq来实现数据同步" class="headerlink" title="通过mq来实现数据同步"></a>通过mq来实现数据同步</h4><p>步骤：</p><ol><li>导入依赖，写配置，在消费者端创建交换机、消息队列</li><li>生产者端导入依赖，写配置，通过RabbitTemplate发送消息</li><li>消费者端监听消息队列，通过获取的消息更新索引表</li><li>测试</li></ol><p>实例</p><p><strong>消费者端</strong></p><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--amqp--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span> <br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure></li><li><p>创建交换机、队列和key</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.hotel.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MqConfiguration</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 交换机</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title function_">topicExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicExchange</span>(HOTEL_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 修改消息队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">insertQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(HOTEL_INSERT_QUEUE, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 删除消息队列</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deleteQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(HOTEL_DELETE_QUEUE, <span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 绑定队列和交换机</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">insertQueueBinding</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(insertQueue()).to(topicExchange()).with(HOTEL_INSERT_KEY);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">deleteQueueBinding</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(deleteQueue()).to(topicExchange()).with(HOTEL_DELETE_KEY);<br>    &#125;<br><br><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>创建监听器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.hotel.mq;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 创建消息队列的监听器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelListener</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IHotelService service;<br><br>    <span class="hljs-meta">@RabbitListener(queues = HOTEL_INSERT_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerHotelInsertOrUpdate</span><span class="hljs-params">(Long id)</span> &#123;<br>        service.insertById(id);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = HOTEL_DELETE_QUEUE)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerHotelDelete</span><span class="hljs-params">(Long id)</span> &#123;<br>        service.deleteById(id);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>生产者端</strong></p><ul><li><p>导入依赖、填写配置</p></li><li><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.hotel.web;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;hotel&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IHotelService hotelService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Hotel <span class="hljs-title function_">queryById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>&#123;<br>        <span class="hljs-keyword">return</span> hotelService.getById(id);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-keyword">public</span> PageResult <span class="hljs-title function_">hotelList</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> Integer page,</span><br><span class="hljs-params">            <span class="hljs-meta">@RequestParam(value = &quot;size&quot;, defaultValue = &quot;1&quot;)</span> Integer size</span><br><span class="hljs-params">    )</span>&#123;<br>        Page&lt;Hotel&gt; result = hotelService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(page, size));<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageResult</span>(result.getTotal(), result.getRecords());<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveHotel</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Hotel hotel)</span>&#123;<br>        hotelService.save(hotel);<br><br>        <span class="hljs-comment">//将修改的数据id发到队列</span><br>        rabbitTemplate.convertAndSend(HOTEL_EXCHANGE, HOTEL_INSERT_KEY, hotel.getId());<br>    &#125;<br><br>    <span class="hljs-meta">@PutMapping()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateById</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Hotel hotel)</span>&#123;<br>        <span class="hljs-keyword">if</span> (hotel.getId() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidParameterException</span>(<span class="hljs-string">&quot;id不能为空&quot;</span>);<br>        &#125;<br>        hotelService.updateById(hotel);<br><br>        <span class="hljs-comment">//将修改的数据id发到队列</span><br>        rabbitTemplate.convertAndSend(HOTEL_EXCHANGE, HOTEL_INSERT_KEY, hotel.getId());<br>    &#125;<br><br>    <span class="hljs-meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        hotelService.removeById(id);<br><br>        <span class="hljs-comment">//将删除的数据id发到队列</span><br>        rabbitTemplate.convertAndSend(HOTEL_EXCHANGE, HOTEL_DELETE_KEY, id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="es集群"><a href="#es集群" class="headerlink" title="es集群"></a>es集群</h3><p>概念：</p><ul><li><p>集群（cluster）：一组拥有共同的 cluster name 的 节点。</p></li><li><p>节点（node)  ：集群中的一个 Elasticearch 实例</p></li><li><p>分片（shard）：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中</p><p>解决问题：数据量太大，单点存储量有限的问题。</p></li></ul><h4 id="集群职责划分"><a href="#集群职责划分" class="headerlink" title="集群职责划分"></a>集群职责划分</h4><p><img src="/img/weifuwu_img/es%E9%9B%86%E7%BE%A4%E5%88%92%E5%88%86.png"></p><p>默认情况下，集群中的任何一个节点都同时具备上述四种角色。但是真实的集群一定要将集群职责分离</p><h4 id="脑裂"><a href="#脑裂" class="headerlink" title="脑裂"></a>脑裂</h4><blockquote><p>因为节点失联导致出现多个主节点</p></blockquote><p>解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）&#x2F; 2 才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p><h4 id="集群分布式存储-x2F-查询"><a href="#集群分布式存储-x2F-查询" class="headerlink" title="集群分布式存储&#x2F;查询"></a>集群分布式存储&#x2F;查询</h4><p><strong>存储</strong></p><p>elasticsearch会通过hash算法来计算文档应该存储到哪个分片</p><p><code>shard = hash(_routing) % number_of_shards</code></p><ul><li>_routing: 默认是文档id</li><li>number_of_shards：分片数，此索引库一旦创建，分片数量不能修改</li></ul><p><strong>查询</strong></p><p>查询分成两个阶段：</p><ul><li><p>scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p></li><li><p>gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p></li></ul><h4 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h4><p>集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即<strong>将宕机节点的分片数据迁移到其它节点</strong>，确保数据安全，这个叫做故障转移。</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>接口限流</title>
    <link href="/2022/09/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/"/>
    <url>/2022/09/18/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E6%8E%A5%E5%8F%A3%E9%99%90%E6%B5%81/</url>
    
    <content type="html"><![CDATA[<h2 id="接口限流"><a href="#接口限流" class="headerlink" title="接口限流"></a>接口限流</h2><h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><blockquote><p>由阿里巴巴中间件团队开发的开源项目，是一种面向分布式微服务架构的轻量级高可用<strong>流量控制</strong>组件</p><p>提供了流量控制、熔断降级、系统负载保护等多个维度来保障服务之间的稳定性</p></blockquote><p><img src="/img/weifuwu_img/sentinel.png" alt="sentinel"></p><p>sentinel分为两部分：</p><ul><li>sentinel-dashboard(控制面板)：提供实时监控之外，还提供了流控规则、熔断规则的在线维护等功能</li><li>客户端整合：每个微服务客户端都需要整合sentinel的客户端封装与配置，才能将监控信息上报给dashboard展示以及实时的更改限流或熔断规则等。</li></ul><h4 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h4><h5 id="部署Sentinel-Dashboard"><a href="#部署Sentinel-Dashboard" class="headerlink" title="部署Sentinel Dashboard"></a>部署Sentinel Dashboard</h5><p>下载地址：<a href="https://github.com/alibaba/Sentinel/releases">sentinel-dashboard</a></p><ul><li><p>运行jar包</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ldif">java -jar sentinel-dashboard-1.8.3.jar<br><br><span class="hljs-comment">#后面可跟参数</span><br><span class="hljs-literal">-</span>Dserver.port=8080 <span class="hljs-comment">#设置端口，默认8080</span><br><span class="hljs-literal">-</span>Dsentinel.dashboard.auth.username=sentinel<span class="hljs-comment">#设置用户名, 默认sentinel</span><br><span class="hljs-literal">-</span>Dsentinel.dashboard.auth.password=123456<span class="hljs-comment">#设置密码, 默认sentinel</span><br></code></pre></td></tr></table></figure></li><li><p>访问<code>localhost:8080</code>来打开控制面板</p></li></ul><h5 id="客户端整合Sentinel"><a href="#客户端整合Sentinel" class="headerlink" title="客户端整合Sentinel"></a>客户端整合Sentinel</h5><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--sentinel--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.1.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置Sentinel Dashboard的访问地址</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">transport:</span><br>        <span class="hljs-attr">dashboard:</span> <span class="hljs-string">localhost:8080</span>   <span class="hljs-comment"># 控制面板端口</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">alibaba-sentinel-rate-limiting</span>  <span class="hljs-comment"># 服务名</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span>  <span class="hljs-comment"># 服务端口</span><br></code></pre></td></tr></table></figure></li><li><p>编写一个访问的接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.controller;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;hello&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>访问此接口和控制台</p><p><img src="/img/weifuwu_img/sentinel%E4%BE%8B%E5%AD%90.png" alt="sentinel例子"></p><p><img src="/img/weifuwu_img/sentinel%E6%8E%A7%E5%88%B6%E5%8F%B0.png" alt="sentinel控制台"></p></li></ul><h4 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h4><h5 id="配置限流规则"><a href="#配置限流规则" class="headerlink" title="配置限流规则"></a>配置限流规则</h5><blockquote><p>对访问某个接口的所有请求进行限流</p></blockquote><p><img src="/img/weifuwu_img/sentinel%E6%B5%81%E6%8E%A7.png" alt="sentinel流控"></p><p><img src="/img/weifuwu_img/sentinel%E6%96%B0%E5%A2%9E%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99.png" alt="sentinel新增流控规则"></p><p>流控模式：</p><ul><li><p>直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认模式。</p></li><li><p>关联：统计与当前相关的另一个资源，触发阈值时，对当前资源限流。</p></li><li><p>链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流</p><blockquote><p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入SpringMVC的所有请求设置同一个root资源，会导致链路模式失效。</p><p>我们需要关闭这种对SpringMVC的资源聚合</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">sentinel:</span><br>      <span class="hljs-attr">web-context-unify:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 关闭context整合</span><br></code></pre></td></tr></table></figure></li></ul><p>流控效果：</p><ul><li>快速失效：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常。是默认的处理方式。</li><li>warm up：预热模式，对超出阈值的请求同样是拒绝，并抛出异常。但这种模式阈值会动态变化，从一个较小的值逐渐增加到最大值。</li><li>排队等待：让所有请求按照先后次序排队执行，两个请求的间隔不能小于指定时长。对流量进行整形，将波动的qps整形成平滑的直线。</li></ul><h5 id="配置热点参数限流"><a href="#配置热点参数限流" class="headerlink" title="配置热点参数限流"></a>配置热点参数限流</h5><blockquote><p>粒度更细，对访问某个接口的指定参数进行限流</p></blockquote><ul><li><p>热点参数限流对默认的SpringMVC是无效的，添加@SentinelResource注解开启热点限流</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SentinelResource(&quot;hot&quot;)</span>    <span class="hljs-comment">//设置资源名</span><br><span class="hljs-meta">@GetMapping(&quot;/hot&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">hot</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String id)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;热点参数&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>通过控制面板设置</p><p><img src="/img/weifuwu_img/%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%991.png" alt="热点规则1"></p><p><img src="/img/weifuwu_img/%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%992.png" alt="热点规则2"></p></li></ul><h4 id="隔离"><a href="#隔离" class="headerlink" title="隔离"></a>隔离</h4><blockquote><p>对访问某个接口的线程进行限制</p></blockquote><h5 id="FeignClient整合Sentinel"><a href="#FeignClient整合Sentinel" class="headerlink" title="FeignClient整合Sentinel"></a>FeignClient整合Sentinel</h5><blockquote><p>将Feign与Sentinel整合，在Feign里面实现线程隔离和服务熔断。</p><p>SpringCloud版本为&lt;spring-cloud.version&gt;Hoxton.SR8&lt;&#x2F;spring-cloud.version&gt;</p><p>循环依赖可能是版本问题</p></blockquote><p>Feign整合Sentinel的步骤：</p><ul><li>在application.yml中配置：feign.sentienl.enable&#x3D;true</li><li>给FeignClient编写FallbackFactory并注册为Bean</li><li>将FallbackFactory配置到FeignClient</li></ul><ul><li><p>在用到feign的类的配置中开启sentinel功能</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启feign对sentinel的支持</span><br></code></pre></td></tr></table></figure></li><li><p>编写失败降级逻辑</p><blockquote><p>业务失败后，不能直接报错，而应该返回用户一个友好提示或者默认结果，这个就是失败降级逻辑。</p><p>给FeignClient编写失败后的降级逻辑</p><p>①方式一：FallbackClass，无法对远程调用的异常做处理</p><p>②方式二：FallbackFactory，可以对远程调用的异常做处理</p></blockquote><p>在feign-api包中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.client.fallback;<br><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserClientFallbackFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;UserClient&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserClient <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable throwable)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserClient</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> &#123;<br>                log.error(<span class="hljs-string">&quot;查询用户异常&quot;</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>将UserClientFallbackFactory注册为一个bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultFeignConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> UserClientFallbackFactory <span class="hljs-title function_">userClientFallbackFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserClientFallbackFactory</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在用到feign的类上记得在启动类上设置默认配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(clients = &#123;UserClient.class&#125;,defaultConfiguration = DefaultFeignConfiguration.class)</span><br></code></pre></td></tr></table></figure></li><li><p>在feing-api项目中的UserClient接口中使用UserClientFallbackFactory</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.client;<br><br><span class="hljs-comment">//注意是fallbackFactory不是fallback</span><br><span class="hljs-meta">@FeignClient(value = &quot;userservice&quot;, fallbackFactory = UserClientFallbackFactory.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    User <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>重启服务</p></li></ul><h5 id="线程隔离"><a href="#线程隔离" class="headerlink" title="线程隔离"></a>线程隔离</h5><p>线程隔离的两种手段</p><ul><li><p>信号量隔离</p></li><li><p>线程池隔离</p></li></ul><p>信号量隔离的特点</p><ul><li>基于计数器模式，简单，开销小，适合高扇出的场景</li></ul><p>线程池隔离的特点</p><ul><li>基于线程池模式，有额外开销，但隔离控制更强</li></ul><h5 id="配置隔离规则"><a href="#配置隔离规则" class="headerlink" title="配置隔离规则"></a>配置隔离规则</h5><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E9%9A%94%E7%A6%BB%E8%A7%84%E5%88%991.png" alt="配置隔离规则1"></p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E9%9A%94%E7%A6%BB%E8%A7%84%E5%88%992.png" alt="配置隔离规则2"></p><h5 id="熔断"><a href="#熔断" class="headerlink" title="熔断"></a>熔断</h5><blockquote><p>熔断降级是解决雪崩问题的重要手段。其思路是由<strong>断路器</strong>统计服务调用的异常比例、慢请求比例，如果超出阈值则会<strong>熔断</strong>该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p></blockquote><p>熔断策略：</p><ul><li>慢调用：当响应时间大于设定的值(RT)时，为一次慢调用。若慢调用的次数大于设定的阈值，请求数量超过设定的最小数量，则会触发熔断</li><li>异常比例：单位时间里出现异常的比例大于设置的比例，则会触发熔断</li><li>异常数: 单位时间里出现异常的比例大于设置的数值，则会触发熔断</li></ul><p><strong>配置慢调用</strong></p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E6%85%A2%E8%B0%83%E7%94%A81.png" alt="配置慢调用1"></p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E6%85%A2%E8%B0%83%E7%94%A82.png" alt="配置慢调用2"></p><p><strong>配置异常比例&#x2F;异常数</strong></p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B%E5%92%8C%E5%BC%82%E5%B8%B8%E6%95%B0.png" alt="配置异常比例和异常数"></p><h4 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h4><blockquote><p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p><p>只对有授权的请求提供服务</p></blockquote><p>默认情况下，sentinel对一切请求的来源都被认为是一样的值default。</p><ul><li><p>自定义请求来源解析器</p><blockquote><p>配置授权规则时会根据解析器的返回值来判断请求来源</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.order.sentinel;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义来源解析器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeaderOriginParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestOriginParser</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">parseOrigin</span><span class="hljs-params">(HttpServletRequest request)</span> &#123;<br>        <span class="hljs-comment">//从请求头获取来源信息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">origin</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;origin&quot;</span>);<br><span class="hljs-comment">//请求头中没有&quot;origin&quot;，则默认值为&quot;blank&quot;</span><br>        <span class="hljs-keyword">if</span> (StringUtil.isEmpty(origin)) &#123;<br>            origin = <span class="hljs-string">&quot;blank&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> origin;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>通过配置，给网关添加过滤器</p><blockquote><p>通过网关的请求都会被加上origin的请求头，值为”gateway”</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">default-filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=origin,gateway</span><br></code></pre></td></tr></table></figure></li><li><p>配置授权规则</p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%991.png" alt="配置授权规则1"></p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%992.png" alt="配置授权规则2"></p></li></ul><h4 id="自定义异常结果"><a href="#自定义异常结果" class="headerlink" title="自定义异常结果"></a>自定义异常结果</h4><blockquote><p>发生限流、降级、授权拦截时，都会抛出异常到调用方，异常结果都是flow limmiting（限流）</p></blockquote><p><strong>异常种类</strong></p><table><thead><tr><th><strong>异常</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>FlowException</td><td>限流异常</td></tr><tr><td>ParamFlowException</td><td>热点参数限流的异常</td></tr><tr><td>DegradeException</td><td>降级异常</td></tr><tr><td>AuthorityException</td><td>授权规则异常</td></tr><tr><td>SystemBlockException</td><td>系统规则异常</td></tr></tbody></table><p>通过自定义堵塞异常处理器来自定义返回结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.order.sentinel;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BlockExceptionHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;未知错误&quot;</span>;    <span class="hljs-comment">//异常信息</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-number">429</span>;   <span class="hljs-comment">//状态码</span><br><br>        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> FlowException) &#123;<br>            msg = <span class="hljs-string">&quot;请求被限流了&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ParamFlowException) &#123;<br>            msg = <span class="hljs-string">&quot;请求被热点参数限流&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> DegradeException) &#123;<br>            msg = <span class="hljs-string">&quot;请求被降级了&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> AuthorityException) &#123;<br>            msg = <span class="hljs-string">&quot;没有权限访问&quot;</span>;<br>            status = <span class="hljs-number">401</span>;<br>        &#125;<br><br>        response.setContentType(<span class="hljs-string">&quot;application/json;charset=utf-8&quot;</span>);<br>        response.setStatus(status);<br>        response.getWriter().println(<span class="hljs-string">&quot;&#123;\&quot;msg\&quot;: &quot;</span> + msg + <span class="hljs-string">&quot;, \&quot;status\&quot;: &quot;</span> + status + <span class="hljs-string">&quot;&#125;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分布式搜索(1)</title>
    <link href="/2022/09/13/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2/"/>
    <url>/2022/09/13/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E5%88%86%E5%B8%83%E5%BC%8F%E6%90%9C%E7%B4%A2/</url>
    
    <content type="html"><![CDATA[<h2 id="分布式搜索-1"><a href="#分布式搜索-1" class="headerlink" title="分布式搜索(1)"></a>分布式搜索(1)</h2><h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><blockquote><p>一个开源的分布式搜索引擎，可以用来实现搜索、日志统计、分析、系统监控等功能</p></blockquote><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>elastic stack（ELK）: 是以elasticsearch为核心的技术栈，包括beats、Logstash、kibana、elasticsearch</p><p>正向索引：根据id索引来查找文档</p><p>倒排索引：根据搜索的词条找id再找文档</p><h4 id="安装es"><a href="#安装es" class="headerlink" title="安装es"></a>安装es</h4><p>创建一个网络, 让es和kibana容器互联</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">docker network create es-<span class="hljs-built_in">net</span><br></code></pre></td></tr></table></figure><ul><li><p>拉取镜像(体积比较大，下载时间可能比较长)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull elasticsearch:<span class="hljs-number">7</span>.<span class="hljs-number">12</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li><p>运行</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run -d <span class="hljs-string">\</span><br>--name es <span class="hljs-string">\</span><br>    -e <span class="hljs-string">&quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</span> <span class="hljs-string">\</span><br>    -e <span class="hljs-string">&quot;discovery.type=single-node&quot;</span> <span class="hljs-string">\</span><br>    -v es-data:/usr/share/elasticsearch/data <span class="hljs-string">\</span><br>    -v es-plugins:/usr/share/elasticsearch/plugins <span class="hljs-string">\</span><br>    --privileged <span class="hljs-string">\</span><br>    --network es-net <span class="hljs-string">\</span><br>    -p <span class="hljs-number">9200</span>:<span class="hljs-number">9200</span> <span class="hljs-string">\</span><br>    -p <span class="hljs-number">9300</span>:<span class="hljs-number">9300</span> <span class="hljs-string">\</span><br>elasticsearch:<span class="hljs-number">7.12</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li></ul><p>命令解释：</p><ul><li><code>-e &quot;cluster.name=es-docker-cluster&quot;</code>：设置集群名称</li><li><code>-e &quot;http.host=0.0.0.0&quot;</code>：监听的地址，可以外网访问</li><li><code>-e &quot;ES_JAVA_OPTS=-Xms512m -Xmx512m&quot;</code>：内存大小</li><li><code>-e &quot;discovery.type=single-node&quot;</code>：非集群模式</li><li><code>-v es-data:/usr/share/elasticsearch/data</code>：挂载逻辑卷，绑定es的数据目录</li><li><code>-v es-logs:/usr/share/elasticsearch/logs</code>：挂载逻辑卷，绑定es的日志目录</li><li><code>-v es-plugins:/usr/share/elasticsearch/plugins</code>：挂载逻辑卷，绑定es的插件目录</li><li><code>--privileged</code>：授予逻辑卷访问权</li><li><code>--network es-net</code> ：加入一个名为es-net的网络中</li><li><code>-p 9200:9200</code>：端口映射配置</li></ul><h4 id="安装kibana"><a href="#安装kibana" class="headerlink" title="安装kibana"></a>安装kibana</h4><blockquote><p>kibana可以给我们提供一个elasticsearch的可视化界面</p></blockquote><ul><li><p>拉取镜像(一定要和es版本一样)</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull kibana:<span class="hljs-number">7</span>.<span class="hljs-number">12</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li><p>运行</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">docker <span class="hljs-built_in">run</span> -d \<br>--name kibana \<br>-e <span class="hljs-attribute">ELASTICSEARCH_HOSTS</span>=http://es:9200 \<br><span class="hljs-attribute">--network</span>=es-net \<br>-p 5601:5601  \<br>kibana:7.12.1<br></code></pre></td></tr></table></figure></li></ul><p>命令解释</p><ul><li><code>--network es-net</code> ：加入一个名为es-net的网络中，与elasticsearch在同一个网络中</li><li><code>-e ELASTICSEARCH_HOSTS=http://es:9200&quot;</code>：设置elasticsearch的地址，因为kibana已经与elasticsearch在一个网络，因此可以用容器名直接访问elasticsearch</li><li><code>-p 5601:5601</code>：端口映射配置</li></ul><h4 id="安装ik"><a href="#安装ik" class="headerlink" title="安装ik"></a>安装ik</h4><blockquote><p>es内置的分词器不支持中文。ik分词器是一个标准的中文分词器</p></blockquote><ul><li><p>在线安装(速度慢)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 进入容器内部</span><br>docker exec -it elasticsearch <span class="hljs-regexp">/bin/</span>bash<br><br><span class="hljs-comment"># 在线下载并安装</span><br>.<span class="hljs-regexp">/bin/</span>elasticsearch-plugin  install https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/medcl/</span>elasticsearch-analysis-ik<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v7.12.1/</span>elasticsearch-analysis-ik-<span class="hljs-number">7.12</span>.<span class="hljs-number">1</span>.zip<br><br><span class="hljs-comment">#退出</span><br><span class="hljs-keyword">exit</span><br><span class="hljs-comment">#重启容器</span><br>docker restart elasticsearch<br></code></pre></td></tr></table></figure></li><li><p>离线安装</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 查看es插件目录挂载的数据卷</span><br>docker <span class="hljs-keyword">volume</span><span class="language-bash"> inspect es-plugins</span><br><br><span class="hljs-comment"># 将ik分词器上传到数据卷内</span><br><br><span class="hljs-comment"># 重启容器</span><br>docker restart es<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">GET</span> /_analyze<br>&#123;<br>  <span class="hljs-string">&quot;analyzer&quot;</span>: <span class="hljs-string">&quot;ik_max_word&quot;</span>,<br>  <span class="hljs-string">&quot;text&quot;</span>: <span class="hljs-string">&quot;上海自来水来自上海&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>IK分词器包含两种模式：</p><ul><li><p><code>ik_smart</code>：最少切分</p></li><li><p><code>ik_max_word</code>：最细切分</p></li></ul><h4 id="扩展词词典"><a href="#扩展词词典" class="headerlink" title="扩展词词典"></a>扩展词词典</h4><blockquote><p>IK分词器提供了扩展词汇的功能</p></blockquote><ul><li><p>ik&#x2F;config目录下的IKAnalyzer.cfg.xml配置文件可以添加扩展词典</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">properties</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展字典 *** 添加扩展词典--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_dict&quot;</span>&gt;</span>ext.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>创建ext_dict，在文件中添加词汇，并放到ik&#x2F;config里</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># ext_dict文件</span><br>哈哈哈哈哈哈<br>传智播客<br></code></pre></td></tr></table></figure></li><li><p>重启es</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker restart es</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="ES基本操作"><a href="#ES基本操作" class="headerlink" title="ES基本操作"></a>ES基本操作</h3><h4 id="索引库操作"><a href="#索引库操作" class="headerlink" title="索引库操作"></a>索引库操作</h4><blockquote><p>类似mysql的表</p><p>mapping是对索引库中文档的<strong>约束</strong></p></blockquote><p>常见的mapping属性包括：</p><ul><li>type：字段数据类型，常见的简单类型有：<ul><li>字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip地址）</li><li>数值：long、integer、short、byte、double、float、</li><li>布尔：boolean</li><li>日期：date</li><li>对象：object</li></ul></li><li>index：是否创建索引，默认为true</li><li>analyzer：使用哪种分词器</li><li>properties：该字段的子字段</li></ul><p>示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs json"># 新增一个索引库<br>PUT /test<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;keyword&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># 查询索引库<br>GEt /test<br><br># 给索引库新增字段   (索引库一旦创建，无法修改mapping，只能新增)<br>PUT /test/_mapping<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;integer&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># 删除索引库<br>DELETE /test<br></code></pre></td></tr></table></figure><h4 id="文档操作"><a href="#文档操作" class="headerlink" title="文档操作"></a>文档操作</h4><blockquote><p>类似mysql的数据</p></blockquote><p>示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs json"># 新增文档<br>POST test/_doc/<span class="hljs-number">1</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asdasd&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;123@qq.com&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;san&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhang&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># 查询文档<br>GET /test/_doc/<span class="hljs-number">1</span><br><br># 删除文档<br>DELETE /test/_doc/<span class="hljs-number">1</span><br><br># 修改文档(全量修改<span class="hljs-punctuation">:</span> 等于DELETE + POST，文档不存在也会新增)<br>PUT test/_doc/<span class="hljs-number">1</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asdasd&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;123@qq.com&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;si&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;li&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># 修改文档(增量修改<span class="hljs-punctuation">:</span> 只修改部分)<br>POST test/_update/<span class="hljs-number">1</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;456@qq.com&quot;</span>  <br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="RESTAPI"><a href="#RESTAPI" class="headerlink" title="RESTAPI"></a>RESTAPI</h3><blockquote><p>ES官方提供了各种不同语言的客户端，用来操作ES。这些客户端的本质就是组装DSL语句，通过http请求发送给ES。官方文档地址：<a href="https://www.elastic.co/guide/en/elasticsearch/client/index.html">https://www.elastic.co/guide/en/elasticsearch/client/index.html</a></p></blockquote><p>Java Rest Client又包括两种：</p><ul><li>Java Low Level Rest Client</li><li>Java High Level Rest Client</li></ul><p>设计mapping映射要考虑的信息包括：</p><ul><li>字段名</li><li>字段数据类型</li><li>是否参与搜索</li><li>是否需要分词 </li><li>如果分词，分词器是什么？</li></ul><h4 id="创建客户端"><a href="#创建客户端" class="headerlink" title="创建客户端"></a>创建客户端</h4><blockquote><p>通过客户端的api操作es</p></blockquote><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--版本要和es的版本一致--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">elasticsearch.version</span>&gt;</span>7.12.1<span class="hljs-tag">&lt;/<span class="hljs-name">elasticsearch.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--RestHighLevelClient依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>通过new的方式创建客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.hotel;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelIndexTest</span> &#123;<br><br>    <span class="hljs-keyword">private</span> RestHighLevelClient client;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(client);<br>    &#125;<br><br>    <span class="hljs-comment">//初始化</span><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> &#123;<br>        client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestHighLevelClient</span>(RestClient.builder(<br>                HttpHost.create(<span class="hljs-string">&quot;http://192.168.229.128:9200&quot;</span>)<br>        ));<br>    &#125;<br><br>    <span class="hljs-comment">//结束后销毁</span><br>    <span class="hljs-meta">@AfterEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">this</span>.client.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="创建索引库"><a href="#创建索引库" class="headerlink" title="创建索引库"></a>创建索引库</h4><ul><li><p>准备创建语句</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.hotel.constants;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ESConstants</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">MAPPING_TEMPLATE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;address\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;price\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;score\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;brand\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;city\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;copy_to\&quot;: \&quot;all\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;starName\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;business\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;location\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;geo_point\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;pic\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;all\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;\n&quot;</span> +<br>            <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>            <span class="hljs-string">&quot;  &#125;\n&quot;</span> +<br>            <span class="hljs-string">&quot;&#125;&quot;</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>通过client发送创建索引库请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 创建索引库</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">CreateIndexRequest</span> <span class="hljs-variable">createIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateIndexRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//设置请求参数</span><br>    createIndexRequest.source(MAPPING_TEMPLATE, XContentType.JSON);<br>    <span class="hljs-comment">//返送请求</span><br>    client.indices().create(createIndexRequest, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="删除索引库"><a href="#删除索引库" class="headerlink" title="删除索引库"></a>删除索引库</h4><ul><li><p>通过client发送删除引库请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 删除索引库</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">DeleteIndexRequest</span> <span class="hljs-variable">deleteIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteIndexRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//发送请求</span><br>    client.indices().delete(deleteIndexRequest, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="查询索引库"><a href="#查询索引库" class="headerlink" title="查询索引库"></a>查询索引库</h4><ul><li><p>通过client发送查询引库请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 查询索引库</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">GetIndexRequest</span> <span class="hljs-variable">getIndexRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetIndexRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//发送请求</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> client.indices().exists(getIndexRequest, RequestOptions.DEFAULT);<br>    System.out.println(exists ? <span class="hljs-string">&quot;索引库存在&quot;</span> : <span class="hljs-string">&quot;索引库不存在&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="新增文档"><a href="#新增文档" class="headerlink" title="新增文档"></a>新增文档</h4><ul><li><p>通过client发送新增文档请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> cn.itcast.hotel;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelDocumentTest</span> &#123;<br><br>    <span class="hljs-keyword">private</span> RestHighLevelClient client;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IHotelService iHotelService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 新增文档</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">//从数据库中获取hotel对象</span><br>        <span class="hljs-type">Hotel</span> <span class="hljs-variable">hotel</span> <span class="hljs-operator">=</span> iHotelService.getById(<span class="hljs-number">61083L</span>);<br>        <span class="hljs-comment">//数据库中的对象属性和索引库中不一致，要转换一下</span><br>        <span class="hljs-type">HotelDoc</span> <span class="hljs-variable">hotelDoc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotelDoc</span>(hotel);<br><br>        <span class="hljs-comment">//创建request请求</span><br>        <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>).id(hotelDoc.getId().toString());<br>        <span class="hljs-comment">//设置请求参数</span><br>        request.source(JSON.toJSONString(hotelDoc), XContentType.JSON);<br>        <span class="hljs-comment">//发送请求</span><br>        client.index(request, RequestOptions.DEFAULT);<br>    &#125;<br><br><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> &#123;<br>        client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestHighLevelClient</span>(RestClient.builder(<br>                HttpHost.create(<span class="hljs-string">&quot;http://192.168.229.128:9200&quot;</span>)<br>        ));<br>    &#125;<br><br>    <span class="hljs-meta">@AfterEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-built_in">this</span>.client.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ul><h4 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h4><ul><li><p>通过client发送查询文档请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 查询文档</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">GetDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建请求</span><br>    <span class="hljs-type">GetRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>, <span class="hljs-string">&quot;61083&quot;</span>);<br>    <span class="hljs-comment">//发送请求,获得响应结果</span><br>    <span class="hljs-type">GetResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.get(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//将响应结构转为对象</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> response.getSourceAsString();<br>    <span class="hljs-type">HotelDoc</span> <span class="hljs-variable">hotelDoc</span> <span class="hljs-operator">=</span> JSON.parseObject(json, HotelDoc.class);<br>    System.out.println(hotelDoc);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="修改文档"><a href="#修改文档" class="headerlink" title="修改文档"></a>修改文档</h4><ul><li><p>通过client发送修改文档请求，全量修改和新增操作一样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 更新文档(局部修改)</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">UpdateDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建请求</span><br>    <span class="hljs-type">UpdateRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>, <span class="hljs-string">&quot;61083&quot;</span>);<br>    <span class="hljs-comment">//设置请求参数</span><br>    request.doc(<br>        <span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-string">&quot;999&quot;</span><br>    );<br>    <span class="hljs-comment">//发送请求</span><br>    client.update(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><ul><li><p>通过client发送删除文档请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 删除文档</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建请求</span><br>    <span class="hljs-type">DeleteRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>, <span class="hljs-string">&quot;61083&quot;</span>);<br>    <span class="hljs-comment">//发送请求</span><br>    client.delete(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="批量新增文档"><a href="#批量新增文档" class="headerlink" title="批量新增文档"></a>批量新增文档</h4><ul><li><p>通过client发送批量新增文档请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 批量新增文档</span><br><span class="hljs-comment">* <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bulkCreateDoc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建请求</span><br>    <span class="hljs-type">BulkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>();<br><br>    <span class="hljs-comment">//查询数据库中所有hotel信息</span><br>    List&lt;Hotel&gt; hotels = iHotelService.list();<br>    <span class="hljs-comment">//将hotel转换为hotelDoc，再封装到请求中</span><br>    <span class="hljs-keyword">for</span> (Hotel hotel : hotels) &#123;<br>        <span class="hljs-type">HotelDoc</span> <span class="hljs-variable">hotelDoc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HotelDoc</span>(hotel);<br>        request.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>)<br>                    .id(hotel.getId().toString())<br>                    .source(JSON.toJSONString(hotelDoc),XContentType.JSON)<br>                   );<br>    &#125;<br>    <span class="hljs-comment">//发送请求</span><br>    client.bulk(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在kibana中用<code>GET /hotel/_search</code>可查看所有文档</p></li></ul><h3 id="DSL查询语法"><a href="#DSL查询语法" class="headerlink" title="DSL查询语法"></a>DSL查询语法</h3><blockquote><p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html">Domain Specific Language</a></p></blockquote><p>常见查询类型：</p><ul><li>查询所有</li><li>全文检索查询: 对搜索条件分词得到词条，然后通过词条来查询相关字段</li><li>精准查询：<strong>不会</strong>对搜索条件分词</li><li>地理查询：给定坐标来查询</li><li>复合查询：将其它简单查询组合起来，实现更复杂的搜索逻辑</li></ul><p>通用查询语法</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /indexName/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;查询类型&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;查询条件&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;条件值&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h4 id="查询所有"><a href="#查询所有" class="headerlink" title="查询所有"></a>查询所有</h4><blockquote><p>match_all</p></blockquote><ul><li><p>实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"># 查询hotel索引库中所有信息<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span>  <br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="全文检索查询"><a href="#全文检索查询" class="headerlink" title="全文检索查询"></a>全文检索查询</h4><blockquote><p>match: 单字段查询</p><p>multi_match: 多字段查询</p></blockquote><ul><li><p>match实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"># 对内容进行分词，然后查询<span class="hljs-string">&quot;all&quot;</span>字段<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;外滩 如家&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>multi_match实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"># 对内容进行分词，然后查询<span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;name&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;business&quot;</span>三个字段<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;multi_match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;外滩 如家&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;name&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;business&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="精准查询"><a href="#精准查询" class="headerlink" title="精准查询"></a>精准查询</h4><blockquote><p>term：根据词条精确值查询</p><p>range：根据值的范围查询</p></blockquote><ul><li><p>term实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"># 查询<span class="hljs-string">&quot;city&quot;</span>字段为<span class="hljs-string">&quot;上海&quot;</span>的信息<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;city&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;上海&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>range实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json"># 查询<span class="hljs-string">&quot;price&quot;</span>字段值为<span class="hljs-punctuation">[</span><span class="hljs-number">200</span><span class="hljs-punctuation">,</span> <span class="hljs-number">300</span><span class="hljs-punctuation">]</span>之间的信息<br># gte<span class="hljs-punctuation">:</span> greater then equals <span class="hljs-punctuation">,</span> lte<span class="hljs-punctuation">:</span> less then equals<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;gte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;lte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="地理查询"><a href="#地理查询" class="headerlink" title="地理查询"></a>地理查询</h4><blockquote><p>geo_distance：指定坐标和半径来查询范围内的数据</p><p>geo_bounding_box：指定两个坐标，查询形成的矩形内的数据</p></blockquote><ul><li><p>geo_distance实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"># 以<span class="hljs-string">&quot;31.21,121.5&quot;</span> 为点做半径为<span class="hljs-number">15</span>km的圆<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;geo_distance&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;distance&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;15km&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;location&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;31.21,121.5&quot;</span> <br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p>geo_bounding_box实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;geo_bounding_box&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;location&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;top_left&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;lat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">31.1</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;lon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">121.5</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;bottom_right&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;lat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30.9</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;lon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">121.7</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="复合查询"><a href="#复合查询" class="headerlink" title="复合查询"></a>复合查询</h4><blockquote><p>function score：算分函数查询，可以控制文档相关性算分，控制文档排名</p><p>bool query：布尔查询，利用逻辑关系组合多个其它的查询，实现复杂搜索</p></blockquote><p><strong>function score</strong></p><p>elasticsearch会根据词条和文档的相关度做打分，算法由两种：</p><ul><li><p>TF-IDF算法</p><p><img src="/img/weifuwu_img/TF-IDF%E7%AE%97%E6%B3%95.png" alt="TF-IDF算法"></p></li><li><p>BM25算法，elasticsearch5.1版本后采用的算法</p><p><img src="/img/weifuwu_img/BM25.png" alt="BM25"></p></li><li><p>function score实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs json"># 复合查询<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;function_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-comment">//原始查询条件</span><br>        <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;外滩&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;functions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-comment">//过滤查到的信息</span><br>            <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;如家&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;weight&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>      <span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;boost_mode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;sum&quot;</span><span class="hljs-comment">//sum模式为_score = 原始分数 + weight</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><p><strong>bool query</strong></p><p>布尔查询是一个或多个查询子句的组合，每一个子句就是一个<strong>子查询</strong>。子查询的组合方式有：</p><ul><li>must：必须匹配每个子查询，类似“与”</li><li>should：选择性匹配子查询，类似“或”</li><li>must_not：必须不匹配，<strong>不参与算分</strong>，类似“非”</li><li>filter：必须匹配，<strong>不参与算分</strong></li></ul><ul><li><p>bool query实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs json"># 名字中包含<span class="hljs-string">&quot;如家&quot;</span><span class="hljs-punctuation">,</span> 价格<span class="hljs-number">400</span>以上，范围<span class="hljs-number">10</span>km之内<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;must&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;如家&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;must_not&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;gt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;geo_distance&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;distance&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10km&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;location&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;lat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">31.21</span><span class="hljs-punctuation">,</span><br>              <span class="hljs-attr">&quot;lon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">121.5</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h3 id="搜索结果处理"><a href="#搜索结果处理" class="headerlink" title="搜索结果处理"></a>搜索结果处理</h3><h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><blockquote><p>sort</p></blockquote><ul><li><p>实例1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"># 按分数降序，价格升序排序<br>GET /hotel/_search<br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;<br>  , <span class="hljs-string">&quot;sort&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-string">&quot;desc&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;price&quot;</span>: <span class="hljs-string">&quot;asc&quot;</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>实例2</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs json"># 按距离升序排序，单位<span class="hljs-string">&quot;km&quot;</span><br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;_geo_distance&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;location&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;lat&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">31</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;lon&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">121</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asc&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;unit&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;km&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><blockquote><p>from、size</p></blockquote><p>深度分页问题：</p><blockquote><p>elasticsearch内部分页时，要查990 ~ 1000的这10条，必须先查询 0~1000条，然后截取其中的990 ~ 1000的这10条。当es集群时，若要查前1000的文档，就得先查询所有节点的前1000，再将这些文档重新排名后选出前1000，对于节点有很大压力。</p><p>因此elasticsearch会禁止from+ size 超过10000的请求。</p></blockquote><ul><li><p>实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json"># 从<span class="hljs-number">0</span>号开始查询<span class="hljs-number">20</span>条数据<br>GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;from&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span># 起始值，默认<span class="hljs-number">0</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span># 希望获取的文档总数<br>  <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;asc&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br>  <br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="高亮"><a href="#高亮" class="headerlink" title="高亮"></a>高亮</h4><blockquote><p>highlight</p></blockquote><ul><li><p>实例</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /hotel/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;如家&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;highlight&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;require_field_match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;false&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>注意：</strong></p><ul><li>高亮是对关键字高亮，因此<strong>搜索条件必须带有关键字</strong>，而不能是范围这样的查询。</li><li>默认情况下，<strong>高亮的字段，必须与搜索指定的字段一致</strong>，否则无法高亮</li><li>如果要对非搜索字段高亮，则需要添加一个属性：required_field_match&#x3D;false</li></ul></li></ul><h3 id="RestAPI查询"><a href="#RestAPI查询" class="headerlink" title="RestAPI查询"></a>RestAPI查询</h3><blockquote><p>不一样的地方就QueryBuilders的查询条件</p></blockquote><h4 id="查询所有-1"><a href="#查询所有-1" class="headerlink" title="查询所有"></a>查询所有</h4><ul><li>matchAllQuery实例</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 查询所有</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMatchAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.matchAllQuery());<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 解析结果</span><br><span class="hljs-comment">* <span class="hljs-doctag">@param</span> response</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handResponse</span><span class="hljs-params">(SearchResponse response)</span> &#123;<br>    <span class="hljs-comment">//解析结果</span><br>    <span class="hljs-type">SearchHits</span> <span class="hljs-variable">searchHits</span> <span class="hljs-operator">=</span> response.getHits();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> searchHits.getTotalHits().value; <span class="hljs-comment">//获取结果总数</span><br>    SearchHit[] hits = searchHits.getHits();    <span class="hljs-comment">//获取结果集</span><br>    System.out.println(<span class="hljs-string">&quot;结果数: &quot;</span> + value);<br>    <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>        <span class="hljs-type">HotelDoc</span> <span class="hljs-variable">hotelDoc</span> <span class="hljs-operator">=</span> JSON.parseObject(json, HotelDoc.class);<br>        System.out.println(hotelDoc);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="/img/weifuwu_img/%E6%9F%A5%E8%AF%A2%E6%89%80%E6%9C%89%E7%BB%93%E6%9E%9C.png" alt="查询所有结果"></p><p>解析响应结果，就是逐层解析JSON字符串，流程如下：</p><ul><li><code>searchHits</code>：通过response.getHits()获取，就是JSON中的最外层的hits，代表命中的结果<ul><li><code>SearchHits#getTotalHits().value</code>：获取总条数信息</li><li><code>SearchHits#getHits()</code>：获取SearchHit数组，也就是文档数组<ul><li><code>SearchHit#getSourceAsString()</code>：获取文档结果中的_source，也就是原始的json文档数据</li></ul></li></ul></li></ul><h4 id="全文检索查询-1"><a href="#全文检索查询-1" class="headerlink" title="全文检索查询"></a>全文检索查询</h4><ul><li><p>matchQuery实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;all&quot;</span>, <span class="hljs-string">&quot;如家&quot;</span>));<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>multiMatchQuery实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testMultiMatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;如家&quot;</span>, <br>                                                         <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;business&quot;</span>));<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="精准查询-1"><a href="#精准查询-1" class="headerlink" title="精准查询"></a>精准查询</h4><ul><li><p>termQuery实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTerm</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.termQuery(<span class="hljs-string">&quot;city&quot;</span>, <span class="hljs-string">&quot;上海&quot;</span>));<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>rangeQuery实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTerm</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>)<br>                           .gte(<span class="hljs-number">100</span>)<br>                           .lte(<span class="hljs-number">150</span>));<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="复合查询-1"><a href="#复合查询-1" class="headerlink" title="复合查询"></a>复合查询</h4><ul><li><p>boolQuery实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.boolQuery()<br>                           .must(QueryBuilders.termQuery(<span class="hljs-string">&quot;city&quot;</span>, <span class="hljs-string">&quot;上海&quot;</span>))<br>                           .filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).lte(<span class="hljs-number">200</span>)));<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="排序-1"><a href="#排序-1" class="headerlink" title="排序"></a>排序</h4><ul><li><p>sort实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSort</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().sort(<span class="hljs-string">&quot;price&quot;</span>, SortOrder.DESC);<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="分页-1"><a href="#分页-1" class="headerlink" title="分页"></a>分页</h4><ul><li><p>from、size实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, size = <span class="hljs-number">4</span>;<br><br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().from((page - <span class="hljs-number">1</span>) * size).size(size);<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="高亮-1"><a href="#高亮-1" class="headerlink" title="高亮"></a>高亮</h4><ul><li><p>highlighter实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testHighlight</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">//创建request请求对象</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;hotel&quot;</span>);<br>    <span class="hljs-comment">//组织DSL参数</span><br>    request.source().query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;all&quot;</span>, <span class="hljs-string">&quot;如家&quot;</span>))<br>        .highlighter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightBuilder</span>().field(<span class="hljs-string">&quot;name&quot;</span>).requireFieldMatch(<span class="hljs-literal">false</span>));<br>    <span class="hljs-comment">//发送查询请求，获取结果</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br>    <span class="hljs-comment">//解析结果</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>结果处理时得获取Highlight里的值</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>消息队列</title>
    <link href="/2022/09/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1/MQ/"/>
    <url>/2022/09/11/%E5%BE%AE%E6%9C%8D%E5%8A%A1/MQ/</url>
    
    <content type="html"><![CDATA[<h2 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h2><blockquote><p>Message Queue</p></blockquote><h3 id="微服务间通讯方式"><a href="#微服务间通讯方式" class="headerlink" title="微服务间通讯方式"></a>微服务间通讯方式</h3><blockquote><p>微服务间通讯有同步和异步两种方式</p></blockquote><table><thead><tr><th></th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>同步调用</td><td>时效性较强，可以立即得到结果</td><td>- 耦合度高<br/>- 性能和吞吐能力下降<br/>- 有额外的资源消耗<br/>- 有级联失败问题</td></tr><tr><td>异步调用</td><td>- 吞吐量提升：无需等待订阅者处理完成，响应更快速<br/>- 故障隔离：服务没有直接调用，不存在级联失败问题<br/>- 调用间没有阻塞，不会造成无效的资源占用<br/>- 耦合度极低，每个服务都可以灵活插拔，可替换<br/>- 流量削峰：不管发布事件的流量波动多大，都由Broker接收，订阅者可以按照自己的速度去处理事件</td><td>- 架构复杂了，业务没有明显的流程线，不好管理<br/>- 需要依赖于Broker的可靠、安全、性能</td></tr></tbody></table><h3 id="常见的MQ实现"><a href="#常见的MQ实现" class="headerlink" title="常见的MQ实现"></a>常见的MQ实现</h3><table><thead><tr><th></th><th><strong>RabbitMQ</strong></th><th><strong>ActiveMQ</strong></th><th><strong>RocketMQ</strong></th><th><strong>Kafka</strong></th></tr></thead><tbody><tr><td>公司&#x2F;社区</td><td>Rabbit</td><td>Apache</td><td>阿里</td><td>Apache</td></tr><tr><td>开发语言</td><td>Erlang</td><td>Java</td><td>Java</td><td>Scala&amp;Java</td></tr><tr><td>协议支持</td><td>AMQP，XMPP，SMTP，STOMP</td><td>OpenWire,STOMP，REST,XMPP,AMQP</td><td>自定义协议</td><td>自定义协议</td></tr><tr><td>可用性</td><td>高</td><td>一般</td><td>高</td><td>高</td></tr><tr><td>单机吞吐量</td><td>一般</td><td>差</td><td>高</td><td>非常高</td></tr><tr><td>消息延迟</td><td>微秒级</td><td>毫秒级</td><td>毫秒级</td><td>毫秒以内</td></tr><tr><td>消息可靠性</td><td>高</td><td>一般</td><td>高</td><td>一般</td></tr></tbody></table><h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><h4 id="通过Docker安装"><a href="#通过Docker安装" class="headerlink" title="通过Docker安装"></a>通过Docker安装</h4><ul><li>选择带有mangement的版本(带有管理界面)安装</li></ul><p><a href="https://hub.docker.com/_/rabbitmq">rabbitmq - Official Image | Docker Hub</a></p><ul><li><p>执行命令启动容器</p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs livescript">docker run <span class="hljs-string">\</span><br> -e RABBITMQ_DEFAULT_USER=root <span class="hljs-string">\</span><br> -e RABBITMQ_DEFAULT_PASS=<span class="hljs-number">123456</span> <span class="hljs-string">\</span><br> --name mq <span class="hljs-string">\</span><br> --hostname mq1 <span class="hljs-string">\</span><br> -p <span class="hljs-number">15672</span>:<span class="hljs-number">15672</span> <span class="hljs-string">\</span><br> -p <span class="hljs-number">5672</span>:<span class="hljs-number">5672</span> <span class="hljs-string">\</span><br> -d <span class="hljs-string">\</span><br> rabbitmq:<span class="hljs-number">3</span>-management<br></code></pre></td></tr></table></figure></li><li><p>通过15672端口打开管理界面</p></li></ul><h4 id="mq基本结构"><a href="#mq基本结构" class="headerlink" title="mq基本结构"></a>mq基本结构</h4><p><img src="/img/weifuwu_img/mq%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png" alt="mq基本结构"></p><p>RabbitMQ中的一些角色：</p><ul><li>publisher：生产者</li><li>consumer：消费者</li><li>exchange个：交换机，负责消息路由</li><li>queue：队列，存储消息</li><li>virtualHost：虚拟主机，隔离不同租户的exchange、queue、消息的隔离</li></ul><h4 id="小案例"><a href="#小案例" class="headerlink" title="小案例"></a>小案例</h4><p>通过rabbitmq来实现消息的返送和接收</p><p><img src="/img/weifuwu_img/%E7%AE%80%E5%8D%95%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E6%A8%A1%E5%9E%8B.png" alt="简单消息队列模型"></p><ul><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PublisherTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSendMessage</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">// 1.建立连接</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.229.128&quot;</span>);<br>        factory.setPort(<span class="hljs-number">5672</span>);<br>        factory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        factory.setUsername(<span class="hljs-string">&quot;root&quot;</span>);<br>        factory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 1.2.建立连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> factory.newConnection();<br><br>        <span class="hljs-comment">// 2.创建通道Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">// 3.创建队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        channel.queueDeclare(queueName, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 4.发送消息</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, rabbitmq!&quot;</span>;<br>        channel.basicPublish(<span class="hljs-string">&quot;&quot;</span>, queueName, <span class="hljs-literal">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">&quot;发送消息成功：【&quot;</span> + message + <span class="hljs-string">&quot;】&quot;</span>);<br><br>        <span class="hljs-comment">// 5.关闭通道和连接</span><br>        channel.close();<br>        connection.close();<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerTest</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException &#123;<br>        <span class="hljs-comment">// 1.建立连接</span><br>        <span class="hljs-type">ConnectionFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionFactory</span>();<br>        <span class="hljs-comment">// 1.1.设置连接参数，分别是：主机名、端口号、vhost、用户名、密码</span><br>        factory.setHost(<span class="hljs-string">&quot;192.168.229.128&quot;</span>);<br>        factory.setPort(<span class="hljs-number">5672</span>);<br>        factory.setVirtualHost(<span class="hljs-string">&quot;/&quot;</span>);<br>        factory.setUsername(<span class="hljs-string">&quot;root&quot;</span>);<br>        factory.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 1.2.建立连接</span><br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> factory.newConnection();<br><br>        <span class="hljs-comment">// 2.创建通道Channel</span><br>        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> connection.createChannel();<br><br>        <span class="hljs-comment">// 3.创建队列</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        channel.queueDeclare(queueName, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 4.订阅消息</span><br>        channel.basicConsume(queueName, <span class="hljs-literal">true</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultConsumer</span>(channel)&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDelivery</span><span class="hljs-params">(String consumerTag, Envelope envelope,</span><br><span class="hljs-params">                                       AMQP.BasicProperties properties, <span class="hljs-type">byte</span>[] body)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                <span class="hljs-comment">// 5.处理消息</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(body);<br>                System.out.println(<span class="hljs-string">&quot;接收到消息：【&quot;</span> + message + <span class="hljs-string">&quot;】&quot;</span>);<br>            &#125;<br>        &#125;);<br>        System.out.println(<span class="hljs-string">&quot;等待接收消息。。。。&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li></ul><h3 id="SpringAMQP"><a href="#SpringAMQP" class="headerlink" title="SpringAMQP"></a>SpringAMQP</h3><blockquote><p>Advanced Message Queuing Protocol(高级消息队列协议)</p><p>SpringAMQP: 基于AMQP定义的一套API规范</p></blockquote><p>SpringAMQP提供了三个功能：</p><ul><li>自动声明队列、交换机及其绑定关系</li><li>基于注解的监听器模式，异步接收消息</li><li>封装了RabbitTemplate工具，用于发送消息</li></ul><h4 id="SimpleQueue-简单队列模型"><a href="#SimpleQueue-简单队列模型" class="headerlink" title="SimpleQueue(简单队列模型)"></a>SimpleQueue(简单队列模型)</h4><blockquote><p>一个生产者和一个消费者</p></blockquote><p>通过SpringAMQP来实现消息的返送和接收</p><ul><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--AMQP依赖，包含RabbitMQ--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure></li><li><p>生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableRabbit</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringAMQPTest</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;#消息队列名<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;testMessage&quot;</span>;#发送的消息<br>        rabbitTemplate.convertAndSend(queueName, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>消费者(同样要导入依赖、编写配置)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//注入一个listener，自动监听队列</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRabbitListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span>#监听的队列名<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerSimpleQueueMessage</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(msg);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//启动项目即可监听队列，有消息自动获取</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="WorkQueue-任务队列模型"><a href="#WorkQueue-任务队列模型" class="headerlink" title="WorkQueue(任务队列模型)"></a>WorkQueue(任务队列模型)</h4><blockquote><p>让<strong>多个消费者</strong>绑定到一个队列，共同消费队列中的消息。</p></blockquote><p><img src="/img/weifuwu_img/workQueue.png" alt="workQueue"></p><ul><li><p>返送多条消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWorkQueue</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//发送50条消息</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; ++i) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;testMessage&quot;</span> + i;<br>        rabbitTemplate.convertAndSend(queueName, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>多个消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerWorkQueueMessage1</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;消费者1接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span> + LocalTime.now());<br>    Thread.sleep(<span class="hljs-number">20</span>);<span class="hljs-comment">//处理快</span><br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerWorkQueueMessage2</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.err.println(<span class="hljs-string">&quot;消费者2........接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span> + LocalTime.now());<br>    Thread.sleep(<span class="hljs-number">200</span>);<span class="hljs-comment">//处理慢</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>如果不配置的话会，消息是平均分配给每个消费者，并没有考虑到消费者的处理能力</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.229</span><span class="hljs-number">.128</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">prefetch:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 每次只能获取一条消息，处理完成才能获取下一个消息</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="发布-x2F-订阅模型"><a href="#发布-x2F-订阅模型" class="headerlink" title="发布&#x2F;订阅模型"></a>发布&#x2F;订阅模型</h4><p><img src="/img/weifuwu_img/%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85%E6%A8%A1%E5%9E%8B.png" alt="发布订阅模型"></p><p>Exchange：交换机。一方面，接收生产者发送的消息。另一方面，知道如何处理消息，例如递交给某个特别队列、递交给所有队列、或是将消息丢弃。到底如何操作，取决于Exchange的类型。<strong>交换机只负责转发消息，不具备存储消息的能力</strong>。Exchange有以下<strong>3</strong>种类型：</p><ul><li>Fanout：广播，将消息交给所有绑定到交换机的队列</li><li>Direct：定向，把消息交给符合指定routing key 的队列</li><li>Topic：通配符，把消息交给符合routing pattern（路由模式） 的队列</li></ul><p><strong>Fanout交换机</strong></p><blockquote><p>消息会通过交换机<strong>广播</strong>到所有绑定队列</p></blockquote><ul><li>声明队列和交换机</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FanoutConfig</span> &#123;<br>    <span class="hljs-comment">//声明交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FanoutExchange <span class="hljs-title function_">fanoutExchange</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FanoutExchange</span>(<span class="hljs-string">&quot;test.fanout&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列1</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue1</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;fanout.queue1&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//声明队列2</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">queue2</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;fanout.queue2&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//绑定交换机和队列1</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindingQueue1</span><span class="hljs-params">(Queue queue1, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue1).to(fanoutExchange);<br>    &#125;<br><br>    <span class="hljs-comment">//绑定交换机和队列2</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">bindingQueue2</span><span class="hljs-params">(Queue queue2, FanoutExchange fanoutExchange)</span> &#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue2).to(fanoutExchange);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><p>声明生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFanoutExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//发送到交换机</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test.fanout&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;testMessage&quot;</span>;<br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>声明消费者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRabbitListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(queues = &quot;fanout.queue1&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerWorkQueueMessage1</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者1接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;fanout.queue2&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerWorkQueueMessage2</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.err.println(<span class="hljs-string">&quot;消费者2........接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>Direct交换机</strong></p><blockquote><p>通过key<strong>定向</strong>向队列发送消息</p></blockquote><ul><li><p>通过注解在listener上声明队列和交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRabbitListener</span> &#123;<br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            value = @Queue(name = &quot;direct.queue1&quot;), //绑定队列</span><br><span class="hljs-meta">            exchange = @Exchange(name = &quot;test.direct&quot;, type = ExchangeTypes.DIRECT),    //绑定交换机</span><br><span class="hljs-meta">            key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;   //绑定key,只有队列有和消息相同的key时，才会收到消息</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerDirectQueue1</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者1接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">            value = @Queue(name = &quot;direct.queue2&quot;), //绑定队列</span><br><span class="hljs-meta">            exchange = @Exchange(name = &quot;test.direct&quot;, type = ExchangeTypes.DIRECT),    //绑定交换机</span><br><span class="hljs-meta">            key = &#123;&quot;red&quot;, &quot;yellow&quot;&#125;   //绑定key,只有队列有和消息相同的key时，才会收到消息</span><br><span class="hljs-meta">    ))</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerDirectQueue2</span><span class="hljs-params">(String msg)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;消费者2接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDirectExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//发送到交换机</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test.direct&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;testMessage&quot;</span>;<br>    <span class="hljs-comment">//只有有&quot;yellow&quot;的队列会收到消息</span><br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;yellow&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>Topic</strong></p><blockquote><p>通过<strong>通配符</strong>#(一个或多个)和.(一个)来匹配队列</p></blockquote><ul><li><p>通过注解在listener上声明队列和交换机</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//话题交换机</span><br><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">    value = @Queue(name = &quot;topic.queue1&quot;), //绑定队列</span><br><span class="hljs-meta">    exchange = @Exchange(name = &quot;test.topic&quot;, type = ExchangeTypes.TOPIC),    //绑定交换机</span><br><span class="hljs-meta">    key = &quot;china.#&quot;   //绑定通配符,只有满足格式的消息，才会接收</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerTopicQueue1</span><span class="hljs-params">(String msg)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;消费者1接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">    value = @Queue(name = &quot;topic.queue2&quot;), //绑定队列</span><br><span class="hljs-meta">    exchange = @Exchange(name = &quot;test.topic&quot;, type = ExchangeTypes.TOPIC),    //绑定交换机</span><br><span class="hljs-meta">    key = &quot;#.news&quot;   //绑定通配符,只有满足格式的消息，才会接收</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenerTopicQueue2</span><span class="hljs-params">(String msg)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;消费者2接收到消息：【&quot;</span> + msg + <span class="hljs-string">&quot;】&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>发送消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testTopicExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//发送到交换机</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;test.topic&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;testMessage&quot;</span>;<br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;china.weather&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h4 id="配置消息转换器"><a href="#配置消息转换器" class="headerlink" title="配置消息转换器"></a>配置消息转换器</h4><ul><li><p>导入jackson转换器依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--jackson消息转换器--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>声明转换器来替换原有的转换器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Docker</title>
    <link href="/2022/09/09/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Docker/"/>
    <url>/2022/09/09/%E5%BE%AE%E6%9C%8D%E5%8A%A1/Docker/</url>
    
    <content type="html"><![CDATA[<h2 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h2><h3 id="Docker作用"><a href="#Docker作用" class="headerlink" title="Docker作用"></a>Docker作用</h3><p>大型项目组件较多，运行环境也较为复杂，部署时所需要的函数库、依赖项各不相同，甚至会有冲突。给部署带来了极大的困难</p><p>Docker为了解决依赖的兼容问题的，采用了两个手段：</p><ul><li><p>将应用的Libs（函数库）、Deps（依赖）、配置与应用一起打包</p></li><li><p>将每个应用放到一个隔离<strong>容器</strong>去运行，避免互相干扰</p></li></ul><h3 id="Docker架构"><a href="#Docker架构" class="headerlink" title="Docker架构"></a>Docker架构</h3><p>概念：</p><ul><li><p><strong>镜像（Image）</strong>：Docker将应用程序及其所需的依赖、函数库、环境、配置等文件打包在一起，称为镜像。</p></li><li><p><strong>容器（Container）</strong>：镜像中的应用程序运行后形成的进程就是<strong>容器</strong>，只是Docker会给容器进程做隔离，对外不可见。</p></li><li><p><strong>DockerHub</strong>：DockerHub是一个官方的Docker镜像的托管平台。这样的平台称为Docker Registry。</p></li></ul><p>Docker是一个CS架构的程序，由两部分组成：</p><ul><li><strong>服务端</strong>(server)：Docker守护进程，负责处理Docker指令，管理镜像、容器等</li><li><strong>客户端</strong>(client)：通过命令或RestAPI向Docker服务端发送指令。可以在本地或远程向服务端发送指令。</li></ul><h3 id="安装Docket（CentOS8）"><a href="#安装Docket（CentOS8）" class="headerlink" title="安装Docket（CentOS8）"></a>安装Docket（CentOS8）</h3><p><a href="https://developer.aliyun.com/article/753261">CentOS8 安装 Docker-阿里云开发者社区 (aliyun.com)</a></p><ol><li><p>卸载老版本Docket</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs linux">yum remove docker \<br>                  docker-client \<br>                  docker-client-latest \<br>                  docker-common \<br>                  docker-latest \<br>                  docker-latest-logrotate \<br>                  docker-logrotate \<br>                  docker-engine<br></code></pre></td></tr></table></figure></li><li><p>安装docket基础包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs linux">yum install -y yum-utils \<br>  device-mapper-persistent-data \<br>  lvm2<br></code></pre></td></tr></table></figure></li><li><p>设置国内仓库</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs linux">yum-config-manager \<br>    --add-repo \<br>    https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br></code></pre></td></tr></table></figure></li><li><p>安装Docket社区版</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">yum install --allowerasing docker-ce<br></code></pre></td></tr></table></figure></li><li><p>启动docket</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs linux">Docker应用需要用到各种端口，逐一去修改防火墙设置。非常麻烦<br>启动docker前，建议关闭防火墙<br># 关闭<br>systemctl stop firewalld<br># 禁止开机启动防火墙<br>systemctl disable firewalld<br><br>sudo systemctl start docker  # 启动docker<br>docker run hello-world  #测试<br></code></pre></td></tr></table></figure></li><li><p>配置国内镜像源</p><p><a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors">容器镜像服务 (aliyun.com)</a></p></li></ol><h3 id="Docker命令"><a href="#Docker命令" class="headerlink" title="Docker命令"></a>Docker命令</h3><h4 id="镜像相关"><a href="#镜像相关" class="headerlink" title="镜像相关"></a>镜像相关</h4><ul><li><p>拉取镜像</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs linux">docker pull 镜像名:版本<br># 没加版本默认latest(最近的)<br></code></pre></td></tr></table></figure></li><li><p>查看镜像</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">docker images<br></code></pre></td></tr></table></figure></li><li><p>通过–help来查看提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">docker save --help<br></code></pre></td></tr></table></figure></li><li><p>删除镜像</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">docker</span> rmi 镜像名:版本<br></code></pre></td></tr></table></figure></li><li><p>保存&#x2F;导入镜像</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs linux"># 保存镜像到tar<br>docker save -o nginx.tar nginx:latest<br># 导入镜像<br>docker load -i nginx.tar<br></code></pre></td></tr></table></figure></li></ul><h4 id="容器相关"><a href="#容器相关" class="headerlink" title="容器相关"></a>容器相关</h4><ul><li><p>创建并运行容器</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run --name 给容器起名 -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -d nginx<br></code></pre></td></tr></table></figure></li><li><p>运行&#x2F;停止容器</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">docker <span class="hljs-literal">start</span>/<span class="hljs-literal">stop</span> 容器名<br></code></pre></td></tr></table></figure></li><li><p>查看正在运行的容器</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell">docker <span class="hljs-built_in">ps</span><br><br>docker <span class="hljs-built_in">ps</span> <span class="hljs-literal">-a</span> <span class="hljs-comment">#查看所有容器</span><br></code></pre></td></tr></table></figure></li><li><p>查看容器日志</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">docker</span> logs 容器名<br></code></pre></td></tr></table></figure></li><li><p>进入&#x2F;退出容器</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker exec -it 容器名 bash<br><br><span class="hljs-keyword">exit</span> <span class="hljs-comment"># 退出容器</span><br></code></pre></td></tr></table></figure><ul><li>docker exec ：进入容器内部，执行一个命令</li><li>-it : 给当前进入的容器创建一个标准输入、输出终端，允许我们与容器交互</li><li>bash：进入容器后执行的命令，bash是一个linux终端交互命令</li></ul></li><li><p>删除容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">rm</span> 容器名<br></code></pre></td></tr></table></figure></li></ul><h4 id="Dockerfile自定义镜像"><a href="#Dockerfile自定义镜像" class="headerlink" title="Dockerfile自定义镜像"></a>Dockerfile自定义镜像</h4><p>镜像组成结构</p><p><img src="/img/weifuwu_img/%E9%95%9C%E5%83%8F%E7%BB%84%E6%88%90%E7%BB%93%E6%9E%84.png"></p><p>Dockerfile指令是一个文本文件，其中包含一个个的**指令(Instruction)**，用指令来说明要执行什么操作来构建镜像。每一个指令都会形成一层Layer</p><p>官网文档 <a href="https://docs.docker.com/engine/reference/builder">https://docs.docker.com/engine/reference/builder</a></p><p> Dockerfile示例</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 指定基础镜像</span><br><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">16.04</span><br><span class="hljs-comment"># 配置环境变量，JDK的安装目录</span><br><span class="hljs-keyword">ENV</span> JAVA_DIR=/usr/local<br><br><span class="hljs-comment"># 拷贝jdk和java项目的包</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./jdk8.tar.gz <span class="hljs-variable">$JAVA_DIR</span>/</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./docker-demo.jar /tmp/app.jar</span><br><br><span class="hljs-comment"># 安装JDK</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JAVA_DIR</span> \</span><br><span class="language-bash"> &amp;&amp; tar -xf ./jdk8.tar.gz \</span><br><span class="language-bash"> &amp;&amp; <span class="hljs-built_in">mv</span> ./jdk1.8.0_144 ./java8</span><br><br><span class="hljs-comment"># 配置环境变量</span><br><span class="hljs-keyword">ENV</span> JAVA_HOME=$JAVA_DIR/java8<br><span class="hljs-keyword">ENV</span> PATH=$PATH:$JAVA_HOME/bin<br><br><span class="hljs-comment"># 暴露端口</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8090</span><br><span class="hljs-comment"># 入口，java项目的启动命令</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> java -jar /tmp/app.jar</span><br></code></pre></td></tr></table></figure><p>构建镜像命令</p><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs erlang">docker build -t 镜像名称:版本 .<br></code></pre></td></tr></table></figure><h3 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h3><blockquote><p><strong>数据卷（volume）</strong>是一个虚拟目录，指向宿主机文件系统中的某个目录</p><p>创建的数据卷会保存在&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;目录下</p><p>通过容器和数据卷的挂载(绑定)，就能在外部操作容器内的目录了</p></blockquote><h4 id="数据卷基本命令"><a href="#数据卷基本命令" class="headerlink" title="数据卷基本命令"></a>数据卷基本命令</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stata">[root@root ~]# docker volume --<span class="hljs-keyword">help</span><br><br>Usage:  docker volume COMMAND<br><br>Manage volumes<br><br>Commands:<br>  create      创建数据卷<br>  <span class="hljs-keyword">inspect</span>     查看一个数据卷详细信息<br>  <span class="hljs-keyword">ls</span>          查看所有数据卷<br>  prune       删除所有未使用的数据卷<br>  <span class="hljs-keyword">rm</span>          - 删除指定数据卷<br><br></code></pre></td></tr></table></figure><h4 id="挂载数据卷"><a href="#挂载数据卷" class="headerlink" title="挂载数据卷"></a>挂载数据卷</h4><p>例子：</p><ol><li><p>创建创建容器并挂载数据卷到容器内的HTML目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run --name mynginx -v html:<span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/nginx/</span>html -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -d nginx<br></code></pre></td></tr></table></figure><p><code>-v html:/usr/share/nginx/html</code>: 创建html数据卷并把容器中的&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html挂载上</p></li><li><p>查看html数据卷位置</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker volume inspect html<br><span class="hljs-comment"># 进入该目录</span><br>cd <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/docker/</span>volumes<span class="hljs-regexp">/html/</span>_data<br><span class="hljs-comment"># 修改文件</span><br>vi index.html<br></code></pre></td></tr></table></figure></li></ol><h4 id="挂载自定义的本地目录"><a href="#挂载自定义的本地目录" class="headerlink" title="挂载自定义的本地目录"></a>挂载自定义的本地目录</h4><blockquote><p>容器不仅仅可以挂载数据卷，也可以直接挂载到宿主机目录上</p><ul><li>带数据卷模式：宿主机目录 –&gt; 数据卷 —&gt; 容器内目录</li><li>直接挂载模式：宿主机目录 —&gt; 容器内目录</li></ul></blockquote><p>例子: 给mysql挂载到本地目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker run \<br>--name mysql \<br>-e MYSQL_ROOT_PASSWORD=<span class="hljs-number">123456</span> \<span class="hljs-comment">#数据库密码</span><br>-p <span class="hljs-number">3307</span>:<span class="hljs-number">3306</span> \<span class="hljs-comment">#宿主机端口:容器端口</span><br>-v <span class="hljs-regexp">/tmp/my</span>sql<span class="hljs-regexp">/conf/</span>hmy.cnf:<span class="hljs-regexp">/etc/my</span>sql<span class="hljs-regexp">/conf.d/</span>hmy.cnf \<span class="hljs-comment">#宿主机文件:容器内文件</span><br>-v <span class="hljs-regexp">/tmp/my</span>sql<span class="hljs-regexp">/data:/</span>var<span class="hljs-regexp">/lib/my</span>sql \<span class="hljs-comment">#宿主机目录:容器内目录</span><br>-d mysql:<span class="hljs-number">5.7</span>.<span class="hljs-number">25</span><br></code></pre></td></tr></table></figure><p>数据卷挂载与目录直接挂载的</p><ul><li>数据卷挂载耦合度低，由docker来管理目录，但是目录较深，不好找</li><li>目录挂载耦合度高，需要我们自己管理目录，不过目录容易寻找查看</li></ul><h3 id="DockerCompose容器编排"><a href="#DockerCompose容器编排" class="headerlink" title="DockerCompose容器编排"></a>DockerCompose容器编排</h3><blockquote><p>Docker Compose可以基于Compose文件帮我们一键部署和启动多个容器，而无需手动一个个创建和运行容器</p></blockquote><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">sudo curl -L <span class="hljs-string">&quot;https://github.com/docker/compose/releases/download/1.29.0/docker-compose-$(uname -s)-$(uname -m)&quot;</span> -o <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br> <br><span class="hljs-comment">#修改文件权限</span><br>sudo chmod +x <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br></code></pre></td></tr></table></figure><p>Base自动补全命令</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 补全命令</span><br>curl -L https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/docker/</span>compose<span class="hljs-regexp">/1.29.1/</span>contrib<span class="hljs-regexp">/completion/</span>bash<span class="hljs-regexp">/docker-compose &gt; /</span>etc<span class="hljs-regexp">/bash_completion.d/</span>docker-compose<br></code></pre></td></tr></table></figure><h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs linux"># 以部署wordpress为例<br><br># 创建一个文件夹用于存放compose文件<br>mkdir /home/wordpress<br>cd wordpress<br><br># 将dockerhub中wordpress的compose文件复制进来<br>vim docker-compose.yml<br><br># 创建启动（后台）<br>docker compose up -d<br><br># 查看启动的容器<br>docker compose ps<br><br># 停止容器<br>docker compose stop<br><br># 启动<br>docker compose start<br><br># 删除容器（数据卷不会一起被删）<br>docker compose down<br><br># 查看日志<br>docker compose logs -f<br><br></code></pre></td></tr></table></figure><h3 id="Docker网络命令"><a href="#Docker网络命令" class="headerlink" title="Docker网络命令"></a>Docker网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs linux"># bridge网络<br># 不指定网络时，新创建的容器默认将连接到bridge网络上<br># 容器之间只能通过ip通讯，ip会随启动顺序而变化，因此不推荐<br><br># 查看容器ip<br>docker inspect \<br>--format=&#x27;&#123;&#123;range.NetworkSettings.Networks&#125;&#125;&#123;&#123;.IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27; 容器名字<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs linux"># 用户自定义网络<br># 容器之间可以通过容器名进行访问<br># docker会通过嵌入式DNS服务器将容器名解析成IP<br><br># 创建自定义网络<br>docker network create 网络名<br><br># 将已有容器连接到此网络<br>docker network connect 网络名 容器名<br><br># 断开容器和网络的连接<br>docker network disconnect 网络名 容器名<br><br># 创建容器时指定网络（mysql为例）<br>docker run -it --rm --network 网络名 容器名 mysql:5.7 mysql -h容器名 -u用户名 -p密码<br></code></pre></td></tr></table></figure><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>相当于启动应用的一系列操作的集合,打包成一个镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> openjdk:<span class="hljs-number">8</span>u342-jre<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./ruoyi-admin.jar .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> make .</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;ruoyi-admin.jar&quot;</span>]</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure><ul><li>FROM：基础镜像</li><li>WORKDIR：相当于cd，进入工作目录</li><li>COPY：将宿主机的文件复制到容器中</li><li>RUN：打包时执行的命令</li><li>CMD：运行镜像时执行的命令</li><li>EXPOSE：监听的端口</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs linux"># 构建镜像<br>docker build dockerfile所在路径<br><br># 指定镜像名称、版本号<br>docker tag 镜像id 名称:版本<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Spring Cloud</title>
    <link href="/2022/09/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud/"/>
    <url>/2022/09/03/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud/</url>
    
    <content type="html"><![CDATA[<h2 id="Spring-Cloud"><a href="#Spring-Cloud" class="headerlink" title="Spring Cloud"></a>Spring Cloud</h2><h4 id="RestTemplate"><a href="#RestTemplate" class="headerlink" title="RestTemplate"></a>RestTemplate</h4><blockquote><p>RestTemplate是一个HTTP客户端，使用它我们可以方便的调用HTTP接口，支持GET、POST、PUT、DELETE等方法。</p></blockquote><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>1.注册RestTemplate实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>2.通过restTemplate发送http来远程调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">queryOrderById</span><span class="hljs-params">(Long orderId)</span> &#123;<br>    <span class="hljs-comment">// 查询订单</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.findById(orderId);<br>    <span class="hljs-comment">// 用restTemplate发送get请求查询user信息</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://localhost:8081/user/&quot;</span> + order.getUserId();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(url, User.class);<br>    order.setUser(user);<br>    <span class="hljs-comment">// 返回</span><br>    <span class="hljs-keyword">return</span> order;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Eureka注册中心"><a href="#Eureka注册中心" class="headerlink" title="Eureka注册中心"></a>Eureka注册中心</h4><blockquote><p>注册中心：在微服务架构中往往会有一个注册中心，每个微服务都会向注册中心去注册自己的地址及端口信息，注册中心维护着服务名称与服务实例的对应关系。每个微服务都会定时从注册中心获取服务列表，同时汇报自己的运行情况，这样当有的服务需要调用其他服务时，就可以从自己获取到的服务列表中获取实例地址进行调用</p></blockquote><h5 id="Eureka架构中的三个角色"><a href="#Eureka架构中的三个角色" class="headerlink" title="Eureka架构中的三个角色"></a>Eureka架构中的三个角色</h5><ul><li>服务注册中心</li></ul><p>Eureka的服务端应用，提供服务注册和发现功能</p><ul><li>服务提供者</li></ul><p>提供服务的应用，可以是SpringBoot应用，也可以是其它任意技术实现，只要对外提供的是Rest风格服务即可。</p><ul><li>服务消费者</li></ul><p>消费应用从注册中心获取服务列表，从而得知每个服务方的信息，知道去哪里调用服务方。</p><h5 id="搭建Eureka"><a href="#搭建Eureka" class="headerlink" title="搭建Eureka"></a>搭建Eureka</h5><h6 id="创建服务端"><a href="#创建服务端" class="headerlink" title="创建服务端"></a>创建服务端</h6><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2021.0.6<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在启动类上加@EnableEurekaServer注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableEurekaServer</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(EurekaApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>编写配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-server</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">instance:</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span> <span class="hljs-comment">#指定主机地址</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#指定是否要从注册中心获取服务（注册中心不需要开启）</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#指定是否要注册到注册中心（注册中心不需要开启）</span><br>  <span class="hljs-attr">server:</span><br>    <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭保护模式</span><br></code></pre></td></tr></table></figure></li><li><p>通过<code>localhost:8081</code>访问注册中心界面</p></li></ol><h6 id="创建客户端"><a href="#创建客户端" class="headerlink" title="创建客户端"></a>创建客户端</h6><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2021.0.6<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在启动类上加@EnableEurekaClient注解</p></li><li><p>编写配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span> <span class="hljs-comment">#运行端口号</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eureka-client</span> <span class="hljs-comment">#服务名称</span><br><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#注册到Eureka的注册中心</span><br>    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#获取注册实例列表</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8081/eureka/</span> <span class="hljs-comment">#配置注册中心地址</span><br></code></pre></td></tr></table></figure></li></ol><h6 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h6><ol><li><p>在注册RestTemplate上加上@LoadTemplate注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@LoadBalanced</span><br><span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>请求的url中用服务名称替换ip</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> RestTemplate restTemplate;<br><br><span class="hljs-keyword">public</span> Order <span class="hljs-title function_">queryOrderById</span><span class="hljs-params">(Long orderId)</span> &#123;<br>    <span class="hljs-comment">// 1.查询订单</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.findById(orderId);<br>    <span class="hljs-comment">//用restTemplate发送http请求查询user信息</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;http://userservice/user/&quot;</span> + order.getUserId();<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(url, User.class);<br>    order.setUser(user);<br>    <span class="hljs-comment">// 4.返回</span><br>    <span class="hljs-keyword">return</span> order;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">eureka:</span><br>  <span class="hljs-attr">client:</span> <span class="hljs-comment">#eureka客户端配置</span><br>    <span class="hljs-attr">register-with-eureka:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否将自己注册到eureka服务端上去</span><br>    <span class="hljs-attr">fetch-registry:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#是否获取eureka服务端上注册的服务列表</span><br>    <span class="hljs-attr">service-url:</span><br>      <span class="hljs-attr">defaultZone:</span> <span class="hljs-string">http://localhost:8001/eureka/</span> <span class="hljs-comment"># 指定注册中心地址</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 启用eureka客户端</span><br>    <span class="hljs-attr">registry-fetch-interval-seconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment">#定义去eureka服务端获取服务列表的时间间隔</span><br>  <span class="hljs-attr">instance:</span> <span class="hljs-comment">#eureka客户端实例配置</span><br>    <span class="hljs-attr">lease-renewal-interval-in-seconds:</span> <span class="hljs-number">30</span> <span class="hljs-comment">#定义服务多久去注册中心续约</span><br>    <span class="hljs-attr">lease-expiration-duration-in-seconds:</span> <span class="hljs-number">90</span> <span class="hljs-comment">#定义服务多久不去续约认为服务失效</span><br>    <span class="hljs-attr">metadata-map:</span><br>      <span class="hljs-attr">zone:</span> <span class="hljs-string">jiangsu</span> <span class="hljs-comment">#所在区域</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">localhost</span> <span class="hljs-comment">#服务主机名称</span><br>    <span class="hljs-attr">prefer-ip-address:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否优先使用ip来作为主机名</span><br>  <span class="hljs-attr">server:</span> <span class="hljs-comment">#eureka服务端配置</span><br>    <span class="hljs-attr">enable-self-preservation:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#关闭eureka服务端的保护机制</span><br></code></pre></td></tr></table></figure><h4 id="Ribbon负载均衡"><a href="#Ribbon负载均衡" class="headerlink" title="Ribbon负载均衡"></a>Ribbon负载均衡</h4><blockquote><p>负载均衡可以增加系统的可用性和扩展性</p><p>在注入RestTemplate时加上@LoadBalanced注解开启负载均衡</p></blockquote><p><img src="/img/weifuwu_img/image-20210713224517686.png" alt="image-20210713224517686"></p><p><img src="/img/weifuwu_img/image-20210713224724673.png" alt="image-20210713224724673"></p><p>流程</p><ul><li>LoadBalanceInterceptor拦截器获取请求，RibbonLoadBalancerClient从url中获取服务名称</li><li>DynamicServerListLoadBalancer根据服务名称拉取eureka服务列表</li><li>IRule根据负载均衡策略选取一个</li><li>RibbonLoadBalancerClient将url中的服务名称替换为ip端口，再发起请求</li></ul><h5 id="自定义负载均衡策略"><a href="#自定义负载均衡策略" class="headerlink" title="自定义负载均衡策略"></a>自定义负载均衡策略</h5><blockquote><p>一般使用默认策略(ZoneAvoidanceRule)</p></blockquote><p>方式一(全局)</p><ul><li>导入坐标</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2021.0.6<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-ribbon<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>注册IRule</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> IRule <span class="hljs-title function_">randomRule</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomRule</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>方式二(局部)</p><ul><li>在application.yml中添加配置</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">userservice:</span>  <span class="hljs-comment">#指定服务名称</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span> <span class="hljs-comment"># 负载均衡规则</span><br></code></pre></td></tr></table></figure><h5 id="开启饥饿加载"><a href="#开启饥饿加载" class="headerlink" title="开启饥饿加载"></a>开启饥饿加载</h5><blockquote><p> Ribbon默认是采用懒加载，即第一次访问时才会去创建LoadBalanceClient，请求时间会很长。</p><p>而饥饿加载则会在项目启动时创建，降低第一次访问的耗时</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">eager-load:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">clients:</span> <span class="hljs-string">userservice</span><span class="hljs-comment">#加载的客户端</span><br></code></pre></td></tr></table></figure><h5 id="常用配置-1"><a href="#常用配置-1" class="headerlink" title="常用配置"></a>常用配置</h5><blockquote><p>此为全局配置，局部配置要<code>服务名:ribbon</code>下配置</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ribbon:</span><br>  <span class="hljs-attr">ConnectTimeout:</span> <span class="hljs-number">1000</span> <span class="hljs-comment">#服务请求连接超时时间（毫秒）</span><br>  <span class="hljs-attr">ReadTimeout:</span> <span class="hljs-number">3000</span> <span class="hljs-comment">#服务请求处理超时时间（毫秒）</span><br>  <span class="hljs-attr">OkToRetryOnAllOperations:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#对超时请求启用重试机制</span><br>  <span class="hljs-attr">MaxAutoRetriesNextServer:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#切换重试实例的最大个数</span><br>  <span class="hljs-attr">MaxAutoRetries:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 切换实例后重试最大次数</span><br>  <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.netflix.loadbalancer.RandomRule</span> <span class="hljs-comment">#修改负载均衡算法</span><br></code></pre></td></tr></table></figure><h4 id="Nacos注册中心"><a href="#Nacos注册中心" class="headerlink" title="Nacos注册中心"></a>Nacos注册中心</h4><h5 id="windows安装"><a href="#windows安装" class="headerlink" title="windows安装"></a>windows安装</h5><ul><li><p>下载   <a href="https://github.com/alibaba/nacos">github</a></p></li><li><p>解压</p></li><li><p>bin目录下运行startup.cmd</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">startup.<span class="hljs-built_in">cmd</span> -m standalone<br></code></pre></td></tr></table></figure></li><li><p>默认账号密码nacos</p></li><li><p>访问<code>http://localhost:8848/nacos</code></p></li></ul><h5 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h5><ul><li><p>父工程导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--alibaba依赖管理--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>项目中导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacos服务发现--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span> <br>    <span class="hljs-attr">application:</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">userservice</span><br>    <span class="hljs-attr">cloud:</span><br>        <span class="hljs-attr">nacos:</span><br>          <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h5><p><img src="/img/weifuwu_img/image-20210713232522531.png" alt="image-20210713232522531"></p><ul><li><p>修改配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span> <span class="hljs-comment"># 集群名称</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="同集群优先的负载均衡"><a href="#同集群优先的负载均衡" class="headerlink" title="同集群优先的负载均衡"></a>同集群优先的负载均衡</h5><blockquote><p>Nacos中提供了一个<code>NacosRule</code>的实现，可以优先从同集群中挑选实例</p></blockquote><ul><li><p>修改配置文件application.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">userservice:</span><span class="hljs-comment">#服务名称</span><br>  <span class="hljs-attr">ribbon:</span><br>    <span class="hljs-attr">NFLoadBalancerRuleClassName:</span> <span class="hljs-string">com.alibaba.cloud.nacos.ribbon.NacosRule</span> <span class="hljs-comment"># 负载均衡规则 </span><br></code></pre></td></tr></table></figure></li></ul><h5 id="权重优先的负载均衡"><a href="#权重优先的负载均衡" class="headerlink" title="权重优先的负载均衡"></a>权重优先的负载均衡</h5><blockquote><p>权重越高，优先级越高</p></blockquote><p><img src="/img/weifuwu_img/%E6%9D%83%E9%87%8D.png" alt="权重"></p><ul><li>通过编辑来设置权重</li></ul><h5 id="给微服务配置namespace"><a href="#给微服务配置namespace" class="headerlink" title="给微服务配置namespace"></a>给微服务配置namespace</h5><blockquote><p>只有同一个命名空间的服务才能访问</p><p>通过namespace来实现环境隔离功能</p></blockquote><ul><li>通过控制台来创建命名空间</li></ul><p><img src="/img/weifuwu_img/%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4.png" alt="命名空间"></p><ul><li><p>配置文件中设置所在的命名空间</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">cluster-name:</span> <span class="hljs-string">HZ</span> <span class="hljs-comment"># 集群名称</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">c36cee20-482c-4675-a115-5e84b8f53882</span> <span class="hljs-comment">#命名空间</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="设置实例类型"><a href="#设置实例类型" class="headerlink" title="设置实例类型"></a>设置实例类型</h5><blockquote><p>实例分为临时实例和非临时实例</p><p>临时实例：如果实例宕机超过一定时间，会从服务列表剔除，默认的类型</p><p>非临时实例：如果实例宕机，不会从服务列表剔除，也可以叫永久实例</p></blockquote><p>设置为非临时实例</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">ephemeral:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 设置为非临时实例</span><br></code></pre></td></tr></table></figure><h4 id="Nacos和Eureka比较"><a href="#Nacos和Eureka比较" class="headerlink" title="Nacos和Eureka比较"></a>Nacos和Eureka比较</h4><ul><li>Nacos与eureka的共同点<ul><li>都支持服务注册和服务拉取</li><li>都支持服务提供者心跳方式做健康检测</li></ul></li><li>Nacos与Eureka的区别<ul><li>Nacos支持服务端主动检测提供者状态：临时实例采用心跳模式，非临时实例采用主动检测模式</li><li>Nacos临时实例心跳不正常会被剔除，非临时实例不会被剔除</li><li>Nacos支持服务列表变更的消息推送模式，服务列表更新更及时</li><li>Nacos集群默认采用AP方式(高可用)，当集群中存在非临时实例时，采用CP模式(强一致)；Eureka采用AP方式</li></ul></li></ul><h4 id="Nacos配置管理"><a href="#Nacos配置管理" class="headerlink" title="Nacos配置管理"></a>Nacos配置管理</h4><h5 id="在nacos中添加配置"><a href="#在nacos中添加配置" class="headerlink" title="在nacos中添加配置"></a>在nacos中添加配置</h5><blockquote><p>项目的核心配置，需要热更新的配置才有放到nacos管理的必要</p></blockquote><p><img src="/img/weifuwu_img/%E7%BB%9F%E4%B8%80%E9%85%8D%E7%BD%AE.png" alt="统一配置"></p><p><img src="/img/weifuwu_img/%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF.png" alt="配置信息"></p><h5 id="从nacos中拉取配置"><a href="#从nacos中拉取配置" class="headerlink" title="从nacos中拉取配置"></a>从nacos中拉取配置</h5><ul><li><p>导入配置管理坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacos配置管理依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加bootstrap.yml配置文件</p><blockquote><p>bootstrap.yml会在application.yml之前被读取，在bootstrap中配置服务名称、环境、nacos地址等信息来读取配置</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">userservice</span> <span class="hljs-comment"># 服务名称</span><br>  <span class="hljs-attr">profiles:</span><br>    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span> <span class="hljs-comment">#开发环境，这里是dev</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#Nacos地址</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#Nacos地址</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span> <span class="hljs-comment">#这里我们获取的yaml格式的配置</span><br></code></pre></td></tr></table></figure><p>最终会定位到userservice-dev.yaml配置中</p><p>记得把application.yml中相同的配置注释掉</p></li><li><p>可以通过@Value注解来读取nacos中的配置信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;pattern.dataformat&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String dataformat;<br></code></pre></td></tr></table></figure></li></ul><h5 id="配置热更新"><a href="#配置热更新" class="headerlink" title="配置热更新"></a>配置热更新</h5><blockquote><p>nacos中的配置改变后立马更新而不需要重启服务</p></blockquote><p>方式一(配置少时)</p><ul><li><p>在类上加@RefreshScope注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-meta">@RefreshScope</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;pattern.dataformat&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String dataformat;<br><br>    <span class="hljs-meta">@GetMapping(&quot;now&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">now</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(dataformat));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>方式二（配置多时，推荐）</p><p>通过@ConfigurationProperties来获取配置</p><ul><li><p>创建配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;pattern&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PatternProperties</span> &#123;<br>    <span class="hljs-keyword">private</span> String dataformat;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>通过注入配置类来获取配置信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> PatternProperties patternProperties;<br><br><span class="hljs-meta">@GetMapping(&quot;now&quot;)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">now</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> LocalDateTime.now().format(DateTimeFormatter.ofPattern(patternProperties.getDataformat()));<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h5 id="配置共享"><a href="#配置共享" class="headerlink" title="配置共享"></a>配置共享</h5><blockquote><p> nacos配置的文件名格式为<code>服务名-环境.yaml</code>，如<code>userservice-dev.yaml</code></p><p>当文件名为<code>服务名.yaml</code>时，即为共享配置，每个环境的都能读到</p></blockquote><p><img src="/img/weifuwu_img/%E5%85%B1%E4%BA%AB%E9%85%8D%E7%BD%AE.png" alt="共享配置"></p><p>有相同配置时，配置的优先级为: 环境配置&gt;共享配置&gt;本地配置</p><h4 id="Nacos搭建集群"><a href="#Nacos搭建集群" class="headerlink" title="Nacos搭建集群"></a>Nacos搭建集群</h4><p>通过nginx反向代理多个nacos实现负载均衡</p><p><img src="/img/weifuwu_img/Nacos%E9%9B%86%E7%BE%A4.png" alt="Nacos集群"></p><p><strong>步骤:</strong></p><ul><li>搭建数据库</li><li>配置nacos</li><li>配置nginx反向代理</li></ul><h5 id="配置nacos"><a href="#配置nacos" class="headerlink" title="配置nacos"></a>配置nacos</h5><ul><li><p>进入nacos的conf目录，修改配置文件cluster.conf.example，重命名为cluster.conf</p></li><li><p>添加nacos集群的ip和端口</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1:8845</span><br><span class="hljs-number">127.0.0.1:8846</span><br><span class="hljs-number">127.0.0.1:8847</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件application.properties，添加数据库信息</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.datasource.platform</span>=<span class="hljs-string">mysql</span><br><br><span class="hljs-attr">db.num</span>=<span class="hljs-string">1</span><br><br><span class="hljs-attr">db.url.0</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><br><span class="hljs-attr">db.user.0</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">db.password.0</span>=<span class="hljs-string">123</span><br></code></pre></td></tr></table></figure></li><li><p>在application.properties中修改每个nacos的端口</p></li><li><p>分别启动nacos</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dos">startup.<span class="hljs-built_in">cmd</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="配置nginx反向代理"><a href="#配置nginx反向代理" class="headerlink" title="配置nginx反向代理"></a>配置nginx反向代理</h5><ul><li><p>下载解压nginx到非中文目录下</p></li><li><p>修改conf&#x2F;nginx.conf文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs conf">upstream nacos-cluster &#123;<br>    server 127.0.0.1:8845;#nacos的ip和端口<br>server 127.0.0.1:8846;<br>server 127.0.0.1:8847;<br>&#125;<br><br>server &#123;<br>    listen       80;<br>    server_name  localhost;<br><br>    location /nacos &#123;<br>        proxy_pass http://nacos-cluster;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>代码中nacos的地址要改为nginx的</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:80</span> <span class="hljs-comment"># Nacos地址</span><br></code></pre></td></tr></table></figure></li></ul><h4 id="使用Feign替代RestTemplate"><a href="#使用Feign替代RestTemplate" class="headerlink" title="使用Feign替代RestTemplate"></a>使用Feign替代RestTemplate</h4><p>RestTemplate存在的问题: 需要自己拼接请求路径，如果参数一多不好管理</p><p>Feign是声明式的服务调用工具，我们只需创建一个接口并用注解的方式来配置它，就可以实现对某个服务接口的调用，简化了直接使用RestTemplate来调用服务接口的开发量</p><h5 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h5><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2021.0.6<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>启动类上加入@EnableFeignClients注解开启Feign的功能</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients</span><br></code></pre></td></tr></table></figure></li><li><p>编写Feign的客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(&quot;userservice&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/user/&#123;id&#125;&quot;)</span><br>    User <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>之后可以注入Feign的客户端来发送http</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderMapper orderMapper;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserClient userClient;<br><br>    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">queryOrderById</span><span class="hljs-params">(Long orderId)</span> &#123;<br>        <span class="hljs-comment">// 查询订单</span><br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.findById(orderId);<br><br>        <span class="hljs-comment">//用feign发送http请求查询user信息</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userClient.findById(order.getUserId());<br>        order.setUser(user);<br>        <br>        <span class="hljs-comment">// 返回</span><br>        <span class="hljs-keyword">return</span> order;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="自定义配置"><a href="#自定义配置" class="headerlink" title="自定义配置"></a>自定义配置</h5><table><thead><tr><th>类型</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><strong>feign.Logger.Level</strong></td><td>修改日志级别</td><td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td></tr><tr><td>feign.codec.Decoder</td><td>响应结果的解析器</td><td>http远程调用的结果做解析，例如解析json字符串为java对象</td></tr><tr><td>feign.codec.Encoder</td><td>请求参数编码</td><td>将请求参数编码，便于通过http请求发送</td></tr><tr><td>feign. Contract</td><td>支持的注解格式</td><td>默认是SpringMVC的注解</td></tr><tr><td>feign. Retryer</td><td>失败重试机制</td><td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td></tr></tbody></table><p>配置方式：</p><ol><li><p>配置文件方式</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">userservice:</span>  <span class="hljs-comment"># 针对某个服务, 不加针对所有服务</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">FULL</span> <span class="hljs-comment"># 日志等级</span><br></code></pre></td></tr></table></figure></li><li><p>代码方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultFeignConfiguration</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Logger.Level <span class="hljs-title function_">feignLevel</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Logger.Level.BASIC;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过注入Bean的方式来自定义配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//如果要所有服务生效,则加在@EnableFeignClient上</span><br><span class="hljs-meta">@EnableFeignClients(defaultConfiguration = DefaultFeignConfiguration.class)</span><br><br><span class="hljs-comment">//如果只要某个服务生效，则加在指定的feignClient上</span><br><span class="hljs-meta">@FeignClient(value = &quot;userservice&quot;, configuration = DefaultFeignConfiguration.class)</span><br><br></code></pre></td></tr></table></figure></li></ol><h5 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h5><blockquote><p>降级指系统将某些业务或者接口的功能降低，可以是只提供部分功能，也可以是完全停掉所有功能。<strong>降级的核心思想就是丢车保帅，优先保证核心业务</strong></p></blockquote><h5 id="优化性能"><a href="#优化性能" class="headerlink" title="优化性能"></a>优化性能</h5><p>可以通过一下两点优化性能：</p><ol><li>日志级别尽量用basic及以下</li><li>使用HttpClient或OKHttp代替URLConnection</li></ol><p><strong>替换连接池</strong></p><blockquote><p> Feign底层发起http请求，依赖于其它的框架。其底层客户端实现包括：</p><p>•URLConnection：默认实现，不支持连接池</p><p>•Apache HttpClient ：支持连接池</p><p>•OKHttp：支持连接池</p><p>因此提高Feign的性能主要手段就是使用<strong>连接池</strong>代替默认的URLConnection。</p></blockquote><ul><li><p>导入依赖坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--httpClient的依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.github.openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>feign-httpclient<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置使用的连接池</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">userservice:</span>  <span class="hljs-comment"># 针对某个服务</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">BASIC</span> <span class="hljs-comment"># 日志等级</span><br>      <span class="hljs-attr">httpclient:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启feign对HttpClient的支持</span><br>        <span class="hljs-attr">max-connections:</span> <span class="hljs-number">200</span> <span class="hljs-comment"># 最大的连接数</span><br>        <span class="hljs-attr">max-connections-per-route:</span> <span class="hljs-number">50</span> <span class="hljs-comment"># 每个路径的最大连接数</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="抽取Feign客户端"><a href="#抽取Feign客户端" class="headerlink" title="抽取Feign客户端"></a>抽取Feign客户端</h5><blockquote><p>将Feign的Client抽取为独立模块，并且把接口有关的POJO、默认的Feign配置都放到这个模块中，提供给所有消费者使用</p><p>降低代码冗余</p></blockquote><p><img src="/img/weifuwu_img/feign%E6%8A%BD%E5%8F%96.png" alt="feign抽取"></p><ul><li><p>创建新模块feign-api</p></li><li><p>将FeignClient及feign配置类、实体类移到feign-api中</p><p><img src="/img/weifuwu_img/feignApi.png" alt="feignApi"></p></li><li><p>在需要feign的类中导入feign-api模块</p><p><img src="/img/weifuwu_img/%E5%AF%BC%E5%85%A5feignApi.png" alt="导入feignApi"></p></li><li><p>在@EnableFeignClients注解中说明feign所在的包或类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableFeignClients(clients = &#123;UserClient.class&#125;)</span><br><br><span class="hljs-comment">//或者</span><br><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;cn.itcast.feign.clients&quot;)</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="常用配置-2"><a href="#常用配置-2" class="headerlink" title="常用配置"></a>常用配置</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">hystrix:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#在Feign中开启Hystrix</span><br>  <span class="hljs-attr">compression:</span><br>    <span class="hljs-attr">request:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否对请求进行GZIP压缩</span><br>      <span class="hljs-attr">mime-types:</span> <span class="hljs-string">text/xml,application/xml,application/json</span> <span class="hljs-comment">#指定压缩的请求数据类型</span><br>      <span class="hljs-attr">min-request-size:</span> <span class="hljs-number">2048</span> <span class="hljs-comment">#超过该大小的请求会被压缩</span><br>    <span class="hljs-attr">response:</span><br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#是否对响应进行GZIP压缩</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span> <span class="hljs-comment">#修改日志级别</span><br>    <span class="hljs-attr">com.macro.cloud.service.UserService:</span> <span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure><h4 id="Gateway网关"><a href="#Gateway网关" class="headerlink" title="Gateway网关"></a>Gateway网关</h4><blockquote><p>SpringCloudGateway是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能</p></blockquote><p>网关的<strong>核心功能特性</strong>：</p><ul><li><strong>请求路由和负载均衡</strong>: </li><li><strong>权限控制</strong>:网关作为微服务入口，需要校验用户是是否有请求资格，如果没有则进行拦截。</li><li><strong>限流</strong>: 当请求流量过高时，在网关中按照下流的微服务能够接受的速度来放行请求，避免服务压力过大</li><li><strong>Predicate（断言）</strong>：指的是Java 8 的 Function Predicate。 输入类型是Spring框架中的ServerWebExchange。 这使开发人员可以匹配HTTP请求中的所有内容，例如请求头或请求参数。如果请求与断言相匹配，则进行路由；</li><li><strong>Filter（过滤器）</strong>：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前后对请求进行修改。</li></ul><h5 id="创建Gateway服务"><a href="#创建Gateway服务" class="headerlink" title="创建Gateway服务"></a>创建Gateway服务</h5><ul><li><p>创建gateway模块</p><p><img src="/img/weifuwu_img/gateway%E6%A8%A1%E5%9D%97.png" alt="gateway模块"></p></li><li><p>导入依赖坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacos服务发现依赖--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--gateway网关--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写路由配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">10010</span> <span class="hljs-comment">#网关地址</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span> <span class="hljs-comment">#服务名</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span> <span class="hljs-comment">#nacos地址</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span> <span class="hljs-comment">#路由配置</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service</span>  <span class="hljs-comment">#路由id</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://userservice</span> <span class="hljs-comment">#路由目标地址，服务注册的名字(lb: loadBalance)</span><br>          <span class="hljs-attr">predicates:</span>  <span class="hljs-comment">#断言，根据这些路径来匹配</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order-service</span>  <span class="hljs-comment">#路由id</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://orderservice</span> <span class="hljs-comment">#路由目标地址(lb: loadBalance)</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，根据这些路径来匹配</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order/**</span><br><br></code></pre></td></tr></table></figure></li><li><p>通过网关地址访问服务</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>localhost:<span class="hljs-number">10010</span><span class="hljs-regexp">/user/</span><span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="断言工厂"><a href="#断言工厂" class="headerlink" title="断言工厂"></a>断言工厂</h5><p><a href="https://docs.gitcode.net/spring/guide/spring-cloud/spring-cloud-gateway.html#_5-%E8%B7%AF%E7%BA%BF%E8%B0%93%E8%AF%8D%E5%B7%A5%E5%8E%82">Spring Cloud 网关 | 中文文档 (gitcode.net)</a></p><table><thead><tr><th><strong>名称</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>After</td><td>是某个时间点后的请求</td><td>-  After&#x3D;2037-01-20T17:42:47.789-07:00[America&#x2F;Denver]</td></tr><tr><td>Before</td><td>是某个时间点之前的请求</td><td>-  Before&#x3D;2031-04-13T15:14:47.433+08:00[Asia&#x2F;Shanghai]</td></tr><tr><td>Between</td><td>是某两个时间点之前的请求</td><td>-  Between&#x3D;2037-01-20T17:42:47.789-07:00[America&#x2F;Denver],  2037-01-21T17:42:47.789-07:00[America&#x2F;Denver]</td></tr><tr><td>Cookie</td><td>请求必须包含某些cookie</td><td>- Cookie&#x3D;chocolate, ch.p</td></tr><tr><td>Header</td><td>请求必须包含某些header</td><td>- Header&#x3D;X-Request-Id, \d+</td></tr><tr><td>Host</td><td>请求必须是访问某个host（域名）</td><td>-  Host&#x3D;<strong>.somehost.org,</strong>.anotherhost.org</td></tr><tr><td>Method</td><td>请求方式必须是指定方式</td><td>- Method&#x3D;GET,POST</td></tr><tr><td>Path</td><td>请求路径必须符合指定规则</td><td>- Path&#x3D;&#x2F;red&#x2F;{segment},&#x2F;blue&#x2F;**</td></tr><tr><td>Query</td><td>请求参数必须包含指定参数</td><td>- Query&#x3D;name, Jack或者-  Query&#x3D;name</td></tr><tr><td>RemoteAddr</td><td>请求者的ip必须是指定范围</td><td>- RemoteAddr&#x3D;192.168.1.1&#x2F;24</td></tr><tr><td>Weight</td><td>权重处理</td><td></td></tr></tbody></table><p>通过<code>predicates:</code>后加断言来设置访问条件</p><h5 id="过滤器工厂"><a href="#过滤器工厂" class="headerlink" title="过滤器工厂"></a>过滤器工厂</h5><blockquote><p>对路由的请求或响应做加工处理 Spring提供了31种不同的路由过滤器工厂</p></blockquote><p><a href="https://docs.gitcode.net/spring/guide/spring-cloud/spring-cloud-gateway.html#_6-gatewayfilter%E5%B7%A5%E5%8E%82">Spring Cloud 网关 | 中文文档 (gitcode.net)</a></p><ul><li><p><strong>添加过滤器(针对某个服务)</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">gateway:</span><br>  <span class="hljs-attr">routes:</span> <span class="hljs-comment">#路由配置</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service</span>  <span class="hljs-comment">#路由id</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://userservice</span> <span class="hljs-comment">#路由目标地址(lb: loadBalance)</span><br>      <span class="hljs-attr">predicates:</span>  <span class="hljs-comment">#断言，根据这些路径来匹配</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>      <span class="hljs-attr">filters:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=Truth,</span> <span class="hljs-string">aaa</span> <span class="hljs-comment"># 添加请求头</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order-service</span>  <span class="hljs-comment">#路由id</span><br>      <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://orderservice</span> <span class="hljs-comment">#路由目标地址(lb: loadBalance)</span><br>      <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，根据这些路径来匹配</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order/**</span><br></code></pre></td></tr></table></figure></li><li><p><strong>添加默认过滤器(对所有服务都有效)</strong></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span> <span class="hljs-comment">#路由配置</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user-service</span>  <span class="hljs-comment">#路由id</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://userservice</span> <span class="hljs-comment">#路由目标地址(lb: loadBalance)</span><br>          <span class="hljs-attr">predicates:</span>  <span class="hljs-comment">#断言，根据这些路径来匹配</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=Truth,</span> <span class="hljs-string">Itcast</span> <span class="hljs-string">is</span> <span class="hljs-string">freaking</span> <span class="hljs-string">awesome!</span> <span class="hljs-comment"># 添加请求头</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">order-service</span>  <span class="hljs-comment">#路由id</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://orderservice</span> <span class="hljs-comment">#路由目标地址(lb: loadBalance)</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言，根据这些路径来匹配</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/order/**</span><br>      <span class="hljs-attr">default-filters:</span> <span class="hljs-comment"># 默认过滤项</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">AddRequestHeader=Truth,</span> <span class="hljs-string">aaa</span><br></code></pre></td></tr></table></figure></li></ul><h5 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h5><blockquote><p>过滤器工厂提供的过滤器的作用都是固定的，可以通过全局过滤器来<strong>自定义</strong>过滤逻辑</p></blockquote><p><strong>定义方式</strong></p><ul><li><p>实现GlobalFilter接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Order(-1)</span>      <span class="hljs-comment">//过滤器优先级，数字越小优先级越高</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthorizeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> exchange 上下文</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chain 过滤链</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-comment">//获取请求参数映射</span><br>        <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();<br>        MultiValueMap&lt;String, String&gt; queryParams = request.getQueryParams();<br>        <span class="hljs-comment">//获取其中的authorize参数</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">auth</span> <span class="hljs-operator">=</span> queryParams.getFirst(<span class="hljs-string">&quot;authorize&quot;</span>);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;admin&quot;</span>.equals(auth)) &#123;<br>            <span class="hljs-comment">//放行</span><br>            <span class="hljs-keyword">return</span> chain.filter(exchange);<br>        &#125;<br>        <span class="hljs-comment">//拦截</span><br>        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);  <span class="hljs-comment">//设置401状态码</span><br>        <span class="hljs-keyword">return</span> exchange.getResponse().setComplete();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>过滤器执行顺序</strong>：</p><ul><li>order值越小，优先级越高</li><li>路由过滤器和defaultFilter的order由Spring指定，默认是按照<strong>声明顺序</strong>从1递增</li><li>当过滤器的order值一样时，会按照 defaultFilter &gt; 路由过滤器 &gt; GlobalFilter的顺序执行。</li></ul><h5 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h5><blockquote><p><strong>浏览器</strong>禁止请求的发起者与服务端发生跨域<strong>ajax</strong>请求，请求被浏览器拦截的问题</p></blockquote><p><strong>解决跨域问题</strong></p><p>在gateway服务的application.yml文件中，添加下面的配置：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">spring:<br>  cloud:<br>    gateway:<br>      # 。。。<br>      globalcors: # 全局的跨域处理<br>        add-to-simple-url-handler-mapping: true # 解决options请求被拦截问题<br>        corsConfigurations:<br>          &#x27;<span class="hljs-string">[/**]</span>&#x27;:<br>            allowedOrigins: # 允许哪些网站的跨域请求 <br>              - <span class="hljs-string">&quot;http://localhost:8090&quot;</span><br>            allowedMethods: # 允许的跨域ajax的请求方式<br>              - <span class="hljs-string">&quot;<span class="hljs-keyword">GET</span>&quot;</span><br>              - <span class="hljs-string">&quot;<span class="hljs-keyword">POST</span>&quot;</span><br>              - <span class="hljs-string">&quot;<span class="hljs-keyword">DELETE</span>&quot;</span><br>              - <span class="hljs-string">&quot;<span class="hljs-keyword">PUT</span>&quot;</span><br>              - <span class="hljs-string">&quot;<span class="hljs-keyword">OPTIONS</span>&quot;</span><br>            allowedHeaders: <span class="hljs-string">&quot;*&quot;</span> # 允许在请求中携带的头信息<br>            allowCredentials: true # 是否允许携带cookie<br>            maxAge: <span class="hljs-number">360000</span> # 这次跨域检测的有效期<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>微服务</category>
      
    </categories>
    
    
    <tags>
      
      <tag>微服务</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>设计模式总结</title>
    <link href="/2022/09/02/%E8%BD%AF%E8%80%83/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    <url>/2022/09/02/%E8%BD%AF%E8%80%83/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="设计模式总结"><a href="#设计模式总结" class="headerlink" title="设计模式总结"></a>设计模式总结</h2><blockquote><p>软件开发的 总体指导思路或参照样板</p><p>从本质上都是简化和分解类或对象</p></blockquote><p><img src="/img/post_img/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E5%88%86%E7%B1%BB.png"></p><h4 id="创建型设计模式-5"><a href="#创建型设计模式-5" class="headerlink" title="创建型设计模式(5)"></a>创建型设计模式(5)</h4><h5 id="1-单例模式（Singleton）"><a href="#1-单例模式（Singleton）" class="headerlink" title="1.单例模式（Singleton）"></a>1.单例模式（Singleton）</h5><blockquote><p>确保某一个类<strong>只有一个</strong>实例，而且自己实例化并向整个系统提供这个实例</p></blockquote><p><strong>适用性</strong></p><ul><li>当类只能有一个实例而且客户可以从一个众所周知的访问点访问它时。</li><li>当这个唯一实例应该是通过子类化可扩展的，并且客户无须更改代码就能使用一个扩展的实例时。</li></ul><p>代码示例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">singleton</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();<br><br>    <span class="hljs-comment">// 限制产生多个对象，如果该类是抽象类，该方法可以省略</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取实例对象</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getSingleton</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> singleton;<br>    &#125;<br><br>    <span class="hljs-comment">// 其他方法，尽量是static方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomgting</span><span class="hljs-params">()</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-原型模式-Prototype"><a href="#2-原型模式-Prototype" class="headerlink" title="2.原型模式(Prototype)"></a>2.原型模式(Prototype)</h5><blockquote><p>将一个对象作为原型，通过对其进行复制而克隆出多个和原型类似的新实例,而不是通过new</p></blockquote><p><img src="/img/post_img/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>资源优化场景：类初始化需要消化非常多的资源，这个资源包括数据、硬件资源等</li><li>通过new产生一个对象需要非常繁琐的数据准备或访问权限，则可以使用原型模式</li><li>一个对象多个修改者的场景，而且各个调用者可能都需要修改其值时，可以用原型模式拷贝多个对象供调用者使用</li></ul><h5 id="3-工厂方法模式-Factory-Method"><a href="#3-工厂方法模式-Factory-Method" class="headerlink" title="3.工厂方法模式(Factory Method)"></a>3.工厂方法模式(Factory Method)</h5><blockquote><p>定义一个用于创建对象的接口，让子类决定实例化哪一个类</p><p>多个工厂实现了工厂接口，每个工厂生产的类不同</p></blockquote><p><strong>适用性</strong></p><ul><li>当一个类希望由它的子类来指定它所创建的对象的时候</li></ul><h5 id="4-抽象工厂模式（AbstractFactory）"><a href="#4-抽象工厂模式（AbstractFactory）" class="headerlink" title="4.抽象工厂模式（AbstractFactory）"></a>4.抽象工厂模式（AbstractFactory）</h5><blockquote><p>提供一个创建<strong>一系列</strong>相关或相互依赖对象的接口，而<strong>无须指定它们具体的类</strong>。</p></blockquote><p><strong>适用性</strong></p><ul><li>当要强调一系列相关的产品对象的设计以便进行联合使用时</li><li>一个系统要由多个产品系列中的一个来配置时</li></ul><h5 id="5-生成器模式-x2F-建造者模式-Builder"><a href="#5-生成器模式-x2F-建造者模式-Builder" class="headerlink" title="5.生成器模式&#x2F;建造者模式(Builder)"></a>5.生成器模式&#x2F;建造者模式(Builder)</h5><blockquote><p>将一个复杂对象分解成多个相对简单的部分，然后根据不同需要分别创建它们，最后构建成该<strong>复杂对象</strong></p></blockquote><p><img src="/img/post_img/%E7%94%9F%E6%88%90%E5%99%A8%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>构造过程必须允许被构造的对象<strong>有不同的表示</strong>时</li><li>多个部件或零件，都可以装配到一个对象中，但是产生的运行结果又不相同时</li></ul><p>​    </p><h4 id="结构型设计模式-7"><a href="#结构型设计模式-7" class="headerlink" title="结构型设计模式(7)"></a>结构型设计模式(7)</h4><h5 id="1-代理模式（Proxy）"><a href="#1-代理模式（Proxy）" class="headerlink" title="1.代理模式（Proxy）"></a>1.代理模式（Proxy）</h5><blockquote><p>为某对象提供一种代理以控制对该对象的访问</p><p>限制、增强或修改该对象的一些特性</p></blockquote><p><img src="/img/post_img/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>将一个对象加以包装以控制对这个对象的访问</li><li>在需要比较通用和复杂的对象指针代替简单的指针时</li><li>为其他对象提供一种代理以控制对这个对象的访问</li></ul><h5 id="2-适配器模式（Adapter）"><a href="#2-适配器模式（Adapter）" class="headerlink" title="2.适配器模式（Adapter）"></a>2.适配器模式（Adapter）</h5><blockquote><p>将一个类的接口转换成客户希望的另外一个接口。Adapter模式使得原本由于接口不兼容而不能一起工作的那些类可以一起工作</p></blockquote><p><img src="/img/post_img/%E9%80%82%E9%85%8D%E5%99%A8%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>将一个对象加以包装以给客户提供其希望的另外一个接口</li><li>想使用一个已经存在的类，而其接口不符合要求</li><li>使所有接口不兼容类可以一起工作</li></ul><h5 id="3-桥接模式-Bridge"><a href="#3-桥接模式-Bridge" class="headerlink" title="3.桥接模式(Bridge)"></a>3.桥接模式(Bridge)</h5><blockquote><p>将抽象部分与其实现部分分离，使它们都可以独立地变化</p></blockquote><p><strong>适用性</strong></p><ul><li>类的抽象和其实现之间不希望有一个固定的绑定关系</li><li>接口或抽象类不稳定</li></ul><h5 id="4-装饰器模式（Decorator）"><a href="#4-装饰器模式（Decorator）" class="headerlink" title="4.装饰器模式（Decorator）"></a>4.装饰器模式（Decorator）</h5><blockquote><p>动态地给一个对象<strong>添加</strong>一些额外的职责。就增加功能而言，Decorator模式比生成子类更加灵活</p></blockquote><p><strong>适用性</strong></p><ul><li>将一个对象加以包装以提供一些额外的行为</li><li>动态地给一个对象添加一些额外的职责</li></ul><h5 id="5-外观-x2F-门面模式（Facade）"><a href="#5-外观-x2F-门面模式（Facade）" class="headerlink" title="5.外观&#x2F;门面模式（Facade）"></a>5.外观&#x2F;门面模式（Facade）</h5><blockquote><p>为系统中多个子系统提供一致的对外调用， 对客户端隐藏子系统细节， 降低其与子系统的耦合</p></blockquote><p><strong>适用性</strong></p><ul><li>将<strong>一系列对象</strong>加以包装以<strong>简化其接口</strong></li><li>需要为一个复杂子系统提供一个简单接口</li></ul><h5 id="6-享元模式（Flyweight）"><a href="#6-享元模式（Flyweight）" class="headerlink" title="6.享元模式（Flyweight）"></a>6.享元模式（Flyweight）</h5><blockquote><p>运用共亨技术有效地支持大量细粒度的对象</p><p>是池技术的重要实现方式</p></blockquote><p><strong>适用性</strong></p><ul><li>系统中存在大量相似对象 </li><li>完全由于使用大量的对象，造成很大的存储开销</li><li>需要<strong>缓冲池</strong>的场景</li><li>进行对象共享,以减少对象数量从而达到较少的内存占用并提升性能</li></ul><h5 id="7-组合模式（Composite）"><a href="#7-组合模式（Composite）" class="headerlink" title="7.组合模式（Composite）"></a>7.组合模式（Composite）</h5><blockquote><p>将对象组合成树型结构以表示“部分-整体”的层次结构</p></blockquote><p><strong>适用性</strong></p><ul><li>表示对象的部分-整体层次结构</li><li>将多个对象组合在一起进行操作，常用于表示树形结构中，<strong>例如二叉树</strong></li></ul><h4 id="行为型设计模式-11"><a href="#行为型设计模式-11" class="headerlink" title="行为型设计模式(11)"></a>行为型设计模式(11)</h4><h5 id="1-模板方法模式（Template-Method）"><a href="#1-模板方法模式（Template-Method）" class="headerlink" title="1.模板方法模式（Template Method）"></a>1.模板方法模式（Template Method）</h5><blockquote><p>定义一个操作中的算法骨架，而将算法的一些步骤放到子类中，使得子类可以不改变该算法结构的情况下重定义该算法的某些特定步骤</p></blockquote><p><img src="/img/post_img/%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>一次性实现一个算法的不变的部分，并将可变的行为留给子类来实现</li><li>各子类中公共的行为应被提取出来并集中到一个公共父类中，以避免代码重复</li></ul><h5 id="2-策略模式（Strategy）"><a href="#2-策略模式（Strategy）" class="headerlink" title="2.策略模式（Strategy）"></a>2.策略模式（Strategy）</h5><blockquote><p>定义一系列的算法，把它们一个个封装起来，并且使它们可以相互替换</p><p>提供不同的算法策略</p></blockquote><p><img src="/img/post_img/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>需要使用一个算法地不同变体</li><li>许多相关的类仅仅是行为有异</li><li>一个类定义了多种行为,并且这些行为在这个类的操作中以多个条件语句的形式出现，将相关的条件分支移入它们各自的Strategy类中，以代替这些条件语句</li></ul><h5 id="3-命令模式（Command）"><a href="#3-命令模式（Command）" class="headerlink" title="3.命令模式（Command）"></a>3.命令模式（Command）</h5><blockquote><p>将一个请求封装为一个对象，从而使得可以用不同的请求对客户进行参数化;对请求排队或记录请求日志，以及支持可撤销的操作</p></blockquote><p><strong>适用性</strong></p><ul><li>抽象出执行的动作以参数化某对象</li><li>将请求封装为对象从而可以使用不同的请求对客户进行参数化</li><li>在不同的时刻指定、排列和执行请求</li></ul><h5 id="4-职责链模式（Chain-of-Responsibility）"><a href="#4-职责链模式（Chain-of-Responsibility）" class="headerlink" title="4.职责链模式（Chain of Responsibility）"></a>4.职责链模式（Chain of Responsibility）</h5><blockquote><p>把请求从链中的一个对象传到下一个对象，直到请求被响应为止</p></blockquote><p><strong>适用性</strong></p><ul><li>有多个对象可以处理一个请求，在运行时刻自动确定由哪个对象处理</li><li>想在不明确指定接收者的情况下向多个对象中的一个提交一个请求</li><li>一个客户需要使用一组相关对象</li></ul><h5 id="5-状态模式（State）"><a href="#5-状态模式（State）" class="headerlink" title="5.状态模式（State）"></a>5.状态模式（State）</h5><blockquote><p>允许一个对象在其内部状态改变时改变它的行为。对象看起来似乎修改了它的类</p></blockquote><p><img src="/img/post_img/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>一个对象的行为决定于其状态且必须在运行时刻根据状态改变行为</li><li>一个对象在其内部状态改变时改变其行为</li></ul><h5 id="6-观察者模式（Observer）"><a href="#6-观察者模式（Observer）" class="headerlink" title="6.观察者模式（Observer）"></a>6.观察者模式（Observer）</h5><blockquote><p>定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新</p></blockquote><p><img src="/img/post_img/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>当一个对象必须通知其它对象，而它又不能假定其它对象是谁时</li><li>当一个对象状态改变时所有依赖它的对象得到通知并自动更新</li><li>在发布-订阅(Publish-Subscribe）消息模型中，订阅者订阅一个主题后，当该主题有新消息到达时，所有订阅者都会收到通知</li></ul><h5 id="7-中介者模式（Mediator）"><a href="#7-中介者模式（Mediator）" class="headerlink" title="7.中介者模式（Mediator）"></a>7.中介者模式（Mediator）</h5><blockquote><p>用一个中介对象来封装一系列的对象交互, 中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互</p></blockquote><p><img src="/img/post_img/%E4%B8%AD%E4%BB%8B%E8%80%85%E6%A8%A1%E5%BC%8F.png"></p><p><strong>适用性</strong></p><ul><li>一组对象以定义良好但是复杂的方式进行通信，产生的相互依赖关系结构混乱且难以理解</li><li>减少多个对象或类之间的通信复杂性</li></ul><h5 id="8-迭代器模式（Iterator）"><a href="#8-迭代器模式（Iterator）" class="headerlink" title="8.迭代器模式（Iterator）"></a>8.迭代器模式（Iterator）</h5><blockquote><p>提供一种方法顺序访问一个聚合对象中的各个元素，且不需要暴露该对象的内部表示</p></blockquote><p><strong>适用性</strong></p><ul><li>访问一个聚合对象的内容而无须暴露它的内部表示</li></ul><h5 id="9-访问者模式（Visitor）"><a href="#9-访问者模式（Visitor）" class="headerlink" title="9.访问者模式（Visitor）"></a>9.访问者模式（Visitor）</h5><blockquote><p>分离对象数据结构与行为的方法，通过这种分离，可达到为一个被访问者动态添加新的操作而无需做其它的修改的效果</p></blockquote><p><strong>适用性</strong></p><ul><li>定义对象结构的类很少改变，但经常需要在此结构上定义新的操作</li><li>需要对一个对象结构中的对象进行很多不同的并且不相关的操作</li></ul><h5 id="10-备忘录模式（Memento）"><a href="#10-备忘录模式（Memento）" class="headerlink" title="10.备忘录模式（Memento）"></a><strong>10.备忘录模式（Memento）</strong></h5><blockquote><p>在不破坏封装性的前提下捕获一个对象的内部状态，并在对象之外保存这个状态。这样以后就可以将对象恢复到原先保存的状态</p></blockquote><p><strong>适用性</strong></p><ul><li>保存一个对象在某一个时刻的（部分）状态，这样以后需要时它才能恢复到先前的状态</li></ul><h5 id="11-解释器模式（Interpreter）"><a href="#11-解释器模式（Interpreter）" class="headerlink" title="11.解释器模式（Interpreter）"></a>11.解释器模式（Interpreter）</h5><blockquote><p>给定一个语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子</p></blockquote><p><strong>适用性</strong></p><ul><li>有一个语言需要解释执行，并且可将句子表示为一个抽象语法树</li><li>如四则运算、正则表达式等</li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>软考</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>选择题考点</title>
    <link href="/2022/08/29/%E8%BD%AF%E8%80%83/%E9%80%89%E6%8B%A9%E9%A2%98%E8%80%83%E7%82%B9/"/>
    <url>/2022/08/29/%E8%BD%AF%E8%80%83/%E9%80%89%E6%8B%A9%E9%A2%98%E8%80%83%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="选择题考点"><a href="#选择题考点" class="headerlink" title="选择题考点"></a>选择题考点</h2><h4 id="常见密钥加密算法"><a href="#常见密钥加密算法" class="headerlink" title="常见密钥加密算法"></a>常见密钥加密算法</h4><h5 id="对称加密算法"><a href="#对称加密算法" class="headerlink" title="对称加密算法:"></a>对称加密算法:</h5><blockquote><p>加解密使用同一个密钥，又称为私人秘钥加密&#x2F;共享秘钥加密</p></blockquote><p>特点：</p><ul><li>加密强度不高但效率高</li><li>在为大量明文加密时一般使用对称加密</li></ul><p>常见对称加密算法：</p><ul><li><strong>DES</strong>（Data Encryption Standard，数据加密标准）</li><li><strong>3DES</strong>（ Triple DES，三重数据加密算法 ）</li><li><strong>RC5</strong>（分组密码算法）</li><li><strong>RC4</strong> (流加密算法)</li><li><strong>IDEA</strong>（International Data Encryption Algorithm，国际数据加密算法）</li><li><strong>AES</strong>（Advanced Encryption Standard，高级加密标准，<strong>分组加密算法</strong>）</li></ul><h5 id="非对称加密算法"><a href="#非对称加密算法" class="headerlink" title="非对称加密算法:"></a>非对称加密算法:</h5><blockquote><p>公钥加密，相应的私钥解密，也称公开密钥加密</p></blockquote><p>特点：</p><ul><li>加密速度慢但强度高</li></ul><p>常见非对称加密算法：</p><ul><li><strong>RSA</strong>（公开密钥密码体制）</li><li><strong>DSA</strong> (Digital Signature Algorithm，一种更高级的验证方式)</li><li><strong>ECC</strong>（Elliptic Curves Cryptography，椭圆曲线加密算法）</li></ul><h4 id="消息摘要算法"><a href="#消息摘要算法" class="headerlink" title="消息摘要算法"></a>消息摘要算法</h4><blockquote><p>对加密内容生成一个摘要，注意摘要不是加密，无法解密，仅能用来标识原内容。</p></blockquote><p>常见消息摘要算法：</p><ul><li>MD5&#x2F;SHA</li></ul><h4 id="加密技术的应用"><a href="#加密技术的应用" class="headerlink" title="加密技术的应用"></a>加密技术的应用</h4><ul><li><strong>数字信封</strong>：用接收方公钥加密使用的对称密钥。</li><li><strong>数字签名</strong>：用发送方<strong>私钥</strong>签名，<strong>保证发送方身份真实性</strong>，发送者不可抵赖，与信息摘要结合，可防篡改。对用户的身份进行认证。</li><li><strong>信息摘要</strong>：单向散列值函数，防篡改，保证消息完整性</li><li><strong>数字证书</strong>：确保消息不可否认。内容包括：CA签名(验证网站真伪)、用户信息（用户名称）、用户公钥等</li></ul><h4 id="编译器和解释器"><a href="#编译器和解释器" class="headerlink" title="编译器和解释器"></a>编译器和解释器</h4><h5 id="编译器"><a href="#编译器" class="headerlink" title="编译器"></a>编译器</h5><blockquote><p>将”高级语言”翻译为低级语言</p><p>将源程序整个编译成可执行的目标代码，执行时不需要编译器</p><p>翻译与执行是分开的</p></blockquote><p><strong>过程</strong></p><p><img src="/img/post_img/%E7%BC%96%E8%AF%91%E7%A8%8B%E5%BA%8F%E8%BF%87%E7%A8%8B.png"></p><p><strong>详细过程</strong></p><p><img src="/img/post_img/%E8%AF%A6%E7%BB%86%E7%BC%96%E8%AF%91%E7%A8%8B%E5%BA%8F%E8%BF%87%E7%A8%8B.png"></p><h5 id="解释器"><a href="#解释器" class="headerlink" title="解释器"></a>解释器</h5><blockquote><p>把高级编程语言逐行转译</p><p>执行过程较慢</p></blockquote><p><strong>过程</strong></p><p><img src="/img/post_img/%E8%A7%A3%E9%87%8A%E7%A8%8B%E5%BA%8F%E8%BF%87%E7%A8%8B.png"></p><h4 id="内聚方式"><a href="#内聚方式" class="headerlink" title="内聚方式"></a>内聚方式</h4><blockquote><p>一个模块各个元素彼此结合的紧密程度</p><p>由高到低</p></blockquote><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>功能内聚</td><td>一个模块内所有处理元素完成一个，而且仅完成一个功能</td></tr><tr><td>顺序内聚</td><td>一个模块内处理元素和同一个功能密切相关，而且这些处理元素必须顺序执行(通常前一个处理元素的输出时后一个处理元素的输入)</td></tr><tr><td>通信内聚</td><td>模块内的所有处理元素都在同一个数据结构上操作，或者各处理使用相同的输入数据或者产生相同的输出数据</td></tr><tr><td>过程内聚</td><td>一个模块内的处理元素是相关的，而且必须以特定的次序执行过程。内聚与顺序内聚的区别是：  顺序内聚中是数据流从一个处理单元流到另一个处理单元，而过程内聚是控制流从一个动作流向另一个动作</td></tr><tr><td>时间内聚</td><td>一个模块包含的任务必须在同一段时间内执行</td></tr><tr><td>逻辑内聚</td><td>模块内执行若干个逻辑上相似的功能，通过参数确定该模块完成哪一个功能</td></tr><tr><td>偶然内聚</td><td>一个模块由完成若干毫无关系的功能处理元素偶然组合在一起，各处理元素之间没有任何联系</td></tr></tbody></table><h4 id="耦合方式"><a href="#耦合方式" class="headerlink" title="耦合方式"></a>耦合方式</h4><blockquote><p>由高到低</p></blockquote><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>内容耦合</td><td>一个模块<strong>直接访问另一模块</strong>的内容</td></tr><tr><td>公共耦合</td><td>一组模块都访问同一个<strong>全局数据结构</strong></td></tr><tr><td>外部耦合</td><td>一组模块都访问同一<strong>全局简单变量</strong></td></tr><tr><td>控制耦合</td><td>模块之间传递的不是数据信息，而是<strong>控制信息</strong>例如标志、开关量等，一个模块控制了另一个模块的功能</td></tr><tr><td>标记耦合</td><td>通过参数表传递<strong>记录信息(数据结构)</strong></td></tr><tr><td>数据耦合</td><td>调用模块和被调用模块之间只传递<strong>简单的数据项参数</strong></td></tr><tr><td>非直接耦合</td><td>两个模块之间没有直接关系，它们之间的联系完全是通过主模块的控制和调用来实现的</td></tr></tbody></table><h4 id="软件质量模型"><a href="#软件质量模型" class="headerlink" title="软件质量模型"></a>软件质量模型</h4><table><thead><tr><th>质量特性</th><th>质量子特性</th></tr></thead><tbody><tr><td>功能性</td><td>适合性<br/>准确性<br/>互用性<br/>依从性<br/>安全性</td></tr><tr><td>可靠性</td><td>成熟性<br/>容错性<br/>易恢复性</td></tr><tr><td>易使用性</td><td>易理解性<br/>易学性<br/>易操作性</td></tr><tr><td>效率</td><td>时间特性<br/>资源特性</td></tr><tr><td>可维护性</td><td>易分析性<br/>易改变性<br/>稳定性<br/>易测试性</td></tr><tr><td>可移植性</td><td>适应性<br/>易安装性<br/>一致性<br/>易替换性</td></tr></tbody></table><h4 id="结构化分析组成"><a href="#结构化分析组成" class="headerlink" title="结构化分析组成"></a>结构化分析组成</h4><p>自顶向下：</p><ul><li>数据流图</li><li>数据字典: 数据库中数据的描写叙述</li><li>加工逻辑</li></ul><h4 id="CPU构成"><a href="#CPU构成" class="headerlink" title="CPU构成"></a>CPU构成</h4><blockquote><p>CPU主要由运算器、控制器、寄存器和内部总线等部件组成</p></blockquote><p><img src="/img/post_img/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E6%A1%86%E5%9B%BE.png" alt="计算机组成框图"></p><p>运算器：</p><ol><li><p>算术逻辑单元(Arithmetic Logic Unit，ALU)：负责数据处理，实现对数据的算术运算和逻辑运算等</p></li><li><p>累加寄存器(Accumulator, AC)：当ALU执行算术或是逻辑运算的时候，为ALU提供一个工作区，<strong>提供数据并暂时存储计算结果</strong>，是一个通用寄存器</p></li><li><p>数据缓冲寄存器(Data Register,DR)：作为CPU和内存，外围设备之间数据的中转站。是CPU和内存，外围设备之间在操作速度上的缓冲</p></li><li><p>状态条件寄存器(Program Status Word, PSW)：保存由算术指令和逻辑指令运行或测试的结果建立的各种条件码内容，如运算结果进位标志</p></li></ol><p>控制器：</p><ol><li>程序计数器(Program Counter, PC)：具有寄存信息和记数两种功能，<strong>存放的是指令的地址</strong>，还有计数的功能，又称为指令计数器。</li><li>指令寄存器(Instruction Register，IR)：当CPU执行一条指令时，<strong>先把它从内存储器取到指令缓存器中</strong>，再送入到指令寄存器中，然后经过指令译码器的译码，从而产生各种微操作。</li><li>地址寄存器(Address Register，AR): 存放的是cpu访问内存单元的地址</li><li>指令译码器（Instruction Decoder, ID）:指令译码器对指令的操作码和地址码进行<strong>解析</strong>，转换成相应的操作信号</li></ol><h4 id="保护计算机软件著作权的法律"><a href="#保护计算机软件著作权的法律" class="headerlink" title="保护计算机软件著作权的法律"></a>保护计算机软件著作权的法律</h4><p>《中华人民共和国著作权法》和《计算机软件保护条例》</p><h4 id="中断向量"><a href="#中断向量" class="headerlink" title="中断向量"></a>中断向量</h4><blockquote><p>记录每个不同中断发生后要跳转的中断服务程序的其实地址</p></blockquote><p>中断向量提供中断服务程序入口地址</p><h4 id="总线"><a href="#总线" class="headerlink" title="总线"></a>总线</h4><blockquote><p>计算机设备和设备之间传输信息的公共数据通道</p></blockquote><p>总线分为数据总线（Data Bus，DB）、地址总线（Address Bus，AB）和控制总线（Control Bus，CB）</p><ul><li>数据总线：用来传送数据信息，是双向的</li><li>地址总线：传送CPU发出的地址信息，是单向的，地址总线的宽度决定了CPU的最大寻址能力</li><li>控制总线：传送控制信号、时序信号和状态信息等，每一条线的信息传送方向是单方向，但作为一个整体则是双向的</li></ul><p>常见总线：</p><ul><li>PCI总线。PCI总线是目前微型机上广泛采用的<strong>内总线</strong>，采用<strong>并行传输</strong>方式。</li><li>PCI Express总线。PCI Express简称为PCI-E，采用点对点<strong>串行</strong>连接，每个设备都有自己的专用连接，不需要向整个总线请求带宽，而且可以把数据传输率提高到一个很高的频率。相对于传统PCI总线在单一时间周期内只能实现单向传输，PCI Express的半双工连接能提供更高的传输速率和质量。</li><li>SCSI总线。小型计算机系统接口（SCSI）是一条<strong>并行外总线</strong>，广泛用于连接软硬磁盘、光盘、扫描仪等。</li><li>SATA。SATA是Serial ATA的缩写，即串行ATA，它主要用作主板和大量存储设备（如硬盘及光盘驱动器）之间的数据传输之用。</li><li>USB。通用串行总线</li></ul><h4 id="统一过程-UP"><a href="#统一过程-UP" class="headerlink" title="统一过程(UP)"></a>统一过程(UP)</h4><p>阶段里程碑：</p><ol><li>初启阶段：生命周期目标</li><li>精化阶段：生命周期架构</li><li>构建阶段：初始运作功能</li><li>移交阶段：产品发布</li><li>产生阶段</li></ol><h4 id="网关协议"><a href="#网关协议" class="headerlink" title="网关协议"></a>网关协议</h4><p><strong>内部网关协议</strong>(IGP, 在一个域中选择路由)：</p><ul><li>RIP(路由信息协议)：相邻路由器交换路由表</li><li>OSPF(最短路径优先):  路由器之间通告网络接口的状态来建立链路状态数据库</li></ul><p><strong>外部网关协议</strong>(EGP, 两个相邻的位于各自域边界上的路由器提供一种交换消息和信息的方法):</p><ul><li>BGP</li></ul><h4 id="环路复杂度"><a href="#环路复杂度" class="headerlink" title="环路复杂度"></a>环路复杂度</h4><p>计算方式：</p><ol><li>流图G的环形复杂度V(G)&#x3D;m-n+2，其中，m是流图中边的条数，n是结点数。</li><li>流图G的环形复杂度V(G)&#x3D;P+1，其中，P是流图中判定结点的数目。</li></ol><h4 id="浮点数加法"><a href="#浮点数加法" class="headerlink" title="浮点数加法"></a>浮点数加法</h4><p>小阶对大阶，尾数向右移</p><h4 id="CMMI成熟度模型"><a href="#CMMI成熟度模型" class="headerlink" title="CMMI成熟度模型"></a>CMMI成熟度模型</h4><blockquote><p>方便记忆方法：描述（说明）是名称产生的结果。</p></blockquote><table><thead><tr><th>等级编号</th><th>等级</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>未执行、未完成</td><td>过程域未被执行或未得到CL1所定义的目标</td></tr><tr><td>1</td><td>已执行</td><td>共性目标是将可标识的输入工作产品转成输出产品，满足过程域的特定目标。</td></tr><tr><td>2</td><td>已管理</td><td>已管理的过程制度化，所有工作任务和产品都被监控</td></tr><tr><td>3</td><td>已定义</td><td>已定义的过程制度化，收集过程资产和度量，并用来将来对过程进行改进</td></tr><tr><td>4</td><td>定量管理</td><td>在过程域中引入度量，并利用度量进行管理</td></tr><tr><td>5</td><td>优化的</td><td>使用量化（统计学）手段改变和优化过程域，以满足客户的改变和持续,改进计划中的过程域的功效</td></tr></tbody></table><h4 id="海明码"><a href="#海明码" class="headerlink" title="海明码"></a>海明码</h4><ul><li><p>核心公式：<strong>2r ≥k+r+1</strong> (k为信息的个数，r为校验位的个数)</p></li><li><p>校验码Pi 必须是在2的n次方位置</p></li><li><p>确定校正位的数值：首先必须<strong>知道哪些信息位需要校正位来校正</strong>，校正的原则：想要校正第几（i）位，则应该满足对应的那几个校正位相加等于i。例如3&#x3D;1+2；7&#x3D;1-+2+4。然后校正位的值为对应信息位的<strong>异或</strong></p></li></ul><h4 id="数据仓库"><a href="#数据仓库" class="headerlink" title="数据仓库"></a>数据仓库</h4><ul><li>数据提取（Data Extraction）指根据一定的目的，<strong>从原始文献中摘录所需要的信息</strong>，以作进一步存储、换算和分析的过程</li><li>OLAP(Online Analytical Processing) 是<strong>在线分析处理</strong>，顾名思义就是OLAP是<strong>用于数据分析</strong>的；因此，它使我们能够同时分析来自多个数据库系统的信息。换句话说，我们可以说它是一种计算方法，可以让用户轻松提取所需的数据并查询数据，以便从不同的角度进行分析</li><li>OLTP (On-Line Transaction Processing)称为面向交易的处理过程，其基本特征是前台接收的用户数据可以立即传送到计算中心进行处理，并在很短的时间内给出处理结果，是对用户操作快速响应的方式之一。</li><li>ETL(Extract, transform, load)是将业务系统的数据经过抽取、清洗转换之后加载到数据仓库的过程，目的是将企业中的分散、零乱、标准不统一的数据整合到一起，为企业的决策提供分析依据</li></ul><h4 id="常见端口"><a href="#常见端口" class="headerlink" title="常见端口"></a>常见端口</h4><table><thead><tr><th>端口名</th><th>端口号</th></tr></thead><tbody><tr><td>简单邮件传输协议(SMPT)</td><td>25</td></tr><tr><td>邮局协议(POP3)</td><td>110</td></tr><tr><td>超文本传输协议(HTTP)</td><td>80</td></tr><tr><td>加密的超文本传输(HTTPS)</td><td>443</td></tr><tr><td>文件传输服务(FTP)</td><td>20数据端口，21命令控制端口</td></tr><tr><td>域名服务(DNS)</td><td>53</td></tr><tr><td>远程登录(Telnet)</td><td>23</td></tr></tbody></table><h4 id="网络攻击"><a href="#网络攻击" class="headerlink" title="网络攻击"></a>网络攻击</h4><blockquote><p> 分为主动攻击和被动攻击两种</p></blockquote><p>主动攻击包括：</p><blockquote><p>主动攻击是攻击者主动做一些不利于你的系统的事情</p></blockquote><ul><li>拒绝服务攻击(DOS)</li><li>分布式Dos(DDOS)</li><li>信息篡改</li><li>资源使用</li><li>欺骗、伪装、重放等</li></ul><p>被动攻击包括：</p><blockquote><p>被动攻击主要是搜集信息而不是进行访问</p></blockquote><ul><li>嗅探</li><li>信息搜集等</li></ul><h4 id="入侵检测"><a href="#入侵检测" class="headerlink" title="入侵检测"></a>入侵检测</h4><ul><li>专家系统</li><li>模型检测</li><li>简单匹配</li></ul><h4 id="常用中间代码"><a href="#常用中间代码" class="headerlink" title="常用中间代码"></a>常用中间代码</h4><ul><li>后缀式</li><li>三地址码</li><li>树</li><li>四元式</li></ul><h4 id="软件维护类型"><a href="#软件维护类型" class="headerlink" title="软件维护类型"></a>软件维护类型</h4><ul><li>改正性：改正在系统开发阶段已发生而系统测试阶段尚未发现的错误</li><li>适应性：使应用软件适应信息技术变化和管理需求变化而进行的修改</li><li>完善性：增加一些在系统分析和设计阶段中没有规定的功能与性能特征</li><li>预防性：改进应用软件的可靠性和可维护性</li></ul><p>​</p><h4 id="DNS域名查询次序"><a href="#DNS域名查询次序" class="headerlink" title="DNS域名查询次序"></a>DNS域名查询次序</h4><p>本机hosts –&gt; 本地DNS缓存 –&gt; 本地DNS服务器 –&gt; 根域名服务器</p><h4 id="敏捷方法"><a href="#敏捷方法" class="headerlink" title="敏捷方法"></a>敏捷方法</h4><ul><li>极限编程XP：激发开发人员创造性、使得管理负担最小的一组技术</li><li>自适应软件开发：核心是三个非线性的、重送的开发阶段:猜测,合作与学习</li><li>水晶方法：水晶方法体系考虑到人们一般很难严格遵循一个纪律约束很强的过程,<strong>认为每一种不同的项目都需要一套不同的策略、约定和方法论</strong>。</li><li>并列争球法：用<strong>迭代</strong>的方法,其中把每<strong>30天一次的迭代称为一个“冲刺”</strong>,并按需求的优先级来实现产品。多个自组织和自治小组并行地递增实现产品。协调是通过简短的日常会议来进行的。</li></ul><h4 id="成本估算"><a href="#成本估算" class="headerlink" title="成本估算"></a>成本估算</h4><ul><li><strong>专家估算</strong>：根据专家的行业经验和历史数据对软件开发过程的成本进行估算。</li><li><strong>Wolverton</strong>：也叫loc方法，通过执行的源代码函数来进行成本估算，估算准确性低，现在已经不用了。</li><li><strong>COCOMO</strong>：构造性成本模型，是一种参数化的成本估算方法。例如通过软件的难度、规模等作为参数进行成本估算。</li><li><strong>COCOMOⅡ</strong>：COCOMOⅡ是对COCOMO作出的改进版，把最新软件开发方法考虑在内。COCOMOⅡ由三个不同的计算模型组成：<br>1）应用组合模型：适用于使用现代GUI工具开发的项目。<br>2）早期开发模型：适用于在软件架构确定之前对软件进行粗略的成本和事件估算，包含了一系列的新的成本和进度估算方法。基于功能点或者代码行。<br>3）结构化后期模型：是COCOMOⅡ中最详细的模型。它使用在整体软件架构已确定之后。包含最新的成本估算、代码行计算方法。</li></ul><h4 id="系统性能评测"><a href="#系统性能评测" class="headerlink" title="系统性能评测"></a>系统性能评测</h4><ul><li><strong>可靠性</strong>：一个系统对于给定时间间隔内、在给定条件下失效运作的概率。可用MTTF &#x2F; （1 + MTTF）来度量，MTTF为平均无故障时间。</li><li><strong>可用性</strong>：在给定的时间点上，一个系统能够按照规格说明正确运作的概率。可用MTBF &#x2F;（1 + MTBF）来度量，MTBF为平均失效间隔时间。</li><li><strong>可维护性</strong>：在给定的使用条件下，在规定的时间间隔内，使用规定的过程和资源完成维护活动的概率。可用 1 &#x2F; （1 + MTTR）来度量，其中MTTR为平均修复时间。</li></ul><h4 id="Cache与主存的三种地址映射方式"><a href="#Cache与主存的三种地址映射方式" class="headerlink" title="Cache与主存的三种地址映射方式"></a>Cache与主存的三种地址映射方式</h4><ol><li><p>全相联映射</p><blockquote><p>Cache 中的<strong>任意</strong>一行可以存放主存中的<strong>任意</strong>一块</p></blockquote></li><li><p>直接映射</p><blockquote><p>主存中每个区的第 i 块会映射到Cache中的第 i 行，主存中的某块只能映射到<strong>特定</strong>的Cache一行中</p></blockquote></li><li><p>组相联映射</p><blockquote><p>是全相联映射与直接映射之间的折中方式，主存中的某块可以映射到Cache一组行中的其中一个上</p></blockquote></li></ol><h4 id="IO软件层次"><a href="#IO软件层次" class="headerlink" title="IO软件层次"></a>IO软件层次</h4><p><img src="/img/post_img/IO%E8%BD%AF%E4%BB%B6%E5%B1%82%E6%AC%A1.png"></p><h4 id="软件测试阶段和测试策略"><a href="#软件测试阶段和测试策略" class="headerlink" title="软件测试阶段和测试策略"></a>软件测试阶段和测试策略</h4><p>测试阶段</p><ol><li>单元测试</li><li>集成测试</li><li>系统测试</li></ol><p>测试策略</p><ul><li>自底向上：从最底层的构建开始测试</li><li>自顶向下：从最顶层的构建开始测试</li><li>三明治：结合自底向上和自顶向下</li><li>一次性：对所有构建一次性测试，然后集成</li></ul><h4 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h4><blockquote><p>完全依赖：用<strong>候选码</strong>中全部的值才能决定 <strong>非主属性</strong></p></blockquote><p>​第一范式（1NF）：所有的属性不可再分；</p><p>​    第二范式（2NF）：非键属性<strong>完全依赖</strong>于主键；</p><p>​    第三范式（3NF）：非主性属性没有传递依赖；</p><p>​    BCNF：任何一个函数依赖中决定因素都是候选码；</p><h4 id="递归复杂度计算公式"><a href="#递归复杂度计算公式" class="headerlink" title="递归复杂度计算公式"></a>递归复杂度计算公式</h4><p>T(N) &#x3D; a * T(N&#x2F;b) + O(N^d)</p><ol><li>当logb(a) &gt; d, O(N^logb(a))</li><li>当logb(a) &lt; d, O(N^d)</li><li>当logb(a) &#x3D; d, O(N^d * logN)</li></ol><h4 id="计算机病毒"><a href="#计算机病毒" class="headerlink" title="计算机病毒"></a>计算机病毒</h4><ul><li>木马病毒：冰河</li><li>蠕虫病毒：欢乐时光、熊猫烧香、红色代码、爱虫病毒、震网</li><li>宏病毒：感染的主要目标是文本文档、电子表格等</li></ul><h4 id="DHCP客户端可从DHCP服务器获得"><a href="#DHCP客户端可从DHCP服务器获得" class="headerlink" title="DHCP客户端可从DHCP服务器获得"></a>DHCP客户端可从DHCP服务器获得</h4><ul><li>本机IP地址、</li><li>DNS服务器地址、</li><li>DHCP服务器地址、</li><li>默认网关地址，</li><li>但没有Web服务器、邮件服务器地址</li></ul><h4 id="多态分类"><a href="#多态分类" class="headerlink" title="多态分类"></a>多态分类</h4><ul><li><p><strong>参数多态</strong>：采用参数化模板，通过给出不同的类型参数，使得一个结构有多种类型。</p><p>例如：泛型</p></li><li><p><strong>包含多态</strong>：同样的操作可用于一个类型及其子类型 （重写）</p></li><li><p><strong>过载多态</strong>：同一个名（操作符﹑函数名）在不同的上下文中有不同的类型 （重载）</p></li><li><p><strong>强制多态</strong>：<em>把操作对象的</em>类型强行加以变换，以符合函数或操作符的要求</p></li></ul><h4 id="Flynn分类法"><a href="#Flynn分类法" class="headerlink" title="Flynn分类法"></a>Flynn分类法</h4><ul><li>单指令流单数据流机器（SISD）传统串行机器</li><li>单指令流多数据流机器（SIMD）一条指令流</li><li>多指令流单数据流机器（MISD）只有理论意义而无实例</li><li>多指令流多数据流机器（SISD）同时多个指令流</li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>软考</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>软件过程模型</title>
    <link href="/2022/08/25/%E8%BD%AF%E8%80%83/%E8%BD%AF%E4%BB%B6%E8%BF%87%E7%A8%8B%E6%A8%A1%E5%9E%8B/"/>
    <url>/2022/08/25/%E8%BD%AF%E8%80%83/%E8%BD%AF%E4%BB%B6%E8%BF%87%E7%A8%8B%E6%A8%A1%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="软件过程模型"><a href="#软件过程模型" class="headerlink" title="软件过程模型"></a>软件过程模型</h2><h4 id="瀑布模型"><a href="#瀑布模型" class="headerlink" title="瀑布模型"></a>瀑布模型</h4><p><img src="/img/post_img/%E7%80%91%E5%B8%83%E6%A8%A1%E5%9E%8B.png"></p><blockquote><p>又称为经典生命周期模型，<strong>以文档作为驱动</strong>、适合于软件需求很明确的软件项目或二次开发的模型。</p></blockquote><p>优点:</p><ul><li>容易理解，管理成本低。</li></ul><p>缺点:</p><ul><li>必须能够完整、正确和清晰地表达需要</li><li>变更需求困难</li><li>很难评估真正的进度</li><li>对于项目风险的控制能力较弱，从而导致项目常常延期完成，开发费用超出预算</li><li>任务之间存在依赖性，开发团队的一些成员要等待另一些成员工作完成。</li></ul><h5 id="V模型"><a href="#V模型" class="headerlink" title="V模型"></a>V模型</h5><p><img src="/img/post_img/V%E6%A8%A1%E5%9E%8B.png"></p><blockquote><p>瀑布模型的一个变体，强调在各个阶段进行测试和验证，以提升软件质量。</p></blockquote><p>优点:</p><ul><li>相较于瀑布模型提升了软件质量</li></ul><p>缺点:</p><ul><li>更耗费人力和时间</li></ul><h4 id="增量模型"><a href="#增量模型" class="headerlink" title="增量模型"></a>增量模型</h4><p><img src="/img/post_img/%E5%A2%9E%E9%87%8F%E6%A8%A1%E5%9E%8B.png"></p><blockquote><p>先开发出一个初始的实现，听取用户的使用意见，通过不断修改直到产生一个充分的版本</p><p>适合小型项目或需要快速上线的项目</p></blockquote><p>优点:</p><ul><li>可以更经济、更容易、更快速的变更</li><li>交付和部署更快</li><li>用户可以更早的使用软件并创造价值</li></ul><p>缺点:</p><ul><li>如果没有对用户的变更需求进行规划，致缺乏整体规划，导致功能堆砌</li><li>越往后变更越困难，成本逐渐上升</li></ul><h4 id="演化模型"><a href="#演化模型" class="headerlink" title="演化模型"></a>演化模型</h4><h5 id="原型模型"><a href="#原型模型" class="headerlink" title="原型模型"></a>原型模型</h5><p><img src="/img/post_img/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%9E%8B.png"></p><blockquote><p>一个软件系统的最初版本，用于验证概念、适用设计选型、发现更多的问题和可能的解决方法。</p><p>原型是为定义需求服务的，在需求明确后，原型需要丢弃（至少部分丢弃）。</p><p>适用于需求不明确时</p></blockquote><p>优点:</p><ul><li>有助于启发和验证系统需求</li></ul><p>缺点:</p><ul><li>开发快没有文档，不利于维护</li><li>容易忽略性能、安全、可靠性等要素</li></ul><h5 id="螺旋模型"><a href="#螺旋模型" class="headerlink" title="螺旋模型"></a>螺旋模型</h5><p><img src="/img/post_img/%E8%9E%BA%E6%97%8B%E6%A8%A1%E5%9E%8B.png"></p><p>将过程（项目阶段）用螺旋线表示，每个螺旋线构成一个回路，每个回路由不同的风险驱动，根据这些风险，在每个阶段规划可选的策略方案。</p><blockquote><p>是一种<strong>风险驱动</strong>型的过程模型</p><p>结合了原型的迭代性质和瀑布模型的系统性和可控性特点。</p></blockquote><p>优点:</p><ul><li>实现风险管理，降低变更风险</li><li>支持用户需求的动态变化</li></ul><p>缺点:</p><ul><li>需要开发人员具有相当丰富的风险评估经验和专门知识</li><li>过多的迭代次数会增加开发成本，延迟提交时间</li></ul><h4 id="喷泉模型"><a href="#喷泉模型" class="headerlink" title="喷泉模型"></a>喷泉模型</h4><p><img src="/img/post_img/%E5%96%B7%E6%B3%89%E6%A8%A1%E5%9E%8B.png"></p><blockquote><p><strong>以用户需求为动力，以对象作为驱动</strong>的模型，适合于<strong>面向对象</strong>的开发方法</p><p>该模型认为软件开发过程自下而上周期的各阶段是相互迭代和无间隙的</p></blockquote><p>优点:</p><ul><li>功能需求、功能模块间的关系、数据流等描述清楚</li></ul><p>缺点:</p><ul><li>开发阶段是重叠的，开发过程中需要大量的开发人员，不利于项目的管理。</li><li>需要严格的管理文档，使得审核的难度加大。</li></ul><h4 id="基于构件的开发模型"><a href="#基于构件的开发模型" class="headerlink" title="基于构件的开发模型"></a>基于构件的开发模型</h4><p><img src="/img/post_img/%E5%9F%BA%E4%BA%8E%E6%9E%84%E4%BB%B6%E7%9A%84%E5%BC%80%E5%8F%91%E6%A8%A1%E5%9E%8B.png"></p><blockquote><p>利用预先包装的构件来构造应用系统</p><p><strong>快速开发</strong></p><p>本质上是演化模型，需要以迭代方式构建软件</p></blockquote><h4 id="形式化方法模型"><a href="#形式化方法模型" class="headerlink" title="形式化方法模型"></a>形式化方法模型</h4><blockquote><p>建立在<strong>严格数学基础上</strong>的一种软件开发方法，其主要活动是生成计算机软件形式化的数学规格说明。</p></blockquote><h4 id="敏捷方法"><a href="#敏捷方法" class="headerlink" title="敏捷方法"></a>敏捷方法</h4><h5 id="极限编程-XP"><a href="#极限编程-XP" class="headerlink" title="极限编程(XP)"></a>极限编程(XP)</h5><blockquote><p>极限是指将我们认同的有效软件开发原理和实践应用到极限，<strong>频繁地去实践</strong></p><p>尽可能早地、持续地对有价值的软件的交付来使客户满意</p><p>使用户能够在发开周期后期改变需求</p><p>极端编程属于轻量级的方法，认为文档、架构不如直接编程来的直接</p></blockquote><h5 id="水晶法"><a href="#水晶法" class="headerlink" title="水晶法"></a>水晶法</h5><blockquote><p>认为每一个不同的项目都需要一套不同的策略</p></blockquote><h5 id="并列争求法"><a href="#并列争求法" class="headerlink" title="并列争求法"></a>并列争求法</h5><h5 id="自适应软件开发"><a href="#自适应软件开发" class="headerlink" title="自适应软件开发"></a>自适应软件开发</h5>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>软考</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>接口管理</title>
    <link href="/2022/08/21/%E5%85%B6%E4%BB%96/%E6%8E%A5%E5%8F%A3%E7%AE%A1%E7%90%86/"/>
    <url>/2022/08/21/%E5%85%B6%E4%BB%96/%E6%8E%A5%E5%8F%A3%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="接口管理"><a href="#接口管理" class="headerlink" title="接口管理"></a>接口管理</h2><h4 id="YApi"><a href="#YApi" class="headerlink" title="YApi"></a>YApi</h4><blockquote><p>一款api管理平台</p></blockquote><p><a href="https://github.com/YMFE/yapi">源码地址</a></p><p>安装比较麻烦，和apifox功能差不多</p><h4 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h4><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Swagger-UI API文档生产工具--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>编写配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Swagger2Config</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">createRestApi</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>            .apiInfo(apiInfo())<br>            .select()<br>            <span class="hljs-comment">//为当前包下controller生成API文档</span><br>            .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.xw.mallLearning.controller&quot;</span>))<br>            <span class="hljs-comment">//为有@Api注解的Controller生成API文档</span><br>            <span class="hljs-comment">//                .apis(RequestHandlerSelectors.withClassAnnotation(Api.class))</span><br>            <span class="hljs-comment">//为有@ApiOperation注解的方法生成API文档</span><br>            <span class="hljs-comment">//                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))</span><br>            .paths(PathSelectors.any())<br>            .build();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>            .title(<span class="hljs-string">&quot;SwaggerUI&quot;</span>)<br>            .description(<span class="hljs-string">&quot;mall-learning&quot;</span>)<br>            .version(<span class="hljs-string">&quot;1.0&quot;</span>)<br>            .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>当swagger版本大于2.6.x且springBoot版本也较高(我测试时是2.7.8)时，需要在配置类中添加以下Bean和配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> BeanPostProcessor <span class="hljs-title function_">springfoxHandlerProviderBeanPostProcessor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPostProcessor</span>() &#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>            <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> WebMvcRequestHandlerProvider) &#123;<br>                customizeSpringfoxHandlerMappings(getHandlerMappings(bean));<br>            &#125;<br>            <span class="hljs-keyword">return</span> bean;<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RequestMappingInfoHandlerMapping</span>&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">customizeSpringfoxHandlerMappings</span><span class="hljs-params">(List&lt;T&gt; mappings)</span> &#123;<br>            List&lt;T&gt; copy = mappings.stream()<br>                .filter(mapping -&gt; mapping.getPatternParser() == <span class="hljs-literal">null</span>)<br>                .collect(Collectors.toList());<br>            mappings.clear();<br>            mappings.addAll(copy);<br>        &#125;<br><br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        <span class="hljs-keyword">private</span> List&lt;RequestMappingInfoHandlerMapping&gt; <span class="hljs-title function_">getHandlerMappings</span><span class="hljs-params">(Object bean)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> ReflectionUtils.findField(bean.getClass(), <span class="hljs-string">&quot;handlerMappings&quot;</span>);<br>                field.setAccessible(<span class="hljs-literal">true</span>);<br>                <span class="hljs-keyword">return</span> (List&lt;RequestMappingInfoHandlerMapping&gt;) field.get(bean);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException | IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(e);<br>            &#125;<br>        &#125;<br>    &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">mvc:</span><br>    <span class="hljs-attr">pathmatch:</span><br>      <span class="hljs-attr">matching-strategy:</span> <span class="hljs-string">ant_path_matcher</span><br></code></pre></td></tr></table></figure></li></ol><p><strong>常用注解</strong></p><p>使文档说明更加易读</p><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@Api</td><td>用在请求类上(如Controller)，表示对类的说明</td></tr><tr><td>@ApiModel</td><td>用在实体类上，表示返回响应数据的信息</td></tr><tr><td>@ApiModelProperty</td><td>用在实体类属性上</td></tr><tr><td>@ApiOperation</td><td>用在请求的方法上，说明方法的用途</td></tr><tr><td>@ApiImplicitParams</td><td>用在请求的方法上，表示一组参数的说明</td></tr><tr><td>@ApiImplicitParam</td><td>用在@ApiImplicitParams中，指定一个参数的各个方面</td></tr></tbody></table><h4 id="knife4j"><a href="#knife4j" class="headerlink" title="knife4j"></a>knife4j</h4><blockquote><p>用来生成各种格式的接口文档</p></blockquote><p>knife4j是集成swagger生成api文档的增强解决方案</p><p><strong>使用步骤</strong></p><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.xiaoymin<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>knife4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>导入配置类</p><p>在mvc配置类上加入两个注解并构建createRestApi方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableSwagger2</span><br><span class="hljs-meta">@EnableKnife4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfigSupport</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebMvcConfigurationSupport</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Docket <span class="hljs-title function_">createRestApi</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Docket</span>(DocumentationType.SWAGGER_2)<br>                .apiInfo(apiInfo())<br>                .select()<br>                .apis(RequestHandlerSelectors.basePackage(<span class="hljs-string">&quot;com.xw.reggie.controller&quot;</span>))<br>                .paths(PathSelectors.any())<br>                .build();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> ApiInfo <span class="hljs-title function_">apiInfo</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiInfoBuilder</span>()<br>                .title(<span class="hljs-string">&quot;瑞吉外卖&quot;</span>)<br>                .version(<span class="hljs-string">&quot;1.0&quot;</span>)<br>                .description(<span class="hljs-string">&quot;瑞吉外码接口文档&quot;</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>在mvc配置类的addResourceHandlers方法中设置静态资源映射</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">registry.addResourceHandler(<span class="hljs-string">&quot;doc.html&quot;</span>).addResourceLocations(<span class="hljs-string">&quot;classpath:/META-INF/resources/&quot;</span>);<br>registry.addResourceHandler(<span class="hljs-string">&quot;/webjars/**&quot;</span>).addResourceLocations(<span class="hljs-string">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);<br></code></pre></td></tr></table></figure></li><li><p>如果有登录状态检测的话要设置放行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//放行的路径</span><br><span class="hljs-string">&quot;/doc.html&quot;</span>,<br><span class="hljs-string">&quot;/webjars/**&quot;</span>,<br><span class="hljs-string">&quot;/swagger-resources&quot;</span>,<br><span class="hljs-string">&quot;/v2/api-docs&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>访问<code>http://localhost:8080/doc.html</code>可以查看接口和导出离线文档</p></li></ol><p><img src="/img/post_img/6452456.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>其他</category>
      
      <category>接口管理</category>
      
    </categories>
    
    
    <tags>
      
      <tag>其他</tag>
      
      <tag>后端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Nginx</title>
    <link href="/2022/08/20/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/"/>
    <url>/2022/08/20/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/</url>
    
    <content type="html"><![CDATA[<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>Nginx是一款轻量级Web服务器&#x2F;反向代理服务器，占用内存少，并发能力强</p><h4 id="下载和安装"><a href="#下载和安装" class="headerlink" title="下载和安装"></a>下载和安装</h4><h5 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h5><ol><li><p><a href="http://nginx.org/en/download.html">官网下载</a></p><p><a href="http://nginx.org/download/">老版本下载</a></p></li><li><p>安装依赖包</p><blockquote><p><strong>GCC编译器</strong>：Nginx是使用C语言编写的程序，因此想要运行Nginx就需要安装一个编译工具。GCC就是一个开源的编译器集合，用于处理各种各样的语言，其中就包含了C语言。</p><p><strong>PCRE</strong>：Nginx在编译过程中需要使用到PCRE库（perl Compatible Regular Expressoin 兼容正则表达式库)，因为在Nginx的Rewrite模块和http核心模块都会使用到PCRE正则表达式语法。</p><p><strong>zlib</strong>：在Nginx的各个模块中需要使用gzip压缩</p><p><strong>OpenSSL</strong>：是一个开放源代码的软件库包，应用程序可以使用这个包进行安全通信，并且避免被窃听。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs linux"># -y表示需要用户确认的地方默认yes<br>yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel<br></code></pre></td></tr></table></figure></li><li><p>解压nginx安装包</p><blockquote><p>最好放到一个特定的目录下管理，以后删除还需要</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">tar -zxvf nginx-1.16.1.tar.gz<br></code></pre></td></tr></table></figure></li><li><p>进入目录执行命令来安装nginx</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss">检查环境，配置环境变量，设置安装到哪<br>./configure --prefix=安装路径<br>编译安装<br><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install<br></code></pre></td></tr></table></figure></li></ol><h5 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h5><blockquote><p>相比源码安装，会添加有很多额外的配置信息</p></blockquote><ol><li><p>通过yum进行安装</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y nginx<br></code></pre></td></tr></table></figure></li><li><p>查看安装的目录</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">whereis nginx</span><br></code></pre></td></tr></table></figure></li><li><p>启动</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># 默认安装到了<span class="hljs-regexp">/usr/</span>sbin，配置文件在<span class="hljs-regexp">/etc/</span>ngin/nginx.conf<br>cd <span class="hljs-regexp">/usr/</span>sbin<br># 启动<br>./nginx<br></code></pre></td></tr></table></figure></li></ol><h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><h5 id="源码方式"><a href="#源码方式" class="headerlink" title="源码方式"></a>源码方式</h5><ol><li><p>停止nginx</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">./nginx -s stop<br></code></pre></td></tr></table></figure></li><li><p>删除nginx文件夹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf nginx/<br></code></pre></td></tr></table></figure></li><li><p>到之前解压出来的源码目录下</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make clean</span><br></code></pre></td></tr></table></figure></li></ol><h5 id="yum方式"><a href="#yum方式" class="headerlink" title="yum方式"></a>yum方式</h5><ol><li><p>停止nginx</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">./nginx -s stop<br>service nginx stop<br></code></pre></td></tr></table></figure></li><li><p>删除nginx自动启动</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">chkconfig</span> nginx <span class="hljs-literal">off</span><br></code></pre></td></tr></table></figure></li><li><p>删除nginx本地文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -rf <span class="hljs-regexp">/usr/</span>sbin/nginx<br>rm -rf <span class="hljs-regexp">/etc/</span>nginx<br>rm -rf <span class="hljs-regexp">/etc/i</span>nit.d/nginx<br></code></pre></td></tr></table></figure></li><li><p>yum清理</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">yum <span class="hljs-built_in">remove</span> nginx<br></code></pre></td></tr></table></figure></li></ol><h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><ul><li>conf&#x2F;nginx.confnginx配置文件</li><li>conf&#x2F;mime.types  HTTP协议中Content-Type的值和文件后缀名对应关系</li><li>html                        存放静态文件</li><li>logs                         存放日志</li><li>sbin                         二进制文件，用于启动、停止nginx</li></ul><h4 id="启动-x2F-关闭方式"><a href="#启动-x2F-关闭方式" class="headerlink" title="启动&#x2F;关闭方式"></a>启动&#x2F;关闭方式</h4><h5 id="信号控制方式"><a href="#信号控制方式" class="headerlink" title="信号控制方式"></a>信号控制方式</h5><table><thead><tr><th>信号</th><th>作用</th></tr></thead><tbody><tr><td>TERM&#x2F;INT</td><td>立即关闭整个服务</td></tr><tr><td>QUIT</td><td>“优雅”地关闭整个服务</td></tr><tr><td>HUP</td><td>重读配置文件并使用服务对新配置项生效</td></tr><tr><td>USR1</td><td>重新打开日志文件，可以用来进行日志切割</td></tr><tr><td>USR2</td><td>平滑升级到最新版的nginx</td></tr><tr><td>WINCH</td><td>所有子进程不在接收处理新连接，相当于给work进程发送QUIT指令</td></tr></tbody></table><p> 通过<code>kill -signal PID</code>来使用</p><h5 id="命令方式"><a href="#命令方式" class="headerlink" title="命令方式"></a>命令方式</h5><p><code>./nginx -h</code> 查看所有参数</p><p><code>-t</code>：检查配置文件是否有错误</p><p><code>-s</code>：signal信号，后面可以跟stop[快速关闭]、quit[优雅关闭]、reopen[重新加载日志文件]、reload[重新加载配置文件]</p><p><code>-c</code>：指定配置文件</p><h4 id="平滑升级"><a href="#平滑升级" class="headerlink" title="平滑升级"></a>平滑升级</h4><p>不需要停止nginx服务器就可以升级版本</p><ol><li><p>准备两个版本的Nginx分别是 1.14.2和1.16.1，1.14.2的编译安装，1.16.1的只需要编译</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 1.14.2</span><br>./configure<br><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install<br><span class="hljs-meta"># 1.16.1</span><br>./configure<br><span class="hljs-built_in">make</span><br></code></pre></td></tr></table></figure></li><li><p>首先备份老版本的nginx下的<code>sbin/nginx</code></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>sbin<br>mv nginx nginxold<br></code></pre></td></tr></table></figure></li><li><p>拷贝新版本的nginx的<code>/objs/nginx</code>到老版本nginx的<code>sbin/</code>目录下</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd ~<span class="hljs-regexp">/nginx/</span>core<span class="hljs-regexp">/nginx-1.16.1/</span>objs<br>cp nginx <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>sbin<br></code></pre></td></tr></table></figure></li><li><p>执行<code>make upgrade</code>进行升级</p></li><li><p><code>./nginx -v</code>查看版本</p></li></ol><h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs linux">nginx目录下<br><br>1.查看nginx版本<br>./sbin/nginx -v<br><br>2.测试配置文件是否有错<br>./sbin/nginx -t<br><br>3.启动nginx服务<br>./sbin/nginx<br><br>4.停止nginx服务<br>./sbin/nginx -s stop<br><br>5.修改过配置文件后，重新加载配置文件<br>./sbin/nginx -s reload<br></code></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>分为三大块：全局块、events块、http块</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs conf">worker_processes  1;<br><br>events &#123;<br>    worker_connections  1024;<br>&#125;<br><br>http &#123;<br>    include       mime.types;<br>    default_type  application/octet-stream;<br>    sendfile        on;<br>    keepalive_timeout  65;<br><br>    server &#123;<br>        listen       80;<br>        # 支持正则，以~开头，如:~^www\.\w+\.com;<br>        server_name  localhost;<br>        location / &#123;<br>            root   html;<br>            index  index.html index.htm;<br>        &#125;<br>        error_page   500 502 503 504  /50x.html;<br>        location = /50x.html &#123;<br>            root   html;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h5 id="全局块"><a href="#全局块" class="headerlink" title="全局块"></a>全局块</h5><h6 id="user指令"><a href="#user指令" class="headerlink" title="user指令"></a>user指令</h6><p>指定启动运行工作进程的用户及用户组，这样对于系统的权限访问控制的更加精细，也更加安全。</p><ol><li><p>在配置文件中设置用户信息</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">user</span> <span class="hljs-title">www</span>;<br></code></pre></td></tr></table></figure></li><li><p>创建一个linux用户</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">useradd www</span><br></code></pre></td></tr></table></figure></li><li><p>创建<code>/home/www/html/index.html</code> 文件，在www用户目录下用户有访问权限</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">    <span class="hljs-selector-tag">body</span> &#123;</span><br><span class="language-css">        <span class="hljs-attribute">width</span>: <span class="hljs-number">35em</span>;</span><br><span class="language-css">        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;</span><br><span class="language-css">        <span class="hljs-attribute">font-family</span>: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="language-css">    &#125;</span><br><span class="language-css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>For online documentation and support please refer to<br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>.<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>Commercial support is available at<br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>Thank you for using nginx.<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>I am WWW<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置，测试访问</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-keyword">location</span> / &#123;<br>root   /home/www/html;<br><span class="hljs-keyword">index</span>  <span class="hljs-keyword">index</span>.html <span class="hljs-keyword">index</span>.htm;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h6 id="work-process指令"><a href="#work-process指令" class="headerlink" title="work process指令"></a>work process指令</h6><ol><li><code>master_process on|off</code>：用来指定是否开启<strong>工作进程</strong>，默认on</li><li><code>worker_processes num/auto</code>：配置Nginx生成工作进程的数量，建议将该值和服务器CPU的内核数保存一致</li></ol><blockquote><p>这两个配置完要停止nginx再启动才会生效</p></blockquote><h6 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h6><table><thead><tr><th>指令</th><th>作用</th></tr></thead><tbody><tr><td>daemon on|off</td><td>设定Nginx是否以守护进程的方式启动，默认on</td></tr><tr><td>pid file</td><td>配置Nginx当前master进程的进程号ID存储的文件路径</td></tr><tr><td>error_log  file [日志级别]</td><td>配置Nginx的错误日志存放路径，日志级别越低显示的信息越多</td></tr><tr><td>include file</td><td>引入其他配置文件</td></tr></tbody></table><h5 id="events块"><a href="#events块" class="headerlink" title="events块"></a>events块</h5><p>主要用来设置nginx和用户的网络连接</p><table><thead><tr><th>指令</th><th>作用</th></tr></thead><tbody><tr><td>accept_mutex on|off</td><td>设置Nginx网络连接序列化。off时为当来了一个请求，会唤醒多个worker来竞争; on时则将会对多个Nginx进程接收连接进行序列号，一个个来唤醒接收</td></tr><tr><td>multi_accept on|off</td><td>设置一个工作进程是否允许同时接收多个网络连接</td></tr><tr><td>worker_connections number</td><td>配置单个worker进程最大的连接数，默认512</td></tr><tr><td>use  method</td><td>设置Nginx服务器选择哪种事件驱动来处理网络消息，select&#x2F;poll&#x2F;epoll&#x2F;kqueue</td></tr></tbody></table><p>例子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs conf">events &#123;<br>    accept_mutex on;<br>    multi_accept on;<br>    use epoll;<br>    worker_connections  1024;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="http块"><a href="#http块" class="headerlink" title="http块"></a>http块</h5><h6 id="指定MIME-Type"><a href="#指定MIME-Type" class="headerlink" title="指定MIME-Type"></a>指定MIME-Type</h6><p>通过<code>default_type mime-type;</code>来指定返回数据的类型，可以配置在http、server、location中</p><p>例子</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">location</span> <span class="hljs-title">/get_text</span> &#123;<br><span class="hljs-comment">#这里也可以设置成text/plain</span><br>    default_type text/html;<br>    return <span class="hljs-number">200</span> <span class="hljs-string">&quot;This is nginx&#x27;s text&quot;</span>;<br>&#125;<br><span class="hljs-keyword">location</span> <span class="hljs-title">/get_json</span>&#123;<br>    default_type application/json;<br>    return <span class="hljs-number">200</span> &#x27;&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;TOM&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>&#125;&#x27;;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="自定义服务日志"><a href="#自定义服务日志" class="headerlink" title="自定义服务日志"></a>自定义服务日志</h6><table><thead><tr><th>指令</th><th>作用</th></tr></thead><tbody><tr><td>access_log path [format]</td><td>设计用户访问请求日志的位置，后面可以跟日志输出格式</td></tr><tr><td>log_format name</td><td>指定日志的输出格式</td></tr><tr><td>sendfile on|off</td><td>是否使用sendfile()传输文件，该属性可以大大提高Nginx处理静态资源的性能</td></tr><tr><td>keepalive_timeout time</td><td>设置长连接的超时时间</td></tr><tr><td>keepalive_requests number</td><td>设置一个keep-alive连接使用的次数</td></tr></tbody></table><h6 id="server块和location块"><a href="#server块和location块" class="headerlink" title="server块和location块"></a>server块和location块</h6><p>server块</p><table><thead><tr><th>指令</th><th>作用</th></tr></thead><tbody><tr><td>listen address[:port]</td><td>配置监听端口</td></tr><tr><td>server_name  name</td><td>设置虚拟主机服务名称。可用正则，如果同时匹配多个，则选最精确的</td></tr></tbody></table><p>location块</p><ol><li><p>location [  &#x3D;  |~  |<del>*   |^</del>   |@ ] uri{…}</p><p>设置请求的URI，&#x3D;精确匹配，<del>正则，</del>*正则不区分大小写，^~用于不包含正则表达式的uri前(和不加符号功能一致，但如果模式匹配，就停止搜索其他模式)</p></li><li><p>root &#x2F; alias path</p><p>root的处理结果是: root路径+location路径<br>alias的处理结果是:使用alias路径替换location路径<br>alias是一个目录别名的定义，root则是最上层目录的含义。<br>如果location路径是以&#x2F;结尾,则alias也必须是以&#x2F;结尾，root没有要求</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># 浏览器<span class="hljs-string">&#x27;/images/1.png&#x27;</span> 匹配到 <span class="hljs-string">&#x27;/usr/local/nginx/html/images/1.png&#x27;</span><br>location /images &#123;<br>root <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>html;<br>&#125;<br><br># 浏览器<span class="hljs-string">&#x27;/images/1.png&#x27;</span> 匹配到 <span class="hljs-string">&#x27;/usr/local/nginx/html/1.png&#x27;</span><br>location /images &#123;<br>alias <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>html;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>index path</p><p>设置网站的默认首页</p></li><li><p>error_page code … [&#x3D;[response]] uri</p><p>设置网站的错误页面</p><p>后面可以跟具体地址、重定向地址</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">server</span> &#123;<br>error_page <span class="hljs-number">404</span> http<span class="hljs-operator">:</span><span class="hljs-comment">//www.baidu.com;</span><br>&#125;<br><br><span class="hljs-keyword">server</span>&#123;<br>error_page <span class="hljs-number">404</span> <span class="hljs-operator">/</span><span class="hljs-number">50</span>x.html;<br>error_page <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> <span class="hljs-operator">/</span><span class="hljs-number">50</span>x.html;<br>location <span class="hljs-operator">=/</span><span class="hljs-number">50</span>x.<span class="hljs-keyword">html</span>&#123;<br>root html;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>还可以用来修改状态码</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># 返回的状态码为200</span><br>server&#123;<br>error_page <span class="hljs-number">404</span> =<span class="hljs-number">200</span> /<span class="hljs-number">50</span>x.html;<br><span class="hljs-keyword">location</span> <span class="hljs-title">=/50x</span>.html&#123;<br>root html;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="静态资源优化配置语法"><a href="#静态资源优化配置语法" class="headerlink" title="静态资源优化配置语法"></a>静态资源优化配置语法</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启高效的文件传输模式，类似</span><br><span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># 必须在sendfile打开的状态下才会生效，主要是用来提升网络包的传输效率，缓存满了才发送</span><br><span class="hljs-attribute">tcp_nopush</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># 该指令必须在keep-alive连接开启的情况下才生效，来提高网络包传输的&#x27;实时性&#x27;</span><br><span class="hljs-attribute">tcp_nodeplay</span> <span class="hljs-literal">on</span>;<br></code></pre></td></tr></table></figure> <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启压缩功能</span><br><span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># 配置需要压缩的文件类型，如application/javascript text/html</span><br><span class="hljs-attribute">gzip_types</span> MIME类型;<br><br><span class="hljs-comment"># 设置Gzip压缩程度，1最低</span><br><span class="hljs-attribute">gzip_comp_level</span> <span class="hljs-number">1</span>-<span class="hljs-number">9</span>;<br><span class="hljs-comment"># 是否携带“Vary:Accept-Encoding”头域的响应头部，用来告诉接收方使用了压缩处理</span><br><span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>|<span class="hljs-literal">off</span>;<br><span class="hljs-comment"># 通过正则匹配User-Agent头里的信息来，选择性地关闭Gzip功能</span><br><span class="hljs-attribute">gzip_disable</span> regex;<br><span class="hljs-comment"># 设置当文件大小大于length时才压缩</span><br><span class="hljs-attribute">gzip_min_length</span> length;<br></code></pre></td></tr></table></figure><h5 id="添加模块步骤"><a href="#添加模块步骤" class="headerlink" title="添加模块步骤"></a>添加模块步骤</h5><p>以添加<code>http_gzip_static_module</code>为例</p><ol><li><p>查询当前Nginx的配置参数</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">nginx -V</span><br></code></pre></td></tr></table></figure></li><li><p>将nginx安装目录下sbin目录中的nginx二进制文件进行更名（保存旧的）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> nginx nginxold<br></code></pre></td></tr></table></figure></li><li><p>进入Nginx的安装目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/root/</span>nginx<span class="hljs-regexp">/core/</span>nginx-<span class="hljs-number">1.16</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li><p>执行make clean清空之前编译的内容</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make clean</span><br></code></pre></td></tr></table></figure></li><li><p>使用configure来配置参数</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">./configure</span> <span class="hljs-params">--with-http_gzip_static_module</span> 后面把第一步查到的配置参数加上<br></code></pre></td></tr></table></figure></li><li><p>使用make命令进行编译</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make</span><br></code></pre></td></tr></table></figure></li><li><p>将objs目录下的nginx二进制执行文件移动到nginx安装目录下的sbin目录中</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mv objs<span class="hljs-regexp">/nginx /u</span>sr<span class="hljs-regexp">/local/</span>nginx/sbin<br></code></pre></td></tr></table></figure></li><li><p>执行更新命令</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make upgrade</span><br></code></pre></td></tr></table></figure></li><li><p>修改配置文件</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启gzip_static</span><br><span class="hljs-attribute">gzip_static</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># reload重新加载配置文件，之后如果存在gz压缩好的文件，就会直接返回压缩好的</span><br><span class="hljs-comment"># gzip压缩文件指令：gzip 文件路径</span><br></code></pre></td></tr></table></figure></li></ol><h5 id="缓存相关指令"><a href="#缓存相关指令" class="headerlink" title="缓存相关指令"></a>缓存相关指令</h5><ol><li>指定缓存时间，填off不缓存</li></ol>   <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">expires <span class="hljs-selector-attr">[modified]</span> <span class="hljs-selector-tag">time</span><br></code></pre></td></tr></table></figure><ol start="2"><li><p>添加响应头</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">add_header <span class="hljs-keyword">name</span> value<br></code></pre></td></tr></table></figure><p>Cache-Control作为响应头信息，可以设置如下值</p><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>must-revalidate</td><td>可缓存但必须再向源服务器进行确认</td></tr><tr><td>no-cache</td><td>缓存前必须确认其有效性</td></tr><tr><td>no-store</td><td>不缓存请求或响应的任何内容</td></tr><tr><td>no-transform</td><td>代理不可更改媒体类型</td></tr><tr><td>public</td><td>可向任意方提供响应的缓存</td></tr><tr><td>private</td><td>仅向特定用户返回响应</td></tr><tr><td>proxy-revalidate</td><td>要求中间缓存服务器对缓存的响应有效性再进行确认</td></tr><tr><td>max-age&#x3D;&lt;秒&gt;</td><td>响应最大Age值</td></tr><tr><td>s-maxage&#x3D;&lt;秒&gt;</td><td>公共缓存服务器响应的最大Age值</td></tr></tbody></table></li></ol><h4 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h4><p>同源:  协议、域名(IP)、端口相同即为同源</p><p>如果从服务器A的页面发送异步请求到服务器B获取数据，如果服务器A和服务器B不满足同源策略，则就会出现跨域问题。</p><p><strong>解决方式</strong></p><p>添加Access-Control-Allow-Origin来设置允许跨域访问的源地址信息</p><p>添加Access-Control-Allow-Methods来设置允许跨域访问的请求方式</p><p>例如</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">location</span> <span class="hljs-title">/getUser</span>&#123;<br><span class="hljs-comment"># *表所有地址都可以</span><br>    add_header Access-Control-Allow-Origin *;<br>    add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE;<br>    default_type application/json;<br>    return <span class="hljs-number">200</span> &#x27;&#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;TOM&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>&#125;&#x27;;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h4><p>盗链：将别人网页的内容放到自己的页面上</p><p><strong>防盗链原理</strong></p><p>通过判断HTTP的头信息Referer来判断获取资源的请求来源，只对允许的来源开放链接</p><p><strong>防盗链步骤</strong></p><p>例子</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /images &#123;<br>           <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> www.baidu.com <span class="hljs-number">192.168.200.222</span> <span class="hljs-regexp">*.example.com</span> <span class="hljs-regexp">example.*</span>  www.example.org  ~\.google\.;<br>           <span class="hljs-attribute">if</span> (<span class="hljs-variable">$invalid_referer</span>)&#123;<br>                <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>;<br>           &#125;<br>           <span class="hljs-attribute">root</span> /usr/local/nginx/html;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Rewrite功能配置"><a href="#Rewrite功能配置" class="headerlink" title="Rewrite功能配置"></a>Rewrite功能配置</h4><p>主要的作用是用来实现URL的重写</p><p>可以用来做域名跳转、域名镜像、给每个模块设置独立域名、合并目录</p><h5 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h5><ol><li><p>set</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> <span class="hljs-variable">$variable</span> value<br><br>例<br><span class="hljs-built_in"> server </span>&#123;<br>        listen 8081;<br>        server_name localhost;<br>        location <span class="hljs-built_in">/server </span>&#123;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$name</span> Tom;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$age</span> 18;<br>                default_type text/plain;<br>                return 200 <span class="hljs-variable">$name</span>=<span class="hljs-variable">$age</span>;<br>        &#125;<br>    &#125;<br>nginx有预设的全局变量<br>例：用全局变量记录日志<br>log_format main <span class="hljs-string">&#x27;$remote_addr - $request - $status - $request_uri - $http_user_agent&#x27;</span>;<br><br>   <span class="hljs-built_in"> server </span>&#123;<br>        listen 8081;<br>        server_name localhost;<br>        location <span class="hljs-built_in">/server </span>&#123;<br>                access_log logs/access.log main;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$name</span> Tom;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$age</span> 18;<br>                default_type text/plain;<br>                return 200 <span class="hljs-variable">$name</span>=<span class="hljs-variable">$age</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure></li><li><p>if</p><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nim"><span class="hljs-keyword">if</span>  (condition)<span class="hljs-meta">&#123;...&#125;</span><br><br><span class="hljs-number">1</span>. 如果变量名对应的值为空或者是<span class="hljs-number">0</span>，<span class="hljs-keyword">if</span>都判断为<span class="hljs-literal">false</span>,其他条件为<span class="hljs-literal">true</span>。<br><span class="hljs-number">2</span>. 使用<span class="hljs-string">&quot;=&quot;</span>和<span class="hljs-string">&quot;!=&quot;</span>比较变量和字符串是否相等，满足条件为<span class="hljs-literal">true</span>，不满足为<span class="hljs-literal">false</span><br>例<br><span class="hljs-keyword">if</span> ($request_method = <span class="hljs-type">POST</span>)&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-number">405</span>;<br>&#125;<br><span class="hljs-number">3</span>. 使用正则表达式对变量进行匹配，匹配成功返回<span class="hljs-literal">true</span>，否则返回<span class="hljs-literal">false</span>。变量与正则表达式之间使用<span class="hljs-string">&quot;~&quot;</span>,<span class="hljs-string">&quot;~*&quot;</span>,<span class="hljs-string">&quot;!~&quot;</span>,<span class="hljs-string">&quot;!~\*&quot;</span>来连接。<br><span class="hljs-number">4</span>. 判断请求的文件是否存在使用<span class="hljs-string">&quot;-f&quot;</span>和<span class="hljs-string">&quot;!-f&quot;</span>, 判断请求的目录是否存在使用<span class="hljs-string">&quot;-d&quot;</span>和<span class="hljs-string">&quot;!-d&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>break</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta">该指令用于中断当前相同作用域中的其他Nginx配置<br>会去找与访问路径对应目录下的<span class="hljs-keyword">index</span>.html文件<br></code></pre></td></tr></table></figure></li><li><p>return</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">return</span> code [text];<br><span class="hljs-keyword">return</span> code URL;<br><span class="hljs-keyword">return</span> URL;<br></code></pre></td></tr></table></figure></li><li><p>rewrite</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ldif">rewrite regex replacement<br><span class="hljs-attribute">replacement</span>:匹配成功后，用于替换URI中被截取内容的字符串<br><span class="hljs-attribute">flag</span>:用来设置rewrite对URI的处理行为，可选值有如下：<br><span class="hljs-literal">-</span> last:替换完后重新匹配<br><span class="hljs-literal">-</span> break: 替换完后去找与访问路径对应目录下的index.html文件<br><span class="hljs-literal">-</span> redirect：永久重定向<br><span class="hljs-literal">-</span> permanent：临时重定向<br></code></pre></td></tr></table></figure></li><li><p>rewrite_log</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">rewrite_log</span> <span class="hljs-literal">on</span>\|<span class="hljs-literal">off</span><br>配置是否开启URL重写日志的输出功能<br>rewrite_log的日志输出级别为<span class="hljs-literal">notice</span><br>所以需要设置日志输出级别为<span class="hljs-literal">notice</span>才能看到日志<br>error_log logs/<span class="hljs-literal">error</span>.log <span class="hljs-literal">notice</span>;<br></code></pre></td></tr></table></figure></li></ol><h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><ol><li><p>proxy_pass</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">proxy_pass URL<br>设置被代理服务器地址，可以是主机名称、IP地址加端口号形式<br><br>例<br>server&#123;<br>listen <span class="hljs-number">80</span>;<br>server_name localhost;<br>location /server&#123;<br><span class="hljs-comment">#proxy_pass http://192.168.200.146;</span><br>proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>/;<br>&#125;<br>&#125;<br>url后面加<span class="hljs-regexp">/则最终找的是url/i</span>ndex.html，不加则为url<span class="hljs-regexp">/server/i</span>ndex.html<br></code></pre></td></tr></table></figure></li><li><p>proxy_set_header</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_set_header</span> field value<br>更改Nginx服务器接收到的客户端请求的请求头信息<br><br>例<br>server &#123;<br><span class="hljs-attribute">listen</span> <span class="hljs-number">8080</span>;<br><span class="hljs-attribute">server_name</span> localhost;<br><span class="hljs-attribute">default_type</span> text/plain;<br><span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-variable">$http_username</span>;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br><span class="hljs-attribute">listen</span> <span class="hljs-number">8081</span>;<br><span class="hljs-attribute">server_name</span> localhost;<br><span class="hljs-section">location</span> /server &#123;<br><span class="hljs-attribute">proxy_pass</span> http://47.96.80.163:8080;<br><span class="hljs-attribute">proxy_set_header</span> username Cat;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>proxy_redirect</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">proxy_redirect redirect replacement;<br>redirect:目标,Location的值<br>replacement:要替换的值<br>重置头信息中的<span class="hljs-string">&quot;Location&quot;</span>和<span class="hljs-string">&quot;Refresh&quot;</span>的值<br><br>例<br>服务端[<span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>]<br>server &#123;<br>    listen  <span class="hljs-number">8081</span>;<br>    server_name localhost;<br>    <span class="hljs-keyword">if</span> (!-f <span class="hljs-variable">$request_filename</span>)&#123;<br>    return <span class="hljs-number">302</span> http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>;<br>    &#125;<br>&#125;<br>代理服务端[<span class="hljs-number">192.168</span>.<span class="hljs-number">200.133</span>]<br>server &#123;<br>listen  <span class="hljs-number">8081</span>;<br>server_name localhost;<br>location / &#123;<br>proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>:<span class="hljs-number">8081</span>/;<br>proxy_redirect http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span> http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.133</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>具体案例</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">案例：将不同请求代理到不同服务器<br><br>代理服务器<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">8082</span>;<br>        server_name     localhost;<br>        <span class="hljs-keyword">location</span> /server1 &#123;<br>                proxy_pass http://<span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.146</span>:<span class="hljs-number">9001</span>/;<br>        &#125;<br>        <span class="hljs-keyword">location</span> /server2 &#123;<br>                proxy_pass http://<span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.146</span>:<span class="hljs-number">9002</span>/;<br>        &#125;<br>        <span class="hljs-keyword">location</span> /server3 &#123;<br>                proxy_pass http://<span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.146</span>:<span class="hljs-number">9003</span>/;<br>        &#125;<br>&#125;<br><br>服务端<br>server1<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">9001</span>;<br>        server_name     localhost;<br>        default_type <span class="hljs-type">text</span>/html;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;&#x27;</span><br>&#125;<br>server2<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">9002</span>;<br>        server_name     localhost;<br>        default_type <span class="hljs-type">text</span>/html;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;&#x27;</span><br>&#125;<br>server3<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">9003</span>;<br>        server_name     localhost;<br>        default_type <span class="hljs-type">text</span>/html;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="第七层负载均衡"><a href="#第七层负载均衡" class="headerlink" title="第七层负载均衡"></a>第七层负载均衡</h4><h5 id="负载均衡作用"><a href="#负载均衡作用" class="headerlink" title="负载均衡作用"></a>负载均衡作用</h5><ol><li>解决服务器的高并发压力，提高应用程序的处理性能。</li><li>提供故障转移，实现高可用。</li><li>通过添加或减少服务器数量，增强网站的可扩展性。</li><li>在负载均衡器上进行过滤，可以提高系统的安全性。</li></ol><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>被代理服务器：47.96.80.163:9001、47.96.80.163:9002、47.96.80.163:9003</p><p>负载均衡器：47.96.80.163:8081</p><p>默认方式为轮询</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">9001</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-attribute">default_type</span> text/html;<br>    <span class="hljs-section">location</span> / &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;9001&lt;/h1&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">9002</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-attribute">default_type</span> text/html;<br>    <span class="hljs-section">location</span> / &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;9002&lt;/h1&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">9003</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-attribute">default_type</span> text/html;<br>    <span class="hljs-section">location</span> / &#123;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;9003&lt;/h1&gt;&#x27;</span>;<br>&#125;<br>&#125;<br><span class="hljs-section">upstream</span> backend &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9001</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9002</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9003</span>;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">8081</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-section">location</span> / &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://backend;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="负载均衡状态"><a href="#负载均衡状态" class="headerlink" title="负载均衡状态"></a>负载均衡状态</h5><table><thead><tr><th>状态</th><th>概述</th></tr></thead><tbody><tr><td>down</td><td>当前的server暂时不参与负载均衡</td></tr><tr><td>backup</td><td>预留的备份服务器，其他主服务器挂了才会被用到</td></tr><tr><td>max_fails</td><td>允许请求失败的次数</td></tr><tr><td>fail_timeout</td><td>经过max_fails次失败后, 服务暂停的时间</td></tr><tr><td>max_conns</td><td>限制最大的接收连接数</td></tr></tbody></table><p><strong>设置方式示例</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> backend &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9001</span> down;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9002</span> backup;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9003</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">15</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h5><table><thead><tr><th>算法名称</th><th>说明</th></tr></thead><tbody><tr><td>轮询</td><td>默认方式</td></tr><tr><td>weight</td><td>权重方式</td></tr><tr><td>ip_hash</td><td>依据ip分配方式</td></tr><tr><td>least_conn</td><td>依据最少连接方式</td></tr><tr><td>url_hash</td><td>依据URL分配方式</td></tr><tr><td>fair</td><td>依据响应时间方式</td></tr></tbody></table><p><strong>示例</strong></p><figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs roboconf"><span class="hljs-comment"># 1.配置权重，权重越大被分配的概率越大，默认为1</span><br>upstream backend &#123;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9001 weight=2;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 2.配置ip_hash，同一个ip只会被分配到同一台服务器上</span><br>upstream backend &#123;<br><span class="hljs-attribute">ip_hash;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 3.配置least_conn，会把请求转发给连接数较少的服务器上</span><br><span class="hljs-comment"># 适合请求处理时间长短不一造成服务器过载的情况</span><br>upstream backend &#123;<br><span class="hljs-attribute">least_conn;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 4.配置url_hash，根据访问url的hash结果来分配请求</span><br>upstream backend &#123;<br><span class="hljs-attribute">hash $request_uri;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 5.配置fair，智能的进行负载均衡</span><br><span class="hljs-comment"># 需要安装第三方模块</span><br>(1)下载 https://github.com/gnosek/nginx-upstream-fair，解压到linux，重命名为fair<br>(2)sbin/nginx -V 查看之前的参数信息，并备份原nginx文件<br>(3)到nginx源文件目录，./configure --add-module=fair所在路径 + 之前的参数信息<br>(4)修改src/http/ngx_http_upstream.h文件，找到ngx_http_upstream_srv_conf_s，<br>添加in_port_t   default_port<br>(5)make<br>(6)将objs下的nginx复制到nginx文件夹下的sbin目录<br>(7)make upgrade<br>(8)测试<br>upstream backend &#123;<br><span class="hljs-attribute">fair;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="第四层负载均衡"><a href="#第四层负载均衡" class="headerlink" title="第四层负载均衡"></a>第四层负载均衡</h4><p>需要安装stream模块，在配置参数的时候加上<code>--with-stream</code></p><p><strong>示例</strong></p><p>stream和http块是平级的</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">stream</span> &#123;<br>        <span class="hljs-section">upstream</span> redisbackend &#123;<br>                <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.200.146:6379</span>;<br>                <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.200.146:6378</span>;<br>        &#125;<br>        <span class="hljs-section">upstream</span> tomcatbackend &#123;<br>        <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.200.146:8080</span>;<br>        &#125;<br>        <span class="hljs-section">server</span> &#123;<br>                <span class="hljs-attribute">listen</span>  <span class="hljs-number">81</span>;<br>                <span class="hljs-attribute">proxy_pass</span> redisbackend;<br>        &#125;<br>        <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span><span class="hljs-number">82</span>;<br>        <span class="hljs-attribute">proxy_pass</span> tomcatbackend;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="集成缓存"><a href="#集成缓存" class="headerlink" title="集成缓存"></a>集成缓存</h4><p><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">Module ngx_http_proxy_module (nginx.org)</a></p><h5 id="相关指令"><a href="#相关指令" class="headerlink" title="相关指令"></a>相关指令</h5><p>例</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># proxy_cache_path：缓存存放路径；</span><br><span class="hljs-comment"># levels：缓存文件层级，如2:1表示请求url经过MD5加密后取最后两个字符和倒数第三个字符来组成存放文件夹，如/ab/c；</span><br><span class="hljs-comment"># keys_zone：为缓存区设置名称和大小；</span><br><span class="hljs-comment"># inactive：缓存存活时间，超过存活时间没有被访问就会被删除；max_size：设置最大缓存空间</span><br><span class="hljs-comment"># proxy_cache：开启缓存</span><br><span class="hljs-comment"># proxy_cache_key：根据key值MD5哈希存缓存，默认$scheme$proxy_host$request_uri</span><br><span class="hljs-comment"># proxy_cache_valid：对不同返回状态码的URL设置不同的缓存时间，如404 1d、any 30s</span><br>proxy_cache_path /home/nginx/proxy_cache <span class="hljs-attribute">levels</span>=2:1 <span class="hljs-attribute">keys_zone</span>=cache:200m<br><span class="hljs-attribute">inactive</span>=1d <span class="hljs-attribute">max_size</span>=20g;<span class="hljs-built_in"></span><br><span class="hljs-built_in">server </span>&#123;<br>proxy_cache 缓存区名称;<br>proxy_cache_key web缓存的key值;<br>proxy_cache_vaild code time;<br>add_header nginx-cache <span class="hljs-string">&quot;<span class="hljs-variable">$upstream_cache_status</span>&quot;</span>;# 添加头信息来查看是否使用了缓存<br>proxy_cache_min_uses number;# 访问number次后才会缓存<br><span class="hljs-built_in">..</span>.<br>&#125;<br>    <br></code></pre></td></tr></table></figure><h5 id="清除缓存"><a href="#清除缓存" class="headerlink" title="清除缓存"></a>清除缓存</h5><p><strong>方式1</strong>：删除对应的缓存目录（删除所有缓存）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf 目录<br></code></pre></td></tr></table></figure><p><strong>方式2</strong>：ngx_cache_purge（删除指定缓存块的缓存）</p><p><a href="https://github.com/FRiCKLE/ngx_cache_purge/tags">github地址</a></p><p>安装ngx_cache_purge第三方模块</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># 配置</span><br><span class="hljs-comment"># 之后浏览器访问对应路径就能删除缓存</span><br>server&#123;<br><span class="hljs-keyword">location</span> <span class="hljs-title">~/purge</span>(/.*) &#123;<br>proxy_cache_purge 缓存块名称 缓存的key;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="设置不缓存的资源"><a href="#设置不缓存的资源" class="headerlink" title="设置不缓存的资源"></a>设置不缓存的资源</h5><p>例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">server&#123;<br>listen8080;<br>server_name localhost;<br>location / &#123;<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> ~ /.*\.js$)&#123;<br>           <span class="hljs-built_in">set</span> <span class="hljs-variable">$nocache</span> 1;<br>        &#125;<br>proxy_no_cache <span class="hljs-variable">$nocache</span> <span class="hljs-variable">$cookie_nocache</span> <span class="hljs-variable">$arg_nocache</span> <span class="hljs-variable">$arg_comment</span>;<br>        proxy_cache_bypass <span class="hljs-variable">$nocache</span> <span class="hljs-variable">$cookie_nocache</span> <span class="hljs-variable">$arg_nocache</span> <span class="hljs-variable">$arg_comment</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="安全控制"><a href="#安全控制" class="headerlink" title="安全控制"></a>安全控制</h4><p>Nginx使用SSL(Secure Sockets Layer)，需要安装<code>--with-http_ssl_module</code>模块</p><h5 id="相关指令-1"><a href="#相关指令-1" class="headerlink" title="相关指令"></a>相关指令</h5><p><a href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html">Module ngx_http_ssl_module (nginx.org)</a></p><h4 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h4><p>使用<strong>Keepalived</strong>来解决，Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，Keepalived 软件主要是通过 VRRP 协议实现高可用功能。</p><p><strong>VRRP（Virtual Route Redundancy Protocol）</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">虚拟路由冗余协议，VRRP可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。其中的虚拟路由即Virtual路由是由VRRP路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的IP地址。而且VRRP路由<span class="hljs-number">1</span>和VRRP路由<span class="hljs-number">2</span>之间会有竞争选择，通过选择会产生一个<span class="hljs-literal">Master</span>路由和一个Backup路由。<br><span class="hljs-literal">Master</span>路由和Backup路由之间会有一个心跳检测，<span class="hljs-literal">Master</span>会定时告知Backup自己的状态，如果在指定的时间内，Backup没有接收到这个通知内容，Backup就会替代<span class="hljs-literal">Master</span>成为新的<span class="hljs-literal">Master</span>。<span class="hljs-literal">Master</span>路由有一个特权就是虚拟路由和后端服务器都是通过<span class="hljs-literal">Master</span>进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听<span class="hljs-literal">Master</span>的状态<br></code></pre></td></tr></table></figure><h5 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a>安装keepalived</h5><ol><li><p>官网下载<a href="https://keepalived.org/%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%88%B0linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A">https://keepalived.org/，上传到linux服务器上</a></p></li><li><p>创建keepalived目录，将压缩包解压到目录</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">tar</span> <span class="hljs-operator">-</span><span class="hljs-variable">zxf</span> 压缩包名 <span class="hljs-operator">-</span><span class="hljs-built_in">C</span> <span class="hljs-variable">keepalived</span><span class="hljs-operator">/</span><br></code></pre></td></tr></table></figure></li><li><p>编译、安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> keepalived/keepalived-2.0.20<br><br><span class="hljs-comment"># sysconf：配置文件所在目录</span><br><span class="hljs-comment"># prefix：keepalived要安装的目录</span><br>./configure --sysconf=/etc --prefix=/usr/local<br><br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure></li></ol><h5 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h5><p>配置文件在<code>/安装目录/keepalived/keepalived.conf</code></p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-keyword">global</span>全局部分：<br>global_defs &#123;<br>   <span class="hljs-meta">#通知邮件，当keepalived发送切换时需要发email给具体的邮箱地址</span><br>   notification_email &#123;<br>     tom<span class="hljs-symbol">@itcast</span>.cn<br>     jerry<span class="hljs-symbol">@itcast</span>.cn<br>   &#125;<br>   <span class="hljs-meta">#设置发件人的邮箱信息</span><br>   notification_email_from zhaomin<span class="hljs-symbol">@itcast</span>.cn<br>   <span class="hljs-meta">#指定smpt服务地址</span><br>   smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span><br>   <span class="hljs-meta">#指定smpt服务连接超时时间</span><br>   smtp_connect_timeout <span class="hljs-number">30</span><br>   <span class="hljs-meta">#运行keepalived服务器的一个标识，可以用作发送邮件的主题信息</span><br>   router_id LVS_DEVEL<br>   <br>   <span class="hljs-meta">#默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)</span><br>   vrrp_skip_check_adv_addr<br>   <span class="hljs-meta">#严格遵守VRRP协议。</span><br>   vrrp_strict<br>   <span class="hljs-meta">#在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0</span><br>   vrrp_garp_interval <span class="hljs-number">0</span><br>   <span class="hljs-meta">#在一个网卡上每组na消息之间的延迟时间，默认为0</span><br>   vrrp_gna_interval <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs pf">VRRP部分，该部分可以包含以下四个子模块<br><span class="hljs-number">1</span>. vrrp_script<br><span class="hljs-number">2</span>. vrrp_sync_group<br><span class="hljs-number">3</span>. garp_group<br><span class="hljs-number">4</span>. vrrp_instance<br>我们会用到第一个和第四个，<br><span class="hljs-comment">#设置keepalived实例的相关信息，VI_1为VRRP实例名称</span><br>vrrp_instance VI_1 &#123;<br>    <span class="hljs-keyword">state</span> MASTER  <span class="hljs-comment">#有两个值可选MASTER主 BACKUP备</span><br>    interface ens33<span class="hljs-comment">#vrrp实例绑定的接口，用于发送VRRP包[当前服务器使用的网卡名称]</span><br>    virtual_router_id <span class="hljs-number">51</span><span class="hljs-comment">#指定VRRP实例ID，范围是0-255</span><br>    priority <span class="hljs-number">100</span><span class="hljs-comment">#指定优先级，优先级高的将成为MASTER</span><br>    advert_int <span class="hljs-number">1</span><span class="hljs-comment">#指定发送VRRP通告的间隔，单位是秒</span><br>    authentication &#123;<span class="hljs-comment">#vrrp之间通信的认证信息</span><br>        auth_type PASS<span class="hljs-comment">#指定认证方式。PASS简单密码认证(推荐)</span><br>        auth_pass <span class="hljs-number">1111</span><span class="hljs-comment">#指定认证使用的密码，最多8位</span><br>    &#125;<br>    virtual_ipaddress &#123; <span class="hljs-comment">#虚拟IP地址设置虚拟IP地址，供用户访问使用，可设置多个，一行一个</span><br>        <span class="hljs-number">192.168</span>.<span class="hljs-number">200.222</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="启动keepalived"><a href="#启动keepalived" class="headerlink" title="启动keepalived"></a>启动keepalived</h5><ol><li><p>启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /安装目录/local/sbin<br>./keepalived<br></code></pre></td></tr></table></figure></li><li><p><code>ip a</code>查看ip，虚拟IP(VIP)会在MASTER节点上，当MASTER节点上的<strong>keepalived</strong>出问题以后，因为BACKUP无法收到MASTER发出的VRRP状态通过信息，就会直接升为MASTER。VIP也会”漂移”到新的MASTER。</p></li><li><p>可以通过编写脚本来检测当nginx进程挂了的时候关闭keepalived，从而自动切换master到另一台nginx上</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 编写脚本ck_nginx.sh，该脚本的意思是检查nginx进程是否在运行，</span><br><span class="hljs-comment"># 如果检测不到nginx进程，则关闭keepalived</span><br><br><span class="hljs-comment">#!/bin/bash</span><br>num=`ps -C nginx --no-header | <span class="hljs-built_in">wc</span> -l`<br><span class="hljs-keyword">if</span> [ `ps -C nginx --no-header | <span class="hljs-built_in">wc</span> -l` -eq 0 ]; <span class="hljs-keyword">then</span><br>killall keepalived<br><span class="hljs-keyword">fi</span><br><br><br><span class="hljs-comment"># 给脚本设置权限</span><br><span class="hljs-built_in">chmod</span> 755 ck_nginx.sh<br><br><br><span class="hljs-comment"># 在keepalived配置文件中添加对应的配置像</span><br>vrrp_script 脚本名称<br>&#123;<br>    script <span class="hljs-string">&quot;脚本位置&quot;</span><br>    interval 3 <span class="hljs-comment">#执行时间间隔</span><br>    weight -20 <span class="hljs-comment">#动态调整vrrp_instance的优先级</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="制作下载站点"><a href="#制作下载站点" class="headerlink" title="制作下载站点"></a>制作下载站点</h4><ol><li><p>将要被下载的资源放到一个目录下</p></li><li><p>修改nginx配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /download&#123;<br><span class="hljs-comment"># 被下载资源路径</span><br>    <span class="hljs-attribute">root</span> /usr/local;<br>    <span class="hljs-comment"># 开启功能</span><br>    <span class="hljs-attribute">autoindex</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment"># 是否展示文件大小</span><br>    <span class="hljs-attribute">autoindex_exact_size</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment"># 目录列表的格式，可以是html/xml/json/jsonp，默认html</span><br>    <span class="hljs-attribute">autoindex_format</span> html;<br>    <span class="hljs-comment"># 是否在目录列表上显示时间</span><br>    <span class="hljs-attribute">autoindex_localtime</span> <span class="hljs-literal">on</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h4><p>Lua是用标准C语言编写并以源代码形式开发。设计的目的是为了嵌入到其他应用程序中，从而为应用程序提供灵活的扩展和定制功能。应用在游戏开发、独立应用脚本、web应用脚本、扩展和数据库插件、系统安全上。</p><p><a href="https://www.lua.org/">官网</a></p><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><ol><li><p>下载压缩包到服务器</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>www.lua.org<span class="hljs-regexp">/ftp/</span>lua-<span class="hljs-number">5.4</span>.<span class="hljs-number">4</span>.tar.gz<br></code></pre></td></tr></table></figure></li><li><p>检查环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make linux <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure></li><li><p>编译安装</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">make <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure></li><li><p>查看版本</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">lua -v</span><br></code></pre></td></tr></table></figure></li></ol><h5 id="交互方式"><a href="#交互方式" class="headerlink" title="交互方式"></a>交互方式</h5><p><strong>1.交互式</strong></p><p>通过命令<code>lua</code>进入控制台</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># lua</span><br>&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World&quot;</span>)<br></code></pre></td></tr></table></figure><p><strong>2.脚本式</strong></p><p>创建hello.lua文件，编写脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim hello.lua</span><br><br><span class="hljs-comment"># 编写脚本</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World&quot;</span>)<br><br><span class="hljs-comment"># 执行</span><br><span class="hljs-built_in">chmod</span> 755 hello.lua<br>lua hello.lua<br><br><span class="hljs-comment"># 也可以在文件开头指定解释器，执行的时候直接用文件名就行了</span><br><span class="hljs-comment">#!/usr/local/bin/lua</span><br></code></pre></td></tr></table></figure><h5 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h5><h6 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h6><p><strong>单行注释</strong></p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-comment">-- 注释</span><br></code></pre></td></tr></table></figure><p><strong>多行注释</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--[[</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">--]]</span><br></code></pre></td></tr></table></figure><blockquote><p>多行注释只需要在前面多加一个-就可以取消</p></blockquote><h6 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h6><p><strong>逻辑运算符</strong></p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">and</span> --&gt;</span> 与<br><span class="hljs-function"><span class="hljs-title">or</span> --&gt;</span> 或<br><span class="hljs-function"><span class="hljs-title">not</span> --&gt;</span> 非<br></code></pre></td></tr></table></figure><p>其他运算符</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">..</span> 连接字符串<br><span class="hljs-comment"># 返回字符串或表的长度</span><br></code></pre></td></tr></table></figure><h6 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h6><p>默认为全局变量，定义局部变量要在前面加<code>local</code></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-comment">;</span><br>local b <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h6 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">nil</span><span class="hljs-params">(空，无效值)</span></span><br><span class="hljs-function"><span class="hljs-title">boolean</span><span class="hljs-params">(布尔，true/false)</span></span><br><span class="hljs-function"><span class="hljs-title">number</span><span class="hljs-params">(数值)</span></span>：只有false和nil为假<br><span class="hljs-function"><span class="hljs-title">string</span><span class="hljs-params">(字符串)</span></span><br><span class="hljs-function"><span class="hljs-title">function</span><span class="hljs-params">(函数)</span></span><br>table（表）<br><span class="hljs-function"><span class="hljs-title">thread</span><span class="hljs-params">(线程)</span></span><br>userdata（用户数据）<br></code></pre></td></tr></table></figure><p><strong>表</strong></p><p>可以用来表示数组、字典或混合使用，下标从1开始</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 定义一个表</span><br><span class="hljs-attribute">arr</span> = &#123;&#125;<br><span class="hljs-attribute">arr</span> = &#123;<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>&#125;<br><span class="hljs-attribute">arr</span> = &#123;X = <span class="hljs-number">10</span>, Y = <span class="hljs-number">20</span>, Z = <span class="hljs-number">30</span>&#125;<br><span class="hljs-attribute">arr</span> = &#123;<span class="hljs-string">&quot;a&quot;</span>, X = <span class="hljs-number">10</span>, <span class="hljs-string">&quot;b&quot;</span>&#125;<br><br><span class="hljs-comment"># 获取表里的值</span><br><span class="hljs-attribute">arr</span> = &#123;<span class="hljs-string">&quot;a&quot;</span>, X = <span class="hljs-number">10</span>, <span class="hljs-string">&quot;b&quot;</span>&#125;<br><span class="hljs-attribute">arr</span>[<span class="hljs-number">0</span>]-- nil<br><span class="hljs-attribute">arr</span>[<span class="hljs-number">1</span>] -- <span class="hljs-string">&quot;a&quot;</span><br><span class="hljs-attribute">arr</span>[<span class="hljs-number">2</span>]-- <span class="hljs-string">&quot;b&quot;</span><br><span class="hljs-attribute">arr</span>[<span class="hljs-string">&quot;X&quot;</span>]-- <span class="hljs-number">10</span><br><span class="hljs-attribute">arr</span>.X-- <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><h6 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs lua"># 定义函数<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span><span class="hljs-params">(params)</span></span><br><span class="hljs-comment">-- 方法的内容</span><br><span class="hljs-keyword">end</span><br><br># 方法定义的参数并非都要传入，传入的会按顺序赋值，没赋值的参数为<span class="hljs-literal">nil</span>；如果传入的参数数量大于方法需要的参数数量，则会丢弃多出来的参数<br><br># 可变长参数<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span><span class="hljs-params">(...)</span></span><br>a, b, c = ...;<br><span class="hljs-built_in">print</span>(a, b, c);<br><span class="hljs-keyword">end</span><br><br># 方法返回值数量也是可变的<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><h6 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h6><p>if</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> 条件 <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">elseif</span> 条件 <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><h6 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h6><p>while</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">while</span> 条件 <span class="hljs-keyword">do</span><br><span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><p>repeat</p><p>直到满足条件才退出循环</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">repeat</span><br><span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">until</span> 条件<br></code></pre></td></tr></table></figure><p>for</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">-- 循环从start开始到end结束；step为步长，默认为1</span><br><span class="hljs-keyword">for</span> <span class="hljs-built_in">param</span>=<span class="hljs-built_in">start</span>,<span class="hljs-keyword">end</span>,step <span class="hljs-built_in">do</span><br> 循环体<br><span class="hljs-function"><span class="hljs-keyword">end</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">-- 遍历表</span><br><span class="hljs-comment">-- ipairs为迭代器，x为表</span><br><span class="hljs-comment">-- ipairs不能遍历出键值对，要遍历键值对要用pairs</span><br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> ipairs(x) <span class="hljs-built_in">do</span><br>循环体<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure><h5 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a>OpenResty</h5><p>OpenResty是一个基于Nginx与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。OpenResty内部已经集成了Nginx和Lua。</p><h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><ol><li><p>下载、解压压缩包<a href="https://openresty.org/en/download.html">OpenResty - Download</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>openresty.org<span class="hljs-regexp">/download/</span>openresty-<span class="hljs-number">1.15</span>.<span class="hljs-number">8.2</span>.tar.gz<br>tar -zxvf openresty-<span class="hljs-number">1.15</span>.<span class="hljs-number">8.2</span>.tar.gz<br></code></pre></td></tr></table></figure></li><li><p>进入openresty目录，编译安装</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss">./configure<br><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install<br></code></pre></td></tr></table></figure></li><li><p>默认安装位置<code>/usr/local/openresty/nginx/</code></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/openresty/</span>nginx/<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 修改配置</span><br>location /lua&#123;<br>    default_type <span class="hljs-string">&#x27;text/html&#x27;</span>;<br>    content_by_lua <span class="hljs-string">&#x27;ngx.say(&quot;&lt;h1&gt;HELLO,OpenRestry&lt;/h1&gt;&quot;)&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment"># 测试</span><br>.<span class="hljs-regexp">/sbin/</span>nginx -t<br><span class="hljs-comment"># 启动</span><br>.<span class="hljs-regexp">/sbin/</span>nginx<br><br><span class="hljs-comment"># 浏览器访问</span><br></code></pre></td></tr></table></figure></li></ol><h6 id="使用ngx-lua指令"><a href="#使用ngx-lua指令" class="headerlink" title="使用ngx_lua指令"></a>使用ngx_lua指令</h6><p><strong>init_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令在每次Nginx重新加载配置时执行，可以用来完成一些耗时模块的加载，或者初始化一些全局配置。<br></code></pre></td></tr></table></figure><p><strong>init_worker_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令用于启动一些定时任务，如心跳检查、定时拉取服务器配置等。<br></code></pre></td></tr></table></figure><p><strong>set_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令只要用来做变量赋值，这个指令一次只能返回一个值，并将结果赋值给Nginx中指定的变量。<br></code></pre></td></tr></table></figure><p><strong>rewrite_by_lua</strong></p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">该指令用于执行内部<span class="hljs-built_in">URL</span>重写或者外部重定向，典型的如伪静态化<span class="hljs-built_in">URL</span>重写，本阶段在rewrite处理阶段的最后默认执行。<br></code></pre></td></tr></table></figure><p><strong>access_by_lua</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">该指令用于访问控制。例如，如果只允许内网<span class="hljs-built_in">IP</span>访问。<br></code></pre></td></tr></table></figure><p><strong>content_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令是应用最多的指令，大部分任务是在这个阶段完成的，其他的过程往往为这个阶段准备数据，正式处理基本都在本阶段。<br></code></pre></td></tr></table></figure><p><strong>header_filter_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令用于设置应答消息的头部信息。<br></code></pre></td></tr></table></figure><p><strong>body_filter_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令是对响应数据进行过滤，如截断、替换。<br></code></pre></td></tr></table></figure><p><strong>log_by_lua</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">该指令用于在<span class="hljs-built_in">log</span>请求处理阶段，用Lua代码处理日志，但并不替换原有<span class="hljs-built_in">log</span>处理。<br></code></pre></td></tr></table></figure><p><strong>balancer_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令主要的作用是用来实现上游服务器的负载均衡器算法<br></code></pre></td></tr></table></figure><p><strong>ssl_certificate_by_lua</strong></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令作用在Nginx和下游服务开始一个SSL握手操作时将允许本配置项的Lua代码。<br></code></pre></td></tr></table></figure><p>例</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs 1c">location /getByGender &#123;<br>default_type &#x27;text/html&#x27;;<br>set_by_lua $name <span class="hljs-string">&quot;</span><br>local uri_args = ngx.req.get_uri_args()<br>gender = uri_args[&#x27;gender&#x27;]<br>name = uri_args[&#x27;name&#x27;]<br>if gender==&#x27;1&#x27; then<br>return name..&#x27;先生&#x27;<br>elseif gender==&#x27;0&#x27; then<br>return name..&#x27;女士&#x27;<br>else<br>return name<br>end<br><span class="hljs-string">&quot;;</span><br>header_filter_by_lua <span class="hljs-string">&quot;</span><br>ngx.header.aaa=&#x27;bbb&#x27;<br><span class="hljs-string">&quot;;</span><br>return <span class="hljs-number">200</span> $name;<br>&#125;<br></code></pre></td></tr></table></figure><h6 id="ngx-lua操作Redis"><a href="#ngx-lua操作Redis" class="headerlink" title="ngx_lua操作Redis"></a>ngx_lua操作Redis</h6> <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">lua</span>-resty-redis提供了访问Redis的详细API，包括创建对接、连接、操作、数据处理等。这些API基本上与Redis的操作一一对应。<br>（<span class="hljs-number">1</span>）redis = require <span class="hljs-string">&quot;resty.redis&quot;</span><br>（<span class="hljs-number">2</span>）<span class="hljs-keyword">new</span><br>语法: redis,err = <span class="hljs-keyword">redi</span><span class="hljs-variable">s:new</span>(),创建一个Redis对象。<br>（<span class="hljs-number">3</span>）connect<br>语法:ok,err=<span class="hljs-keyword">redi</span><span class="hljs-variable">s:connect</span>(host,port[,options_table]),设置连接Redis的连接信息。<br>ok:连接成功返回 <span class="hljs-number">1</span>，连接失败返回nil<br>err:返回对应的错误信息<br>（<span class="hljs-number">4</span>）set_timeout<br>语法: <span class="hljs-keyword">redi</span><span class="hljs-variable">s:set_timeout</span>(time) ，设置请求操作Redis的超时时间。<br>（<span class="hljs-number">5</span>）<span class="hljs-keyword">close</span><br>语法: ok,err = <span class="hljs-keyword">redi</span><span class="hljs-variable">s:close</span>(),关闭当前连接，成功返回<span class="hljs-number">1</span>，失败返回nil和错误信息<br>（<span class="hljs-number">6</span>）redis命令对应的方法<br>在<span class="hljs-keyword">lua</span>-resty-redis中，所有的Redis命令都有自己的方法，方法名字和命令名字相同，只是全部为小写。<br><br></code></pre></td></tr></table></figure><h6 id="ngx-lua操作mysql"><a href="#ngx-lua操作mysql" class="headerlink" title="ngx_lua操作mysql"></a>ngx_lua操作mysql</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">（<span class="hljs-number">1</span>）引入&quot;resty.mysql&quot;模块<br><span class="hljs-keyword">local</span> mysql = require &quot;resty.mysql&quot;<br>（<span class="hljs-number">2</span>）<span class="hljs-built_in">new</span><br>创建一个MySQL连接对象，遇到错误时，db为nil，err为错误描述信息<br>语法: db,err = mysql:<span class="hljs-built_in">new</span>()<br>（<span class="hljs-number">3</span>）<span class="hljs-keyword">connect</span><br>尝试连接到一个MySQL服务器<br>语法:ok,err=db:<span class="hljs-keyword">connect</span>(<span class="hljs-keyword">options</span>),<span class="hljs-keyword">options</span>是一个参数的Lua表结构，里面包含数据库连接的相关信息<br>    host:服务器主机名或IP地址<br>    port:服务器监听端口，默认为<span class="hljs-number">3306</span><br>    <span class="hljs-keyword">user</span>:登录的用户名<br>    <span class="hljs-keyword">password</span>:登录密码<br>    <span class="hljs-keyword">database</span>:使用的数据库名<br>（<span class="hljs-number">4</span>）set_timeout<br>设置子请求的超时时间(ms)，包括<span class="hljs-keyword">connect</span>方法<br>语法:db:set_timeout(<span class="hljs-type">time</span>)<br>（<span class="hljs-number">5</span>）<span class="hljs-keyword">close</span><br>关闭当前MySQL连接并返回状态。如果成功，则返回<span class="hljs-number">1</span>；如果出现任何错误，则将返回nil和错误描述。<br>语法:db:<span class="hljs-keyword">close</span>()<br>（<span class="hljs-number">6</span>）send_query<br>异步向远程MySQL发送一个查询。如果成功则返回成功发送的字节数；如果错误，则返回nil和错误描述<br>语法:bytes,err=db:send_query(<span class="hljs-keyword">sql</span>)<br>（<span class="hljs-number">7</span>）read_result<br>从MySQL服务器返回结果中读取一行数据。res返回一个描述OK包或结果集包的Lua表,语法:<br>res, err, errcode, <span class="hljs-built_in">sqlstate</span> = db:read_result() <br>res, err, errcode, <span class="hljs-built_in">sqlstate</span> = db:read_result(<span class="hljs-keyword">rows</span>) :<span class="hljs-keyword">rows</span>指定返回结果集的最大值，默认为<span class="hljs-number">4</span><br>如果是查询，则返回一个容纳多行的数组。每行是一个数据列的key-<span class="hljs-keyword">value</span>对，如<br><br>    &#123;<br>      &#123;id=<span class="hljs-number">1</span>,username=&quot;TOM&quot;,birthday=&quot;1988-11-11&quot;,salary=<span class="hljs-number">10000.0</span>&#125;,<br>      &#123;id=<span class="hljs-number">2</span>,username=&quot;JERRY&quot;,birthday=&quot;1989-11-11&quot;,salary=<span class="hljs-number">20000.0</span>&#125;<br>    &#125;<br>如果是增删改，则返回类上如下数据<br>    &#123;<br>    insert_id = <span class="hljs-number">0</span>,<br>    server_status=<span class="hljs-number">2</span>,<br>    warning_count=<span class="hljs-number">1</span>,<br>    affected_rows=<span class="hljs-number">2</span>,<br>    message=nil<br>    &#125;<br>返回值:<br>res:操作的结果集<br>err:错误信息<br>errcode:MySQL的错误码，比如<span class="hljs-number">1064</span><br><span class="hljs-built_in">sqlstate</span>:返回由<span class="hljs-number">5</span>个字符组成的标准<span class="hljs-keyword">SQL</span>错误码，比如<span class="hljs-number">42000</span><br><br></code></pre></td></tr></table></figure><h4 id="具体应用"><a href="#具体应用" class="headerlink" title="具体应用"></a>具体应用</h4><ul><li><p>部署静态资源</p><p>将静态资源放到html文件夹下</p></li><li><p>反向代理</p><blockquote><p>正向代理:代理的是客服端,对客服端负责,帮助客服端访问服务器</p><p>反向代理:代理的是服务端,对服务端负责,帮助服务器提供服务</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs linux">#在配置文件中的http中配置反向代理,记得开放端口<br>server &#123;<br>        listen       80;#监听的端口，当访问这个端口时转发到指定服务器<br>        server_name  localhost;<br>        location / &#123;<br>proxy_pass:http://192.168.229.130:8080;#转发的服务器<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>负载均衡</p><blockquote><p>基于反向代理，根据算法将用户请求分发到集群中的一台服务器上</p></blockquote><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td>weight</td><td>权重方式，值越大分配几率越高</td></tr><tr><td>ip_hash</td><td>根据客户端ip</td></tr><tr><td>least_conn</td><td>根据最少连接方式</td></tr><tr><td>url_hash</td><td>根据url分配方式</td></tr><tr><td>fair</td><td>根据响应时间方式</td></tr><tr><td>轮询</td><td>默认</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs linux">#配置负载均衡<br>upstream targetserver&#123;#upstream指令来定义一组服务器<br>server 192.168.229.130:8080;<br>server 192.168.229.131:8080;<br>server 192.168.229.131:8081;<br>&#125;<br><br>server &#123;<br>        listen       80;#监听的端口，当访问这个端口时转发到指定服务器<br>        server_name  localhost;<br>        location / &#123;<br>proxy_pass:http://targetserver;#转发的服务器<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>记得<code>./sbin/nginx -s reload</code>重新加载</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>中间件</category>
      
      <category>nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL主从配置</title>
    <link href="/2022/08/19/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MySQL%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE/"/>
    <url>/2022/08/19/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MySQL%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="MySQL主从配置"><a href="#MySQL主从配置" class="headerlink" title="MySQL主从配置"></a>MySQL主从配置</h2><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul><li>主从服务器操作系统版本和位数一致；</li><li>Master 和 Slave 数据库的版本要一致；</li><li>Master 和 Slave 数据库中的数据要一致；</li><li>Master 开启二进制日志， Master 和 Slave 的 server_id 在局域网内必须唯一；</li></ul><h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><p>​<strong>主库配置</strong></p><ol><li><p>修改配置文件&#x2F;etc&#x2F;my.cnf(windows下在my.ini文件中)</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">log-bin</span>=master-bin<span class="hljs-comment">#开启二进制文件</span><br><span class="hljs-attr">server-id</span>=<span class="hljs-number">100</span><span class="hljs-comment">#服务器唯一ID</span><br></code></pre></td></tr></table></figure></li><li><p>重启mysql服务</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">systemctl restart mysqld</span><br></code></pre></td></tr></table></figure></li><li><p>登录mysql创建一个用户并赋予REPLICATION SLAVE权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE USER &#x27;username&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;password&#x27;;<br>GRANT REPLICATION SLAVE ON *.* TO &#x27;username&#x27;@&#x27;%&#x27;;<br>ALTER USER &#x27;username&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;password&#x27;;<br></code></pre></td></tr></table></figure></li><li><p>查看主库状态</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show master status;<br></code></pre></td></tr></table></figure></li></ol><p>​<strong>从库配置</strong></p><ol><li><p>修改配置文件</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[mysqld]</span><br><span class="hljs-attr">server-id</span>=<span class="hljs-number">101</span><span class="hljs-comment">#服务器唯一ID</span><br></code></pre></td></tr></table></figure></li><li><p>重启mysql服务</p></li><li><p>设置主节点参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CHANGE MASTER TO<br>MASTER_HOST=&#x27;192.168.229.168&#x27;,<br>MASTER_USER=&#x27;zs&#x27;,<br>MASTER_PASSWORD=&#x27;123456&#x27;,<br>MASTER_LOG_FILE=&#x27;master-bin.000001&#x27;,#查看主库状态时File列的参数<br>MASTER_LOG_POS=3578;#查看主库状态时Position列的参数<br></code></pre></td></tr></table></figure></li><li><p>开启主从服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">start slave;<br></code></pre></td></tr></table></figure></li><li><p>查看是否成功</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show slave status \G<br></code></pre></td></tr></table></figure></li></ol><h4 id="常见错误"><a href="#常见错误" class="headerlink" title="常见错误"></a>常见错误</h4><ol><li>Slave_SQL_Running: NO</li></ol><p>解决方式:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql&gt; stop slave ;<br>mysql&gt; set GLOBAL SQL_SLAVE_SKIP_COUNTER=1;<br>mysql&gt; start slave ;<br><br>或者主节点参数配置错误，重新配置一遍<br></code></pre></td></tr></table></figure><ol start="2"><li>Slave_IO_Running: NO&#x2F;Collecting</li></ol><p>解决方式:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">每次数据库重启后都会导致master status发生变化,重新配置从库的主节点参数<br><br>或者复制虚拟机时数据库的uuid相同，删除<span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/mysql/</span>auto.cnf文件后重启数据库<br>systemctl restart mysqld<br><br>或者防火墙没关<br></code></pre></td></tr></table></figure><h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p>主库负责增删改，从库负责查</p><p><strong>Sharding-JDBC</strong></p><p>轻量级java框架，增强JDBC功能，可以在程序中实现数据库读写分离</p><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sharding-jdbc-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.0-RC1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">shardingsphere:</span><br>    <span class="hljs-attr">datasource:</span><br>      <span class="hljs-comment"># 定义数据源名称</span><br>      <span class="hljs-attr">names:</span><br>        <span class="hljs-string">master,slave</span><br>      <span class="hljs-comment"># 主数据源</span><br>      <span class="hljs-attr">master:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.229.168:3306/rw?characterEncoding=utf-8</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>      <span class="hljs-comment"># 从数据源</span><br>      <span class="hljs-attr">slave:</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span><br>        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br>        <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.229.130:3306/rw?characterEncoding=utf-8</span><br>        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">masterslave:</span><br>      <span class="hljs-comment"># 读写分离配置（轮询）</span><br>      <span class="hljs-attr">load-balance-algorithm-type:</span> <span class="hljs-string">round_robin</span><br>      <span class="hljs-comment"># 最终的数据源名称</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">dataSource</span><br>      <span class="hljs-comment"># 主库数据源名称</span><br>      <span class="hljs-attr">master-data-source-name:</span> <span class="hljs-string">master</span><br>      <span class="hljs-comment"># 从库数据源名称列表，多个逗号分隔</span><br>      <span class="hljs-attr">slave-data-source-names:</span> <span class="hljs-string">slave</span><br>    <span class="hljs-attr">props:</span><br>      <span class="hljs-attr">sql:</span><br>        <span class="hljs-attr">show:</span> <span class="hljs-literal">true</span> <span class="hljs-comment">#开启SQL显示，默认false</span><br>  <span class="hljs-attr">main:</span><br>  <span class="hljs-comment">#Sharding和Druid的类有重名的，需要加上这个配置</span><br>    <span class="hljs-attr">allow-bean-definition-overriding:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringCache</title>
    <link href="/2022/08/19/spring/SpringCache/"/>
    <url>/2022/08/19/spring/SpringCache/</url>
    
    <content type="html"><![CDATA[<h2 id="Spring-Cache"><a href="#Spring-Cache" class="headerlink" title="Spring Cache"></a>Spring Cache</h2><p>通过注解来实现缓存，底层可以切换不同的cache实现，通过CacheManager接口来统一不同的缓存技术</p><p>对不同的缓存技术需要实现不同的CacheManager</p><table><thead><tr><th>CacheManager</th><th>描述</th></tr></thead><tbody><tr><td>EhCacheCacheManager</td><td>使用EhCache缓存技术</td></tr><tr><td>GuavaCacheManager</td><td>使用Guava缓存技术</td></tr><tr><td>RedisCacheManager</td><td>使用Redis缓存技术</td></tr></tbody></table><h4 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h4><table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@EnableCaching</td><td>开启缓存注解功能</td></tr><tr><td>@Cacheable</td><td>优先从缓存中取数据，没有去数据库取</td></tr><tr><td>@CachePut</td><td>将方法返回值放到内存中</td></tr><tr><td>@CacheEvict</td><td>将一条或多条数据从缓存中删除</td></tr></tbody></table><h4 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h4><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 不使用默认缓存技术，使用到其他缓存技术时要导入这个坐标 --&gt;</span><br><span class="hljs-comment">&lt;!-- 及相应缓存技术的坐标 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>配置相应技术</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span> <br>    <span class="hljs-attr">redis:</span><br>        <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span><br>        <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>        <span class="hljs-attr">database:</span> <span class="hljs-number">0</span><br>    <span class="hljs-attr">cache:</span><br>        <span class="hljs-attr">redis:</span><br>          <span class="hljs-attr">time-to-live:</span> <span class="hljs-number">1800000</span> <span class="hljs-comment">#缓存过期时间</span><br>        <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span><br></code></pre></td></tr></table></figure><p>启动类加@EnableCaching注解</p><p>在要缓存的方法上加注解, 返回值会被存到redis中, <strong>返回值必须是可序列化的</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/list&quot;)</span><br>    <span class="hljs-meta">@Cacheable(value = &quot;setmealCache&quot;, key = &quot;#setmeal.categoryId + &#x27;_&#x27; + #setmeal.status&quot;)</span><br>    <span class="hljs-keyword">public</span> R&lt;List&lt;Setmeal&gt;&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(Setmeal setmeal)</span> &#123;...&#125;<br></code></pre></td></tr></table></figure><h4 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h4><blockquote><p>在微服务中使用spring cache</p><p>例子来自尚医通</p></blockquote><ul><li><p>在common组件中添加依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- redis --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- spring2.X集成redis所需common-pool2--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>在common组件中添加redis配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xw.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableCaching</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 自定义key规则</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> KeyGenerator <span class="hljs-title function_">keyGenerator</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KeyGenerator</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">generate</span><span class="hljs-params">(Object target, Method method, Object... params)</span> &#123;<br>                <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                sb.append(target.getClass().getName());<br>                sb.append(method.getName());<br>                <span class="hljs-keyword">for</span> (Object obj : params) &#123;<br>                    sb.append(obj.toString());<br>                &#125;<br>                <span class="hljs-keyword">return</span> sb.toString();<br>            &#125;<br>        &#125;;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置RedisTemplate规则</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> redisConnectionFactory</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;<br>        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        redisTemplate.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br><br>     <span class="hljs-comment">//解决查询缓存转换异常的问题</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        <span class="hljs-comment">// 指定要序列化的域，field,get和set,以及修饰符范围，ANY是都有包括private和public</span><br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        <span class="hljs-comment">// 指定序列化输入的类型，类必须是非final修饰的，final修饰的类，比如String,Integer等会跑出异常</span><br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br><br>        <span class="hljs-comment">//序列号key value</span><br>        redisTemplate.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);<br>        redisTemplate.setHashKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());<br>        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);<br><br>        redisTemplate.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> redisTemplate;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 设置CacheManager缓存规则</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> factory</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisSerializer&lt;String&gt; redisSerializer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>();<br>        <span class="hljs-type">Jackson2JsonRedisSerializer</span> <span class="hljs-variable">jackson2JsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonRedisSerializer</span>(Object.class);<br><br>        <span class="hljs-comment">//解决查询缓存转换异常的问题</span><br>        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">om</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);<br>        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);<br>        jackson2JsonRedisSerializer.setObjectMapper(om);<br><br>        <span class="hljs-comment">// 配置序列化（解决乱码的问题）,过期时间600秒</span><br>        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()<br>                .entryTtl(Duration.ofSeconds(<span class="hljs-number">600</span>))<br>                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))<br>                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))<br>                .disableCachingNullValues();<br><br>        <span class="hljs-type">RedisCacheManager</span> <span class="hljs-variable">cacheManager</span> <span class="hljs-operator">=</span> RedisCacheManager.builder(factory)<br>                .cacheDefaults(config)<br>                .build();<br>        <span class="hljs-keyword">return</span> cacheManager;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure></li><li><p>在使用到缓存的模块中添加配置</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">spring.redis.host=<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>spring.redis.port=<span class="hljs-number">6379</span><br>spring.redis.database= <span class="hljs-number">0</span><br>spring.redis.timeout=<span class="hljs-number">1800000</span><br><br>spring.redis.lettuce.pool.max-active=<span class="hljs-number">20</span><br>spring.redis.lettuce.pool.max-wait=-<span class="hljs-number">1</span><br>#最大阻塞等待时间(负数表示没限制)<br>spring.redis.lettuce.pool.max-idle=<span class="hljs-number">5</span><br>spring.redis.lettuce.pool.min-idle=<span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li><li><p>在需要缓存的方法上添加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 根据id查询子数据列表</span><br>    <span class="hljs-meta">@Cacheable(value = &quot;dict&quot;,keyGenerator = &quot;keyGenerator&quot;)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Dict&gt; <span class="hljs-title function_">findChildData</span><span class="hljs-params">(Long id)</span> &#123;<br>        LambdaQueryWrapper&lt;Dict&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        wrapper.eq(Dict::getParentId, id);<br>        List&lt;Dict&gt; dictList = baseMapper.selectList(wrapper);<br>        <span class="hljs-keyword">for</span> (Dict dict : dictList) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasChildren</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.isChildren(dict.getId());<br>            dict.setHasChildren(hasChildren);<br>        &#125;<br>        <span class="hljs-keyword">return</span> dictList;<br>    &#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Redis</title>
    <link href="/2022/08/16/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/"/>
    <url>/2022/08/16/%E4%B8%AD%E9%97%B4%E4%BB%B6/Redis/</url>
    
    <content type="html"><![CDATA[<h2 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h2><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><p>Redis是一款基于内存的key-value结构数据库</p><p>默认端口号6379</p><ul><li>键值（key-value）型，value支持多种不同数据结构，功能丰富</li><li>单线程，每个命令具备原子性</li><li>低延迟，速度快（基于内存、IO多路复用、良好的编码）。</li><li>支持数据持久化</li><li>支持主从集群、分片集群</li><li>支持多语言客户端</li></ul><h3 id="使用场所"><a href="#使用场所" class="headerlink" title="使用场所"></a>使用场所</h3><ol><li>存放验证码、用户登录信息</li><li>对不常变化的数据进行缓存</li></ol><h3 id="安装及运行"><a href="#安装及运行" class="headerlink" title="安装及运行"></a>安装及运行</h3><ol><li><p>官网下载压缩包  <a href="https://redis.io/">Redis官网</a></p></li><li><p>下载redis所需依赖</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y gcc tcl<br></code></pre></td></tr></table></figure></li><li><p>上传压缩包，解压、编译、安装，默认安装在<code>/usr/local/bin</code></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -zxvf redis-<span class="hljs-number">6</span>.<span class="hljs-number">2</span>.<span class="hljs-number">6</span>.tar.gz<br><span class="hljs-attribute">cd</span> redis-<span class="hljs-number">6</span>.<span class="hljs-number">2</span>.<span class="hljs-number">6</span><br><span class="hljs-attribute">make</span> &amp;&amp; make install<br></code></pre></td></tr></table></figure></li></ol><h4 id="linux下运行redis"><a href="#linux下运行redis" class="headerlink" title="linux下运行redis"></a>linux下运行redis</h4><ol><li><p>修改配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 允许访问的地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问，生产环境不要设置为0.0.0.0</span><br><span class="hljs-attr">bind</span> <span class="hljs-string">0.0.0.0</span><br><span class="hljs-comment"># 守护进程，修改为yes后即可后台运行</span><br><span class="hljs-attr">daemonize</span> <span class="hljs-string">yes </span><br><span class="hljs-comment"># 密码，设置后访问Redis必须输入密码</span><br><span class="hljs-attr">requirepass</span> <span class="hljs-string">123456</span><br></code></pre></td></tr></table></figure></li><li><p>其他常用配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 监听的端口</span><br><span class="hljs-attr">port</span> <span class="hljs-string">6379</span><br><span class="hljs-comment"># 工作目录，默认是当前目录，也就是运行redis-server时的命令，日志、持久化等文件会保存在这个目录</span><br><span class="hljs-attr">dir</span> <span class="hljs-string">.</span><br><span class="hljs-comment"># 数据库数量，设置为1，代表只使用1个库，默认有16个库，编号0~15</span><br><span class="hljs-attr">databases</span> <span class="hljs-string">1</span><br><span class="hljs-comment"># 设置redis能够使用的最大内存</span><br><span class="hljs-attr">maxmemory</span> <span class="hljs-string">512mb</span><br><span class="hljs-comment"># 日志文件，默认为空，不记录日志，可以指定日志文件名</span><br><span class="hljs-attr">logfile</span> <span class="hljs-string">&quot;redis.log&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>运行服务器端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs linux"># 服务器端：运行redis的src目录下的redis-server文件<br>redis-server redis.conf<br></code></pre></td></tr></table></figure></li><li><p>远程连接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs linux">要远程连接的话要把配置文件的bind 127.0.0.1注释起来<br>windows命令行: ./redis-cli.exe -h 远程ip地址 -p 6379ssss<br>出现  Error: 在驱动器 %1 上插入软盘。时要把linux上的redis的protected-mode设置成no<br></code></pre></td></tr></table></figure></li></ol><h4 id="运行redis客户端"><a href="#运行redis客户端" class="headerlink" title="运行redis客户端"></a>运行redis客户端</h4><ol><li><p>命令行客户端</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ldif">redis-cli [options] [commonds]<br><span class="hljs-comment"># 常见options</span><br><span class="hljs-literal">-</span>h 127.0.0.1：指定要连接的redis节点的IP地址，默认是127.0.0.1<br><span class="hljs-literal">-</span>p 6379：指定要连接的redis节点的端口，默认是6379<br><span class="hljs-literal">-</span>a 123456：指定redis的访问密码 <br><br><span class="hljs-comment"># 测试</span><br>ping<span class="hljs-comment"># 如果连接成功返回PONG</span><br></code></pre></td></tr></table></figure></li><li><p>图形化客户端  </p><p><a href="https://github.com/lework/RedisDesktopManager-Windows/releases">下载地址</a></p></li></ol><h4 id="windows下运行redis"><a href="#windows下运行redis" class="headerlink" title="windows下运行redis"></a>windows下运行redis</h4><p>运行redis-server.exe文件即可</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">遇到启动报错时<br>redis-cli.exe<br>shutdown<br><span class="hljs-keyword">exit</span><br>redis-server.exe redis.windows.conf<br></code></pre></td></tr></table></figure><h3 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h3><h4 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h4><ul><li>字符串string</li><li>哈希 hash (适合存对象)</li><li>列表 list</li><li>集合 set</li><li>有序集合 sorted set</li></ul><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><h4 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h4><p>命令行<code>help @generic</code>查看帮助文档</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>keys pattern</td><td>查找符合模式pattern的key <br/>模糊查询会影响效率，不建议生产环境使用</td></tr><tr><td>exists key</td><td>检查key是否存在</td></tr><tr><td>type key</td><td>返回key所存储的值得类型</td></tr><tr><td>ttl key</td><td>查看key的剩余有效时间<br/>-2已失效，-1永久有效</td></tr><tr><td>expire key seconds</td><td>设置key的有效剩余时间</td></tr><tr><td>del key</td><td>删除key</td></tr></tbody></table><h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>set key value</td><td>设置值</td></tr><tr><td>get key</td><td>获取值</td></tr><tr><td>mset k1 v1 k2 v2 …</td><td>multi，批量设置值</td></tr><tr><td>mget v1 v2 …</td><td>批量获取值</td></tr><tr><td>incr key</td><td>让整型的key自增1</td></tr><tr><td>incrby key step</td><td>让整型的key自增自定义步长</td></tr><tr><td>setex key seconds value</td><td>设置值并指定过期时间(秒)</td></tr><tr><td>setnx key value</td><td>当key不存在时才设置值</td></tr></tbody></table><h4 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h4><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>hset key field value</td><td>(可以批量)设置key中字段field的值</td></tr><tr><td>hget key field</td><td>(可以批量)获取key中字段field的值</td></tr><tr><td>hdel key field</td><td>删除key中字段field</td></tr><tr><td>hkeys key</td><td>获取key中所有字段</td></tr><tr><td>hvals key</td><td>获取key中所有值</td></tr><tr><td>hgetall key</td><td>获取key中所有字段和值</td></tr><tr><td>hincrby key field step</td><td>自增</td></tr><tr><td>hsetnx key field value</td><td>field不存在时才添加</td></tr></tbody></table><h4 id="List"><a href="#List" class="headerlink" title="List"></a>List</h4><p>类似java的LinkedList</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>lpush key value1 [value2…]</td><td>插入一个或多个值到列表左边</td></tr><tr><td>lrange key start stop</td><td>获取列表指定范围内的元素</td></tr><tr><td>rpop key</td><td>移除并获取列表最右边一个元素</td></tr><tr><td>llen key</td><td>获取列表长度</td></tr><tr><td>brpop key1 [key2..] timeout</td><td>在timeout时间里移除并获取列表最右一个元素</td></tr></tbody></table><h4 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h4><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>sadd key member1 [member2…]</td><td>添加一个或多个元素</td></tr><tr><td>smembers key</td><td>返回所有元素</td></tr><tr><td>scard key</td><td>获取元素数</td></tr><tr><td>sinter key1 [key2…]</td><td>返回交集</td></tr><tr><td>sunion key1 [key2…]</td><td>返回并集</td></tr><tr><td>sdiff key1 [key2…]</td><td>返回差集</td></tr><tr><td>srem key member1 [member2…]</td><td>移除一个或多个元素</td></tr><tr><td>sismember key member</td><td>判断元素是否在集合中</td></tr></tbody></table><h4 id="Sorted-Set"><a href="#Sorted-Set" class="headerlink" title="Sorted Set"></a>Sorted Set</h4><p>类似java的TreeSet</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>zadd key score1 member1 [score2 member2…]</td><td>添加一个或多个元素，或更新已有元素的分数</td></tr><tr><td>zrange key start stop [withscores]</td><td>获取指定区间元素</td></tr><tr><td>zincrby key increment member</td><td>对指定元素的分数加上增量increment</td></tr><tr><td>zrem key member1 [member2…]</td><td>移除一个或多个元素</td></tr><tr><td>zcount key min max</td><td>统计score值在给定范围内的所有元素的个数</td></tr><tr><td>zcard key</td><td>获取sorted set中的元素个数</td></tr><tr><td>zranke key member</td><td>获取sorted set 中的指定元素的排名</td></tr></tbody></table><h4 id="key的层级关系"><a href="#key的层级关系" class="headerlink" title="key的层级关系"></a>key的层级关系</h4><p>推荐key的命名方式为<code>项目名:业务名:类型:id</code></p><p>RDM图形界面工具会自动根据<code>:</code> 来分包</p><h3 id="java操作redis"><a href="#java操作redis" class="headerlink" title="java操作redis"></a>java操作redis</h3><h4 id="jedis"><a href="#jedis" class="headerlink" title="jedis"></a>jedis</h4><p>jedis的方法名和redis的命令是一样的，方便学习，但是线程不安全</p><p><a href="https://github.com/redis/jedis">jedis仓库</a></p><ol><li><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!--单元测试--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-jupiter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisTest</span> &#123;<br>    <span class="hljs-keyword">private</span> Jedis jedis;<br><br>    <span class="hljs-meta">@BeforeEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 建立连接</span><br>        jedis = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">&quot;47.96.80.163&quot;</span>, <span class="hljs-number">6378</span>);<br>        <span class="hljs-comment">// 设置密码</span><br>        jedis.auth(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-comment">// 选择库，默认0</span><br>        jedis.select(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> &#123;<br>        jedis.set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;zs&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(name);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterEach</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 关闭连接</span><br>        <span class="hljs-keyword">if</span> (jedis != <span class="hljs-literal">null</span>)<br>            jedis.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p>​<a href="https://blog.csdn.net/ming_yeye/article/details/117789182">遇到程序包redis.clients.jedis不存在时</a></p><h5 id="jedis连接池"><a href="#jedis连接池" class="headerlink" title="jedis连接池"></a>jedis连接池</h5><p>因为jedis是线程不安全的，所以可以使用jedis连接池来给每个线程分配一个jedis，从而避免因为多线程导致的问题</p><ol><li><p>编写连接池工厂类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisConnectionFactory</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JedisPool jedisPool;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-comment">// 配置连接池</span><br>        <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>        poolConfig.setMaxTotal(<span class="hljs-number">8</span>);      <span class="hljs-comment">// 最大数量</span><br>        poolConfig.setMaxIdle(<span class="hljs-number">8</span>);       <span class="hljs-comment">// 最大保存待命的数量</span><br>        poolConfig.setMinIdle(<span class="hljs-number">0</span>);       <span class="hljs-comment">// 最小保存待命的数量</span><br>        poolConfig.setMaxWait(Duration.ofSeconds(<span class="hljs-number">200</span>));     <span class="hljs-comment">// 最大等待时间，超出时间就会销毁</span><br>        <span class="hljs-comment">// 创建连接池对象，参数：连接池配置、服务端ip、服务端端口、超时时间、密码</span><br>        jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig, <span class="hljs-string">&quot;47.96.80.163&quot;</span>, <span class="hljs-number">6378</span>, <span class="hljs-number">1000</span>, <span class="hljs-string">&quot;123456&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试通过线程池获取jedis</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@BeforeEach</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 建立连接</span><br>    jedis = JedisConnectionFactory.getJedis();<br>    <span class="hljs-comment">// 设置密码</span><br>    jedis.auth(<span class="hljs-string">&quot;123456&quot;</span>);<br>    <span class="hljs-comment">// 选择库，默认0</span><br>    jedis.select(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="Spring-Data-Redis"><a href="#Spring-Data-Redis" class="headerlink" title="Spring Data Redis"></a>Spring Data Redis</h4><p>SpringDataRedis中提供了RedisTemplate工具类，其中封装了各种对Redis的操作。</p><p>通过opsForXXX()方法获取操作某个数据类型的对象，再进行操作</p><p><a href="https://spring.io/projects/spring-data-redis">官方文档</a></p><ol><li><p>导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- spring-data-redis依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 连接池依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>添加配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">47.96</span><span class="hljs-number">.80</span><span class="hljs-number">.163</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6378</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-comment"># 默认使用lettuce连接池，要使用jedis连接池需要导入jedis依赖</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">1000ms</span><br></code></pre></td></tr></table></figure></li><li><p>注入RedisTemplate测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringDataRedisDemoApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> &#123;<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;aaa&quot;</span>, <span class="hljs-string">&quot;bbb&quot;</span>);<br>        System.out.println(redisTemplate.opsForValue().get(<span class="hljs-string">&quot;aaa&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="自定义序列化器"><a href="#自定义序列化器" class="headerlink" title="自定义序列化器"></a>自定义序列化器</h5><p>默认使用jdk的序列化器，可读性差，内存占用较大</p><ol><li><p>编写配置类</p><p>使用到了json序列化器，可能要自己导入坐标</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--jackson--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> &#123;<br>        <span class="hljs-comment">// 创建RedisTemplate对象</span><br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        <span class="hljs-comment">// 设置连接工厂</span><br>        template.setConnectionFactory(connectionFactory);<br>        <span class="hljs-comment">// 创建JSON序列化工具</span><br>        <span class="hljs-type">GenericJackson2JsonRedisSerializer</span> <span class="hljs-variable">jsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();<br>        <span class="hljs-comment">// 创建key序列化工具</span><br>        template.setKeySerializer(RedisSerializer.string());<br>        template.setHashKeySerializer(RedisSerializer.string());<br>        <span class="hljs-comment">// 创建value序列化工具</span><br>        template.setValueSerializer(jsonRedisSerializer);<br>        template.setHashValueSerializer(jsonRedisSerializer);<br><br>        <span class="hljs-keyword">return</span> template;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testUser</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-number">20</span>);<br>    redisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:1&quot;</span>, user);<br>    System.out.println(redisTemplate.opsForValue().get(<span class="hljs-string">&quot;user:1&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><p>redis中存的格式为</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@class&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;com.xw.springdataredisdemo.pojo.User&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;张三&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>会额外存序列化的类信息，占据额外内存，可以使用<strong>StringRedisTemplate</strong>解决这个问题</p></li></ol><h5 id="StringRedisTemplate"><a href="#StringRedisTemplate" class="headerlink" title="StringRedisTemplate"></a>StringRedisTemplate</h5><ol><li><p>注入StringRedisTemplate，测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringDataRedisDemoApplicationTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><span class="hljs-comment">// JSON序列化工具</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JsonProcessingException &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-number">20</span>);<br>        <span class="hljs-comment">// 手动序列化为json</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(user);<br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:1&quot;</span>, json);<br>        <span class="hljs-comment">// 手动反序列化</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonUser</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(<span class="hljs-string">&quot;user:1&quot;</span>);<br>        <span class="hljs-type">User</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> mapper.readValue(jsonUser, User.class);<br>        System.out.println(u);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>redis中存的格式为</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;张三&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h3><h4 id="缓存更新"><a href="#缓存更新" class="headerlink" title="缓存更新"></a>缓存更新</h4><h5 id="更新策略"><a href="#更新策略" class="headerlink" title="更新策略"></a>更新策略</h5><ol><li><p><strong>内存淘汰：</strong>redis自动进行，当redis内存达到咱们设定的max-memery的时候，会自动触发淘汰机制，淘汰掉一些不重要的数据(可以自己设置策略方式)</p></li><li><p><strong>超时剔除：</strong>当我们给redis设置了过期时间ttl之后，redis会将超时的数据进行删除，方便咱们继续使用缓存</p></li><li><p><strong>主动更新：</strong>我们可以手动调用方法把缓存删掉，通常用于解决缓存和数据库不一致问题</p></li></ol><h5 id="最佳实践方案"><a href="#最佳实践方案" class="headerlink" title="最佳实践方案"></a>最佳实践方案</h5><ol><li>低一致性需求：使用redis的内存淘汰机制</li><li>高一致性需求：主动更新，并以超时剔除作为兜底方案<ul><li>读操作<ul><li>缓存未命中则查询数据库，并写入缓存，并设定超时时间</li></ul></li><li>写操作<ul><li>先写数据库再删缓存</li></ul></li></ul></li></ol><h4 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h4><p>缓存穿透是指客户端请求的数据在缓存中和数据库中都不存在，这样缓存永远不会生效，这些请求都会打到数据库。</p><h5 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h5><ul><li><strong>缓存空对象</strong><ul><li>原理：即使访问的对象不存在，也在缓存中存一份空对象</li><li>优点：实现简单，维护方便</li><li>缺点：<ul><li>额外的内存消耗</li><li>可能造成短期的不一致</li></ul></li></ul></li><li><strong>布隆过滤</strong><ul><li>原理：在缓存前多加一层，通过一个庞大的二进制数组，走哈希思想去判断当前这个要查询的这个数据是否存在，如果布隆过滤器判断存在，则放行</li><li>优点：内存占用较少，没有多余key</li><li>缺点：<ul><li>实现复杂</li><li>存在误判可能</li></ul></li></ul></li></ul><h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><p>在同一时段大量的缓存key同时失效或者Redis服务宕机，导致大量请求到达数据库，带来巨大压力。</p><h5 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h5><ul><li>给不同的Key的TTL添加随机值</li><li>利用Redis集群提高服务的可用性</li><li>给缓存业务添加降级限流策略</li><li>给业务添加多级缓存</li></ul><h4 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h4><p>也叫热点Key问题，就是一个被高并发访问并且缓存重建业务较复杂的key突然失效了，无数的请求访问会在瞬间给数据库带来巨大的冲击。</p><p><strong>解决方案</strong></p><ul><li><p><strong>互斥锁</strong></p><ul><li>原理：第一个查询未命中的线程去(上锁)查询数据库、重建缓存数据，其他线程再此期间等待，直到缓存更新</li><li>优点：没有额外内存消耗，保证一致性，实现简单</li><li>缺点：影响性能，可能有死锁风险</li></ul></li><li><p><strong>逻辑过期</strong></p><ul><li>原理：设置一个过期时间的key，当过期时不删除缓存，而是有一个额外的线程持有锁去进行重构数据，在此期间其他线程返回的是旧数据</li><li>优点：线程无需等待，性能较好</li><li>缺点：不能保证一致性，有额外内存消耗，实现复杂</li></ul></li></ul><h5 id="互斥锁实例"><a href="#互斥锁实例" class="headerlink" title="互斥锁实例"></a>互斥锁实例</h5><ol><li><p>定义获取锁、释放锁的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-comment">// setIfAbsent只有不存在时才放入值，以此来实现互斥锁</span><br>    <span class="hljs-comment">// 尝试获取锁</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>    <span class="hljs-comment">// 通过BooleanUtil，防止拆箱时空指针</span><br>    <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">(String key)</span> &#123;<br>    stringRedisTemplate.delete(key);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithPassMutex</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 从redis中查询缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);<br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>        <span class="hljs-keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;&quot;</span>.equals(shopJson)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 防止缓存击穿</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:shop:&quot;</span> + id;<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>        <span class="hljs-keyword">if</span> (!isLock) &#123;<br>            Thread.sleep(<span class="hljs-number">50</span>);<br>            <span class="hljs-keyword">return</span> queryWithPassThrough(id);<br>        &#125;<br>        <span class="hljs-comment">// 没有缓存，从数据库中取数据</span><br>        shop = <span class="hljs-built_in">this</span>.getById(id);<br>        <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 将空对象保存到redis，防止缓存穿透</span><br>            stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(shop), CACHE_SHOP_TTL, TimeUnit.MINUTES);<br>    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        unLock(lockKey);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> shop;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h5 id="逻辑过期实例"><a href="#逻辑过期实例" class="headerlink" title="逻辑过期实例"></a>逻辑过期实例</h5><ol><li><p>定义获取锁、释放锁的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-comment">// setIfAbsent只有不存在时才放入值，以此来实现互斥锁</span><br>    <span class="hljs-comment">// 尝试获取锁</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>    <span class="hljs-comment">// 通过BooleanUtil，防止拆箱时空指针</span><br>    <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">(String key)</span> &#123;<br>    stringRedisTemplate.delete(key);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>定义重建缓存的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveShop2Redis</span><span class="hljs-params">(Long id, Long expireSeconds)</span> &#123;<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getById(id);<br>    <span class="hljs-comment">// 封装逻辑过期时间</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>    redisData.setData(shop);<br>    redisData.setExpireTime(LocalDateTime.now().plusSeconds(expireSeconds));<br>    <span class="hljs-comment">// 写入Redis</span><br>    stringRedisTemplate.opsForValue().set(CACHE_SHOP_KEY + id, JSONUtil.toJsonStr(redisData));<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br><span class="hljs-comment">// 固定大小的线程池</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithPassLogicalExpire</span> <span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 从redis中查询缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(CACHE_SHOP_KEY + id);<br>    <span class="hljs-keyword">if</span> (StrUtil.isBlank(shopJson)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, RedisData.class);<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);<br>    <span class="hljs-comment">// 判断是否过期</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>    <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// 未过期，直接返回</span><br>        <span class="hljs-keyword">return</span> shop;<br>    &#125;<br>    <span class="hljs-comment">// 已过期，重建缓存</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-keyword">if</span> (isLock) &#123;<br>        <span class="hljs-comment">// 开启新线程</span><br>        CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 重建缓存</span><br>                <span class="hljs-built_in">this</span>.saveShop2Redis(id, <span class="hljs-number">30L</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// 释放锁</span><br>                unLock(lockKey);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <span class="hljs-comment">// 返回旧数据</span><br>    <span class="hljs-keyword">return</span> shop;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="封装工具类"><a href="#封装工具类" class="headerlink" title="封装工具类"></a>封装工具类</h4><p>具有的功能：</p><ol><li>存<ul><li>将任意对象序列化为json存到string类型的key的缓存中，并设置TTL过期时间</li><li>将任意对象序列化为json存到string类型的key的缓存中，并设置逻辑过期时间，用于处理缓存击穿问题</li></ul></li><li>取<ul><li>根据key查询缓存，并反序列化为指定对象，利用缓存空值的方法解决缓存穿透问题</li><li>根据key查询缓存，并反序列化为指定对象，利用逻辑过期解决缓存击穿问题</li></ul></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-comment">// 固定大小的线程池</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheClient</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonValue</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(value);<br>        stringRedisTemplate.opsForValue().set(key, jsonValue, time, unit);<br>    &#125;<br><br>    <span class="hljs-comment">// 逻辑过期，用于防止缓存穿透</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithLogicExpire</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-comment">// 设置逻辑过期</span><br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>        redisData.setData(value);<br>        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));<br>        <span class="hljs-comment">// 写入Redis</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">jsonValue</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(redisData);<br>        stringRedisTemplate.opsForValue().set(key, jsonValue, time, unit);<br>    &#125;<br><br>    <span class="hljs-comment">// 存空对象，用于防止缓存穿透</span><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type,  Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 从redis中查询缓存</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;&quot;</span>.equals(json)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 没有缓存，通过用户自定义方法查询数据库</span><br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>        <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 将空对象保存到redis，防止缓存穿透</span><br>            stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br><br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-comment">// 对逻辑过期数据的查询</span><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithPassLogicalExpire</span> <span class="hljs-params">(String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 从redis中查询缓存</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(json)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);<br>        <span class="hljs-comment">// 判断是否过期</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>        <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>            <span class="hljs-comment">// 未过期，直接返回</span><br>            <span class="hljs-keyword">return</span> r;<br>        &#125;<br>        <span class="hljs-comment">// 已过期，重建缓存</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>        <span class="hljs-keyword">if</span> (isLock) &#123;<br>            <span class="hljs-comment">// 开启新线程</span><br>            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 重建缓存: 查询数据库、写入缓存</span><br>                    <span class="hljs-type">R</span> <span class="hljs-variable">r1</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>                    <span class="hljs-built_in">this</span>.setWithLogicExpire(key, r1, time, unit);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// 释放锁</span><br>                    unLock(lockKey);<br>                &#125;<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">// 返回旧数据</span><br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-comment">// setIfAbsent只有不存在时才放入值，以此来实现互斥锁</span><br>        <span class="hljs-comment">// 尝试获取锁</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>        <span class="hljs-comment">// 通过BooleanUtil，防止拆箱时空指针</span><br>        <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unLock</span><span class="hljs-params">(String key)</span> &#123;<br>        stringRedisTemplate.delete(key);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h4 id="优惠券秒杀"><a href="#优惠券秒杀" class="headerlink" title="优惠券秒杀"></a>优惠券秒杀</h4><h5 id="全局id生成器"><a href="#全局id生成器" class="headerlink" title="全局id生成器"></a>全局id生成器</h5><blockquote><p> 是一种在分布式系统下用来生成全局唯一ID的工具</p></blockquote><p>id(Long型，64位)的结构可以设计成：</p><p><code>符号位(1位，为0) ：时间戳(31位，以秒为单位) ：序列号（32位）</code></p><p>作用：</p><ul><li>增加id的复杂性，防止被猜出规律</li><li>唯一性，安全性</li></ul><p><strong>Redis自增实现全局id生成器</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisIdWorker</span> &#123;<br><br>    <span class="hljs-comment">// 开始时间戳</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BEGIN_TIMESTAMP</span> <span class="hljs-operator">=</span> <span class="hljs-number">1640995200L</span>;<br><br>    <span class="hljs-comment">// 序列号位数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>;<br><br>    <span class="hljs-comment">// redis</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisIdWorker</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nextId</span><span class="hljs-params">(String keyPrefix)</span> &#123;<br>        <span class="hljs-comment">// 生成时间戳</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nowSecond</span> <span class="hljs-operator">=</span> now.toEpochSecond(ZoneOffset.UTC);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">timeStamp</span> <span class="hljs-operator">=</span> nowSecond - BEGIN_TIMESTAMP;<br>        <span class="hljs-comment">// 生成序列号</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy:MM:dd&quot;</span>));  <span class="hljs-comment">// 获取当天日期</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="hljs-string">&quot;icr:&quot;</span> + keyPrefix + <span class="hljs-string">&quot;:&quot;</span> + date);<span class="hljs-comment">// 以天为单位生成序列号</span><br>        <span class="hljs-comment">// 返回id</span><br>        <span class="hljs-keyword">return</span> timeStamp &lt;&lt; COUNT_BITS | count;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 获取当前时间的秒数</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> LocalDateTime.of(<span class="hljs-number">2022</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> time.toEpochSecond(ZoneOffset.UTC);<br>        System.out.println(second);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>测试</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HmDianPingApplicationTests</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisIdWorker redisIdWorker;<br><br>    <span class="hljs-comment">// 固定大小线程池</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">es</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">500</span>);<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisIdWorker</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">300</span>);<br><br>        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> () -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>                System.out.println(id);<br>            &#125;<br>            latch.countDown();<br>        &#125;;<br><br>        <span class="hljs-type">long</span> <span class="hljs-variable">begin</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">300</span>; i++) &#123;<br>            es.submit(task);<br>        &#125;<br>        latch.await();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br><br>        System.out.println(<span class="hljs-string">&quot;执行时间 = &quot;</span> + (end - begin));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="超卖问题"><a href="#超卖问题" class="headerlink" title="超卖问题"></a>超卖问题</h5><p>超卖问题是典型的多线程安全问题，针对这一问题的常见解决方案就是加锁</p><p>通常有两种解决方案</p><ul><li><strong>悲观锁</strong>：认为线程安全问题一定会发生，因此在操作数据之前先获取锁，确保线程串行执行</li><li><strong>乐观锁</strong>：认为线程安全问题不一定会发生，只在更新数据的时候去判断数据是否被其他线程修改</li></ul><p><strong>实例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> ISeckillVoucherService seckillVoucherService;<br><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedisIdWorker redisIdWorker;<br><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// 查询数据</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">voucher</span> <span class="hljs-operator">=</span> seckillVoucherService.getById(voucherId);<br>    <span class="hljs-comment">// 判断开始结束时间</span><br>    <span class="hljs-keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀尚未开始!&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;秒杀已经结束!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 判断库存</span><br>    <span class="hljs-keyword">if</span> (voucher.getStock() &lt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;库存不足&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 获取锁对象</span><br>    <span class="hljs-comment">// SimpleRedisLock lock = new SimpleRedisLock(&quot;order:&quot; + userId, stringRedisTemplate);</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock:order:&quot;</span> + userId);<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>    <span class="hljs-keyword">if</span> (!isLock) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;不允许重复下单&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) AopContext.currentProxy();<br>        <span class="hljs-keyword">return</span> proxy.createVoucherOrder(userId, voucherId);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        lock.unlock();<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long userId, Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// 一人一单</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId)<br>        .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;用户已经购买过一次&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 扣减库存</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>        .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>        .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId)<br>        .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// 防止超卖</span><br>        .update();<br>    <span class="hljs-keyword">if</span> (!success)<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;库存不足&quot;</span>);<br>    <span class="hljs-comment">// 创建订单</span><br>    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>    voucherOrder.setId(orderId);<br>    voucherOrder.setUserId(userId);<br>    voucherOrder.setVoucherId(voucherId);<br>    <span class="hljs-built_in">this</span>.save(voucherOrder);<br>    <span class="hljs-comment">// 返回订单id</span><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h5><p>满足分布式系统或集群模式下多进程可见并且互斥的锁</p><blockquote><p>在集群部署的时候不能使用synchronized作为锁，每个tomcat都有一个属于自己的jvm，锁的时候不是锁的同一个对象，导致synchronized失效</p></blockquote><p><strong>分布式锁应满足的条件</strong>：</p><ol><li><p>可见性：多个线程都能看到相同的结果，注意：这个地方说的可见性并不是并发编程中指的内存可见性，只是说多个进程之间都能感知到变化的意思</p></li><li><p>互斥：互斥是分布式锁的最基本的条件，使得程序串行执行</p></li><li><p>高可用：程序不易崩溃，时时刻刻都保证较高的可用性</p></li><li><p>高性能：由于加锁本身就让性能降低，所有对于分布式锁本身需要他就较高的加锁性能和释放锁性能</p></li></ol><p><strong>基于Redis实现分布式锁</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ILock</span> &#123;<br>      <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span>;<br><br>      <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>第一版锁，在业务时间超过锁过期时间时，存在锁被其他jvm的线程误删的风险</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ILock</span> &#123;<br><br>    <span class="hljs-comment">// 锁前缀</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br><br>    <span class="hljs-comment">// 锁名称</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleRedisLock</span><span class="hljs-params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> KEY_PREFIX + name;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> Thread.currentThread().getId();    <span class="hljs-comment">// 以当前线程的id作为值</span><br>        <span class="hljs-comment">// 获取锁</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, value + <span class="hljs-string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);<br>        <span class="hljs-comment">// 通过equlas防止拆箱时可能的空指针</span><br>        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(success);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        stringRedisTemplate.delete(KEY_PREFIX + name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>第二版锁，解决锁误删的问题</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRedisLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ILock</span> &#123;<br><br>        <span class="hljs-comment">// 锁前缀</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:&quot;</span>;<br>    <span class="hljs-comment">// 用于标识不同线程的锁</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ID_PREFIX</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>) + <span class="hljs-string">&quot;-&quot;</span>;<br><br>    <span class="hljs-comment">// 锁名称</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimpleRedisLock</span><span class="hljs-params">(String name, StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> KEY_PREFIX + name;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();    <span class="hljs-comment">// 以当前线程的id作为值</span><br>        <span class="hljs-comment">// 获取锁</span><br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, value, timeoutSec, TimeUnit.SECONDS);<br>        <span class="hljs-comment">// 通过equlas防止拆箱时可能的空指针</span><br>        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(success);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 判断线程标识</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> KEY_PREFIX + name;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();    <span class="hljs-comment">// 以当前线程的id作为值</span><br>        <span class="hljs-keyword">if</span> (stringRedisTemplate.opsForValue().get(key).equals(value)) &#123;<br>            stringRedisTemplate.delete(KEY_PREFIX + name);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="原子性问题"><a href="#原子性问题" class="headerlink" title="原子性问题"></a>原子性问题</h5><p>执行完业务，要释放锁的时候，先判断锁标识是否一致，然后再释放锁</p><p>此时若获取锁标识后出现阻塞，在阻塞期间锁过期并被其他jvm的线程获取</p><p>当阻塞结束就有可能将锁误删除</p><blockquote><p>获取锁标识和释放锁不是原子性的</p></blockquote><p><strong>解决方式</strong></p><p>通过Lua脚本实现原子性操作多条命令</p><p><strong>客户端调用脚本</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 示例</span><br><span class="hljs-comment">-- 1 表示有一个key，后面跟参数，ky会保存到KEYS[]，value会保存到ARGV[]中</span><br><span class="hljs-comment">-- 注意lua数组下标从1开始</span><br>EVAL <span class="hljs-string">&quot;return redis.call(&#x27;set&#x27;,&#x27;KEYS[1],ARGV[1]&#x27;)&quot;</span> <span class="hljs-number">1</span> name Rose<br></code></pre></td></tr></table></figure><p><strong>java调用lua脚本</strong></p><p>创建lua脚本</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>]) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 释放锁</span><br>    <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">&#x27;del&#x27;</span>, KEYS[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><p>加载lua脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 解锁脚本</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;<br><span class="hljs-keyword">static</span> &#123;<br>    UNLOCK_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>    <span class="hljs-comment">// 脚本所在位置</span><br>    UNLOCK_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;script/unlock.lua&quot;</span>));<br>    <span class="hljs-comment">// 设置脚本返回值类型</span><br>    UNLOCK_SCRIPT.setResultType(Long.class);<br>&#125;<br></code></pre></td></tr></table></figure><p>使用脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> KEY_PREFIX + name;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();    <span class="hljs-comment">// 以当前线程的id作为值</span><br>    stringRedisTemplate.execute(<br>        UNLOCK_SCRIPT,<br>        Collections.singletonList(key),<br>        value<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Redisson"><a href="#Redisson" class="headerlink" title="Redisson"></a>Redisson</h5><p>Redisson是一个在Redis的基础上实现的Java驻内存数据网格（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务，其中就包含了各种<strong>分布式锁</strong>的实现。</p><p><strong>使用</strong></p><ol><li><p>引入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.13.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p>配置Redisson客户端</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://127.0.0.1:6379&quot;</span>);<br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissionClient redissonClient;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">//获取锁(可重入)，指定锁的名称</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br>    <span class="hljs-comment">//尝试获取锁，参数分别是：获取锁的最大等待时间(期间会重试)，锁自动释放时间，时间单位</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>,TimeUnit.SECONDS);<br>    <span class="hljs-comment">//判断获取锁成功</span><br>    <span class="hljs-keyword">if</span>(isLock)&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;执行业务&quot;</span>);          <br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            <span class="hljs-comment">//释放锁</span><br>            lock.unlock();<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><p><strong>Redission分布式锁原理</strong></p><ul><li><p><strong>可重入</strong>：利用hash结构记录线程id和重入次数</p></li><li><p><strong>可重试</strong>：利用信号量和PubSub功能实现等待、唤醒，获取锁失败的重试机制</p></li><li><p><strong>超时续约</strong>：利用watchDog，每隔一段时间(releaseTime &#x2F; 3)，重置超时时间</p></li><li><p><strong>主从一致性</strong>：多个独立的Redis节点，必须在所有节点都获取重入锁，蔡栓获取锁成功</p></li></ul><h4 id="优化秒杀"><a href="#优化秒杀" class="headerlink" title="优化秒杀"></a>优化秒杀</h4><p><strong>思路</strong>：</p><p><strong>将耗时比较短的逻辑判断放入到redis中</strong>，比如是否库存足够，比如是否一人一单，这样的操作，只要这种逻辑可以完成，就意味着我们是一定可以下单完成的，我们只需要进行快速的逻辑判断，根本就不用等下单逻辑走完，我们直接给用户返回成功， 再在后台开一个线程，后台线程慢慢的去执行queue里边的消息</p><p><strong>实例</strong>：</p><ol><li><p>在新增秒杀券的时候，将库存信息保存到redis中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSeckillVoucher</span><span class="hljs-params">(Voucher voucher)</span> &#123;<br>    <span class="hljs-comment">// 保存优惠券</span><br>    save(voucher);<br>    <span class="hljs-comment">// 保存秒杀信息</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillVoucher</span>();<br>    seckillVoucher.setVoucherId(voucher.getId());<br>    seckillVoucher.setStock(voucher.getStock());<br>    seckillVoucher.setBeginTime(voucher.getBeginTime());<br>    seckillVoucher.setEndTime(voucher.getEndTime());<br>    seckillVoucherService.save(seckillVoucher);<br>    <span class="hljs-comment">// 保存优惠券库存到redis中</span><br>    stringRedisTemplate.opsForValue().set(RedisConstants.SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>将判断库存和一人一单的判断逻辑写到lua脚本中，实现快速判断是否能购买</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> voucherId = ARGV[<span class="hljs-number">1</span>]<br><span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">2</span>]<br><br><span class="hljs-keyword">local</span> stockKey = <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br><span class="hljs-keyword">local</span> orderKey = <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><br><span class="hljs-comment">-- 判断库存是否充足</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 库存不足，返回1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 判断当前用户是否已下过单(一人一单)</span><br><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 以下过单，返回2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 扣除库存，下单</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, <span class="hljs-number">-1</span>)<br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; SECKILL_SCRIPT;<br><span class="hljs-keyword">static</span> &#123;<br>    SECKILL_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>    SECKILL_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;script/seckill.lua&quot;</span>));<br>    SECKILL_SCRIPT.setResultType(Long.class);<br>&#125;<br><br>IVoucherOrderService proxy;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 执行lua脚本判断</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>        SECKILL_SCRIPT,<br>        Collections.emptyList(),    <span class="hljs-comment">// keys</span><br>        voucherId.toString(), userId.toString() <span class="hljs-comment">//values</span><br>    );<br>    <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> result.intValue();<br>    <span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(r == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;库存不足&quot;</span> : <span class="hljs-string">&quot;不能重复下单&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 保存到阻塞队列（之后通过lua脚本完成）</span><br>    <span class="hljs-comment">// 获取代理对象</span><br>    proxy = (IVoucherOrderService) AopContext.currentProxy();<br>    orderTasks.add(voucherOrder);<br><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>下单时将创建&#x2F;保存订单任务放到(<strong>jdk的</strong>)阻塞队列中，异步执行任务</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 阻塞队列和执行下单的线程</span><br><span class="hljs-keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">SECKILL_ORDER_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br><br><span class="hljs-comment">// 类初始化完后会调用此方法</span><br><span class="hljs-meta">@PostConstruct</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 开启处理阻塞队列的线程</span><br>    SECKILL_ORDER_EXECUTOR.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrderHandler</span>());<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 获取阻塞队列里的订单，如果队列为空则会阻塞住</span><br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> orderTasks.take();<br>                <span class="hljs-comment">// 创建订单</span><br>                handleVoucherOrder(voucherOrder);<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                log.error(<span class="hljs-string">&quot;处理订单异常&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>    <span class="hljs-comment">// 一人一单</span><br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId)<br>        .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();<br>    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>        log.error(<span class="hljs-string">&quot;用户已经购买过一次&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 扣减库存</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>        .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>)<br>        .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId())<br>        .gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// 防止超卖</span><br>        .update();<br>    <span class="hljs-keyword">if</span> (!success)<br>        log.error(<span class="hljs-string">&quot;库存不足&quot;</span>);<br>    <span class="hljs-comment">// 保存订单</span><br>    <span class="hljs-built_in">this</span>.save(voucherOrder);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="Redis消息队列"><a href="#Redis消息队列" class="headerlink" title="Redis消息队列"></a>Redis消息队列</h4><h5 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h5><p>消息队列模型主要包括的三个角色：</p><ul><li><strong>生产者</strong>：发送消息到消息队列</li><li><strong>消息队列</strong>：存储和管理消息，也称为消息代理</li><li><strong>消费者</strong>：从消息队列获取消息并处理</li></ul><p>Redis提供了三种不同的方式来实现消息队列：</p><ul><li><strong>list</strong>：基于List结构模拟消息队列</li><li><strong>PubSub</strong>：基于点对点消息模型（发布订阅）</li><li><strong>Stream</strong>：比较完善的消息队列模型</li></ul><h5 id="基于List实现消息队列"><a href="#基于List实现消息队列" class="headerlink" title="基于List实现消息队列"></a>基于List实现消息队列</h5><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>LPUSH&#x2F;RPUSH keys values</td><td>往双端队列存数据</td></tr><tr><td>LPOP&#x2F;RPOP</td><td>从双端队列取数据并删除</td></tr><tr><td>BLPOP&#x2F;BRPOP</td><td>取数据，没有数据的时候会等待</td></tr></tbody></table><p>缺点：</p><ul><li>无法避免消息丢失</li><li>只支持单消费者</li></ul><h5 id="基于PubSub的消息队列"><a href="#基于PubSub的消息队列" class="headerlink" title="基于PubSub的消息队列"></a>基于PubSub的消息队列</h5><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>SUBSCRIBE channels</td><td>订阅频道</td></tr><tr><td>PUBLISH channel msg</td><td>向一个频道发送消息</td></tr><tr><td>PSUBSCRIBE pattern</td><td>订阅与pattern格式匹配的所有频道<br/>?：匹配一个字符<br/>*：匹配0到多个字符<br/>[ab]：匹配括号里的字符</td></tr></tbody></table><p>缺点：</p><ul><li>不支持数据持久化</li><li>无法避免消息丢失</li><li>消息堆积有上限，超出会数据丢失</li></ul><h5 id="基于Stream的消息队列"><a href="#基于Stream的消息队列" class="headerlink" title="基于Stream的消息队列"></a>基于Stream的消息队列</h5><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>XADD</td><td>发送消息</td></tr><tr><td>XREAD</td><td>读取消息，不会删除</td></tr></tbody></table><p><img src="/img/redis_img/xadd.png"></p><p><img src="/img/redis_img/xread.png"></p><p>特点：</p><ul><li>消息可回溯</li><li>一个消息可以被多个消费者读取</li><li>可以阻塞读取</li><li>有消息漏读的风险</li></ul><h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>基于Redis的Stream结构作为消息队列，实现异步秒杀下单</p><ol><li><p>创建消息队列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs redis">XGROUP create stream.orders g1 0 mkstream <br></code></pre></td></tr></table></figure></li><li><p>修改判断是否有抢购资格的lua脚本，发送消息到消息队列</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> voucherId = ARGV[<span class="hljs-number">1</span>]<br><span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">2</span>]<br><span class="hljs-keyword">local</span> orderId = ARGV[<span class="hljs-number">3</span>]<br><br><span class="hljs-keyword">local</span> stockKey = <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br><span class="hljs-keyword">local</span> orderKey = <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><br><span class="hljs-comment">-- 判断库存是否充足</span><br><span class="hljs-keyword">if</span> (<span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 库存不足，返回1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 判断当前用户是否已下过单(一人一单)</span><br><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 以下过单，返回2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- 扣除库存，下单</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, <span class="hljs-number">-1</span>)<br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br><span class="hljs-comment">-- 发送消息到队列中</span><br>redis.call(<span class="hljs-string">&#x27;xadd&#x27;</span>, <span class="hljs-string">&#x27;stream.orders&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;userId&#x27;</span>, userId, <span class="hljs-string">&#x27;voucherId&#x27;</span>, voucherId, <span class="hljs-string">&#x27;id&#x27;</span>, orderId)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure></li><li><p>编写处理消息逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;stream.orders&quot;</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 获取消息队列里的订单，如果队列为空则会阻塞住</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                    Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                    StreamReadOptions.empty().count(<span class="hljs-number">1</span>).block(Duration.ofSeconds(<span class="hljs-number">2</span>)),<br>                    StreamOffset.create(queueName, ReadOffset.lastConsumed())<br>                );<br>                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span> || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// 没有读到消息，继续下一次循环</span><br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; values = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 创建订单</span><br>                handleVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// ack确认</span><br>                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;处理订单异常&quot;</span>, e);<br>                handlePendingList();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePendingList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 获取消息队列里的订单，如果队列为空则会阻塞住</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                    Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                    StreamReadOptions.empty().count(<span class="hljs-number">1</span>),<br>                    StreamOffset.create(queueName, ReadOffset.from(<span class="hljs-string">&quot;0&quot;</span>))<br>                );<br>                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span> || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// 没有读到消息，结束循环</span><br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; values = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(values, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 创建订单</span><br>                handleVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// ack确认</span><br>                stringRedisTemplate.opsForStream().acknowledge(queueName, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;处理订单异常&quot;</span>, e);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h4 id="点赞"><a href="#点赞" class="headerlink" title="点赞"></a>点赞</h4><blockquote><p>通过redis存哪些用户点赞了哪些文章，实现一篇文章一个用户只能点赞一次</p></blockquote><p>点赞时调用的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 获取登录用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 判断是否已经点赞，如果已点赞则取消点赞</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blog:liked:&quot;</span> + id;<br>    <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>    <span class="hljs-keyword">if</span> (score == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 增加点赞数</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>        <span class="hljs-comment">// 保存点赞信息到Redis的SortedSet中，用于之后可以获取点赞的顺序</span><br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 减少点赞数</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>        <span class="hljs-comment">// 保存取消点赞信息到Redis</span><br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            stringRedisTemplate.opsForZSet().remove(key, userId.toString());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><p>通过id查询文章时调用的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">Blog</span> <span class="hljs-variable">blog</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-keyword">if</span> (blog == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;博客不存在&quot;</span>);<br>    &#125;<br>    queryBlogUser(blog);<br>    <span class="hljs-comment">// 查询是否被当前用户点赞</span><br>    isBlogLiked(blog);<br><br>    <span class="hljs-keyword">return</span> Result.ok(blog);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isBlogLiked</span><span class="hljs-params">(Blog blog)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blog:liked:&quot;</span> + blog.getId();<br>    <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>    blog.setIsLike(score != <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>查询热门文章时调用的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryHotBlog</span><span class="hljs-params">(Integer current)</span> &#123;<br>    <span class="hljs-comment">// 根据用户查询</span><br>    Page&lt;Blog&gt; page = query()<br>        .orderByDesc(<span class="hljs-string">&quot;liked&quot;</span>)<br>        .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.MAX_PAGE_SIZE));<br>    <span class="hljs-comment">// 获取当前页数据</span><br>    List&lt;Blog&gt; records = page.getRecords();<br>    <span class="hljs-comment">// 查询用户</span><br>    records.forEach(blog -&gt; &#123;<br>        <span class="hljs-built_in">this</span>.queryBlogUser(blog);<br>        <span class="hljs-built_in">this</span>.isBlogLiked(blog);<br>    &#125;);<br><br>    <span class="hljs-keyword">return</span> Result.ok(records);<br>&#125;<br></code></pre></td></tr></table></figure><p>查询点赞顺序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查询redis文章前5个先点赞的用户id</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> RedisConstants.BLOG_LIKED_KEY + id;<br>    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (top5 == <span class="hljs-literal">null</span> || top5.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());<br>    <span class="hljs-comment">// 查询用户</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    List&lt;User&gt; users = userService.query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id, &quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>    List&lt;UserDTO&gt; userDTOS = users.stream().map(user -&gt;<br>                                                BeanUtil.copyProperties(user, UserDTO.class)<br>                                               ).collect(Collectors.toList());<br><br>    <span class="hljs-keyword">return</span> Result.ok(userDTOS);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="关注"><a href="#关注" class="headerlink" title="关注"></a>关注</h4><p>通过set集合的查看交集功能实现查找共同关注</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 关注时将关注的用户存到redis中</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, Boolean isFollow)</span> &#123;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 根据isFollow判断关注还是取关</span><br>    <span class="hljs-keyword">if</span> (isFollow) &#123;<br>        <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>        follow.setFollowUserId(followUserId);<br>        follow.setUserId(userId);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(follow);<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// 把关注目标存到redis</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>            stringRedisTemplate.opsForSet().add(key, followUserId.toString());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        LambdaQueryWrapper&lt;Follow&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();<br>        wrapper.eq(Follow::getFollowUserId, followUserId)<br>            .eq(Follow::getUserId, userId);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> remove(wrapper);<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// 把关注目标从redis移除</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">commonFollow</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 查找当前用户和目标用户的共同关注</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span>;<br>    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(Arrays.asList(key + userId, key + id));<br>    <span class="hljs-keyword">if</span> (intersect == <span class="hljs-literal">null</span> || intersect.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());<br>    <span class="hljs-comment">// 转换成UserDTO</span><br>    List&lt;UserDTO&gt; users = userService.listByIds(ids)<br>        .stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>        .collect(Collectors.toList());<br>    <span class="hljs-keyword">return</span> Result.ok(users);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h4><blockquote><p>推送也叫做Feed流，直译为投喂。为用户持续的提供“沉浸式”的体验，通过无限下拉刷新获取新的信息。</p></blockquote><p>Feed流有常见两种模式：</p><p><strong>Timeline</strong>：不做内容筛选，简单的按照内容发布时间排序，常用于好友或关注。例如朋友圈</p><ul><li>优点：信息全面，不会有缺失。并且实现也相对简单</li><li>缺点：信息噪音较多，用户不一定感兴趣，内容获取效率低</li></ul><p><strong>智能排序</strong>：利用智能算法屏蔽掉违规的、用户不感兴趣的内容。推送用户感兴趣信息来吸引用户</p><ul><li>优点：投喂用户感兴趣信息，用户粘度很高，容易沉迷</li><li>缺点：如果算法不精准，可能起到反作用</li></ul><p>Timeline模式的实现方案有三种：</p><ul><li><strong>拉模式</strong>：也叫做读扩散。被关注人发送消息后会保存到自己的邮箱，用户自己去拉取关注的人的收件箱里的消息<ul><li>优点：节约空间</li><li>缺点：比较延迟，要拉的消息多时对服务器有较大压力</li></ul></li><li><strong>推模式</strong>：也叫做写扩散。被关注人发送消息后会主动写到关注人的邮箱中<ul><li>优点：实效快</li><li>缺点：内存占用大</li></ul></li><li><strong>推拉结合</strong>：也叫做读写混合。对粉丝少的被关注人使用推模式；对于粉丝多的被关注人，对活跃粉丝使用推模式，对其他粉丝使用拉模式</li></ul><p><strong>实例</strong></p><blockquote><p>推模式，用sortedSet作为收件箱</p></blockquote><p>推给粉丝消息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(Blog blog)</span> &#123;<br>    <span class="hljs-comment">// 获取登录用户</span><br>    <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>    blog.setUserId(user.getId());<br>    <span class="hljs-comment">// 保存探店博文</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(blog);<br>    <span class="hljs-comment">// 推送给粉丝</span><br>    <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>        List&lt;Follow&gt; followUserIds = followService.query().eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, user.getId()).list();<br>        <span class="hljs-keyword">for</span> (Follow follow : followUserIds) &#123;<br>            <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> follow.getUserId();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;feed:&quot;</span> + userId;<br>            stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>&#125;<br></code></pre></td></tr></table></figure><p>粉丝查看消息</p><blockquote><p>通过滚动分页实现</p></blockquote><p><strong>滚动分页</strong>：从上一次查到的消息开始分页，避免有新消息插入导致又拿到上次已经拿到的消息</p><p><img src="/img/redis_img/gundongfenye.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(Long max, Integer offset)</span> &#123;<br>    <span class="hljs-comment">// 查询收件箱 ZREVRANGEBYSCORE key max min LIMIT offset count</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;feed:&quot;</span> + userId;<br>    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet().reverseRangeByScoreWithScores(<br>        key, <span class="hljs-number">0</span>, max, offset, <span class="hljs-number">2</span><br>    );<br>    <span class="hljs-keyword">if</span> (typedTuples == <span class="hljs-literal">null</span> || typedTuples.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br>    <span class="hljs-comment">// 获取数据(blogId, 最小时间戳，偏移量(查询出来的数据中score为最小时间戳的消息个数))</span><br>    List&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(typedTuples.size());<br>    <span class="hljs-type">long</span> <span class="hljs-variable">minTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 偏移量offset</span><br>    <span class="hljs-keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; typedTuple : typedTuples) &#123;<br>        ids.add(Long.valueOf(typedTuple.getValue()));<br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> typedTuple.getScore().longValue();<br>        os = time == minTime ? ++os : <span class="hljs-number">1</span>;<br>        minTime = time;<br>    &#125;<br>    <span class="hljs-comment">// 查询blog</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    List&lt;Blog&gt; blogs = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>    <span class="hljs-keyword">for</span> (Blog blog : blogs) &#123;<br>        queryBlogUser(blog);    <span class="hljs-comment">// 查询博客作者</span><br>        isBlogLiked(blog);  <span class="hljs-comment">// 查询是否被当前用户点赞</span><br>    &#125;<br>    <span class="hljs-comment">// 封装返回</span><br>    <span class="hljs-type">ScrollResult</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScrollResult</span>();<br>    r.setList(blogs);<br>    r.setOffset(os);<br>    r.setMinTime(minTime);<br><br>    <span class="hljs-keyword">return</span> Result.ok(r);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="附近"><a href="#附近" class="headerlink" title="附近"></a>附近</h4><p><strong>GEO数据类型</strong>：GEO就是Geolocation的简写形式，代表地理坐标。Redis在3.2版本中加入了对GEO的支持，允许存储地理坐标信息，帮助我们根据经纬度来检索数据，底层基于SortedSet</p><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>GEOADD</td><td>添加一个地理空间信息，包含：经度（longitude）、纬度（latitude）、值（member）</td></tr><tr><td>GEODIST</td><td>计算指定的两个点之间的距离并返回</td></tr><tr><td>GEOHASH</td><td>将指定member的坐标转为hash字符串形式并返回</td></tr><tr><td>GEOPOS</td><td>返回指定member的坐标</td></tr><tr><td>GEORADIUS</td><td>指定圆心、半径，找到该圆内包含的所有member，并按照与圆心之间的距离排序后返回。<strong>6.以后已废弃</strong></td></tr><tr><td>GEOSEARCH</td><td>在指定范围内搜索member，并按照与指定点之间的距离排序后返回。范围可以是圆形或矩形。6.2.新功能</td></tr><tr><td>GEOSEARCHSTORE</td><td>与GEOSEARCH功能一致，不过可以把结果存储到一个指定的key。 6.2.新功能</td></tr></tbody></table><p><strong>实例</strong></p><p>按分类导入店铺id和坐标到redis</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">loadShopData</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 查询店铺信息</span><br>    List&lt;Shop&gt; list = shopService.list();<br>    <span class="hljs-comment">// 按typeId分组</span><br>    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));<br>    <span class="hljs-comment">// 存到redis</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">typeId</span> <span class="hljs-operator">=</span> entry.getKey();<br>        List&lt;Shop&gt; value = entry.getValue();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;shop:geo:&quot;</span> + typeId;<br>        ArrayList&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (Shop shop : value) &#123;<br>            <span class="hljs-comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span><br>            locations.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(shop.getId().toString(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(shop.getX(), shop.getY())));<br>        &#125;<br>        stringRedisTemplate.opsForGeo().add(key, locations);    <span class="hljs-comment">// 一次存多个</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>查询附近店铺及距离，<strong>注意</strong>：redis版本要在6.2以上，否则使用不了GEOSEARCH指令</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;<br>    <span class="hljs-comment">// 判断是否需要根据坐标查询</span><br>    <span class="hljs-keyword">if</span> (x == <span class="hljs-literal">null</span> || y == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 根据类型分页查询</span><br>        Page&lt;Shop&gt; page = query()<br>            .eq(<span class="hljs-string">&quot;type_id&quot;</span>, typeId)<br>            .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));<br>        <span class="hljs-comment">// 返回数据</span><br>        <span class="hljs-keyword">return</span> Result.ok(page.getRecords());<br>    &#125;<br>    <span class="hljs-comment">// 计算分页参数</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (current - <span class="hljs-number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;<br>    <span class="hljs-comment">// 查询redis</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;shop:geo:&quot;</span> + typeId;<br>    GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo().search(<br>        key,    <span class="hljs-comment">// 店铺类型</span><br>        GeoReference.fromCoordinate(x, y),  <span class="hljs-comment">// 当前位置</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Distance</span>(<span class="hljs-number">5000</span>),  <span class="hljs-comment">// 半径</span><br>        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)  <span class="hljs-comment">// 带上距离、查询范围</span><br>    );<br>    <span class="hljs-keyword">if</span> (results == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    <span class="hljs-comment">// 搜集店铺id和距离</span><br>    List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();<br>    <span class="hljs-keyword">if</span> (list.size() &lt;= from) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList()); <br>    &#125;<br>    List&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(list.size());<br>    Map&lt;String, Distance&gt; distanceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(list.size());<br>    list.stream().skip(from).forEach(result -&gt; &#123;<br>        <span class="hljs-comment">// 店铺id和距离</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopIdStr</span> <span class="hljs-operator">=</span> result.getContent().getName();<br>        ids.add(Long.valueOf(shopIdStr));<br>        <span class="hljs-type">Distance</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> result.getDistance();<br>        distanceMap.put(shopIdStr, distance);<br>    &#125;);<br>    <span class="hljs-comment">// 根据店铺id查询shop</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    List&lt;Shop&gt; shops = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id, &quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>    <span class="hljs-keyword">for</span> (Shop shop : shops) &#123;<br>        shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(shops);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h4><p>通过二进制位上的0和1表示当天是否有签到</p><p>使用Redis的BitMap数据结构实现，BitMap基于String实现</p><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>SETBIT</td><td>向指定位置（offset）存入一个0或1</td></tr><tr><td>GETBIT</td><td>获取指定位置（offset）的bit值</td></tr><tr><td>BITCOUNT</td><td>统计BitMap中值为1的bit位的数量</td></tr><tr><td>BITFIELD</td><td>操作（查询、修改、自增）BitMap中bit数组中的指定位置（offset）的值</td></tr><tr><td>BITFIELD_RO</td><td>获取BitMap中bit数组，并以十进制形式返回</td></tr><tr><td>BITOP</td><td>将多个BitMap的结果做位运算（与 、或、异或）</td></tr><tr><td>BITPOS</td><td>查找bit数组中指定范围内第一个0或1出现的位置</td></tr></tbody></table><p><strong>实例</strong></p><p>签到</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 获取登录用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 获取日期及当天是本月的第几天</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>    <span class="hljs-comment">// 写入redis</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sign:&quot;</span> + userId + keySuffix;<br>    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);    <span class="hljs-comment">// true表示写入1</span><br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure><p>统计连续签到次数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 获取登录用户</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 获取日期及当天是本月的第几天</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>    <span class="hljs-comment">// 获取签到记录</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;sign:&quot;</span> + userId + keySuffix;<br>    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(<br>        key,<br>        BitFieldSubCommands.create().get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="hljs-number">0</span>)<br>    );<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">// 统计到今天为止的签到数</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> result.get(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span> || num == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> ((num &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">1</span>) &#123;<br>        count++;<br>        num = num &gt;&gt; <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(count);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="UV"><a href="#UV" class="headerlink" title="UV"></a>UV</h4><p>Unique Visitor(独立访客量)：一天同一个人访问网站记录一次</p><p>Page View（点击量）：访问一个页面就记录一次</p><p>Hyperloglog(HLL)：概率算法，用于确定非常大的集合的基数，对集合大小的测量有一定的误差</p><p>Redis中HLL是基于string结构实现的，内存占用很小</p><table><thead><tr><th>指令</th><th>说明</th></tr></thead><tbody><tr><td>PFADD key ele…</td><td>添加元素</td></tr><tr><td>PFCOUNT key</td><td>获取大小</td></tr></tbody></table><p>java中使用stringRedisTemplate.opsForHyperLogLog()来操作</p><h3 id="分布式缓存"><a href="#分布式缓存" class="headerlink" title="分布式缓存"></a>分布式缓存</h3><h4 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h4><h5 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h5><p>RDB全称Redis Database Backup file（Redis数据备份文件），备份时是替换整个rdb文件</p><ul><li><p><strong>什么时候会RDB持久化</strong>：</p><ol><li><p>执行save命令，会使用主进程持久化，在此期间其他命令都会阻塞</p></li><li><p>执行bgsave（异步持久化）命令</p></li><li><p>停机时自动save</p></li><li><p>触发RDB条件，执行bgsave(配置文件中设置)</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 900秒内，如果至少有1个key被修改，则执行bgsave ， 如果是save &quot;&quot; 则表示禁用RDB</span><br><span class="hljs-attr">save</span> <span class="hljs-string">900 1  </span><br><span class="hljs-attr">save</span> <span class="hljs-string">300 10  </span><br><span class="hljs-attr">save</span> <span class="hljs-string">60 10000 </span><br></code></pre></td></tr></table></figure></li></ol></li><li><p>相关配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 是否压缩 ,建议不开启，压缩也会消耗cpu，磁盘的话不值钱</span><br><span class="hljs-attr">rdbcompression</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># RDB文件名称</span><br><span class="hljs-attr">dbfilename</span> <span class="hljs-string">dump.rdb  </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 文件保存的路径目录</span><br><span class="hljs-attr">dir</span> <span class="hljs-string">./ </span><br></code></pre></td></tr></table></figure></li></ul><h5 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h5><p>AOF全称为Append Only File（追加文件），记录所有写命令到aof中</p><ul><li><p>开启aof</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 禁用rdb</span><br><span class="hljs-attr">save</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-comment"># 是否开启AOF功能，默认是no</span><br><span class="hljs-attr">appendonly</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"># AOF文件的名称</span><br><span class="hljs-attr">appendfilename</span> <span class="hljs-string">&quot;appendonly.aof&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>持久化频率</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 表示每执行一次写命令，立即记录到AOF文件</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">always </span><br><span class="hljs-comment"># 写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">everysec </span><br><span class="hljs-comment"># 写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">no</span><br></code></pre></td></tr></table></figure></li><li><p>重写命令，AOF文件执行重写功能，用最少的命令达到相同效果，以压缩文件大小。</p><p><code>BGREWRITEAOF</code></p></li><li><p>重写配置</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># AOF文件比上次文件 增长超过多少百分比则触发重写</span><br><span class="hljs-attr">auto-aof-rewrite-percentage</span> <span class="hljs-string">100</span><br><span class="hljs-comment"># AOF文件体积最小多大以上才触发重写 </span><br><span class="hljs-attr">auto-aof-rewrite-min-size</span> <span class="hljs-string">64mb </span><br></code></pre></td></tr></table></figure></li></ul><h3 id="分布式锁-1"><a href="#分布式锁-1" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>​在单体项目下保证原子性可以使用synchronized，在分布式下就无法使用。</p><p>​可以使用mysql、redis等来实现多线程下的锁。基本原理是根据id的唯一性来控制不同机器中的进程对资源的访问</p><p><strong>实现方式1</strong></p><blockquote><p><code>setnx</code>命令：当不存在时才设置值</p><p><code>expire</code>命令：设置超时时间</p></blockquote><p>获取锁时：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">setnx <span class="hljs-keyword">lock</span> 表示当前进程的唯一值<br>expire <span class="hljs-keyword">lock</span> <span class="hljs-number">5</span><span class="hljs-meta"># 添加超时时间</span><br></code></pre></td></tr></table></figure><p>释放锁时：</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">del <span class="hljs-keyword">lock</span><br></code></pre></td></tr></table></figure><p><strong>缺陷</strong>：</p><p>当一个jvm的线程获取锁后、设置超时时间前挂了，就会导致死锁</p><p><strong>实现方式2</strong></p><blockquote><p>使用<code>set key value ex timeout nx OK</code>来让set和expire命令是一个原子操作</p><p>或者也可以使用lua脚本实现</p></blockquote><p>获取锁时：</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos"><span class="hljs-keyword">set</span> <span class="hljs-keyword">lock</span> 表示当前进程的唯一值 EX <span class="hljs-number">4</span> NX ...<br></code></pre></td></tr></table></figure><p>释放锁时：</p><p>如果释放锁前判断锁是自己的锁，但判断完锁超时了，此时就有可能会释放掉别人的锁，需要通过lua脚本使判断锁和释放锁是原子操作</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 示例</span><br><span class="hljs-keyword">local</span> key = KEYS[<span class="hljs-number">1</span>]<br><span class="hljs-keyword">local</span> requestId = KEYS[<span class="hljs-number">2</span>]<br><span class="hljs-keyword">local</span> value = redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, key)<br><span class="hljs-keyword">if</span> value == requestId <span class="hljs-keyword">then</span><span class="hljs-comment">-- 判断是不是自己的锁</span><br>    redis.call(<span class="hljs-string">&#x27;del&#x27;</span>, key);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">end</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">-1</span><br></code></pre></td></tr></table></figure><p>缺陷：</p><p>自己实现太麻烦了</p><p><strong>实现方式3</strong></p><blockquote><p>通过Redisson实现，Redisson帮忙实现了分布式锁</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissonClient redissonClient;<br><br><span class="hljs-type">RLock</span> <span class="hljs-variable">rLock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockName);<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> rLock.tryLock(expireTime, TimeUnit.MILLISECONDS);<br>    <span class="hljs-keyword">if</span> (isLocked) &#123;<br>        <span class="hljs-comment">// TODO</span><br>                &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            rLock.unlock();<br>    &#125;<br>...<br></code></pre></td></tr></table></figure><h3 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h3><p>windows下案例：配置两台redis，一主一从</p><ol><li><p>创建两个文件夹<code>6379</code>、<code>6380</code>，将配置文件<code>redis.windows.conf</code>各复制到文件夹中一份</p></li><li><p>各创建<code>data</code>文件夹用于存放数据文件</p></li><li><p><code>6379</code>（主服务器）中要改的配置</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs conf"># 端口<br>port 6379<br><br># 数据保存的文件夹<br>dir E:\redis\6379\data<br><br># 密码<br>requirepass 123456<br></code></pre></td></tr></table></figure></li><li><p><code>6380</code>（从服务器）中要改的配置</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs conf"># 端口<br>port 6380<br><br># 数据保存的文件夹<br>dir E:\redis\6380\data<br><br># 主服务器密码<br>masterauth 123456<br><br># 从属于哪台服务器<br>replicaof 127.0.0.1 6379<br></code></pre></td></tr></table></figure></li><li><p><code>redis-server.exe 配置文件路径</code>启动两台redis</p></li><li><p>springboot中配置类</p> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * redis序列化器配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisConnectionFactory <span class="hljs-title function_">redisConnectionFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">LettuceClientConfiguration</span> <span class="hljs-variable">clientConfiguration</span> <span class="hljs-operator">=</span> LettuceClientConfiguration.builder()<br>                .readFrom(ReadFrom.REPLICA)     <span class="hljs-comment">// 读操作都找从节点</span><br>                .build();<br><br>        <span class="hljs-type">RedisStaticMasterReplicaConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisStaticMasterReplicaConfiguration</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>);<br>        configuration.addNode(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6380</span>);<br>        configuration.setPassword(<span class="hljs-string">&quot;123456&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LettuceConnectionFactory</span>(configuration, clientConfiguration);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> &#123;<br>        <span class="hljs-comment">// 创建RedisTemplate对象</span><br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        <span class="hljs-comment">// 设置连接工厂</span><br>        template.setConnectionFactory(connectionFactory);<br>        <span class="hljs-comment">// 创建JSON序列化工具</span><br>        <span class="hljs-type">GenericJackson2JsonRedisSerializer</span> <span class="hljs-variable">jsonRedisSerializer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();<br>        <span class="hljs-comment">// 创建key序列化工具</span><br>        template.setKeySerializer(RedisSerializer.string());<br>        template.setHashKeySerializer(RedisSerializer.string());<br>        <span class="hljs-comment">// 创建value序列化工具</span><br>        template.setValueSerializer(jsonRedisSerializer);<br>        template.setHashValueSerializer(jsonRedisSerializer);<br><br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>中间件</category>
      
      <category>redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>中间件</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux部署java项目</title>
    <link href="/2022/08/14/linux/linux%E9%83%A8%E7%BD%B2java%E9%A1%B9%E7%9B%AE/"/>
    <url>/2022/08/14/linux/linux%E9%83%A8%E7%BD%B2java%E9%A1%B9%E7%9B%AE/</url>
    
    <content type="html"><![CDATA[<h2 id="linux部署java项目"><a href="#linux部署java项目" class="headerlink" title="linux部署java项目"></a>linux部署java项目</h2><h4 id="手工部署"><a href="#手工部署" class="headerlink" title="手工部署"></a>手工部署</h4><p>项目在后台运行</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">nohup Command <span class="hljs-selector-attr">[Arg...]</span><span class="hljs-selector-attr">[&amp;]</span><br></code></pre></td></tr></table></figure><p>说明:</p><p>​<strong>nohup</strong>: no hang up不挂起，退出终端也不会影响程序运行</p><p>​<strong>Command</strong>: 要执行的指令</p><p>​<strong>Arg</strong>: 参数</p><p>​<strong>&amp;</strong>: 让命令在后台运行</p><p>例子:</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">运行jar包并把控制台的信息输出到<span class="hljs-keyword">log</span>.<span class="hljs-keyword">log</span>文件中<br>nohup java -jar reggieTakeOut<span class="hljs-number">-1.0</span>-<span class="hljs-keyword">SNAPSHOT</span>.jar &amp;&gt; <span class="hljs-keyword">log</span>.<span class="hljs-keyword">log</span> &amp;<br></code></pre></td></tr></table></figure><p>关闭项目</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs perl">查找进程<br>ps -ef | <span class="hljs-keyword">grep</span> java<br>杀进程<br><span class="hljs-keyword">kill</span> -<span class="hljs-number">9</span> 进程号<br></code></pre></td></tr></table></figure><h4 id="通过Shell脚本部署"><a href="#通过Shell脚本部署" class="headerlink" title="通过Shell脚本部署"></a>通过Shell脚本部署</h4><ol><li><p>不是root管理员的话可能要授予权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 八进制表示的权限 文件名<br></code></pre></td></tr></table></figure></li><li><p>执行.sh脚本文件</p></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>类图和用例图考点</title>
    <link href="/2022/08/13/%E8%BD%AF%E8%80%83/%E7%B1%BB%E5%9B%BE%E5%92%8C%E7%94%A8%E4%BE%8B%E5%9B%BE%E8%80%83%E7%82%B9/"/>
    <url>/2022/08/13/%E8%BD%AF%E8%80%83/%E7%B1%BB%E5%9B%BE%E5%92%8C%E7%94%A8%E4%BE%8B%E5%9B%BE%E8%80%83%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="类图和用例图考点"><a href="#类图和用例图考点" class="headerlink" title="类图和用例图考点"></a>类图和用例图考点</h2><h4 id="1-类间关系"><a href="#1-类间关系" class="headerlink" title="1.类间关系"></a>1.类间关系</h4><p><strong>依赖</strong><img src="/img/post_img/1.png"></p><p>也就是使用，只要在类中用到了对方，就叫做依赖。类的成员属性、方法的返回类型、方法接收的参数类型、在方法中用到，都是依赖。<br>类A的方法中仅仅使用了类B的对象，那么类A依赖于类B。</p><p><strong>关联</strong><img src="/img/post_img/2.png"></p><p>类与类之间的关系<br>关联具有多重性：一对一关系、一对多关系、多对多关系</p><p><strong>聚合</strong><img src="/img/post_img/3.png"><br>类A中有一个成员变量类B</p><p><strong>组合</strong><img src="/img/post_img/4.png"><br>也就是类A中有类B的对象，且通过new B()的方式创建</p><p><strong>泛化（继承）</strong><img src="/img/post_img/5.png"></p><p>也就是继承</p><p><strong>实现</strong><img src="/img/post_img/6.png"></p><p>如接口的实现</p><h4 id="2-用例间关系"><a href="#2-用例间关系" class="headerlink" title="2.用例间关系"></a>2.用例间关系</h4><p><strong>包含关系(include) :</strong></p><p>基用例中使用了被包含用例，没有被包含用例的基用例是不完整的；</p><p>使用带箭头的虚线表示，在线上标注<code>&lt;&lt;include&gt;&gt;</code>，箭头从基用例指向被包含用例;</p><p><img src="/img/post_img/20161103115539825.png"></p><p><strong>扩展关系(extend)：</strong></p><p>对基用例行为的扩展，即使没有扩展用例，基用例也是完整的；</p><p>使用带箭头的虚线表示，在线上标注<code>&lt;&lt;extend&gt;&gt;</code>，箭头从扩展用例指向基用例;</p><p><img src="/img/post_img/20161103115623076.png"></p><p><strong>泛化(generlize):</strong></p><p>一个父用例可以被特化形成多个子用例，类似于实现接口；</p><p>使用实现空心箭头表示，箭头从子用例指向基用例；</p><p><img src="/img/post_img/20161103115643014.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>软考</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux软件安装</title>
    <link href="/2022/08/13/linux/linux%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/"/>
    <url>/2022/08/13/linux/linux%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h2 id="linux软件安装"><a href="#linux软件安装" class="headerlink" title="linux软件安装"></a>linux软件安装</h2><h4 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h4><p>​<strong>查看状态</strong></p><p>​systemctl status firewalld.service</p><p>​<strong>打开防火墙</strong></p><p>​systemctl start firewalld.service</p><p>​<strong>关闭防火墙</strong></p><p>​systemctl stop firewalld.service</p><p>​<strong>开启防火墙</strong></p><p>​systemctl enable firewalld.service</p><p>​<strong>禁用防火墙</strong></p><p>​systemctl disable firewalld.service</p><p>​<strong>重启防火墙</strong></p><p>​systemctl restart firewalld</p><p>​<strong>开放单个端口</strong></p><p>​firewall-cmd –zone&#x3D;public –add-port&#x3D;端口号&#x2F;tcp –permanent</p><p>​重启防火墙后生效</p><p>​<strong>关闭单个端口</strong></p><p>​firewall-cmd –zone&#x3D;public –remove-port&#x3D;端口号&#x2F;tcp –permanent</p><p>​重启防火墙后生</p><h4 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h4><ol><li><p>进入网卡配置目录</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/etc/</span>sysconfig<span class="hljs-regexp">/network-scripts/</span><br></code></pre></td></tr></table></figure></li><li><p>编辑网卡配置文件</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs routeros">vim ifcfg-ens33<br><br>修改网卡IP<br><span class="hljs-attribute">TYPE</span>=Ethernet#设置网卡类型，“Ethernet”表示以太网<br><span class="hljs-attribute">DEVICE</span>=ens33#设置网卡的名称<br><span class="hljs-attribute">ONBOOT</span>=<span class="hljs-literal">yes</span>#设置网卡是否在 Linux 操作系统启动时激活<br><span class="hljs-attribute">BOOTPROTO</span>=static#设置网卡的配置方式，“static”表示使用静态IP地址，“dhcp”时表示动态获取地址<br><span class="hljs-attribute">IPADDR</span>=192.168.80.3#设置网卡的<span class="hljs-built_in"> IP </span>地址<br><span class="hljs-attribute">NETMASK</span>=255.255.255.0#设置网卡的子网掩码<br><span class="hljs-attribute">GATEWAY</span>=192.168.80.2#设置网卡的默认网关地址<br><span class="hljs-attribute">DNS1</span>=192.168.80.2#设置DNS服务器的<span class="hljs-built_in"> IP </span>地址<br><br>重载网卡<br>nmcli<span class="hljs-built_in"> connection </span>reload<br></code></pre></td></tr></table></figure></li></ol><h4 id="jdk"><a href="#jdk" class="headerlink" title="jdk"></a>jdk</h4><ol><li><p>下载jdk    <a href="https://www.oracle.com/java/technologies/javase/javase8u211-later-archive-downloads.html">官网下载</a></p></li><li><p>上传jdk的二进制发布包(tar.gz)</p></li><li><p>解压安装包 </p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">tar</span> <span class="hljs-operator">-</span><span class="hljs-variable">zxvf</span> 压缩包名 <span class="hljs-operator">-</span><span class="hljs-built_in">C</span> 解压到的路径<br></code></pre></td></tr></table></figure></li><li><p>配置环境变量 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/profile<br><br>添加到文件末尾<br><span class="hljs-built_in">export</span> JAVA_HOME=/usr/java/jdk1.8.0_333-amd64<br><span class="hljs-built_in">export</span> <br>CLASSPATH=<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib <br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br><br>使环境变量立即生效<br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure></li><li><p>查看jdk是否安装成功 </p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">java -<span class="hljs-built_in">version</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="tomcat"><a href="#tomcat" class="headerlink" title="tomcat"></a>tomcat</h4><ol><li><p>下载tomcat     <a href="https://mirrors.huaweicloud.com/apache/tomcat/tomcat-8/v8.5.81/bin/">镜像</a></p></li><li><p>解压</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> -zxvf apache-tomcat-<span class="hljs-number">8</span>.<span class="hljs-number">5</span>.<span class="hljs-number">81</span>.tar.gz <br></code></pre></td></tr></table></figure></li><li><p>运行bin目录下的startup.sh文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./startup.sh<br></code></pre></td></tr></table></figure></li><li><p>查看是否启动</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">查看进程<br><span class="hljs-keyword">ps</span> -ef | <span class="hljs-keyword">grep</span> tomcat<br></code></pre></td></tr></table></figure></li></ol><h4 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h4><p>​碰到错误：为仓库 ‘appstream’ 下载元数据失败 : Cannot prepare internal mirrorlist: No URLs in mirrorlist时解决办法: <a href="https://blog.csdn.net/wykqh/article/details/123004620">CentOS Linux 8 - AppStream 错误</a></p><ol><li><p>安装<a href="https://dev.mysql.com/downloads/repo/yum/">MySQL Yum存储库</a></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rpm</span> -ivh mysql80-community-release-el8-<span class="hljs-number">4</span>.noarch.rpm<br></code></pre></td></tr></table></figure></li><li><p>禁用默认 MySQL 模块</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">yum module <span class="hljs-built_in">disable</span> mysql<br></code></pre></td></tr></table></figure></li><li><p>安装 MySQL</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">yum install mysql-community-<span class="hljs-keyword">server</span><br></code></pre></td></tr></table></figure></li><li><p>启动 MySQL 服务</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nsis">查看mysql服务状态<br><span class="hljs-params">system</span>ctl status mysqld<br>启动 MySQL 服务<br><span class="hljs-params">system</span>ctl start mysqld<br>开机自动启动mysql服务<br><span class="hljs-params">system</span>ctl enable mysqld<br></code></pre></td></tr></table></figure></li><li><p>查看是否启动</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">查看mysql进程<br><span class="hljs-keyword">ps</span> -ef | <span class="hljs-keyword">grep</span> mysql<br>查看已启动的服务<br>netstat -tunpl<br></code></pre></td></tr></table></figure></li><li><p>登录mysql</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">查看临时密码<br>cat /var/<span class="hljs-keyword">log</span>/mysqld.<span class="hljs-keyword">log</span> | grep <span class="hljs-keyword">password</span><br>通过临时密码登录<br>先设置一个符合要求的密码<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;MyNewPwd1!&#x27;</span>;<br>修改密码最低位数和安全等级(MySQL <span class="hljs-number">8.0</span>以上)<br><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> validate_password.length=<span class="hljs-number">1</span>;<br><span class="hljs-keyword">set</span> <span class="hljs-keyword">global</span> validate_password.<span class="hljs-keyword">policy</span>=<span class="hljs-number">0</span>;<br>然后可以再设置一个简单的密码<br></code></pre></td></tr></table></figure></li><li><p>开启远程连接</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">use mysql; <br><span class="hljs-keyword">update</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">set</span> host = <span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">where</span> <span class="hljs-keyword">user</span> =<span class="hljs-string">&#x27;root&#x27;</span>;<br><br>(mysql8<span class="hljs-number">.0</span>以上, 远程连接时出现<span class="hljs-number">2058</span>错误)<br><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED <span class="hljs-keyword">WITH</span> mysql_native_password <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;远程登录密码&#x27;</span>;<br><br>刷新配置<br>flush <span class="hljs-keyword">privileges</span>;<br></code></pre></td></tr></table></figure></li></ol><h4 id="lrzsz"><a href="#lrzsz" class="headerlink" title="lrzsz"></a>lrzsz</h4><p>lrzsz是一款在linux里可代替ftp上传和下载的程序</p><ol><li><p>搜索lrzsz安装包</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">yum list lrzsz</span><br></code></pre></td></tr></table></figure></li><li><p>在线安装</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> lrzsz.x86_64<br></code></pre></td></tr></table></figure></li><li><p>打开文件上传界面</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">rz</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="git"><a href="#git" class="headerlink" title="git"></a>git</h4><ol><li><p>搜索git安装包</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">yum list git</span><br></code></pre></td></tr></table></figure></li><li><p>在线安装</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> git<br></code></pre></td></tr></table></figure></li></ol><h4 id="maven"><a href="#maven" class="headerlink" title="maven"></a>maven</h4><ol><li><p><a href="https://archive.apache.org/dist/maven/maven-3/">官网下载</a></p></li><li><p>解压</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">tar</span> -zxvf 压缩包名<br></code></pre></td></tr></table></figure></li><li><p>配置环境变量</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/etc/</span>profile<br>export MAVEN_HOME=<span class="hljs-regexp">/home/</span>cyx<span class="hljs-regexp">/maven/</span>apache-maven-<span class="hljs-number">3.6</span>.<span class="hljs-number">3</span><br>export PATH=<span class="hljs-variable">$JAVA_HOME</span><span class="hljs-regexp">/bin:$MAVEN_HOME/</span>bin:<span class="hljs-variable">$PATH</span><br><br>使配置文件立即生效<br>source <span class="hljs-regexp">/etc/</span>profile<br>查看maven版本<br>mvn -version<br></code></pre></td></tr></table></figure></li><li><p>修改maven配置文件</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">vim /conf/settings.<span class="hljs-keyword">xml</span><br><span class="hljs-title">设置本地仓库</span><br><span class="hljs-title">&lt;localRepository</span>&gt;仓库路径<span class="hljs-tag">&lt;/localRepository&gt;</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h4><ol><li><p><a href="https://download.redis.io/releases/">官网下载</a></p></li><li><p>上传解压</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">-tar -zxvf 压缩包名<br></code></pre></td></tr></table></figure></li><li><p>安装依赖环境gcc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">yum install gcc-c++<br></code></pre></td></tr></table></figure></li><li><p>编译安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs linux">到redis目录下<br>make<br>到redis/src目录下<br>make install<br></code></pre></td></tr></table></figure></li><li><p>修改redis.conf文件中的一些配置：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 绑定地址，默认是127.0.0.1，会导致只能在本地访问。修改为0.0.0.0则可以在任意IP访问</span><br><span class="hljs-built_in">bind</span> 0.0.0.0<br><span class="hljs-comment"># 数据库数量，设置为1</span><br>databases 1<br></code></pre></td></tr></table></figure></li><li><p>启动Redis：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-server redis.conf<br></code></pre></td></tr></table></figure><p>停止redis服务：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">redis-cli shutdown<br></code></pre></td></tr></table></figure></li></ol><h4 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h4><ol><li><p>安装python-pip</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs linux">yum -y install epel-release<br>dnf install -y python3<br>dnf install python3-paramiko<br></code></pre></td></tr></table></figure></li><li><p>安装docker-compose</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">pip3 install docker-compose<br></code></pre></td></tr></table></figure></li><li><p>查看版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">docker-compose --version<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数据流图考点</title>
    <link href="/2022/08/12/%E8%BD%AF%E8%80%83/%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE%E8%80%83%E7%82%B9/"/>
    <url>/2022/08/12/%E8%BD%AF%E8%80%83/%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE%E8%80%83%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h2 id="数据流图考点"><a href="#数据流图考点" class="headerlink" title="数据流图考点"></a>数据流图考点</h2><h4 id="1-黑洞，白洞，灰洞"><a href="#1-黑洞，白洞，灰洞" class="headerlink" title="1.黑洞，白洞，灰洞"></a>1.黑洞，白洞，灰洞</h4><p><strong>数据平衡原则</strong>: </p><p>加工的输入数据流和输出数据流要平衡，即保证加工的输出数据流都有其对应的输入数据流与输出数据流。父图和子图之间的数据流必须保持一致，如果上层数据流底部某加工的一个输入（输出）数据流对应于下层数据流图中若干个输入（输出）数据流，而且下层数据流中这些数据流的成分之和正好等于上层数据流底部的这个数据流，那么，它仍算是平衡的。</p><p><strong>分解时三种常见错误</strong>:</p><p>黑洞: 只有输入数据流,没有输出数据流的数据加工</p><p>奇迹: 只有输出数据流,没有输入数据流的数据加工</p><p>灰洞: 输入数据流无法通过加工产生输出流</p><h4 id="2-找缺失的数据流"><a href="#2-找缺失的数据流" class="headerlink" title="2.找缺失的数据流"></a>2.找缺失的数据流</h4><p>三步：</p><ol><li>从父图中找子图是否有缺失的数据流</li><li>找是否有加工缺少输入或输出</li><li>从题的说明中找加工的数据流</li></ol><p>数据流至少有一头为加工</p><h4 id="3-结构化语言描述加工逻辑"><a href="#3-结构化语言描述加工逻辑" class="headerlink" title="3.结构化语言描述加工逻辑"></a>3.结构化语言描述加工逻辑</h4><ul><li><p>选择语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs 选择语句">IF 条件 THEN<br>    分支内容<br>ELSE IF 条件 THEN<br>    分支内容<br>ELSE<br>    分支内容<br>ENDIF<br></code></pre></td></tr></table></figure></li><li><p>循环语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs 循环语句">WHILE 条件<br>DO<br>&#123;<br>    IF 条件 THEN<br>        内容<br>    ENDIF<br>&#125;<br>ENDDO<br></code></pre></td></tr></table></figure></li></ul><h4 id="4-父图和子图如何保持数据流图平衡"><a href="#4-父图和子图如何保持数据流图平衡" class="headerlink" title="4.父图和子图如何保持数据流图平衡"></a>4.父图和子图如何保持数据流图平衡</h4><p>父图中某加工的输入输出数据流必须与其子图的输入输出数据流在数量和名字上相同，或者父图中的一个输入（或输出）数据流应对应于子图中几个输入（或输出）数据流并集，而子图中组成这些数据流的数据项正好是父图中的这一个数据流</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>软考</category>
      
    </categories>
    
    
    <tags>
      
      <tag>软考</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux常用命令</title>
    <link href="/2022/08/12/linux/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2022/08/12/linux/linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="linux常用命令"><a href="#linux常用命令" class="headerlink" title="linux常用命令"></a>linux常用命令</h2><h4 id="目录操作"><a href="#目录操作" class="headerlink" title="目录操作"></a>目录操作</h4><table><thead><tr><th align="left"></th><th>命令</th><th>对应单词</th><th>作用</th></tr></thead><tbody><tr><td align="left">1</td><td>ls [-a所有-l详细]</td><td>list</td><td>查看当前目录内容</td></tr><tr><td align="left">2</td><td>pwd</td><td>print work directory</td><td>查看当前所在目录</td></tr><tr><td align="left">3</td><td>cd 目录名</td><td>change directory</td><td>切换目录</td></tr><tr><td align="left">4</td><td>mkdir  目录名</td><td>make directory</td><td>创建目录</td></tr><tr><td align="left">5</td><td>rmdir [-p嵌套删除] 目录名</td><td>remove directory</td><td>删除空目录</td></tr><tr><td align="left">6</td><td>rm [-r所有-f无需确认]目录名</td><td>remove</td><td>可以删除非空目录</td></tr><tr><td align="left">7</td><td>cp [-r拷贝目录] 源目录 目标目录</td><td>copy</td><td>拷贝目录</td></tr><tr><td align="left">8</td><td>mv 源目录 目标目录&#x2F;[新目录名]&#x2F;</td><td>move</td><td>移动目录</td></tr></tbody></table><h4 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h4><table><thead><tr><th></th><th>命令</th><th>对应单词</th><th>作用</th></tr></thead><tbody><tr><td>1</td><td>touch 文件名</td><td>touch</td><td>若文件不存在则创建目录</td></tr><tr><td>2</td><td>rm 文件名</td><td>remove</td><td>删除文件</td></tr><tr><td>3</td><td>cat [-n显示行数] 文件名</td><td></td><td>显示文件所有内容</td></tr><tr><td>4</td><td>more 文件名</td><td></td><td>分页显示文件内容(回车下一行,空格下一屏,b上一屏,q退出)</td></tr><tr><td>5</td><td>tail [-f动态显示] 文件名</td><td></td><td>读取文件末尾内容</td></tr><tr><td>6</td><td>cp 源文件 目标目录</td><td>copy</td><td>拷贝文件</td></tr><tr><td>7</td><td>mv 源文件 目标目录&#x2F;[新文件名]</td><td>move</td><td>移动文件</td></tr></tbody></table><h4 id="压缩打包-x2F-解压"><a href="#压缩打包-x2F-解压" class="headerlink" title="压缩打包&#x2F;解压"></a>压缩打包&#x2F;解压</h4><p>tar [-zcxvf] 压缩包名 打包的文件</p><table><thead><tr><th>选项</th><th>含义</th></tr></thead><tbody><tr><td>-c</td><td>将多个文件或目录进行打包。</td></tr><tr><td>-z</td><td>通过gzip来压缩&#x2F;解压</td></tr><tr><td>-f 包名</td><td>指定包的文件名。包的扩展名是用来给管理员识别格式的，所以一定要正确指定扩展名；</td></tr><tr><td>-v</td><td>显示打包文件过程；</td></tr><tr><td>-x</td><td>解压缩</td></tr></tbody></table><h4 id="文本编辑"><a href="#文本编辑" class="headerlink" title="文本编辑"></a>文本编辑</h4><p>vi&#x2F;vim 文件名</p><h4 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h4><table><thead><tr><th>语法</th><th>作用</th></tr></thead><tbody><tr><td>find 目录名 -name 文件名</td><td>通过文件名来模糊查找文件</td></tr><tr><td>grep 单词 文件名</td><td>从文件中查找文本内容</td></tr></tbody></table><h4 id="选项对应的单词"><a href="#选项对应的单词" class="headerlink" title="选项对应的单词"></a>选项对应的单词</h4><p>-a<br>all : 全部，所有 (ls , lsattr , uname)<br>archive : 存档 (cp , rsync)<br>append : 附加 (tar -A , 7z)</p><p>-c<br>commands : 执行命令，带参数 (bash , ksh , python)<br>create : 创建 (tar)</p><p>-f<br>force : 强制，不经确认(cp , rm ,mv)<br>file : 文件，带参数 (tar)</p><p>-h<br>–help : 帮助<br>human readable : 人性化显示(ls , du , df)<br>headers : 头部</p><p>-i<br>interactive : 交互模式，提示(rm , mv)<br>include : 包含</p><p>-k<br>keep : 保留</p><p>-l<br>long listing format : 长格式(ls)<br>list : 列表<br>load : 读取 (gcc , emacs)</p><p>-m<br>message : 消息 (cvs)<br>manual : 手册 (whereis)<br>create home : 创建 home 目录 (usermod , useradd)</p><p>-n<br>number : 行号、编号 (cat , head , tail , pstree , lspci)<br>no : (useradd , make)</p><p>-p<br>parents 需要时创建上层目录，如目录早已存在则不当作错误</p><p>-q<br>quiet : 静默</p><p>-r<br>reverse : 反转<br>recursive : 递归 (cp , rm , chmod -R)</p><p>-u<br>user : 用户名、UID，带参数</p><p>-v<br>verbose : 冗长<br>version : 版本</p><p>-x<br>exclude : 排除 (tar , zip)</p><p>-y<br>yes</p><p>-z<br>zip : 启用压缩 (bzip , tar , zcat , zip , cvs)</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>linux</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>git常用命令</title>
    <link href="/2022/08/10/git/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2022/08/10/git/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="git常用命令"><a href="#git常用命令" class="headerlink" title="git常用命令"></a>git常用命令</h2><h4 id="本地仓库操作"><a href="#本地仓库操作" class="headerlink" title="本地仓库操作"></a>本地仓库操作</h4><p>设置用户信息</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.name</span> <span class="hljs-string">&quot;用户名&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.email</span> <span class="hljs-string">&quot;邮箱&quot;</span><br></code></pre></td></tr></table></figure><p>查看配置信息</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">git <span class="hljs-built_in">config</span> <span class="hljs-comment">--list</span><br></code></pre></td></tr></table></figure><p>创建git本地仓库</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">git <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure><p>获取git远程仓库</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">clone</span> <span class="hljs-title">仓库地址</span><br></code></pre></td></tr></table></figure><p>将文件存入暂存区</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">git <span class="hljs-built_in">add</span> *或者文件名<br></code></pre></td></tr></table></figure><p>将文件取消暂存 &#x2F; 切换版本</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git <span class="hljs-built_in">reset</span> *或者文件名<br></code></pre></td></tr></table></figure><p>查看文件状态</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git status</span> <br></code></pre></td></tr></table></figure><p>提交到版本库</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">git</span> commit -m <span class="hljs-string">&quot;备注&quot;</span><br></code></pre></td></tr></table></figure><p>查看日志</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">git <span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><h4 id="远程仓库操作"><a href="#远程仓库操作" class="headerlink" title="远程仓库操作"></a>远程仓库操作</h4><p>查看远程仓库</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git remote -v</span><br></code></pre></td></tr></table></figure><p>添加远程仓库</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">git remote <span class="hljs-keyword">add </span><span class="hljs-keyword">origin </span>仓库地址<br></code></pre></td></tr></table></figure><p>拉取远程仓库</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git pull <span class="hljs-built_in">origin</span> 远程分支名<br></code></pre></td></tr></table></figure><p>推送到远程仓库</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git <span class="hljs-built_in">push</span> <span class="hljs-built_in">origin</span> 远程分支名<br></code></pre></td></tr></table></figure><h4 id="分支操作"><a href="#分支操作" class="headerlink" title="分支操作"></a>分支操作</h4><p>查看分支</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git branch</span><br></code></pre></td></tr></table></figure><p>创建分支</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">git <span class="hljs-keyword">branch </span>分支名<br></code></pre></td></tr></table></figure><p>切换分支</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">git</span> checkout 分支名<br></code></pre></td></tr></table></figure><p>推送到远程仓库</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git <span class="hljs-built_in">push</span> <span class="hljs-built_in">origin</span> 分支名<br></code></pre></td></tr></table></figure><p>合并分支</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">git <span class="hljs-keyword">merge</span> 分支名<br></code></pre></td></tr></table></figure><h4 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h4><p>列出已有的标签</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">tag</span><br></code></pre></td></tr></table></figure><p>创建标签</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">tag</span> <span class="hljs-title">标签名</span><br></code></pre></td></tr></table></figure><p>将标签推送至远程仓库</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git <span class="hljs-built_in">push</span> <span class="hljs-built_in">origin</span> 标签名<br></code></pre></td></tr></table></figure><p>取出创建这个标签时的代码</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">git</span> checkout -<span class="hljs-keyword">b</span> 新的分支名 标签名<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>在SpringBoot中使用过滤器</title>
    <link href="/2022/08/09/spring/springboot/%E5%9C%A8SpringBoot%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
    <url>/2022/08/09/spring/springboot/%E5%9C%A8SpringBoot%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="在SpringBoot中使用过滤器"><a href="#在SpringBoot中使用过滤器" class="headerlink" title="在SpringBoot中使用过滤器"></a>在SpringBoot中使用过滤器</h2><h4 id="1-实现Filter接口"><a href="#1-实现Filter接口" class="headerlink" title="1.实现Filter接口"></a>1.实现<code>Filter</code>接口</h4><p>可以重写Filter中的三个方法</p><table><thead><tr><th>name</th><th>说明</th></tr></thead><tbody><tr><td>init(FilterConfig)</td><td>创建filter时会调用一次</td></tr><tr><td>doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</td><td>拦截客户端请求时调用</td></tr><tr><td>destroy()</td><td>销毁filter时会调用一次</td></tr></tbody></table><h4 id="2-注册拦截器"><a href="#2-注册拦截器" class="headerlink" title="2.注册拦截器"></a>2.注册拦截器</h4><p>方式1: 注解注册</p><p>通过<code>@WebFilter(filterName, urlPatterns)</code>注解来说明这是一个过滤器</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>filterName</td><td>过滤器名字</td></tr><tr><td>urlPatterns</td><td>拦截的路径</td></tr></tbody></table><p>然后在主启动类上使用<code>@ServletComponentScan</code>注解开启扫描</p><p>加上这个注解可以扫描<code>@Servlet</code>、<code>@Filter</code>、<code>@Listener</code></p><p>方式2: 配置类方式注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterConfig</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Filter1 filter;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title function_">filter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//通过FilterRegistrationBean注入Bean</span><br>        <span class="hljs-type">FilterRegistrationBean</span> <span class="hljs-variable">registration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterRegistrationBean</span>();<br>        <span class="hljs-comment">//设置过滤器</span><br>        registration.setFilter(filter);<br>        <span class="hljs-comment">//设置过滤器名和拦截路径</span><br>        registration.setName(<span class="hljs-string">&quot;filter&quot;</span>);<br>        registration.addUrlPatterns(<span class="hljs-string">&quot;/*&quot;</span>);<br>        <span class="hljs-comment">//设置优先级别</span><br>        registration.setOrder(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">return</span> registration;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebFilter(filterName = &quot;loginCheckFilter&quot;, urlPatterns = &quot;/*&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginCheckFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-comment">//路径匹配器</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AntPathMatcher</span> <span class="hljs-variable">PATH_MATCHER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (HttpServletResponse) servletResponse;<br><br>        <span class="hljs-comment">//获取请求的uri</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">requestURI</span> <span class="hljs-operator">=</span> request.getRequestURI();<br><br>        <span class="hljs-comment">//判断是否需要处理</span><br>        String[] urls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<br>                <span class="hljs-comment">//不需要处理的路径</span><br>                <span class="hljs-string">&quot;/employee/login&quot;</span>,<br>                <span class="hljs-string">&quot;/employee/logout&quot;</span>,<br>                <span class="hljs-string">&quot;/backend/**&quot;</span>,<br>                <span class="hljs-string">&quot;/front/**&quot;</span>,<br>                <span class="hljs-string">&quot;/common/**&quot;</span><br>        &#125;;<br>        <span class="hljs-keyword">if</span> (check(urls, requestURI)) &#123;<br>            <span class="hljs-comment">//不用处理, 放行</span><br>            filterChain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request.getSession().getAttribute(<span class="hljs-string">&quot;employee&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//网页端验证有没有登录</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (Long) request.getSession().getAttribute(<span class="hljs-string">&quot;employee&quot;</span>);<br>            BaseContext.setCurrentId(id);<br>            <span class="hljs-comment">//已登录, 放行</span><br>            filterChain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//未登录, 拦截</span><br>            response.getWriter().write(JSON.toJSONString(R.error(<span class="hljs-string">&quot;NOTLOGIN&quot;</span>)));<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 匹配请求路径是否不需要处理</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> urls</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requestURI</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">check</span><span class="hljs-params">(String[] urls, String requestURI)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String url : urls) &#123;<br>            <span class="hljs-keyword">if</span> (PATH_MATCHER.match(url, requestURI)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
      <category>springBoot</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MP公共字段自动填充</title>
    <link href="/2022/08/08/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E5%85%AC%E5%85%B1%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85/"/>
    <url>/2022/08/08/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mybatis-plus/MP%E5%85%AC%E5%85%B1%E5%AD%97%E6%AE%B5%E8%87%AA%E5%8A%A8%E5%A1%AB%E5%85%85/</url>
    
    <content type="html"><![CDATA[<h2 id="MP公共字段自动填充"><a href="#MP公共字段自动填充" class="headerlink" title="MP公共字段自动填充"></a>MP公共字段自动填充</h2><ol><li>在需要自动填充的字段上添加<code>@TableField(fill)</code>注解</li></ol><p>参数:</p><p>fill</p><table><thead><tr><th>可填入的值</th><th>说明</th></tr></thead><tbody><tr><td>FieldFill.INSERT</td><td>插入表时填充</td></tr><tr><td>FieldFill.UPDATE</td><td>更新时填充</td></tr><tr><td>FieldFill.INSERT_UPDATE</td><td>更新和插入表时填充</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span><span class="hljs-comment">//插入表时时填充</span><br><span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br><br><span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span><span class="hljs-comment">//更新和插入表时填充</span><br><span class="hljs-keyword">private</span> LocalDateTime updateTime;<br><br><br><span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span><span class="hljs-comment">//插入表时时填充</span><br><span class="hljs-keyword">private</span> Long createUser;<br><br><br><span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span><span class="hljs-comment">//更新和插入表时填充</span><br><span class="hljs-keyword">private</span> Long updateUser;<br></code></pre></td></tr></table></figure><ol start="2"><li>实现<code>MetaObjectHandler</code>接口， 重写<code>insertFill()</code>和<code>updateFill()</code>方法</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>        <span class="hljs-comment">//插入时填充的字段名及填充的值</span><br>        metaObject.setValue(<span class="hljs-string">&quot;createTime&quot;</span>, LocalDateTime.now());<br>        metaObject.setValue(<span class="hljs-string">&quot;updateTime&quot;</span>, LocalDateTime.now());<br>        metaObject.setValue(<span class="hljs-string">&quot;createUser&quot;</span>, BaseContext.getCurrentId());<br>        metaObject.setValue(<span class="hljs-string">&quot;updateUser&quot;</span>, BaseContext.getCurrentId());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> &#123;<br>        <span class="hljs-comment">//更新时填充的字段名及填充的值</span><br>        metaObject.setValue(<span class="hljs-string">&quot;updateTime&quot;</span>, LocalDateTime.now());<br>        metaObject.setValue(<span class="hljs-string">&quot;updateUser&quot;</span>, BaseContext.getCurrentId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>数据库</category>
      
      <category>mysql</category>
      
      <category>mybatis-plus</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>7.v-if和v-show区别</title>
    <link href="/2022/08/05/%E5%89%8D%E7%AB%AF/vue/7.v-if%E5%92%8Cv-show%E5%8C%BA%E5%88%AB/"/>
    <url>/2022/08/05/%E5%89%8D%E7%AB%AF/vue/7.v-if%E5%92%8Cv-show%E5%8C%BA%E5%88%AB/</url>
    
    <content type="html"><![CDATA[<h2 id="7-v-if和v-show区别"><a href="#7-v-if和v-show区别" class="headerlink" title="7.v-if和v-show区别"></a>7.v-if和v-show区别</h2><p><code>v-if</code>只有条件为真时才渲染到dom上,条件为假时从DOM中销毁</p><p><code>v-for</code>是一次性全都记载到DOM中,通过<code>display</code>来控制是否展示元素</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&#x27;ok&#x27;</span>&gt;</span>aaa<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">&#x27;!ok&#x27;</span>&gt;</span>bbb<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ok&#x3D;true时</p><p><img src="/img/post_img/SLK%25HS%5DU1$G4N8Z3NDIE3H7.png"></p><p>ok&#x3D;false时</p><p><img src="/img/post_img/20220805164227.png"></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>6.Vue绑定样式</title>
    <link href="/2022/08/03/%E5%89%8D%E7%AB%AF/vue/6.Vue%E7%BB%91%E5%AE%9A%E6%A0%B7%E5%BC%8F/"/>
    <url>/2022/08/03/%E5%89%8D%E7%AB%AF/vue/6.Vue%E7%BB%91%E5%AE%9A%E6%A0%B7%E5%BC%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="6-Vue绑定样式"><a href="#6-Vue绑定样式" class="headerlink" title="6.Vue绑定样式"></a>6.Vue绑定样式</h2><h3 id="绑定class"><a href="#绑定class" class="headerlink" title="绑定class"></a>绑定class</h3><p>通过<code>v-bind:class</code>来绑定class</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css"></span><br><span class="language-css">    <span class="hljs-selector-class">.active</span> &#123;</span><br><span class="language-css">        <span class="hljs-attribute">color</span>: red;</span><br><span class="language-css">    &#125;</span><br><span class="language-css"></span><br><span class="language-css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span> <span class="hljs-attr">v-bind:class</span>=<span class="hljs-string">&#x27;&#123;active: isActive&#125;&#x27;</span>&gt;</span>aa<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span><span class="hljs-comment">//当isActive为true时active生效</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="绑定css"><a href="#绑定css" class="headerlink" title="绑定css"></a>绑定css</h3><p>通过<code>v-bind:style</code>来绑定css</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span> <span class="hljs-attr">v-bind:style</span>=<span class="hljs-string">&#x27;styleObject&#x27;</span>&gt;</span>aa<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">styleObject</span>: &#123;<span class="hljs-comment">//通过声明数据对象来绑定css</span></span><br><span class="language-javascript">                <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;red&#x27;</span>,</span><br><span class="language-javascript">                <span class="hljs-attr">fontSize</span>: <span class="hljs-string">&#x27;20px&#x27;</span></span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>注意</strong>:  </p><ol><li>原来的<code>class</code>&#x2F;<code>style</code>不会被覆盖掉</li><li>可以用<code>[&#123;...&#125;. &#123;...&#125;, ...]</code>来绑定多个</li><li>也可以声明数据对象来绑定多个</li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>5.Vue计算属性和监听器</title>
    <link href="/2022/08/02/%E5%89%8D%E7%AB%AF/vue/5.Vue%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8/"/>
    <url>/2022/08/02/%E5%89%8D%E7%AB%AF/vue/5.Vue%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="5-Vue计算属性和监听器"><a href="#5-Vue计算属性和监听器" class="headerlink" title="5.Vue计算属性和监听器"></a>5.Vue计算属性和监听器</h2><h4 id="计算属性"><a href="#计算属性" class="headerlink" title="计算属性"></a>计算属性</h4><p>用<code>computed</code>来定义计算属性</p><p>作用: 调用计算属性时会显示return的值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;print&#125;&#125;<span class="hljs-comment">&lt;!-- Hello World --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello&#x27;</span>,</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">computed</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">print</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> + <span class="hljs-string">&quot; World&quot;</span>;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>也可以在计算属性中定义get和set，当给计算属性赋值时会调用set，使用计算属性则会调用get</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;print&#125;&#125;<span class="hljs-comment">&lt;!-- Hi World --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello&#x27;</span>,</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">computed</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">print</span>: &#123;</span><br><span class="language-javascript">                <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> + <span class="hljs-string">&quot; World&quot;</span>;</span><br><span class="language-javascript">                &#125;,</span><br><span class="language-javascript">                <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newMsg</span>) &#123;</span><br><span class="language-javascript">                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = newMsg;</span><br><span class="language-javascript">                &#125;</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    vm.<span class="hljs-property">print</span> = <span class="hljs-string">&quot;Hi&quot;</span>;<span class="hljs-comment">//调用了set</span></span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>注意</strong>: 不同于<code>methods</code>, 计算属性是有缓存的，只有值改变时才会重新计算</p><h4 id="侦听器"><a href="#侦听器" class="headerlink" title="侦听器"></a>侦听器</h4><p>用<code>watch</code>来定义侦听器</p><p>作用: 当值发生改变时会调用侦听器的方法</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;message&#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello&#x27;</span>,</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">watch</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newVal, oldVal</span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(oldVal + <span class="hljs-string">&quot;--&gt;&quot;</span> + newVal);</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    vm.<span class="hljs-property">message</span> = <span class="hljs-string">&quot;Hi&quot;</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>4.Vue钩子函数</title>
    <link href="/2022/07/30/%E5%89%8D%E7%AB%AF/vue/4.Vue%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0/"/>
    <url>/2022/07/30/%E5%89%8D%E7%AB%AF/vue/4.Vue%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="4-Vue钩子函数"><a href="#4-Vue钩子函数" class="headerlink" title="4.Vue钩子函数"></a>4.Vue钩子函数</h2><p>Vue对象初始化过程调用的函数称为<strong>钩子函数</strong>;</p><p>不应该使用箭头函数来定义一个生命周期方法;</p><p>钩子函数调用的时机:</p><ol><li><p>new Vue()</p></li><li><p><font color='green'>beforeCreate     (数据侦听和事件&#x2F;侦听器的配置之前)</font></p></li><li><p><font color='green'>created               (数据侦听和事件&#x2F;侦听器的配置之后)</font></p></li><li><p><font color='blue'>beforeMount     (数据挂载前)</font></p></li><li><p><font color='blue'>mounted            (数据挂载后, 视图的数据被Vue的替换)</font></p></li><li><p><font color='purple'>beforeUpdate   (数据改变,加载到视图前)</font></p></li><li><p><font color='purple'>updated             (加载到视图后)</font></p></li><li><p><font color='red'>beforeDestroy  (调用vm.$destroy()后,Vue对象销毁前)</font></p></li><li><p><font color='red'>destroy               (Vue对象销毁后)</font></p></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span><br>        &#123;&#123; message &#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">let</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;a&#x27;</span></span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">beforeCreate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;beforeCreate&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">created</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;created&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-attr">beforeMount</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;beforeMount&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">mounted</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;mounted&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-attr">beforeUpdate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;beforeUpdate&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">updated</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;updated&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-attr">activated</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;activated&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">deactivated</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;deactivated&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-attr">beforeDestroy</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;beforeDestroy&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">destroyed</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;destroyed&#x27;</span>);</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript"></span><br><span class="language-javascript">        <span class="hljs-attr">errorCaptured</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span><br><span class="language-javascript">            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;errorCaptured&#x27;</span>);</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript"></span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    vm.<span class="hljs-property">message</span> = <span class="hljs-string">&#x27;b&#x27;</span>;</span><br><span class="language-javascript">    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-string">&#x27;vm.$destroy()&#x27;</span>, <span class="hljs-number">2000</span>);</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>参考<a href="https://cn.vuejs.org/v2/api/#%E9%80%89%E9%A1%B9-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E9%92%A9%E5%AD%90">API — Vue.js (vuejs.org)</a></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>3.Vue数据和方法</title>
    <link href="/2022/07/30/%E5%89%8D%E7%AB%AF/vue/3.Vue%E6%95%B0%E6%8D%AE%E5%92%8C%E6%96%B9%E6%B3%95/"/>
    <url>/2022/07/30/%E5%89%8D%E7%AB%AF/vue/3.Vue%E6%95%B0%E6%8D%AE%E5%92%8C%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="3-Vue数据和方法"><a href="#3-Vue数据和方法" class="headerlink" title="3.Vue数据和方法"></a>3.Vue数据和方法</h2><h4 id="数据"><a href="#数据" class="headerlink" title="数据"></a>数据</h4><h5 id="响应式"><a href="#响应式" class="headerlink" title="响应式"></a>响应式</h5><p><strong>响应式</strong>: data中的property改变时，视图也会更新为新的值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;message&#125;&#125;// 1 ---&gt; 2<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> data = &#123;<span class="hljs-attr">message</span>: <span class="hljs-number">1</span>&#125;;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: data</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    vm.<span class="hljs-property">message</span> = <span class="hljs-number">2</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>使用<code>Object.freeze()</code>可以使property变为<strong>非响应式</strong></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;message&#125;&#125;// 仍然为1<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> data = &#123;<span class="hljs-attr">message</span>: <span class="hljs-number">1</span>&#125;;</span><br><span class="language-javascript">    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(data);</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: data</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    vm.<span class="hljs-property">message</span> = <span class="hljs-number">2</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>也可以使用 <code>v-once</code>来一次性插值,之后就不会更新</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span> <span class="hljs-attr">v-once</span>&gt;</span><br>        &#123;&#123;message&#125;&#125;// 仍然为1<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> data = &#123;<span class="hljs-attr">message</span>: <span class="hljs-number">1</span>&#125;;</span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: data</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript">    vm.<span class="hljs-property">message</span> = <span class="hljs-number">2</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="展示原始html"><a href="#展示原始html" class="headerlink" title="展示原始html"></a>展示原始html</h5><p>用插值表达式的话会按字符串输出，使用<code>v-html</code>可以展示原始html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">&#x27;message&#x27;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;&lt;font color=&quot;red&quot;&gt;a&lt;/font&gt;&#x27;</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="在插值表达式里使用js"><a href="#在插值表达式里使用js" class="headerlink" title="在插值表达式里使用js"></a>在插值表达式里使用js</h5><p><code>&#123;&#123;&#125;&#125;</code>里面还可以使用单个js的表达式</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;message + 10&#125;&#125;//11<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-number">1</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="缩写"><a href="#缩写" class="headerlink" title="缩写"></a>缩写</h5><p><code>v-bind:...</code> 可以缩写为<code>:...</code></p><p><code>v-on:...</code>可以缩写为<code>@...</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">&#x27;class1&#x27;</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">&#x27;click1&#x27;</span>&gt;</span><br>        &#123;&#123;message&#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;aaa&#x27;</span>,</span><br><span class="language-javascript">            <span class="hljs-attr">class1</span>: <span class="hljs-string">&#x27;class1&#x27;</span></span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">            click1 : <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-title function_">alert</span>(<span class="hljs-string">&quot;被点击了&quot;</span>);</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><p>前缀带<code>$</code>的为Vue提供的方法</p><p>如:</p><p>$watch(prop, function), 当prop值改变时调用function</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span><br>        &#123;&#123;message&#125;&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">var</span> vm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-number">1</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><br><span class="language-javascript">    vm.$watch(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">newVal, oldVal</span>)&#123;</span><br><span class="language-javascript">        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;oldVal:&#x27;</span> + oldVal + <span class="hljs-string">&#x27;, newVal:&#x27;</span> + newVal);</span><br><span class="language-javascript">    &#125;) </span><br><span class="language-javascript"></span><br><span class="language-javascript">    vm.<span class="hljs-property">message</span> = <span class="hljs-number">2</span>;</span><br><span class="language-javascript"></span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>参考<a href="https://cn.vuejs.org/v2/api/#%E5%AE%9E%E4%BE%8B-property">API — Vue.js (vuejs.org)</a></p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2.Vue入门</title>
    <link href="/2022/07/29/%E5%89%8D%E7%AB%AF/vue/2.Vue%E5%85%A5%E9%97%A8/"/>
    <url>/2022/07/29/%E5%89%8D%E7%AB%AF/vue/2.Vue%E5%85%A5%E9%97%A8/</url>
    
    <content type="html"><![CDATA[<h2 id="2-Vue入门"><a href="#2-Vue入门" class="headerlink" title="2.Vue入门"></a>2.Vue入门</h2><h4 id="声明式渲染"><a href="#声明式渲染" class="headerlink" title="声明式渲染"></a>声明式渲染</h4><p><code>&#123;&#123;...&#125;&#125;</code>  :  文本插入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&#x27;app&#x27;</span>&gt;</span>&#123;&#123;message&#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello Vue&#x27;</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>数据和 DOM 已经被建立了关联，所有东西都是<strong>响应式的</strong>。</p><h4 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h4><p>指令带有前缀 <code>v-</code>，以表示它们是 Vue 提供的特殊 Attribute</p><h5 id="绑定"><a href="#绑定" class="headerlink" title="绑定"></a>绑定</h5><p>v-bind:title : 将元素的 <code>title</code> 和 Vue 实例的 <code>message</code> 绑定起来</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app2&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-bind:title</span>=<span class="hljs-string">&#x27;message&#x27;</span>&gt;</span>动态绑定的信息<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript"><span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app2&#x27;</span>,</span><br><span class="language-javascript"><span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript"><span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;页面加载与&#x27;</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>()</span><br><span class="language-javascript">&#125;</span><br><span class="language-javascript">&#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="条件"><a href="#条件" class="headerlink" title="条件"></a>条件</h5><p>v-if : 条件控制,当Vue 实例的seen为true时显示元素</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app3&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">&quot;seen&quot;</span>&gt;</span>aaaaaaa<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app3&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">seen</span>: <span class="hljs-literal">true</span></span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h5><p>v-for : 遍历Vue中绑定的数组</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app4&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">&quot;todo in todos&quot;</span>&gt;</span><br>                &#123;&#123; todo.text &#125;&#125;<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app4&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">todos</span>: [</span><br><span class="language-javascript">                &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;a&#x27;</span> &#125;,</span><br><span class="language-javascript">                &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;b&#x27;</span> &#125;,</span><br><span class="language-javascript">                &#123; <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;c&#x27;</span> &#125;</span><br><span class="language-javascript">            ]</span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h5><p>v-on添加事件监听器</p><p>v-on:click : 添加单击事件监听</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app5&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">&quot;reverseMessage&quot;</span>&gt;</span>反转消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app5&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello Vue&#x27;</span></span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">        <span class="hljs-attr">methods</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">reverseMessage</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">                <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">reverse</span>().<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>)</span><br><span class="language-javascript">            &#125;</span><br><span class="language-javascript">        &#125;,</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure><p>v-model : 将输入框和Vue中实例绑定起来</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;app6&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;&#123; message &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">&quot;message&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>(&#123;</span><br><span class="language-javascript">        <span class="hljs-attr">el</span>: <span class="hljs-string">&#x27;#app6&#x27;</span>,</span><br><span class="language-javascript">        <span class="hljs-attr">data</span>: &#123;</span><br><span class="language-javascript">            <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Hello&#x27;</span></span><br><span class="language-javascript">        &#125;</span><br><span class="language-javascript">    &#125;)</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>1.Vue下载</title>
    <link href="/2022/07/29/%E5%89%8D%E7%AB%AF/vue/1.Vue%E4%B8%8B%E8%BD%BD/"/>
    <url>/2022/07/29/%E5%89%8D%E7%AB%AF/vue/1.Vue%E4%B8%8B%E8%BD%BD/</url>
    
    <content type="html"><![CDATA[<h2 id="1-Vue下载"><a href="#1-Vue下载" class="headerlink" title="1.Vue下载"></a>1.Vue下载</h2><h3 id="通过js"><a href="#通过js" class="headerlink" title="通过js"></a>通过js</h3><p>vue教程</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>cn.vuejs.org<span class="hljs-regexp">/v2/gui</span>de/<br></code></pre></td></tr></table></figure><p>vue下载链接</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>cn.vuejs.org<span class="hljs-regexp">/js/</span>vue.js<br></code></pre></td></tr></table></figure><p>导入</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;utf-8&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;js/vue.js&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="通过npm"><a href="#通过npm" class="headerlink" title="通过npm"></a>通过npm</h3><ul><li><p>npm安装vue脚手架</p><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript"><span class="hljs-built_in">npm</span> install -g @vue/cli<br></code></pre></td></tr></table></figure></li><li><p>创建项目</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">vue ui</span><br></code></pre></td></tr></table></figure></li><li><p>之后会进入ui界面进行创建项目</p><p><img src="/img/post_img/npm%E5%88%9B%E5%BB%BAVue%E9%A1%B9%E7%9B%AE1.png"></p><p><img src="/img/post_img/npm%E5%88%9B%E5%BB%BAVue%E9%A1%B9%E7%9B%AE2.png"></p><p><img src="/img/post_img/npm%E5%88%9B%E5%BB%BAVue%E9%A1%B9%E7%9B%AE3.png"></p></li><li><p>之后就会自己创建了，如果报错试试管理员打开cmd来创建</p></li><li><p><a href="https://devtools.vuejs.org/guide/installation.html">安装</a>开发者工具</p></li></ul><p><strong>运行项目</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">npm <span class="hljs-built_in">run</span> serve<br></code></pre></td></tr></table></figure><p><strong>修改端口和添加代理</strong></p><p>官方文档：<a href="https://webpack.js.org/configuration/dev-server/#devserverport">DevServer | webpack</a></p><ul><li><p>在vue.config.js中修改配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> &#123; defineConfig &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@vue/cli-service&#x27;</span>)<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">transpileDependencies</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">devServer</span>: &#123;<br>    <span class="hljs-comment">// 配置端口</span><br>    <span class="hljs-attr">port</span>: <span class="hljs-number">7070</span>,<br>    <span class="hljs-comment">// 添加代理</span><br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://localhost:8080&#x27;</span>,<br>        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>前端</category>
      
      <category>Vue</category>
      
    </categories>
    
    
    <tags>
      
      <tag>前端</tag>
      
      <tag>Vue</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bean的依赖属性配置管理</title>
    <link href="/2022/07/26/spring/bean%E7%9A%84%E4%BE%9D%E8%B5%96%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"/>
    <url>/2022/07/26/spring/bean%E7%9A%84%E4%BE%9D%E8%B5%96%E5%B1%9E%E6%80%A7%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="bean的依赖属性配置管理"><a href="#bean的依赖属性配置管理" class="headerlink" title="bean的依赖属性配置管理"></a>bean的依赖属性配置管理</h2><p>在配置文件中设置值</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">zoo:</span><br>  <span class="hljs-attr">cat:</span><br>    <span class="hljs-attr">id:</span> <span class="hljs-number">1</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;zs&quot;</span><br>  <span class="hljs-attr">dog:</span><br>    <span class="hljs-attr">id:</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">&quot;ls&quot;</span><br></code></pre></td></tr></table></figure><p>定义一个类，通过<strong>ConfigurationProperties注解</strong>来读取和封装配置中的属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = &quot;zoo&quot;)</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZooProperties</span> &#123;<br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <span class="hljs-keyword">private</span> Dog dog;<br>&#125;<br></code></pre></td></tr></table></figure><p>在需要使用配置的地方使用<strong>EnableConfigurationProperties注解</strong>来注入配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableConfigurationProperties(ZooProperties.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestSpringboot23BeanPropApplication</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ZooProperties zooProperties;<br>&#125;<br></code></pre></td></tr></table></figure><p>在需要使用属性类的位置通过注解<strong>EnableConfigurationProperties注解</strong>加载bean，而不要直接在属性配置类上定义bean，<strong>减少资源加载的数量</strong>，因需加载而不要饱和式加载。</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bean的加载控制</title>
    <link href="/2022/07/24/spring/Bean%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%8E%A7%E5%88%B6/"/>
    <url>/2022/07/24/spring/Bean%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="bean的加载控制"><a href="#bean的加载控制" class="headerlink" title="bean的加载控制"></a>bean的加载控制</h2><p><strong>springboot</strong>提供了几个注解，当条件满足时才加载相应的bean</p><h4 id="ConditionalOnClass-x2F-ConditionalOnMissingClass"><a href="#ConditionalOnClass-x2F-ConditionalOnMissingClass" class="headerlink" title="@ConditionalOnClass &#x2F; @ConditionalOnMissingClass"></a>@ConditionalOnClass &#x2F; @ConditionalOnMissingClass</h4><p>当虚拟机中有指定类时加载bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnClass(name = &quot;com.xw.bean.Dog&quot;)</span><br><span class="hljs-keyword">public</span> Cat <span class="hljs-title function_">cat</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>当虚拟机中有没有指定类时加载bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingClass(&quot;com.xw.bean.Dog&quot;)</span><br><span class="hljs-keyword">public</span> Cat <span class="hljs-title function_">cat</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="ConditionalOnBean-x2F-ConditionalOnMissingBean"><a href="#ConditionalOnBean-x2F-ConditionalOnMissingBean" class="headerlink" title="@ConditionalOnBean &#x2F; @ConditionalOnMissingBean"></a>@ConditionalOnBean &#x2F; @ConditionalOnMissingBean</h4><p>当加载了指定名称的bean时加载bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnBean(name = &quot;dog&quot;)</span><br><span class="hljs-keyword">public</span> Cat <span class="hljs-title function_">cat</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>当没有加载了指定名称的bean时加载bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-meta">@ConditionalOnMissingBean(name = &quot;dog&quot;)</span><br><span class="hljs-keyword">public</span> Cat <span class="hljs-title function_">cat</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>还有一系列的条件控制注解</p><p><img src="/img/post_img/image-20220724133812086.png"></p><h2 id="Bean默认是单例还是多例"><a href="#Bean默认是单例还是多例" class="headerlink" title="Bean默认是单例还是多例"></a>Bean默认是单例还是多例</h2><p>在Spring框架中，Bean默认是单例的。也就是说，当应用程序中的多个地方都需要调用某个Bean时，Spring容器只会创建一个Bean的实例，并在需要时共享使用这个实例。</p><p>如果需要将Bean设置成多例，可以通过在Bean类上添加<code>@Scope(&quot;prototype&quot;)</code>注解来实现</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoBean</span> &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>当容器需要创建这个Bean时，每次都会创建一个新的实例</p>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hexo常用命令</title>
    <link href="/2022/07/23/git/Hexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2022/07/23/git/Hexo%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h4 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h4><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">hexo <span class="hljs-keyword">server</span> 或 hexo s<br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th></th></tr></thead><tbody><tr><td>-p</td><td>post,自定义端口</td></tr><tr><td>-l</td><td>log,启动日志</td></tr></tbody></table><p>默认访问网址<code>http://localhost:4000/</code></p><h4 id="生成静态文件"><a href="#生成静态文件" class="headerlink" title="生成静态文件"></a>生成静态文件</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">hexo <span class="hljs-keyword">generate</span> 或 hexo g<br></code></pre></td></tr></table></figure><table><thead><tr><th>参数</th><th></th></tr></thead><tbody><tr><td>-d</td><td>deploy, 生成后立即部署到服务器</td></tr><tr><td>-f</td><td>force,强制重新生成全部文件,不加则只生成改动的文件</td></tr></tbody></table><h4 id="部署网站"><a href="#部署网站" class="headerlink" title="部署网站"></a>部署网站</h4><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">hexo <span class="hljs-keyword">deploy</span> 或 hexo d<br></code></pre></td></tr></table></figure><h4 id="清除缓存"><a href="#清除缓存" class="headerlink" title="清除缓存"></a>清除缓存</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">hexo clean</span><br></code></pre></td></tr></table></figure><p>清除缓存文件 (<code>db.json</code>) 和已生成的静态文件 (<code>public</code>)。</p><h4 id="Hexo版本"><a href="#Hexo版本" class="headerlink" title="Hexo版本"></a>Hexo版本</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">hexo <span class="hljs-built_in">version</span> 或 hexo -v<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>git</category>
      
    </categories>
    
    
    <tags>
      
      <tag>git</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bean的加载方式(2)</title>
    <link href="/2022/07/23/spring/bean%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F(2)/"/>
    <url>/2022/07/23/spring/bean%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F(2)/</url>
    
    <content type="html"><![CDATA[<h2 id="bean的加载方式-2"><a href="#bean的加载方式-2" class="headerlink" title="bean的加载方式(2)"></a>bean的加载方式(2)</h2><h4 id="5-容器初始化完成后手动加载bean"><a href="#5-容器初始化完成后手动加载bean" class="headerlink" title="5.容器初始化完成后手动加载bean"></a>5.容器初始化完成后手动加载bean</h4><p>通过AnnotationConfigApplicationContext的<strong>register</strong>方法，可以在容器初始化完成后手动加载bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig5.class);<br>        <span class="hljs-comment">//上下文容器对象已经初始化完毕后，手工加载bean</span><br>        ctx.register(Cat.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>也可以用<strong>registerBean</strong>方法指定bean的名称和参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App5</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig5.class);<br><br>        <span class="hljs-comment">//容器中有同名称的bean时会覆盖之前的</span><br>        app.registerBean(<span class="hljs-string">&quot;tom&quot;</span>, Cat.class, <span class="hljs-number">0</span>);<br>        app.registerBean(<span class="hljs-string">&quot;tom&quot;</span>, Cat.class, <span class="hljs-number">1</span>);<br>        app.registerBean(<span class="hljs-string">&quot;tom&quot;</span>, Cat.class, <span class="hljs-number">2</span>);<br><br>        System.out.println(app.getBean(<span class="hljs-string">&quot;tom&quot;</span>));<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            结果</span><br><span class="hljs-comment">            Cat&#123;id=&#x27;2&#x27;&#125;</span><br><span class="hljs-comment">        */</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="6-在容器初始化过程中加载bean"><a href="#6-在容器初始化过程中加载bean" class="headerlink" title="6.在容器初始化过程中加载bean"></a>6.在容器初始化过程中加载bean</h4><h5 id="1-ImportSelector接口"><a href="#1-ImportSelector接口" class="headerlink" title="(1)ImportSelector接口"></a>(1)ImportSelector接口</h5><p>实现<strong>ImportSelector</strong>接口,selectImports方法的返回值会被注入到容器中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> importingClassMetadata.hasAnnotation(<span class="hljs-string">&quot;org.springframework.context.annotation.ComponentScan&quot;</span>);<br>        <span class="hljs-keyword">if</span> (flag) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;com.xw.bean.Dog&quot;</span>&#125;;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>];<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>导入Selector配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(&quot;com.xw.bean&quot;)</span><br><span class="hljs-meta">@Import(MySelector.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig6</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>获取bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig6.class);<br><br>        String[] names = app.getBeanDefinitionNames();<br>        <span class="hljs-keyword">for</span> (String name : names) &#123;<br>            System.out.println(name);<br>        &#125;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            结果</span><br><span class="hljs-comment">            com.xw.bean.Dog</span><br><span class="hljs-comment">        */</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="2-ImportBeanDefinitionRegistrar接口"><a href="#2-ImportBeanDefinitionRegistrar接口" class="headerlink" title="(2)ImportBeanDefinitionRegistrar接口"></a>(2)ImportBeanDefinitionRegistrar接口</h5><p>bean的加载不是一个简简单单的对象，spring中定义了一个叫做<strong>BeanDefinition</strong>的东西，它才是控制bean初始化加载的核心</p><p><strong>ImportBeanDefinitionRegistrar</strong>相比于ImportSelector，对注入的bean有更大的操作空间</p><p>实现ImportBeanDefinitionRegistrar接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyRegister</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br>        <span class="hljs-comment">//获取bean的beanDefinition</span><br>        <span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.rootBeanDefinition(Dog.class).getBeanDefinition();<br>        <span class="hljs-comment">//注入到容器中</span><br>        registry.registerBeanDefinition(<span class="hljs-string">&quot;dog&quot;</span>, beanDefinition);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>导入Registrar配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(&quot;com.xw.bean&quot;)</span><br><span class="hljs-meta">@Import(MyRegister.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig6</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>获取bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App6</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig6.class);<br><br>        String[] names = app.getBeanDefinitionNames();<br>        <span class="hljs-keyword">for</span> (String name : names) &#123;<br>            System.out.println(name);<br>        &#125;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">            结果</span><br><span class="hljs-comment">            dog</span><br><span class="hljs-comment">        */</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h4 id="7-对容器中bean的最终裁定"><a href="#7-对容器中bean的最终裁定" class="headerlink" title="7.对容器中bean的最终裁定"></a>7.对容器中bean的最终裁定</h4><p>postProcessor为最后执行的对容器中bean的注册</p><p>实现<strong>BeanDefinitionRegistryPostProcessor</strong>接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-comment">//获取bean的beanDefinition</span><br>        <span class="hljs-type">AbstractBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> BeanDefinitionBuilder.rootBeanDefinition(Cat.class).getBeanDefinition();<br>        <span class="hljs-comment">//将之前的dog删掉换成cat</span><br>        registry.removeBeanDefinition(<span class="hljs-string">&quot;dog&quot;</span>);<br>        registry.registerBeanDefinition(<span class="hljs-string">&quot;cat&quot;</span>, beanDefinition);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postProcessBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory configurableListableBeanFactory)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>导入PostProcessor配置类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(&quot;com.xw.bean&quot;)</span><br><span class="hljs-meta">@Import(&#123;MyRegister.class, MyPostProcessor.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig6</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>获取bean</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bean">public class App6 &#123;<br>    public static void main(String[] args) &#123;<br>        AnnotationConfigApplicationContext app = new AnnotationConfigApplicationContext(SpringConfig6.class);<br><br>        String[] names = app.getBeanDefinitionNames();<br>        for (String name : names) &#123;<br>            System.out.println(name);<br>        &#125;<br>        /*<br>            结果<br>            cat<br>        */<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="FactoryBean"><a href="#FactoryBean" class="headerlink" title="FactoryBean"></a>FactoryBean</h2><blockquote><p><strong>BeanFactory</strong>的作用是完成了Bean的初始化、自动装配、存储单例Bean等功能</p><p><strong>FactoryBean</strong>本身是一个Bean，的作用是会将自身和getObject()方法的返回值作为Bean注入到容器中</p></blockquote><p>读原文<a href="https://juejin.cn/post/6844903954615107597">FactoryBean——Spring的扩展点之一 - 掘金 (juejin.cn)</a>做的笔记</p><h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><ol><li>实现FactoryBean接口，将自定义的FactoryBean注入容器</li><li>从容器中获取</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// service类，将通过FactoryBean注入容器</span><br><br><span class="hljs-keyword">package</span> com.xw.service;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;userService construct&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 自定义的FactoryBean</span><br><br><span class="hljs-keyword">package</span> com.xw.component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;UserService&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;<br>        <span class="hljs-keyword">return</span> UserService.class;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 配置类，用于扫描组件</span><br><br><span class="hljs-keyword">package</span> com.xw.config;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(&quot;com.xw.component&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 容器，获取Bean</span><br><br><span class="hljs-keyword">package</span> com.xw;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(AppConfig.class);<br>        System.out.println(<span class="hljs-string">&quot;容器初始化完成&quot;</span>);<br>        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> applicationContext.getBean(UserService.class);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">customFactoryBean</span> <span class="hljs-operator">=</span> applicationContext.getBean(<span class="hljs-string">&quot;customFactoryBean&quot;</span>);<br>        <br>        <span class="hljs-comment">// 通过Class类和BeanName获取的Bean竟然是同一个Bean</span><br>        System.out.println(userService);<br>        System.out.println(customFactoryBean);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">    容器初始化完成</span><br><span class="hljs-comment">    userService construct</span><br><span class="hljs-comment">    com.xw.service.UserService@59d016c9</span><br><span class="hljs-comment">    com.xw.service.UserService@59d016c9</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>注意：</p><ol><li><p>自定义的FactoryBean会向容器中注入两个Bean，一个是自身，一个是getObject()方法的返回值；</p></li><li><p>要想获取自定义的FactoryBean本身，需要在BeanName前面加上<code>&amp;</code>符号，<code>applicationContext.getBean(&quot;&amp;customFactoryBean&quot;)</code></p></li></ol><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><ol><li><p>refresh()</p><p>创建容器的<code>finishBeanFactoryInitialization</code>步骤，会调用到<code>beanFactory.preInstantiateSingletons()</code>来实例化单例Bean</p><p><img src="/img/spring_img/%E5%88%9B%E5%BB%BA%E5%AE%B9%E5%99%A8%E8%BF%87%E7%A8%8BfinishBeanFactoryInitialization.png"></p></li><li><p>preInstantiateSingletons()</p><p>如果是FactoryBean的实例，就通过<code>getBean()</code>来获取或创建Bean，且在BeanName前加了个<code>&amp;</code></p><p>之后会判断<code>isEagerInit</code>来创建<code>getObject()</code>里的Bean</p><p><img src="/img/spring_img/preInstantiateSingletons.png"></p></li><li><p>getObjectForBeanInstance()</p><p>在<code>getBean()</code>中会调用<code>doGetBean()</code>，然后调用<code>getObjectForBeanInstance()</code></p><p>在这个方法中，会判断Bean是否是<code>FactoryBean</code>的实例，如果是则判断缓存中是否有对应的实例，如果没有才会调用<code>getObjectFromFactoryBean()</code></p><p><img src="/img/spring_img/getObjectForBeanInstance.png"></p></li><li><p>getObjectFromFactoryBean()</p><p>通过<code>doGetObjectFromFactoryBean()</code>来调用FactoryBean的<code>getObject()</code>方法，并且判断是否为单例来决定要不要放到缓存中</p><p><img src="/img/spring_img/getObjectFromFactoryBean.png"></p></li><li><p>doGetObjectFromFactoryBean()</p><p>最终在这个方法中调用了<code>getObject()</code></p><p><img src="/img/spring_img/doGetObjectFromFactoryBean.png"></p></li><li><p>总结</p><p>通过判断<code>FactoryBean</code>、<code>getObject()里返回的对象</code>是否被创建过，只有都没有创建过才会最终创建Bean，保证单例性</p></li></ol><h3 id="在Mybatis里的使用场景"><a href="#在Mybatis里的使用场景" class="headerlink" title="在Mybatis里的使用场景"></a>在Mybatis里的使用场景</h3><p><strong>Spring中使用Mybatis</strong></p><ol><li>mybatis中，通过<code>sqlSessionFactoryBean</code>来创建<code>sqlSessionFactory</code></li><li><code>MapperScannerRegistrar</code>会将Mapper文件扫描出来生成<code>BeanDefinition</code>，然后会生成一个<code>MapperFactoryBean</code>，通过<code>MapperFactoryBean</code>最终会生成一个Mapper文件对应的代理对象</li></ol><p>SpringBoot整合Mybatis</p><ol><li>在SpringBoot中Mybatis的自动装配由<code>MybatisAutoConfiguration</code>这个类完成，里面调用了<code>SqlSessionFactoryBean</code>的getObject()方法来注入了<code>sqlSessionFactory</code></li></ol>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>bean的加载方式(1)</title>
    <link href="/2022/07/22/spring/bean%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F(1)/"/>
    <url>/2022/07/22/spring/bean%E7%9A%84%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F(1)/</url>
    
    <content type="html"><![CDATA[<h2 id="bean的加载方式-1"><a href="#bean的加载方式-1" class="headerlink" title="bean的加载方式(1)"></a>bean的加载方式(1)</h2><h4 id="1-lt-bean-gt-标签"><a href="#1-lt-bean-gt-标签" class="headerlink" title="1.&lt;bean/&gt;标签"></a>1.<code>&lt;bean/&gt;</code>标签</h4><p>通过xml配置来注入bean</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--xml方式声明自己开发的bean--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cat&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xw.bean.Cat&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xw.bean.Dog&quot;</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--xml方式声明第三方开发的bean--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><p>获取bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;spring-config.xml&quot;</span>);<br>        String[] names = app.getBeanDefinitionNames(); <span class="hljs-comment">// 获取容器中所有bean的名称</span><br>        <span class="hljs-keyword">for</span> (String name : names) &#123;<br>            System.out.println(name);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">cat<br>com<span class="hljs-selector-class">.xw</span><span class="hljs-selector-class">.bean</span>.Dog#<span class="hljs-number">0</span><br>dataSource<br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.druid</span><span class="hljs-selector-class">.pool</span>.DruidDataSource#<span class="hljs-number">0</span><br>com<span class="hljs-selector-class">.alibaba</span><span class="hljs-selector-class">.druid</span><span class="hljs-selector-class">.pool</span>.DruidDataSource#<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><h4 id="2-注解定义bean"><a href="#2-注解定义bean" class="headerlink" title="2.注解定义bean"></a>2.注解定义bean</h4><p>可以使用的注解有@Component以及三个衍生注解@Service、@Controller、@Repository。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component(&quot;jerry&quot;)</span><span class="hljs-comment">//可以给bean起个名字</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mouse</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>加载第三方bean时可通过@bean来注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DbConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DruidDataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();<br>        <span class="hljs-keyword">return</span> ds;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>最后记得开启注解扫描</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">    &quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--指定扫描加载bean的位置--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;com.xw.bean,com.xw.config&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="3-ComponentScan扫描bean"><a href="#3-ComponentScan扫描bean" class="headerlink" title="3.@ComponentScan扫描bean"></a>3.@ComponentScan扫描bean</h4><p>使用<strong>FactoryBean接口</strong></p><p>造出来的bean并不是DogFactoryBean，而是Dog</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DogFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;Dog&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Dog <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Dog</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br>        <span class="hljs-comment">//可以对对象进行一系列操作后再注入</span><br>        <span class="hljs-keyword">return</span> d;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;<br>        <span class="hljs-keyword">return</span> Dog.class;<br>    &#125;<br>    <span class="hljs-comment">//是否单例</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>定义一个类并使用**@ComponentScan**替代原始xml配置中的包扫描这个动作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ComponentScan(&#123;&quot;com.xw.bean&quot;,&quot;com.xw.config&quot;&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig3</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DogFactoryBean <span class="hljs-title function_">dog</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//通过FactoryBean来注入，可以在对象初始化前做一些事情</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DogFactoryBean</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>通过<strong>AnnotationConfigApplicationContext</strong>获取bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App3</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig3.class);<br>        String[] names = app.getBeanDefinitionNames();<br>        <span class="hljs-keyword">for</span> (String name : names) &#123;<br>            System.out.println(name);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><p>可用**@ImportResource**将xml配置文件中的bean和配置类中的bean融合在一起，在配置类上直接写上要被融合的xml配置文件名即可，算的上一种兼容性解决方案</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ImportResource(&quot;applicationContext1.xml&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig3</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>@Configuration</strong>注解的proxyBeanMethods属性，此属性默认值为true，若设为false，则表示注入到容器中的对象不再是唯一的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig3</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cat <span class="hljs-title function_">cat</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-Import指定bean"><a href="#4-Import指定bean" class="headerlink" title="4.@Import指定bean"></a>4.@Import指定bean</h4><p>通过@Import可指定要注入的bean，不需要在bean上加注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(Dog.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig4</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>获取bean</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App4</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig4.class);<br>        String[] names = app.getBeanDefinitionNames();<br>        <span class="hljs-keyword">for</span> (String name : names) &#123;<br>            System.out.println(name);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>结果</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">springConfig4<br>com<span class="hljs-selector-class">.xw</span><span class="hljs-selector-class">.bean</span>.Dog<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习笔记</category>
      
      <category>spring</category>
      
    </categories>
    
    
    <tags>
      
      <tag>后端</tag>
      
      <tag>spring</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
