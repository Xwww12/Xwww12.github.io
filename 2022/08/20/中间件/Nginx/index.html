

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="xw">
  <meta name="keywords" content="">
  
    <meta name="description" content="NginxNginx是一款轻量级Web服务器&#x2F;反向代理服务器，占用内存少，并发能力强 下载和安装源码安装 官网下载 老版本下载  安装依赖包  GCC编译器：Nginx是使用C语言编写的程序，因此想要运行Nginx就需要安装一个编译工具。GCC就是一个开源的编译器集合，用于处理各种各样的语言，其中就包含了C语言。 PCRE：Nginx在编译过程中需要使用到PCRE库（perl Compa">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="http://xwww12.github.io/2022/08/20/%E4%B8%AD%E9%97%B4%E4%BB%B6/Nginx/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="NginxNginx是一款轻量级Web服务器&#x2F;反向代理服务器，占用内存少，并发能力强 下载和安装源码安装 官网下载 老版本下载  安装依赖包  GCC编译器：Nginx是使用C语言编写的程序，因此想要运行Nginx就需要安装一个编译工具。GCC就是一个开源的编译器集合，用于处理各种各样的语言，其中就包含了C语言。 PCRE：Nginx在编译过程中需要使用到PCRE库（perl Compa">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-08-20T14:06:41.978Z">
<meta property="article:modified_time" content="2023-01-10T08:47:56.403Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="中间件">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>Nginx - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"xwww12.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>夕立ち的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/banner_img/Reimu1.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">Nginx</span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        xw
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-20 22:06" pubdate>
          2022年8月20日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          23k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          192 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Nginx</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>Nginx是一款轻量级Web服务器&#x2F;反向代理服务器，占用内存少，并发能力强</p>
<h4 id="下载和安装"><a href="#下载和安装" class="headerlink" title="下载和安装"></a>下载和安装</h4><h5 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h5><ol>
<li><p><a target="_blank" rel="noopener" href="http://nginx.org/en/download.html">官网下载</a></p>
<p><a target="_blank" rel="noopener" href="http://nginx.org/download/">老版本下载</a></p>
</li>
<li><p>安装依赖包</p>
<blockquote>
<p><strong>GCC编译器</strong>：Nginx是使用C语言编写的程序，因此想要运行Nginx就需要安装一个编译工具。GCC就是一个开源的编译器集合，用于处理各种各样的语言，其中就包含了C语言。</p>
<p><strong>PCRE</strong>：Nginx在编译过程中需要使用到PCRE库（perl Compatible Regular Expressoin 兼容正则表达式库)，因为在Nginx的Rewrite模块和http核心模块都会使用到PCRE正则表达式语法。</p>
<p><strong>zlib</strong>：在Nginx的各个模块中需要使用gzip压缩</p>
<p><strong>OpenSSL</strong>：是一个开放源代码的软件库包，应用程序可以使用这个包进行安全通信，并且避免被窃听。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs linux"># -y表示需要用户确认的地方默认yes<br>yum -y install gcc zlib zlib-devel pcre-devel openssl openssl-devel<br></code></pre></td></tr></table></figure>
</li>
<li><p>解压nginx安装包</p>
<blockquote>
<p>最好放到一个特定的目录下管理，以后删除还需要</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs linux">tar -zxvf nginx-1.16.1.tar.gz<br></code></pre></td></tr></table></figure>
</li>
<li><p>进入目录执行命令来安装nginx</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gauss">检查环境，配置环境变量，设置安装到哪<br>./configure --prefix=安装路径<br>编译安装<br><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install<br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h5><blockquote>
<p>相比源码安装，会添加有很多额外的配置信息</p>
</blockquote>
<ol>
<li><p>通过yum进行安装</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> -y nginx<br></code></pre></td></tr></table></figure>
</li>
<li><p>查看安装的目录</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">whereis nginx</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># 默认安装到了<span class="hljs-regexp">/usr/</span>sbin，配置文件在<span class="hljs-regexp">/etc/</span>ngin/nginx.conf<br>cd <span class="hljs-regexp">/usr/</span>sbin<br># 启动<br>./nginx<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h4><h5 id="源码方式"><a href="#源码方式" class="headerlink" title="源码方式"></a>源码方式</h5><ol>
<li><p>停止nginx</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">./nginx -s stop<br></code></pre></td></tr></table></figure>
</li>
<li><p>删除nginx文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf nginx/<br></code></pre></td></tr></table></figure>
</li>
<li><p>到之前解压出来的源码目录下</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make clean</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="yum方式"><a href="#yum方式" class="headerlink" title="yum方式"></a>yum方式</h5><ol>
<li><p>停止nginx</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">./nginx -s stop<br>service nginx stop<br></code></pre></td></tr></table></figure>
</li>
<li><p>删除nginx自动启动</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">chkconfig</span> nginx <span class="hljs-literal">off</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>删除nginx本地文件</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">rm -rf <span class="hljs-regexp">/usr/</span>sbin/nginx<br>rm -rf <span class="hljs-regexp">/etc/</span>nginx<br>rm -rf <span class="hljs-regexp">/etc/i</span>nit.d/nginx<br></code></pre></td></tr></table></figure>
</li>
<li><p>yum清理</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">yum <span class="hljs-built_in">remove</span> nginx<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><ul>
<li>conf&#x2F;nginx.conf	nginx配置文件</li>
<li>conf&#x2F;mime.types  HTTP协议中Content-Type的值和文件后缀名对应关系</li>
<li>html                        存放静态文件</li>
<li>logs                         存放日志</li>
<li>sbin                         二进制文件，用于启动、停止nginx</li>
</ul>
<h4 id="启动-x2F-关闭方式"><a href="#启动-x2F-关闭方式" class="headerlink" title="启动&#x2F;关闭方式"></a>启动&#x2F;关闭方式</h4><h5 id="信号控制方式"><a href="#信号控制方式" class="headerlink" title="信号控制方式"></a>信号控制方式</h5><table>
<thead>
<tr>
<th>信号</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>TERM&#x2F;INT</td>
<td>立即关闭整个服务</td>
</tr>
<tr>
<td>QUIT</td>
<td>“优雅”地关闭整个服务</td>
</tr>
<tr>
<td>HUP</td>
<td>重读配置文件并使用服务对新配置项生效</td>
</tr>
<tr>
<td>USR1</td>
<td>重新打开日志文件，可以用来进行日志切割</td>
</tr>
<tr>
<td>USR2</td>
<td>平滑升级到最新版的nginx</td>
</tr>
<tr>
<td>WINCH</td>
<td>所有子进程不在接收处理新连接，相当于给work进程发送QUIT指令</td>
</tr>
</tbody></table>
<p> 通过<code>kill -signal PID</code>来使用</p>
<h5 id="命令方式"><a href="#命令方式" class="headerlink" title="命令方式"></a>命令方式</h5><p><code>./nginx -h</code> 查看所有参数</p>
<p><code>-t</code>：检查配置文件是否有错误</p>
<p><code>-s</code>：signal信号，后面可以跟stop[快速关闭]、quit[优雅关闭]、reopen[重新加载日志文件]、reload[重新加载配置文件]</p>
<p><code>-c</code>：指定配置文件</p>
<h4 id="平滑升级"><a href="#平滑升级" class="headerlink" title="平滑升级"></a>平滑升级</h4><p>不需要停止nginx服务器就可以升级版本</p>
<ol>
<li><p>准备两个版本的Nginx分别是 1.14.2和1.16.1，1.14.2的编译安装，1.16.1的只需要编译</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-meta"># 1.14.2</span><br>./configure<br><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install<br><span class="hljs-meta"># 1.16.1</span><br>./configure<br><span class="hljs-built_in">make</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>首先备份老版本的nginx下的<code>sbin/nginx</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>sbin<br>mv nginx nginxold<br></code></pre></td></tr></table></figure>
</li>
<li><p>拷贝新版本的nginx的<code>/objs/nginx</code>到老版本nginx的<code>sbin/</code>目录下</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd ~<span class="hljs-regexp">/nginx/</span>core<span class="hljs-regexp">/nginx-1.16.1/</span>objs<br>cp nginx <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>sbin<br></code></pre></td></tr></table></figure>
</li>
<li><p>执行<code>make upgrade</code>进行升级</p>
</li>
<li><p><code>./nginx -v</code>查看版本</p>
</li>
</ol>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs linux">nginx目录下<br><br>1.查看nginx版本<br>./sbin/nginx -v<br><br>2.测试配置文件是否有错<br>./sbin/nginx -t<br><br>3.启动nginx服务<br>./sbin/nginx<br><br>4.停止nginx服务<br>./sbin/nginx -s stop<br><br>5.修改过配置文件后，重新加载配置文件<br>./sbin/nginx -s reload<br></code></pre></td></tr></table></figure>



<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>分为三大块：全局块、events块、http块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs conf">worker_processes  1;<br><br>events &#123;<br>    worker_connections  1024;<br>&#125;<br><br>http &#123;<br>    include       mime.types;<br>    default_type  application/octet-stream;<br>    sendfile        on;<br>    keepalive_timeout  65;<br><br>    server &#123;<br>        listen       80;<br>        # 支持正则，以~开头，如:~^www\.\w+\.com;<br>        server_name  localhost;<br>        location / &#123;<br>            root   html;<br>            index  index.html index.htm;<br>        &#125;<br>        error_page   500 502 503 504  /50x.html;<br>        location = /50x.html &#123;<br>            root   html;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="全局块"><a href="#全局块" class="headerlink" title="全局块"></a>全局块</h5><h6 id="user指令"><a href="#user指令" class="headerlink" title="user指令"></a>user指令</h6><p>指定启动运行工作进程的用户及用户组，这样对于系统的权限访问控制的更加精细，也更加安全。</p>
<ol>
<li><p>在配置文件中设置用户信息</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">user</span> <span class="hljs-title">www</span>;<br></code></pre></td></tr></table></figure>
</li>
<li><p>创建一个linux用户</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">useradd www</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>创建<code>/home/www/html/index.html</code> 文件，在www用户目录下用户有访问权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span><br><span class="language-css">    <span class="hljs-selector-tag">body</span> &#123;</span><br><span class="language-css">        <span class="hljs-attribute">width</span>: <span class="hljs-number">35em</span>;</span><br><span class="language-css">        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;</span><br><span class="language-css">        <span class="hljs-attribute">font-family</span>: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="language-css">    &#125;</span><br><span class="language-css"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Welcome to nginx!<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>For online documentation and support please refer to<br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://nginx.org/&quot;</span>&gt;</span>nginx.org<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>.<span class="hljs-tag">&lt;<span class="hljs-name">br</span>/&gt;</span><br>Commercial support is available at<br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;http://nginx.com/&quot;</span>&gt;</span>nginx.com<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>Thank you for using nginx.<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">em</span>&gt;</span>I am WWW<span class="hljs-tag">&lt;/<span class="hljs-name">em</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>修改配置，测试访问</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs glsl"><span class="hljs-keyword">location</span> / &#123;<br>	root   /home/www/html;<br>	<span class="hljs-keyword">index</span>  <span class="hljs-keyword">index</span>.html <span class="hljs-keyword">index</span>.htm;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h6 id="work-process指令"><a href="#work-process指令" class="headerlink" title="work process指令"></a>work process指令</h6><ol>
<li><code>master_process on|off</code>：用来指定是否开启<strong>工作进程</strong>，默认on</li>
<li><code>worker_processes num/auto</code>：配置Nginx生成工作进程的数量，建议将该值和服务器CPU的内核数保存一致</li>
</ol>
<blockquote>
<p>这两个配置完要停止nginx再启动才会生效</p>
</blockquote>
<h6 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h6><table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>daemon on|off</td>
<td>设定Nginx是否以守护进程的方式启动，默认on</td>
</tr>
<tr>
<td>pid file</td>
<td>配置Nginx当前master进程的进程号ID存储的文件路径</td>
</tr>
<tr>
<td>error_log  file [日志级别]</td>
<td>配置Nginx的错误日志存放路径，日志级别越低显示的信息越多</td>
</tr>
<tr>
<td>include file</td>
<td>引入其他配置文件</td>
</tr>
</tbody></table>
<h5 id="events块"><a href="#events块" class="headerlink" title="events块"></a>events块</h5><p>主要用来设置nginx和用户的网络连接</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>accept_mutex on|off</td>
<td>设置Nginx网络连接序列化。off时为当来了一个请求，会唤醒多个worker来竞争; on时则将会对多个Nginx进程接收连接进行序列号，一个个来唤醒接收</td>
</tr>
<tr>
<td>multi_accept on|off</td>
<td>设置一个工作进程是否允许同时接收多个网络连接</td>
</tr>
<tr>
<td>worker_connections number</td>
<td>配置单个worker进程最大的连接数，默认512</td>
</tr>
<tr>
<td>use  method</td>
<td>设置Nginx服务器选择哪种事件驱动来处理网络消息，select&#x2F;poll&#x2F;epoll&#x2F;kqueue</td>
</tr>
</tbody></table>
<p>例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs conf">events &#123;<br>    accept_mutex on;<br>    multi_accept on;<br>    use epoll;<br>    worker_connections  1024;<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="http块"><a href="#http块" class="headerlink" title="http块"></a>http块</h5><h6 id="指定MIME-Type"><a href="#指定MIME-Type" class="headerlink" title="指定MIME-Type"></a>指定MIME-Type</h6><p>通过<code>default_type mime-type;</code>来指定返回数据的类型，可以配置在http、server、location中</p>
<p>例子</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">location</span> <span class="hljs-title">/get_text</span> &#123;<br>	<span class="hljs-comment">#这里也可以设置成text/plain</span><br>    default_type text/html;<br>    return <span class="hljs-number">200</span> <span class="hljs-string">&quot;This is nginx&#x27;s text&quot;</span>;<br>&#125;<br><span class="hljs-keyword">location</span> <span class="hljs-title">/get_json</span>&#123;<br>    default_type application/json;<br>    return <span class="hljs-number">200</span> &#x27;&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;TOM&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>&#125;&#x27;;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="自定义服务日志"><a href="#自定义服务日志" class="headerlink" title="自定义服务日志"></a>自定义服务日志</h6><table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>access_log path [format]</td>
<td>设计用户访问请求日志的位置，后面可以跟日志输出格式</td>
</tr>
<tr>
<td>log_format name</td>
<td>指定日志的输出格式</td>
</tr>
<tr>
<td>sendfile on|off</td>
<td>是否使用sendfile()传输文件，该属性可以大大提高Nginx处理静态资源的性能</td>
</tr>
<tr>
<td>keepalive_timeout time</td>
<td>设置长连接的超时时间</td>
</tr>
<tr>
<td>keepalive_requests number</td>
<td>设置一个keep-alive连接使用的次数</td>
</tr>
</tbody></table>
<h6 id="server块和location块"><a href="#server块和location块" class="headerlink" title="server块和location块"></a>server块和location块</h6><p>server块</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>listen address[:port]</td>
<td>配置监听端口</td>
</tr>
<tr>
<td>server_name  name</td>
<td>设置虚拟主机服务名称。可用正则，如果同时匹配多个，则选最精确的</td>
</tr>
</tbody></table>
<p>location块</p>
<ol>
<li><p>location [  &#x3D;  |~  |<del>*   |^</del>   |@ ] uri{…}</p>
<p>设置请求的URI，&#x3D;精确匹配，<del>正则，</del>*正则不区分大小写，^~用于不包含正则表达式的uri前(和不加符号功能一致，但如果模式匹配，就停止搜索其他模式)</p>
</li>
<li><p>root &#x2F; alias path</p>
<p>root的处理结果是: root路径+location路径<br>alias的处理结果是:使用alias路径替换location路径<br>alias是一个目录别名的定义，root则是最上层目录的含义。<br>如果location路径是以&#x2F;结尾,则alias也必须是以&#x2F;结尾，root没有要求</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gradle"># 浏览器<span class="hljs-string">&#x27;/images/1.png&#x27;</span> 匹配到 <span class="hljs-string">&#x27;/usr/local/nginx/html/images/1.png&#x27;</span><br>location /images &#123;<br>	root <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>html;<br>&#125;<br><br># 浏览器<span class="hljs-string">&#x27;/images/1.png&#x27;</span> 匹配到 <span class="hljs-string">&#x27;/usr/local/nginx/html/1.png&#x27;</span><br>location /images &#123;<br>	alias <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/nginx/</span>html;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>index path</p>
<p>设置网站的默认首页</p>
</li>
<li><p>error_page code … [&#x3D;[response]] uri</p>
<p>设置网站的错误页面</p>
<p>后面可以跟具体地址、重定向地址</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">server</span> &#123;<br>	error_page <span class="hljs-number">404</span> http<span class="hljs-operator">:</span><span class="hljs-comment">//www.baidu.com;</span><br>&#125;<br><br><span class="hljs-keyword">server</span>&#123;<br>	error_page <span class="hljs-number">404</span> <span class="hljs-operator">/</span><span class="hljs-number">50</span>x.html;<br>	error_page <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> <span class="hljs-operator">/</span><span class="hljs-number">50</span>x.html;<br>	location <span class="hljs-operator">=/</span><span class="hljs-number">50</span>x.<span class="hljs-keyword">html</span>&#123;<br>		root html;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>还可以用来修改状态码</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># 返回的状态码为200</span><br>server&#123;<br>	error_page <span class="hljs-number">404</span> =<span class="hljs-number">200</span> /<span class="hljs-number">50</span>x.html;<br>	<span class="hljs-keyword">location</span> <span class="hljs-title">=/50x</span>.html&#123;<br>		root html;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="静态资源优化配置语法"><a href="#静态资源优化配置语法" class="headerlink" title="静态资源优化配置语法"></a>静态资源优化配置语法</h5><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启高效的文件传输模式，类似</span><br><span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># 必须在sendfile打开的状态下才会生效，主要是用来提升网络包的传输效率，缓存满了才发送</span><br><span class="hljs-attribute">tcp_nopush</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># 该指令必须在keep-alive连接开启的情况下才生效，来提高网络包传输的&#x27;实时性&#x27;</span><br><span class="hljs-attribute">tcp_nodeplay</span> <span class="hljs-literal">on</span>;<br></code></pre></td></tr></table></figure>

 <figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启压缩功能</span><br><span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># 配置需要压缩的文件类型，如application/javascript text/html</span><br><span class="hljs-attribute">gzip_types</span> MIME类型;<br><br><span class="hljs-comment"># 设置Gzip压缩程度，1最低</span><br><span class="hljs-attribute">gzip_comp_level</span> <span class="hljs-number">1</span>-<span class="hljs-number">9</span>;<br><span class="hljs-comment"># 是否携带“Vary:Accept-Encoding”头域的响应头部，用来告诉接收方使用了压缩处理</span><br><span class="hljs-attribute">gzip_vary</span> <span class="hljs-literal">on</span>|<span class="hljs-literal">off</span>;<br><span class="hljs-comment"># 通过正则匹配User-Agent头里的信息来，选择性地关闭Gzip功能</span><br><span class="hljs-attribute">gzip_disable</span> regex;<br><span class="hljs-comment"># 设置当文件大小大于length时才压缩</span><br><span class="hljs-attribute">gzip_min_length</span> length;<br></code></pre></td></tr></table></figure>

<h5 id="添加模块步骤"><a href="#添加模块步骤" class="headerlink" title="添加模块步骤"></a>添加模块步骤</h5><p>以添加<code>http_gzip_static_module</code>为例</p>
<ol>
<li><p>查询当前Nginx的配置参数</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">nginx -V</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>将nginx安装目录下sbin目录中的nginx二进制文件进行更名（保存旧的）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> nginx nginxold<br></code></pre></td></tr></table></figure>
</li>
<li><p>进入Nginx的安装目录</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/root/</span>nginx<span class="hljs-regexp">/core/</span>nginx-<span class="hljs-number">1.16</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>执行make clean清空之前编译的内容</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make clean</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>使用configure来配置参数</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">./configure</span> <span class="hljs-params">--with-http_gzip_static_module</span> 后面把第一步查到的配置参数加上<br></code></pre></td></tr></table></figure>
</li>
<li><p>使用make命令进行编译</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>将objs目录下的nginx二进制执行文件移动到nginx安装目录下的sbin目录中</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mv objs<span class="hljs-regexp">/nginx /u</span>sr<span class="hljs-regexp">/local/</span>nginx/sbin<br></code></pre></td></tr></table></figure>
</li>
<li><p>执行更新命令</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">make upgrade</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 开启gzip_static</span><br><span class="hljs-attribute">gzip_static</span> <span class="hljs-literal">on</span>;<br><span class="hljs-comment"># reload重新加载配置文件，之后如果存在gz压缩好的文件，就会直接返回压缩好的</span><br><span class="hljs-comment"># gzip压缩文件指令：gzip 文件路径</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="缓存相关指令"><a href="#缓存相关指令" class="headerlink" title="缓存相关指令"></a>缓存相关指令</h5><ol>
<li>指定缓存时间，填off不缓存</li>
</ol>
   <figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">expires <span class="hljs-selector-attr">[modified]</span> <span class="hljs-selector-tag">time</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li><p>添加响应头</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">add_header <span class="hljs-keyword">name</span> value<br></code></pre></td></tr></table></figure>

<p>Cache-Control作为响应头信息，可以设置如下值</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>must-revalidate</td>
<td>可缓存但必须再向源服务器进行确认</td>
</tr>
<tr>
<td>no-cache</td>
<td>缓存前必须确认其有效性</td>
</tr>
<tr>
<td>no-store</td>
<td>不缓存请求或响应的任何内容</td>
</tr>
<tr>
<td>no-transform</td>
<td>代理不可更改媒体类型</td>
</tr>
<tr>
<td>public</td>
<td>可向任意方提供响应的缓存</td>
</tr>
<tr>
<td>private</td>
<td>仅向特定用户返回响应</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>要求中间缓存服务器对缓存的响应有效性再进行确认</td>
</tr>
<tr>
<td>max-age&#x3D;&lt;秒&gt;</td>
<td>响应最大Age值</td>
</tr>
<tr>
<td>s-maxage&#x3D;&lt;秒&gt;</td>
<td>公共缓存服务器响应的最大Age值</td>
</tr>
</tbody></table>
</li>
</ol>
<h4 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h4><p>同源:  协议、域名(IP)、端口相同即为同源</p>
<p>如果从服务器A的页面发送异步请求到服务器B获取数据，如果服务器A和服务器B不满足同源策略，则就会出现跨域问题。</p>
<p><strong>解决方式</strong></p>
<p>添加Access-Control-Allow-Origin来设置允许跨域访问的源地址信息</p>
<p>添加Access-Control-Allow-Methods来设置允许跨域访问的请求方式</p>
<p>例如</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">location</span> <span class="hljs-title">/getUser</span>&#123;<br>	<span class="hljs-comment"># *表所有地址都可以</span><br>    add_header Access-Control-Allow-Origin *;<br>    add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE;<br>    default_type application/json;<br>    return <span class="hljs-number">200</span> &#x27;&#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-number">1</span>,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;TOM&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>&#125;&#x27;;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h4><p>盗链：将别人网页的内容放到自己的页面上</p>
<p><strong>防盗链原理</strong></p>
<p>通过判断HTTP的头信息Referer来判断获取资源的请求来源，只对允许的来源开放链接</p>
<p><strong>防盗链步骤</strong></p>
<p>例子</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /images &#123;<br>           <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> www.baidu.com <span class="hljs-number">192.168.200.222</span> <span class="hljs-regexp">*.example.com</span> <span class="hljs-regexp">example.*</span>  www.example.org  ~\.google\.;<br>           <span class="hljs-attribute">if</span> (<span class="hljs-variable">$invalid_referer</span>)&#123;<br>                <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>;<br>           &#125;<br>           <span class="hljs-attribute">root</span> /usr/local/nginx/html;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Rewrite功能配置"><a href="#Rewrite功能配置" class="headerlink" title="Rewrite功能配置"></a>Rewrite功能配置</h4><p>主要的作用是用来实现URL的重写</p>
<p>可以用来做域名跳转、域名镜像、给每个模块设置独立域名、合并目录</p>
<h5 id="规则"><a href="#规则" class="headerlink" title="规则"></a>规则</h5><ol>
<li><p>set</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">set</span> <span class="hljs-variable">$variable</span> value<br><br>例<br><span class="hljs-built_in"> server </span>&#123;<br>        listen 8081;<br>        server_name localhost;<br>        location <span class="hljs-built_in">/server </span>&#123;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$name</span> Tom;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$age</span> 18;<br>                default_type text/plain;<br>                return 200 <span class="hljs-variable">$name</span>=<span class="hljs-variable">$age</span>;<br>        &#125;<br>    &#125;<br>nginx有预设的全局变量<br>例：用全局变量记录日志<br>log_format main <span class="hljs-string">&#x27;$remote_addr - $request - $status - $request_uri - $http_user_agent&#x27;</span>;<br><br>   <span class="hljs-built_in"> server </span>&#123;<br>        listen 8081;<br>        server_name localhost;<br>        location <span class="hljs-built_in">/server </span>&#123;<br>                access_log logs/access.log main;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$name</span> Tom;<br>                <span class="hljs-built_in">set</span> <span class="hljs-variable">$age</span> 18;<br>                default_type text/plain;<br>                return 200 <span class="hljs-variable">$name</span>=<span class="hljs-variable">$age</span>;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>if</p>
<figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nim"><span class="hljs-keyword">if</span>  (condition)<span class="hljs-meta">&#123;...&#125;</span><br><br><span class="hljs-number">1</span>. 如果变量名对应的值为空或者是<span class="hljs-number">0</span>，<span class="hljs-keyword">if</span>都判断为<span class="hljs-literal">false</span>,其他条件为<span class="hljs-literal">true</span>。<br><span class="hljs-number">2</span>. 使用<span class="hljs-string">&quot;=&quot;</span>和<span class="hljs-string">&quot;!=&quot;</span>比较变量和字符串是否相等，满足条件为<span class="hljs-literal">true</span>，不满足为<span class="hljs-literal">false</span><br>例<br><span class="hljs-keyword">if</span> ($request_method = <span class="hljs-type">POST</span>)&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">405</span>;<br>&#125;<br><span class="hljs-number">3</span>. 使用正则表达式对变量进行匹配，匹配成功返回<span class="hljs-literal">true</span>，否则返回<span class="hljs-literal">false</span>。变量与正则表达式之间使用<span class="hljs-string">&quot;~&quot;</span>,<span class="hljs-string">&quot;~*&quot;</span>,<span class="hljs-string">&quot;!~&quot;</span>,<span class="hljs-string">&quot;!~\*&quot;</span>来连接。<br><span class="hljs-number">4</span>. 判断请求的文件是否存在使用<span class="hljs-string">&quot;-f&quot;</span>和<span class="hljs-string">&quot;!-f&quot;</span>, 判断请求的目录是否存在使用<span class="hljs-string">&quot;-d&quot;</span>和<span class="hljs-string">&quot;!-d&quot;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>break</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs axapta">该指令用于中断当前相同作用域中的其他Nginx配置<br>会去找与访问路径对应目录下的<span class="hljs-keyword">index</span>.html文件<br></code></pre></td></tr></table></figure>
</li>
<li><p>return</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">return</span> code [text];<br><span class="hljs-keyword">return</span> code URL;<br><span class="hljs-keyword">return</span> URL;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rewrite</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ldif">rewrite regex replacement<br><span class="hljs-attribute">replacement</span>:匹配成功后，用于替换URI中被截取内容的字符串<br><span class="hljs-attribute">flag</span>:用来设置rewrite对URI的处理行为，可选值有如下：<br><span class="hljs-literal">-</span> last:	替换完后重新匹配<br><span class="hljs-literal">-</span> break: 替换完后去找与访问路径对应目录下的index.html文件<br><span class="hljs-literal">-</span> redirect：永久重定向<br><span class="hljs-literal">-</span> permanent：临时重定向<br></code></pre></td></tr></table></figure>
</li>
<li><p>rewrite_log</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">rewrite_log</span> <span class="hljs-literal">on</span>\|<span class="hljs-literal">off</span><br>配置是否开启URL重写日志的输出功能<br>rewrite_log的日志输出级别为<span class="hljs-literal">notice</span><br>所以需要设置日志输出级别为<span class="hljs-literal">notice</span>才能看到日志<br>error_log logs/<span class="hljs-literal">error</span>.log <span class="hljs-literal">notice</span>;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h4><ol>
<li><p>proxy_pass</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">proxy_pass URL<br>设置被代理服务器地址，可以是主机名称、IP地址加端口号形式<br><br>例<br>server&#123;<br>	listen <span class="hljs-number">80</span>;<br>	server_name localhost;<br>	location /server&#123;<br>		<span class="hljs-comment">#proxy_pass http://192.168.200.146;</span><br>		proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>/;<br>	&#125;<br>&#125;<br>url后面加<span class="hljs-regexp">/则最终找的是url/i</span>ndex.html，不加则为url<span class="hljs-regexp">/server/i</span>ndex.html<br></code></pre></td></tr></table></figure>
</li>
<li><p>proxy_set_header</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_set_header</span> field value<br>更改Nginx服务器接收到的客户端请求的请求头信息<br><br>例<br>server &#123;<br>	<span class="hljs-attribute">listen</span> <span class="hljs-number">8080</span>;<br>	<span class="hljs-attribute">server_name</span> localhost;<br>	<span class="hljs-attribute">default_type</span> text/plain;<br>	<span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-variable">$http_username</span>;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>	<span class="hljs-attribute">listen</span> <span class="hljs-number">8081</span>;<br>	<span class="hljs-attribute">server_name</span> localhost;<br>	<span class="hljs-section">location</span> /server &#123;<br>		<span class="hljs-attribute">proxy_pass</span> http://47.96.80.163:8080;<br>		<span class="hljs-attribute">proxy_set_header</span> username Cat;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>proxy_redirect</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">proxy_redirect redirect replacement;<br>redirect:目标,Location的值<br>replacement:要替换的值<br>重置头信息中的<span class="hljs-string">&quot;Location&quot;</span>和<span class="hljs-string">&quot;Refresh&quot;</span>的值<br><br>例<br>服务端[<span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>]<br>server &#123;<br>    listen  <span class="hljs-number">8081</span>;<br>    server_name localhost;<br>    <span class="hljs-keyword">if</span> (!-f <span class="hljs-variable">$request_filename</span>)&#123;<br>    	return <span class="hljs-number">302</span> http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>;<br>    &#125;<br>&#125;<br>代理服务端[<span class="hljs-number">192.168</span>.<span class="hljs-number">200.133</span>]<br>server &#123;<br>	listen  <span class="hljs-number">8081</span>;<br>	server_name localhost;<br>	location / &#123;<br>		proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span>:<span class="hljs-number">8081</span>/;<br>		proxy_redirect http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.146</span> http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">200.133</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>具体案例</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">案例：将不同请求代理到不同服务器<br><br>代理服务器<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">8082</span>;<br>        server_name     localhost;<br>        <span class="hljs-keyword">location</span> /server1 &#123;<br>                proxy_pass http://<span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.146</span>:<span class="hljs-number">9001</span>/;<br>        &#125;<br>        <span class="hljs-keyword">location</span> /server2 &#123;<br>                proxy_pass http://<span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.146</span>:<span class="hljs-number">9002</span>/;<br>        &#125;<br>        <span class="hljs-keyword">location</span> /server3 &#123;<br>                proxy_pass http://<span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.146</span>:<span class="hljs-number">9003</span>/;<br>        &#125;<br>&#125;<br><br>服务端<br>server1<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">9001</span>;<br>        server_name     localhost;<br>        default_type <span class="hljs-type">text</span>/html;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;&#x27;</span><br>&#125;<br>server2<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">9002</span>;<br>        server_name     localhost;<br>        default_type <span class="hljs-type">text</span>/html;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;&#x27;</span><br>&#125;<br>server3<br><span class="hljs-keyword">server</span> &#123;<br>        <span class="hljs-keyword">listen</span>          <span class="hljs-number">9003</span>;<br>        server_name     localhost;<br>        default_type <span class="hljs-type">text</span>/html;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="第七层负载均衡"><a href="#第七层负载均衡" class="headerlink" title="第七层负载均衡"></a>第七层负载均衡</h4><h5 id="负载均衡作用"><a href="#负载均衡作用" class="headerlink" title="负载均衡作用"></a>负载均衡作用</h5><ol>
<li>解决服务器的高并发压力，提高应用程序的处理性能。</li>
<li>提供故障转移，实现高可用。</li>
<li>通过添加或减少服务器数量，增强网站的可扩展性。</li>
<li>在负载均衡器上进行过滤，可以提高系统的安全性。</li>
</ol>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>被代理服务器：47.96.80.163:9001、47.96.80.163:9002、47.96.80.163:9003</p>
<p>负载均衡器：47.96.80.163:8081</p>
<p>默认方式为轮询</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">9001</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-attribute">default_type</span> text/html;<br>    <span class="hljs-section">location</span> / &#123;<br>    	<span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;9001&lt;/h1&gt;&#x27;</span>;<br>	&#125;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">9002</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-attribute">default_type</span> text/html;<br>    <span class="hljs-section">location</span> / &#123;<br>    	<span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;9002&lt;/h1&gt;&#x27;</span>;<br>	&#125;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">9003</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-attribute">default_type</span> text/html;<br>    <span class="hljs-section">location</span> / &#123;<br>    	<span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">&#x27;&lt;h1&gt;9003&lt;/h1&gt;&#x27;</span>;<br>	&#125;<br>&#125;<br><span class="hljs-section">upstream</span> backend &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9001</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9002</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9003</span>;<br>&#125;<br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>  <span class="hljs-number">8081</span>;<br>    <span class="hljs-attribute">server_name</span> localhost;<br>    <span class="hljs-section">location</span> / &#123;<br>    	<span class="hljs-attribute">proxy_pass</span> http://backend;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="负载均衡状态"><a href="#负载均衡状态" class="headerlink" title="负载均衡状态"></a>负载均衡状态</h5><table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>down</td>
<td>当前的server暂时不参与负载均衡</td>
</tr>
<tr>
<td>backup</td>
<td>预留的备份服务器，其他主服务器挂了才会被用到</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求失败的次数</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>经过max_fails次失败后, 服务暂停的时间</td>
</tr>
<tr>
<td>max_conns</td>
<td>限制最大的接收连接数</td>
</tr>
</tbody></table>
<p><strong>设置方式示例</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> backend &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9001</span> down;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9002</span> backup;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">47.96.80.163:9003</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">15</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h5><table>
<thead>
<tr>
<th>算法名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>默认方式</td>
</tr>
<tr>
<td>weight</td>
<td>权重方式</td>
</tr>
<tr>
<td>ip_hash</td>
<td>依据ip分配方式</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据URL分配方式</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式</td>
</tr>
</tbody></table>
<p><strong>示例</strong></p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs roboconf"><span class="hljs-comment"># 1.配置权重，权重越大被分配的概率越大，默认为1</span><br>upstream backend &#123;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9001 weight=2;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 2.配置ip_hash，同一个ip只会被分配到同一台服务器上</span><br>upstream backend &#123;<br>	<span class="hljs-attribute">ip_hash;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 3.配置least_conn，会把请求转发给连接数较少的服务器上</span><br><span class="hljs-comment"># 适合请求处理时间长短不一造成服务器过载的情况</span><br>upstream backend &#123;<br>	<span class="hljs-attribute">least_conn;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 4.配置url_hash，根据访问url的hash结果来分配请求</span><br>upstream backend &#123;<br>	<span class="hljs-attribute">hash $request_uri;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br><br><span class="hljs-comment"># 5.配置fair，智能的进行负载均衡</span><br><span class="hljs-comment"># 需要安装第三方模块</span><br>(1)下载 https://github.com/gnosek/nginx-upstream-fair，解压到linux，重命名为fair<br>(2)sbin/nginx -V 查看之前的参数信息，并备份原nginx文件<br>(3)到nginx源文件目录，./configure --add-module=fair所在路径 + 之前的参数信息<br>(4)修改src/http/ngx_http_upstream.h文件，找到ngx_http_upstream_srv_conf_s，<br>	添加in_port_t	   default_port<br>(5)make<br>(6)将objs下的nginx复制到nginx文件夹下的sbin目录<br>(7)make upgrade<br>(8)测试<br>upstream backend &#123;<br>	<span class="hljs-attribute">fair;</span><br><span class="hljs-attribute">    server 47.96.80.163</span>:9001;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9002;<br>    <span class="hljs-attribute">server 47.96.80.163</span>:9003;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="第四层负载均衡"><a href="#第四层负载均衡" class="headerlink" title="第四层负载均衡"></a>第四层负载均衡</h4><p>需要安装stream模块，在配置参数的时候加上<code>--with-stream</code></p>
<p><strong>示例</strong></p>
<p>stream和http块是平级的</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">stream</span> &#123;<br>        <span class="hljs-section">upstream</span> redisbackend &#123;<br>                <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.200.146:6379</span>;<br>                <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.200.146:6378</span>;<br>        &#125;<br>        <span class="hljs-section">upstream</span> tomcatbackend &#123;<br>        		<span class="hljs-attribute">server</span> <span class="hljs-number">192.168.200.146:8080</span>;<br>        &#125;<br>        <span class="hljs-section">server</span> &#123;<br>                <span class="hljs-attribute">listen</span>  <span class="hljs-number">81</span>;<br>                <span class="hljs-attribute">proxy_pass</span> redisbackend;<br>        &#125;<br>        <span class="hljs-section">server</span> &#123;<br>        		<span class="hljs-attribute">listen</span>	<span class="hljs-number">82</span>;<br>        		<span class="hljs-attribute">proxy_pass</span> tomcatbackend;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="集成缓存"><a href="#集成缓存" class="headerlink" title="集成缓存"></a>集成缓存</h4><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html">Module ngx_http_proxy_module (nginx.org)</a></p>
<h5 id="相关指令"><a href="#相关指令" class="headerlink" title="相关指令"></a>相关指令</h5><p>例</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># proxy_cache_path：缓存存放路径；</span><br><span class="hljs-comment"># levels：缓存文件层级，如2:1表示请求url经过MD5加密后取最后两个字符和倒数第三个字符来组成存放文件夹，如/ab/c；</span><br><span class="hljs-comment"># keys_zone：为缓存区设置名称和大小；</span><br><span class="hljs-comment"># inactive：缓存存活时间，超过存活时间没有被访问就会被删除；max_size：设置最大缓存空间</span><br><span class="hljs-comment"># proxy_cache：开启缓存</span><br><span class="hljs-comment"># proxy_cache_key：根据key值MD5哈希存缓存，默认$scheme$proxy_host$request_uri</span><br><span class="hljs-comment"># proxy_cache_valid：对不同返回状态码的URL设置不同的缓存时间，如404 1d、any 30s</span><br>proxy_cache_path /home/nginx/proxy_cache <span class="hljs-attribute">levels</span>=2:1 <span class="hljs-attribute">keys_zone</span>=cache:200m<br><span class="hljs-attribute">inactive</span>=1d <span class="hljs-attribute">max_size</span>=20g;<span class="hljs-built_in"></span><br><span class="hljs-built_in">server </span>&#123;<br>	proxy_cache 缓存区名称;<br>	proxy_cache_key web缓存的key值;<br>	proxy_cache_vaild code time;<br>	add_header nginx-cache <span class="hljs-string">&quot;<span class="hljs-variable">$upstream_cache_status</span>&quot;</span>;	# 添加头信息来查看是否使用了缓存<br>	proxy_cache_min_uses number;	# 访问number次后才会缓存<br>	<span class="hljs-built_in">..</span>.<br>&#125;<br>    <br></code></pre></td></tr></table></figure>

<h5 id="清除缓存"><a href="#清除缓存" class="headerlink" title="清除缓存"></a>清除缓存</h5><p><strong>方式1</strong>：删除对应的缓存目录（删除所有缓存）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf 目录<br></code></pre></td></tr></table></figure>

<p><strong>方式2</strong>：ngx_cache_purge（删除指定缓存块的缓存）</p>
<p><a target="_blank" rel="noopener" href="https://github.com/FRiCKLE/ngx_cache_purge/tags">github地址</a></p>
<p>安装ngx_cache_purge第三方模块</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment"># 配置</span><br><span class="hljs-comment"># 之后浏览器访问对应路径就能删除缓存</span><br>server&#123;<br>	<span class="hljs-keyword">location</span> <span class="hljs-title">~/purge</span>(/.*) &#123;<br>		proxy_cache_purge 缓存块名称 缓存的key;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="设置不缓存的资源"><a href="#设置不缓存的资源" class="headerlink" title="设置不缓存的资源"></a>设置不缓存的资源</h5><p>例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">server&#123;<br>	listen	8080;<br>	server_name localhost;<br>	location / &#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> ~ /.*\.js$)&#123;<br>           <span class="hljs-built_in">set</span> <span class="hljs-variable">$nocache</span> 1;<br>        &#125;<br>		proxy_no_cache <span class="hljs-variable">$nocache</span> <span class="hljs-variable">$cookie_nocache</span> <span class="hljs-variable">$arg_nocache</span> <span class="hljs-variable">$arg_comment</span>;<br>        proxy_cache_bypass <span class="hljs-variable">$nocache</span> <span class="hljs-variable">$cookie_nocache</span> <span class="hljs-variable">$arg_nocache</span> <span class="hljs-variable">$arg_comment</span>;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="安全控制"><a href="#安全控制" class="headerlink" title="安全控制"></a>安全控制</h4><p>Nginx使用SSL(Secure Sockets Layer)，需要安装<code>--with-http_ssl_module</code>模块</p>
<h5 id="相关指令-1"><a href="#相关指令-1" class="headerlink" title="相关指令"></a>相关指令</h5><p><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_ssl_module.html">Module ngx_http_ssl_module (nginx.org)</a></p>
<h4 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h4><p>使用<strong>Keepalived</strong>来解决，Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，Keepalived 软件主要是通过 VRRP 协议实现高可用功能。</p>
<p><strong>VRRP（Virtual Route Redundancy Protocol）</strong></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">虚拟路由冗余协议，VRRP可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。其中的虚拟路由即Virtual路由是由VRRP路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的IP地址。而且VRRP路由<span class="hljs-number">1</span>和VRRP路由<span class="hljs-number">2</span>之间会有竞争选择，通过选择会产生一个<span class="hljs-literal">Master</span>路由和一个Backup路由。<br><span class="hljs-literal">Master</span>路由和Backup路由之间会有一个心跳检测，<span class="hljs-literal">Master</span>会定时告知Backup自己的状态，如果在指定的时间内，Backup没有接收到这个通知内容，Backup就会替代<span class="hljs-literal">Master</span>成为新的<span class="hljs-literal">Master</span>。<span class="hljs-literal">Master</span>路由有一个特权就是虚拟路由和后端服务器都是通过<span class="hljs-literal">Master</span>进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听<span class="hljs-literal">Master</span>的状态<br></code></pre></td></tr></table></figure>

<h5 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a>安装keepalived</h5><ol>
<li><p>官网下载<a target="_blank" rel="noopener" href="https://keepalived.org/%EF%BC%8C%E4%B8%8A%E4%BC%A0%E5%88%B0linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A">https://keepalived.org/，上传到linux服务器上</a></p>
</li>
<li><p>创建keepalived目录，将压缩包解压到目录</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">tar</span> <span class="hljs-operator">-</span><span class="hljs-variable">zxf</span> 压缩包名 <span class="hljs-operator">-</span><span class="hljs-built_in">C</span> <span class="hljs-variable">keepalived</span><span class="hljs-operator">/</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>编译、安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> keepalived/keepalived-2.0.20<br><br><span class="hljs-comment"># sysconf：配置文件所在目录</span><br><span class="hljs-comment"># prefix：keepalived要安装的目录</span><br>./configure --sysconf=/etc --prefix=/usr/local<br><br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="配置keepalived"><a href="#配置keepalived" class="headerlink" title="配置keepalived"></a>配置keepalived</h5><p>配置文件在<code>/安装目录/keepalived/keepalived.conf</code></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-keyword">global</span>全局部分：<br>global_defs &#123;<br>   <span class="hljs-meta">#通知邮件，当keepalived发送切换时需要发email给具体的邮箱地址</span><br>   notification_email &#123;<br>     tom<span class="hljs-symbol">@itcast</span>.cn<br>     jerry<span class="hljs-symbol">@itcast</span>.cn<br>   &#125;<br>   <span class="hljs-meta">#设置发件人的邮箱信息</span><br>   notification_email_from zhaomin<span class="hljs-symbol">@itcast</span>.cn<br>   <span class="hljs-meta">#指定smpt服务地址</span><br>   smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.200</span><span class="hljs-number">.1</span><br>   <span class="hljs-meta">#指定smpt服务连接超时时间</span><br>   smtp_connect_timeout <span class="hljs-number">30</span><br>   <span class="hljs-meta">#运行keepalived服务器的一个标识，可以用作发送邮件的主题信息</span><br>   router_id LVS_DEVEL<br>   <br>   <span class="hljs-meta">#默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)</span><br>   vrrp_skip_check_adv_addr<br>   <span class="hljs-meta">#严格遵守VRRP协议。</span><br>   vrrp_strict<br>   <span class="hljs-meta">#在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0</span><br>   vrrp_garp_interval <span class="hljs-number">0</span><br>   <span class="hljs-meta">#在一个网卡上每组na消息之间的延迟时间，默认为0</span><br>   vrrp_gna_interval <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs pf">VRRP部分，该部分可以包含以下四个子模块<br><span class="hljs-number">1</span>. vrrp_script<br><span class="hljs-number">2</span>. vrrp_sync_group<br><span class="hljs-number">3</span>. garp_group<br><span class="hljs-number">4</span>. vrrp_instance<br>我们会用到第一个和第四个，<br><span class="hljs-comment">#设置keepalived实例的相关信息，VI_1为VRRP实例名称</span><br>vrrp_instance VI_1 &#123;<br>    <span class="hljs-keyword">state</span> MASTER  		<span class="hljs-comment">#有两个值可选MASTER主 BACKUP备</span><br>    interface ens33		<span class="hljs-comment">#vrrp实例绑定的接口，用于发送VRRP包[当前服务器使用的网卡名称]</span><br>    virtual_router_id <span class="hljs-number">51</span><span class="hljs-comment">#指定VRRP实例ID，范围是0-255</span><br>    priority <span class="hljs-number">100</span>		<span class="hljs-comment">#指定优先级，优先级高的将成为MASTER</span><br>    advert_int <span class="hljs-number">1</span>		<span class="hljs-comment">#指定发送VRRP通告的间隔，单位是秒</span><br>    authentication &#123;	<span class="hljs-comment">#vrrp之间通信的认证信息</span><br>        auth_type PASS	<span class="hljs-comment">#指定认证方式。PASS简单密码认证(推荐)</span><br>        auth_pass <span class="hljs-number">1111</span>	<span class="hljs-comment">#指定认证使用的密码，最多8位</span><br>    &#125;<br>    virtual_ipaddress &#123; <span class="hljs-comment">#虚拟IP地址设置虚拟IP地址，供用户访问使用，可设置多个，一行一个</span><br>        <span class="hljs-number">192.168</span>.<span class="hljs-number">200.222</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="启动keepalived"><a href="#启动keepalived" class="headerlink" title="启动keepalived"></a>启动keepalived</h5><ol>
<li><p>启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /安装目录/local/sbin<br>./keepalived<br></code></pre></td></tr></table></figure>
</li>
<li><p><code>ip a</code>查看ip，虚拟IP(VIP)会在MASTER节点上，当MASTER节点上的<strong>keepalived</strong>出问题以后，因为BACKUP无法收到MASTER发出的VRRP状态通过信息，就会直接升为MASTER。VIP也会”漂移”到新的MASTER。</p>
</li>
<li><p>可以通过编写脚本来检测当nginx进程挂了的时候关闭keepalived，从而自动切换master到另一台nginx上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 编写脚本ck_nginx.sh，该脚本的意思是检查nginx进程是否在运行，</span><br><span class="hljs-comment"># 如果检测不到nginx进程，则关闭keepalived</span><br><br><span class="hljs-comment">#!/bin/bash</span><br>num=`ps -C nginx --no-header | <span class="hljs-built_in">wc</span> -l`<br><span class="hljs-keyword">if</span> [ `ps -C nginx --no-header | <span class="hljs-built_in">wc</span> -l` -eq 0 ]; <span class="hljs-keyword">then</span><br>	killall keepalived<br><span class="hljs-keyword">fi</span><br><br><br><span class="hljs-comment"># 给脚本设置权限</span><br><span class="hljs-built_in">chmod</span> 755 ck_nginx.sh<br><br><br><span class="hljs-comment"># 在keepalived配置文件中添加对应的配置像</span><br>vrrp_script 脚本名称<br>&#123;<br>    script <span class="hljs-string">&quot;脚本位置&quot;</span><br>    interval 3 <span class="hljs-comment">#执行时间间隔</span><br>    weight -20 <span class="hljs-comment">#动态调整vrrp_instance的优先级</span><br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="制作下载站点"><a href="#制作下载站点" class="headerlink" title="制作下载站点"></a>制作下载站点</h4><ol>
<li><p>将要被下载的资源放到一个目录下</p>
</li>
<li><p>修改nginx配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /download&#123;<br>	<span class="hljs-comment"># 被下载资源路径</span><br>    <span class="hljs-attribute">root</span> /usr/local;<br>    <span class="hljs-comment"># 开启功能</span><br>    <span class="hljs-attribute">autoindex</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment"># 是否展示文件大小</span><br>    <span class="hljs-attribute">autoindex_exact_size</span> <span class="hljs-literal">on</span>;<br>    <span class="hljs-comment"># 目录列表的格式，可以是html/xml/json/jsonp，默认html</span><br>    <span class="hljs-attribute">autoindex_format</span> html;<br>    <span class="hljs-comment"># 是否在目录列表上显示时间</span><br>    <span class="hljs-attribute">autoindex_localtime</span> <span class="hljs-literal">on</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h4><p>Lua是用标准C语言编写并以源代码形式开发。设计的目的是为了嵌入到其他应用程序中，从而为应用程序提供灵活的扩展和定制功能。应用在游戏开发、独立应用脚本、web应用脚本、扩展和数据库插件、系统安全上。</p>
<p><a target="_blank" rel="noopener" href="https://www.lua.org/">官网</a></p>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><ol>
<li><p>下载压缩包到服务器</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>www.lua.org<span class="hljs-regexp">/ftp/</span>lua-<span class="hljs-number">5.4</span>.<span class="hljs-number">4</span>.tar.gz<br></code></pre></td></tr></table></figure>
</li>
<li><p>检查环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">make linux <span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>编译安装</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">make <span class="hljs-keyword">install</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>查看版本</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">lua -v</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h5 id="交互方式"><a href="#交互方式" class="headerlink" title="交互方式"></a>交互方式</h5><p><strong>1.交互式</strong></p>
<p>通过命令<code>lua</code>进入控制台</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># lua</span><br>&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><strong>2.脚本式</strong></p>
<p>创建hello.lua文件，编写脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># vim hello.lua</span><br><br><span class="hljs-comment"># 编写脚本</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Hello World&quot;</span>)<br><br><span class="hljs-comment"># 执行</span><br><span class="hljs-built_in">chmod</span> 755 hello.lua<br>lua hello.lua<br><br><span class="hljs-comment"># 也可以在文件开头指定解释器，执行的时候直接用文件名就行了</span><br><span class="hljs-comment">#!/usr/local/bin/lua</span><br></code></pre></td></tr></table></figure>

<h5 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h5><h6 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h6><p><strong>单行注释</strong></p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-comment">-- 注释</span><br></code></pre></td></tr></table></figure>

<p><strong>多行注释</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--[[</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">--]]</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>多行注释只需要在前面多加一个-就可以取消</p>
</blockquote>
<h6 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h6><p><strong>逻辑运算符</strong></p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">and</span> --&gt;</span> 与<br><span class="hljs-function"><span class="hljs-title">or</span> --&gt;</span> 或<br><span class="hljs-function"><span class="hljs-title">not</span> --&gt;</span> 非<br></code></pre></td></tr></table></figure>

<p>其他运算符</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-string">..</span> 连接字符串<br><span class="hljs-comment"># 返回字符串或表的长度</span><br></code></pre></td></tr></table></figure>

<h6 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h6><p>默认为全局变量，定义局部变量要在前面加<code>local</code></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span><span class="hljs-comment">;</span><br>local b <span class="hljs-operator">=</span> <span class="hljs-number">20</span><span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<h6 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h6><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">nil</span><span class="hljs-params">(空，无效值)</span></span><br><span class="hljs-function"><span class="hljs-title">boolean</span><span class="hljs-params">(布尔，true/false)</span></span><br><span class="hljs-function"><span class="hljs-title">number</span><span class="hljs-params">(数值)</span></span>：只有false和nil为假<br><span class="hljs-function"><span class="hljs-title">string</span><span class="hljs-params">(字符串)</span></span><br><span class="hljs-function"><span class="hljs-title">function</span><span class="hljs-params">(函数)</span></span><br>table（表）<br><span class="hljs-function"><span class="hljs-title">thread</span><span class="hljs-params">(线程)</span></span><br>userdata（用户数据）<br></code></pre></td></tr></table></figure>

<p><strong>表</strong></p>
<p>可以用来表示数组、字典或混合使用，下标从1开始</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># 定义一个表</span><br><span class="hljs-attribute">arr</span> = &#123;&#125;<br><span class="hljs-attribute">arr</span> = &#123;<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>&#125;<br><span class="hljs-attribute">arr</span> = &#123;X = <span class="hljs-number">10</span>, Y = <span class="hljs-number">20</span>, Z = <span class="hljs-number">30</span>&#125;<br><span class="hljs-attribute">arr</span> = &#123;<span class="hljs-string">&quot;a&quot;</span>, X = <span class="hljs-number">10</span>, <span class="hljs-string">&quot;b&quot;</span>&#125;<br><br><span class="hljs-comment"># 获取表里的值</span><br><span class="hljs-attribute">arr</span> = &#123;<span class="hljs-string">&quot;a&quot;</span>, X = <span class="hljs-number">10</span>, <span class="hljs-string">&quot;b&quot;</span>&#125;<br><span class="hljs-attribute">arr</span>[<span class="hljs-number">0</span>]	-- nil<br><span class="hljs-attribute">arr</span>[<span class="hljs-number">1</span>] 	-- <span class="hljs-string">&quot;a&quot;</span><br><span class="hljs-attribute">arr</span>[<span class="hljs-number">2</span>]	-- <span class="hljs-string">&quot;b&quot;</span><br><span class="hljs-attribute">arr</span>[<span class="hljs-string">&quot;X&quot;</span>]	-- <span class="hljs-number">10</span><br><span class="hljs-attribute">arr</span>.X	-- <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<h6 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs lua"># 定义函数<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span><span class="hljs-params">(params)</span></span><br>	<span class="hljs-comment">-- 方法的内容</span><br><span class="hljs-keyword">end</span><br><br># 方法定义的参数并非都要传入，传入的会按顺序赋值，没赋值的参数为<span class="hljs-literal">nil</span>；如果传入的参数数量大于方法需要的参数数量，则会丢弃多出来的参数<br><br># 可变长参数<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span><span class="hljs-params">(...)</span></span><br>	a, b, c = ...;<br>	<span class="hljs-built_in">print</span>(a, b, c);<br><span class="hljs-keyword">end</span><br><br># 方法返回值数量也是可变的<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span><span class="hljs-params">()</span></span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>;<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h6 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h6><p>if</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> 条件 <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">elseif</span> 条件 <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">else</span><br>    <span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h6 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h6><p>while</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-keyword">while</span> 条件 <span class="hljs-keyword">do</span><br>	<span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>repeat</p>
<p>直到满足条件才退出循环</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">repeat</span><br>	<span class="hljs-comment">-- 代码</span><br><span class="hljs-keyword">until</span> 条件<br></code></pre></td></tr></table></figure>

<p>for</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">-- 循环从start开始到end结束；step为步长，默认为1</span><br><span class="hljs-keyword">for</span> <span class="hljs-built_in">param</span>=<span class="hljs-built_in">start</span>,<span class="hljs-keyword">end</span>,step <span class="hljs-built_in">do</span><br> 循环体<br><span class="hljs-function"><span class="hljs-keyword">end</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">-- 遍历表</span><br><span class="hljs-comment">-- ipairs为迭代器，x为表</span><br><span class="hljs-comment">-- ipairs不能遍历出键值对，要遍历键值对要用pairs</span><br><span class="hljs-keyword">for</span> i,v <span class="hljs-keyword">in</span> ipairs(x) <span class="hljs-built_in">do</span><br>	循环体<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h5 id="OpenResty"><a href="#OpenResty" class="headerlink" title="OpenResty"></a>OpenResty</h5><p>OpenResty是一个基于Nginx与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。OpenResty内部已经集成了Nginx和Lua。</p>
<h6 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h6><ol>
<li><p>下载、解压压缩包	<a target="_blank" rel="noopener" href="https://openresty.org/en/download.html">OpenResty - Download</a></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>openresty.org<span class="hljs-regexp">/download/</span>openresty-<span class="hljs-number">1.15</span>.<span class="hljs-number">8.2</span>.tar.gz<br>tar -zxvf openresty-<span class="hljs-number">1.15</span>.<span class="hljs-number">8.2</span>.tar.gz<br></code></pre></td></tr></table></figure>
</li>
<li><p>进入openresty目录，编译安装</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gauss">./configure<br><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install<br></code></pre></td></tr></table></figure>
</li>
<li><p>默认安装位置<code>/usr/local/openresty/nginx/</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/openresty/</span>nginx/<br></code></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 修改配置</span><br>location /lua&#123;<br>    default_type <span class="hljs-string">&#x27;text/html&#x27;</span>;<br>    content_by_lua <span class="hljs-string">&#x27;ngx.say(&quot;&lt;h1&gt;HELLO,OpenRestry&lt;/h1&gt;&quot;)&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment"># 测试</span><br>.<span class="hljs-regexp">/sbin/</span>nginx -t<br><span class="hljs-comment"># 启动</span><br>.<span class="hljs-regexp">/sbin/</span>nginx<br><br><span class="hljs-comment"># 浏览器访问</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h6 id="使用ngx-lua指令"><a href="#使用ngx-lua指令" class="headerlink" title="使用ngx_lua指令"></a>使用ngx_lua指令</h6><p><strong>init_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令在每次Nginx重新加载配置时执行，可以用来完成一些耗时模块的加载，或者初始化一些全局配置。<br></code></pre></td></tr></table></figure>

<p><strong>init_worker_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令用于启动一些定时任务，如心跳检查、定时拉取服务器配置等。<br></code></pre></td></tr></table></figure>

<p><strong>set_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令只要用来做变量赋值，这个指令一次只能返回一个值，并将结果赋值给Nginx中指定的变量。<br></code></pre></td></tr></table></figure>

<p><strong>rewrite_by_lua</strong></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">该指令用于执行内部<span class="hljs-built_in">URL</span>重写或者外部重定向，典型的如伪静态化<span class="hljs-built_in">URL</span>重写，本阶段在rewrite处理阶段的最后默认执行。<br></code></pre></td></tr></table></figure>

<p><strong>access_by_lua</strong></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">该指令用于访问控制。例如，如果只允许内网<span class="hljs-built_in">IP</span>访问。<br></code></pre></td></tr></table></figure>

<p><strong>content_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令是应用最多的指令，大部分任务是在这个阶段完成的，其他的过程往往为这个阶段准备数据，正式处理基本都在本阶段。<br></code></pre></td></tr></table></figure>

<p><strong>header_filter_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令用于设置应答消息的头部信息。<br></code></pre></td></tr></table></figure>

<p><strong>body_filter_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令是对响应数据进行过滤，如截断、替换。<br></code></pre></td></tr></table></figure>

<p><strong>log_by_lua</strong></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">该指令用于在<span class="hljs-built_in">log</span>请求处理阶段，用Lua代码处理日志，但并不替换原有<span class="hljs-built_in">log</span>处理。<br></code></pre></td></tr></table></figure>

<p><strong>balancer_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令主要的作用是用来实现上游服务器的负载均衡器算法<br></code></pre></td></tr></table></figure>

<p><strong>ssl_certificate_by_lua</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">该指令作用在Nginx和下游服务开始一个SSL握手操作时将允许本配置项的Lua代码。<br></code></pre></td></tr></table></figure>

<p>例</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs 1c">location /getByGender &#123;<br>	default_type &#x27;text/html&#x27;;<br>	set_by_lua $name <span class="hljs-string">&quot;</span><br>		local uri_args = ngx.req.get_uri_args()<br>		gender = uri_args[&#x27;gender&#x27;]<br>		name = uri_args[&#x27;name&#x27;]<br>		if gender==&#x27;1&#x27; then<br>			return name..&#x27;先生&#x27;<br>		elseif gender==&#x27;0&#x27; then<br>			return name..&#x27;女士&#x27;<br>		else<br>			return name<br>		end<br>	<span class="hljs-string">&quot;;</span><br>	header_filter_by_lua <span class="hljs-string">&quot;</span><br>		ngx.header.aaa=&#x27;bbb&#x27;<br>	<span class="hljs-string">&quot;;</span><br>	return <span class="hljs-number">200</span> $name;<br>&#125;<br></code></pre></td></tr></table></figure>

<h6 id="ngx-lua操作Redis"><a href="#ngx-lua操作Redis" class="headerlink" title="ngx_lua操作Redis"></a>ngx_lua操作Redis</h6> <figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">lua</span>-resty-redis提供了访问Redis的详细API，包括创建对接、连接、操作、数据处理等。这些API基本上与Redis的操作一一对应。<br>（<span class="hljs-number">1</span>）redis = require <span class="hljs-string">&quot;resty.redis&quot;</span><br>（<span class="hljs-number">2</span>）<span class="hljs-keyword">new</span><br>	语法: redis,err = <span class="hljs-keyword">redi</span><span class="hljs-variable">s:new</span>(),创建一个Redis对象。<br>（<span class="hljs-number">3</span>）connect<br>	语法:ok,err=<span class="hljs-keyword">redi</span><span class="hljs-variable">s:connect</span>(host,port[,options_table]),设置连接Redis的连接信息。<br>	ok:连接成功返回 <span class="hljs-number">1</span>，连接失败返回nil<br>	err:返回对应的错误信息<br>（<span class="hljs-number">4</span>）set_timeout<br>	语法: <span class="hljs-keyword">redi</span><span class="hljs-variable">s:set_timeout</span>(time) ，设置请求操作Redis的超时时间。<br>（<span class="hljs-number">5</span>）<span class="hljs-keyword">close</span><br>	语法: ok,err = <span class="hljs-keyword">redi</span><span class="hljs-variable">s:close</span>(),关闭当前连接，成功返回<span class="hljs-number">1</span>，失败返回nil和错误信息<br>（<span class="hljs-number">6</span>）redis命令对应的方法<br>	在<span class="hljs-keyword">lua</span>-resty-redis中，所有的Redis命令都有自己的方法，方法名字和命令名字相同，只是全部为小写。<br><br></code></pre></td></tr></table></figure>

<h6 id="ngx-lua操作mysql"><a href="#ngx-lua操作mysql" class="headerlink" title="ngx_lua操作mysql"></a>ngx_lua操作mysql</h6><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">（<span class="hljs-number">1</span>）引入&quot;resty.mysql&quot;模块<br>	<span class="hljs-keyword">local</span> mysql = require &quot;resty.mysql&quot;<br>（<span class="hljs-number">2</span>）<span class="hljs-built_in">new</span><br>	创建一个MySQL连接对象，遇到错误时，db为nil，err为错误描述信息<br>	语法: db,err = mysql:<span class="hljs-built_in">new</span>()<br>（<span class="hljs-number">3</span>）<span class="hljs-keyword">connect</span><br>	尝试连接到一个MySQL服务器<br>	语法:ok,err=db:<span class="hljs-keyword">connect</span>(<span class="hljs-keyword">options</span>),<span class="hljs-keyword">options</span>是一个参数的Lua表结构，里面包含数据库连接的相关信息<br>    host:服务器主机名或IP地址<br>    port:服务器监听端口，默认为<span class="hljs-number">3306</span><br>    <span class="hljs-keyword">user</span>:登录的用户名<br>    <span class="hljs-keyword">password</span>:登录密码<br>    <span class="hljs-keyword">database</span>:使用的数据库名<br>（<span class="hljs-number">4</span>）set_timeout<br>	设置子请求的超时时间(ms)，包括<span class="hljs-keyword">connect</span>方法<br>	语法:db:set_timeout(<span class="hljs-type">time</span>)<br>（<span class="hljs-number">5</span>）<span class="hljs-keyword">close</span><br>	关闭当前MySQL连接并返回状态。如果成功，则返回<span class="hljs-number">1</span>；如果出现任何错误，则将返回nil和错误描述。<br>	语法:db:<span class="hljs-keyword">close</span>()<br>（<span class="hljs-number">6</span>）send_query<br>	异步向远程MySQL发送一个查询。如果成功则返回成功发送的字节数；如果错误，则返回nil和错误描述<br>	语法:bytes,err=db:send_query(<span class="hljs-keyword">sql</span>)<br>（<span class="hljs-number">7</span>）read_result<br>	从MySQL服务器返回结果中读取一行数据。res返回一个描述OK包或结果集包的Lua表,语法:<br>	res, err, errcode, <span class="hljs-built_in">sqlstate</span> = db:read_result() <br>	res, err, errcode, <span class="hljs-built_in">sqlstate</span> = db:read_result(<span class="hljs-keyword">rows</span>) :<span class="hljs-keyword">rows</span>指定返回结果集的最大值，默认为<span class="hljs-number">4</span><br>	如果是查询，则返回一个容纳多行的数组。每行是一个数据列的key-<span class="hljs-keyword">value</span>对，如<br><br>    &#123;<br>      &#123;id=<span class="hljs-number">1</span>,username=&quot;TOM&quot;,birthday=&quot;1988-11-11&quot;,salary=<span class="hljs-number">10000.0</span>&#125;,<br>      &#123;id=<span class="hljs-number">2</span>,username=&quot;JERRY&quot;,birthday=&quot;1989-11-11&quot;,salary=<span class="hljs-number">20000.0</span>&#125;<br>    &#125;<br>	如果是增删改，则返回类上如下数据<br>    &#123;<br>    	insert_id = <span class="hljs-number">0</span>,<br>    	server_status=<span class="hljs-number">2</span>,<br>    	warning_count=<span class="hljs-number">1</span>,<br>    	affected_rows=<span class="hljs-number">2</span>,<br>    	message=nil<br>    &#125;<br>	返回值:<br>		res:操作的结果集<br>		err:错误信息<br>		errcode:MySQL的错误码，比如<span class="hljs-number">1064</span><br>		<span class="hljs-built_in">sqlstate</span>:返回由<span class="hljs-number">5</span>个字符组成的标准<span class="hljs-keyword">SQL</span>错误码，比如<span class="hljs-number">42000</span><br><br></code></pre></td></tr></table></figure>



<h4 id="具体应用"><a href="#具体应用" class="headerlink" title="具体应用"></a>具体应用</h4><ul>
<li><p>部署静态资源</p>
<p>将静态资源放到html文件夹下</p>
</li>
<li><p>反向代理</p>
<blockquote>
<p>正向代理:代理的是客服端,对客服端负责,帮助客服端访问服务器</p>
<p>反向代理:代理的是服务端,对服务端负责,帮助服务器提供服务</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs linux">#在配置文件中的http中配置反向代理,记得开放端口<br>server &#123;<br>        listen       80;	#监听的端口，当访问这个端口时转发到指定服务器<br>        server_name  localhost;<br>        location / &#123;<br>			proxy_pass:http://192.168.229.130:8080;	#转发的服务器<br>&#125;<br></code></pre></td></tr></table></figure>


</li>
<li><p>负载均衡</p>
<blockquote>
<p>基于反向代理，根据算法将用户请求分发到集群中的一台服务器上</p>
</blockquote>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>weight</td>
<td>权重方式，值越大分配几率越高</td>
</tr>
<tr>
<td>ip_hash</td>
<td>根据客户端ip</td>
</tr>
<tr>
<td>least_conn</td>
<td>根据最少连接方式</td>
</tr>
<tr>
<td>url_hash</td>
<td>根据url分配方式</td>
</tr>
<tr>
<td>fair</td>
<td>根据响应时间方式</td>
</tr>
<tr>
<td>轮询</td>
<td>默认</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs linux">#配置负载均衡<br>upstream targetserver&#123;			#upstream指令来定义一组服务器<br>	server 192.168.229.130:8080;<br>	server 192.168.229.131:8080;<br>	server 192.168.229.131:8081;<br>&#125;<br><br>server &#123;<br>        listen       80;	#监听的端口，当访问这个端口时转发到指定服务器<br>        server_name  localhost;<br>        location / &#123;<br>			proxy_pass:http://targetserver;	#转发的服务器<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>记得<code>./sbin/nginx -s reload</code>重新加载</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">学习笔记</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="category-chain-item">中间件</a>
  
  
    <span>></span>
    
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E4%B8%AD%E9%97%B4%E4%BB%B6/nginx/" class="category-chain-item">nginx</a>
  
  

  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%90%8E%E7%AB%AF/">#后端</a>
      
        <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">#中间件</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Nginx</div>
      <div>http://xwww12.github.io/2022/08/20/中间件/Nginx/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>xw</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年8月20日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/08/21/%E5%85%B6%E4%BB%96/%E6%8E%A5%E5%8F%A3%E7%AE%A1%E7%90%86/" title="接口管理">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">接口管理</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/19/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/MySQL%E4%B8%BB%E4%BB%8E%E9%85%8D%E7%BD%AE/" title="MySQL主从配置">
                        <span class="hidden-mobile">MySQL主从配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <div style="font-size: 10px"> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/snow2.js"></script>
<script src="/js/pageTitle.js"></script>
<script src="/js/sakura.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
